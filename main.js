/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Be=Object.prototype.hasOwnProperty;var Ue=(s,n)=>{for(var t in n)le(s,t,{get:n[t],enumerable:!0})},Ye=(s,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of Ke(n))!Be.call(s,r)&&r!==t&&le(s,r,{get:()=>n[r],enumerable:!(e=We(n,r))||e.enumerable});return s};var Xe=s=>Ye(le({},"__esModule",{value:!0}),s);var dn={};Ue(dn,{default:()=>se});module.exports=Xe(dn);var Lt=require("obsidian");var qt=require("obsidian"),ce="chartnotes-view",qe=["bar","stacked-bar","line","area","pie","scatter","gantt"];function je(s){let n=String(s!=null?s:"bar").trim().toLowerCase();return qe.includes(n)?n:"bar"}var Ze=["sum","count","cumulative-sum"];function Je(s){let n=String(s!=null?s:"sum").trim().toLowerCase();return Ze.includes(n)?n:"sum"}var Xt=class extends qt.BasesView{constructor(t,e,r){super(t);this.type=ce;this.renderer=r,this.rootEl=e.createDiv("chartnotes-bases-view")}onDataUpdated(){var z,j,G;this.rootEl.empty();let t=this.data,e=(z=t==null?void 0:t.groupedData)!=null?z:[];if(!e.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,o=(j=r==null?void 0:r.get("chartType"))!=null?j:"bar",i=je(o),h=r==null?void 0:r.get("aggregateMode"),a=Je(h),m=a==="cumulative-sum"&&!(i==="line"||i==="area")?"sum":a,f=this.getPropFromConfig("xProperty"),w=this.getPropFromConfig("yProperty"),x=this.getPropFromConfig("seriesProperty"),p=this.getPropFromConfig("startProperty"),c=this.getPropFromConfig("endProperty"),C=this.getPropFromConfig("dueProperty"),I=this.getPropFromConfig("durationProperty"),T=this.getPropFromConfig("groupProperty"),_=i==="gantt",M=i==="scatter";if(!_&&!f.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / label' property in view options."});return}if(M&&(!f.id||!w.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(_&&(!p.id||!c.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt charts need Start and End properties configured."});return}let N;if(_?N=this.buildRowsForGantt(e,f,x,p,c,C,I,T):M?N=this.buildRowsForScatter(e,f,w,x):N=this.buildRowsForAggregatedCharts(e,f,w,x,m),!N.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let $={rows:N},R=this.buildEncoding({x:f,y:w,series:x,start:p,end:c,due:C,duration:I,group:T,aggMode:m}),d=((G=r==null?void 0:r.get("title"))!=null?G:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",S=r==null?void 0:r.get("drilldown"),b={type:i,source:{type:"properties",query:""},encoding:R,options:{title:d,drilldown:typeof S=="boolean"?S:!0}},P={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,b,$,P)}getPropFromConfig(t){var h,a;let e=this.config,r=(h=e==null?void 0:e.get)==null?void 0:h.call(e,t);if(!r)return{id:null,name:null};let o=r.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let l=(0,qt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,e){if(!e.id)return null;let r;try{r=t.getValue(e.id)}catch(o){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let e=t.trim();if(!e)return null;let r=new Date(e);return Number.isNaN(r.getTime())?null:r}compareX(t,e){let r=this.parseDate(t!=null?String(t):null),o=this.parseDate(e!=null?String(e):null);if(r&&o)return r.getTime()-o.getTime();let i=Number(t),h=Number(e);return!Number.isNaN(i)&&!Number.isNaN(h)?i-h:String(t!=null?t:"").localeCompare(String(e!=null?e:""))}buildRowsForAggregatedCharts(t,e,r,o,i){var m,f;let h=new Map,a=i==="count"||!r.id&&i!=="sum";for(let w of t)for(let x of w.entries){let p=x.file,c=(f=this.readValue(x,e))!=null?f:p!=null&&p.name?String(p.name):String((m=p==null?void 0:p.path)!=null?m:""),C=1,I=null;if(!a&&r.id){if(I=this.readValue(x,r),I==null)continue;let $=Number(I);if(Number.isNaN($))continue;C=$}else C=1;let T=this.readValue(x,o),_=T!=null?String(T):void 0,M=`${c}@@${_!=null?_:""}`,N=h.get(M);N||(N={x:c,y:0,series:_,notes:[],props:{}},h.set(M,N)),N.y+=C,p!=null&&p.path&&N.notes.push(p.path),N.props&&e.name&&(N.props[e.name]=c),!a&&N.props&&r.name&&I!=null&&(N.props[r.name]=N.y),N.props&&o.name&&T!=null&&(N.props[o.name]=T)}let l=Array.from(h.values());return i==="cumulative-sum"?this.toCumulative(l):l}toCumulative(t){var o,i;let e=new Map;for(let h of t){let a=(o=h.series)!=null?o:"__no_series__",l=e.get(a);l||(l=[],e.set(a,l)),l.push(h)}let r=[];for(let[,h]of e){let a=[...h].sort((m,f)=>this.compareX(m.x,f.x)),l=0;for(let m of a){let f=Number((i=m.y)!=null?i:0);Number.isNaN(f)||(l+=f,m.y=l,r.push(m))}}return r}buildRowsForScatter(t,e,r,o){let i=[];for(let h of t)for(let a of h.entries){let l=a.file,m=this.readValue(a,e),f=this.readValue(a,r);if(m==null||f==null)continue;let w=Number(m),x=Number(f);if(Number.isNaN(w)||Number.isNaN(x))continue;let p=this.readValue(a,o),c=p!=null?String(p):void 0;i.push({x:w,y:x,series:c,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,e,r,o,i,h,a,l){var f,w;let m=[];for(let x of t)for(let p of x.entries){let c=p.file,C=this.readValue(p,o),I=this.readValue(p,i);if(!C||!I)continue;let T=this.parseDate(C),_=this.parseDate(I);if(!T||!_)continue;let M=(w=this.readValue(p,e))!=null?w:c!=null&&c.name?String(c.name).replace(/\.md$/i,""):String((f=c==null?void 0:c.path)!=null?f:""),N=this.readValue(p,h),$=this.parseDate(N!=null?N:null),R=this.readValue(p,a),v=R!=null?Number(R):void 0,d=typeof v=="number"&&!Number.isNaN(v),S=this.readValue(p,r),D=S!=null?String(S):void 0,b=this.readValue(p,l),P={};a.name&&d&&(P[a.name]=v),l.name&&b!=null&&(P[l.name]=b),m.push({x:M,y:0,series:D,start:T,end:_,due:$!=null?$:void 0,notes:c!=null&&c.path?[c.path]:[],props:P})}return m}buildEncoding(t){var r,o,i,h,a,l,m;let e;return t.aggMode==="count"||!t.y.id&&t.aggMode!=="sum"?e="Count":t.aggMode==="cumulative-sum"?e=t.y.name?`${t.y.name} (cumulative)`:"Cumulative":e=t.y.name?`${t.y.name} (sum)`:"Value",{x:(r=t.x.name)!=null?r:"x",y:e,series:(o=t.series.name)!=null?o:"series",start:(i=t.start.name)!=null?i:"start",end:(h=t.end.name)!=null?h:"end",due:(a=t.due.name)!=null?a:"due",duration:(l=t.duration.name)!=null?l:"duration",group:(m=t.group.name)!=null?m:"group"}}};var Ne=require("obsidian"),jt=class{constructor(n){this.index=new Map;this.app=n}async buildIndex(){this.index.clear();let n=this.app.vault.getMarkdownFiles();for(let t of n)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(n){if(n.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(n)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Ne.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[h,a]of Object.entries(i))h!=="position"&&(t[h]=a)}let o=this.app.metadataCache.getFileCache(n);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",n.path,e)}this.index.set(n.path,{path:n.path,props:t})}removeFile(n){this.index.delete(n.path)}};function ke(s,n){if(!n||n.length===0)return!0;for(let t of n){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(e))return!0}return!1}function Pe(s,n){if(!n||n.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of n)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let e=String(t);for(let r of n)if(e===r||e==="#"+r)return!0;return!1}function Jt(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function $t(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,e,r]=s.split("-");return new Date(Number(t),Number(e)-1,Number(r),0,0,0,0)}let n=new Date(s);return isNaN(n.getTime())?null:n}function ut(s){let n=new Date(s);return n.setHours(0,0,0,0),n}function Zt(s,n){let t=new Date(s);return t.setDate(t.getDate()-n),t}function tn(s,n){return Zt(s,n*7)}function en(s,n){let t=new Date(s);return t.setMonth(t.getMonth()-n),t}function de(s,n){let t=new Date(s);return t.setDate(t.getDate()+n),t}function nn(s,n){return de(s,n*7)}function rn(s,n){let t=new Date(s);return t.setMonth(t.getMonth()+n),t}function Te(s){let n=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(n)||n.endsWith("date")||n.endsWith("at")||n.endsWith("on"))}function Me(s,n){let t=n?new Date(n):new Date,e=ut(t),r=s.trim().toLowerCase();if(r==="today")return e;if(r==="yesterday")return ut(Zt(e,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(Zt(e,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Zt(e,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(tn(e,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(en(e,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(de(e,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(de(e,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(nn(e,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(rn(e,o))}return null}function Le(s){let n=s.trim(),t=n.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let m=t[1].trim(),f=t[2].trim(),w=t[3].trim(),x=Te(m),p=ue(f,x),c=ue(w,x),C=p.valueType==="date"||c.valueType==="date"?"date":p.valueType;return{field:m,op:"between",value:p.value,value2:c.value,valueType:C}}let e=/(==|!=|>=|<=|>|<)/,r=n.split(e);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),h=r[2].trim(),a=Te(o),l=ue(h,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function ue(s,n){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),r=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(n){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(Jt(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ie(s,n){let t=s[n.field];if(t==null)return!1;if(n.valueType==="date"){let o=t instanceof Date?ut(t):Jt(t)?ut($t(t)):null;if(!o)return!1;let i=n.value instanceof Date?n.value:null,h=n.value2 instanceof Date?n.value2:null;if(!i)return!1;let a=o.getTime(),l=ut(i).getTime();switch(n.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!h)return!1;let m=ut(h).getTime();return a>=l&&a<=m}}if(n.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(n.value);switch(n.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof n.value2!="number"?!1:o>=i&&o<=n.value2}}let e=String(t),r=String(n.value);switch(n.op){case"==":return e===r;case"!=":return e!==r;case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r;case"between":return!1}}function sn(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(Jt(s)){let n=$t(s);if(n)return{key:n,isDate:!0}}return{key:s,isDate:!1}}function on(s,n){let t=s.x,e=n.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let r=String(t),o=String(e);return r<o?-1:r>o?1:0}function an(s,n){var o,i;let t=on(s,n);if(t!==0)return t;let e=(o=s.series)!=null?o:"",r=(i=n.series)!=null?i:"";return e<r?-1:e>r?1:0}function ln(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let n=s.trim().match(/^(\d+)/);if(n){let t=Number(n[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function cn(s){var e,r;let n=new Map,t=[];for(let o of s){let i=(e=o.series)!=null?e:"__no_series__",a=((r=n.get(i))!=null?r:0)+o.y;n.set(i,a),t.push({...o,y:a})}return t}function un(s,n){var i,h;let t=ln(n);if(!t||t<=1)return[...s];let e=new Map,r=new Map,o=[];for(let a of s){let l=(i=a.series)!=null?i:"__no_series__",m=e.get(l);m||(m=[],e.set(l,m));let f=(h=r.get(l))!=null?h:0;if(m.push(a.y),f+=a.y,m.length>t){let p=m.shift();f-=p}r.set(l,f);let w=m.length||1,x=f/w;o.push({...a,y:x})}return o}var te=class{constructor(n,t){this.getIndex=n,this.defaultPaths=t}run(n){var i,h,a;let t=this.getIndex(),e=(i=n.source)!=null&&i.paths&&n.source.paths.length?n.source.paths:this.defaultPaths,r=(h=n.source)!=null&&h.tags&&n.source.tags.length?n.source.tags:[],o=[];for(let l of t){let m=e&&e.length?ke(l.path,e):!0,f=r&&r.length?Pe(l.props,r):!0;if(!m||!f)continue;let w=!0;if((a=n.source)!=null&&a.where&&n.source.where.length>0)for(let x of n.source.where){let p;try{p=Le(x)}catch(c){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${x} (${c.message})`)}if(!Ie(l.props,p)){w=!1;break}}w&&o.push(l)}return n.type==="gantt"?this.runGantt(n,o):n.type==="table"?this.runTable(n,o):this.runStandard(n,o)}runTable(n,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=n.encoding)==null?void 0:r.x,yField:(o=n.encoding)==null?void 0:o.y}}runGantt(n,t){var f,w,x;let e=(f=n.encoding)!=null?f:{},r=e.start,o=e.end,i=(w=e.label)!=null?w:e.x,h=e.series,a=e.duration,l=e.due,m=[];for(let p of t){let c=(x=p.props)!=null?x:{},C=R=>Array.isArray(R)?R[0]:R,I=null;if(o){let R=C(c[o]),v=$t(R);v&&(I=v)}if(!I)continue;let T=null;if(r){let R=C(c[r]),v=$t(R);v&&(T=v)}if(!T&&a){let R=C(c[a]),v=Number(R);Number.isNaN(v)||(T=new Date(I.getTime()-v*6e4))}T||(T=new Date(I.getTime()));let _;if(l){let R=C(c[l]),v=$t(R);v&&(_=v)}let M;if(i){let R=C(c[i]);(R==null||R==="")&&(R=p.path),M=R}else M=p.path;let N;if(h){let R=C(c[h]);R!=null&&(N=String(R))}let $={x:M,y:0,notes:[p.path],series:N,start:T,end:I,props:c};_&&($.due=_),m.push($)}return m.sort((p,c)=>{let C=p.start?p.start.getTime():0,I=c.start?c.start.getTime():0;return C-I}),{rows:m,xField:i,yField:o}}runStandard(n,t){var p,c,C,I,T,_,M,N,$,R;let e=(p=n.encoding)==null?void 0:p.x,r=(c=n.encoding)==null?void 0:c.y,o=(C=n.encoding)==null?void 0:C.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(I=n.aggregate)!=null?I:{},h=(T=i.y)!=null?T:null,a=!!i.cumulative,l=i.rolling;if(!r&&h!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let m=[];for(let v of t){let d=(_=v.props)!=null?_:{},S=Q=>Array.isArray(Q)?Q[0]:Q,D=S(d[e]);if(D==null)continue;let b=sn(D),P=b.key,z=b.isDate,j;if(o){let Q=S(d[o]);Q!=null&&String(Q).trim()!==""&&(j=String(Q))}let G;if(h==="count")G=1;else{let Q=S(d[r]);if(Q==null)continue;let Z=Number(Q);if(Number.isNaN(Z))continue;G=Z}m.push({x:P,y:G,notes:[v.path],series:j,props:d,_isDate:z,_origX:D})}if(m.length===0)return{rows:[],xField:e,yField:r};let f=[];if(h){let v=new Map;for(let d of m){let S=(M=d.series)!=null?M:"",D=d.x instanceof Date?d.x.toISOString().slice(0,10):String(d.x),b=S+"||"+D,P=(N=v.get(b))!=null?N:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:d.x,isDate:d._isDate,series:d.series,props:d.props};P.sum+=d.y,P.count+=1,d.y<P.min&&(P.min=d.y),d.y>P.max&&(P.max=d.y),P.notes.push(...d.notes),P.props=($=d.props)!=null?$:P.props,v.set(b,P)}for(let[,d]of v){let S=d.sum;switch(h){case"sum":S=d.sum;break;case"avg":S=d.sum/d.count;break;case"min":S=d.min;break;case"max":S=d.max;break;case"count":S=d.count;break}f.push({x:d.xRep,y:S,notes:d.notes,series:d.series,props:d.props})}}else f=m.map(v=>({x:v.x,y:v.y,notes:v.notes,series:v.series,props:v.props}));if(f.length===0)return{rows:[],xField:e,yField:r};let w=((R=n.sort)==null?void 0:R.x)==="desc"?"desc":"asc";if(f.sort((v,d)=>{let S=an(v,d);return w==="asc"?S:-S}),(a||l)&&!(n.type==="line"||n.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let x=f;return l?x=un(f,l):a&&(x=cn(f)),{rows:x,xField:e,yField:r}}};var Ct=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(s,n){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((e,r)=>e*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(s,n){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,n&&(e.style.background=n);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",e.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let h=s.createDiv({cls:"chart-notes-details"});return h.style.display="none",{scroll:t,inner:e,svg:o,tooltip:i,details:h}}function gt(s,n,t,e,r,o){let i=s.getBoundingClientRect(),h=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);n.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${h}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,n.style.display="block";let a=n.getBoundingClientRect(),l=o.clientX-i.left+6,m=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),m+a.height>i.height-4&&(m=i.height-a.height-4),m<4&&(m=4),n.style.left=l+"px",n.style.top=m+"px"}function ft(s){s.style.display="none"}function yt(s,n,t,e,r,o){if(!o)return;if(n.empty(),!r||r.length===0){n.style.display="none";return}n.style.display="block";let i=n.createEl("div",{cls:"chart-notes-details-header"}),h=i.createEl("div",{cls:"chart-notes-details-title"});h.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{n.style.display="none"});let l=n.createEl("ul",{cls:"chart-notes-details-list"});for(let m of r){let w=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:m});w.href="#",w.addEventListener("click",x=>{x.preventDefault(),app.workspace.openLinkText(m,"",!1)})}}function Gt(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let n=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${n}/${t}`}function _e(s){if(!s)return!1;let n=s.trim().toLowerCase();if(n==="#fff"||n==="#ffffff"||n==="white")return!0;if(!n.startsWith("#"))return!1;let t,e,r;if(n.length===4)t=parseInt(n[1]+n[1],16),e=parseInt(n[2]+n[2],16),r=parseInt(n[3]+n[3],16);else if(n.length===7)t=parseInt(n.slice(1,3),16),e=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*r)/255>.7}var pe=class extends Ct.Modal{constructor(t,e,r,o){var h;super(app);this.notePath=t,this.spec=e,this.refresh=r,this.reindexFile=o;let i=(h=e.encoding)!=null?h:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var R,v;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(e),o={},i=r,h=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(h){try{o=(R=(0,Ct.parseYaml)(h[1]))!=null?R:{}}catch(d){o={}}i=r.slice(h[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(v=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?v:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),m=l.createEl("a",{text:a,cls:"gantt-edit-title"});m.href="#",m.addEventListener("click",d=>{d.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let f=l.createDiv({cls:"gantt-edit-subtitle"});f.textContent=this.notePath;let w=t.createDiv({cls:"gantt-edit-form"}),x=d=>{let S=w.createDiv({cls:"gantt-edit-row"}),D=S.createDiv({cls:"gantt-edit-label"});D.textContent=d;let b=S.createDiv({cls:"gantt-edit-field"});return{row:S,field:b}},p=d=>{if(!d)return"";let D=String(d).match(/^(\d{4}-\d{2}-\d{2})/);return D?D[1]:""},c=d=>{if(d=d.trim(),!!d&&/^\d{4}-\d{2}-\d{2}$/.test(d))return d},C=null;if(this.startKey){let{field:d}=x(this.startKey+" (in\xEDcio)");C=d.createEl("input",{type:"date"}),C.value=p(o[this.startKey])}let I=null;if(this.endKey){let{field:d}=x(this.endKey+" (fim)");I=d.createEl("input",{type:"date"}),I.value=p(o[this.endKey])}let T=null;if(this.durationKey){let{field:d}=x(this.durationKey+" (minutos)");T=d.createEl("input",{type:"number"});let S=o[this.durationKey];T.value=S!=null?String(S):"",T.min="0",T.step="5"}let _=null;if(this.dueKey){let{field:d}=x(this.dueKey+" (due)");_=d.createEl("input",{type:"date"}),_.value=p(o[this.dueKey])}let M=t.createDiv({cls:"gantt-edit-buttons"}),N=M.createEl("button",{text:"Salvar",cls:"mod-cta"});M.createEl("button",{text:"Cancelar"}).addEventListener("click",d=>{d.preventDefault(),this.close()}),N.addEventListener("click",async d=>{if(d.preventDefault(),this.startKey&&C){let b=c(C.value);b?o[this.startKey]=b:delete o[this.startKey]}if(this.endKey&&I){let b=c(I.value);b?o[this.endKey]=b:delete o[this.endKey]}if(this.durationKey&&T){let b=T.value.trim();if(b==="")delete o[this.durationKey];else{let P=Number(b);Number.isNaN(P)||(o[this.durationKey]=P)}}if(this.dueKey&&_){let b=c(_.value);b?o[this.dueKey]=b:delete o[this.dueKey]}let D=`---
${(0,Ct.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(e,D),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(b){}if(this.refresh)try{this.refresh()}catch(b){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ee(s,n,t,e){var ye,be,xe,ve,Se,we,Ae,Ee;let r=(ye=n.options)!=null?ye:{},o=r.background,i=(be=r.drilldown)!=null?be:!0,h=!0,a=u=>{if(u==null)return"";let k=String(u).trim();if(!k)return"";let H=k.match(/^\[\[(.+?)\]\]$/);H&&(k=H[1]);let U=k.lastIndexOf("/");return U>=0&&U<k.length-1&&(k=k.slice(U+1)),k};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(u=>u.start&&u.end);if(l.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let m=n.encoding,f=m.group,w=m.duration,x=(u,k)=>{if(!u||!k)return;let H=u[k];return Array.isArray(H)?H[0]:H},c=l.map(u=>{var xt,ct;let k=u.start,H=u.end,U=u.props,It=typeof u.x=="string"?u.x:u.x instanceof Date?Gt(k):String(u.x),At=a(It),bt,Ft=f?x(U,f):void 0;Ft!=null?bt=String(Ft):u.series!=null?bt=String(u.series):bt=At;let mt=(xt=u.notes)==null?void 0:xt[0],Et=mt?(ct=mt.replace(/\.md$/i,"").split("/").pop())!=null?ct:mt:At,Rt=u.due,_t,kt=x(U,w);if(kt!=null){let vt=Number(kt);Number.isNaN(vt)||(_t=vt)}return{row:u,start:k,end:H,props:U,fullName:At,groupKey:bt,notePath:mt,noteTitle:Et,due:Rt,estMinutes:_t}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(c.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}c.sort((u,k)=>{if(u.groupKey<k.groupKey)return-1;if(u.groupKey>k.groupKey)return 1;let H=u.start.getTime(),U=k.start.getTime();return H!==U?H-U:u.fullName.localeCompare(k.fullName)});let C=26,I=0,T=null;for(let u of c)u.groupKey!==T&&(T=u.groupKey,I+=1),I+=1;let _=Math.min(...c.map(u=>u.start.getTime())),M=Math.max(...c.map(u=>u.end.getTime()));if(!isFinite(_)||!isFinite(M)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let N=24*60*60*1e3,$=u=>{let k=new Date(u);return k.setHours(0,0,0,0),k.getTime()},R=$(_),v=$(M),d=s.querySelector(".prop-charts-title-row");d||(d=s.createDiv({cls:"prop-charts-title-row"}));let S=s.dataset.ganttZoomMode||String((xe=r.zoomMode)!=null?xe:"100");s.dataset.ganttZoomMode=S;let D=s.dataset.ganttLabelMode||String((ve=r.labelMode)!=null?ve:"compact");s.dataset.ganttLabelMode=D;let b=d.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let k=b.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===S&&k.addClass("is-active"),k.addEventListener("click",H=>{H.preventDefault(),s.dataset.ganttZoomMode=u.id,ee(s,n,t,e)})}),b.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let k=s.querySelector(".chart-notes-zoom-button");k&&k.click()});let j=Number(r.labelWidth),G=!Number.isNaN(j)&&j>120?j:260,Q=D==="wide"?G+160:G,Z=s.getBoundingClientRect().width||600,et=Math.max(Z,820),F;if(S==="fit")F=Z;else{let u=Number(S)/100||1;F=et*u}let{inner:g,svg:y,tooltip:A,details:E}=wt(s,o);g.style.width=F+"px";let L=(u,k,H,U,It,At,bt,Ft,mt)=>{if(!u)return;let Et=Math.max(40,U-8),_t=Math.max(8,Math.floor(Et/6)),kt=u.split(/\s+/),xt=[],ct="";for(let Nt of kt){if(!ct){ct=Nt;continue}(ct+" "+Nt).length<=_t?ct+=" "+Nt:(xt.push(ct),ct=Nt)}ct&&xt.push(ct);let vt=It+2,Ot=xt.length*vt,Wt=H-Ot/2+It;xt.forEach((Nt,Ut)=>{let ot=document.createElementNS(y.namespaceURI,"text");ot.setAttribute("x",String(k)),ot.setAttribute("y",String(Wt+Ut*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Nt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),mt&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>mt(rt))),y.appendChild(ot)})},J=28,V=28,st=10,Y=Math.max(300,J+V+I*C+24);y.setAttribute("height",String(Y));let W=F-Q-st,K=J+6;y.style.color="#111111";let tt=v+N-R||1,at=R-tt*.02,ht=v+N+tt*.08,lt=u=>Q+(u-at)/(ht-at)*W,O=(ht-at)/N,Mt=Math.max(4,Math.min(12,Math.floor(W/90)||4)),dt=O/Mt,q=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=q[q.length-1];for(let u of q)if(u>=dt){pt=u;break}let Vt=[],Ge=$(at);for(let u=Ge;u<=ht+.5*N;u+=pt*N)Vt.push(u);let Ht=document.createElementNS(y.namespaceURI,"line");Ht.setAttribute("x1",String(Q)),Ht.setAttribute("y1",String(K)),Ht.setAttribute("x2",String(F-st)),Ht.setAttribute("y2",String(K)),Ht.setAttribute("stroke","#111111"),y.appendChild(Ht);for(let u of Vt){let k=lt(u),H=document.createElementNS(y.namespaceURI,"line");H.setAttribute("x1",String(k)),H.setAttribute("y1",String(K)),H.setAttribute("x2",String(k)),H.setAttribute("y2",String(Y-V)),H.setAttribute("stroke","#111111"),H.setAttribute("stroke-opacity","0.20"),H.setAttribute("stroke-dasharray","2,4"),y.appendChild(H);let U=document.createElementNS(y.namespaceURI,"text");U.setAttribute("x",String(k)),U.setAttribute("y",String(K-4)),U.setAttribute("text-anchor","middle"),U.setAttribute("font-size","10"),U.setAttribute("fill","#111111"),U.textContent=Gt(new Date(u)),y.appendChild(U)}let fe=new Date;fe.setHours(0,0,0,0);let oe=fe.getTime();if(oe>=at&&oe<=ht){let u=lt(oe),k=document.createElementNS(y.namespaceURI,"line");k.setAttribute("x1",String(u)),k.setAttribute("y1",String(K)),k.setAttribute("x2",String(u)),k.setAttribute("y2",String(Y-V)),k.setAttribute("stroke","#4caf50"),k.setAttribute("stroke-width","2"),k.setAttribute("stroke-dasharray","4,2"),y.appendChild(k);let H=document.createElementNS(y.namespaceURI,"text");H.setAttribute("x",String(u+4)),H.setAttribute("y",String(K+12)),H.setAttribute("font-size","10"),H.setAttribute("fill","#4caf50"),H.textContent="hoje",y.appendChild(H)}let Bt=g.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Bt.setAttr("title",D==="wide"?"Compactar nomes":"Expandir nomes"),Bt.style.left=`${Q}px`,Bt.style.top="4px",Bt.addEventListener("click",u=>{u.preventDefault();let H=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=H,ee(s,n,t,e)});let ze=["status","priority"],ie=Array.isArray(r.tooltipFields)?r.tooltipFields.map(u=>String(u)):null,Ve=ie&&ie.length?ie:ze,Qt=0,ae=null;for(let u of c){let k=u.start,H=u.end,U=(H.getTime()-k.getTime())/6e4,It=u.props,At=u.notePath,bt=u.noteTitle,Ft=(we=(Se=u.row.notes)==null?void 0:Se.length)!=null?we:0,mt=u.due,Et=u.estMinutes,Rt=[];Rt.push(`${Gt(k)} \u2192 ${Gt(H)}`),typeof Et=="number"&&!Number.isNaN(Et)?Rt.push(`est: ${Math.round(Et)} min`):U>0&&Rt.push(`dura\xE7\xE3o: ${Math.round(U)} min`),mt instanceof Date&&Rt.push(`due: ${Gt(mt)}`);for(let nt of Ve){let B=x(It,nt);B!=null&&String(B).trim()!==""&&Rt.push(`${nt}: ${String(B)}`)}let _t=Rt.join("<br>"),kt=nt=>{var B;nt.preventDefault(),h&&At?new pe(At,n,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(s,E,bt,Et!=null?Et:U,(B=u.row.notes)!=null?B:[],i)},xt=nt=>{bt&&_t&&gt(s,A,bt,_t,Ft,nt)},ct=()=>ft(A);if(u.groupKey!==ae){ae=u.groupKey;let nt=K+8+Qt*C+C/2,B=a(ae);L(B,4,nt,Q-12,11,"600"),Qt+=1}let vt=K+8+Qt*C,Ot=C-10,Wt=lt(k.getTime()),Nt=lt(H.getTime()),Ut=Math.max(4,Nt-Wt),ot=u.fullName,rt=document.createElementNS(y.namespaceURI,"rect");rt.setAttribute("x",String(Wt)),rt.setAttribute("y",String(vt)),rt.setAttribute("width",String(Ut)),rt.setAttribute("height",String(Ot)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=u.row.series)!=null?Ae:ot,Qt)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=h&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",ct),rt.addEventListener("click",kt),y.appendChild(rt);let De=vt+Ot/2;if(Ut>=6){let nt=it((Ee=u.row.series)!=null?Ee:ot,Qt),B=document.createElementNS(y.namespaceURI,"circle");B.setAttribute("cx",String(Wt)),B.setAttribute("cy",String(De)),B.setAttribute("r","3.5"),B.setAttribute("fill","#ffffff"),B.setAttribute("stroke",nt),B.setAttribute("stroke-width","1.5"),y.appendChild(B);let Pt=document.createElementNS(y.namespaceURI,"circle");Pt.setAttribute("cx",String(Nt)),Pt.setAttribute("cy",String(De)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),y.appendChild(Pt)}let Ce=vt+Ot/2+2,Yt=f?16:4;if(D==="wide")L(ot,Yt,Ce,Q-Yt-4,11,null,xt,ct,kt);else{let nt=ot,B=Math.max(40,Q-Yt-8),Re=Math.max(8,Math.floor(B/6));nt.length>Re&&(nt=nt.slice(0,Re-1)+"\u2026");let St=document.createElementNS(y.namespaceURI,"text");St.setAttribute("x",String(Yt)),St.setAttribute("y",String(Ce)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=nt,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",ct),St.addEventListener("click",kt),y.appendChild(St)}if(mt instanceof Date){let nt=lt(mt.getTime()),B=document.createElementNS(y.namespaceURI,"line");B.setAttribute("x1",String(nt)),B.setAttribute("y1",String(vt)),B.setAttribute("x2",String(nt)),B.setAttribute("y2",String(vt+Ot)),B.setAttribute("stroke","#ff6b6b"),B.setAttribute("stroke-width","2"),B.setAttribute("stroke-dasharray","4,2"),y.appendChild(B)}Qt+=1}if(h){let u=s.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function he(s,n,t){var Q,Z,et,F;let e=(Q=n.options)!=null?Q:{},r=e.background,o=(Z=e.drilldown)!=null?Z:!0,i=(et=t.rows)!=null?et:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:h,svg:a,tooltip:l,details:m}=wt(s,r),f=s.getBoundingClientRect().width||600,w=Math.max(f,480);h.style.width=w+"px";let x=40,p=16,c=18,C=28,I=300;a.setAttribute("height",String(I));let T=w-x-p,_=I-c-C,M=new Map;for(let g of i){let y=String(g.x),A=(F=M.get(y))!=null?F:{label:g.x,rows:[]};A.rows.push(g),M.set(y,A)}let $=Array.from(M.keys()).sort((g,y)=>g<y?-1:g>y?1:0).map(g=>M.get(g)),R=$.length,v=new Set;i.forEach(g=>{g.series!=null&&v.add(String(g.series))});let d=Array.from(v),S=d.length>1,D=S?"grouped":"single",b=0;i.forEach(g=>{g.y>b&&(b=g.y)}),(!isFinite(b)||b<=0)&&(b=1);let P=g=>c+_-g/(b||1)*_,z=P(0),j=4;for(let g=0;g<=j;g++){let y=b*g/j,A=P(y),E=document.createElementNS(a.namespaceURI,"line");E.setAttribute("x1",String(x)),E.setAttribute("y1",String(A)),E.setAttribute("x2",String(w-p)),E.setAttribute("y2",String(A)),E.setAttribute("stroke","#cccccc"),E.setAttribute("stroke-opacity","0.25"),a.appendChild(E);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(x-4)),L.setAttribute("y",String(A+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(y)),a.appendChild(L)}let G=R>0?T/R:T;if($.forEach((g,y)=>{let A=x+G*(y+.5),E=String(g.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(A)),L.setAttribute("y",String(I-C+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=E,a.appendChild(L)}),S){let g=s.createDiv({cls:"chart-notes-legend"});d.forEach((y,A)=>{let E=g.createDiv({cls:"chart-notes-legend-item"}),L=E.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=it(y,A),E.createSpan({text:y})})}$.forEach((g,y)=>{let A=x+G*(y+.5),E=g.rows;if(D==="single"){let Y=E[0],W=Y.y,K=G*.6,tt=A-K/2,at=P(W),ht=Math.max(2,z-at),lt=it("bar",y),O=document.createElementNS(a.namespaceURI,"rect");O.setAttribute("x",String(tt)),O.setAttribute("y",String(at)),O.setAttribute("width",String(K)),O.setAttribute("height",String(ht)),O.setAttribute("fill",lt),O.setAttribute("stroke","rgba(0,0,0,0.25)"),O.setAttribute("stroke-width","0.5"),O.style.cursor="pointer";let X=String(g.label),Mt=`valor: ${Math.round(W*100)/100}`;O.addEventListener("mouseenter",dt=>{var q,pt;return gt(s,l,X,Mt,(pt=(q=Y.notes)==null?void 0:q.length)!=null?pt:0,dt)}),O.addEventListener("mouseleave",()=>ft(l)),O.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(s,m,X,W,(q=Y.notes)!=null?q:[],o)}),a.appendChild(O);return}let L=d.length,J=G/Math.max(L+1,2),V=L*J,st=A-V/2;d.forEach((Y,W)=>{let K=E.find(q=>(q.series!=null?String(q.series):"")===Y);if(!K)return;let tt=K.y,at=st+W*J,ht=P(tt),lt=Math.max(2,z-ht),O=it(Y,W),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(at)),X.setAttribute("y",String(ht)),X.setAttribute("width",String(J)),X.setAttribute("height",String(lt)),X.setAttribute("fill",O),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let Mt=`${Y} @ ${String(g.label)}`,dt=`valor: ${Math.round(tt*100)/100}`;X.addEventListener("mouseenter",q=>{var pt,Vt;return gt(s,l,Mt,dt,(Vt=(pt=K.notes)==null?void 0:pt.length)!=null?Vt:0,q)}),X.addEventListener("mouseleave",()=>ft(l)),X.addEventListener("click",q=>{var pt;q.preventDefault(),yt(s,m,Mt,tt,(pt=K.notes)!=null?pt:[],o)}),a.appendChild(X)})})}function $e(s,n,t){var G,Q,Z,et;let e=(G=n.options)!=null?G:{},r=e.background,o=(Q=e.drilldown)!=null?Q:!0,i=(Z=t.rows)!=null?Z:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:h,svg:a,tooltip:l,details:m}=wt(s,r),f=s.getBoundingClientRect().width||600,w=Math.max(f,480);h.style.width=w+"px";let x=40,p=16,c=18,C=28,I=300;a.setAttribute("height",String(I));let T=w-x-p,_=I-c-C,M=new Map;for(let F of i){let g=String(F.x),y=(et=M.get(g))!=null?et:{label:F.x,rows:[]};y.rows.push(F),M.set(g,y)}let $=Array.from(M.keys()).sort((F,g)=>F<g?-1:F>g?1:0).map(F=>M.get(F)),R=$.length,v=new Set;i.forEach(F=>{F.series!=null&&v.add(String(F.series))});let d=Array.from(v);if(!d.length){he(s,n,t);return}let S=0;$.forEach(F=>{let g=F.rows.reduce((y,A)=>y+A.y,0);g>S&&(S=g)}),(!isFinite(S)||S<=0)&&(S=1);let D=F=>c+_-F/(S||1)*_,b=D(0),P=4;for(let F=0;F<=P;F++){let g=S*F/P,y=D(g),A=document.createElementNS(a.namespaceURI,"line");A.setAttribute("x1",String(x)),A.setAttribute("y1",String(y)),A.setAttribute("x2",String(w-p)),A.setAttribute("y2",String(y)),A.setAttribute("stroke","#cccccc"),A.setAttribute("stroke-opacity","0.25"),a.appendChild(A);let E=document.createElementNS(a.namespaceURI,"text");E.setAttribute("x",String(x-4)),E.setAttribute("y",String(y+3)),E.setAttribute("text-anchor","end"),E.setAttribute("font-size","10"),E.setAttribute("fill","#111111"),E.textContent=String(Math.round(g)),a.appendChild(E)}let z=R>0?T/R:T;$.forEach((F,g)=>{let y=x+z*(g+.5),A=String(F.label),E=document.createElementNS(a.namespaceURI,"text");E.setAttribute("x",String(y)),E.setAttribute("y",String(I-C+12)),E.setAttribute("text-anchor","middle"),E.setAttribute("font-size","10"),E.setAttribute("fill","#111111"),E.textContent=A,a.appendChild(E)});let j=s.createDiv({cls:"chart-notes-legend"});d.forEach((F,g)=>{let y=j.createDiv({cls:"chart-notes-legend-item"}),A=y.createDiv();A.style.width="10px",A.style.height="10px",A.style.borderRadius="999px",A.style.backgroundColor=it(F,g),y.createSpan({text:F})}),$.forEach((F,g)=>{let y=x+z*(g+.5),A=z*.6,E=y-A/2,L=0;d.forEach((J,V)=>{let st=F.rows.find(dt=>(dt.series!=null?String(dt.series):"")===J);if(!st)return;let Y=st.y,W=L,K=L+Y;L=K;let tt=D(W),at=D(K),ht=Math.max(2,tt-at),lt=it(J,V),O=document.createElementNS(a.namespaceURI,"rect");O.setAttribute("x",String(E)),O.setAttribute("y",String(at)),O.setAttribute("width",String(A)),O.setAttribute("height",String(ht)),O.setAttribute("fill",lt),O.setAttribute("stroke","rgba(0,0,0,0.25)"),O.setAttribute("stroke-width","0.5"),O.style.cursor="pointer";let X=`${J} @ ${String(F.label)}`,Mt=`valor: ${Math.round(Y*100)/100}`;O.addEventListener("mouseenter",dt=>{var q,pt;return gt(s,l,X,Mt,(pt=(q=st.notes)==null?void 0:q.length)!=null?pt:0,dt)}),O.addEventListener("mouseleave",()=>ft(l)),O.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(s,m,X,Y,(q=st.notes)!=null?q:[],o)}),a.appendChild(O)})})}function me(s,n,t,e){var Q,Z,et,F;let r=(Q=n.options)!=null?Q:{},o=r.background,i=(Z=r.drilldown)!=null?Z:!0,h=(et=t.rows)!=null?et:[];if(!h.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:m,details:f}=wt(s,o),w=s.getBoundingClientRect().width||600,x=Math.max(w,480);a.style.width=x+"px";let p=40,c=16,C=18,I=24,T=300;l.setAttribute("height",String(T));let _=x-p-c,M=T-C-I,N=new Map;for(let g of h){let y=g.series!=null?String(g.series):"__default__",A=(F=N.get(y))!=null?F:[];A.push(g),N.set(y,A)}let $=Array.from(N.keys()),R=[],v=new Set;for(let g of h){let y=String(g.x);v.has(y)||(v.add(y),R.push(g.x))}let d=R.length||1,S=g=>{let y=String(g),A=R.findIndex(E=>String(E)===y);return A<0?p:d===1?p+_/2:p+A/(d-1)*_},D=g=>String(g),b=Number.POSITIVE_INFINITY,P=Number.NEGATIVE_INFINITY;for(let g of h)g.y<b&&(b=g.y),g.y>P&&(P=g.y);(!isFinite(b)||!isFinite(P))&&(b=0,P=1),b===P&&(b===0?P=1:b=0);let z=g=>C+M-(g-b)/(P-b||1)*M,j=4;for(let g=0;g<=j;g++){let y=b+(P-b)*g/j,A=z(y),E=document.createElementNS(l.namespaceURI,"line");E.setAttribute("x1",String(p)),E.setAttribute("y1",String(A)),E.setAttribute("x2",String(x-c)),E.setAttribute("y2",String(A)),E.setAttribute("stroke","#cccccc"),E.setAttribute("stroke-opacity","0.25"),l.appendChild(E);let L=document.createElementNS(l.namespaceURI,"text");L.setAttribute("x",String(p-4)),L.setAttribute("y",String(A+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=Math.abs(y)>=100?String(Math.round(y)):String(Math.round(y*10)/10),l.appendChild(L)}let G=$.filter(g=>g!=="__default__");if(G.length>1){let g=s.createDiv({cls:"chart-notes-legend"});G.forEach((y,A)=>{let E=y,L=g.createDiv({cls:"chart-notes-legend-item"}),J=L.createDiv();J.style.width="10px",J.style.height="10px",J.style.borderRadius="999px",J.style.backgroundColor=it(E,A),L.createSpan({text:E})})}$.forEach((g,y)=>{let A=N.get(g);if(!(A!=null&&A.length))return;let E=g==="__default__"?it("line",y):it(g,y),L=[...A].sort((V,st)=>{let Y=R.findIndex(K=>String(K)===String(V.x)),W=R.findIndex(K=>String(K)===String(st.x));return Y-W}),J="";if(L.forEach((V,st)=>{let Y=S(V.x),W=z(V.y);J+=(st===0?"M ":" L ")+Y+" "+W}),e){let V=L[0],st=L[L.length-1],Y=S(V.x),W=S(st.x),K=z(b);J+=` L ${W} ${K} L ${Y} ${K} Z`;let tt=document.createElementNS(l.namespaceURI,"path");tt.setAttribute("d",J),tt.setAttribute("fill",E),tt.setAttribute("fill-opacity","0.18"),tt.setAttribute("stroke",E),tt.setAttribute("stroke-width","1.5"),l.appendChild(tt)}else{let V=document.createElementNS(l.namespaceURI,"path");V.setAttribute("d",J),V.setAttribute("fill","none"),V.setAttribute("stroke",E),V.setAttribute("stroke-width","2"),l.appendChild(V)}L.forEach(V=>{let st=S(V.x),Y=z(V.y),W=document.createElementNS(l.namespaceURI,"circle");W.setAttribute("cx",String(st)),W.setAttribute("cy",String(Y)),W.setAttribute("r","3"),W.setAttribute("fill","#ffffff"),W.setAttribute("stroke",E),W.setAttribute("stroke-width","1.5"),W.style.cursor="pointer";let K=D(V.x),tt=g==="__default__"?"":String(V.series),at=tt?`${tt} @ ${K}`:K,ht=`valor: ${Math.round(V.y*100)/100}`;W.addEventListener("mouseenter",lt=>{var O,X;return gt(s,m,at,ht,(X=(O=V.notes)==null?void 0:O.length)!=null?X:0,lt)}),W.addEventListener("mouseleave",()=>ft(m)),W.addEventListener("click",lt=>{var O;lt.preventDefault(),yt(s,f,at,V.y,(O=V.notes)!=null?O:[],i)}),l.appendChild(W)})})}function He(s,n,t){var _;let{background:e,drilldown:r=!0}=(_=n.options)!=null?_:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=_e(e)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:h,svg:a,tooltip:l,details:m}=wt(s,e),f=Math.max(i,420);h.style.width=f+"px",o&&(a.style.color=o);let w=300,x=f/2,p=(w-28+28)/2,c=Math.min(f/2-20,w/2-20),I=t.rows.map(M=>Math.max(0,M.y)).reduce((M,N)=>M+N,0)||1,T=-Math.PI/2;t.rows.forEach((M,N)=>{var G;let $=M.x instanceof Date?M.x.toISOString().slice(0,10):String(M.x),R=M.y,v=R/I*Math.PI*2,d=x+c*Math.cos(T),S=p+c*Math.sin(T),D=x+c*Math.cos(T+v),b=p+c*Math.sin(T+v),P=v>Math.PI?1:0,z=document.createElementNS(a.namespaceURI,"path"),j=[`M ${x} ${p}`,`L ${d} ${S}`,`A ${c} ${c} 0 ${P} 1 ${D} ${b}`,"Z"].join(" ");z.setAttribute("d",j),z.setAttribute("fill",it((G=M.series)!=null?G:$,N)),z.style.cursor="pointer",z.addEventListener("mouseenter",Q=>{var Z,et;return gt(s,l,$,R,(et=(Z=M.notes)==null?void 0:Z.length)!=null?et:0,Q)}),z.addEventListener("mouseleave",()=>ft(l)),z.addEventListener("click",()=>{var Q;return yt(s,m,$,R,(Q=M.notes)!=null?Q:[],r)}),a.appendChild(z),T+=v})}function Qe(s,n,t){var S;let{background:e,drilldown:r=!0}=(S=n.options)!=null?S:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=e?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:h,svg:a,tooltip:l,details:m}=wt(s,e),f=Math.max(i,700);h.style.width=f+"px",o&&(a.style.color=o);let w=300,x=f-48-10,p=w-28-28,c=t.rows.map(D=>{let b=D.x;if(b instanceof Date)return b.getTime();if(typeof b=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(b)){let z=new Date(b);if(!isNaN(z.getTime()))return z.getTime()}let P=Number(b);return isNaN(P)?null:P}return typeof b=="number"?b:null}),C=t.rows.map(D=>D.y),I=c.filter(D=>D!==null);if(I.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let T=Math.min(...I),_=Math.max(...I),M=Math.min(...C),N=Math.max(...C),$=D=>48+(D-T)/(_-T||1)*x,R=D=>w-28-(D-M)/(N-M||1)*p,v=document.createElementNS(a.namespaceURI,"line");v.setAttribute("x1",String(48)),v.setAttribute("y1",String(28)),v.setAttribute("x2",String(48)),v.setAttribute("y2",String(w-28)),v.setAttribute("stroke","currentColor"),a.appendChild(v);let d=document.createElementNS(a.namespaceURI,"line");d.setAttribute("x1",String(48)),d.setAttribute("y1",String(w-28)),d.setAttribute("x2",String(f-10)),d.setAttribute("y2",String(w-28)),d.setAttribute("stroke","currentColor"),a.appendChild(d),t.rows.forEach((D,b)=>{let P=c[b];if(P==null)return;let z=$(P),j=R(C[b]),G=document.createElementNS(a.namespaceURI,"circle");G.setAttribute("cx",String(z)),G.setAttribute("cy",String(j)),G.setAttribute("r","4"),G.setAttribute("fill",it(D.series,b)),G.style.cursor="pointer";let Q=D.x instanceof Date?D.x.toISOString().slice(0,10):typeof D.x=="string"?D.x:String(D.x);G.addEventListener("mouseenter",Z=>{var et,F;return gt(s,l,Q,D.y,(F=(et=D.notes)==null?void 0:et.length)!=null?F:0,Z)}),G.addEventListener("mouseleave",()=>ft(l)),G.addEventListener("click",Z=>{var et;Z.preventDefault(),yt(s,m,Q,D.y,(et=D.notes)!=null?et:[],r)}),a.appendChild(G)})}var Oe=require("obsidian"),re=class{render(n,t,e,r,o=!1){var l;let{title:i}=(l=t.options)!=null?l:{};n.empty(),n.addClass("prop-charts-container");let a=n.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":he(n,t,e);break;case"stacked-bar":$e(n,t,e);break;case"line":me(n,t,e,!1);break;case"area":me(n,t,e,!0);break;case"pie":He(n,t,e);break;case"scatter":Qe(n,t,e);break;case"gantt":ee(n,t,e,r);break;default:n.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!o){let m=n.createEl("button",{cls:"chart-notes-zoom-button"});m.setAttr("type","button"),m.setAttr("aria-label","Expandir gr\xE1fico"),m.textContent="\u2922",m.addEventListener("click",f=>{f.preventDefault(),new ge(t,e,this,r).open()})}}},ge=class extends Oe.Modal{constructor(t,e,r,o){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=r,this.ctx=o}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),r=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:r,cls:"chart-notes-zoom-title"});let o=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(l,m)=>{let f=o.createEl("button",{cls:"chart-notes-zoom-size-btn",text:l});(()=>{f.toggleClass("is-active",this.size===m)})(),f.addEventListener("click",x=>{x.preventDefault(),this.size=m,this.applySize(),o.querySelectorAll(".chart-notes-zoom-size-btn").forEach(c=>c.classList.remove("is-active")),f.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let h=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(h,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",r="85vh";switch(this.size){case"small":e="60vw",r="55vh";break;case"medium":e="80vw",r="70vh";break;case"large":default:e="95vw",r="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=r,t.style.maxHeight=r}};var se=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new jt(this.app),await this.indexer.buildIndex(),this.query=new te(()=>this.indexer.getAll(),[]),this.renderer=new re,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,r)=>{var m;let o;try{let f=(0,Lt.parseYaml)(t);if(!f||typeof f!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}o=f}catch(f){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+f.message});return}if(!o.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=o.type==="gantt",h=o.type==="table";if(!i&&!h){if(!o.encoding||!o.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let w=((m=o.aggregate)==null?void 0:m.y)==="count";if(!o.encoding.y&&!w){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}o.encoding||(o.encoding={}),o.source||(o.source={});let l;try{l=this.query.run(o)}catch(f){e.createEl("div",{text:"Chart Notes: erro na query: "+f.message});return}this.renderer.render(e,o,l)}),this.registerBasesView(ce,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new Xt(t,e,this.renderer),options:()=>[{type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},{type:"property",key:"xProperty",displayName:"X axis / label"},{type:"property",key:"yProperty",displayName:"Y axis / value (empty = count)"},{type:"property",key:"seriesProperty",displayName:"Series / color (optional)"},{type:"dropdown",key:"aggregateMode",displayName:"Aggregation (Y)",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum"},shouldHide:p=>{var C;let c=String((C=p.get("chartType"))!=null?C:"bar");return c==="scatter"||c==="gantt"}},{type:"property",key:"startProperty",displayName:"Start (Gantt)",shouldHide:p=>{var c;return String((c=p.get("chartType"))!=null?c:"")!=="gantt"}},{type:"property",key:"endProperty",displayName:"End (Gantt)",shouldHide:p=>{var c;return String((c=p.get("chartType"))!=null?c:"")!=="gantt"}},{type:"property",key:"dueProperty",displayName:"Due (Gantt, optional)",shouldHide:p=>{var c;return String((c=p.get("chartType"))!=null?c:"")!=="gantt"}},{type:"property",key:"durationProperty",displayName:"Duration in minutes (Gantt, optional)",shouldHide:p=>{var c;return String((c=p.get("chartType"))!=null?c:"")!=="gantt"}},{type:"property",key:"groupProperty",displayName:"Group / lane (Gantt, optional)",shouldHide:p=>{var c;return String((c=p.get("chartType"))!=null?c:"")!=="gantt"}},{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]})}onunload(){console.log("Chart Notes: unloading plugin")}};
