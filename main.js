/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var be=Object.defineProperty;var mn=Object.getOwnPropertyDescriptor;var fn=Object.getOwnPropertyNames;var hn=Object.prototype.hasOwnProperty;var gn=(s,r)=>{for(var t in r)be(s,t,{get:r[t],enumerable:!0})},yn=(s,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of fn(r))!hn.call(s,e)&&e!==t&&be(s,e,{get:()=>r[e],enumerable:!(n=mn(r,e))||n.enumerable});return s};var bn=s=>yn(be({},"__esModule",{value:!0}),s);var qn={};gn(qn,{default:()=>ye});module.exports=bn(qn);var Zt=require("obsidian");var le=require("obsidian"),xe="chartnotes-view",xn=["bar","stacked-bar","line","stacked-area","pie","scatter","gantt","metric"],Sn=["sum","count","cumulative-sum"];var ae="(missing)",wn="__no_series__",vn=60,Fe=6e4;function An(s){let r=String(s!=null?s:"bar").trim().toLowerCase();return xn.includes(r)?r:"bar"}function Dn(s){let r=String(s!=null?s:"sum").trim().toLowerCase();return Sn.includes(r)?r:"sum"}var ce=class extends le.BasesView{constructor(t,n,e){super(t);this.type=xe;this.renderer=e,this.rootEl=n.createDiv("chartnotes-bases-view")}onDataUpdated(){var W,Q,L,O,f,C,R,H,V,z,Y;this.rootEl.empty();let t=this.data,n=(W=t==null?void 0:t.groupedData)!=null?W:[];if(!n.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let e=this.config,o=An((Q=e==null?void 0:e.get("chartType"))!=null?Q:"bar"),i=o==="pie",l=o==="scatter",a=o==="gantt",c=o==="metric",m=Dn(e==null?void 0:e.get("aggregateMode")),p=m==="cumulative-sum"&&!(o==="line"||o==="stacked-area")?"sum":m,u=i||l||a?"none":"auto",h=this.getPropFromConfig("xProperty"),x=this.getPropFromConfig("ganttLabelProperty"),g=this.getPropFromConfig("yProperty"),N=this.getPropFromConfig("seriesProperty");i&&(N={id:null,name:null});let w=this.getPropFromConfig("startProperty"),A=this.getPropFromConfig("endProperty"),D=this.getPropFromConfig("dueProperty"),P=this.getPropFromConfig("durationProperty"),G=this.getPropFromConfig("groupProperty");if(!a&&!c&&!h.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(l&&(!h.id||!g.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(w.id||A.id||D.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Due with Duration."});return}let T=a&&x.id?x:a?h:{id:null,name:null},E;if(c){let J=this.getPropFromConfig("metricProperty"),U=String((L=e==null?void 0:e.get("metricOperation"))!=null?L:"count"),q=String((O=e==null?void 0:e.get("metricDataType"))!=null?O:"auto");E=this.buildRowsForMetric(n,J,U,q)}else if(a)E=this.buildRowsForGantt(n,T,N,w,A,D,P,G);else if(l)E=this.buildRowsForScatter(n,h,g,N);else{let J=i;E=this.buildRowsForAggregatedCharts(n,h,g,N,p,u,J)}if(!E.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let y={rows:E},b=((f=e==null?void 0:e.get("title"))!=null?f:"").trim()||(e==null?void 0:e.name)||"Chart Notes (Bases)",M=e==null?void 0:e.get("drilldown"),k=typeof M=="boolean"?M:!0,I=this.buildEncoding({x:h,y:g,series:N,start:w,end:A,due:D,duration:P,group:G,label:T,aggMode:p,chartType:o}),_={title:b,drilldown:k};c&&(_.metricLabel=(C=e==null?void 0:e.get("metricLabel"))!=null?C:"",_.metricLabelPosition=(R=e==null?void 0:e.get("metricLabelPosition"))!=null?R:"above",_.metricDecimals=(H=e==null?void 0:e.get("metricDecimals"))!=null?H:"0",_.metricPrefix=(V=e==null?void 0:e.get("metricPrefix"))!=null?V:"",_.metricSuffix=(z=e==null?void 0:e.get("metricSuffix"))!=null?z:"",_.metricColor=(Y=e==null?void 0:e.get("metricColor"))!=null?Y:"auto");let F={type:o,source:{type:"properties",query:""},encoding:I,options:_},$={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,F,y,$)}getPropFromConfig(t){var l,a;let n=this.config,e=(l=n==null?void 0:n.get)==null?void 0:l.call(n,t);if(!e)return{id:null,name:null};let o=e.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let c=(0,le.parsePropertyId)(i);return{id:i,name:(a=c.name)!=null?a:i}}catch(c){return{id:i,name:i}}}readValue(t,n){if(!n.id)return null;let e;try{e=t.getValue(n.id)}catch(o){return null}if(!e)return null;try{if(typeof e.isEmpty=="function"&&e.isEmpty())return null}catch(o){}try{let o=e.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=new Date(t.trim());return Number.isNaN(n.getTime())?null:n}compareX(t,n){let e=this.parseDate(t!=null?String(t):null),o=this.parseDate(n!=null?String(n):null);if(e&&o)return e.getTime()-o.getTime();let i=Number(t),l=Number(n);return!Number.isNaN(i)&&!Number.isNaN(l)?i-l:String(t!=null?t:"").localeCompare(String(n!=null?n:""))}fmtDate(t){let n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${e}-${o}`}startOfWeek(t){let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),e=(n.getDay()+6)%7;return n.setDate(n.getDate()-e),n.setHours(0,0,0,0),n}bucketX(t,n){let e=this.parseDate(t);if(!e)return t;switch(n){case"none":return t;case"auto":case"day":return this.fmtDate(new Date(e.getFullYear(),e.getMonth(),e.getDate()));case"week":{let o=this.startOfWeek(e);return`${this.fmtDate(o)} (W)`}case"month":{let o=String(e.getMonth()+1).padStart(2,"0");return`${e.getFullYear()}-${o}`}case"quarter":{let o=Math.floor(e.getMonth()/3)+1;return`${e.getFullYear()}-Q${o}`}case"year":return`${e.getFullYear()}`;default:return t}}getXValuesForEntry(t,n,e,o){var m,d;let i=[],l=p=>this.bucketX(p,e);if(!n.id){let p=t.file,u=p!=null&&p.name?String(p.name):String((m=p==null?void 0:p.path)!=null?m:ae);return i.push(l(u)),i}if(!o){let p=(d=this.readValue(t,n))!=null?d:ae;return i.push(l(p)),i}let a=null;try{a=t.getValue(n.id)}catch(p){a=null}let c=p=>{if(!p)return;let u=String(p).trim();u&&i.push(l(u))};if(a==null)c(ae);else if(typeof a=="string"){let p=a.trim();if(p){let u=p.split(/\s+/);for(let h of u)c(h)}}else if(Array.isArray(a))for(let p of a){if(p==null)continue;let u;try{u=p.toString()}catch(h){continue}c(u)}else if(typeof a.toArray=="function"){let p=a.toArray();if(Array.isArray(p))for(let u of p){if(u==null)continue;let h;try{h=u.toString()}catch(x){continue}c(h)}else{let u;try{u=a.toString()}catch(h){u=""}c(u)}}else{let p;try{p=a.toString()}catch(u){p=""}c(p)}return i.length||c(ae),i}buildRowsForAggregatedCharts(t,n,e,o,i,l,a){let c=new Map,m=a||i==="count"||!e.id&&i!=="sum",d=e.name||"y";for(let u of t)for(let h of u.entries){let x=h.file,g=this.getXValuesForEntry(h,n,l,a),N=1,w=null;if(!m&&e.id){if(w=this.readValue(h,e),w==null)continue;let P=Number(w);if(Number.isNaN(P))continue;N=P}else N=1;let A=this.readValue(h,o),D=A!=null?String(A):void 0;for(let P of g){let G=`${P}@@${D!=null?D:""}`,T=c.get(G);T||(T={x:P,y:0,series:D,notes:[],props:{}},c.set(G,T)),T.y+=N,x!=null&&x.path&&T.notes.push(x.path),T.props&&n.name&&(T.props[n.name]=P),!m&&T.props&&d&&w!=null&&(T.props[d]=T.y),m&&T.props&&(T.props[d]=T.y),T.props&&o.name&&A!=null&&(T.props[o.name]=A)}}let p=Array.from(c.values());return i==="cumulative-sum"?this.toCumulative(p):p}toCumulative(t){var o,i;let n=new Map;for(let l of t){let a=(o=l.series)!=null?o:wn,c=n.get(a);c||(c=[],n.set(a,c)),c.push(l)}let e=[];for(let[,l]of n){let a=[...l].sort((m,d)=>this.compareX(m.x,d.x)),c=0;for(let m of a){let d=Number((i=m.y)!=null?i:0);Number.isNaN(d)||(c+=d,e.push({...m,y:c}))}}return e.sort((l,a)=>this.compareX(l.x,a.x)),e}buildRowsForMetric(t,n,e,o){let i=[],l=[];for(let d of t)for(let p of d.entries){let u=p.file;if(u!=null&&u.path&&i.push(u.path),!n.id)continue;let h=this.readValue(p,n);if(h==null)continue;let x=Number(h),g=!Number.isNaN(x)&&Number.isFinite(x),N=this.parseDate(h),w=N!==null;l.push({value:h,isNumber:g,isDate:w,parsedNumber:g?x:null,parsedDate:N})}let a="text";if(o!=="auto")a=o;else if(l.length>0){let d=l[0];d.isNumber?a="number":d.isDate&&(a="date")}let c=0,m=null;if(!n.id)c=i.length;else if(e==="count"||e==="count-value"||e==="count-date")c=l.length;else if(a==="number"){let d=l.map(p=>p.parsedNumber).filter(p=>p!==null);if(d.length===0)c=0;else switch(e){case"sum":c=d.reduce((p,u)=>p+u,0);break;case"avg":c=d.reduce((p,u)=>p+u,0)/d.length;break;case"min":c=Math.min(...d);break;case"max":c=Math.max(...d);break;default:m="Operation incompatible with data type",c=0}}else if(a==="date"){let d=l.map(p=>p.parsedDate).filter(p=>p!==null);if(d.length===0)c=0;else switch(e){case"oldest":c=new Date(Math.min(...d.map(p=>p.getTime())));break;case"newest":c=new Date(Math.max(...d.map(p=>p.getTime())));break;default:m="Operation incompatible with data type",c=0}}else e!=="count"&&e!=="count-value"&&(m="Operation incompatible with data type"),c=l.length;return[{x:c instanceof Date?c.toISOString().slice(0,10):String(c),y:c instanceof Date?c.getTime():typeof c=="number"?c:0,notes:i,props:{_metricValue:c,_metricError:m,_metricDataType:a,_metricOperation:e}}]}buildRowsForScatter(t,n,e,o){let i=[];for(let l of t)for(let a of l.entries){let c=a.file,m=this.readValue(a,n),d=this.readValue(a,e);if(m==null||d==null)continue;let p=Number(m),u=Number(d);if(Number.isNaN(p)||Number.isNaN(u))continue;let h=this.readValue(a,o),x=h!=null?String(h):void 0;i.push({x:p,y:u,series:x,notes:c!=null&&c.path?[c.path]:[],props:{}})}return i}buildRowsForGantt(t,n,e,o,i,l,a,c){var x;let m=[],d=vn*Fe,p=g=>{let N=[g==null?void 0:g.label,g==null?void 0:g.name,g==null?void 0:g.value,g==null?void 0:g.key,g==null?void 0:g.group,g==null?void 0:g.groupLabel];for(let w of N)if(w!=null&&String(w).trim()!=="")return String(w);return""},u=n;try{let g=this.getPropFromConfig("ganttLabelProperty");g&&g.id&&(u=g)}catch(g){}let h=!!c.id;for(let g of t){let N=p(g);for(let w of(x=g.entries)!=null?x:[]){let A=w.file,D=this.readValue(w,o),P=this.readValue(w,i),G=this.readValue(w,l),T=this.readValue(w,a),E=T!=null?Number(T):NaN,y=Number.isFinite(E)&&E>0,v=y?E*Fe:d,b=this.parseDate(D),M=this.parseDate(P),k=this.parseDate(G),I=b,_=M;if(I&&!_&&(_=new Date(I.getTime()+v)),!I&&_&&(I=new Date(_.getTime()-v)),!I&&!_&&k&&(y?(_=k,I=new Date(k.getTime()-v)):(I=k,_=new Date(k.getTime()+d))),!I||!_)continue;if(I.getTime()>_.getTime()){let O=I;I=_,_=O}let F=this.readValue(w,u);(F==null||String(F).trim()==="")&&(A!=null&&A.name?F=String(A.name).replace(/\.md$/i,""):A!=null&&A.path?F=String(A.path):F="(no title)");let $=this.readValue(w,e),W=$!=null?String($):void 0,Q={};if(N&&(Q.__basesGroup=N),h){let O=this.readValue(w,c);O!=null&&c.name&&(Q[c.name]=O)}u.name&&(Q[u.name]=F),Q.label=F,o.name&&D!=null&&(Q[o.name]=D),i.name&&P!=null&&(Q[i.name]=P),l.name&&G!=null&&(Q[l.name]=G),y&&a.name&&(Q[a.name]=E);let L=A==null?void 0:A.path;m.push({x:F,y:0,series:W,start:I,end:_,due:k!=null?k:void 0,notes:L?[L]:[],props:Q})}}return m.sort((g,N)=>!g.start||!N.start?0:g.start.getTime()-N.start.getTime()),m}buildEncoding(t){var l,a,c,m,d,p,u,h,x,g,N;let n=(l=t.x.name)!=null?l:"x",e=(a=t.y.name)!=null?a:"y",o=(d=(m=(c=t.label.name)!=null?c:t.x.name)!=null?m:t.group.name)!=null?d:"label",i=t.chartType==="gantt"?"__basesGroup":(p=t.group.name)!=null?p:"group";return{x:n,y:e,series:(u=t.series.name)!=null?u:"series",start:(h=t.start.name)!=null?h:"start",end:(x=t.end.name)!=null?x:"end",due:(g=t.due.name)!=null?g:"due",duration:(N=t.duration.name)!=null?N:"duration",group:i,label:o}}};var Ve=require("obsidian"),ue=class{constructor(r){this.index=new Map;this.app=r}async buildIndex(){this.index.clear();let r=this.app.vault.getMarkdownFiles();for(let t of r)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(r){if(r.extension!=="md")return;let t={};try{let e=(await this.app.vault.read(r)).match(/^---\n([\s\S]*?)\n---\n?/);if(e){let i=(0,Ve.parseYaml)(e[1])||{};if(i&&typeof i=="object")for(let[l,a]of Object.entries(i))l!=="position"&&(t[l]=a)}let o=this.app.metadataCache.getFileCache(r);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",r.path,n)}this.index.set(r.path,{path:r.path,props:t})}removeFile(r){this.index.delete(r.path)}};function Oe(s,r){if(!r||r.length===0)return!0;for(let t of r){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Be(s,r){if(!r||r.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let e of r)if(t.includes(e)||t.includes("#"+e))return!0;return!1}let n=String(t);for(let e of r)if(n===e||n==="#"+e)return!0;return!1}function pe(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function Qt(s){if(s instanceof Date&&!isNaN(s.getTime()))return s;if(typeof s!="string")return null;let r=s.trim(),t=r.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?/);if(t){let e=Number(t[1]),o=Number(t[2])-1,i=Number(t[3]),l=t[4]?Number(t[4]):0,a=t[5]?Number(t[5]):0,c=t[6]?Number(t[6]):0;return Number.isNaN(e)||Number.isNaN(o)||Number.isNaN(i)||Number.isNaN(l)||Number.isNaN(a)||Number.isNaN(c)?null:new Date(e,o,i,l,a,c,0)}let n=new Date(r);return isNaN(n.getTime())?null:n}function ft(s){let r=new Date(s);return r.setHours(0,0,0,0),r}function de(s,r){let t=new Date(s);return t.setDate(t.getDate()-r),t}function En(s,r){return de(s,r*7)}function Nn(s,r){let t=new Date(s);return t.setMonth(t.getMonth()-r),t}function we(s,r){let t=new Date(s);return t.setDate(t.getDate()+r),t}function Tn(s,r){return we(s,r*7)}function Rn(s,r){let t=new Date(s);return t.setMonth(t.getMonth()+r),t}function He(s){let r=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(r)||r.endsWith("date")||r.endsWith("at")||r.endsWith("on"))}function Ge(s,r){let t=r?new Date(r):new Date,n=ft(t),e=s.trim().toLowerCase();if(e==="today")return n;if(e==="yesterday")return ft(de(n,1));if(/^-\d+$/.test(e)){let o=parseInt(e.slice(1),10);return ft(de(n,o))}if(/^-\d+d$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ft(de(n,o))}if(/^-\d+w$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ft(En(n,o))}if(/^-\d+m$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ft(Nn(n,o))}if(/^\+\d+$/.test(e)){let o=parseInt(e.slice(1),10);return ft(we(n,o))}if(/^\+\d+d$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ft(we(n,o))}if(/^\+\d+w$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ft(Tn(n,o))}if(/^\+\d+m$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ft(Rn(n,o))}return null}function Qe(s){let r=s.trim(),t=r.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let m=t[1].trim(),d=t[2].trim(),p=t[3].trim(),u=He(m),h=Se(d,u),x=Se(p,u),g=h.valueType==="date"||x.valueType==="date"?"date":h.valueType;return{field:m,op:"between",value:h.value,value2:x.value,valueType:g}}let n=/(==|!=|>=|<=|>|<)/,e=r.split(n);if(e.length!==3)throw new Error(`Invalid WHERE expression: ${s}`);let o=e[0].trim(),i=e[1].trim(),l=e[2].trim(),a=He(o),c=Se(l,a);return{field:o,op:i,value:c.value,valueType:c.valueType}}function Se(s,r){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),e=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(r){if(t==="0"||n==="today")return{value:ft(new Date),valueType:"date"};let i=Ge(t);if(i)return{value:i,valueType:"date"}}else if(e){let i=Ge(t);if(i)return{value:i,valueType:"date"}}if(pe(t)){let i=Qt(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ke(s,r){let t=s[r.field];if(t==null)return!1;if(r.valueType==="date"){let o=t instanceof Date?ft(t):pe(t)?ft(Qt(t)):null;if(!o)return!1;let i=r.value instanceof Date?r.value:null,l=r.value2 instanceof Date?r.value2:null;if(!i)return!1;let a=o.getTime(),c=ft(i).getTime();switch(r.op){case"==":return a===c;case"!=":return a!==c;case">":return a>c;case">=":return a>=c;case"<":return a<c;case"<=":return a<=c;case"between":if(!l)return!1;let m=ft(l).getTime();return a>=c&&a<=m}}if(r.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(r.value);switch(r.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof r.value2!="number"?!1:o>=i&&o<=r.value2}}let n=String(t),e=String(r.value);switch(r.op){case"==":return n===e;case"!=":return n!==e;case">":return n>e;case">=":return n>=e;case"<":return n<e;case"<=":return n<=e;case"between":return!1}return!1}var Ye="__no_series__",Cn="||",kn=6e4;function Mn(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(pe(s)){let r=Qt(s);if(r)return{key:r,isDate:!0}}return{key:s,isDate:!1}}function Ln(s,r){let t=s.x,n=r.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let e=String(t),o=String(n);return e<o?-1:e>o?1:0}function Pn(s,r){var o,i;let t=Ln(s,r);if(t!==0)return t;let n=(o=s.series)!=null?o:"",e=(i=r.series)!=null?i:"";return n<e?-1:n>e?1:0}function In(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let r=s.trim().match(/^(\d+)/);if(r){let t=Number(r[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`Invalid aggregate.rolling: ${String(s)}`)}function _n(s){var n,e;let r=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:Ye,a=((e=r.get(i))!=null?e:0)+o.y;r.set(i,a),t.push({...o,y:a})}return t}function $n(s,r){var i,l;let t=In(r);if(!t||t<=1)return[...s];let n=new Map,e=new Map,o=[];for(let a of s){let c=(i=a.series)!=null?i:Ye,m=n.get(c);m||(m=[],n.set(c,m));let d=(l=e.get(c))!=null?l:0;if(m.push(a.y),d+=a.y,m.length>t){let h=m.shift();d-=h}e.set(c,d);let p=m.length||1,u=d/p;o.push({...a,y:u})}return o}var me=class{constructor(r,t){this.getIndex=r,this.defaultPaths=t}run(r){var i,l,a;let t=this.getIndex(),n=(i=r.source)!=null&&i.paths&&r.source.paths.length?r.source.paths:this.defaultPaths,e=(l=r.source)!=null&&l.tags&&r.source.tags.length?r.source.tags:[],o=[];for(let c of t){let m=n&&n.length?Oe(c.path,n):!0,d=e&&e.length?Be(c.props,e):!0;if(!m||!d)continue;let p=!0;if((a=r.source)!=null&&a.where&&r.source.where.length>0)for(let u of r.source.where){let h;try{h=Qe(u)}catch(x){throw new Error(`Invalid condition: ${u} (${x.message})`)}if(!Ke(c.props,h)){p=!1;break}}p&&o.push(c)}return r.type==="gantt"?this.runGantt(r,o):r.type==="table"?this.runTable(r,o):this.runStandard(r,o)}runTable(r,t){var e,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(e=r.encoding)==null?void 0:e.x,yField:(o=r.encoding)==null?void 0:o.y}}runGantt(r,t){var d,p,u;let n=(d=r.encoding)!=null?d:{},e=n.start,o=n.end,i=(p=n.label)!=null?p:n.x,l=n.series,a=n.duration,c=n.due,m=[];for(let h of t){let x=(u=h.props)!=null?u:{},g=T=>Array.isArray(T)?T[0]:T,N=null;if(o){let T=g(x[o]),E=Qt(T);E&&(N=E)}if(!N)continue;let w=null;if(e){let T=g(x[e]),E=Qt(T);E&&(w=E)}if(!w&&a){let T=g(x[a]),E=Number(T);Number.isNaN(E)||(w=new Date(N.getTime()-E*kn))}w||(w=new Date(N.getTime()));let A;if(c){let T=g(x[c]),E=Qt(T);E&&(A=E)}let D;if(i){let T=g(x[i]);(T==null||T==="")&&(T=h.path),D=T}else D=h.path;let P;if(l){let T=g(x[l]);T!=null&&(P=String(T))}let G={x:D,y:0,notes:[h.path],series:P,start:w,end:N,props:x};A&&(G.due=A),m.push(G)}return m.sort((h,x)=>{let g=h.start?h.start.getTime():0,N=x.start?x.start.getTime():0;return g-N}),{rows:m,xField:i,yField:o}}runStandard(r,t){var h,x,g,N,w,A,D,P,G,T;let n=(h=r.encoding)==null?void 0:h.x,e=(x=r.encoding)==null?void 0:x.y,o=(g=r.encoding)==null?void 0:g.series;if(!n)throw new Error("encoding.x is required.");let i=(N=r.aggregate)!=null?N:{},l=(w=i.y)!=null?w:null,a=!!i.cumulative,c=i.rolling;if(!e&&l!=="count")throw new Error("encoding.y is required (except when aggregate.y = 'count').");let m=[];for(let E of t){let y=(A=E.props)!=null?A:{},v=$=>Array.isArray($)?$[0]:$,b=v(y[n]);if(b==null)continue;let M=Mn(b),k=M.key,I=M.isDate,_;if(o){let $=v(y[o]);$!=null&&String($).trim()!==""&&(_=String($))}let F;if(l==="count")F=1;else{let $=v(y[e]);if($==null)continue;let W=Number($);if(Number.isNaN(W))continue;F=W}m.push({x:k,y:F,notes:[E.path],series:_,props:y,_isDate:I,_origX:b})}if(m.length===0)return{rows:[],xField:n,yField:e};let d=[];if(l){let E=new Map;for(let y of m){let v=(D=y.series)!=null?D:"",b=y.x instanceof Date?y.x.toISOString().slice(0,10):String(y.x),M=v+Cn+b,k=(P=E.get(M))!=null?P:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:y.x,isDate:y._isDate,series:y.series,props:y.props};k.sum+=y.y,k.count+=1,y.y<k.min&&(k.min=y.y),y.y>k.max&&(k.max=y.y),k.notes.push(...y.notes),k.props=(G=y.props)!=null?G:k.props,E.set(M,k)}for(let[,y]of E){let v=y.sum;switch(l){case"sum":v=y.sum;break;case"avg":v=y.sum/y.count;break;case"min":v=y.min;break;case"max":v=y.max;break;case"count":v=y.count;break}d.push({x:y.xRep,y:v,notes:y.notes,series:y.series,props:y.props})}}else d=m.map(E=>({x:E.x,y:E.y,notes:E.notes,series:E.series,props:E.props}));if(d.length===0)return{rows:[],xField:n,yField:e};let p=((T=r.sort)==null?void 0:T.x)==="desc"?"desc":"asc";if(d.sort((E,y)=>{let v=Pn(E,y);return p==="asc"?v:-v}),(a||c)&&!(r.type==="line"||r.type==="stacked-area"))throw new Error("aggregate.cumulative / aggregate.rolling are only supported for type: 'line' or 'stacked-area'.");if(a&&c)throw new Error("It is not yet possible to use 'cumulative' and 'rolling' together in the same chart.");let u=d;return c?u=$n(d,c):a&&(u=_n(d)),{rows:u,xField:n,yField:e}}};var Rt=require("obsidian");var Ue=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function ut(s,r){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,e)=>n*33+e.charCodeAt(0)>>>0,0);return Ue[t%Ue.length]}function St(s,r){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,r&&(n.style.background=r);let e="http://www.w3.org/2000/svg",o=document.createElementNS(e,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let l=s.createDiv({cls:"chart-notes-details"});return l.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:l}}function yt(s,r,t,n,e,o){let i=s.getBoundingClientRect(),l=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);r.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${l}</div>
    <div class="chart-notes-tooltip-notes">${e} nota${e===1?"":"s"}</div>
  `,r.style.display="block";let a=r.getBoundingClientRect(),c=o.clientX-i.left+6,m=o.clientY-i.top+6;c+a.width>i.width-4&&(c=i.width-a.width-4),c<4&&(c=4),m+a.height>i.height-4&&(m=i.height-a.height-4),m<4&&(m=4),r.style.left=c+"px",r.style.top=m+"px"}function bt(s){s.style.display="none"}function pt(s,r,t,n,e,o){if(!o)return;if(r.empty(),!e||e.length===0){r.style.display="none";return}r.style.display="block";let i=r.createEl("div",{cls:"chart-notes-details-header"}),l=i.createEl("div",{cls:"chart-notes-details-title"});l.textContent=`Notas em "${t}" (${e.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{r.style.display="none"});let c=r.createEl("ul",{cls:"chart-notes-details-list"});for(let m of e){let p=c.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:m});p.href="#",p.addEventListener("click",u=>{u.preventDefault(),app.workspace.openLinkText(m,"",!1)})}}function Ft(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let r=s.getUTCDate().toString().padStart(2,"0"),t=(s.getUTCMonth()+1).toString().padStart(2,"0");return`${r}/${t}`}function We(s){if(!s)return!1;let r=s.trim().toLowerCase();if(r==="#fff"||r==="#ffffff"||r==="white")return!0;if(!r.startsWith("#"))return!1;let t,n,e;if(r.length===4)t=parseInt(r[1]+r[1],16),n=parseInt(r[2]+r[2],16),e=parseInt(r[3]+r[3],16);else if(r.length===7)t=parseInt(r.slice(1,3),16),n=parseInt(r.slice(3,5),16),e=parseInt(r.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*e)/255>.7}var ve=class extends Rt.Modal{constructor(t,n,e,o){var l;super(app);this.notePath=t,this.spec=n,this.refresh=e,this.reindexFile=o;let i=(l=n.encoding)!=null?l:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var T,E;let{contentEl:t}=this;t.empty(),this.titleEl.setText("Edit task");let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Rt.TFile)){t.createEl("p",{text:"File not found: "+this.notePath});return}this.titleEl.setText(`Edit task \u2013 ${n.basename}`);let e=await this.app.vault.read(n),o={},i=e,l=e.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);if(l){try{o=(T=(0,Rt.parseYaml)(l[1]))!=null?T:{}}catch(y){o={}}i=(E=l[2])!=null?E:""}let a=t.createDiv({cls:"gantt-edit-form"}),c=y=>{let v=a.createDiv({cls:"gantt-edit-row"}),b=v.createDiv({cls:"gantt-edit-label"});b.textContent=y;let M=v.createDiv({cls:"gantt-edit-field"});return{row:v,field:M}},m=y=>{if(!y)return null;if(y instanceof Date&&!isNaN(y.getTime()))return y;let b=String(y).trim().match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?/);if(!b)return null;let M=Number(b[1]),k=Number(b[2])-1,I=Number(b[3]),_=b[4]?Number(b[4]):0,F=b[5]?Number(b[5]):0,$=b[6]?Number(b[6]):0;return Number.isNaN(M)||Number.isNaN(k)||Number.isNaN(I)||Number.isNaN(_)||Number.isNaN(F)||Number.isNaN($)?null:new Date(M,k,I,_,F,$,0)},d=y=>{let v=m(y);if(!v)return"";let b=$=>$.toString().padStart(2,"0"),M=v.getFullYear(),k=b(v.getMonth()+1),I=b(v.getDate()),_=b(v.getHours()),F=b(v.getMinutes());return`${M}-${k}-${I}T${_}:${F}`},p=y=>{if(y=y.trim(),!y)return;let v=y.match(/^(\d{4})-(\d{2})-(\d{2})(?:T(\d{2}):(\d{2}))?$/);if(!v)return;let b=`${v[1]}-${v[2]}-${v[3]}`;if(v[4]){let M=v[4],k=v[5];return`${b}T${M}:${k}`}return b},u=null,h=null,x=null,g=null;if(this.startKey){let{field:y}=c(`In\xEDcio (${this.startKey})`);u=y.createEl("input"),u.type="datetime-local",u.value=d(o[this.startKey])}if(this.endKey){let{field:y}=c(`Fim (${this.endKey})`);h=y.createEl("input"),h.type="datetime-local",h.value=d(o[this.endKey])}if(this.durationKey){let{field:y}=c(`Dura\xE7\xE3o (min) (${this.durationKey})`);x=y.createEl("input"),x.type="number";let v=o[this.durationKey];x.value=typeof v=="number"&&!Number.isNaN(v)?String(v):""}if(this.dueKey){let{field:y}=c(`Due (${this.dueKey})`);g=y.createEl("input"),g.type="datetime-local",g.value=d(o[this.dueKey])}let N=a.createDiv({cls:"gantt-edit-actions-row"});N.style.marginTop="0.75rem",N.style.display="flex",N.style.justifyContent="space-between",N.style.alignItems="center";let w=N.createDiv({cls:"gantt-edit-actions-left"});w.style.display="flex";let A=N.createDiv({cls:"gantt-edit-actions-right"});A.style.display="flex",A.style.gap="0.5rem";let D=w.createEl("button",{text:"Open note"}),P=A.createEl("button",{text:"Save"}),G=A.createEl("button",{text:"Cancel"});D.addEventListener("click",()=>{this.app.workspace.openLinkText(this.notePath,"",!1),this.close()}),G.addEventListener("click",()=>this.close()),P.addEventListener("click",async()=>{if(this.startKey&&u){let b=p(u.value);b?o[this.startKey]=b:delete o[this.startKey]}if(this.endKey&&h){let b=p(h.value);b?o[this.endKey]=b:delete o[this.endKey]}if(this.durationKey&&x){let b=x.value.trim();if(b==="")delete o[this.durationKey];else{let M=Number(b);Number.isNaN(M)||(o[this.durationKey]=M)}}if(this.dueKey&&g){let b=p(g.value);b?o[this.dueKey]=b:delete o[this.dueKey]}let v=`---
${(0,Rt.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,v),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(b){}if(this.refresh)try{this.refresh()}catch(b){}new Rt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function fe(s,r,t,n){var Ne,Te,Re,Ce,ke,Me,Le,Pe;let e=(Ne=r.options)!=null?Ne:{},o=e.background,i=(Te=e.drilldown)!=null?Te:!0,l=!0,a=S=>{if(S==null)return"";let B=String(S).trim();if(!B)return"";let K=B.match(/^\[\[(.+?)\]\]$/);K&&(B=K[1]);let Z=B.lastIndexOf("/");return Z>=0&&Z<B.length-1&&(B=B.slice(Z+1)),B};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(S=>S.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"No data available."});return}let c=t.rows.filter(S=>S.start&&S.end);if(c.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: missing date fields."});return}let m=r.encoding,d=m.group,p=m.duration,u=(S,B)=>{if(!S||!B)return;let K=S[B];return Array.isArray(K)?K[0]:K},h="__chartnotes_no_group__",g=c.map(S=>{var mt,At;let B=S.start,K=S.end,Z=S.props,Bt=typeof S.x=="string"?S.x:S.x instanceof Date?Ft(B):String(S.x),Lt=a(Bt),Tt=d!=null&&d!==""?u(Z,d):void 0,Pt=Tt!=null&&String(Tt).trim().length>0?String(Tt):h,gt=(mt=S.notes)==null?void 0:mt[0],It=gt?(At=gt.replace(/\.md$/i,"").split("/").pop())!=null?At:gt:Lt,Wt=S.due,Ht,vt=u(Z,p);if(vt!=null){let _t=Number(vt);Number.isNaN(_t)||(Ht=_t)}return{row:S,start:B,end:K,props:Z,fullName:Lt,groupKey:Pt,notePath:gt,noteTitle:It,due:Wt,estMinutes:Ht}}).filter(S=>S.start instanceof Date&&!isNaN(S.start.getTime())&&S.end instanceof Date&&!isNaN(S.end.getTime()));if(g.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: invalid dates."});return}g.sort((S,B)=>{if(S.groupKey<B.groupKey)return-1;if(S.groupKey>B.groupKey)return 1;let K=S.start.getTime(),Z=B.start.getTime();return K!==Z?K-Z:S.fullName.localeCompare(B.fullName)});let N=26,w=0,A=null;for(let S of g)S.groupKey!==A&&(A=S.groupKey,S.groupKey!==h&&(w+=1)),w+=1;let D=Math.min(...g.map(S=>S.start.getTime())),P=Math.max(...g.map(S=>S.end.getTime()));if(!isFinite(D)||!isFinite(P)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: invalid date range."});return}let G=24*60*60*1e3,T=S=>{let B=new Date(S);return B.setHours(0,0,0,0),B.getTime()},E=T(D),y=T(P),v=s.querySelector(".prop-charts-title-row");v||(v=s.createDiv({cls:"prop-charts-title-row"}));let b=s.dataset.ganttZoomMode||String((Re=e.zoomMode)!=null?Re:"100");s.dataset.ganttZoomMode=b;let M=s.dataset.ganttLabelMode||String((Ce=e.labelMode)!=null?Ce:"compact");s.dataset.ganttLabelMode=M;let k=v.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(S=>{let B=k.createEl("button",{cls:"gantt-zoom-btn",text:S.label});S.id===b&&B.addClass("is-active"),B.addEventListener("click",K=>{K.preventDefault(),s.dataset.ganttZoomMode=S.id,fe(s,r,t,n)})});let _=Number(e.labelWidth),F=!Number.isNaN(_)&&_>120?_:260,$=M==="wide"?F+160:F,W=s.getBoundingClientRect().width||600,Q=Math.max(W,820),L;if(b==="fit")L=W;else{let S=Number(b)/100||1;L=Q*S}let{inner:O,svg:f,tooltip:C,details:R}=St(s,o);O.style.width=L+"px";let H=(S,B,K,Z,Bt,Lt,Tt,te,Pt)=>{if(!S)return;let gt=Math.max(40,Z-8),Wt=Math.max(8,Math.floor(gt/6)),Ht=S.split(/\s+/),vt=[],mt="";for(let $t of Ht){if(!mt){mt=$t;continue}(mt+" "+$t).length<=Wt?mt+=" "+$t:(vt.push(mt),mt=$t)}mt&&vt.push(mt);let At=Bt+2,_t=vt.length*At,ee=K-_t/2+Bt;vt.forEach(($t,oe)=>{let dt=document.createElementNS(f.namespaceURI,"text");dt.setAttribute("x",String(B)),dt.setAttribute("y",String(ee+oe*At)),dt.setAttribute("text-anchor","start"),dt.setAttribute("font-size",String(Bt)),dt.setAttribute("fill","#111111"),Lt&&dt.setAttribute("font-weight",Lt),dt.textContent=$t,Tt&&dt.addEventListener("mouseenter",lt=>Tt(lt)),te&&dt.addEventListener("mouseleave",()=>te()),Pt&&(dt.style.cursor="pointer",dt.addEventListener("click",lt=>Pt(lt))),f.appendChild(dt)})},V=28,z=28,Y=10,J=Math.max(300,V+z+w*N+24);f.setAttribute("height",String(J));let U=L-$-Y,q=V+6;f.style.color="#111111";let ot=y+G-E||1,nt=E-ot*.02,it=y+G+ot*.08,at=S=>$+(S-nt)/(it-nt)*U,tt=(it-nt)/G,X=Math.max(4,Math.min(12,Math.floor(U/90)||4)),ht=tt/X,ct=[1,2,3,5,7,10,14,21,30,60,90,180,365],rt=ct[ct.length-1];for(let S of ct)if(S>=ht){rt=S;break}let xt=[],wt=T(nt);for(let S=wt;S<=it+.5*G;S+=rt*G)xt.push(S);let Mt=document.createElementNS(f.namespaceURI,"line");Mt.setAttribute("x1",String($)),Mt.setAttribute("y1",String(q)),Mt.setAttribute("x2",String(L-Y)),Mt.setAttribute("y2",String(q)),Mt.setAttribute("stroke","#111111"),f.appendChild(Mt);for(let S of xt){let B=at(S),K=document.createElementNS(f.namespaceURI,"line");K.setAttribute("x1",String(B)),K.setAttribute("y1",String(q)),K.setAttribute("x2",String(B)),K.setAttribute("y2",String(J-z)),K.setAttribute("stroke","#111111"),K.setAttribute("stroke-opacity","0.20"),K.setAttribute("stroke-dasharray","2,4"),f.appendChild(K);let Z=document.createElementNS(f.namespaceURI,"text");Z.setAttribute("x",String(B)),Z.setAttribute("y",String(q-4)),Z.setAttribute("text-anchor","middle"),Z.setAttribute("font-size","10"),Z.setAttribute("fill","#111111"),Z.textContent=Ft(new Date(S)),f.appendChild(Z)}let Jt=new Date;Jt.setHours(0,0,0,0);let Kt=Jt.getTime();if(Kt>=nt&&Kt<=it){let S=at(Kt),B=document.createElementNS(f.namespaceURI,"line");B.setAttribute("x1",String(S)),B.setAttribute("y1",String(q)),B.setAttribute("x2",String(S)),B.setAttribute("y2",String(J-z)),B.setAttribute("stroke","#4caf50"),B.setAttribute("stroke-width","2"),B.setAttribute("stroke-dasharray","4,2"),f.appendChild(B);let K=document.createElementNS(f.namespaceURI,"text");K.setAttribute("x",String(S+4)),K.setAttribute("y",String(q+12)),K.setAttribute("font-size","10"),K.setAttribute("fill","#4caf50"),K.textContent="today",f.appendChild(K)}let Nt=O.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Nt.setAttr("title",M==="wide"?"Compact names":"Expand names"),Nt.style.left=`${$}px`,Nt.style.top="4px",Nt.addEventListener("click",S=>{S.preventDefault();let K=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=K,fe(s,r,t,n)});let Ot=["status","priority"],Yt=Array.isArray(e.tooltipFields)?e.tooltipFields.map(S=>String(S)):null,pn=Yt&&Yt.length?Yt:Ot,Ut=0,se=null;for(let S of g){let B=S.start,K=S.end,Z=(K.getTime()-B.getTime())/6e4,Bt=S.props,Lt=S.notePath,Tt=S.noteTitle,te=(Me=(ke=S.row.notes)==null?void 0:ke.length)!=null?Me:0,Pt=S.due,gt=S.estMinutes,It=[];It.push(`${Ft(B)} \u2192 ${Ft(K)}`),typeof gt=="number"&&!Number.isNaN(gt)?It.push(`est: ${Math.round(gt)} min`):Z>0&&It.push(`dura\xE7\xE3o: ${Math.round(Z)} min`),Pt instanceof Date&&It.push(`due: ${Ft(Pt)}`);for(let st of pn){let j=u(Bt,st);j!=null&&String(j).trim()!==""&&It.push(`${st}: ${String(j)}`)}let Wt=It.join("<br>"),Ht=st=>{var j;st.preventDefault(),l&&Lt?new ve(Lt,r,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():pt(s,R,Tt,gt!=null?gt:Z,(j=S.row.notes)!=null?j:[],i)},vt=st=>{Tt&&Wt&&yt(s,C,Tt,Wt,te,st)},mt=()=>bt(C);if(S.groupKey!==se&&(se=S.groupKey,se!==h)){let st=q+8+Ut*N+N/2,j=a(se);H(j,4,st,$-12,11,"600"),Ut+=1}let At=q+8+Ut*N,_t=N-10,ee=at(B.getTime()),$t=at(K.getTime()),oe=Math.max(4,$t-ee),dt=S.fullName,lt=document.createElementNS(f.namespaceURI,"rect");lt.setAttribute("x",String(ee)),lt.setAttribute("y",String(At)),lt.setAttribute("width",String(oe)),lt.setAttribute("height",String(_t)),lt.setAttribute("rx","3"),lt.setAttribute("ry","3"),lt.setAttribute("fill",ut((Le=S.row.series)!=null?Le:dt,Ut)),lt.setAttribute("stroke","rgba(0,0,0,0.25)"),lt.setAttribute("stroke-width","0.5"),lt.style.cursor=l&&Lt?"pointer":"default",lt.addEventListener("mouseenter",vt),lt.addEventListener("mouseleave",mt),lt.addEventListener("click",Ht),f.appendChild(lt);let Ie=At+_t/2;if(oe>=6){let st=ut((Pe=S.row.series)!=null?Pe:dt,Ut),j=document.createElementNS(f.namespaceURI,"circle");j.setAttribute("cx",String(ee)),j.setAttribute("cy",String(Ie)),j.setAttribute("r","3.5"),j.setAttribute("fill","#ffffff"),j.setAttribute("stroke",st),j.setAttribute("stroke-width","1.5"),f.appendChild(j);let Gt=document.createElementNS(f.namespaceURI,"circle");Gt.setAttribute("cx",String($t)),Gt.setAttribute("cy",String(Ie)),Gt.setAttribute("r","3.5"),Gt.setAttribute("fill","#ffffff"),Gt.setAttribute("stroke",st),Gt.setAttribute("stroke-width","1.5"),f.appendChild(Gt)}let _e=At+_t/2+2,ie=4;if(M==="wide")H(dt,ie,_e,$-ie-4,11,null,vt,mt,Ht);else{let st=dt,j=Math.max(40,$-ie-8),$e=Math.max(8,Math.floor(j/6));st.length>$e&&(st=st.slice(0,$e-1)+"\u2026");let Dt=document.createElementNS(f.namespaceURI,"text");Dt.setAttribute("x",String(ie)),Dt.setAttribute("y",String(_e)),Dt.setAttribute("text-anchor","start"),Dt.setAttribute("font-size","11"),Dt.setAttribute("fill","#111111"),Dt.textContent=st,Dt.style.cursor="pointer",Dt.addEventListener("mouseenter",vt),Dt.addEventListener("mouseleave",mt),Dt.addEventListener("click",Ht),f.appendChild(Dt)}if(Pt instanceof Date){let st=at(Pt.getTime()),j=document.createElementNS(f.namespaceURI,"line");j.setAttribute("x1",String(st)),j.setAttribute("y1",String(At)),j.setAttribute("x2",String(st)),j.setAttribute("y2",String(At+_t)),j.setAttribute("stroke","#ff6b6b"),j.setAttribute("stroke-width","2"),j.setAttribute("stroke-dasharray","4,2"),f.appendChild(j)}Ut+=1}if(l){let S=s.createDiv({cls:"prop-charts-empty"});S.textContent="Click on a bar or name to adjust dates and task estimate."}}function Ae(s,r,t){var W,Q,L,O;let n=(W=r.options)!=null?W:{},e=n.background,o=(Q=n.drilldown)!=null?Q:!0,i=(L=t.rows)!=null?L:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"No data available."});return}let{inner:l,svg:a,tooltip:c,details:m}=St(s,e),d=s.getBoundingClientRect().width||600,p=Math.max(d,480);l.style.width=p+"px";let u=40,h=16,x=18,g=28,N=300;a.setAttribute("height",String(N));let w=p-u-h,A=N-x-g,D=new Map;for(let f of i){let C=String(f.x),R=(O=D.get(C))!=null?O:{label:f.x,rows:[]};R.rows.push(f),D.set(C,R)}let G=Array.from(D.keys()).sort((f,C)=>f<C?-1:f>C?1:0).map(f=>D.get(f)),T=G.length,E=f=>String(f!=null?f:""),y=new Set;i.forEach(f=>{f.series!=null&&y.add(E(f.series))});let v=Array.from(y),b=v.length>1,M=b?"grouped":"single",k=0;i.forEach(f=>{f.y>k&&(k=f.y)}),(!isFinite(k)||k<=0)&&(k=1);let I=f=>x+A-f/(k||1)*A,_=I(0),F=4;for(let f=0;f<=F;f++){let C=k*f/F,R=I(C),H=document.createElementNS(a.namespaceURI,"line");H.setAttribute("x1",String(u)),H.setAttribute("y1",String(R)),H.setAttribute("x2",String(p-h)),H.setAttribute("y2",String(R)),H.setAttribute("stroke","#cccccc"),H.setAttribute("stroke-opacity","0.25"),a.appendChild(H);let V=document.createElementNS(a.namespaceURI,"text");V.setAttribute("x",String(u-4)),V.setAttribute("y",String(R+3)),V.setAttribute("text-anchor","end"),V.setAttribute("font-size","10"),V.setAttribute("fill","#111111"),V.textContent=String(Math.round(C)),a.appendChild(V)}let $=T>0?w/T:w;if(G.forEach((f,C)=>{let R=u+$*(C+.5),H=String(f.label),V=document.createElementNS(a.namespaceURI,"text");V.setAttribute("x",String(R)),V.setAttribute("y",String(N-g+12)),V.setAttribute("text-anchor","middle"),V.setAttribute("font-size","10"),V.setAttribute("fill","#111111"),V.textContent=H,a.appendChild(V)}),b){let f=s.createDiv({cls:"chart-notes-legend"});v.forEach((C,R)=>{let H=f.createDiv({cls:"chart-notes-legend-item"}),V=H.createDiv();V.style.width="10px",V.style.height="10px",V.style.borderRadius="999px",V.style.backgroundColor=ut(C,R),H.createSpan({text:C})})}G.forEach((f,C)=>{let R=u+$*(C+.5),H=f.rows;if(M==="single"){let U=H[0],q=U.y,ot=$*.6,nt=R-ot/2,it=I(q),at=Math.max(2,_-it),tt=ut("bar",C),et=document.createElementNS(a.namespaceURI,"rect");et.setAttribute("x",String(nt)),et.setAttribute("y",String(it)),et.setAttribute("width",String(ot)),et.setAttribute("height",String(at)),et.setAttribute("fill",tt),et.setAttribute("stroke","rgba(0,0,0,0.25)"),et.setAttribute("stroke-width","0.5"),et.style.cursor="pointer";let X=String(f.label),ht=`valor: ${Math.round(q*100)/100}`;et.addEventListener("mouseenter",ct=>{var rt,xt;return yt(s,c,X,ht,(xt=(rt=U.notes)==null?void 0:rt.length)!=null?xt:0,ct)}),et.addEventListener("mouseleave",()=>bt(c)),et.addEventListener("click",ct=>{var rt;ct.preventDefault(),pt(s,m,X,q,(rt=U.notes)!=null?rt:[],o)}),a.appendChild(et);return}let V=v.length,z=$/Math.max(V+1,2),Y=V*z,J=R-Y/2;v.forEach((U,q)=>{let ot=H.find(rt=>rt.series!=null&&E(rt.series)===U);if(!ot)return;let nt=ot.y,it=J+q*z,at=I(nt),tt=Math.max(2,_-at),et=ut(U,q),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(it)),X.setAttribute("y",String(at)),X.setAttribute("width",String(z)),X.setAttribute("height",String(tt)),X.setAttribute("fill",et),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let ht=`${U} @ ${String(f.label)}`,ct=`valor: ${Math.round(nt*100)/100}`;X.addEventListener("mouseenter",rt=>{var xt,wt;return yt(s,c,ht,ct,(wt=(xt=ot.notes)==null?void 0:xt.length)!=null?wt:0,rt)}),X.addEventListener("mouseleave",()=>bt(c)),X.addEventListener("click",rt=>{var xt;rt.preventDefault(),pt(s,m,ht,nt,(xt=ot.notes)!=null?xt:[],o)}),a.appendChild(X)})})}function Xe(s,r,t){var F,$,W,Q;let n=(F=r.options)!=null?F:{},e=n.background,o=($=n.drilldown)!=null?$:!0,i=(W=t.rows)!=null?W:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"No data available."});return}let l=new Map;for(let L of i){let O=String(L.x),f=(Q=l.get(O))!=null?Q:{label:L.x,rows:[]};f.rows.push(L),l.set(O,f)}let c=Array.from(l.keys()).sort((L,O)=>L<O?-1:L>O?1:0).map(L=>l.get(L)),m=c.length,d=L=>String(L!=null?L:""),p=new Set(i.map(L=>d(L.series))),u=Array.from(p);if(u.length===1&&u[0]===""){Ae(s,r,t);return}let{inner:h,svg:x,tooltip:g,details:N}=St(s,e),w=s.getBoundingClientRect().width||600,A=Math.max(w,480);h.style.width=A+"px",x.setAttribute("width",String(A));let D=40,P=16,G=18,T=28,E=300;x.setAttribute("height",String(E));let y=A-D-P,v=E-G-T,b=0;c.forEach(L=>{let O=L.rows.reduce((f,C)=>f+(C.y||0),0);O>b&&(b=O)}),(!isFinite(b)||b<=0)&&(b=1);let M=L=>G+v-L/(b||1)*v,k=4;for(let L=0;L<=k;L++){let O=b*L/k,f=M(O),C=document.createElementNS(x.namespaceURI,"line");C.setAttribute("x1",String(D)),C.setAttribute("y1",String(f)),C.setAttribute("x2",String(A-P)),C.setAttribute("y2",String(f)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),x.appendChild(C);let R=document.createElementNS(x.namespaceURI,"text");R.setAttribute("x",String(D-4)),R.setAttribute("y",String(f+3)),R.setAttribute("text-anchor","end"),R.setAttribute("font-size","10"),R.setAttribute("fill","#111111"),R.textContent=String(Math.round(O)),x.appendChild(R)}let I=m>0?y/m:y;c.forEach((L,O)=>{let f=D+I*(O+.5),C=String(L.label),R=document.createElementNS(x.namespaceURI,"text");R.setAttribute("x",String(f)),R.setAttribute("y",String(E-T+12)),R.setAttribute("text-anchor","middle"),R.setAttribute("font-size","10"),R.setAttribute("fill","#111111"),R.textContent=C,x.appendChild(R)});let _=h.createDiv({cls:"chart-notes-legend"});u.forEach((L,O)=>{if(L==="")return;let f=_.createDiv({cls:"chart-notes-legend-item"}),C=f.createDiv();C.style.width="10px",C.style.height="10px",C.style.borderRadius="999px",C.style.backgroundColor=ut(L,O),f.createSpan({text:L})}),c.forEach((L,O)=>{let f=D+I*(O+.5),C=I*.6,R=f-C/2,H=0;u.forEach((V,z)=>{if(V==="")return;let Y=L.rows.find(ht=>d(ht.series)===V);if(!Y)return;let J=Y.y||0,U=H,q=H+J;H=q;let ot=M(U),nt=M(q),it=Math.max(2,ot-nt),at=ut(V,z),tt=document.createElementNS(x.namespaceURI,"rect");tt.setAttribute("x",String(R)),tt.setAttribute("y",String(nt)),tt.setAttribute("width",String(C)),tt.setAttribute("height",String(it)),tt.setAttribute("fill",at),tt.setAttribute("stroke","rgba(0,0,0,0.25)"),tt.setAttribute("stroke-width","0.5"),tt.style.cursor="pointer";let et=`${V} @ ${String(L.label)}`,X=`valor: ${Math.round(J*100)/100}`;tt.addEventListener("mouseenter",ht=>{var ct,rt;return yt(s,g,et,X,(rt=(ct=Y.notes)==null?void 0:ct.length)!=null?rt:0,ht)}),tt.addEventListener("mouseleave",()=>bt(g)),tt.addEventListener("click",ht=>{var ct;ht.preventDefault(),pt(s,N,et,J,(ct=Y.notes)!=null?ct:[],o)}),x.appendChild(tt)})})}var Ct=40,zt=16,qt=18,je=28,Fn=.6,Vn=2,ne="__default__";var De=[1,2,3,5,7,10,14,21,30,60,90,180,365],Hn=90,ze=3,Gn=10,jt=.02,qe=4,On=100,Ze="No data available.";function kt(s){if(!s)return null;if(s instanceof Date){let r=s.getTime();return Number.isNaN(r)?null:s}if(typeof s=="string"){let r=s.trim();if(!r||/^\d+$/.test(r))return null;let t=new Date(r);if(!Number.isNaN(t.getTime()))return t}return null}function Je(s){var t;let r=new Map;for(let n of s){let e=n.series!=null&&n.series!==""?String(n.series):ne,o=(t=r.get(e))!=null?t:[];o.push(n),r.set(e,o)}return r}function tn(s){let r=s.map(t=>kt(t.x)).filter(t=>!!t);return r.length>=Vn&&r.length>=s.length*Fn}function en(s,r,t){let o=s.map(u=>kt(u.x)).filter(u=>!!u).map(u=>u.getTime()).sort((u,h)=>u-h),i=o[0],l=o[o.length-1];i===l&&(i-=864e5,l+=864e5);let a=l-i||864e5,c=i-a*jt,m=l+a*jt;return{xScale:u=>{let h=kt(u);if(!h)return t;let x=h.getTime();return t+(x-c)/(m-c||1)*r},xLabelOf:u=>{let h=kt(u);return h?Ft(h):String(u)}}}function nn(s,r,t){let n=[],e=new Set;for(let a of s){let c=String(a.x);e.has(c)||(e.add(c),n.push(a.x))}let o=n.length||1;return{xScale:a=>{let c=String(a),m=n.findIndex(d=>String(d)===c);return m<0?t:o===1?t+r/2:t+m/(o-1)*r},xLabelOf:a=>String(a)}}function rn(s,r,t,n,e,o,i,l,a){let m=i+e,d=document.createElementNS(s.namespaceURI,"line");d.setAttribute("x1",String(o)),d.setAttribute("y1",String(m)),d.setAttribute("x2",String(a-l)),d.setAttribute("y2",String(m)),d.setAttribute("stroke","#111111"),d.setAttribute("stroke-width","1"),s.appendChild(d);let p=(t-r)/864e5,u=Math.max(ze,Math.min(Gn,Math.floor(n/Hn)||ze)),h=p/u,x=De[De.length-1];for(let w of De)if(w>=h){x=w;break}let N=(w=>{let A=new Date(w);return A.setHours(0,0,0,0),A.getTime()})(r);for(let w=N;w<=t+.5*864e5;w+=x*864e5){let A=o+(w-r)/(t-r)*n,D=document.createElementNS(s.namespaceURI,"line");D.setAttribute("x1",String(A)),D.setAttribute("y1",String(i)),D.setAttribute("x2",String(A)),D.setAttribute("y2",String(m)),D.setAttribute("stroke","#111111"),D.setAttribute("stroke-opacity","0.18"),D.setAttribute("stroke-dasharray","2,4"),s.appendChild(D);let P=document.createElementNS(s.namespaceURI,"text");P.setAttribute("x",String(A)),P.setAttribute("y",String(m+12)),P.setAttribute("text-anchor","middle"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=Ft(new Date(w)),s.appendChild(P)}}function Bn(s){let r=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY;for(let n of s)n.y<r&&(r=n.y),n.y>t&&(t=n.y);return!isFinite(r)||!isFinite(t)?{min:0,max:1}:r===t?r===0?{min:0,max:1}:{min:0,max:t}:{min:r,max:t}}function sn(s,r,t,n){return e=>n+t-(e-s)/(r-s||1)*t}function on(s,r,t,n,e,o,i){for(let l=0;l<=qe;l++){let a=r+(t-r)*l/qe,c=n(a),m=document.createElementNS(s.namespaceURI,"line");m.setAttribute("x1",String(o)),m.setAttribute("y1",String(c)),m.setAttribute("x2",String(e+o+i)),m.setAttribute("y2",String(c)),m.setAttribute("stroke","#cccccc"),m.setAttribute("stroke-opacity","0.25"),s.appendChild(m);let d=document.createElementNS(s.namespaceURI,"text");d.setAttribute("x",String(o-4)),d.setAttribute("y",String(c+3)),d.setAttribute("text-anchor","end"),d.setAttribute("font-size","10"),d.setAttribute("fill","#111111"),d.textContent=Math.abs(a)>=On?String(Math.round(a)):String(Math.round(a*10)/10),s.appendChild(d)}}function an(s,r,t=!0){let n=t?r.filter(o=>o!==ne):r;if(n.length<=1)return;let e=s.createDiv({cls:"chart-notes-legend"});n.forEach((o,i)=>{let l=e.createDiv({cls:"chart-notes-legend-item"}),a=l.createDiv();a.style.width="10px",a.style.height="10px",a.style.borderRadius="999px",a.style.backgroundColor=ut(o,i),l.createSpan({text:o})})}function Qn(s,r){let t=[...s];return r&&t.sort((n,e)=>{let o=kt(n.x),i=kt(e.x),l=o?o.getTime():0,a=i?i.getTime():0;return l-a}),t}function Kn(s,r,t,n,e){let o="";if(s.forEach((i,l)=>{let a=r(i.x),c=t(i.y);o+=l===0?`M ${a} ${c}`:` L ${a} ${c}`}),n&&s.length>0){let i=s[0],l=s[s.length-1],a=r(i.x),c=r(l.x),m=t(e);o+=` L ${c} ${m} L ${a} ${m} Z`}return o}function Yn(s,r,t,n,e,o,i,l,a,c,m){r.forEach(d=>{let p=t(d.x),u=n(d.y),h=document.createElementNS(s.namespaceURI,"circle");h.setAttribute("cx",String(p)),h.setAttribute("cy",String(u)),h.setAttribute("r","3"),h.setAttribute("fill","#ffffff"),h.setAttribute("stroke",o),h.setAttribute("stroke-width","1.5"),h.style.cursor="pointer";let x=e(d.x),g=i?`${i} @ ${x}`:x,N=`value: ${Math.round(d.y*100)/100}`;h.addEventListener("mouseenter",w=>{var A,D;return yt(l,a,g,N,(D=(A=d.notes)==null?void 0:A.length)!=null?D:0,w)}),h.addEventListener("mouseleave",()=>bt(a)),h.addEventListener("click",w=>{var A;w.preventDefault(),pt(l,c,g,d.y,(A=d.notes)!=null?A:[],m)}),s.appendChild(h)})}function Ee(s,r,t,n){var v,b,M;let e=(v=r.options)!=null?v:{},o=e.background,i=(b=e.drilldown)!=null?b:!0,l=(M=t.rows)!=null?M:[];if(!l.length){s.createDiv({cls:"prop-charts-empty",text:Ze});return}let{inner:a,svg:c,tooltip:m,details:d}=St(s,o),p=s.getBoundingClientRect().width||600,u=Math.max(p,480);a.style.width=u+"px";let h=300;c.setAttribute("height",String(h));let x=u-Ct-zt,g=h-qt-je,N=tn(l),w=Je(l),A=Array.from(w.keys()),D=N?en(l,x,Ct):nn(l,x,Ct),{xScale:P,xLabelOf:G}=D;if(N){let I=l.map(O=>kt(O.x)).filter(O=>!!O).map(O=>O.getTime()).sort((O,f)=>O-f),_=I[0],F=I[I.length-1],$=24*60*60*1e3;_===F&&(_-=$,F+=$);let W=F-_||$,Q=_-W*jt,L=F+W*jt;rn(c,Q,L,x,g,Ct,qt,zt,u)}let{min:T,max:E}=Bn(l),y=sn(T,E,g,qt);on(c,T,E,y,x,Ct,zt),an(s,A),A.forEach((k,I)=>{let _=w.get(k);if(!(_!=null&&_.length))return;let F=k===ne?ut("line",I):ut(k,I),$=Qn(_,N),W=Kn($,P,y,n,T),Q=document.createElementNS(c.namespaceURI,"path");Q.setAttribute("d",W),Q.setAttribute("fill",n?F:"none"),Q.setAttribute("fill-opacity",n?"0.18":"0"),Q.setAttribute("stroke",F),Q.setAttribute("stroke-width",n?"1.5":"2"),c.appendChild(Q);let L=k===ne?"":String(k);Yn(c,$,P,y,G,F,L,s,m,d,i)})}function cn(s,r,t){var k,I,_,F,$,W,Q,L,O;let n=(k=r.options)!=null?k:{},e=n.background,o=(I=n.drilldown)!=null?I:!0,i=(_=t.rows)!=null?_:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:Ze});return}let l=Je(i),a=Array.from(l.keys()).filter(f=>f!==ne);if(a.length===0){Ee(s,r,t,!0);return}let{inner:c,svg:m,tooltip:d,details:p}=St(s,e),u=s.getBoundingClientRect().width||600,h=Math.max(u,480);c.style.width=h+"px";let x=300;m.setAttribute("height",String(x));let g=h-Ct-zt,N=x-qt-je,w=tn(i),A=[],D=new Set;for(let f of i){let C=String(f.x);D.has(C)||(D.add(C),A.push(f.x))}let P=w?en(i,g,Ct):nn(i,g,Ct),{xScale:G,xLabelOf:T}=P;if(w&&A.sort((f,C)=>{let R=kt(f),H=kt(C),V=R?R.getTime():0,z=H?H.getTime():0;return V-z}),w){let C=i.map(U=>kt(U.x)).filter(U=>!!U).map(U=>U.getTime()).sort((U,q)=>U-q),R=C[0],H=C[C.length-1],V=24*60*60*1e3;R===H&&(R-=V,H+=V);let z=H-R||V,Y=R-z*jt,J=H+z*jt;rn(m,Y,J,g,N,Ct,qt,zt,h)}let E=new Map,y=new Map;for(let f of A)E.set(String(f),new Map);for(let f of a){let C=(F=l.get(f))!=null?F:[],R=new Map;for(let H of C){let V=String(H.x);R.set(V,($=H.y)!=null?$:0)}y.set(f,R)}for(let f of a){let C=(W=y.get(f))!=null?W:new Map,R=0;for(let H of A){let V=String(H),z=C.get(V);z!==void 0&&(R=z);let Y=E.get(V);Y&&Y.set(f,R)}}let v=[];for(let f of A){let C=String(f),R=new Map,H=new Map,V=E.get(C);for(let Y of a){let J=(Q=V==null?void 0:V.get(Y))!=null?Q:0;R.set(Y,J)}let z=0;for(let Y of a){let J=(L=R.get(Y))!=null?L:0;H.set(Y,z),z+=J}v.push({x:f,seriesValues:R,stackedValues:H})}let b=0;for(let f of v){let C=0;for(let R of a)C+=(O=f.seriesValues.get(R))!=null?O:0;C>b&&(b=C)}(!isFinite(b)||b<=0)&&(b=1);let M=sn(0,b,N,qt);on(m,0,b,M,g,Ct,zt),a.length>0&&an(s,a,!1),a.forEach((f,C)=>{let R=ut(f,C),H="";v.forEach((U,q)=>{var et,X;let ot=G(U.x),nt=(et=U.stackedValues.get(f))!=null?et:0,it=(X=U.seriesValues.get(f))!=null?X:0,at=nt+it,tt=M(at);H+=q===0?`M ${ot} ${tt}`:` L ${ot} ${tt}`});let V=v.slice().reverse().map(U=>{var it;let q=G(U.x),ot=(it=U.stackedValues.get(f))!=null?it:0,nt=M(ot);return`${q} ${nt}`}).join(" L "),z=`${H} L ${V} Z`,Y=document.createElementNS(m.namespaceURI,"path");Y.setAttribute("d",z),Y.setAttribute("fill",R),Y.setAttribute("fill-opacity","0.18"),Y.setAttribute("stroke",R),Y.setAttribute("stroke-width","1.5"),m.appendChild(Y);let J=y.get(f);v.forEach(U=>{var Mt,Jt,Kt;let q=String(U.x);if(!(J==null?void 0:J.has(q)))return;let nt=G(U.x),it=(Mt=U.stackedValues.get(f))!=null?Mt:0,at=(Jt=U.seriesValues.get(f))!=null?Jt:0,tt=it+at,et=M(tt),X=document.createElementNS(m.namespaceURI,"circle");X.setAttribute("cx",String(nt)),X.setAttribute("cy",String(et)),X.setAttribute("r","3"),X.setAttribute("fill","#ffffff"),X.setAttribute("stroke",R),X.setAttribute("stroke-width","1.5"),X.style.cursor="pointer";let ht=T(U.x),ct=`${f} @ ${ht}`,rt=`value: ${Math.round(at*100)/100}`,wt=((Kt=l.get(f))!=null?Kt:[]).find(Nt=>String(Nt.x)===String(U.x));X.addEventListener("mouseenter",Nt=>{var Ot,Yt;return yt(s,d,ct,rt,(Yt=(Ot=wt==null?void 0:wt.notes)==null?void 0:Ot.length)!=null?Yt:0,Nt)}),X.addEventListener("mouseleave",()=>bt(d)),X.addEventListener("click",Nt=>{var Ot;Nt.preventDefault(),pt(s,p,ct,at,(Ot=wt==null?void 0:wt.notes)!=null?Ot:[],o)}),m.appendChild(X)})})}function ln(s,r,t){var A;let{background:n,drilldown:e=!0}=(A=r.options)!=null?A:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"No data available."});return}let o=We(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:l,svg:a,tooltip:c,details:m}=St(s,n),d=Math.max(i,420);l.style.width=d+"px",o&&(a.style.color=o);let p=300,u=d/2,h=(p-28+28)/2,x=Math.min(d/2-20,p/2-20),N=t.rows.map(D=>Math.max(0,D.y)).reduce((D,P)=>D+P,0)||1,w=-Math.PI/2;t.rows.forEach((D,P)=>{var F;let G=D.x instanceof Date?D.x.toISOString().slice(0,10):String(D.x),T=D.y,E=T/N*Math.PI*2,y=u+x*Math.cos(w),v=h+x*Math.sin(w),b=u+x*Math.cos(w+E),M=h+x*Math.sin(w+E),k=E>Math.PI?1:0,I=document.createElementNS(a.namespaceURI,"path"),_=[`M ${u} ${h}`,`L ${y} ${v}`,`A ${x} ${x} 0 ${k} 1 ${b} ${M}`,"Z"].join(" ");I.setAttribute("d",_),I.setAttribute("fill",ut((F=D.series)!=null?F:G,P)),I.style.cursor="pointer",I.addEventListener("mouseenter",$=>{var W,Q;return yt(s,c,G,T,(Q=(W=D.notes)==null?void 0:W.length)!=null?Q:0,$)}),I.addEventListener("mouseleave",()=>bt(c)),I.addEventListener("click",()=>{var $;return pt(s,m,G,T,($=D.notes)!=null?$:[],e)}),a.appendChild(I),w+=E})}function un(s,r,t){var v;let{background:n,drilldown:e=!0}=(v=r.options)!=null?v:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"No data available."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:l,svg:a,tooltip:c,details:m}=St(s,n),d=Math.max(i,700);l.style.width=d+"px",o&&(a.style.color=o);let p=300,u=d-48-10,h=p-28-28,x=t.rows.map(b=>{let M=b.x;if(M instanceof Date)return M.getTime();if(typeof M=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(M)){let I=new Date(M);if(!isNaN(I.getTime()))return I.getTime()}let k=Number(M);return isNaN(k)?null:k}return typeof M=="number"?M:null}),g=t.rows.map(b=>b.y),N=x.filter(b=>b!==null);if(N.length===0){s.createDiv({cls:"prop-charts-empty",text:"No data (X is not numeric/date)."});return}let w=Math.min(...N),A=Math.max(...N),D=Math.min(...g),P=Math.max(...g),G=b=>48+(b-w)/(A-w||1)*u,T=b=>p-28-(b-D)/(P-D||1)*h,E=document.createElementNS(a.namespaceURI,"line");E.setAttribute("x1",String(48)),E.setAttribute("y1",String(28)),E.setAttribute("x2",String(48)),E.setAttribute("y2",String(p-28)),E.setAttribute("stroke","currentColor"),a.appendChild(E);let y=document.createElementNS(a.namespaceURI,"line");y.setAttribute("x1",String(48)),y.setAttribute("y1",String(p-28)),y.setAttribute("x2",String(d-10)),y.setAttribute("y2",String(p-28)),y.setAttribute("stroke","currentColor"),a.appendChild(y),t.rows.forEach((b,M)=>{let k=x[M];if(k==null)return;let I=G(k),_=T(g[M]),F=document.createElementNS(a.namespaceURI,"circle");F.setAttribute("cx",String(I)),F.setAttribute("cy",String(_)),F.setAttribute("r","4"),F.setAttribute("fill",ut(b.series,M)),F.style.cursor="pointer";let $=b.x instanceof Date?b.x.toISOString().slice(0,10):typeof b.x=="string"?b.x:String(b.x);F.addEventListener("mouseenter",W=>{var Q,L;return yt(s,c,$,b.y,(L=(Q=b.notes)==null?void 0:Q.length)!=null?L:0,W)}),F.addEventListener("mouseleave",()=>bt(c)),F.addEventListener("click",W=>{var Q;W.preventDefault(),pt(s,m,$,b.y,(Q=b.notes)!=null?Q:[],e)}),a.appendChild(F)})}function Un(s){switch(s){case"auto":return"var(--text-accent, #5b6cff)";case"accent":return"var(--text-accent, #5b6cff)";case"green":return"#5ec27f";case"red":return"#ff6b6b";case"blue":return"#5b6cff";case"orange":return"#ffb347";case"purple":return"#b47cff";default:return"var(--text-accent, #5b6cff)"}}function Wn(s,r,t="",n=""){let e=r===0?Math.round(s).toString():s.toFixed(r);return`${t}${e}${n}`}function Xn(s){let r=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),n=String(s.getDate()).padStart(2,"0");return`${r}-${t}-${n}`}function zn(s){return{count:"Count notes","count-value":"Count notes with value",sum:"Sum of values",avg:"Average of values",min:"Smallest value",max:"Largest value","count-date":"Count notes with date",oldest:"Oldest date",newest:"Newest date"}[s]||s}function dn(s,r,t){var M,k,I,_,F,$,W,Q,L,O,f,C;let n=(M=r.options)!=null?M:{},e=n.background;s.empty(),s.addClass("prop-charts-container"),s.addClass("prop-charts-metric");let o=(k=n.metricLabel)!=null?k:"",i=(I=n.metricLabelPosition)!=null?I:"above",l=Number((_=n.metricDecimals)!=null?_:0),a=(F=n.metricPrefix)!=null?F:"",c=($=n.metricSuffix)!=null?$:"",m=(W=n.metricColor)!=null?W:"auto",d=Un(m),p=t.rows[0];if(!p){s.createDiv({cls:"prop-charts-empty",text:"No data available."});return}let u=(Q=p.props)==null?void 0:Q._metricValue,h=(L=p.props)==null?void 0:L._metricError,x=(O=p.props)==null?void 0:O._metricDataType,g=(f=p.props)==null?void 0:f._metricOperation,N=(C=p.notes)!=null?C:[],w=N.length,A=s.createDiv({cls:"prop-charts-metric-card"});e&&(A.style.backgroundColor=e);let D="\u2013",P="",G=!1;h?(D="\u2013",P=h,G=!0):w===0?(D="\u2013",P="No notes found"):u==null?(D="0",P="No valid values (property empty or invalid)"):(u instanceof Date?(D=Xn(u),g==="oldest"?P="Oldest":g==="newest"&&(P="Newest")):typeof u=="number"?D=Wn(u,l,a,c):D=String(u),P?P+=` \u2022 ${w} note${w===1?"":"s"}`:P=`${w} note${w===1?"":"s"}`);let T=A.createDiv({cls:"prop-charts-metric-content"});if(o){let R=T.createDiv({cls:"prop-charts-metric-label"});R.textContent=o,i==="below"&&(R.style.order="3")}let E=T.createDiv({cls:"prop-charts-metric-value"});if(E.textContent=D,E.style.color=G?"var(--text-error, #ff6b6b)":d,E.style.cursor=w>0&&!G?"pointer":"default",P){let R=T.createDiv({cls:"prop-charts-metric-subtext"});R.textContent=P,G&&(R.style.color="var(--text-error, #ff6b6b)")}let y=A.createDiv({cls:"prop-charts-metric-info"});y.textContent="\u24D8",y.style.cursor="help";let v=A.createDiv({cls:"prop-charts-metric-tooltip"});v.style.display="none";let b=[x?`Property type: ${x}`:"",g?`Operation: ${zn(g)}`:"",`Notes: ${w}`].filter(Boolean).join(`
`);y.addEventListener("mouseenter",R=>{let H=A.getBoundingClientRect();v.textContent=b,v.style.display="block";let V=v.getBoundingClientRect(),z=R.clientX-H.left+6,Y=R.clientY-H.top+6;z+V.width>H.width-4&&(z=H.width-V.width-4),z<4&&(z=4),Y+V.height>H.height-4&&(Y=H.height-V.height-4),Y<4&&(Y=4),v.style.left=z+"px",v.style.top=Y+"px"}),y.addEventListener("mouseleave",()=>{v.style.display="none"}),w>0&&!G&&(E.addEventListener("click",()=>{pt(s,s.createDiv({cls:"chart-notes-details"}),o||"Metric",typeof u=="number"?u:0,N,!0)}),A.style.cursor="pointer",A.addEventListener("click",()=>{pt(s,s.createDiv({cls:"chart-notes-details"}),o||"Metric",typeof u=="number"?u:0,N,!0)}))}var ge=class{render(r,t,n,e){var i;let{title:o}=(i=t.options)!=null?i:{};if(r.empty(),r.addClass("prop-charts-container"),t.type!=="metric"){let a=r.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});o&&(a.textContent=o)}switch(t.type){case"bar":Ae(r,t,n);break;case"stacked-bar":Xe(r,t,n);break;case"line":Ee(r,t,n,!1);break;case"stacked-area":cn(r,t,n);break;case"pie":ln(r,t,n);break;case"scatter":un(r,t,n);break;case"gantt":fe(r,t,n,e);break;case"metric":dn(r,t,n);break;default:r.createDiv({text:"Chart Notes: unsupported type: "+t.type})}}};var ye=class extends Zt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("Chart Notes: loading plugin (Bases-only)"),this.indexer=new ue(this.app),await this.indexer.buildIndex(),this.query=new me(()=>this.indexer.getAll(),[]),this.renderer=new ge,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Zt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Zt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Zt.TFile&&this.indexer.removeFile(t)})),this.registerBasesView(xe,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new ce(t,n,this.renderer),options:()=>{let t=[];return t.push({type:"dropdown",key:"chartType",displayName:"Chart type",description:"Type of chart to render",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line","stacked-area":"Stacked area",pie:"Pie",scatter:"Scatter",gantt:"Gantt",metric:"Indicator"}}),t.push({type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",description:"Property used for the X axis or categories (for pie, this is the slice).",shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return e==="gantt"||e==="metric"}}),t.push({type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:`Label for each task bar.
If empty, uses the note title.`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"yProperty",displayName:"Y value (empty = count)",description:`Numeric property summed on the Y axis.
Leave empty to just count notes.`,shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return e==="pie"||e==="gantt"||e==="metric"}}),t.push({type:"property",key:"seriesProperty",displayName:"Series / color (optional)",description:"Property that defines series / color for bars, lines and stacked area.",shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return e==="pie"||e==="metric"}}),t.push({type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",description:`How to aggregate Y when multiple notes share the same X/series.
For line/stacked-area, 'Cumulative sum' turns the series into a running total.`,default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum"},shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return e==="scatter"||e==="gantt"||e==="stacked-bar"||e==="metric"}}),t.push({type:"property",key:"startProperty",displayName:"Start (Gantt)",description:"Start date/datetime for the task.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"endProperty",displayName:"End (Gantt)",description:"End date/datetime for the task.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"dueProperty",displayName:"Due (deadline, optional)",description:"Due date / deadline for the task.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"durationProperty",displayName:"Duration in minutes (optional)",description:`Duration of the task in minutes.
Used together with start/end/due.`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")==="metric"}}),t.push({type:"text",key:"title",displayName:"Title (optional)",description:`Custom chart title.
Falls back to the view name.`}),t.push({type:"property",key:"metricProperty",displayName:"Property",description:`Property to measure.
Leave empty to count all notes in this view.`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"dropdown",key:"metricOperation",displayName:"How to calculate",description:"Operation to perform on the selected property.",default:"count",options:{count:"Count notes","count-value":"Count notes with value",sum:"Sum of values",avg:"Average of values",min:"Smallest value",max:"Largest value","count-date":"Count notes with date",oldest:"Oldest date",newest:"Newest date"},shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"dropdown",key:"metricDataType",displayName:"Data type",description:`Type of data in the property.
Auto-detected, but you can override if needed.`,default:"auto",options:{auto:"Auto-detect",number:"Number",date:"Date",text:"Text/Other (count only)"},shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"text",key:"metricLabel",displayName:"Label",description:`Text to display with the number.
e.g., Total tasks, Average duration`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"dropdown",key:"metricLabelPosition",displayName:"Label position",description:"Where to show the label relative to the number.",default:"above",options:{above:"Label above number",below:"Label below number"},shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"dropdown",key:"metricDecimals",displayName:"Decimal places",description:"Number of decimal places to show.",default:"0",options:{0:"0",1:"1",2:"2",3:"3"},shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"text",key:"metricPrefix",displayName:"Prefix (optional)",description:`Text to show before the number.
e.g., R$, %, #`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"text",key:"metricSuffix",displayName:"Suffix (optional)",description:`Text to show after the number.
e.g., h, days, units, %`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t.push({type:"dropdown",key:"metricColor",displayName:"Highlight color",description:"Color for the number display.",default:"auto",options:{auto:"Automatic (theme)",accent:"Accent color",green:"Green",red:"Red",blue:"Blue",orange:"Orange",purple:"Purple"},shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="metric"}}),t}})}onunload(){console.log("Chart Notes: unloading plugin")}};
