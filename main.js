/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Xe=(o,r)=>{for(var t in r)le(o,t,{get:r[t],enumerable:!0})},qe=(o,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Oe(r))!Ye.call(o,n)&&n!==t&&le(o,n,{get:()=>r[n],enumerable:!(e=Ue(r,n))||e.enumerable});return o};var je=o=>qe(le({},"__esModule",{value:!0}),o);var lr={};Xe(lr,{default:()=>se});module.exports=je(lr);var Lt=require("obsidian");var Kt=require("obsidian"),ce="chartnotes-view",Re=["bar","stacked-bar","line","area","pie","scatter","gantt"];function Te(o){let r=String(o!=null?o:"bar").trim().toLowerCase();return Re.includes(r)?r:"bar"}var qt=class extends Kt.BasesView{constructor(t,e,n){super(t);this.type=ce;this.settings={chartType:"bar",xProperty:null,yProperty:null,seriesProperty:null,startProperty:null,endProperty:null,dueProperty:null,durationProperty:null,groupProperty:null};this.groupedData=[];this.initializedFromConfig=!1;this.controlsBuilt=!1;this.renderer=n,this.containerEl=e.createDiv("chartnotes-bases-view"),this.controlsEl=this.containerEl.createDiv("chartnotes-bases-controls"),this.chartEl=this.containerEl.createDiv("chartnotes-bases-chart"),this.controlsEl.style.display="flex",this.controlsEl.style.flexWrap="wrap",this.controlsEl.style.gap="6px",this.controlsEl.style.marginBottom="8px",this.controlsEl.style.alignItems="flex-end"}onDataUpdated(){var e;let t=this.data;this.groupedData=(e=t==null?void 0:t.groupedData)!=null?e:[],this.initializedFromConfig||(this.loadSettingsFromConfig(),this.ensureDefaultsFromOrder(),this.initializedFromConfig=!0),this.controlsBuilt||(this.buildControlsUI(),this.controlsBuilt=!0),this.renderChart()}loadSettingsFromConfig(){let t=this.config;if(!t)return;let e=s=>{try{let i=t.get(s);if(typeof i=="string"&&i.trim().length>0)return i}catch(i){}return null},n=e("chartType");n&&(this.settings.chartType=n),this.settings.xProperty=e("xProperty"),this.settings.yProperty=e("yProperty"),this.settings.seriesProperty=e("seriesProperty"),this.settings.startProperty=e("startProperty"),this.settings.endProperty=e("endProperty"),this.settings.dueProperty=e("dueProperty"),this.settings.durationProperty=e("durationProperty"),this.settings.groupProperty=e("groupProperty")}saveSettingsToConfig(){let t=this.config;if(!t||typeof t.set!="function")return;let e=(n,s)=>{try{t.set(n,s!=null?s:null)}catch(i){}};e("chartType",this.settings.chartType),e("xProperty",this.settings.xProperty),e("yProperty",this.settings.yProperty),e("seriesProperty",this.settings.seriesProperty),e("startProperty",this.settings.startProperty),e("endProperty",this.settings.endProperty),e("dueProperty",this.settings.dueProperty),e("durationProperty",this.settings.durationProperty),e("groupProperty",this.settings.groupProperty)}ensureDefaultsFromOrder(){var s,i;let t=this.config,e=(i=(s=t==null?void 0:t.getOrder)==null?void 0:s.call(t))!=null?i:[];if(!e.length)return;let n=p=>p>=0&&p<e.length?e[p]:null;this.settings.xProperty||(this.settings.xProperty=n(0)),this.settings.yProperty||(this.settings.yProperty=n(1)),this.settings.seriesProperty||(this.settings.seriesProperty=n(2))}buildControlsUI(){var a,l;this.controlsEl.empty();let t=this.config,e=(l=(a=t==null?void 0:t.getOrder)==null?void 0:a.call(t))!=null?l:[],n=this.controlsEl.createDiv("chartnotes-control"),s=n.createEl("label");s.textContent="Tipo:";let i=n.createEl("select");i.style.marginLeft="4px";for(let d of Re){let h=i.createEl("option");h.value=d,h.text=d}i.value=Te(this.settings.chartType),i.onchange=()=>{this.settings.chartType=i.value,this.saveSettingsToConfig(),this.renderChart()};let p=(d,h)=>{var k,w,F;let S=this.controlsEl.createDiv("chartnotes-control"),x=S.createEl("label");x.textContent=h;let m=S.createEl("select");m.style.marginLeft="4px";let f=m.createEl("option");f.value="",f.text="(auto)";for(let R of e){let z=R;try{let E=(0,Kt.parsePropertyId)(R),v=(k=E.type)!=null?k:"",c=(w=E.name)!=null?w:R;z=v?`${c} (${v})`:c}catch(E){}let $=m.createEl("option");$.value=R,$.text=z}let A=(F=this.settings[d])!=null?F:"";return A&&(m.value=A),m.onchange=()=>{let R=m.value||null;this.settings[d]=R,this.saveSettingsToConfig(),this.renderChart()},m};p("xProperty","X:"),p("yProperty","Y:"),p("seriesProperty","S\xE9rie:"),p("startProperty","In\xEDcio:"),p("endProperty","Fim:"),p("dueProperty","Due:"),p("durationProperty","Dura\xE7\xE3o:"),p("groupProperty","Grupo:")}renderChart(){var d;if(this.chartEl.empty(),!this.groupedData||this.groupedData.length===0){this.chartEl.createDiv({cls:"prop-charts-empty",text:"Sem dados (Base vazia ou sem resultados)."});return}let t=Te(this.settings.chartType),e;if(t==="gantt"?e=this.buildRowsForGantt(this.groupedData):t==="scatter"?e=this.buildRowsForScatter(this.groupedData):e=this.buildRowsForAggregatedCharts(this.groupedData),!e.length){this.chartEl.createDiv({cls:"prop-charts-empty",text:"Sem linhas para exibir (verifique as propriedades X/Y)."});return}let n={rows:e},s=this.buildEncoding(),i=this.config,p=(d=i==null?void 0:i.name)!=null?d:"Chart Notes (Bases)",a={type:t,source:{type:"properties",query:""},encoding:s,options:{title:p,drilldown:!0}},l={refresh:()=>this.onDataUpdated()};this.renderer.render(this.chartEl,a,n,l)}getSelectedProp(t){var n;let e=this.settings[t];if(!e)return{id:null,name:null};try{let s=(0,Kt.parsePropertyId)(e);return{id:e,name:(n=s.name)!=null?n:e}}catch(s){return{id:e,name:e}}}readValue(t,e){if(!e.id)return null;let n;try{n=t.getValue(e.id)}catch(s){return null}if(!n)return null;try{if(typeof n.isEmpty=="function"&&n.isEmpty())return null}catch(s){}try{let s=n.toString();if(s==null)return null;let i=String(s).trim();return i.length?i:null}catch(s){return null}}parseDate(t){if(!t)return null;let e=t.trim();if(!e)return null;let n=new Date(e);return Number.isNaN(n.getTime())?null:n}buildRowsForAggregatedCharts(t){var p,a;let e=this.getSelectedProp("xProperty"),n=this.getSelectedProp("yProperty"),s=this.getSelectedProp("seriesProperty"),i=new Map;for(let l of t)for(let d of l.entries){let h=d.file,S=(a=this.readValue(d,e))!=null?a:h!=null&&h.name?String(h.name):String((p=h==null?void 0:h.path)!=null?p:""),x=this.readValue(d,n),m=1;if(n.id){if(x==null)continue;let F=Number(x);if(Number.isNaN(F))continue;m=F}let f=this.readValue(d,s),A=f!=null?String(f):void 0,k=`${S}@@${A!=null?A:""}`,w=i.get(k);w||(w={x:S,y:0,series:A,notes:[],props:{}},i.set(k,w)),w.y+=m,h!=null&&h.path&&w.notes.push(h.path),w.props&&e.name&&(w.props[e.name]=S),w.props&&n.name&&x!=null&&(w.props[n.name]=m),w.props&&s.name&&f!=null&&(w.props[s.name]=f)}return Array.from(i.values())}buildRowsForScatter(t){let e=this.getSelectedProp("xProperty"),n=this.getSelectedProp("yProperty"),s=this.getSelectedProp("seriesProperty"),i=[];for(let p of t)for(let a of p.entries){let l=a.file,d=this.readValue(a,e),h=this.readValue(a,n);if(d==null||h==null)continue;let S=Number(d),x=Number(h);if(Number.isNaN(S)||Number.isNaN(x))continue;let m=this.readValue(a,s),f=m!=null?String(m):void 0,A={x:S,y:x,series:f,notes:l!=null&&l.path?[l.path]:[],props:{}};i.push(A)}return i}buildRowsForGantt(t){var h,S;let e=this.getSelectedProp("xProperty"),n=this.getSelectedProp("seriesProperty"),s=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),p=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),l=this.getSelectedProp("groupProperty"),d=[];for(let x of t)for(let m of x.entries){let f=m.file,A=this.readValue(m,s),k=this.readValue(m,i);if(!A||!k)continue;let w=this.parseDate(A),F=this.parseDate(k);if(!w||!F)continue;let R=(S=this.readValue(m,e))!=null?S:f!=null&&f.name?String(f.name).replace(/\.md$/i,""):String((h=f==null?void 0:f.path)!=null?h:""),z=this.readValue(m,p),$=this.parseDate(z!=null?z:null),E=this.readValue(m,a),v=E!=null?Number(E):void 0,c=typeof v=="number"&&!Number.isNaN(v),D=this.readValue(m,n),T=D!=null?String(D):void 0,b=this.readValue(m,l),L={};a.name&&c&&(L[a.name]=v),l.name&&b!=null&&(L[l.name]=b);let W={x:R,y:0,series:T,start:w,end:F,due:$!=null?$:void 0,notes:f!=null&&f.path?[f.path]:[],props:L};d.push(W)}return d}buildEncoding(){var d,h,S,x,m,f,A,k;let t=this.getSelectedProp("xProperty"),e=this.getSelectedProp("yProperty"),n=this.getSelectedProp("seriesProperty"),s=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),p=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),l=this.getSelectedProp("groupProperty");return{x:(d=t.name)!=null?d:"x",y:(h=e.name)!=null?h:"y",series:(S=n.name)!=null?S:"series",start:(x=s.name)!=null?x:"start",end:(m=i.name)!=null?m:"end",due:(f=p.name)!=null?f:"due",duration:(A=a.name)!=null?A:"duration",group:(k=l.name)!=null?k:"group"}}};var Ne=require("obsidian"),jt=class{constructor(r){this.index=new Map;this.app=r}async buildIndex(){this.index.clear();let r=this.app.vault.getMarkdownFiles();for(let t of r)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(r){if(r.extension!=="md")return;let t={};try{let n=(await this.app.vault.read(r)).match(/^---\n([\s\S]*?)\n---\n?/);if(n){let i=(0,Ne.parseYaml)(n[1])||{};if(i&&typeof i=="object")for(let[p,a]of Object.entries(i))p!=="position"&&(t[p]=a)}let s=this.app.metadataCache.getFileCache(r);s!=null&&s.tags&&!t.tags&&(t.tags=s.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",r.path,e)}this.index.set(r.path,{path:r.path,props:t})}removeFile(r){this.index.delete(r.path)}};function Le(o,r){if(!r||r.length===0)return!0;for(let t of r){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Ie(o,r){if(!r||r.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let n of r)if(t.includes(n)||t.includes("#"+n))return!0;return!1}let e=String(t);for(let n of r)if(e===n||e==="#"+n)return!0;return!1}function Jt(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function $t(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,n]=o.split("-");return new Date(Number(t),Number(e)-1,Number(n),0,0,0,0)}let r=new Date(o);return isNaN(r.getTime())?null:r}function ut(o){let r=new Date(o);return r.setHours(0,0,0,0),r}function Zt(o,r){let t=new Date(o);return t.setDate(t.getDate()-r),t}function Ze(o,r){return Zt(o,r*7)}function Je(o,r){let t=new Date(o);return t.setMonth(t.getMonth()-r),t}function de(o,r){let t=new Date(o);return t.setDate(t.getDate()+r),t}function tr(o,r){return de(o,r*7)}function er(o,r){let t=new Date(o);return t.setMonth(t.getMonth()+r),t}function ke(o){let r=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(r)||r.endsWith("date")||r.endsWith("at")||r.endsWith("on"))}function Me(o,r){let t=r?new Date(r):new Date,e=ut(t),n=o.trim().toLowerCase();if(n==="today")return e;if(n==="yesterday")return ut(Zt(e,1));if(/^-\d+$/.test(n)){let s=parseInt(n.slice(1),10);return ut(Zt(e,s))}if(/^-\d+d$/.test(n)){let s=parseInt(n.slice(1,-1),10);return ut(Zt(e,s))}if(/^-\d+w$/.test(n)){let s=parseInt(n.slice(1,-1),10);return ut(Ze(e,s))}if(/^-\d+m$/.test(n)){let s=parseInt(n.slice(1,-1),10);return ut(Je(e,s))}if(/^\+\d+$/.test(n)){let s=parseInt(n.slice(1),10);return ut(de(e,s))}if(/^\+\d+d$/.test(n)){let s=parseInt(n.slice(1,-1),10);return ut(de(e,s))}if(/^\+\d+w$/.test(n)){let s=parseInt(n.slice(1,-1),10);return ut(tr(e,s))}if(/^\+\d+m$/.test(n)){let s=parseInt(n.slice(1,-1),10);return ut(er(e,s))}return null}function Fe(o){let r=o.trim(),t=r.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let d=t[1].trim(),h=t[2].trim(),S=t[3].trim(),x=ke(d),m=ue(h,x),f=ue(S,x),A=m.valueType==="date"||f.valueType==="date"?"date":m.valueType;return{field:d,op:"between",value:m.value,value2:f.value,valueType:A}}let e=/(==|!=|>=|<=|>|<)/,n=r.split(e);if(n.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let s=n[0].trim(),i=n[1].trim(),p=n[2].trim(),a=ke(s),l=ue(p,a);return{field:s,op:i,value:l.value,valueType:l.valueType}}function ue(o,r){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),n=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(r){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(n){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(Jt(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let s=Number(t);return Number.isNaN(s)?{value:t,valueType:"string"}:{value:s,valueType:"number"}}function _e(o,r){let t=o[r.field];if(t==null)return!1;if(r.valueType==="date"){let s=t instanceof Date?ut(t):Jt(t)?ut($t(t)):null;if(!s)return!1;let i=r.value instanceof Date?r.value:null,p=r.value2 instanceof Date?r.value2:null;if(!i)return!1;let a=s.getTime(),l=ut(i).getTime();switch(r.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!p)return!1;let d=ut(p).getTime();return a>=l&&a<=d}}if(r.valueType==="number"){let s=Number(t);if(isNaN(s))return!1;let i=Number(r.value);switch(r.op){case"==":return s===i;case"!=":return s!==i;case">":return s>i;case">=":return s>=i;case"<":return s<i;case"<=":return s<=i;case"between":return typeof r.value2!="number"?!1:s>=i&&s<=r.value2}}let e=String(t),n=String(r.value);switch(r.op){case"==":return e===n;case"!=":return e!==n;case">":return e>n;case">=":return e>=n;case"<":return e<n;case"<=":return e<=n;case"between":return!1}}function rr(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(Jt(o)){let r=$t(o);if(r)return{key:r,isDate:!0}}return{key:o,isDate:!1}}function nr(o,r){let t=o.x,e=r.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let n=String(t),s=String(e);return n<s?-1:n>s?1:0}function sr(o,r){var s,i;let t=nr(o,r);if(t!==0)return t;let e=(s=o.series)!=null?s:"",n=(i=r.series)!=null?i:"";return e<n?-1:e>n?1:0}function or(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let r=o.trim().match(/^(\d+)/);if(r){let t=Number(r[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function ir(o){var e,n;let r=new Map,t=[];for(let s of o){let i=(e=s.series)!=null?e:"__no_series__",a=((n=r.get(i))!=null?n:0)+s.y;r.set(i,a),t.push({...s,y:a})}return t}function ar(o,r){var i,p;let t=or(r);if(!t||t<=1)return[...o];let e=new Map,n=new Map,s=[];for(let a of o){let l=(i=a.series)!=null?i:"__no_series__",d=e.get(l);d||(d=[],e.set(l,d));let h=(p=n.get(l))!=null?p:0;if(d.push(a.y),h+=a.y,d.length>t){let m=d.shift();h-=m}n.set(l,h);let S=d.length||1,x=h/S;s.push({...a,y:x})}return s}var te=class{constructor(r,t){this.getIndex=r,this.defaultPaths=t}run(r){var i,p,a;let t=this.getIndex(),e=(i=r.source)!=null&&i.paths&&r.source.paths.length?r.source.paths:this.defaultPaths,n=(p=r.source)!=null&&p.tags&&r.source.tags.length?r.source.tags:[],s=[];for(let l of t){let d=e&&e.length?Le(l.path,e):!0,h=n&&n.length?Ie(l.props,n):!0;if(!d||!h)continue;let S=!0;if((a=r.source)!=null&&a.where&&r.source.where.length>0)for(let x of r.source.where){let m;try{m=Fe(x)}catch(f){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${x} (${f.message})`)}if(!_e(l.props,m)){S=!1;break}}S&&s.push(l)}return r.type==="gantt"?this.runGantt(r,s):r.type==="table"?this.runTable(r,s):this.runStandard(r,s)}runTable(r,t){var n,s;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(n=r.encoding)==null?void 0:n.x,yField:(s=r.encoding)==null?void 0:s.y}}runGantt(r,t){var h,S,x;let e=(h=r.encoding)!=null?h:{},n=e.start,s=e.end,i=(S=e.label)!=null?S:e.x,p=e.series,a=e.duration,l=e.due,d=[];for(let m of t){let f=(x=m.props)!=null?x:{},A=E=>Array.isArray(E)?E[0]:E,k=null;if(s){let E=A(f[s]),v=$t(E);v&&(k=v)}if(!k)continue;let w=null;if(n){let E=A(f[n]),v=$t(E);v&&(w=v)}if(!w&&a){let E=A(f[a]),v=Number(E);Number.isNaN(v)||(w=new Date(k.getTime()-v*6e4))}w||(w=new Date(k.getTime()));let F;if(l){let E=A(f[l]),v=$t(E);v&&(F=v)}let R;if(i){let E=A(f[i]);(E==null||E==="")&&(E=m.path),R=E}else R=m.path;let z;if(p){let E=A(f[p]);E!=null&&(z=String(E))}let $={x:R,y:0,notes:[m.path],series:z,start:w,end:k,props:f};F&&($.due=F),d.push($)}return d.sort((m,f)=>{let A=m.start?m.start.getTime():0,k=f.start?f.start.getTime():0;return A-k}),{rows:d,xField:i,yField:s}}runStandard(r,t){var m,f,A,k,w,F,R,z,$,E;let e=(m=r.encoding)==null?void 0:m.x,n=(f=r.encoding)==null?void 0:f.y,s=(A=r.encoding)==null?void 0:A.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(k=r.aggregate)!=null?k:{},p=(w=i.y)!=null?w:null,a=!!i.cumulative,l=i.rolling;if(!n&&p!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let d=[];for(let v of t){let c=(F=v.props)!=null?F:{},D=H=>Array.isArray(H)?H[0]:H,T=D(c[e]);if(T==null)continue;let b=rr(T),L=b.key,W=b.isDate,rt;if(s){let H=D(c[s]);H!=null&&String(H).trim()!==""&&(rt=String(H))}let B;if(p==="count")B=1;else{let H=D(c[n]);if(H==null)continue;let j=Number(H);if(Number.isNaN(j))continue;B=j}d.push({x:L,y:B,notes:[v.path],series:rt,props:c,_isDate:W,_origX:T})}if(d.length===0)return{rows:[],xField:e,yField:n};let h=[];if(p){let v=new Map;for(let c of d){let D=(R=c.series)!=null?R:"",T=c.x instanceof Date?c.x.toISOString().slice(0,10):String(c.x),b=D+"||"+T,L=(z=v.get(b))!=null?z:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:c.x,isDate:c._isDate,series:c.series,props:c.props};L.sum+=c.y,L.count+=1,c.y<L.min&&(L.min=c.y),c.y>L.max&&(L.max=c.y),L.notes.push(...c.notes),L.props=($=c.props)!=null?$:L.props,v.set(b,L)}for(let[,c]of v){let D=c.sum;switch(p){case"sum":D=c.sum;break;case"avg":D=c.sum/c.count;break;case"min":D=c.min;break;case"max":D=c.max;break;case"count":D=c.count;break}h.push({x:c.xRep,y:D,notes:c.notes,series:c.series,props:c.props})}}else h=d.map(v=>({x:v.x,y:v.y,notes:v.notes,series:v.series,props:v.props}));if(h.length===0)return{rows:[],xField:e,yField:n};let S=((E=r.sort)==null?void 0:E.x)==="desc"?"desc":"asc";if(h.sort((v,c)=>{let D=sr(v,c);return S==="asc"?D:-D}),(a||l)&&!(r.type==="line"||r.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let x=h;return l?x=ar(h,l):a&&(x=ir(h)),{rows:x,xField:e,yField:n}}};var Pt=require("obsidian");var $e=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,r){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,n)=>e*33+n.charCodeAt(0)>>>0,0);return $e[t%$e.length]}function wt(o,r){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,r&&(e.style.background=r);let n="http://www.w3.org/2000/svg",s=document.createElementNS(n,"svg");s.setAttribute("width","100%"),s.setAttribute("height",String(300)),s.style.display="block",e.appendChild(s);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let p=o.createDiv({cls:"chart-notes-details"});return p.style.display="none",{scroll:t,inner:e,svg:s,tooltip:i,details:p}}function ft(o,r,t,e,n,s){let i=o.getBoundingClientRect(),p=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);r.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${p}</div>
    <div class="chart-notes-tooltip-notes">${n} nota${n===1?"":"s"}</div>
  `,r.style.display="block";let a=r.getBoundingClientRect(),l=s.clientX-i.left+6,d=s.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),d+a.height>i.height-4&&(d=i.height-a.height-4),d<4&&(d=4),r.style.left=l+"px",r.style.top=d+"px"}function gt(o){o.style.display="none"}function mt(o,r,t,e,n,s){if(!s)return;if(r.empty(),!n||n.length===0){r.style.display="none";return}r.style.display="block";let i=r.createEl("div",{cls:"chart-notes-details-header"}),p=i.createEl("div",{cls:"chart-notes-details-title"});p.textContent=`Notas em "${t}" (${n.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{r.style.display="none"});let l=r.createEl("ul",{cls:"chart-notes-details-list"});for(let d of n){let S=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:d});S.href="#",S.addEventListener("click",x=>{x.preventDefault(),app.workspace.openLinkText(d,"",!1)})}}function Bt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let r=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${r}/${t}`}function He(o){if(!o)return!1;let r=o.trim().toLowerCase();if(r==="#fff"||r==="#ffffff"||r==="white")return!0;if(!r.startsWith("#"))return!1;let t,e,n;if(r.length===4)t=parseInt(r[1]+r[1],16),e=parseInt(r[2]+r[2],16),n=parseInt(r[3]+r[3],16);else if(r.length===7)t=parseInt(r.slice(1,3),16),e=parseInt(r.slice(3,5),16),n=parseInt(r.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*n)/255>.7}var pe=class extends Pt.Modal{constructor(t,e,n,s){var p;super(app);this.notePath=t,this.spec=e,this.refresh=n,this.reindexFile=s;let i=(p=e.encoding)!=null?p:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var E,v;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Pt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let n=await this.app.vault.read(e),s={},i=n,p=/^---\n([\s\S]*?)\n---\n?/m.exec(n);if(p){try{s=(E=(0,Pt.parseYaml)(p[1]))!=null?E:{}}catch(c){s={}}i=n.slice(p[0].length)}(typeof s!="object"||s==null)&&(s={});let a=(v=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?v:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),d=l.createEl("a",{text:a,cls:"gantt-edit-title"});d.href="#",d.addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let h=l.createDiv({cls:"gantt-edit-subtitle"});h.textContent=this.notePath;let S=t.createDiv({cls:"gantt-edit-form"}),x=c=>{let D=S.createDiv({cls:"gantt-edit-row"}),T=D.createDiv({cls:"gantt-edit-label"});T.textContent=c;let b=D.createDiv({cls:"gantt-edit-field"});return{row:D,field:b}},m=c=>{if(!c)return"";let T=String(c).match(/^(\d{4}-\d{2}-\d{2})/);return T?T[1]:""},f=c=>{if(c=c.trim(),!!c&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c},A=null;if(this.startKey){let{field:c}=x(this.startKey+" (in\xEDcio)");A=c.createEl("input",{type:"date"}),A.value=m(s[this.startKey])}let k=null;if(this.endKey){let{field:c}=x(this.endKey+" (fim)");k=c.createEl("input",{type:"date"}),k.value=m(s[this.endKey])}let w=null;if(this.durationKey){let{field:c}=x(this.durationKey+" (minutos)");w=c.createEl("input",{type:"number"});let D=s[this.durationKey];w.value=D!=null?String(D):"",w.min="0",w.step="5"}let F=null;if(this.dueKey){let{field:c}=x(this.dueKey+" (due)");F=c.createEl("input",{type:"date"}),F.value=m(s[this.dueKey])}let R=t.createDiv({cls:"gantt-edit-buttons"}),z=R.createEl("button",{text:"Salvar",cls:"mod-cta"});R.createEl("button",{text:"Cancelar"}).addEventListener("click",c=>{c.preventDefault(),this.close()}),z.addEventListener("click",async c=>{if(c.preventDefault(),this.startKey&&A){let b=f(A.value);b?s[this.startKey]=b:delete s[this.startKey]}if(this.endKey&&k){let b=f(k.value);b?s[this.endKey]=b:delete s[this.endKey]}if(this.durationKey&&w){let b=w.value.trim();if(b==="")delete s[this.durationKey];else{let L=Number(b);Number.isNaN(L)||(s[this.durationKey]=L)}}if(this.dueKey&&F){let b=f(F.value);b?s[this.dueKey]=b:delete s[this.dueKey]}let T=`---
${(0,Pt.stringifyYaml)(s).trim()}
---
`+i;if(await this.app.vault.modify(e,T),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(b){}if(this.refresh)try{this.refresh()}catch(b){}new Pt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ee(o,r,t,e){var me,be,xe,ve,Se,we,Ae,Ee;let n=(me=r.options)!=null?me:{},s=n.background,i=(be=n.drilldown)!=null?be:!0,p=!0,a=u=>{if(u==null)return"";let N=String(u).trim();if(!N)return"";let _=N.match(/^\[\[(.+?)\]\]$/);_&&(N=_[1]);let O=N.lastIndexOf("/");return O>=0&&O<N.length-1&&(N=N.slice(O+1)),N};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(u=>u.start&&u.end);if(l.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let d=r.encoding,h=d.group,S=d.duration,x=(u,N)=>{if(!u||!N)return;let _=u[N];return Array.isArray(_)?_[0]:_},f=l.map(u=>{var xt,ct;let N=u.start,_=u.end,O=u.props,It=typeof u.x=="string"?u.x:u.x instanceof Date?Bt(N):String(u.x),At=a(It),bt,Ft=h?x(O,h):void 0;Ft!=null?bt=String(Ft):u.series!=null?bt=String(u.series):bt=At;let yt=(xt=u.notes)==null?void 0:xt[0],Et=yt?(ct=yt.replace(/\.md$/i,"").split("/").pop())!=null?ct:yt:At,Ct=u.due,_t,kt=x(O,S);if(kt!=null){let vt=Number(kt);Number.isNaN(vt)||(_t=vt)}return{row:u,start:N,end:_,props:O,fullName:At,groupKey:bt,notePath:yt,noteTitle:Et,due:Ct,estMinutes:_t}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(f.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}f.sort((u,N)=>{if(u.groupKey<N.groupKey)return-1;if(u.groupKey>N.groupKey)return 1;let _=u.start.getTime(),O=N.start.getTime();return _!==O?_-O:u.fullName.localeCompare(N.fullName)});let A=26,k=0,w=null;for(let u of f)u.groupKey!==w&&(w=u.groupKey,k+=1),k+=1;let F=Math.min(...f.map(u=>u.start.getTime())),R=Math.max(...f.map(u=>u.end.getTime()));if(!isFinite(F)||!isFinite(R)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let z=24*60*60*1e3,$=u=>{let N=new Date(u);return N.setHours(0,0,0,0),N.getTime()},E=$(F),v=$(R),c=o.querySelector(".prop-charts-title-row");c||(c=o.createDiv({cls:"prop-charts-title-row"}));let D=o.dataset.ganttZoomMode||String((xe=n.zoomMode)!=null?xe:"100");o.dataset.ganttZoomMode=D;let T=o.dataset.ganttLabelMode||String((ve=n.labelMode)!=null?ve:"compact");o.dataset.ganttLabelMode=T;let b=c.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let N=b.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===D&&N.addClass("is-active"),N.addEventListener("click",_=>{_.preventDefault(),o.dataset.ganttZoomMode=u.id,ee(o,r,t,e)})}),b.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let N=o.querySelector(".chart-notes-zoom-button");N&&N.click()});let rt=Number(n.labelWidth),B=!Number.isNaN(rt)&&rt>120?rt:260,H=T==="wide"?B+160:B,j=o.getBoundingClientRect().width||600,tt=Math.max(j,820),I;if(D==="fit")I=j;else{let u=Number(D)/100||1;I=tt*u}let{inner:y,svg:g,tooltip:P,details:C}=wt(o,s);y.style.width=I+"px";let M=(u,N,_,O,It,At,bt,Ft,yt)=>{if(!u)return;let Et=Math.max(40,O-8),_t=Math.max(8,Math.floor(Et/6)),kt=u.split(/\s+/),xt=[],ct="";for(let Tt of kt){if(!ct){ct=Tt;continue}(ct+" "+Tt).length<=_t?ct+=" "+Tt:(xt.push(ct),ct=Tt)}ct&&xt.push(ct);let vt=It+2,zt=xt.length*vt,Vt=_-zt/2+It;xt.forEach((Tt,Yt)=>{let ot=document.createElementNS(g.namespaceURI,"text");ot.setAttribute("x",String(N)),ot.setAttribute("y",String(Vt+Yt*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Tt,bt&&ot.addEventListener("mouseenter",nt=>bt(nt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),yt&&(ot.style.cursor="pointer",ot.addEventListener("click",nt=>yt(nt))),g.appendChild(ot)})},Z=28,G=28,st=10,Y=Math.max(300,Z+G+k*A+24);g.setAttribute("height",String(Y));let V=I-H-st,K=Z+6;g.style.color="#111111";let J=v+z-E||1,at=E-J*.02,ht=v+z+J*.08,lt=u=>H+(u-at)/(ht-at)*V,Q=(ht-at)/z,Nt=Math.max(4,Math.min(12,Math.floor(V/90)||4)),dt=Q/Nt,q=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=q[q.length-1];for(let u of q)if(u>=dt){pt=u;break}let Gt=[],Ge=$(at);for(let u=Ge;u<=ht+.5*z;u+=pt*z)Gt.push(u);let Ht=document.createElementNS(g.namespaceURI,"line");Ht.setAttribute("x1",String(H)),Ht.setAttribute("y1",String(K)),Ht.setAttribute("x2",String(I-st)),Ht.setAttribute("y2",String(K)),Ht.setAttribute("stroke","#111111"),g.appendChild(Ht);for(let u of Gt){let N=lt(u),_=document.createElementNS(g.namespaceURI,"line");_.setAttribute("x1",String(N)),_.setAttribute("y1",String(K)),_.setAttribute("x2",String(N)),_.setAttribute("y2",String(Y-G)),_.setAttribute("stroke","#111111"),_.setAttribute("stroke-opacity","0.20"),_.setAttribute("stroke-dasharray","2,4"),g.appendChild(_);let O=document.createElementNS(g.namespaceURI,"text");O.setAttribute("x",String(N)),O.setAttribute("y",String(K-4)),O.setAttribute("text-anchor","middle"),O.setAttribute("font-size","10"),O.setAttribute("fill","#111111"),O.textContent=Bt(new Date(u)),g.appendChild(O)}let ge=new Date;ge.setHours(0,0,0,0);let oe=ge.getTime();if(oe>=at&&oe<=ht){let u=lt(oe),N=document.createElementNS(g.namespaceURI,"line");N.setAttribute("x1",String(u)),N.setAttribute("y1",String(K)),N.setAttribute("x2",String(u)),N.setAttribute("y2",String(Y-G)),N.setAttribute("stroke","#4caf50"),N.setAttribute("stroke-width","2"),N.setAttribute("stroke-dasharray","4,2"),g.appendChild(N);let _=document.createElementNS(g.namespaceURI,"text");_.setAttribute("x",String(u+4)),_.setAttribute("y",String(K+12)),_.setAttribute("font-size","10"),_.setAttribute("fill","#4caf50"),_.textContent="hoje",g.appendChild(_)}let Ot=y.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",T==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${H}px`,Ot.style.top="4px",Ot.addEventListener("click",u=>{u.preventDefault();let _=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=_,ee(o,r,t,e)});let Ve=["status","priority"],ie=Array.isArray(n.tooltipFields)?n.tooltipFields.map(u=>String(u)):null,Ke=ie&&ie.length?ie:Ve,Qt=0,ae=null;for(let u of f){let N=u.start,_=u.end,O=(_.getTime()-N.getTime())/6e4,It=u.props,At=u.notePath,bt=u.noteTitle,Ft=(we=(Se=u.row.notes)==null?void 0:Se.length)!=null?we:0,yt=u.due,Et=u.estMinutes,Ct=[];Ct.push(`${Bt(N)} \u2192 ${Bt(_)}`),typeof Et=="number"&&!Number.isNaN(Et)?Ct.push(`est: ${Math.round(Et)} min`):O>0&&Ct.push(`dura\xE7\xE3o: ${Math.round(O)} min`),yt instanceof Date&&Ct.push(`due: ${Bt(yt)}`);for(let et of Ke){let U=x(It,et);U!=null&&String(U).trim()!==""&&Ct.push(`${et}: ${String(U)}`)}let _t=Ct.join("<br>"),kt=et=>{var U;et.preventDefault(),p&&At?new pe(At,r,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():mt(o,C,bt,Et!=null?Et:O,(U=u.row.notes)!=null?U:[],i)},xt=et=>{bt&&_t&&ft(o,P,bt,_t,Ft,et)},ct=()=>gt(P);if(u.groupKey!==ae){ae=u.groupKey;let et=K+8+Qt*A+A/2,U=a(ae);M(U,4,et,H-12,11,"600"),Qt+=1}let vt=K+8+Qt*A,zt=A-10,Vt=lt(N.getTime()),Tt=lt(_.getTime()),Yt=Math.max(4,Tt-Vt),ot=u.fullName,nt=document.createElementNS(g.namespaceURI,"rect");nt.setAttribute("x",String(Vt)),nt.setAttribute("y",String(vt)),nt.setAttribute("width",String(Yt)),nt.setAttribute("height",String(zt)),nt.setAttribute("rx","3"),nt.setAttribute("ry","3"),nt.setAttribute("fill",it((Ae=u.row.series)!=null?Ae:ot,Qt)),nt.setAttribute("stroke","rgba(0,0,0,0.25)"),nt.setAttribute("stroke-width","0.5"),nt.style.cursor=p&&At?"pointer":"default",nt.addEventListener("mouseenter",xt),nt.addEventListener("mouseleave",ct),nt.addEventListener("click",kt),g.appendChild(nt);let De=vt+zt/2;if(Yt>=6){let et=it((Ee=u.row.series)!=null?Ee:ot,Qt),U=document.createElementNS(g.namespaceURI,"circle");U.setAttribute("cx",String(Vt)),U.setAttribute("cy",String(De)),U.setAttribute("r","3.5"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",et),U.setAttribute("stroke-width","1.5"),g.appendChild(U);let Mt=document.createElementNS(g.namespaceURI,"circle");Mt.setAttribute("cx",String(Tt)),Mt.setAttribute("cy",String(De)),Mt.setAttribute("r","3.5"),Mt.setAttribute("fill","#ffffff"),Mt.setAttribute("stroke",et),Mt.setAttribute("stroke-width","1.5"),g.appendChild(Mt)}let Pe=vt+zt/2+2,Xt=h?16:4;if(T==="wide")M(ot,Xt,Pe,H-Xt-4,11,null,xt,ct,kt);else{let et=ot,U=Math.max(40,H-Xt-8),Ce=Math.max(8,Math.floor(U/6));et.length>Ce&&(et=et.slice(0,Ce-1)+"\u2026");let St=document.createElementNS(g.namespaceURI,"text");St.setAttribute("x",String(Xt)),St.setAttribute("y",String(Pe)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=et,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",ct),St.addEventListener("click",kt),g.appendChild(St)}if(yt instanceof Date){let et=lt(yt.getTime()),U=document.createElementNS(g.namespaceURI,"line");U.setAttribute("x1",String(et)),U.setAttribute("y1",String(vt)),U.setAttribute("x2",String(et)),U.setAttribute("y2",String(vt+zt)),U.setAttribute("stroke","#ff6b6b"),U.setAttribute("stroke-width","2"),U.setAttribute("stroke-dasharray","4,2"),g.appendChild(U)}Qt+=1}if(p){let u=o.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function he(o,r,t){var H,j,tt,I;let e=(H=r.options)!=null?H:{},n=e.background,s=(j=e.drilldown)!=null?j:!0,i=(tt=t.rows)!=null?tt:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:d}=wt(o,n),h=o.getBoundingClientRect().width||600,S=Math.max(h,480);p.style.width=S+"px";let x=40,m=16,f=18,A=28,k=300;a.setAttribute("height",String(k));let w=S-x-m,F=k-f-A,R=new Map;for(let y of i){let g=String(y.x),P=(I=R.get(g))!=null?I:{label:y.x,rows:[]};P.rows.push(y),R.set(g,P)}let $=Array.from(R.keys()).sort((y,g)=>y<g?-1:y>g?1:0).map(y=>R.get(y)),E=$.length,v=new Set;i.forEach(y=>{y.series!=null&&v.add(String(y.series))});let c=Array.from(v),D=c.length>1,T=D?"grouped":"single",b=0;i.forEach(y=>{y.y>b&&(b=y.y)}),(!isFinite(b)||b<=0)&&(b=1);let L=y=>f+F-y/(b||1)*F,W=L(0),rt=4;for(let y=0;y<=rt;y++){let g=b*y/rt,P=L(g),C=document.createElementNS(a.namespaceURI,"line");C.setAttribute("x1",String(x)),C.setAttribute("y1",String(P)),C.setAttribute("x2",String(S-m)),C.setAttribute("y2",String(P)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),a.appendChild(C);let M=document.createElementNS(a.namespaceURI,"text");M.setAttribute("x",String(x-4)),M.setAttribute("y",String(P+3)),M.setAttribute("text-anchor","end"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=String(Math.round(g)),a.appendChild(M)}let B=E>0?w/E:w;if($.forEach((y,g)=>{let P=x+B*(g+.5),C=String(y.label),M=document.createElementNS(a.namespaceURI,"text");M.setAttribute("x",String(P)),M.setAttribute("y",String(k-A+12)),M.setAttribute("text-anchor","middle"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=C,a.appendChild(M)}),D){let y=o.createDiv({cls:"chart-notes-legend"});c.forEach((g,P)=>{let C=y.createDiv({cls:"chart-notes-legend-item"}),M=C.createDiv();M.style.width="10px",M.style.height="10px",M.style.borderRadius="999px",M.style.backgroundColor=it(g,P),C.createSpan({text:g})})}$.forEach((y,g)=>{let P=x+B*(g+.5),C=y.rows;if(T==="single"){let Y=C[0],V=Y.y,K=B*.6,J=P-K/2,at=L(V),ht=Math.max(2,W-at),lt=it("bar",g),Q=document.createElementNS(a.namespaceURI,"rect");Q.setAttribute("x",String(J)),Q.setAttribute("y",String(at)),Q.setAttribute("width",String(K)),Q.setAttribute("height",String(ht)),Q.setAttribute("fill",lt),Q.setAttribute("stroke","rgba(0,0,0,0.25)"),Q.setAttribute("stroke-width","0.5"),Q.style.cursor="pointer";let X=String(y.label),Nt=`valor: ${Math.round(V*100)/100}`;Q.addEventListener("mouseenter",dt=>{var q,pt;return ft(o,l,X,Nt,(pt=(q=Y.notes)==null?void 0:q.length)!=null?pt:0,dt)}),Q.addEventListener("mouseleave",()=>gt(l)),Q.addEventListener("click",dt=>{var q;dt.preventDefault(),mt(o,d,X,V,(q=Y.notes)!=null?q:[],s)}),a.appendChild(Q);return}let M=c.length,Z=B/Math.max(M+1,2),G=M*Z,st=P-G/2;c.forEach((Y,V)=>{let K=C.find(q=>(q.series!=null?String(q.series):"")===Y);if(!K)return;let J=K.y,at=st+V*Z,ht=L(J),lt=Math.max(2,W-ht),Q=it(Y,V),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(at)),X.setAttribute("y",String(ht)),X.setAttribute("width",String(Z)),X.setAttribute("height",String(lt)),X.setAttribute("fill",Q),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let Nt=`${Y} @ ${String(y.label)}`,dt=`valor: ${Math.round(J*100)/100}`;X.addEventListener("mouseenter",q=>{var pt,Gt;return ft(o,l,Nt,dt,(Gt=(pt=K.notes)==null?void 0:pt.length)!=null?Gt:0,q)}),X.addEventListener("mouseleave",()=>gt(l)),X.addEventListener("click",q=>{var pt;q.preventDefault(),mt(o,d,Nt,J,(pt=K.notes)!=null?pt:[],s)}),a.appendChild(X)})})}function Qe(o,r,t){var B,H,j,tt;let e=(B=r.options)!=null?B:{},n=e.background,s=(H=e.drilldown)!=null?H:!0,i=(j=t.rows)!=null?j:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:d}=wt(o,n),h=o.getBoundingClientRect().width||600,S=Math.max(h,480);p.style.width=S+"px";let x=40,m=16,f=18,A=28,k=300;a.setAttribute("height",String(k));let w=S-x-m,F=k-f-A,R=new Map;for(let I of i){let y=String(I.x),g=(tt=R.get(y))!=null?tt:{label:I.x,rows:[]};g.rows.push(I),R.set(y,g)}let $=Array.from(R.keys()).sort((I,y)=>I<y?-1:I>y?1:0).map(I=>R.get(I)),E=$.length,v=new Set;i.forEach(I=>{I.series!=null&&v.add(String(I.series))});let c=Array.from(v);if(!c.length){he(o,r,t);return}let D=0;$.forEach(I=>{let y=I.rows.reduce((g,P)=>g+P.y,0);y>D&&(D=y)}),(!isFinite(D)||D<=0)&&(D=1);let T=I=>f+F-I/(D||1)*F,b=T(0),L=4;for(let I=0;I<=L;I++){let y=D*I/L,g=T(y),P=document.createElementNS(a.namespaceURI,"line");P.setAttribute("x1",String(x)),P.setAttribute("y1",String(g)),P.setAttribute("x2",String(S-m)),P.setAttribute("y2",String(g)),P.setAttribute("stroke","#cccccc"),P.setAttribute("stroke-opacity","0.25"),a.appendChild(P);let C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(x-4)),C.setAttribute("y",String(g+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=String(Math.round(y)),a.appendChild(C)}let W=E>0?w/E:w;$.forEach((I,y)=>{let g=x+W*(y+.5),P=String(I.label),C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(g)),C.setAttribute("y",String(k-A+12)),C.setAttribute("text-anchor","middle"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=P,a.appendChild(C)});let rt=o.createDiv({cls:"chart-notes-legend"});c.forEach((I,y)=>{let g=rt.createDiv({cls:"chart-notes-legend-item"}),P=g.createDiv();P.style.width="10px",P.style.height="10px",P.style.borderRadius="999px",P.style.backgroundColor=it(I,y),g.createSpan({text:I})}),$.forEach((I,y)=>{let g=x+W*(y+.5),P=W*.6,C=g-P/2,M=0;c.forEach((Z,G)=>{let st=I.rows.find(dt=>(dt.series!=null?String(dt.series):"")===Z);if(!st)return;let Y=st.y,V=M,K=M+Y;M=K;let J=T(V),at=T(K),ht=Math.max(2,J-at),lt=it(Z,G),Q=document.createElementNS(a.namespaceURI,"rect");Q.setAttribute("x",String(C)),Q.setAttribute("y",String(at)),Q.setAttribute("width",String(P)),Q.setAttribute("height",String(ht)),Q.setAttribute("fill",lt),Q.setAttribute("stroke","rgba(0,0,0,0.25)"),Q.setAttribute("stroke-width","0.5"),Q.style.cursor="pointer";let X=`${Z} @ ${String(I.label)}`,Nt=`valor: ${Math.round(Y*100)/100}`;Q.addEventListener("mouseenter",dt=>{var q,pt;return ft(o,l,X,Nt,(pt=(q=st.notes)==null?void 0:q.length)!=null?pt:0,dt)}),Q.addEventListener("mouseleave",()=>gt(l)),Q.addEventListener("click",dt=>{var q;dt.preventDefault(),mt(o,d,X,Y,(q=st.notes)!=null?q:[],s)}),a.appendChild(Q)})})}function ye(o,r,t,e){var H,j,tt,I;let n=(H=r.options)!=null?H:{},s=n.background,i=(j=n.drilldown)!=null?j:!0,p=(tt=t.rows)!=null?tt:[];if(!p.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:d,details:h}=wt(o,s),S=o.getBoundingClientRect().width||600,x=Math.max(S,480);a.style.width=x+"px";let m=40,f=16,A=18,k=24,w=300;l.setAttribute("height",String(w));let F=x-m-f,R=w-A-k,z=new Map;for(let y of p){let g=y.series!=null?String(y.series):"__default__",P=(I=z.get(g))!=null?I:[];P.push(y),z.set(g,P)}let $=Array.from(z.keys()),E=[],v=new Set;for(let y of p){let g=String(y.x);v.has(g)||(v.add(g),E.push(y.x))}let c=E.length||1,D=y=>{let g=String(y),P=E.findIndex(C=>String(C)===g);return P<0?m:c===1?m+F/2:m+P/(c-1)*F},T=y=>String(y),b=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY;for(let y of p)y.y<b&&(b=y.y),y.y>L&&(L=y.y);(!isFinite(b)||!isFinite(L))&&(b=0,L=1),b===L&&(b===0?L=1:b=0);let W=y=>A+R-(y-b)/(L-b||1)*R,rt=4;for(let y=0;y<=rt;y++){let g=b+(L-b)*y/rt,P=W(g),C=document.createElementNS(l.namespaceURI,"line");C.setAttribute("x1",String(m)),C.setAttribute("y1",String(P)),C.setAttribute("x2",String(x-f)),C.setAttribute("y2",String(P)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),l.appendChild(C);let M=document.createElementNS(l.namespaceURI,"text");M.setAttribute("x",String(m-4)),M.setAttribute("y",String(P+3)),M.setAttribute("text-anchor","end"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=Math.abs(g)>=100?String(Math.round(g)):String(Math.round(g*10)/10),l.appendChild(M)}let B=$.filter(y=>y!=="__default__");if(B.length>1){let y=o.createDiv({cls:"chart-notes-legend"});B.forEach((g,P)=>{let C=g,M=y.createDiv({cls:"chart-notes-legend-item"}),Z=M.createDiv();Z.style.width="10px",Z.style.height="10px",Z.style.borderRadius="999px",Z.style.backgroundColor=it(C,P),M.createSpan({text:C})})}$.forEach((y,g)=>{let P=z.get(y);if(!(P!=null&&P.length))return;let C=y==="__default__"?it("line",g):it(y,g),M=[...P].sort((G,st)=>{let Y=E.findIndex(K=>String(K)===String(G.x)),V=E.findIndex(K=>String(K)===String(st.x));return Y-V}),Z="";if(M.forEach((G,st)=>{let Y=D(G.x),V=W(G.y);Z+=(st===0?"M ":" L ")+Y+" "+V}),e){let G=M[0],st=M[M.length-1],Y=D(G.x),V=D(st.x),K=W(b);Z+=` L ${V} ${K} L ${Y} ${K} Z`;let J=document.createElementNS(l.namespaceURI,"path");J.setAttribute("d",Z),J.setAttribute("fill",C),J.setAttribute("fill-opacity","0.18"),J.setAttribute("stroke",C),J.setAttribute("stroke-width","1.5"),l.appendChild(J)}else{let G=document.createElementNS(l.namespaceURI,"path");G.setAttribute("d",Z),G.setAttribute("fill","none"),G.setAttribute("stroke",C),G.setAttribute("stroke-width","2"),l.appendChild(G)}M.forEach(G=>{let st=D(G.x),Y=W(G.y),V=document.createElementNS(l.namespaceURI,"circle");V.setAttribute("cx",String(st)),V.setAttribute("cy",String(Y)),V.setAttribute("r","3"),V.setAttribute("fill","#ffffff"),V.setAttribute("stroke",C),V.setAttribute("stroke-width","1.5"),V.style.cursor="pointer";let K=T(G.x),J=y==="__default__"?"":String(G.series),at=J?`${J} @ ${K}`:K,ht=`valor: ${Math.round(G.y*100)/100}`;V.addEventListener("mouseenter",lt=>{var Q,X;return ft(o,d,at,ht,(X=(Q=G.notes)==null?void 0:Q.length)!=null?X:0,lt)}),V.addEventListener("mouseleave",()=>gt(d)),V.addEventListener("click",lt=>{var Q;lt.preventDefault(),mt(o,h,at,G.y,(Q=G.notes)!=null?Q:[],i)}),l.appendChild(V)})})}function ze(o,r,t){var F;let{background:e,drilldown:n=!0}=(F=r.options)!=null?F:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=He(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:d}=wt(o,e),h=Math.max(i,420);p.style.width=h+"px",s&&(a.style.color=s);let S=300,x=h/2,m=(S-28+28)/2,f=Math.min(h/2-20,S/2-20),k=t.rows.map(R=>Math.max(0,R.y)).reduce((R,z)=>R+z,0)||1,w=-Math.PI/2;t.rows.forEach((R,z)=>{var B;let $=R.x instanceof Date?R.x.toISOString().slice(0,10):String(R.x),E=R.y,v=E/k*Math.PI*2,c=x+f*Math.cos(w),D=m+f*Math.sin(w),T=x+f*Math.cos(w+v),b=m+f*Math.sin(w+v),L=v>Math.PI?1:0,W=document.createElementNS(a.namespaceURI,"path"),rt=[`M ${x} ${m}`,`L ${c} ${D}`,`A ${f} ${f} 0 ${L} 1 ${T} ${b}`,"Z"].join(" ");W.setAttribute("d",rt),W.setAttribute("fill",it((B=R.series)!=null?B:$,z)),W.style.cursor="pointer",W.addEventListener("mouseenter",H=>{var j,tt;return ft(o,l,$,E,(tt=(j=R.notes)==null?void 0:j.length)!=null?tt:0,H)}),W.addEventListener("mouseleave",()=>gt(l)),W.addEventListener("click",()=>{var H;return mt(o,d,$,E,(H=R.notes)!=null?H:[],n)}),a.appendChild(W),w+=v})}function Be(o,r,t){var D;let{background:e,drilldown:n=!0}=(D=r.options)!=null?D:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:d}=wt(o,e),h=Math.max(i,700);p.style.width=h+"px",s&&(a.style.color=s);let S=300,x=h-48-10,m=S-28-28,f=t.rows.map(T=>{let b=T.x;if(b instanceof Date)return b.getTime();if(typeof b=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(b)){let W=new Date(b);if(!isNaN(W.getTime()))return W.getTime()}let L=Number(b);return isNaN(L)?null:L}return typeof b=="number"?b:null}),A=t.rows.map(T=>T.y),k=f.filter(T=>T!==null);if(k.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let w=Math.min(...k),F=Math.max(...k),R=Math.min(...A),z=Math.max(...A),$=T=>48+(T-w)/(F-w||1)*x,E=T=>S-28-(T-R)/(z-R||1)*m,v=document.createElementNS(a.namespaceURI,"line");v.setAttribute("x1",String(48)),v.setAttribute("y1",String(28)),v.setAttribute("x2",String(48)),v.setAttribute("y2",String(S-28)),v.setAttribute("stroke","currentColor"),a.appendChild(v);let c=document.createElementNS(a.namespaceURI,"line");c.setAttribute("x1",String(48)),c.setAttribute("y1",String(S-28)),c.setAttribute("x2",String(h-10)),c.setAttribute("y2",String(S-28)),c.setAttribute("stroke","currentColor"),a.appendChild(c),t.rows.forEach((T,b)=>{let L=f[b];if(L==null)return;let W=$(L),rt=E(A[b]),B=document.createElementNS(a.namespaceURI,"circle");B.setAttribute("cx",String(W)),B.setAttribute("cy",String(rt)),B.setAttribute("r","4"),B.setAttribute("fill",it(T.series,b)),B.style.cursor="pointer";let H=T.x instanceof Date?T.x.toISOString().slice(0,10):typeof T.x=="string"?T.x:String(T.x);B.addEventListener("mouseenter",j=>{var tt,I;return ft(o,l,H,T.y,(I=(tt=T.notes)==null?void 0:tt.length)!=null?I:0,j)}),B.addEventListener("mouseleave",()=>gt(l)),B.addEventListener("click",j=>{var tt;j.preventDefault(),mt(o,d,H,T.y,(tt=T.notes)!=null?tt:[],n)}),a.appendChild(B)})}var We=require("obsidian"),ne=class{render(r,t,e,n,s=!1){var l;let{title:i}=(l=t.options)!=null?l:{};r.empty(),r.addClass("prop-charts-container");let a=r.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":he(r,t,e);break;case"stacked-bar":Qe(r,t,e);break;case"line":ye(r,t,e,!1);break;case"area":ye(r,t,e,!0);break;case"pie":ze(r,t,e);break;case"scatter":Be(r,t,e);break;case"gantt":ee(r,t,e,n);break;default:r.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!s){let d=r.createEl("button",{cls:"chart-notes-zoom-button"});d.setAttr("type","button"),d.setAttr("aria-label","Expandir gr\xE1fico"),d.textContent="\u2922",d.addEventListener("click",h=>{h.preventDefault(),new fe(t,e,this,n).open()})}}},fe=class extends We.Modal{constructor(t,e,n,s){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=n,this.ctx=s}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),n=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:n,cls:"chart-notes-zoom-title"});let s=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(l,d)=>{let h=s.createEl("button",{cls:"chart-notes-zoom-size-btn",text:l});(()=>{h.toggleClass("is-active",this.size===d)})(),h.addEventListener("click",x=>{x.preventDefault(),this.size=d,this.applySize(),s.querySelectorAll(".chart-notes-zoom-size-btn").forEach(f=>f.classList.remove("is-active")),h.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let p=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(p,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",n="85vh";switch(this.size){case"small":e="60vw",n="55vh";break;case"medium":e="80vw",n="70vh";break;case"large":default:e="95vw",n="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=n,t.style.maxHeight=n}};var se=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("loading Chart Notes plugin"),this.indexer=new jt(this.app),await this.indexer.buildIndex(),this.query=new te(()=>this.indexer.getAll(),[]),this.renderer=new ne,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,n)=>{var d;let s;try{let h=(0,Lt.parseYaml)(t);if(!h||typeof h!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}s=h}catch(h){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+h.message});return}if(!s.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=s.type==="gantt",p=s.type==="table";if(!i&&!p){if(!s.encoding||!s.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let S=((d=s.aggregate)==null?void 0:d.y)==="count";if(!s.encoding.y&&!S){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}s.encoding||(s.encoding={}),s.source||(s.source={});let l;try{l=this.query.run(s)}catch(h){e.createEl("div",{text:"Chart Notes: erro na query: "+h.message});return}this.renderer.render(e,s,l)}),this.registerBasesView(ce,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new qt(t,e,this.renderer),options:()=>[{type:"dropdown",key:"chartType",displayName:"Tipo do gr\xE1fico",default:"bar",options:{bar:"Barra","stacked-bar":"Barra empilhada",line:"Linha",area:"\xC1rea",pie:"Pizza",scatter:"Dispers\xE3o",gantt:"Gantt"}},{type:"text",key:"title",displayName:"T\xEDtulo (opcional)",placeholder:"(vazio = usa nome da view)"},{type:"property",key:"xProperty",displayName:"Propriedade X / label"},{type:"property",key:"yProperty",displayName:"Propriedade Y / valor (vazio = conta linhas)"},{type:"property",key:"seriesProperty",displayName:"S\xE9rie (opcional, gera legenda / cores)"},{type:"property",key:"startProperty",displayName:"In\xEDcio (Gantt)"},{type:"property",key:"endProperty",displayName:"Fim (Gantt)"},{type:"property",key:"dueProperty",displayName:"Due date (Gantt, opcional)"},{type:"property",key:"durationProperty",displayName:"Dura\xE7\xE3o em minutos (Gantt, opcional)"},{type:"property",key:"groupProperty",displayName:"Grupo / lane (Gantt / s\xE9ries, opcional)"},{type:"toggle",key:"drilldown",displayName:"Drilldown (clicar abre lista de notas)",default:!0},{type:"text",key:"background",displayName:"Cor de fundo (ex: #ffffff, opcional)",placeholder:"#ffffff"},{type:"multitext",key:"tooltipFields",displayName:"Campos extras no tooltip (ex: status,priority)",default:[]}]})}onunload(){console.log("unloading Chart Notes plugin")}};
