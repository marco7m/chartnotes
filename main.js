/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Ue=Object.prototype.hasOwnProperty;var Oe=(s,n)=>{for(var t in n)le(s,t,{get:n[t],enumerable:!0})},Ye=(s,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of Ke(n))!Ue.call(s,r)&&r!==t&&le(s,r,{get:()=>n[r],enumerable:!(e=We(n,r))||e.enumerable});return s};var Xe=s=>Ye(le({},"__esModule",{value:!0}),s);var an={};Oe(an,{default:()=>se});module.exports=Xe(an);var Ct=require("obsidian");var qt=require("obsidian"),ce="chartnotes-view",Xt=class extends qt.BasesView{constructor(t,e,r){super(t);this.type=ce;this.containerEl=e.createDiv("chartnotes-bases-view"),this.renderer=r}onDataUpdated(){var M,z,$,C;this.containerEl.empty();let t=(M=this.data)==null?void 0:M.groupedData;if(!t||t.length===0){this.containerEl.createDiv({cls:"prop-charts-empty",text:"Sem dados (Base vazia ou sem resultados)."});return}let e=this.config,o=(((z=e==null?void 0:e.get("chartType"))!=null?z:"bar")||"bar").trim().toLowerCase();new Set(["bar","stacked-bar","line","area","pie","scatter","gantt"]).has(o)||(o="bar");let p;if(o==="gantt"?p=this.buildRowsForGantt(t):o==="scatter"?p=this.buildRowsForScatter(t):p=this.buildRowsForAggregatedCharts(t),!p.length){this.containerEl.createDiv({cls:"prop-charts-empty",text:"Sem linhas para exibir (verifique as propriedades configuradas)."});return}let a={rows:p},c=this.buildEncoding(),g=(($=e==null?void 0:e.get("title"))!=null?$:"").trim()||(e==null?void 0:e.name)||"Chart Notes (Bases)",x=((C=e==null?void 0:e.get("background"))!=null?C:"").trim()||void 0,y=e==null?void 0:e.get("drilldown"),m=typeof y=="boolean"?y:!0,w=e==null?void 0:e.get("tooltipFields"),T;Array.isArray(w)&&(T=w.map(S=>String(S).trim()).filter(S=>S.length>0),T.length===0&&(T=void 0));let A={type:o,source:{type:"properties",query:""},encoding:c,options:{title:g,background:x,drilldown:m,tooltipFields:T}},_={refresh:()=>this.onDataUpdated()};this.renderer.render(this.containerEl,A,a,_)}getSelectedProp(t){var i;let e=this.config,r=e==null?void 0:e.get(t);if(!r||typeof r!="string")return{id:null,name:null};let o=r;try{let p=(0,qt.parsePropertyId)(o);return{id:r,name:(i=p==null?void 0:p.name)!=null?i:r}}catch(p){return{id:r,name:r}}}readValue(t,e){if(!e.id)return null;let r;try{r=t.getValue(e.id)}catch(o){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let e=t.trim();if(!e)return null;let r=new Date(e);return Number.isNaN(r.getTime())?null:r}buildRowsForAggregatedCharts(t){var p,a;let e=this.getSelectedProp("xProperty"),r=this.getSelectedProp("yProperty"),o=this.getSelectedProp("seriesProperty"),i=new Map;for(let c of t)for(let h of c.entries){let g=h.file,b=(a=this.readValue(h,e))!=null?a:g!=null&&g.name?String(g.name):String((p=g==null?void 0:g.path)!=null?p:""),x=this.readValue(h,r),y=1;if(r.id){if(x==null)continue;let _=Number(x);if(Number.isNaN(_))continue;y=_}let m=this.readValue(h,o),w=m!=null?String(m):void 0,T=`${b}@@${w!=null?w:""}`,A=i.get(T);A||(A={x:b,y:0,series:w,notes:[],props:{}},i.set(T,A)),A.y+=y,g!=null&&g.path&&A.notes.push(g.path),A.props&&e.name&&(A.props[e.name]=b),A.props&&r.name&&x!=null&&(A.props[r.name]=y),A.props&&o.name&&m!=null&&(A.props[o.name]=m)}return Array.from(i.values())}buildRowsForScatter(t){let e=this.getSelectedProp("xProperty"),r=this.getSelectedProp("yProperty"),o=this.getSelectedProp("seriesProperty"),i=[];for(let p of t)for(let a of p.entries){let c=a.file,h=this.readValue(a,e),g=this.readValue(a,r);if(h==null||g==null)continue;let b=Number(h),x=Number(g);if(Number.isNaN(b)||Number.isNaN(x))continue;let y=this.readValue(a,o),m=y!=null?String(y):void 0,w={x:b,y:x,series:m,notes:c!=null&&c.path?[c.path]:[],props:{}};i.push(w)}return i}buildRowsForGantt(t){var g,b;let e=this.getSelectedProp("xProperty"),r=this.getSelectedProp("seriesProperty"),o=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),p=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),c=this.getSelectedProp("groupProperty"),h=[];for(let x of t)for(let y of x.entries){let m=y.file,w=this.readValue(y,o),T=this.readValue(y,i);if(!w||!T)continue;let A=this.parseDate(w),_=this.parseDate(T);if(!A||!_)continue;let M=(b=this.readValue(y,e))!=null?b:m!=null&&m.name?String(m.name).replace(/\.md$/i,""):String((g=m==null?void 0:m.path)!=null?g:""),z=this.readValue(y,p),$=this.parseDate(z!=null?z:null),C=this.readValue(y,a),S=C!=null?Number(C):void 0,u=typeof S=="number"&&!Number.isNaN(S),E=this.readValue(y,r),N=E!=null?String(E):void 0,v=this.readValue(y,c),L={};a.name&&u&&(L[a.name]=S),c.name&&v!=null&&(L[c.name]=v);let V={x:M,y:0,series:N,start:A,end:_,due:$!=null?$:void 0,notes:m!=null&&m.path?[m.path]:[],props:L};h.push(V)}return h}buildEncoding(){var h,g,b,x,y,m,w,T;let t=this.getSelectedProp("xProperty"),e=this.getSelectedProp("yProperty"),r=this.getSelectedProp("seriesProperty"),o=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),p=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),c=this.getSelectedProp("groupProperty");return{x:(h=t.name)!=null?h:"x",y:(g=e.name)!=null?g:"y",series:(b=r.name)!=null?b:"series",start:(x=o.name)!=null?x:"start",end:(y=i.name)!=null?y:"end",due:(m=p.name)!=null?m:"due",duration:(w=a.name)!=null?w:"duration",group:(T=c.name)!=null?T:"group"}}};var Ne=require("obsidian"),jt=class{constructor(n){this.index=new Map;this.app=n}async buildIndex(){this.index.clear();let n=this.app.vault.getMarkdownFiles();for(let t of n)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(n){if(n.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(n)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Ne.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[p,a]of Object.entries(i))p!=="position"&&(t[p]=a)}let o=this.app.metadataCache.getFileCache(n);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",n.path,e)}this.index.set(n.path,{path:n.path,props:t})}removeFile(n){this.index.delete(n.path)}};function ke(s,n){if(!n||n.length===0)return!0;for(let t of n){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(e))return!0}return!1}function Me(s,n){if(!n||n.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of n)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let e=String(t);for(let r of n)if(e===r||e==="#"+r)return!0;return!1}function Jt(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function $t(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,e,r]=s.split("-");return new Date(Number(t),Number(e)-1,Number(r),0,0,0,0)}let n=new Date(s);return isNaN(n.getTime())?null:n}function ut(s){let n=new Date(s);return n.setHours(0,0,0,0),n}function Zt(s,n){let t=new Date(s);return t.setDate(t.getDate()-n),t}function qe(s,n){return Zt(s,n*7)}function je(s,n){let t=new Date(s);return t.setMonth(t.getMonth()-n),t}function de(s,n){let t=new Date(s);return t.setDate(t.getDate()+n),t}function Ze(s,n){return de(s,n*7)}function Je(s,n){let t=new Date(s);return t.setMonth(t.getMonth()+n),t}function Te(s){let n=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(n)||n.endsWith("date")||n.endsWith("at")||n.endsWith("on"))}function Pe(s,n){let t=n?new Date(n):new Date,e=ut(t),r=s.trim().toLowerCase();if(r==="today")return e;if(r==="yesterday")return ut(Zt(e,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(Zt(e,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Zt(e,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(qe(e,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(je(e,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(de(e,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(de(e,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Ze(e,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Je(e,o))}return null}function Le(s){let n=s.trim(),t=n.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let h=t[1].trim(),g=t[2].trim(),b=t[3].trim(),x=Te(h),y=ue(g,x),m=ue(b,x),w=y.valueType==="date"||m.valueType==="date"?"date":y.valueType;return{field:h,op:"between",value:y.value,value2:m.value,valueType:w}}let e=/(==|!=|>=|<=|>|<)/,r=n.split(e);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),p=r[2].trim(),a=Te(o),c=ue(p,a);return{field:o,op:i,value:c.value,valueType:c.valueType}}function ue(s,n){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),r=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(n){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Pe(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Pe(t);if(i)return{value:i,valueType:"date"}}if(Jt(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ie(s,n){let t=s[n.field];if(t==null)return!1;if(n.valueType==="date"){let o=t instanceof Date?ut(t):Jt(t)?ut($t(t)):null;if(!o)return!1;let i=n.value instanceof Date?n.value:null,p=n.value2 instanceof Date?n.value2:null;if(!i)return!1;let a=o.getTime(),c=ut(i).getTime();switch(n.op){case"==":return a===c;case"!=":return a!==c;case">":return a>c;case">=":return a>=c;case"<":return a<c;case"<=":return a<=c;case"between":if(!p)return!1;let h=ut(p).getTime();return a>=c&&a<=h}}if(n.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(n.value);switch(n.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof n.value2!="number"?!1:o>=i&&o<=n.value2}}let e=String(t),r=String(n.value);switch(n.op){case"==":return e===r;case"!=":return e!==r;case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r;case"between":return!1}}function tn(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(Jt(s)){let n=$t(s);if(n)return{key:n,isDate:!0}}return{key:s,isDate:!1}}function en(s,n){let t=s.x,e=n.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let r=String(t),o=String(e);return r<o?-1:r>o?1:0}function nn(s,n){var o,i;let t=en(s,n);if(t!==0)return t;let e=(o=s.series)!=null?o:"",r=(i=n.series)!=null?i:"";return e<r?-1:e>r?1:0}function rn(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let n=s.trim().match(/^(\d+)/);if(n){let t=Number(n[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function sn(s){var e,r;let n=new Map,t=[];for(let o of s){let i=(e=o.series)!=null?e:"__no_series__",a=((r=n.get(i))!=null?r:0)+o.y;n.set(i,a),t.push({...o,y:a})}return t}function on(s,n){var i,p;let t=rn(n);if(!t||t<=1)return[...s];let e=new Map,r=new Map,o=[];for(let a of s){let c=(i=a.series)!=null?i:"__no_series__",h=e.get(c);h||(h=[],e.set(c,h));let g=(p=r.get(c))!=null?p:0;if(h.push(a.y),g+=a.y,h.length>t){let y=h.shift();g-=y}r.set(c,g);let b=h.length||1,x=g/b;o.push({...a,y:x})}return o}var te=class{constructor(n,t){this.getIndex=n,this.defaultPaths=t}run(n){var i,p,a;let t=this.getIndex(),e=(i=n.source)!=null&&i.paths&&n.source.paths.length?n.source.paths:this.defaultPaths,r=(p=n.source)!=null&&p.tags&&n.source.tags.length?n.source.tags:[],o=[];for(let c of t){let h=e&&e.length?ke(c.path,e):!0,g=r&&r.length?Me(c.props,r):!0;if(!h||!g)continue;let b=!0;if((a=n.source)!=null&&a.where&&n.source.where.length>0)for(let x of n.source.where){let y;try{y=Le(x)}catch(m){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${x} (${m.message})`)}if(!Ie(c.props,y)){b=!1;break}}b&&o.push(c)}return n.type==="gantt"?this.runGantt(n,o):n.type==="table"?this.runTable(n,o):this.runStandard(n,o)}runTable(n,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=n.encoding)==null?void 0:r.x,yField:(o=n.encoding)==null?void 0:o.y}}runGantt(n,t){var g,b,x;let e=(g=n.encoding)!=null?g:{},r=e.start,o=e.end,i=(b=e.label)!=null?b:e.x,p=e.series,a=e.duration,c=e.due,h=[];for(let y of t){let m=(x=y.props)!=null?x:{},w=C=>Array.isArray(C)?C[0]:C,T=null;if(o){let C=w(m[o]),S=$t(C);S&&(T=S)}if(!T)continue;let A=null;if(r){let C=w(m[r]),S=$t(C);S&&(A=S)}if(!A&&a){let C=w(m[a]),S=Number(C);Number.isNaN(S)||(A=new Date(T.getTime()-S*6e4))}A||(A=new Date(T.getTime()));let _;if(c){let C=w(m[c]),S=$t(C);S&&(_=S)}let M;if(i){let C=w(m[i]);(C==null||C==="")&&(C=y.path),M=C}else M=y.path;let z;if(p){let C=w(m[p]);C!=null&&(z=String(C))}let $={x:M,y:0,notes:[y.path],series:z,start:A,end:T,props:m};_&&($.due=_),h.push($)}return h.sort((y,m)=>{let w=y.start?y.start.getTime():0,T=m.start?m.start.getTime():0;return w-T}),{rows:h,xField:i,yField:o}}runStandard(n,t){var y,m,w,T,A,_,M,z,$,C;let e=(y=n.encoding)==null?void 0:y.x,r=(m=n.encoding)==null?void 0:m.y,o=(w=n.encoding)==null?void 0:w.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(T=n.aggregate)!=null?T:{},p=(A=i.y)!=null?A:null,a=!!i.cumulative,c=i.rolling;if(!r&&p!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let h=[];for(let S of t){let u=(_=S.props)!=null?_:{},E=Q=>Array.isArray(Q)?Q[0]:Q,N=E(u[e]);if(N==null)continue;let v=tn(N),L=v.key,V=v.isDate,nt;if(o){let Q=E(u[o]);Q!=null&&String(Q).trim()!==""&&(nt=String(Q))}let B;if(p==="count")B=1;else{let Q=E(u[r]);if(Q==null)continue;let j=Number(Q);if(Number.isNaN(j))continue;B=j}h.push({x:L,y:B,notes:[S.path],series:nt,props:u,_isDate:V,_origX:N})}if(h.length===0)return{rows:[],xField:e,yField:r};let g=[];if(p){let S=new Map;for(let u of h){let E=(M=u.series)!=null?M:"",N=u.x instanceof Date?u.x.toISOString().slice(0,10):String(u.x),v=E+"||"+N,L=(z=S.get(v))!=null?z:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:u.x,isDate:u._isDate,series:u.series,props:u.props};L.sum+=u.y,L.count+=1,u.y<L.min&&(L.min=u.y),u.y>L.max&&(L.max=u.y),L.notes.push(...u.notes),L.props=($=u.props)!=null?$:L.props,S.set(v,L)}for(let[,u]of S){let E=u.sum;switch(p){case"sum":E=u.sum;break;case"avg":E=u.sum/u.count;break;case"min":E=u.min;break;case"max":E=u.max;break;case"count":E=u.count;break}g.push({x:u.xRep,y:E,notes:u.notes,series:u.series,props:u.props})}}else g=h.map(S=>({x:S.x,y:S.y,notes:S.notes,series:S.series,props:S.props}));if(g.length===0)return{rows:[],xField:e,yField:r};let b=((C=n.sort)==null?void 0:C.x)==="desc"?"desc":"asc";if(g.sort((S,u)=>{let E=nn(S,u);return b==="asc"?E:-E}),(a||c)&&!(n.type==="line"||n.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&c)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let x=g;return c?x=on(g,c):a&&(x=sn(g)),{rows:x,xField:e,yField:r}}};var Rt=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(s,n){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((e,r)=>e*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(s,n){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,n&&(e.style.background=n);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",e.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let p=s.createDiv({cls:"chart-notes-details"});return p.style.display="none",{scroll:t,inner:e,svg:o,tooltip:i,details:p}}function mt(s,n,t,e,r,o){let i=s.getBoundingClientRect(),p=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);n.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${p}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,n.style.display="block";let a=n.getBoundingClientRect(),c=o.clientX-i.left+6,h=o.clientY-i.top+6;c+a.width>i.width-4&&(c=i.width-a.width-4),c<4&&(c=4),h+a.height>i.height-4&&(h=i.height-a.height-4),h<4&&(h=4),n.style.left=c+"px",n.style.top=h+"px"}function gt(s){s.style.display="none"}function yt(s,n,t,e,r,o){if(!o)return;if(n.empty(),!r||r.length===0){n.style.display="none";return}n.style.display="block";let i=n.createEl("div",{cls:"chart-notes-details-header"}),p=i.createEl("div",{cls:"chart-notes-details-title"});p.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{n.style.display="none"});let c=n.createEl("ul",{cls:"chart-notes-details-list"});for(let h of r){let b=c.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:h});b.href="#",b.addEventListener("click",x=>{x.preventDefault(),app.workspace.openLinkText(h,"",!1)})}}function Bt(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let n=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${n}/${t}`}function _e(s){if(!s)return!1;let n=s.trim().toLowerCase();if(n==="#fff"||n==="#ffffff"||n==="white")return!0;if(!n.startsWith("#"))return!1;let t,e,r;if(n.length===4)t=parseInt(n[1]+n[1],16),e=parseInt(n[2]+n[2],16),r=parseInt(n[3]+n[3],16);else if(n.length===7)t=parseInt(n.slice(1,3),16),e=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*r)/255>.7}var pe=class extends Rt.Modal{constructor(t,e,r,o){var p;super(app);this.notePath=t,this.spec=e,this.refresh=r,this.reindexFile=o;let i=(p=e.encoding)!=null?p:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var C,S;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Rt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(e),o={},i=r,p=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(p){try{o=(C=(0,Rt.parseYaml)(p[1]))!=null?C:{}}catch(u){o={}}i=r.slice(p[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(S=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?S:this.notePath,c=t.createDiv({cls:"gantt-edit-header"}),h=c.createEl("a",{text:a,cls:"gantt-edit-title"});h.href="#",h.addEventListener("click",u=>{u.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let g=c.createDiv({cls:"gantt-edit-subtitle"});g.textContent=this.notePath;let b=t.createDiv({cls:"gantt-edit-form"}),x=u=>{let E=b.createDiv({cls:"gantt-edit-row"}),N=E.createDiv({cls:"gantt-edit-label"});N.textContent=u;let v=E.createDiv({cls:"gantt-edit-field"});return{row:E,field:v}},y=u=>{if(!u)return"";let N=String(u).match(/^(\d{4}-\d{2}-\d{2})/);return N?N[1]:""},m=u=>{if(u=u.trim(),!!u&&/^\d{4}-\d{2}-\d{2}$/.test(u))return u},w=null;if(this.startKey){let{field:u}=x(this.startKey+" (in\xEDcio)");w=u.createEl("input",{type:"date"}),w.value=y(o[this.startKey])}let T=null;if(this.endKey){let{field:u}=x(this.endKey+" (fim)");T=u.createEl("input",{type:"date"}),T.value=y(o[this.endKey])}let A=null;if(this.durationKey){let{field:u}=x(this.durationKey+" (minutos)");A=u.createEl("input",{type:"number"});let E=o[this.durationKey];A.value=E!=null?String(E):"",A.min="0",A.step="5"}let _=null;if(this.dueKey){let{field:u}=x(this.dueKey+" (due)");_=u.createEl("input",{type:"date"}),_.value=y(o[this.dueKey])}let M=t.createDiv({cls:"gantt-edit-buttons"}),z=M.createEl("button",{text:"Salvar",cls:"mod-cta"});M.createEl("button",{text:"Cancelar"}).addEventListener("click",u=>{u.preventDefault(),this.close()}),z.addEventListener("click",async u=>{if(u.preventDefault(),this.startKey&&w){let v=m(w.value);v?o[this.startKey]=v:delete o[this.startKey]}if(this.endKey&&T){let v=m(T.value);v?o[this.endKey]=v:delete o[this.endKey]}if(this.durationKey&&A){let v=A.value.trim();if(v==="")delete o[this.durationKey];else{let L=Number(v);Number.isNaN(L)||(o[this.durationKey]=L)}}if(this.dueKey&&_){let v=m(_.value);v?o[this.dueKey]=v:delete o[this.dueKey]}let N=`---
${(0,Rt.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(e,N),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(v){}if(this.refresh)try{this.refresh()}catch(v){}new Rt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ee(s,n,t,e){var ye,be,xe,ve,Se,we,Ae,Ee;let r=(ye=n.options)!=null?ye:{},o=r.background,i=(be=r.drilldown)!=null?be:!0,p=!0,a=l=>{if(l==null)return"";let P=String(l).trim();if(!P)return"";let F=P.match(/^\[\[(.+?)\]\]$/);F&&(P=F[1]);let O=P.lastIndexOf("/");return O>=0&&O<P.length-1&&(P=P.slice(O+1)),P};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(l=>l.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let c=t.rows.filter(l=>l.start&&l.end);if(c.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let h=n.encoding,g=h.group,b=h.duration,x=(l,P)=>{if(!l||!P)return;let F=l[P];return Array.isArray(F)?F[0]:F},m=c.map(l=>{var xt,ct;let P=l.start,F=l.end,O=l.props,It=typeof l.x=="string"?l.x:l.x instanceof Date?Bt(P):String(l.x),At=a(It),bt,Ft=g?x(O,g):void 0;Ft!=null?bt=String(Ft):l.series!=null?bt=String(l.series):bt=At;let ft=(xt=l.notes)==null?void 0:xt[0],Et=ft?(ct=ft.replace(/\.md$/i,"").split("/").pop())!=null?ct:ft:At,Nt=l.due,_t,Mt=x(O,b);if(Mt!=null){let vt=Number(Mt);Number.isNaN(vt)||(_t=vt)}return{row:l,start:P,end:F,props:O,fullName:At,groupKey:bt,notePath:ft,noteTitle:Et,due:Nt,estMinutes:_t}}).filter(l=>l.start instanceof Date&&!isNaN(l.start.getTime())&&l.end instanceof Date&&!isNaN(l.end.getTime()));if(m.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}m.sort((l,P)=>{if(l.groupKey<P.groupKey)return-1;if(l.groupKey>P.groupKey)return 1;let F=l.start.getTime(),O=P.start.getTime();return F!==O?F-O:l.fullName.localeCompare(P.fullName)});let w=26,T=0,A=null;for(let l of m)l.groupKey!==A&&(A=l.groupKey,T+=1),T+=1;let _=Math.min(...m.map(l=>l.start.getTime())),M=Math.max(...m.map(l=>l.end.getTime()));if(!isFinite(_)||!isFinite(M)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let z=24*60*60*1e3,$=l=>{let P=new Date(l);return P.setHours(0,0,0,0),P.getTime()},C=$(_),S=$(M),u=s.querySelector(".prop-charts-title-row");u||(u=s.createDiv({cls:"prop-charts-title-row"}));let E=s.dataset.ganttZoomMode||String((xe=r.zoomMode)!=null?xe:"100");s.dataset.ganttZoomMode=E;let N=s.dataset.ganttLabelMode||String((ve=r.labelMode)!=null?ve:"compact");s.dataset.ganttLabelMode=N;let v=u.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(l=>{let P=v.createEl("button",{cls:"gantt-zoom-btn",text:l.label});l.id===E&&P.addClass("is-active"),P.addEventListener("click",F=>{F.preventDefault(),s.dataset.ganttZoomMode=l.id,ee(s,n,t,e)})}),v.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",l=>{l.preventDefault();let P=s.querySelector(".chart-notes-zoom-button");P&&P.click()});let nt=Number(r.labelWidth),B=!Number.isNaN(nt)&&nt>120?nt:260,Q=N==="wide"?B+160:B,j=s.getBoundingClientRect().width||600,tt=Math.max(j,820),I;if(E==="fit")I=j;else{let l=Number(E)/100||1;I=tt*l}let{inner:d,svg:f,tooltip:D,details:R}=wt(s,o);d.style.width=I+"px";let k=(l,P,F,O,It,At,bt,Ft,ft)=>{if(!l)return;let Et=Math.max(40,O-8),_t=Math.max(8,Math.floor(Et/6)),Mt=l.split(/\s+/),xt=[],ct="";for(let Tt of Mt){if(!ct){ct=Tt;continue}(ct+" "+Tt).length<=_t?ct+=" "+Tt:(xt.push(ct),ct=Tt)}ct&&xt.push(ct);let vt=It+2,zt=xt.length*vt,Wt=F-zt/2+It;xt.forEach((Tt,Ot)=>{let ot=document.createElementNS(f.namespaceURI,"text");ot.setAttribute("x",String(P)),ot.setAttribute("y",String(Wt+Ot*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Tt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),ft&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>ft(rt))),f.appendChild(ot)})},Z=28,G=28,st=10,Y=Math.max(300,Z+G+T*w+24);f.setAttribute("height",String(Y));let W=I-Q-st,K=Z+6;f.style.color="#111111";let J=S+z-C||1,at=C-J*.02,ht=S+z+J*.08,lt=l=>Q+(l-at)/(ht-at)*W,H=(ht-at)/z,kt=Math.max(4,Math.min(12,Math.floor(W/90)||4)),dt=H/kt,q=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=q[q.length-1];for(let l of q)if(l>=dt){pt=l;break}let Gt=[],Be=$(at);for(let l=Be;l<=ht+.5*z;l+=pt*z)Gt.push(l);let Qt=document.createElementNS(f.namespaceURI,"line");Qt.setAttribute("x1",String(Q)),Qt.setAttribute("y1",String(K)),Qt.setAttribute("x2",String(I-st)),Qt.setAttribute("y2",String(K)),Qt.setAttribute("stroke","#111111"),f.appendChild(Qt);for(let l of Gt){let P=lt(l),F=document.createElementNS(f.namespaceURI,"line");F.setAttribute("x1",String(P)),F.setAttribute("y1",String(K)),F.setAttribute("x2",String(P)),F.setAttribute("y2",String(Y-G)),F.setAttribute("stroke","#111111"),F.setAttribute("stroke-opacity","0.20"),F.setAttribute("stroke-dasharray","2,4"),f.appendChild(F);let O=document.createElementNS(f.namespaceURI,"text");O.setAttribute("x",String(P)),O.setAttribute("y",String(K-4)),O.setAttribute("text-anchor","middle"),O.setAttribute("font-size","10"),O.setAttribute("fill","#111111"),O.textContent=Bt(new Date(l)),f.appendChild(O)}let ge=new Date;ge.setHours(0,0,0,0);let oe=ge.getTime();if(oe>=at&&oe<=ht){let l=lt(oe),P=document.createElementNS(f.namespaceURI,"line");P.setAttribute("x1",String(l)),P.setAttribute("y1",String(K)),P.setAttribute("x2",String(l)),P.setAttribute("y2",String(Y-G)),P.setAttribute("stroke","#4caf50"),P.setAttribute("stroke-width","2"),P.setAttribute("stroke-dasharray","4,2"),f.appendChild(P);let F=document.createElementNS(f.namespaceURI,"text");F.setAttribute("x",String(l+4)),F.setAttribute("y",String(K+12)),F.setAttribute("font-size","10"),F.setAttribute("fill","#4caf50"),F.textContent="hoje",f.appendChild(F)}let Ut=d.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ut.setAttr("title",N==="wide"?"Compactar nomes":"Expandir nomes"),Ut.style.left=`${Q}px`,Ut.style.top="4px",Ut.addEventListener("click",l=>{l.preventDefault();let F=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=F,ee(s,n,t,e)});let Ve=["status","priority"],ie=Array.isArray(r.tooltipFields)?r.tooltipFields.map(l=>String(l)):null,Ge=ie&&ie.length?ie:Ve,Ht=0,ae=null;for(let l of m){let P=l.start,F=l.end,O=(F.getTime()-P.getTime())/6e4,It=l.props,At=l.notePath,bt=l.noteTitle,Ft=(we=(Se=l.row.notes)==null?void 0:Se.length)!=null?we:0,ft=l.due,Et=l.estMinutes,Nt=[];Nt.push(`${Bt(P)} \u2192 ${Bt(F)}`),typeof Et=="number"&&!Number.isNaN(Et)?Nt.push(`est: ${Math.round(Et)} min`):O>0&&Nt.push(`dura\xE7\xE3o: ${Math.round(O)} min`),ft instanceof Date&&Nt.push(`due: ${Bt(ft)}`);for(let et of Ge){let U=x(It,et);U!=null&&String(U).trim()!==""&&Nt.push(`${et}: ${String(U)}`)}let _t=Nt.join("<br>"),Mt=et=>{var U;et.preventDefault(),p&&At?new pe(At,n,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(s,R,bt,Et!=null?Et:O,(U=l.row.notes)!=null?U:[],i)},xt=et=>{bt&&_t&&mt(s,D,bt,_t,Ft,et)},ct=()=>gt(D);if(l.groupKey!==ae){ae=l.groupKey;let et=K+8+Ht*w+w/2,U=a(ae);k(U,4,et,Q-12,11,"600"),Ht+=1}let vt=K+8+Ht*w,zt=w-10,Wt=lt(P.getTime()),Tt=lt(F.getTime()),Ot=Math.max(4,Tt-Wt),ot=l.fullName,rt=document.createElementNS(f.namespaceURI,"rect");rt.setAttribute("x",String(Wt)),rt.setAttribute("y",String(vt)),rt.setAttribute("width",String(Ot)),rt.setAttribute("height",String(zt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=l.row.series)!=null?Ae:ot,Ht)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=p&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",ct),rt.addEventListener("click",Mt),f.appendChild(rt);let De=vt+zt/2;if(Ot>=6){let et=it((Ee=l.row.series)!=null?Ee:ot,Ht),U=document.createElementNS(f.namespaceURI,"circle");U.setAttribute("cx",String(Wt)),U.setAttribute("cy",String(De)),U.setAttribute("r","3.5"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",et),U.setAttribute("stroke-width","1.5"),f.appendChild(U);let Lt=document.createElementNS(f.namespaceURI,"circle");Lt.setAttribute("cx",String(Tt)),Lt.setAttribute("cy",String(De)),Lt.setAttribute("r","3.5"),Lt.setAttribute("fill","#ffffff"),Lt.setAttribute("stroke",et),Lt.setAttribute("stroke-width","1.5"),f.appendChild(Lt)}let Re=vt+zt/2+2,Yt=g?16:4;if(N==="wide")k(ot,Yt,Re,Q-Yt-4,11,null,xt,ct,Mt);else{let et=ot,U=Math.max(40,Q-Yt-8),Ce=Math.max(8,Math.floor(U/6));et.length>Ce&&(et=et.slice(0,Ce-1)+"\u2026");let St=document.createElementNS(f.namespaceURI,"text");St.setAttribute("x",String(Yt)),St.setAttribute("y",String(Re)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=et,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",ct),St.addEventListener("click",Mt),f.appendChild(St)}if(ft instanceof Date){let et=lt(ft.getTime()),U=document.createElementNS(f.namespaceURI,"line");U.setAttribute("x1",String(et)),U.setAttribute("y1",String(vt)),U.setAttribute("x2",String(et)),U.setAttribute("y2",String(vt+zt)),U.setAttribute("stroke","#ff6b6b"),U.setAttribute("stroke-width","2"),U.setAttribute("stroke-dasharray","4,2"),f.appendChild(U)}Ht+=1}if(p){let l=s.createDiv({cls:"prop-charts-empty"});l.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function he(s,n,t){var Q,j,tt,I;let e=(Q=n.options)!=null?Q:{},r=e.background,o=(j=e.drilldown)!=null?j:!0,i=(tt=t.rows)!=null?tt:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:c,details:h}=wt(s,r),g=s.getBoundingClientRect().width||600,b=Math.max(g,480);p.style.width=b+"px";let x=40,y=16,m=18,w=28,T=300;a.setAttribute("height",String(T));let A=b-x-y,_=T-m-w,M=new Map;for(let d of i){let f=String(d.x),D=(I=M.get(f))!=null?I:{label:d.x,rows:[]};D.rows.push(d),M.set(f,D)}let $=Array.from(M.keys()).sort((d,f)=>d<f?-1:d>f?1:0).map(d=>M.get(d)),C=$.length,S=new Set;i.forEach(d=>{d.series!=null&&S.add(String(d.series))});let u=Array.from(S),E=u.length>1,N=E?"grouped":"single",v=0;i.forEach(d=>{d.y>v&&(v=d.y)}),(!isFinite(v)||v<=0)&&(v=1);let L=d=>m+_-d/(v||1)*_,V=L(0),nt=4;for(let d=0;d<=nt;d++){let f=v*d/nt,D=L(f),R=document.createElementNS(a.namespaceURI,"line");R.setAttribute("x1",String(x)),R.setAttribute("y1",String(D)),R.setAttribute("x2",String(b-y)),R.setAttribute("y2",String(D)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),a.appendChild(R);let k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(x-4)),k.setAttribute("y",String(D+3)),k.setAttribute("text-anchor","end"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=String(Math.round(f)),a.appendChild(k)}let B=C>0?A/C:A;if($.forEach((d,f)=>{let D=x+B*(f+.5),R=String(d.label),k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(D)),k.setAttribute("y",String(T-w+12)),k.setAttribute("text-anchor","middle"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=R,a.appendChild(k)}),E){let d=s.createDiv({cls:"chart-notes-legend"});u.forEach((f,D)=>{let R=d.createDiv({cls:"chart-notes-legend-item"}),k=R.createDiv();k.style.width="10px",k.style.height="10px",k.style.borderRadius="999px",k.style.backgroundColor=it(f,D),R.createSpan({text:f})})}$.forEach((d,f)=>{let D=x+B*(f+.5),R=d.rows;if(N==="single"){let Y=R[0],W=Y.y,K=B*.6,J=D-K/2,at=L(W),ht=Math.max(2,V-at),lt=it("bar",f),H=document.createElementNS(a.namespaceURI,"rect");H.setAttribute("x",String(J)),H.setAttribute("y",String(at)),H.setAttribute("width",String(K)),H.setAttribute("height",String(ht)),H.setAttribute("fill",lt),H.setAttribute("stroke","rgba(0,0,0,0.25)"),H.setAttribute("stroke-width","0.5"),H.style.cursor="pointer";let X=String(d.label),kt=`valor: ${Math.round(W*100)/100}`;H.addEventListener("mouseenter",dt=>{var q,pt;return mt(s,c,X,kt,(pt=(q=Y.notes)==null?void 0:q.length)!=null?pt:0,dt)}),H.addEventListener("mouseleave",()=>gt(c)),H.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(s,h,X,W,(q=Y.notes)!=null?q:[],o)}),a.appendChild(H);return}let k=u.length,Z=B/Math.max(k+1,2),G=k*Z,st=D-G/2;u.forEach((Y,W)=>{let K=R.find(q=>(q.series!=null?String(q.series):"")===Y);if(!K)return;let J=K.y,at=st+W*Z,ht=L(J),lt=Math.max(2,V-ht),H=it(Y,W),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(at)),X.setAttribute("y",String(ht)),X.setAttribute("width",String(Z)),X.setAttribute("height",String(lt)),X.setAttribute("fill",H),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let kt=`${Y} @ ${String(d.label)}`,dt=`valor: ${Math.round(J*100)/100}`;X.addEventListener("mouseenter",q=>{var pt,Gt;return mt(s,c,kt,dt,(Gt=(pt=K.notes)==null?void 0:pt.length)!=null?Gt:0,q)}),X.addEventListener("mouseleave",()=>gt(c)),X.addEventListener("click",q=>{var pt;q.preventDefault(),yt(s,h,kt,J,(pt=K.notes)!=null?pt:[],o)}),a.appendChild(X)})})}function $e(s,n,t){var B,Q,j,tt;let e=(B=n.options)!=null?B:{},r=e.background,o=(Q=e.drilldown)!=null?Q:!0,i=(j=t.rows)!=null?j:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:c,details:h}=wt(s,r),g=s.getBoundingClientRect().width||600,b=Math.max(g,480);p.style.width=b+"px";let x=40,y=16,m=18,w=28,T=300;a.setAttribute("height",String(T));let A=b-x-y,_=T-m-w,M=new Map;for(let I of i){let d=String(I.x),f=(tt=M.get(d))!=null?tt:{label:I.x,rows:[]};f.rows.push(I),M.set(d,f)}let $=Array.from(M.keys()).sort((I,d)=>I<d?-1:I>d?1:0).map(I=>M.get(I)),C=$.length,S=new Set;i.forEach(I=>{I.series!=null&&S.add(String(I.series))});let u=Array.from(S);if(!u.length){he(s,n,t);return}let E=0;$.forEach(I=>{let d=I.rows.reduce((f,D)=>f+D.y,0);d>E&&(E=d)}),(!isFinite(E)||E<=0)&&(E=1);let N=I=>m+_-I/(E||1)*_,v=N(0),L=4;for(let I=0;I<=L;I++){let d=E*I/L,f=N(d),D=document.createElementNS(a.namespaceURI,"line");D.setAttribute("x1",String(x)),D.setAttribute("y1",String(f)),D.setAttribute("x2",String(b-y)),D.setAttribute("y2",String(f)),D.setAttribute("stroke","#cccccc"),D.setAttribute("stroke-opacity","0.25"),a.appendChild(D);let R=document.createElementNS(a.namespaceURI,"text");R.setAttribute("x",String(x-4)),R.setAttribute("y",String(f+3)),R.setAttribute("text-anchor","end"),R.setAttribute("font-size","10"),R.setAttribute("fill","#111111"),R.textContent=String(Math.round(d)),a.appendChild(R)}let V=C>0?A/C:A;$.forEach((I,d)=>{let f=x+V*(d+.5),D=String(I.label),R=document.createElementNS(a.namespaceURI,"text");R.setAttribute("x",String(f)),R.setAttribute("y",String(T-w+12)),R.setAttribute("text-anchor","middle"),R.setAttribute("font-size","10"),R.setAttribute("fill","#111111"),R.textContent=D,a.appendChild(R)});let nt=s.createDiv({cls:"chart-notes-legend"});u.forEach((I,d)=>{let f=nt.createDiv({cls:"chart-notes-legend-item"}),D=f.createDiv();D.style.width="10px",D.style.height="10px",D.style.borderRadius="999px",D.style.backgroundColor=it(I,d),f.createSpan({text:I})}),$.forEach((I,d)=>{let f=x+V*(d+.5),D=V*.6,R=f-D/2,k=0;u.forEach((Z,G)=>{let st=I.rows.find(dt=>(dt.series!=null?String(dt.series):"")===Z);if(!st)return;let Y=st.y,W=k,K=k+Y;k=K;let J=N(W),at=N(K),ht=Math.max(2,J-at),lt=it(Z,G),H=document.createElementNS(a.namespaceURI,"rect");H.setAttribute("x",String(R)),H.setAttribute("y",String(at)),H.setAttribute("width",String(D)),H.setAttribute("height",String(ht)),H.setAttribute("fill",lt),H.setAttribute("stroke","rgba(0,0,0,0.25)"),H.setAttribute("stroke-width","0.5"),H.style.cursor="pointer";let X=`${Z} @ ${String(I.label)}`,kt=`valor: ${Math.round(Y*100)/100}`;H.addEventListener("mouseenter",dt=>{var q,pt;return mt(s,c,X,kt,(pt=(q=st.notes)==null?void 0:q.length)!=null?pt:0,dt)}),H.addEventListener("mouseleave",()=>gt(c)),H.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(s,h,X,Y,(q=st.notes)!=null?q:[],o)}),a.appendChild(H)})})}function fe(s,n,t,e){var Q,j,tt,I;let r=(Q=n.options)!=null?Q:{},o=r.background,i=(j=r.drilldown)!=null?j:!0,p=(tt=t.rows)!=null?tt:[];if(!p.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:c,tooltip:h,details:g}=wt(s,o),b=s.getBoundingClientRect().width||600,x=Math.max(b,480);a.style.width=x+"px";let y=40,m=16,w=18,T=24,A=300;c.setAttribute("height",String(A));let _=x-y-m,M=A-w-T,z=new Map;for(let d of p){let f=d.series!=null?String(d.series):"__default__",D=(I=z.get(f))!=null?I:[];D.push(d),z.set(f,D)}let $=Array.from(z.keys()),C=[],S=new Set;for(let d of p){let f=String(d.x);S.has(f)||(S.add(f),C.push(d.x))}let u=C.length||1,E=d=>{let f=String(d),D=C.findIndex(R=>String(R)===f);return D<0?y:u===1?y+_/2:y+D/(u-1)*_},N=d=>String(d),v=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY;for(let d of p)d.y<v&&(v=d.y),d.y>L&&(L=d.y);(!isFinite(v)||!isFinite(L))&&(v=0,L=1),v===L&&(v===0?L=1:v=0);let V=d=>w+M-(d-v)/(L-v||1)*M,nt=4;for(let d=0;d<=nt;d++){let f=v+(L-v)*d/nt,D=V(f),R=document.createElementNS(c.namespaceURI,"line");R.setAttribute("x1",String(y)),R.setAttribute("y1",String(D)),R.setAttribute("x2",String(x-m)),R.setAttribute("y2",String(D)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),c.appendChild(R);let k=document.createElementNS(c.namespaceURI,"text");k.setAttribute("x",String(y-4)),k.setAttribute("y",String(D+3)),k.setAttribute("text-anchor","end"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=Math.abs(f)>=100?String(Math.round(f)):String(Math.round(f*10)/10),c.appendChild(k)}let B=$.filter(d=>d!=="__default__");if(B.length>1){let d=s.createDiv({cls:"chart-notes-legend"});B.forEach((f,D)=>{let R=f,k=d.createDiv({cls:"chart-notes-legend-item"}),Z=k.createDiv();Z.style.width="10px",Z.style.height="10px",Z.style.borderRadius="999px",Z.style.backgroundColor=it(R,D),k.createSpan({text:R})})}$.forEach((d,f)=>{let D=z.get(d);if(!(D!=null&&D.length))return;let R=d==="__default__"?it("line",f):it(d,f),k=[...D].sort((G,st)=>{let Y=C.findIndex(K=>String(K)===String(G.x)),W=C.findIndex(K=>String(K)===String(st.x));return Y-W}),Z="";if(k.forEach((G,st)=>{let Y=E(G.x),W=V(G.y);Z+=(st===0?"M ":" L ")+Y+" "+W}),e){let G=k[0],st=k[k.length-1],Y=E(G.x),W=E(st.x),K=V(v);Z+=` L ${W} ${K} L ${Y} ${K} Z`;let J=document.createElementNS(c.namespaceURI,"path");J.setAttribute("d",Z),J.setAttribute("fill",R),J.setAttribute("fill-opacity","0.18"),J.setAttribute("stroke",R),J.setAttribute("stroke-width","1.5"),c.appendChild(J)}else{let G=document.createElementNS(c.namespaceURI,"path");G.setAttribute("d",Z),G.setAttribute("fill","none"),G.setAttribute("stroke",R),G.setAttribute("stroke-width","2"),c.appendChild(G)}k.forEach(G=>{let st=E(G.x),Y=V(G.y),W=document.createElementNS(c.namespaceURI,"circle");W.setAttribute("cx",String(st)),W.setAttribute("cy",String(Y)),W.setAttribute("r","3"),W.setAttribute("fill","#ffffff"),W.setAttribute("stroke",R),W.setAttribute("stroke-width","1.5"),W.style.cursor="pointer";let K=N(G.x),J=d==="__default__"?"":String(G.series),at=J?`${J} @ ${K}`:K,ht=`valor: ${Math.round(G.y*100)/100}`;W.addEventListener("mouseenter",lt=>{var H,X;return mt(s,h,at,ht,(X=(H=G.notes)==null?void 0:H.length)!=null?X:0,lt)}),W.addEventListener("mouseleave",()=>gt(h)),W.addEventListener("click",lt=>{var H;lt.preventDefault(),yt(s,g,at,G.y,(H=G.notes)!=null?H:[],i)}),c.appendChild(W)})})}function Qe(s,n,t){var _;let{background:e,drilldown:r=!0}=(_=n.options)!=null?_:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=_e(e)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:c,details:h}=wt(s,e),g=Math.max(i,420);p.style.width=g+"px",o&&(a.style.color=o);let b=300,x=g/2,y=(b-28+28)/2,m=Math.min(g/2-20,b/2-20),T=t.rows.map(M=>Math.max(0,M.y)).reduce((M,z)=>M+z,0)||1,A=-Math.PI/2;t.rows.forEach((M,z)=>{var B;let $=M.x instanceof Date?M.x.toISOString().slice(0,10):String(M.x),C=M.y,S=C/T*Math.PI*2,u=x+m*Math.cos(A),E=y+m*Math.sin(A),N=x+m*Math.cos(A+S),v=y+m*Math.sin(A+S),L=S>Math.PI?1:0,V=document.createElementNS(a.namespaceURI,"path"),nt=[`M ${x} ${y}`,`L ${u} ${E}`,`A ${m} ${m} 0 ${L} 1 ${N} ${v}`,"Z"].join(" ");V.setAttribute("d",nt),V.setAttribute("fill",it((B=M.series)!=null?B:$,z)),V.style.cursor="pointer",V.addEventListener("mouseenter",Q=>{var j,tt;return mt(s,c,$,C,(tt=(j=M.notes)==null?void 0:j.length)!=null?tt:0,Q)}),V.addEventListener("mouseleave",()=>gt(c)),V.addEventListener("click",()=>{var Q;return yt(s,h,$,C,(Q=M.notes)!=null?Q:[],r)}),a.appendChild(V),A+=S})}function He(s,n,t){var E;let{background:e,drilldown:r=!0}=(E=n.options)!=null?E:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=e?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:c,details:h}=wt(s,e),g=Math.max(i,700);p.style.width=g+"px",o&&(a.style.color=o);let b=300,x=g-48-10,y=b-28-28,m=t.rows.map(N=>{let v=N.x;if(v instanceof Date)return v.getTime();if(typeof v=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(v)){let V=new Date(v);if(!isNaN(V.getTime()))return V.getTime()}let L=Number(v);return isNaN(L)?null:L}return typeof v=="number"?v:null}),w=t.rows.map(N=>N.y),T=m.filter(N=>N!==null);if(T.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let A=Math.min(...T),_=Math.max(...T),M=Math.min(...w),z=Math.max(...w),$=N=>48+(N-A)/(_-A||1)*x,C=N=>b-28-(N-M)/(z-M||1)*y,S=document.createElementNS(a.namespaceURI,"line");S.setAttribute("x1",String(48)),S.setAttribute("y1",String(28)),S.setAttribute("x2",String(48)),S.setAttribute("y2",String(b-28)),S.setAttribute("stroke","currentColor"),a.appendChild(S);let u=document.createElementNS(a.namespaceURI,"line");u.setAttribute("x1",String(48)),u.setAttribute("y1",String(b-28)),u.setAttribute("x2",String(g-10)),u.setAttribute("y2",String(b-28)),u.setAttribute("stroke","currentColor"),a.appendChild(u),t.rows.forEach((N,v)=>{let L=m[v];if(L==null)return;let V=$(L),nt=C(w[v]),B=document.createElementNS(a.namespaceURI,"circle");B.setAttribute("cx",String(V)),B.setAttribute("cy",String(nt)),B.setAttribute("r","4"),B.setAttribute("fill",it(N.series,v)),B.style.cursor="pointer";let Q=N.x instanceof Date?N.x.toISOString().slice(0,10):typeof N.x=="string"?N.x:String(N.x);B.addEventListener("mouseenter",j=>{var tt,I;return mt(s,c,Q,N.y,(I=(tt=N.notes)==null?void 0:tt.length)!=null?I:0,j)}),B.addEventListener("mouseleave",()=>gt(c)),B.addEventListener("click",j=>{var tt;j.preventDefault(),yt(s,h,Q,N.y,(tt=N.notes)!=null?tt:[],r)}),a.appendChild(B)})}var ze=require("obsidian"),re=class{render(n,t,e,r,o=!1){var c;let{title:i}=(c=t.options)!=null?c:{};n.empty(),n.addClass("prop-charts-container");let a=n.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":he(n,t,e);break;case"stacked-bar":$e(n,t,e);break;case"line":fe(n,t,e,!1);break;case"area":fe(n,t,e,!0);break;case"pie":Qe(n,t,e);break;case"scatter":He(n,t,e);break;case"gantt":ee(n,t,e,r);break;default:n.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!o){let h=n.createEl("button",{cls:"chart-notes-zoom-button"});h.setAttr("type","button"),h.setAttr("aria-label","Expandir gr\xE1fico"),h.textContent="\u2922",h.addEventListener("click",g=>{g.preventDefault(),new me(t,e,this,r).open()})}}},me=class extends ze.Modal{constructor(t,e,r,o){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=r,this.ctx=o}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),r=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:r,cls:"chart-notes-zoom-title"});let o=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(c,h)=>{let g=o.createEl("button",{cls:"chart-notes-zoom-size-btn",text:c});(()=>{g.toggleClass("is-active",this.size===h)})(),g.addEventListener("click",x=>{x.preventDefault(),this.size=h,this.applySize(),o.querySelectorAll(".chart-notes-zoom-size-btn").forEach(m=>m.classList.remove("is-active")),g.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let p=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(p,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",r="85vh";switch(this.size){case"small":e="60vw",r="55vh";break;case"medium":e="80vw",r="70vh";break;case"large":default:e="95vw",r="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=r,t.style.maxHeight=r}};var se=class extends Ct.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new jt(this.app),await this.indexer.buildIndex(),this.query=new te(()=>this.indexer.getAll(),[]),this.renderer=new re,this.registerEvent(this.app.vault.on("modify",async e=>{e instanceof Ct.TFile&&await this.indexer.updateFile(e)})),this.registerEvent(this.app.vault.on("create",async e=>{e instanceof Ct.TFile&&await this.indexer.updateFile(e)})),this.registerEvent(this.app.vault.on("delete",async e=>{e instanceof Ct.TFile&&this.indexer.removeFile(e)})),this.registerMarkdownCodeBlockProcessor("chart",async(e,r,o)=>{var g;let i;try{let b=(0,Ct.parseYaml)(e);if(!b||typeof b!="object"){r.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}i=b}catch(b){r.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+(b==null?void 0:b.message)});return}if(!i.type){r.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let p=i.type==="gantt",a=i.type==="table";if(!p&&!a){if(!i.encoding||!i.encoding.x){r.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let x=((g=i.aggregate)==null?void 0:g.y)==="count";if(!i.encoding.y&&!x){r.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}i.encoding||(i.encoding={}),i.source||(i.source={});let h;try{h=this.query.run(i)}catch(b){r.createEl("div",{text:"Chart Notes: erro na query: "+(b==null?void 0:b.message)});return}this.renderer.render(r,i,h)});let t=this;typeof t.registerBasesView=="function"?(console.log("Chart Notes: registerBasesView dispon\xEDvel, registrando view do Bases."),t.registerBasesView(ce,{name:"Chart Notes",icon:"lucide-chart-area",factory:(e,r)=>new Xt(e,r,this.renderer),options:()=>[{type:"dropdown",key:"chartType",displayName:"Tipo do gr\xE1fico",default:"bar",options:{bar:"Barra","stacked-bar":"Barra empilhada",line:"Linha",area:"\xC1rea",pie:"Pizza",scatter:"Dispers\xE3o",gantt:"Gantt"}},{type:"text",key:"title",displayName:"T\xEDtulo (opcional)",placeholder:"(vazio = usa nome da view)"},{type:"property",key:"xProperty",displayName:"Propriedade X / label"},{type:"property",key:"yProperty",displayName:"Propriedade Y / valor (vazio = contagem)"},{type:"property",key:"seriesProperty",displayName:"S\xE9rie (opcional, gera legenda / cores)"},{type:"property",key:"startProperty",displayName:"In\xEDcio (Gantt)"},{type:"property",key:"endProperty",displayName:"Fim (Gantt)"},{type:"property",key:"dueProperty",displayName:"Due date (Gantt, opcional)"},{type:"property",key:"durationProperty",displayName:"Dura\xE7\xE3o em minutos (Gantt, opcional)"},{type:"property",key:"groupProperty",displayName:"Grupo / lane (Gantt / s\xE9ries, opcional)"},{type:"toggle",key:"drilldown",displayName:"Drilldown (clicar abre lista de notas)",default:!0},{type:"text",key:"background",displayName:"Cor de fundo (ex: #ffffff, opcional)",placeholder:"#ffffff"},{type:"multitext",key:"tooltipFields",displayName:"Campos extras no tooltip (ex: status,priority)",default:[]}]})):(console.warn("Chart Notes: registerBasesView n\xE3o existe nesta vers\xE3o do Obsidian. Integra\xE7\xE3o com Bases desabilitada."),new Ct.Notice("Chart Notes: sua vers\xE3o do Obsidian ainda n\xE3o exp\xF5e a API do Bases. A integra\xE7\xE3o com Bases ficar\xE1 desabilitada at\xE9 uma atualiza\xE7\xE3o futura."))}onunload(){console.log("Chart Notes: unloading plugin")}};
