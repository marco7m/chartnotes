/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ue=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var Ye=Object.getOwnPropertyNames;var Oe=Object.prototype.hasOwnProperty;var Xe=(s,e)=>{for(var t in e)ue(s,t,{get:e[t],enumerable:!0})},ze=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ye(e))!Oe.call(s,r)&&r!==t&&ue(s,r,{get:()=>e[r],enumerable:!(n=We(e,r))||n.enumerable});return s};var qe=s=>ze(ue({},"__esModule",{value:!0}),s);var fn={};Xe(fn,{default:()=>ae});module.exports=qe(fn);var Vt=require("obsidian");var Jt=require("obsidian"),de="chartnotes-view",je=["bar","stacked-bar","line","area","pie","scatter","gantt"];function Ze(s){let e=String(s!=null?s:"bar").trim().toLowerCase();return je.includes(e)?e:"bar"}var Je=["sum","count","cumulative-sum"];function tn(s){let e=String(s!=null?s:"sum").trim().toLowerCase();return Je.includes(e)?e:"sum"}var en=["auto","none","day","week","month","quarter","year"];function nn(s){let e=String(s!=null?s:"auto").trim().toLowerCase();return en.includes(e)?e:"auto"}var jt="(missing)",Zt=class extends Jt.BasesView{constructor(t,n,r){super(t);this.type=de;this.renderer=r,this.rootEl=n.createDiv("chartnotes-bases-view")}onDataUpdated(){var $,Y,Z;this.rootEl.empty();let t=this.data,n=($=t==null?void 0:t.groupedData)!=null?$:[];if(!n.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,o=Ze((Y=r==null?void 0:r.get("chartType"))!=null?Y:"bar"),i=o==="pie",d=o==="scatter",a=o==="gantt",l=tn(r==null?void 0:r.get("aggregateMode")),A=l==="cumulative-sum"&&!(o==="line"||o==="area")?"sum":l,y=nn(r==null?void 0:r.get("xBucket")),g=i||d||a?"none":y,h=this.getPropFromConfig("xProperty"),k=this.getPropFromConfig("ganttLabelProperty"),R=this.getPropFromConfig("yProperty"),f=this.getPropFromConfig("seriesProperty");i&&(f={id:null,name:null});let N=this.getPropFromConfig("startProperty"),M=this.getPropFromConfig("endProperty"),D=this.getPropFromConfig("dueProperty"),K=this.getPropFromConfig("durationProperty"),H=this.getPropFromConfig("groupProperty");if(!a&&!h.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(d&&(!h.id||!R.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(N.id||M.id||D.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Due with Duration."});return}let x=a&&k.id?k:a?h:{id:null,name:null},E;if(a)E=this.buildRowsForGantt(n,x,f,N,M,D,K,H);else if(d)E=this.buildRowsForScatter(n,h,R,f);else{let m=i;E=this.buildRowsForAggregatedCharts(n,h,R,f,A,g,m)}if(!E.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let c={rows:E},v=((Z=r==null?void 0:r.get("title"))!=null?Z:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",w=r==null?void 0:r.get("drilldown"),F=typeof w=="boolean"?w:!0,U=this.buildEncoding({x:h,y:R,series:f,start:N,end:M,due:D,duration:K,group:H,label:x,aggMode:A,xBucket:g,chartType:o}),O={type:o,source:{type:"properties",query:""},encoding:U,options:{title:v,drilldown:F}},_={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,O,c,_)}getPropFromConfig(t){var d,a;let n=this.config,r=(d=n==null?void 0:n.get)==null?void 0:d.call(n,t);if(!r)return{id:null,name:null};let o=r.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let l=(0,Jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,n){if(!n.id)return null;let r;try{r=t.getValue(n.id)}catch(o){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=new Date(t.trim());return Number.isNaN(n.getTime())?null:n}compareX(t,n){let r=this.parseDate(t!=null?String(t):null),o=this.parseDate(n!=null?String(n):null);if(r&&o)return r.getTime()-o.getTime();let i=Number(t),d=Number(n);return!Number.isNaN(i)&&!Number.isNaN(d)?i-d:String(t!=null?t:"").localeCompare(String(n!=null?n:""))}fmtDate(t){let n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${o}`}startOfWeek(t){let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(n.getDay()+6)%7;return n.setDate(n.getDate()-r),n.setHours(0,0,0,0),n}bucketX(t,n){let r=this.parseDate(t);if(!r)return t;switch(n){case"none":return t;case"auto":case"day":return this.fmtDate(new Date(r.getFullYear(),r.getMonth(),r.getDate()));case"week":{let o=this.startOfWeek(r);return`${this.fmtDate(o)} (W)`}case"month":{let o=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${o}`}case"quarter":{let o=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${o}`}case"year":return`${r.getFullYear()}`;default:return t}}getXValuesForEntry(t,n,r,o){var S,A;let i=[],d=y=>this.bucketX(y,r);if(!n.id){let y=t.file,g=y!=null&&y.name?String(y.name):String((S=y==null?void 0:y.path)!=null?S:jt);return i.push(d(g)),i}if(!o){let y=(A=this.readValue(t,n))!=null?A:jt;return i.push(d(y)),i}let a=null;try{a=t.getValue(n.id)}catch(y){a=null}let l=y=>{if(!y)return;let g=String(y).trim();g&&i.push(d(g))};if(a==null)l(jt);else if(typeof a=="string"){let y=a.trim();if(y){let g=y.split(/\s+/);for(let h of g)l(h)}}else if(Array.isArray(a))for(let y of a){if(y==null)continue;let g;try{g=y.toString()}catch(h){continue}l(g)}else if(typeof a.toArray=="function"){let y=a.toArray();if(Array.isArray(y))for(let g of y){if(g==null)continue;let h;try{h=g.toString()}catch(k){continue}l(h)}else{let g;try{g=a.toString()}catch(h){g=""}l(g)}}else{let y;try{y=a.toString()}catch(g){y=""}l(y)}return i.length||l(jt),i}buildRowsForAggregatedCharts(t,n,r,o,i,d,a){let l=new Map,S=a||i==="count"||!r.id&&i!=="sum",A=r.name||"y";for(let g of t)for(let h of g.entries){let k=h.file,R=this.getXValuesForEntry(h,n,d,a),f=1,N=null;if(!S&&r.id){if(N=this.readValue(h,r),N==null)continue;let K=Number(N);if(Number.isNaN(K))continue;f=K}else f=1;let M=this.readValue(h,o),D=M!=null?String(M):void 0;for(let K of R){let H=`${K}@@${D!=null?D:""}`,x=l.get(H);x||(x={x:K,y:0,series:D,notes:[],props:{}},l.set(H,x)),x.y+=f,k!=null&&k.path&&x.notes.push(k.path),x.props&&n.name&&(x.props[n.name]=K),!S&&x.props&&A&&N!=null&&(x.props[A]=x.y),S&&x.props&&(x.props[A]=x.y),x.props&&o.name&&M!=null&&(x.props[o.name]=M)}}let y=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(y):y}toCumulative(t){var o,i;let n=new Map;for(let d of t){let a=(o=d.series)!=null?o:"__no_series__",l=n.get(a);l||(l=[],n.set(a,l)),l.push(d)}let r=[];for(let[,d]of n){let a=[...d].sort((S,A)=>this.compareX(S.x,A.x)),l=0;for(let S of a){let A=Number((i=S.y)!=null?i:0);Number.isNaN(A)||(l+=A,r.push({...S,y:l}))}}return r}buildRowsForScatter(t,n,r,o){let i=[];for(let d of t)for(let a of d.entries){let l=a.file,S=this.readValue(a,n),A=this.readValue(a,r);if(S==null||A==null)continue;let y=Number(S),g=Number(A);if(Number.isNaN(y)||Number.isNaN(g))continue;let h=this.readValue(a,o),k=h!=null?String(h):void 0;i.push({x:y,y:g,series:k,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,n,r,o,i,d,a,l){var R;let S=[],g=f=>{let N=[f==null?void 0:f.label,f==null?void 0:f.name,f==null?void 0:f.value,f==null?void 0:f.key,f==null?void 0:f.group,f==null?void 0:f.groupLabel];for(let M of N)if(M!=null&&String(M).trim()!=="")return String(M);return""},h=n;try{let f=this.getPropFromConfig("ganttLabelProperty");f&&f.id&&(h=f)}catch(f){}let k=!!l.id;for(let f of t){let N=g(f);for(let M of(R=f.entries)!=null?R:[]){let D=M.file,K=this.readValue(M,o),H=this.readValue(M,i),x=this.readValue(M,d),E=this.readValue(M,a),c=E!=null?Number(E):NaN,P=Number.isFinite(c)&&c>0,v=P?c*6e4:36e5,w=this.parseDate(K),F=this.parseDate(H),U=this.parseDate(x),O=w,_=F;if(O&&!_&&(_=new Date(O.getTime()+v)),!O&&_&&(O=new Date(_.getTime()-v)),!O&&!_&&U&&(P?(_=U,O=new Date(U.getTime()-v)):(O=U,_=new Date(U.getTime()+36e5))),!O||!_)continue;if(O.getTime()>_.getTime()){let T=O;O=_,_=T}let $=this.readValue(M,h);($==null||String($).trim()==="")&&(D!=null&&D.name?$=String(D.name).replace(/\.md$/i,""):D!=null&&D.path?$=String(D.path):$="(sem t\xEDtulo)");let Y=this.readValue(M,r),Z=Y!=null?String(Y):void 0,m={};if(N&&(m.__basesGroup=N),k){let T=this.readValue(M,l);T!=null&&l.name&&(m[l.name]=T)}h.name&&(m[h.name]=$),m.label=$,o.name&&K!=null&&(m[o.name]=K),i.name&&H!=null&&(m[i.name]=H),d.name&&x!=null&&(m[d.name]=x),P&&a.name&&(m[a.name]=c);let b=D==null?void 0:D.path;S.push({x:$,y:0,series:Z,start:O,end:_,due:U!=null?U:void 0,notes:b?[b]:[],props:m})}}return S.sort((f,N)=>!f.start||!N.start?0:f.start.getTime()-N.start.getTime()),S}buildEncoding(t){var d,a,l,S,A,y,g,h,k,R,f;let n=(d=t.x.name)!=null?d:"x",r=(a=t.y.name)!=null?a:"y",o=(A=(S=(l=t.label.name)!=null?l:t.x.name)!=null?S:t.group.name)!=null?A:"label",i=t.chartType==="gantt"?"__basesGroup":(y=t.group.name)!=null?y:"group";return{x:n,y:r,series:(g=t.series.name)!=null?g:"series",start:(h=t.start.name)!=null?h:"start",end:(k=t.end.name)!=null?k:"end",due:(R=t.due.name)!=null?R:"due",duration:(f=t.duration.name)!=null?f:"duration",group:i,label:o}}};var Re=require("obsidian"),te=class{constructor(e){this.index=new Map;this.app=e}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(e){if(e.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(e)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Re.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[d,a]of Object.entries(i))d!=="position"&&(t[d]=a)}let o=this.app.metadataCache.getFileCache(e);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",e.path,n)}this.index.set(e.path,{path:e.path,props:t})}removeFile(e){this.index.delete(e.path)}};function Le(s,e){if(!e||e.length===0)return!0;for(let t of e){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Ie(s,e){if(!e||e.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of e)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let n=String(t);for(let r of e)if(n===r||n==="#"+r)return!0;return!1}function ne(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function Ft(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,n,r]=s.split("-");return new Date(Number(t),Number(n)-1,Number(r),0,0,0,0)}let e=new Date(s);return isNaN(e.getTime())?null:e}function ht(s){let e=new Date(s);return e.setHours(0,0,0,0),e}function ee(s,e){let t=new Date(s);return t.setDate(t.getDate()-e),t}function rn(s,e){return ee(s,e*7)}function sn(s,e){let t=new Date(s);return t.setMonth(t.getMonth()-e),t}function me(s,e){let t=new Date(s);return t.setDate(t.getDate()+e),t}function on(s,e){return me(s,e*7)}function an(s,e){let t=new Date(s);return t.setMonth(t.getMonth()+e),t}function Me(s){let e=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(e)||e.endsWith("date")||e.endsWith("at")||e.endsWith("on"))}function Pe(s,e){let t=e?new Date(e):new Date,n=ht(t),r=s.trim().toLowerCase();if(r==="today")return n;if(r==="yesterday")return ht(ee(n,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ht(ee(n,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ht(ee(n,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ht(rn(n,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ht(sn(n,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ht(me(n,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ht(me(n,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ht(on(n,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ht(an(n,o))}return null}function _e(s){let e=s.trim(),t=e.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let S=t[1].trim(),A=t[2].trim(),y=t[3].trim(),g=Me(S),h=pe(A,g),k=pe(y,g),R=h.valueType==="date"||k.valueType==="date"?"date":h.valueType;return{field:S,op:"between",value:h.value,value2:k.value,valueType:R}}let n=/(==|!=|>=|<=|>|<)/,r=e.split(n);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),d=r[2].trim(),a=Me(o),l=pe(d,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function pe(s,e){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),r=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(e){if(t==="0"||n==="today")return{value:ht(new Date),valueType:"date"};let i=Pe(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Pe(t);if(i)return{value:i,valueType:"date"}}if(ne(t)){let i=Ft(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Fe(s,e){let t=s[e.field];if(t==null)return!1;if(e.valueType==="date"){let o=t instanceof Date?ht(t):ne(t)?ht(Ft(t)):null;if(!o)return!1;let i=e.value instanceof Date?e.value:null,d=e.value2 instanceof Date?e.value2:null;if(!i)return!1;let a=o.getTime(),l=ht(i).getTime();switch(e.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!d)return!1;let S=ht(d).getTime();return a>=l&&a<=S}}if(e.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(e.value);switch(e.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof e.value2!="number"?!1:o>=i&&o<=e.value2}}let n=String(t),r=String(e.value);switch(e.op){case"==":return n===r;case"!=":return n!==r;case">":return n>r;case">=":return n>=r;case"<":return n<r;case"<=":return n<=r;case"between":return!1}}function ln(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(ne(s)){let e=Ft(s);if(e)return{key:e,isDate:!0}}return{key:s,isDate:!1}}function cn(s,e){let t=s.x,n=e.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let r=String(t),o=String(n);return r<o?-1:r>o?1:0}function un(s,e){var o,i;let t=cn(s,e);if(t!==0)return t;let n=(o=s.series)!=null?o:"",r=(i=e.series)!=null?i:"";return n<r?-1:n>r?1:0}function dn(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let e=s.trim().match(/^(\d+)/);if(e){let t=Number(e[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function pn(s){var n,r;let e=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:"__no_series__",a=((r=e.get(i))!=null?r:0)+o.y;e.set(i,a),t.push({...o,y:a})}return t}function mn(s,e){var i,d;let t=dn(e);if(!t||t<=1)return[...s];let n=new Map,r=new Map,o=[];for(let a of s){let l=(i=a.series)!=null?i:"__no_series__",S=n.get(l);S||(S=[],n.set(l,S));let A=(d=r.get(l))!=null?d:0;if(S.push(a.y),A+=a.y,S.length>t){let h=S.shift();A-=h}r.set(l,A);let y=S.length||1,g=A/y;o.push({...a,y:g})}return o}var re=class{constructor(e,t){this.getIndex=e,this.defaultPaths=t}run(e){var i,d,a;let t=this.getIndex(),n=(i=e.source)!=null&&i.paths&&e.source.paths.length?e.source.paths:this.defaultPaths,r=(d=e.source)!=null&&d.tags&&e.source.tags.length?e.source.tags:[],o=[];for(let l of t){let S=n&&n.length?Le(l.path,n):!0,A=r&&r.length?Ie(l.props,r):!0;if(!S||!A)continue;let y=!0;if((a=e.source)!=null&&a.where&&e.source.where.length>0)for(let g of e.source.where){let h;try{h=_e(g)}catch(k){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${g} (${k.message})`)}if(!Fe(l.props,h)){y=!1;break}}y&&o.push(l)}return e.type==="gantt"?this.runGantt(e,o):e.type==="table"?this.runTable(e,o):this.runStandard(e,o)}runTable(e,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=e.encoding)==null?void 0:r.x,yField:(o=e.encoding)==null?void 0:o.y}}runGantt(e,t){var A,y,g;let n=(A=e.encoding)!=null?A:{},r=n.start,o=n.end,i=(y=n.label)!=null?y:n.x,d=n.series,a=n.duration,l=n.due,S=[];for(let h of t){let k=(g=h.props)!=null?g:{},R=x=>Array.isArray(x)?x[0]:x,f=null;if(o){let x=R(k[o]),E=Ft(x);E&&(f=E)}if(!f)continue;let N=null;if(r){let x=R(k[r]),E=Ft(x);E&&(N=E)}if(!N&&a){let x=R(k[a]),E=Number(x);Number.isNaN(E)||(N=new Date(f.getTime()-E*6e4))}N||(N=new Date(f.getTime()));let M;if(l){let x=R(k[l]),E=Ft(x);E&&(M=E)}let D;if(i){let x=R(k[i]);(x==null||x==="")&&(x=h.path),D=x}else D=h.path;let K;if(d){let x=R(k[d]);x!=null&&(K=String(x))}let H={x:D,y:0,notes:[h.path],series:K,start:N,end:f,props:k};M&&(H.due=M),S.push(H)}return S.sort((h,k)=>{let R=h.start?h.start.getTime():0,f=k.start?k.start.getTime():0;return R-f}),{rows:S,xField:i,yField:o}}runStandard(e,t){var h,k,R,f,N,M,D,K,H,x;let n=(h=e.encoding)==null?void 0:h.x,r=(k=e.encoding)==null?void 0:k.y,o=(R=e.encoding)==null?void 0:R.series;if(!n)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(f=e.aggregate)!=null?f:{},d=(N=i.y)!=null?N:null,a=!!i.cumulative,l=i.rolling;if(!r&&d!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let S=[];for(let E of t){let c=(M=E.props)!=null?M:{},P=$=>Array.isArray($)?$[0]:$,v=P(c[n]);if(v==null)continue;let w=ln(v),F=w.key,U=w.isDate,O;if(o){let $=P(c[o]);$!=null&&String($).trim()!==""&&(O=String($))}let _;if(d==="count")_=1;else{let $=P(c[r]);if($==null)continue;let Y=Number($);if(Number.isNaN(Y))continue;_=Y}S.push({x:F,y:_,notes:[E.path],series:O,props:c,_isDate:U,_origX:v})}if(S.length===0)return{rows:[],xField:n,yField:r};let A=[];if(d){let E=new Map;for(let c of S){let P=(D=c.series)!=null?D:"",v=c.x instanceof Date?c.x.toISOString().slice(0,10):String(c.x),w=P+"||"+v,F=(K=E.get(w))!=null?K:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:c.x,isDate:c._isDate,series:c.series,props:c.props};F.sum+=c.y,F.count+=1,c.y<F.min&&(F.min=c.y),c.y>F.max&&(F.max=c.y),F.notes.push(...c.notes),F.props=(H=c.props)!=null?H:F.props,E.set(w,F)}for(let[,c]of E){let P=c.sum;switch(d){case"sum":P=c.sum;break;case"avg":P=c.sum/c.count;break;case"min":P=c.min;break;case"max":P=c.max;break;case"count":P=c.count;break}A.push({x:c.xRep,y:P,notes:c.notes,series:c.series,props:c.props})}}else A=S.map(E=>({x:E.x,y:E.y,notes:E.notes,series:E.series,props:E.props}));if(A.length===0)return{rows:[],xField:n,yField:r};let y=((x=e.sort)==null?void 0:x.x)==="desc"?"desc":"asc";if(A.sort((E,c)=>{let P=un(E,c);return y==="asc"?P:-P}),(a||l)&&!(e.type==="line"||e.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let g=A;return l?g=mn(A,l):a&&(g=pn(A)),{rows:g,xField:n,yField:r}}};var Et=require("obsidian");var $e=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function ut(s,e){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,r)=>n*33+r.charCodeAt(0)>>>0,0);return $e[t%$e.length]}function wt(s,e){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,e&&(n.style.background=e);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let d=s.createDiv({cls:"chart-notes-details"});return d.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:d}}function gt(s,e,t,n,r,o){let i=s.getBoundingClientRect(),d=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);e.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${d}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,e.style.display="block";let a=e.getBoundingClientRect(),l=o.clientX-i.left+6,S=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),S+a.height>i.height-4&&(S=i.height-a.height-4),S<4&&(S=4),e.style.left=l+"px",e.style.top=S+"px"}function yt(s){s.style.display="none"}function bt(s,e,t,n,r,o){if(!o)return;if(e.empty(),!r||r.length===0){e.style.display="none";return}e.style.display="block";let i=e.createEl("div",{cls:"chart-notes-details-header"}),d=i.createEl("div",{cls:"chart-notes-details-title"});d.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{e.style.display="none"});let l=e.createEl("ul",{cls:"chart-notes-details-list"});for(let S of r){let y=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:S});y.href="#",y.addEventListener("click",g=>{g.preventDefault(),app.workspace.openLinkText(S,"",!1)})}}function Mt(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let e=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${e}/${t}`}function He(s){if(!s)return!1;let e=s.trim().toLowerCase();if(e==="#fff"||e==="#ffffff"||e==="white")return!0;if(!e.startsWith("#"))return!1;let t,n,r;if(e.length===4)t=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16),r=parseInt(e[3]+e[3],16);else if(e.length===7)t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*r)/255>.7}var he=class extends Et.Modal{constructor(t,n,r,o){var d;super(app);this.notePath=t,this.spec=n,this.refresh=r,this.reindexFile=o;let i=(d=n.encoding)!=null?d:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var x,E;let{contentEl:t}=this;t.empty();let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Et.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(n),o={},i=r,d=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(d){try{o=(x=(0,Et.parseYaml)(d[1]))!=null?x:{}}catch(c){o={}}i=r.slice(d[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(E=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?E:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),S=l.createEl("a",{text:a,cls:"gantt-edit-title"});S.href="#",S.addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let A=l.createDiv({cls:"gantt-edit-subtitle"});A.textContent=this.notePath;let y=t.createDiv({cls:"gantt-edit-form"}),g=c=>{let P=y.createDiv({cls:"gantt-edit-row"}),v=P.createDiv({cls:"gantt-edit-label"});v.textContent=c;let w=P.createDiv({cls:"gantt-edit-field"});return{row:P,field:w}},h=c=>{if(!c)return"";let v=String(c).match(/^(\d{4}-\d{2}-\d{2})/);return v?v[1]:""},k=c=>{if(c=c.trim(),!!c&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c},R=null;if(this.startKey){let{field:c}=g(this.startKey+" (in\xEDcio)");R=c.createEl("input",{type:"date"}),R.value=h(o[this.startKey])}let f=null;if(this.endKey){let{field:c}=g(this.endKey+" (fim)");f=c.createEl("input",{type:"date"}),f.value=h(o[this.endKey])}let N=null;if(this.durationKey){let{field:c}=g(this.durationKey+" (minutos)");N=c.createEl("input",{type:"number"});let P=o[this.durationKey];N.value=P!=null?String(P):"",N.min="0",N.step="5"}let M=null;if(this.dueKey){let{field:c}=g(this.dueKey+" (due)");M=c.createEl("input",{type:"date"}),M.value=h(o[this.dueKey])}let D=t.createDiv({cls:"gantt-edit-buttons"}),K=D.createEl("button",{text:"Salvar",cls:"mod-cta"});D.createEl("button",{text:"Cancelar"}).addEventListener("click",c=>{c.preventDefault(),this.close()}),K.addEventListener("click",async c=>{if(c.preventDefault(),this.startKey&&R){let w=k(R.value);w?o[this.startKey]=w:delete o[this.startKey]}if(this.endKey&&f){let w=k(f.value);w?o[this.endKey]=w:delete o[this.endKey]}if(this.durationKey&&N){let w=N.value.trim();if(w==="")delete o[this.durationKey];else{let F=Number(w);Number.isNaN(F)||(o[this.durationKey]=F)}}if(this.dueKey&&M){let w=k(M.value);w?o[this.dueKey]=w:delete o[this.dueKey]}let v=`---
${(0,Et.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,v),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(w){}if(this.refresh)try{this.refresh()}catch(w){}new Et.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function se(s,e,t,n){var Se,xe,ve,we,Ae,De,Ee,Te;let r=(Se=e.options)!=null?Se:{},o=r.background,i=(xe=r.drilldown)!=null?xe:!0,d=!0,a=u=>{if(u==null)return"";let I=String(u).trim();if(!I)return"";let Q=I.match(/^\[\[(.+?)\]\]$/);Q&&(I=Q[1]);let tt=I.lastIndexOf("/");return tt>=0&&tt<I.length-1&&(I=I.slice(tt+1)),I};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(u=>u.start&&u.end);if(l.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let S=e.encoding,A=S.group,y=S.duration,g=(u,I)=>{if(!u||!I)return;let Q=u[I];return Array.isArray(Q)?Q[0]:Q},h="__chartnotes_no_group__",R=l.map(u=>{var mt,xt;let I=u.start,Q=u.end,tt=u.props,_t=typeof u.x=="string"?u.x:u.x instanceof Date?Mt(I):String(u.x),Tt=a(_t),At=A!=null&&A!==""?g(tt,A):void 0,Ct=At!=null&&String(At).trim().length>0?String(At):h,ft=(mt=u.notes)==null?void 0:mt[0],kt=ft?(xt=ft.replace(/\.md$/i,"").split("/").pop())!=null?xt:ft:Tt,Gt=u.due,Lt,St=g(tt,y);if(St!=null){let Nt=Number(St);Number.isNaN(Nt)||(Lt=Nt)}return{row:u,start:I,end:Q,props:tt,fullName:Tt,groupKey:Ct,notePath:ft,noteTitle:kt,due:Gt,estMinutes:Lt}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(R.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}R.sort((u,I)=>{if(u.groupKey<I.groupKey)return-1;if(u.groupKey>I.groupKey)return 1;let Q=u.start.getTime(),tt=I.start.getTime();return Q!==tt?Q-tt:u.fullName.localeCompare(I.fullName)});let f=26,N=0,M=null;for(let u of R)u.groupKey!==M&&(M=u.groupKey,u.groupKey!==h&&(N+=1)),N+=1;let D=Math.min(...R.map(u=>u.start.getTime())),K=Math.max(...R.map(u=>u.end.getTime()));if(!isFinite(D)||!isFinite(K)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let H=24*60*60*1e3,x=u=>{let I=new Date(u);return I.setHours(0,0,0,0),I.getTime()},E=x(D),c=x(K),P=s.querySelector(".prop-charts-title-row");P||(P=s.createDiv({cls:"prop-charts-title-row"}));let v=s.dataset.ganttZoomMode||String((ve=r.zoomMode)!=null?ve:"100");s.dataset.ganttZoomMode=v;let w=s.dataset.ganttLabelMode||String((we=r.labelMode)!=null?we:"compact");s.dataset.ganttLabelMode=w;let F=P.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let I=F.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===v&&I.addClass("is-active"),I.addEventListener("click",Q=>{Q.preventDefault(),s.dataset.ganttZoomMode=u.id,se(s,e,t,n)})}),F.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let I=s.querySelector(".chart-notes-zoom-button");I&&I.click()});let _=Number(r.labelWidth),$=!Number.isNaN(_)&&_>120?_:260,Y=w==="wide"?$+160:$,Z=s.getBoundingClientRect().width||600,m=Math.max(Z,820),b;if(v==="fit")b=Z;else{let u=Number(v)/100||1;b=m*u}let{inner:T,svg:p,tooltip:C,details:L}=wt(s,o);T.style.width=b+"px";let G=(u,I,Q,tt,_t,Tt,At,Kt,Ct)=>{if(!u)return;let ft=Math.max(40,tt-8),Gt=Math.max(8,Math.floor(ft/6)),Lt=u.split(/\s+/),St=[],mt="";for(let Rt of Lt){if(!mt){mt=Rt;continue}(mt+" "+Rt).length<=Gt?mt+=" "+Rt:(St.push(mt),mt=Rt)}mt&&St.push(mt);let xt=_t+2,Nt=St.length*xt,Ut=Q-Nt/2+_t;St.forEach((Rt,zt)=>{let ct=document.createElementNS(p.namespaceURI,"text");ct.setAttribute("x",String(I)),ct.setAttribute("y",String(Ut+zt*xt)),ct.setAttribute("text-anchor","start"),ct.setAttribute("font-size",String(_t)),ct.setAttribute("fill","#111111"),Tt&&ct.setAttribute("font-weight",Tt),ct.textContent=Rt,At&&ct.addEventListener("mouseenter",at=>At(at)),Kt&&ct.addEventListener("mouseleave",()=>Kt()),Ct&&(ct.style.cursor="pointer",ct.addEventListener("click",at=>Ct(at))),p.appendChild(ct)})},st=28,z=28,W=10,nt=Math.max(300,st+z+N*f+24);p.setAttribute("height",String(nt));let q=b-Y-W,rt=st+6;p.style.color="#111111";let dt=c+H-E||1,ot=E-dt*.02,lt=c+H+dt*.08,V=u=>Y+(u-ot)/(lt-ot)*q,B=(lt-ot)/H,J=Math.max(4,Math.min(12,Math.floor(q/90)||4)),X=B/J,pt=[1,2,3,5,7,10,14,21,30,60,90,180,365],Qt=pt[pt.length-1];for(let u of pt)if(u>=X){Qt=u;break}let ye=[],Qe=x(ot);for(let u=Qe;u<=lt+.5*H;u+=Qt*H)ye.push(u);let $t=document.createElementNS(p.namespaceURI,"line");$t.setAttribute("x1",String(Y)),$t.setAttribute("y1",String(rt)),$t.setAttribute("x2",String(b-W)),$t.setAttribute("y2",String(rt)),$t.setAttribute("stroke","#111111"),p.appendChild($t);for(let u of ye){let I=V(u),Q=document.createElementNS(p.namespaceURI,"line");Q.setAttribute("x1",String(I)),Q.setAttribute("y1",String(rt)),Q.setAttribute("x2",String(I)),Q.setAttribute("y2",String(nt-z)),Q.setAttribute("stroke","#111111"),Q.setAttribute("stroke-opacity","0.20"),Q.setAttribute("stroke-dasharray","2,4"),p.appendChild(Q);let tt=document.createElementNS(p.namespaceURI,"text");tt.setAttribute("x",String(I)),tt.setAttribute("y",String(rt-4)),tt.setAttribute("text-anchor","middle"),tt.setAttribute("font-size","10"),tt.setAttribute("fill","#111111"),tt.textContent=Mt(new Date(u)),p.appendChild(tt)}let be=new Date;be.setHours(0,0,0,0);let le=be.getTime();if(le>=ot&&le<=lt){let u=V(le),I=document.createElementNS(p.namespaceURI,"line");I.setAttribute("x1",String(u)),I.setAttribute("y1",String(rt)),I.setAttribute("x2",String(u)),I.setAttribute("y2",String(nt-z)),I.setAttribute("stroke","#4caf50"),I.setAttribute("stroke-width","2"),I.setAttribute("stroke-dasharray","4,2"),p.appendChild(I);let Q=document.createElementNS(p.namespaceURI,"text");Q.setAttribute("x",String(u+4)),Q.setAttribute("y",String(rt+12)),Q.setAttribute("font-size","10"),Q.setAttribute("fill","#4caf50"),Q.textContent="hoje",p.appendChild(Q)}let Ot=T.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",w==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${Y}px`,Ot.style.top="4px",Ot.addEventListener("click",u=>{u.preventDefault();let Q=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=Q,se(s,e,t,n)});let Ke=["status","priority"],ce=Array.isArray(r.tooltipFields)?r.tooltipFields.map(u=>String(u)):null,Ue=ce&&ce.length?ce:Ke,Ht=0,Xt=null;for(let u of R){let I=u.start,Q=u.end,tt=(Q.getTime()-I.getTime())/6e4,_t=u.props,Tt=u.notePath,At=u.noteTitle,Kt=(De=(Ae=u.row.notes)==null?void 0:Ae.length)!=null?De:0,Ct=u.due,ft=u.estMinutes,kt=[];kt.push(`${Mt(I)} \u2192 ${Mt(Q)}`),typeof ft=="number"&&!Number.isNaN(ft)?kt.push(`est: ${Math.round(ft)} min`):tt>0&&kt.push(`dura\xE7\xE3o: ${Math.round(tt)} min`),Ct instanceof Date&&kt.push(`due: ${Mt(Ct)}`);for(let it of Ue){let j=g(_t,it);j!=null&&String(j).trim()!==""&&kt.push(`${it}: ${String(j)}`)}let Gt=kt.join("<br>"),Lt=it=>{var j;it.preventDefault(),d&&Tt?new he(Tt,e,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():bt(s,L,At,ft!=null?ft:tt,(j=u.row.notes)!=null?j:[],i)},St=it=>{At&&Gt&&gt(s,C,At,Gt,Kt,it)},mt=()=>yt(C);if(u.groupKey!==Xt&&(Xt=u.groupKey,Xt!==h)){let it=rt+8+Ht*f+f/2,j=a(Xt);G(j,4,it,Y-12,11,"600"),Ht+=1}let xt=rt+8+Ht*f,Nt=f-10,Ut=V(I.getTime()),Rt=V(Q.getTime()),zt=Math.max(4,Rt-Ut),ct=u.fullName,at=document.createElementNS(p.namespaceURI,"rect");at.setAttribute("x",String(Ut)),at.setAttribute("y",String(xt)),at.setAttribute("width",String(zt)),at.setAttribute("height",String(Nt)),at.setAttribute("rx","3"),at.setAttribute("ry","3"),at.setAttribute("fill",ut((Ee=u.row.series)!=null?Ee:ct,Ht)),at.setAttribute("stroke","rgba(0,0,0,0.25)"),at.setAttribute("stroke-width","0.5"),at.style.cursor=d&&Tt?"pointer":"default",at.addEventListener("mouseenter",St),at.addEventListener("mouseleave",mt),at.addEventListener("click",Lt),p.appendChild(at);let Ce=xt+Nt/2;if(zt>=6){let it=ut((Te=u.row.series)!=null?Te:ct,Ht),j=document.createElementNS(p.namespaceURI,"circle");j.setAttribute("cx",String(Ut)),j.setAttribute("cy",String(Ce)),j.setAttribute("r","3.5"),j.setAttribute("fill","#ffffff"),j.setAttribute("stroke",it),j.setAttribute("stroke-width","1.5"),p.appendChild(j);let It=document.createElementNS(p.namespaceURI,"circle");It.setAttribute("cx",String(Rt)),It.setAttribute("cy",String(Ce)),It.setAttribute("r","3.5"),It.setAttribute("fill","#ffffff"),It.setAttribute("stroke",it),It.setAttribute("stroke-width","1.5"),p.appendChild(It)}let ke=xt+Nt/2+2,qt=4;if(w==="wide")G(ct,qt,ke,Y-qt-4,11,null,St,mt,Lt);else{let it=ct,j=Math.max(40,Y-qt-8),Ne=Math.max(8,Math.floor(j/6));it.length>Ne&&(it=it.slice(0,Ne-1)+"\u2026");let vt=document.createElementNS(p.namespaceURI,"text");vt.setAttribute("x",String(qt)),vt.setAttribute("y",String(ke)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=it,vt.style.cursor="pointer",vt.addEventListener("mouseenter",St),vt.addEventListener("mouseleave",mt),vt.addEventListener("click",Lt),p.appendChild(vt)}if(Ct instanceof Date){let it=V(Ct.getTime()),j=document.createElementNS(p.namespaceURI,"line");j.setAttribute("x1",String(it)),j.setAttribute("y1",String(xt)),j.setAttribute("x2",String(it)),j.setAttribute("y2",String(xt+Nt)),j.setAttribute("stroke","#ff6b6b"),j.setAttribute("stroke-width","2"),j.setAttribute("stroke-dasharray","4,2"),p.appendChild(j)}Ht+=1}if(d){let u=s.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function fe(s,e,t){var $,Y,Z,m;let n=($=e.options)!=null?$:{},r=n.background,o=(Y=n.drilldown)!=null?Y:!0,i=(Z=t.rows)!=null?Z:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:d,svg:a,tooltip:l,details:S}=wt(s,r),A=s.getBoundingClientRect().width||600,y=Math.max(A,480);d.style.width=y+"px";let g=40,h=16,k=18,R=28,f=300;a.setAttribute("height",String(f));let N=y-g-h,M=f-k-R,D=new Map;for(let b of i){let T=String(b.x),p=(m=D.get(T))!=null?m:{label:b.x,rows:[]};p.rows.push(b),D.set(T,p)}let H=Array.from(D.keys()).sort((b,T)=>b<T?-1:b>T?1:0).map(b=>D.get(b)),x=H.length,E=new Set;i.forEach(b=>{b.series!=null&&E.add(String(b.series))});let c=Array.from(E),P=c.length>1,v=P?"grouped":"single",w=0;i.forEach(b=>{b.y>w&&(w=b.y)}),(!isFinite(w)||w<=0)&&(w=1);let F=b=>k+M-b/(w||1)*M,U=F(0),O=4;for(let b=0;b<=O;b++){let T=w*b/O,p=F(T),C=document.createElementNS(a.namespaceURI,"line");C.setAttribute("x1",String(g)),C.setAttribute("y1",String(p)),C.setAttribute("x2",String(y-h)),C.setAttribute("y2",String(p)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),a.appendChild(C);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(g-4)),L.setAttribute("y",String(p+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(T)),a.appendChild(L)}let _=x>0?N/x:N;if(H.forEach((b,T)=>{let p=g+_*(T+.5),C=String(b.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(p)),L.setAttribute("y",String(f-R+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=C,a.appendChild(L)}),P){let b=s.createDiv({cls:"chart-notes-legend"});c.forEach((T,p)=>{let C=b.createDiv({cls:"chart-notes-legend-item"}),L=C.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=ut(T,p),C.createSpan({text:T})})}H.forEach((b,T)=>{let p=g+_*(T+.5),C=b.rows;if(v==="single"){let W=C[0],nt=W.y,q=_*.6,rt=p-q/2,dt=F(nt),ot=Math.max(2,U-dt),lt=ut("bar",T),V=document.createElementNS(a.namespaceURI,"rect");V.setAttribute("x",String(rt)),V.setAttribute("y",String(dt)),V.setAttribute("width",String(q)),V.setAttribute("height",String(ot)),V.setAttribute("fill",lt),V.setAttribute("stroke","rgba(0,0,0,0.25)"),V.setAttribute("stroke-width","0.5"),V.style.cursor="pointer";let B=String(b.label),et=`valor: ${Math.round(nt*100)/100}`;V.addEventListener("mouseenter",J=>{var X,pt;return gt(s,l,B,et,(pt=(X=W.notes)==null?void 0:X.length)!=null?pt:0,J)}),V.addEventListener("mouseleave",()=>yt(l)),V.addEventListener("click",J=>{var X;J.preventDefault(),bt(s,S,B,nt,(X=W.notes)!=null?X:[],o)}),a.appendChild(V);return}let L=c.length,G=_/Math.max(L+1,2),st=L*G,z=p-st/2;c.forEach((W,nt)=>{let q=C.find(X=>(X.series!=null?String(X.series):"")===W);if(!q)return;let rt=q.y,dt=z+nt*G,ot=F(rt),lt=Math.max(2,U-ot),V=ut(W,nt),B=document.createElementNS(a.namespaceURI,"rect");B.setAttribute("x",String(dt)),B.setAttribute("y",String(ot)),B.setAttribute("width",String(G)),B.setAttribute("height",String(lt)),B.setAttribute("fill",V),B.setAttribute("stroke","rgba(0,0,0,0.25)"),B.setAttribute("stroke-width","0.5"),B.style.cursor="pointer";let et=`${W} @ ${String(b.label)}`,J=`valor: ${Math.round(rt*100)/100}`;B.addEventListener("mouseenter",X=>{var pt,Qt;return gt(s,l,et,J,(Qt=(pt=q.notes)==null?void 0:pt.length)!=null?Qt:0,X)}),B.addEventListener("mouseleave",()=>yt(l)),B.addEventListener("click",X=>{var pt;X.preventDefault(),bt(s,S,et,rt,(pt=q.notes)!=null?pt:[],o)}),a.appendChild(B)})})}function Ge(s,e,t){var _,$,Y,Z;let n=(_=e.options)!=null?_:{},r=n.background,o=($=n.drilldown)!=null?$:!0,i=(Y=t.rows)!=null?Y:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:d,svg:a,tooltip:l,details:S}=wt(s,r),A=s.getBoundingClientRect().width||600,y=Math.max(A,480);d.style.width=y+"px";let g=40,h=16,k=18,R=28,f=300;a.setAttribute("height",String(f));let N=y-g-h,M=f-k-R,D=new Map;for(let m of i){let b=String(m.x),T=(Z=D.get(b))!=null?Z:{label:m.x,rows:[]};T.rows.push(m),D.set(b,T)}let H=Array.from(D.keys()).sort((m,b)=>m<b?-1:m>b?1:0).map(m=>D.get(m)),x=H.length,E=new Set;i.forEach(m=>{m.series!=null&&E.add(String(m.series))});let c=Array.from(E);if(!c.length){fe(s,e,t);return}let P=0;H.forEach(m=>{let b=m.rows.reduce((T,p)=>T+p.y,0);b>P&&(P=b)}),(!isFinite(P)||P<=0)&&(P=1);let v=m=>k+M-m/(P||1)*M,w=v(0),F=4;for(let m=0;m<=F;m++){let b=P*m/F,T=v(b),p=document.createElementNS(a.namespaceURI,"line");p.setAttribute("x1",String(g)),p.setAttribute("y1",String(T)),p.setAttribute("x2",String(y-h)),p.setAttribute("y2",String(T)),p.setAttribute("stroke","#cccccc"),p.setAttribute("stroke-opacity","0.25"),a.appendChild(p);let C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(g-4)),C.setAttribute("y",String(T+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=String(Math.round(b)),a.appendChild(C)}let U=x>0?N/x:N;H.forEach((m,b)=>{let T=g+U*(b+.5),p=String(m.label),C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(T)),C.setAttribute("y",String(f-R+12)),C.setAttribute("text-anchor","middle"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=p,a.appendChild(C)});let O=s.createDiv({cls:"chart-notes-legend"});c.forEach((m,b)=>{let T=O.createDiv({cls:"chart-notes-legend-item"}),p=T.createDiv();p.style.width="10px",p.style.height="10px",p.style.borderRadius="999px",p.style.backgroundColor=ut(m,b),T.createSpan({text:m})}),H.forEach((m,b)=>{let T=g+U*(b+.5),p=U*.6,C=T-p/2,L=0;c.forEach((G,st)=>{let z=m.rows.find(J=>(J.series!=null?String(J.series):"")===G);if(!z)return;let W=z.y,nt=L,q=L+W;L=q;let rt=v(nt),dt=v(q),ot=Math.max(2,rt-dt),lt=ut(G,st),V=document.createElementNS(a.namespaceURI,"rect");V.setAttribute("x",String(C)),V.setAttribute("y",String(dt)),V.setAttribute("width",String(p)),V.setAttribute("height",String(ot)),V.setAttribute("fill",lt),V.setAttribute("stroke","rgba(0,0,0,0.25)"),V.setAttribute("stroke-width","0.5"),V.style.cursor="pointer";let B=`${G} @ ${String(m.label)}`,et=`valor: ${Math.round(W*100)/100}`;V.addEventListener("mouseenter",J=>{var X,pt;return gt(s,l,B,et,(pt=(X=z.notes)==null?void 0:X.length)!=null?pt:0,J)}),V.addEventListener("mouseleave",()=>yt(l)),V.addEventListener("click",J=>{var X;J.preventDefault(),bt(s,S,B,W,(X=z.notes)!=null?X:[],o)}),a.appendChild(V)})})}function Wt(s){if(!s)return null;if(s instanceof Date){let e=s.getTime();return Number.isNaN(e)?null:s}if(typeof s=="string"){let e=s.trim();if(!e||/^\d+$/.test(e))return null;let t=new Date(e);if(!Number.isNaN(t.getTime()))return t}return null}function ge(s,e,t,n){var _,$,Y,Z;let r=(_=e.options)!=null?_:{},o=r.background,i=($=r.drilldown)!=null?$:!0,d=(Y=t.rows)!=null?Y:[];if(!d.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:S,details:A}=wt(s,o),y=s.getBoundingClientRect().width||600,g=Math.max(y,480);a.style.width=g+"px";let h=40,k=16,R=18,f=28,N=300;l.setAttribute("height",String(N));let M=g-h-k,D=N-R-f,K=d.map(m=>Wt(m.x)).filter(m=>!!m),H=K.length>=2&&K.length>=d.length*.6,x=new Map;for(let m of d){let b=m.series!=null&&m.series!==""?String(m.series):"__default__",T=(Z=x.get(b))!=null?Z:[];T.push(m),x.set(b,T)}let E=Array.from(x.keys()),c,P;if(H){let b=K.map(B=>B.getTime()).sort((B,et)=>B-et),T=b[0],p=b[b.length-1];T===p&&(T-=864e5,p+=864e5);let C=p-T||864e5,L=T-C*.02,G=p+C*.02;c=B=>{let et=Wt(B);if(!et)return h;let J=et.getTime();return h+(J-L)/(G-L||1)*M},P=B=>{let et=Wt(B);return et?Mt(et):String(B)};let st=R+D,z=document.createElementNS(l.namespaceURI,"line");z.setAttribute("x1",String(h)),z.setAttribute("y1",String(st)),z.setAttribute("x2",String(g-k)),z.setAttribute("y2",String(st)),z.setAttribute("stroke","#111111"),z.setAttribute("stroke-width","1"),l.appendChild(z);let W=(G-L)/864e5,q=Math.max(3,Math.min(10,Math.floor(M/90)||3)),rt=W/q,dt=[1,2,3,5,7,10,14,21,30,60,90,180,365],ot=dt[dt.length-1];for(let B of dt)if(B>=rt){ot=B;break}let V=(B=>{let et=new Date(B);return et.setHours(0,0,0,0),et.getTime()})(L);for(let B=V;B<=G+.5*864e5;B+=ot*864e5){let et=h+(B-L)/(G-L)*M,J=document.createElementNS(l.namespaceURI,"line");J.setAttribute("x1",String(et)),J.setAttribute("y1",String(R)),J.setAttribute("x2",String(et)),J.setAttribute("y2",String(st)),J.setAttribute("stroke","#111111"),J.setAttribute("stroke-opacity","0.18"),J.setAttribute("stroke-dasharray","2,4"),l.appendChild(J);let X=document.createElementNS(l.namespaceURI,"text");X.setAttribute("x",String(et)),X.setAttribute("y",String(st+12)),X.setAttribute("text-anchor","middle"),X.setAttribute("font-size","10"),X.setAttribute("fill","#111111"),X.textContent=Mt(new Date(B)),l.appendChild(X)}}else{let m=[],b=new Set;for(let p of d){let C=String(p.x);b.has(C)||(b.add(C),m.push(p.x))}let T=m.length||1;c=p=>{let C=String(p),L=m.findIndex(G=>String(G)===C);return L<0?h:T===1?h+M/2:h+L/(T-1)*M},P=p=>String(p)}let v=Number.POSITIVE_INFINITY,w=Number.NEGATIVE_INFINITY;for(let m of d)m.y<v&&(v=m.y),m.y>w&&(w=m.y);(!isFinite(v)||!isFinite(w))&&(v=0,w=1),v===w&&(v===0?w=1:v=0);let F=m=>R+D-(m-v)/(w-v||1)*D,U=4;for(let m=0;m<=U;m++){let b=v+(w-v)*m/U,T=F(b),p=document.createElementNS(l.namespaceURI,"line");p.setAttribute("x1",String(h)),p.setAttribute("y1",String(T)),p.setAttribute("x2",String(g-k)),p.setAttribute("y2",String(T)),p.setAttribute("stroke","#cccccc"),p.setAttribute("stroke-opacity","0.25"),l.appendChild(p);let C=document.createElementNS(l.namespaceURI,"text");C.setAttribute("x",String(h-4)),C.setAttribute("y",String(T+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=Math.abs(b)>=100?String(Math.round(b)):String(Math.round(b*10)/10),l.appendChild(C)}let O=E.filter(m=>m!=="__default__");if(O.length>1){let m=s.createDiv({cls:"chart-notes-legend"});O.forEach((b,T)=>{let p=b,C=m.createDiv({cls:"chart-notes-legend-item"}),L=C.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=ut(p,T),C.createSpan({text:p})})}E.forEach((m,b)=>{let T=x.get(m);if(!(T!=null&&T.length))return;let p=m==="__default__"?ut("line",b):ut(m,b),C=[...T];H&&C.sort((G,st)=>{let z=Wt(G.x),W=Wt(st.x),nt=z?z.getTime():0,q=W?W.getTime():0;return nt-q});let L="";if(C.forEach((G,st)=>{let z=c(G.x),W=F(G.y);L+=(st===0?"M ":" L ")+z+" "+W}),n){let G=C[0],st=C[C.length-1],z=c(G.x),W=c(st.x),nt=F(v);L+=` L ${W} ${nt} L ${z} ${nt} Z`;let q=document.createElementNS(l.namespaceURI,"path");q.setAttribute("d",L),q.setAttribute("fill",p),q.setAttribute("fill-opacity","0.18"),q.setAttribute("stroke",p),q.setAttribute("stroke-width","1.5"),l.appendChild(q)}else{let G=document.createElementNS(l.namespaceURI,"path");G.setAttribute("d",L),G.setAttribute("fill","none"),G.setAttribute("stroke",p),G.setAttribute("stroke-width","2"),l.appendChild(G)}C.forEach(G=>{let st=c(G.x),z=F(G.y),W=document.createElementNS(l.namespaceURI,"circle");W.setAttribute("cx",String(st)),W.setAttribute("cy",String(z)),W.setAttribute("r","3"),W.setAttribute("fill","#ffffff"),W.setAttribute("stroke",p),W.setAttribute("stroke-width","1.5"),W.style.cursor="pointer";let nt=P(G.x),q=m==="__default__"?"":String(G.series),rt=q?`${q} @ ${nt}`:nt,dt=`valor: ${Math.round(G.y*100)/100}`;W.addEventListener("mouseenter",ot=>{var lt,V;return gt(s,S,rt,dt,(V=(lt=G.notes)==null?void 0:lt.length)!=null?V:0,ot)}),W.addEventListener("mouseleave",()=>yt(S)),W.addEventListener("click",ot=>{var lt;ot.preventDefault(),bt(s,A,rt,G.y,(lt=G.notes)!=null?lt:[],i)}),l.appendChild(W)})})}function Be(s,e,t){var M;let{background:n,drilldown:r=!0}=(M=e.options)!=null?M:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=He(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:d,svg:a,tooltip:l,details:S}=wt(s,n),A=Math.max(i,420);d.style.width=A+"px",o&&(a.style.color=o);let y=300,g=A/2,h=(y-28+28)/2,k=Math.min(A/2-20,y/2-20),f=t.rows.map(D=>Math.max(0,D.y)).reduce((D,K)=>D+K,0)||1,N=-Math.PI/2;t.rows.forEach((D,K)=>{var _;let H=D.x instanceof Date?D.x.toISOString().slice(0,10):String(D.x),x=D.y,E=x/f*Math.PI*2,c=g+k*Math.cos(N),P=h+k*Math.sin(N),v=g+k*Math.cos(N+E),w=h+k*Math.sin(N+E),F=E>Math.PI?1:0,U=document.createElementNS(a.namespaceURI,"path"),O=[`M ${g} ${h}`,`L ${c} ${P}`,`A ${k} ${k} 0 ${F} 1 ${v} ${w}`,"Z"].join(" ");U.setAttribute("d",O),U.setAttribute("fill",ut((_=D.series)!=null?_:H,K)),U.style.cursor="pointer",U.addEventListener("mouseenter",$=>{var Y,Z;return gt(s,l,H,x,(Z=(Y=D.notes)==null?void 0:Y.length)!=null?Z:0,$)}),U.addEventListener("mouseleave",()=>yt(l)),U.addEventListener("click",()=>{var $;return bt(s,S,H,x,($=D.notes)!=null?$:[],r)}),a.appendChild(U),N+=E})}function Ve(s,e,t){var P;let{background:n,drilldown:r=!0}=(P=e.options)!=null?P:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:d,svg:a,tooltip:l,details:S}=wt(s,n),A=Math.max(i,700);d.style.width=A+"px",o&&(a.style.color=o);let y=300,g=A-48-10,h=y-28-28,k=t.rows.map(v=>{let w=v.x;if(w instanceof Date)return w.getTime();if(typeof w=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(w)){let U=new Date(w);if(!isNaN(U.getTime()))return U.getTime()}let F=Number(w);return isNaN(F)?null:F}return typeof w=="number"?w:null}),R=t.rows.map(v=>v.y),f=k.filter(v=>v!==null);if(f.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let N=Math.min(...f),M=Math.max(...f),D=Math.min(...R),K=Math.max(...R),H=v=>48+(v-N)/(M-N||1)*g,x=v=>y-28-(v-D)/(K-D||1)*h,E=document.createElementNS(a.namespaceURI,"line");E.setAttribute("x1",String(48)),E.setAttribute("y1",String(28)),E.setAttribute("x2",String(48)),E.setAttribute("y2",String(y-28)),E.setAttribute("stroke","currentColor"),a.appendChild(E);let c=document.createElementNS(a.namespaceURI,"line");c.setAttribute("x1",String(48)),c.setAttribute("y1",String(y-28)),c.setAttribute("x2",String(A-10)),c.setAttribute("y2",String(y-28)),c.setAttribute("stroke","currentColor"),a.appendChild(c),t.rows.forEach((v,w)=>{let F=k[w];if(F==null)return;let U=H(F),O=x(R[w]),_=document.createElementNS(a.namespaceURI,"circle");_.setAttribute("cx",String(U)),_.setAttribute("cy",String(O)),_.setAttribute("r","4"),_.setAttribute("fill",ut(v.series,w)),_.style.cursor="pointer";let $=v.x instanceof Date?v.x.toISOString().slice(0,10):typeof v.x=="string"?v.x:String(v.x);_.addEventListener("mouseenter",Y=>{var Z,m;return gt(s,l,$,v.y,(m=(Z=v.notes)==null?void 0:Z.length)!=null?m:0,Y)}),_.addEventListener("mouseleave",()=>yt(l)),_.addEventListener("click",Y=>{var Z;Y.preventDefault(),bt(s,S,$,v.y,(Z=v.notes)!=null?Z:[],r)}),a.appendChild(_)})}var ie=class{render(e,t,n,r){var a;let{title:o}=(a=t.options)!=null?a:{};e.empty(),e.addClass("prop-charts-container");let d=e.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(o&&(d.textContent=o),t.type){case"bar":fe(e,t,n);break;case"stacked-bar":Ge(e,t,n);break;case"line":ge(e,t,n,!1);break;case"area":ge(e,t,n,!0);break;case"pie":Be(e,t,n);break;case"scatter":Ve(e,t,n);break;case"gantt":se(e,t,n,r);break;default:e.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}}};function hn(){return[{type:"dropdown",key:"chartType",displayName:"Chart type",description:"Type of chart to render",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},{type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",description:"Property used for the X axis or categories (for pie, this is the slice)."},{type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:"Label for each task bar. If empty, uses the X / category.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")!=="gantt"}},{type:"property",key:"yProperty",displayName:"Y value (empty = count)",description:"Numeric property summed on the Y axis. Leave empty to just count notes.",shouldHide:e=>{var n;let t=String((n=e.get("chartType"))!=null?n:"bar");return t==="pie"||t==="gantt"}},{type:"property",key:"seriesProperty",displayName:"Series / color (optional)",description:"Property that defines series / color for bars, lines and area.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")==="pie"}},{type:"dropdown",key:"xBucket",displayName:"X bucket (dates)",description:"How to bucket dates on the X axis for line / area charts (day, week, month...).",default:"auto",options:{auto:"Auto",none:"None",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:e=>{var n;let t=String((n=e.get("chartType"))!=null?n:"bar");return!(t==="line"||t==="area")}},{type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",description:"How to aggregate Y values with the same X / series.",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum (line/area only)"},shouldHide:e=>{var n;let t=String((n=e.get("chartType"))!=null?n:"bar");return t==="pie"||t==="scatter"||t==="gantt"}},{type:"property",key:"startProperty",displayName:"Start (Gantt)",description:"Start date/datetime for the task.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")!=="gantt"}},{type:"property",key:"endProperty",displayName:"End (Gantt)",description:"End date/datetime for the task.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")!=="gantt"}},{type:"property",key:"dueProperty",displayName:"Due (deadline, optional)",description:"Due date / deadline for the task.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")!=="gantt"}},{type:"property",key:"durationProperty",displayName:"Duration in minutes (optional)",description:"Duration of the task in minutes. Used together with start/due.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")!=="gantt"}},{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)",description:"Custom chart title. Falls back to the view name."},{type:"text",key:"labelWidth",displayName:"Gantt label column width",description:"Optional width for the left label column in the Gantt chart.",shouldHide:e=>{var t;return String((t=e.get("chartType"))!=null?t:"bar")!=="gantt"}}]}var ae=class extends Vt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("Chart Notes: loading plugin (Bases-only)"),this.indexer=new te(this.app),await this.indexer.buildIndex(),this.query=new re(()=>this.indexer.getAll(),[]),this.renderer=new ie,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Vt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Vt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Vt.TFile&&this.indexer.removeFile(t)})),this.registerBasesView(de,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new Zt(t,n,this.renderer),options:hn})}onunload(){console.log("Chart Notes: unloading plugin")}};
