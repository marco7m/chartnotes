/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ue=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Oe=(s,r)=>{for(var t in r)ue(s,t,{get:r[t],enumerable:!0})},Xe=(s,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of We(r))!Ye.call(s,e)&&e!==t&&ue(s,e,{get:()=>r[e],enumerable:!(n=Ue(r,e))||n.enumerable});return s};var ze=s=>Xe(ue({},"__esModule",{value:!0}),s);var hn={};Oe(hn,{default:()=>ae});module.exports=ze(hn);var Qt=require("obsidian");var Jt=require("obsidian"),de="chartnotes-view",qe=["bar","stacked-bar","line","area","pie","scatter","gantt"];function je(s){let r=String(s!=null?s:"bar").trim().toLowerCase();return qe.includes(r)?r:"bar"}var Ze=["sum","count","cumulative-sum"];function Je(s){let r=String(s!=null?s:"sum").trim().toLowerCase();return Ze.includes(r)?r:"sum"}var tn=["auto","none","day","week","month","quarter","year"];function en(s){let r=String(s!=null?s:"auto").trim().toLowerCase();return tn.includes(r)?r:"auto"}var jt="(missing)",Zt=class extends Jt.BasesView{constructor(t,n,e){super(t);this.type=de;this.renderer=e,this.rootEl=n.createDiv("chartnotes-bases-view")}onDataUpdated(){var I,z,J;this.rootEl.empty();let t=this.data,n=(I=t==null?void 0:t.groupedData)!=null?I:[];if(!n.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let e=this.config,o=je((z=e==null?void 0:e.get("chartType"))!=null?z:"bar"),i=o==="pie",u=o==="scatter",a=o==="gantt",l=Je(e==null?void 0:e.get("aggregateMode")),D=l==="cumulative-sum"&&!(o==="line"||o==="area")?"sum":l,y=en(e==null?void 0:e.get("xBucket")),g=i||u||a?"none":y,m=this.getPropFromConfig("xProperty"),N=this.getPropFromConfig("ganttLabelProperty"),R=this.getPropFromConfig("yProperty"),f=this.getPropFromConfig("seriesProperty");i&&(f={id:null,name:null});let k=this.getPropFromConfig("startProperty"),M=this.getPropFromConfig("endProperty"),E=this.getPropFromConfig("dueProperty"),V=this.getPropFromConfig("durationProperty"),H=this.getPropFromConfig("groupProperty");if(!a&&!m.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(u&&(!m.id||!R.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(k.id||M.id||E.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Due with Duration."});return}let x=a&&N.id?N:a?m:{id:null,name:null},T;if(a)T=this.buildRowsForGantt(n,x,f,k,M,E,V,H);else if(u)T=this.buildRowsForScatter(n,m,R,f);else{let p=i;T=this.buildRowsForAggregatedCharts(n,m,R,f,D,g,p)}if(!T.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let c={rows:T},v=((J=e==null?void 0:e.get("title"))!=null?J:"").trim()||(e==null?void 0:e.name)||"Chart Notes (Bases)",A=e==null?void 0:e.get("drilldown"),$=typeof A=="boolean"?A:!0,K=this.buildEncoding({x:m,y:R,series:f,start:k,end:M,due:E,duration:V,group:H,label:x,aggMode:D,xBucket:g,chartType:o}),Y={type:o,source:{type:"properties",query:""},encoding:K,options:{title:v,drilldown:$}},_={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,Y,c,_)}getPropFromConfig(t){var u,a;let n=this.config,e=(u=n==null?void 0:n.get)==null?void 0:u.call(n,t);if(!e)return{id:null,name:null};let o=e.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let l=(0,Jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,n){if(!n.id)return null;let e;try{e=t.getValue(n.id)}catch(o){return null}if(!e)return null;try{if(typeof e.isEmpty=="function"&&e.isEmpty())return null}catch(o){}try{let o=e.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=new Date(t.trim());return Number.isNaN(n.getTime())?null:n}compareX(t,n){let e=this.parseDate(t!=null?String(t):null),o=this.parseDate(n!=null?String(n):null);if(e&&o)return e.getTime()-o.getTime();let i=Number(t),u=Number(n);return!Number.isNaN(i)&&!Number.isNaN(u)?i-u:String(t!=null?t:"").localeCompare(String(n!=null?n:""))}fmtDate(t){let n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${e}-${o}`}startOfWeek(t){let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),e=(n.getDay()+6)%7;return n.setDate(n.getDate()-e),n.setHours(0,0,0,0),n}bucketX(t,n){let e=this.parseDate(t);if(!e)return t;switch(n){case"none":return t;case"auto":case"day":return this.fmtDate(new Date(e.getFullYear(),e.getMonth(),e.getDate()));case"week":{let o=this.startOfWeek(e);return`${this.fmtDate(o)} (W)`}case"month":{let o=String(e.getMonth()+1).padStart(2,"0");return`${e.getFullYear()}-${o}`}case"quarter":{let o=Math.floor(e.getMonth()/3)+1;return`${e.getFullYear()}-Q${o}`}case"year":return`${e.getFullYear()}`;default:return t}}getXValuesForEntry(t,n,e,o){var b,D;let i=[],u=y=>this.bucketX(y,e);if(!n.id){let y=t.file,g=y!=null&&y.name?String(y.name):String((b=y==null?void 0:y.path)!=null?b:jt);return i.push(u(g)),i}if(!o){let y=(D=this.readValue(t,n))!=null?D:jt;return i.push(u(y)),i}let a=null;try{a=t.getValue(n.id)}catch(y){a=null}let l=y=>{if(!y)return;let g=String(y).trim();g&&i.push(u(g))};if(a==null)l(jt);else if(typeof a=="string"){let y=a.trim();if(y){let g=y.split(/\s+/);for(let m of g)l(m)}}else if(Array.isArray(a))for(let y of a){if(y==null)continue;let g;try{g=y.toString()}catch(m){continue}l(g)}else if(typeof a.toArray=="function"){let y=a.toArray();if(Array.isArray(y))for(let g of y){if(g==null)continue;let m;try{m=g.toString()}catch(N){continue}l(m)}else{let g;try{g=a.toString()}catch(m){g=""}l(g)}}else{let y;try{y=a.toString()}catch(g){y=""}l(y)}return i.length||l(jt),i}buildRowsForAggregatedCharts(t,n,e,o,i,u,a){let l=new Map,b=a||i==="count"||!e.id&&i!=="sum",D=e.name||"y";for(let g of t)for(let m of g.entries){let N=m.file,R=this.getXValuesForEntry(m,n,u,a),f=1,k=null;if(!b&&e.id){if(k=this.readValue(m,e),k==null)continue;let V=Number(k);if(Number.isNaN(V))continue;f=V}else f=1;let M=this.readValue(m,o),E=M!=null?String(M):void 0;for(let V of R){let H=`${V}@@${E!=null?E:""}`,x=l.get(H);x||(x={x:V,y:0,series:E,notes:[],props:{}},l.set(H,x)),x.y+=f,N!=null&&N.path&&x.notes.push(N.path),x.props&&n.name&&(x.props[n.name]=V),!b&&x.props&&D&&k!=null&&(x.props[D]=x.y),b&&x.props&&(x.props[D]=x.y),x.props&&o.name&&M!=null&&(x.props[o.name]=M)}}let y=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(y):y}toCumulative(t){var o,i;let n=new Map;for(let u of t){let a=(o=u.series)!=null?o:"__no_series__",l=n.get(a);l||(l=[],n.set(a,l)),l.push(u)}let e=[];for(let[,u]of n){let a=[...u].sort((b,D)=>this.compareX(b.x,D.x)),l=0;for(let b of a){let D=Number((i=b.y)!=null?i:0);Number.isNaN(D)||(l+=D,e.push({...b,y:l}))}}return e}buildRowsForScatter(t,n,e,o){let i=[];for(let u of t)for(let a of u.entries){let l=a.file,b=this.readValue(a,n),D=this.readValue(a,e);if(b==null||D==null)continue;let y=Number(b),g=Number(D);if(Number.isNaN(y)||Number.isNaN(g))continue;let m=this.readValue(a,o),N=m!=null?String(m):void 0;i.push({x:y,y:g,series:N,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,n,e,o,i,u,a,l){var R;let b=[],g=f=>{let k=[f==null?void 0:f.label,f==null?void 0:f.name,f==null?void 0:f.value,f==null?void 0:f.key,f==null?void 0:f.group,f==null?void 0:f.groupLabel];for(let M of k)if(M!=null&&String(M).trim()!=="")return String(M);return""},m=n;try{let f=this.getPropFromConfig("ganttLabelProperty");f&&f.id&&(m=f)}catch(f){}let N=!!l.id;for(let f of t){let k=g(f);for(let M of(R=f.entries)!=null?R:[]){let E=M.file,V=this.readValue(M,o),H=this.readValue(M,i),x=this.readValue(M,u),T=this.readValue(M,a),c=T!=null?Number(T):NaN,P=Number.isFinite(c)&&c>0,v=P?c*6e4:36e5,A=this.parseDate(V),$=this.parseDate(H),K=this.parseDate(x),Y=A,_=$;if(Y&&!_&&(_=new Date(Y.getTime()+v)),!Y&&_&&(Y=new Date(_.getTime()-v)),!Y&&!_&&K&&(P?(_=K,Y=new Date(K.getTime()-v)):(Y=K,_=new Date(K.getTime()+36e5))),!Y||!_)continue;if(Y.getTime()>_.getTime()){let h=Y;Y=_,_=h}let I=this.readValue(M,m);(I==null||String(I).trim()==="")&&(E!=null&&E.name?I=String(E.name).replace(/\.md$/i,""):E!=null&&E.path?I=String(E.path):I="(sem t\xEDtulo)");let z=this.readValue(M,e),J=z!=null?String(z):void 0,p={};if(k&&(p.__basesGroup=k),N){let h=this.readValue(M,l);h!=null&&l.name&&(p[l.name]=h)}m.name&&(p[m.name]=I),p.label=I,o.name&&V!=null&&(p[o.name]=V),i.name&&H!=null&&(p[i.name]=H),u.name&&x!=null&&(p[u.name]=x),P&&a.name&&(p[a.name]=c);let S=E==null?void 0:E.path;b.push({x:I,y:0,series:J,start:Y,end:_,due:K!=null?K:void 0,notes:S?[S]:[],props:p})}}return b.sort((f,k)=>!f.start||!k.start?0:f.start.getTime()-k.start.getTime()),b}buildEncoding(t){var u,a,l,b,D,y,g,m,N,R,f;let n=(u=t.x.name)!=null?u:"x",e=(a=t.y.name)!=null?a:"y",o=(D=(b=(l=t.label.name)!=null?l:t.x.name)!=null?b:t.group.name)!=null?D:"label",i=t.chartType==="gantt"?"__basesGroup":(y=t.group.name)!=null?y:"group";return{x:n,y:e,series:(g=t.series.name)!=null?g:"series",start:(m=t.start.name)!=null?m:"start",end:(N=t.end.name)!=null?N:"end",due:(R=t.due.name)!=null?R:"due",duration:(f=t.duration.name)!=null?f:"duration",group:i,label:o}}};var ke=require("obsidian"),te=class{constructor(r){this.index=new Map;this.app=r}async buildIndex(){this.index.clear();let r=this.app.vault.getMarkdownFiles();for(let t of r)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(r){if(r.extension!=="md")return;let t={};try{let e=(await this.app.vault.read(r)).match(/^---\n([\s\S]*?)\n---\n?/);if(e){let i=(0,ke.parseYaml)(e[1])||{};if(i&&typeof i=="object")for(let[u,a]of Object.entries(i))u!=="position"&&(t[u]=a)}let o=this.app.metadataCache.getFileCache(r);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",r.path,n)}this.index.set(r.path,{path:r.path,props:t})}removeFile(r){this.index.delete(r.path)}};function Pe(s,r){if(!r||r.length===0)return!0;for(let t of r){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Le(s,r){if(!r||r.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let e of r)if(t.includes(e)||t.includes("#"+e))return!0;return!1}let n=String(t);for(let e of r)if(n===e||n==="#"+e)return!0;return!1}function ne(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function Ft(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,n,e]=s.split("-");return new Date(Number(t),Number(n)-1,Number(e),0,0,0,0)}let r=new Date(s);return isNaN(r.getTime())?null:r}function ht(s){let r=new Date(s);return r.setHours(0,0,0,0),r}function ee(s,r){let t=new Date(s);return t.setDate(t.getDate()-r),t}function nn(s,r){return ee(s,r*7)}function rn(s,r){let t=new Date(s);return t.setMonth(t.getMonth()-r),t}function he(s,r){let t=new Date(s);return t.setDate(t.getDate()+r),t}function sn(s,r){return he(s,r*7)}function on(s,r){let t=new Date(s);return t.setMonth(t.getMonth()+r),t}function Re(s){let r=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(r)||r.endsWith("date")||r.endsWith("at")||r.endsWith("on"))}function Me(s,r){let t=r?new Date(r):new Date,n=ht(t),e=s.trim().toLowerCase();if(e==="today")return n;if(e==="yesterday")return ht(ee(n,1));if(/^-\d+$/.test(e)){let o=parseInt(e.slice(1),10);return ht(ee(n,o))}if(/^-\d+d$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ht(ee(n,o))}if(/^-\d+w$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ht(nn(n,o))}if(/^-\d+m$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ht(rn(n,o))}if(/^\+\d+$/.test(e)){let o=parseInt(e.slice(1),10);return ht(he(n,o))}if(/^\+\d+d$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ht(he(n,o))}if(/^\+\d+w$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ht(sn(n,o))}if(/^\+\d+m$/.test(e)){let o=parseInt(e.slice(1,-1),10);return ht(on(n,o))}return null}function Ie(s){let r=s.trim(),t=r.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let b=t[1].trim(),D=t[2].trim(),y=t[3].trim(),g=Re(b),m=pe(D,g),N=pe(y,g),R=m.valueType==="date"||N.valueType==="date"?"date":m.valueType;return{field:b,op:"between",value:m.value,value2:N.value,valueType:R}}let n=/(==|!=|>=|<=|>|<)/,e=r.split(n);if(e.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=e[0].trim(),i=e[1].trim(),u=e[2].trim(),a=Re(o),l=pe(u,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function pe(s,r){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),e=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(r){if(t==="0"||n==="today")return{value:ht(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(e){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(ne(t)){let i=Ft(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function _e(s,r){let t=s[r.field];if(t==null)return!1;if(r.valueType==="date"){let o=t instanceof Date?ht(t):ne(t)?ht(Ft(t)):null;if(!o)return!1;let i=r.value instanceof Date?r.value:null,u=r.value2 instanceof Date?r.value2:null;if(!i)return!1;let a=o.getTime(),l=ht(i).getTime();switch(r.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!u)return!1;let b=ht(u).getTime();return a>=l&&a<=b}}if(r.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(r.value);switch(r.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof r.value2!="number"?!1:o>=i&&o<=r.value2}}let n=String(t),e=String(r.value);switch(r.op){case"==":return n===e;case"!=":return n!==e;case">":return n>e;case">=":return n>=e;case"<":return n<e;case"<=":return n<=e;case"between":return!1}}function an(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(ne(s)){let r=Ft(s);if(r)return{key:r,isDate:!0}}return{key:s,isDate:!1}}function ln(s,r){let t=s.x,n=r.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let e=String(t),o=String(n);return e<o?-1:e>o?1:0}function cn(s,r){var o,i;let t=ln(s,r);if(t!==0)return t;let n=(o=s.series)!=null?o:"",e=(i=r.series)!=null?i:"";return n<e?-1:n>e?1:0}function un(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let r=s.trim().match(/^(\d+)/);if(r){let t=Number(r[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function dn(s){var n,e;let r=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:"__no_series__",a=((e=r.get(i))!=null?e:0)+o.y;r.set(i,a),t.push({...o,y:a})}return t}function pn(s,r){var i,u;let t=un(r);if(!t||t<=1)return[...s];let n=new Map,e=new Map,o=[];for(let a of s){let l=(i=a.series)!=null?i:"__no_series__",b=n.get(l);b||(b=[],n.set(l,b));let D=(u=e.get(l))!=null?u:0;if(b.push(a.y),D+=a.y,b.length>t){let m=b.shift();D-=m}e.set(l,D);let y=b.length||1,g=D/y;o.push({...a,y:g})}return o}var re=class{constructor(r,t){this.getIndex=r,this.defaultPaths=t}run(r){var i,u,a;let t=this.getIndex(),n=(i=r.source)!=null&&i.paths&&r.source.paths.length?r.source.paths:this.defaultPaths,e=(u=r.source)!=null&&u.tags&&r.source.tags.length?r.source.tags:[],o=[];for(let l of t){let b=n&&n.length?Pe(l.path,n):!0,D=e&&e.length?Le(l.props,e):!0;if(!b||!D)continue;let y=!0;if((a=r.source)!=null&&a.where&&r.source.where.length>0)for(let g of r.source.where){let m;try{m=Ie(g)}catch(N){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${g} (${N.message})`)}if(!_e(l.props,m)){y=!1;break}}y&&o.push(l)}return r.type==="gantt"?this.runGantt(r,o):r.type==="table"?this.runTable(r,o):this.runStandard(r,o)}runTable(r,t){var e,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(e=r.encoding)==null?void 0:e.x,yField:(o=r.encoding)==null?void 0:o.y}}runGantt(r,t){var D,y,g;let n=(D=r.encoding)!=null?D:{},e=n.start,o=n.end,i=(y=n.label)!=null?y:n.x,u=n.series,a=n.duration,l=n.due,b=[];for(let m of t){let N=(g=m.props)!=null?g:{},R=x=>Array.isArray(x)?x[0]:x,f=null;if(o){let x=R(N[o]),T=Ft(x);T&&(f=T)}if(!f)continue;let k=null;if(e){let x=R(N[e]),T=Ft(x);T&&(k=T)}if(!k&&a){let x=R(N[a]),T=Number(x);Number.isNaN(T)||(k=new Date(f.getTime()-T*6e4))}k||(k=new Date(f.getTime()));let M;if(l){let x=R(N[l]),T=Ft(x);T&&(M=T)}let E;if(i){let x=R(N[i]);(x==null||x==="")&&(x=m.path),E=x}else E=m.path;let V;if(u){let x=R(N[u]);x!=null&&(V=String(x))}let H={x:E,y:0,notes:[m.path],series:V,start:k,end:f,props:N};M&&(H.due=M),b.push(H)}return b.sort((m,N)=>{let R=m.start?m.start.getTime():0,f=N.start?N.start.getTime():0;return R-f}),{rows:b,xField:i,yField:o}}runStandard(r,t){var m,N,R,f,k,M,E,V,H,x;let n=(m=r.encoding)==null?void 0:m.x,e=(N=r.encoding)==null?void 0:N.y,o=(R=r.encoding)==null?void 0:R.series;if(!n)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(f=r.aggregate)!=null?f:{},u=(k=i.y)!=null?k:null,a=!!i.cumulative,l=i.rolling;if(!e&&u!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let b=[];for(let T of t){let c=(M=T.props)!=null?M:{},P=I=>Array.isArray(I)?I[0]:I,v=P(c[n]);if(v==null)continue;let A=an(v),$=A.key,K=A.isDate,Y;if(o){let I=P(c[o]);I!=null&&String(I).trim()!==""&&(Y=String(I))}let _;if(u==="count")_=1;else{let I=P(c[e]);if(I==null)continue;let z=Number(I);if(Number.isNaN(z))continue;_=z}b.push({x:$,y:_,notes:[T.path],series:Y,props:c,_isDate:K,_origX:v})}if(b.length===0)return{rows:[],xField:n,yField:e};let D=[];if(u){let T=new Map;for(let c of b){let P=(E=c.series)!=null?E:"",v=c.x instanceof Date?c.x.toISOString().slice(0,10):String(c.x),A=P+"||"+v,$=(V=T.get(A))!=null?V:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:c.x,isDate:c._isDate,series:c.series,props:c.props};$.sum+=c.y,$.count+=1,c.y<$.min&&($.min=c.y),c.y>$.max&&($.max=c.y),$.notes.push(...c.notes),$.props=(H=c.props)!=null?H:$.props,T.set(A,$)}for(let[,c]of T){let P=c.sum;switch(u){case"sum":P=c.sum;break;case"avg":P=c.sum/c.count;break;case"min":P=c.min;break;case"max":P=c.max;break;case"count":P=c.count;break}D.push({x:c.xRep,y:P,notes:c.notes,series:c.series,props:c.props})}}else D=b.map(T=>({x:T.x,y:T.y,notes:T.notes,series:T.series,props:T.props}));if(D.length===0)return{rows:[],xField:n,yField:e};let y=((x=r.sort)==null?void 0:x.x)==="desc"?"desc":"asc";if(D.sort((T,c)=>{let P=cn(T,c);return y==="asc"?P:-P}),(a||l)&&!(r.type==="line"||r.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let g=D;return l?g=pn(D,l):a&&(g=dn(D)),{rows:g,xField:n,yField:e}}};var Et=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function ut(s,r){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,e)=>n*33+e.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function At(s,r){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,r&&(n.style.background=r);let e="http://www.w3.org/2000/svg",o=document.createElementNS(e,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let u=s.createDiv({cls:"chart-notes-details"});return u.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:u}}function gt(s,r,t,n,e,o){let i=s.getBoundingClientRect(),u=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);r.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${u}</div>
    <div class="chart-notes-tooltip-notes">${e} nota${e===1?"":"s"}</div>
  `,r.style.display="block";let a=r.getBoundingClientRect(),l=o.clientX-i.left+6,b=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),b+a.height>i.height-4&&(b=i.height-a.height-4),b<4&&(b=4),r.style.left=l+"px",r.style.top=b+"px"}function yt(s){s.style.display="none"}function bt(s,r,t,n,e,o){if(!o)return;if(r.empty(),!e||e.length===0){r.style.display="none";return}r.style.display="block";let i=r.createEl("div",{cls:"chart-notes-details-header"}),u=i.createEl("div",{cls:"chart-notes-details-title"});u.textContent=`Notas em "${t}" (${e.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{r.style.display="none"});let l=r.createEl("ul",{cls:"chart-notes-details-list"});for(let b of e){let y=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:b});y.href="#",y.addEventListener("click",g=>{g.preventDefault(),app.workspace.openLinkText(b,"",!1)})}}function Mt(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let r=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${r}/${t}`}function $e(s){if(!s)return!1;let r=s.trim().toLowerCase();if(r==="#fff"||r==="#ffffff"||r==="white")return!0;if(!r.startsWith("#"))return!1;let t,n,e;if(r.length===4)t=parseInt(r[1]+r[1],16),n=parseInt(r[2]+r[2],16),e=parseInt(r[3]+r[3],16);else if(r.length===7)t=parseInt(r.slice(1,3),16),n=parseInt(r.slice(3,5),16),e=parseInt(r.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*e)/255>.7}var me=class extends Et.Modal{constructor(t,n,e,o){var u;super(app);this.notePath=t,this.spec=n,this.refresh=e,this.reindexFile=o;let i=(u=n.encoding)!=null?u:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var x,T;let{contentEl:t}=this;t.empty();let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Et.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let e=await this.app.vault.read(n),o={},i=e,u=/^---\n([\s\S]*?)\n---\n?/m.exec(e);if(u){try{o=(x=(0,Et.parseYaml)(u[1]))!=null?x:{}}catch(c){o={}}i=e.slice(u[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(T=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?T:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),b=l.createEl("a",{text:a,cls:"gantt-edit-title"});b.href="#",b.addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let D=l.createDiv({cls:"gantt-edit-subtitle"});D.textContent=this.notePath;let y=t.createDiv({cls:"gantt-edit-form"}),g=c=>{let P=y.createDiv({cls:"gantt-edit-row"}),v=P.createDiv({cls:"gantt-edit-label"});v.textContent=c;let A=P.createDiv({cls:"gantt-edit-field"});return{row:P,field:A}},m=c=>{if(!c)return"";let v=String(c).match(/^(\d{4}-\d{2}-\d{2})/);return v?v[1]:""},N=c=>{if(c=c.trim(),!!c&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c},R=null;if(this.startKey){let{field:c}=g(this.startKey+" (in\xEDcio)");R=c.createEl("input",{type:"date"}),R.value=m(o[this.startKey])}let f=null;if(this.endKey){let{field:c}=g(this.endKey+" (fim)");f=c.createEl("input",{type:"date"}),f.value=m(o[this.endKey])}let k=null;if(this.durationKey){let{field:c}=g(this.durationKey+" (minutos)");k=c.createEl("input",{type:"number"});let P=o[this.durationKey];k.value=P!=null?String(P):"",k.min="0",k.step="5"}let M=null;if(this.dueKey){let{field:c}=g(this.dueKey+" (due)");M=c.createEl("input",{type:"date"}),M.value=m(o[this.dueKey])}let E=t.createDiv({cls:"gantt-edit-buttons"}),V=E.createEl("button",{text:"Salvar",cls:"mod-cta"});E.createEl("button",{text:"Cancelar"}).addEventListener("click",c=>{c.preventDefault(),this.close()}),V.addEventListener("click",async c=>{if(c.preventDefault(),this.startKey&&R){let A=N(R.value);A?o[this.startKey]=A:delete o[this.startKey]}if(this.endKey&&f){let A=N(f.value);A?o[this.endKey]=A:delete o[this.endKey]}if(this.durationKey&&k){let A=k.value.trim();if(A==="")delete o[this.durationKey];else{let $=Number(A);Number.isNaN($)||(o[this.durationKey]=$)}}if(this.dueKey&&M){let A=N(M.value);A?o[this.dueKey]=A:delete o[this.dueKey]}let v=`---
${(0,Et.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,v),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(A){}if(this.refresh)try{this.refresh()}catch(A){}new Et.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function se(s,r,t,n){var be,Se,xe,ve,Ae,we,De,Ee;let e=(be=r.options)!=null?be:{},o=e.background,i=(Se=e.drilldown)!=null?Se:!0,u=!0,a=d=>{if(d==null)return"";let F=String(d).trim();if(!F)return"";let Q=F.match(/^\[\[(.+?)\]\]$/);Q&&(F=Q[1]);let tt=F.lastIndexOf("/");return tt>=0&&tt<F.length-1&&(F=F.slice(tt+1)),F};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(d=>d.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(d=>d.start&&d.end);if(l.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let b=r.encoding,D=b.group,y=b.duration,g=(d,F)=>{if(!d||!F)return;let Q=d[F];return Array.isArray(Q)?Q[0]:Q},m="__chartnotes_no_group__",R=l.map(d=>{var pt,xt;let F=d.start,Q=d.end,tt=d.props,_t=typeof d.x=="string"?d.x:d.x instanceof Date?Mt(F):String(d.x),Tt=a(_t),wt=D!=null&&D!==""?g(tt,D):void 0,Ct=wt!=null&&String(wt).trim().length>0?String(wt):m,ft=(pt=d.notes)==null?void 0:pt[0],Nt=ft?(xt=ft.replace(/\.md$/i,"").split("/").pop())!=null?xt:ft:Tt,Gt=d.due,Lt,St=g(tt,y);if(St!=null){let kt=Number(St);Number.isNaN(kt)||(Lt=kt)}return{row:d,start:F,end:Q,props:tt,fullName:Tt,groupKey:Ct,notePath:ft,noteTitle:Nt,due:Gt,estMinutes:Lt}}).filter(d=>d.start instanceof Date&&!isNaN(d.start.getTime())&&d.end instanceof Date&&!isNaN(d.end.getTime()));if(R.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}R.sort((d,F)=>{if(d.groupKey<F.groupKey)return-1;if(d.groupKey>F.groupKey)return 1;let Q=d.start.getTime(),tt=F.start.getTime();return Q!==tt?Q-tt:d.fullName.localeCompare(F.fullName)});let f=26,k=0,M=null;for(let d of R)d.groupKey!==M&&(M=d.groupKey,d.groupKey!==m&&(k+=1)),k+=1;let E=Math.min(...R.map(d=>d.start.getTime())),V=Math.max(...R.map(d=>d.end.getTime()));if(!isFinite(E)||!isFinite(V)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let H=24*60*60*1e3,x=d=>{let F=new Date(d);return F.setHours(0,0,0,0),F.getTime()},T=x(E),c=x(V),P=s.querySelector(".prop-charts-title-row");P||(P=s.createDiv({cls:"prop-charts-title-row"}));let v=s.dataset.ganttZoomMode||String((xe=e.zoomMode)!=null?xe:"100");s.dataset.ganttZoomMode=v;let A=s.dataset.ganttLabelMode||String((ve=e.labelMode)!=null?ve:"compact");s.dataset.ganttLabelMode=A;let $=P.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(d=>{let F=$.createEl("button",{cls:"gantt-zoom-btn",text:d.label});d.id===v&&F.addClass("is-active"),F.addEventListener("click",Q=>{Q.preventDefault(),s.dataset.ganttZoomMode=d.id,se(s,r,t,n)})});let Y=Number(e.labelWidth),_=!Number.isNaN(Y)&&Y>120?Y:260,I=A==="wide"?_+160:_,z=s.getBoundingClientRect().width||600,J=Math.max(z,820),p;if(v==="fit")p=z;else{let d=Number(v)/100||1;p=J*d}let{inner:S,svg:h,tooltip:w,details:C}=At(s,o);S.style.width=p+"px";let L=(d,F,Q,tt,_t,Tt,wt,Kt,Ct)=>{if(!d)return;let ft=Math.max(40,tt-8),Gt=Math.max(8,Math.floor(ft/6)),Lt=d.split(/\s+/),St=[],pt="";for(let Rt of Lt){if(!pt){pt=Rt;continue}(pt+" "+Rt).length<=Gt?pt+=" "+Rt:(St.push(pt),pt=Rt)}pt&&St.push(pt);let xt=_t+2,kt=St.length*xt,Ut=Q-kt/2+_t;St.forEach((Rt,zt)=>{let ct=document.createElementNS(h.namespaceURI,"text");ct.setAttribute("x",String(F)),ct.setAttribute("y",String(Ut+zt*xt)),ct.setAttribute("text-anchor","start"),ct.setAttribute("font-size",String(_t)),ct.setAttribute("fill","#111111"),Tt&&ct.setAttribute("font-weight",Tt),ct.textContent=Rt,wt&&ct.addEventListener("mouseenter",lt=>wt(lt)),Kt&&ct.addEventListener("mouseleave",()=>Kt()),Ct&&(ct.style.cursor="pointer",ct.addEventListener("click",lt=>Ct(lt))),h.appendChild(ct)})},G=28,nt=28,j=10,U=Math.max(300,G+nt+k*f+24);h.setAttribute("height",String(U));let rt=p-I-j,O=G+6;h.style.color="#111111";let dt=c+H-T||1,st=T-dt*.02,it=c+H+dt*.08,at=d=>I+(d-st)/(it-st)*rt,W=(it-st)/H,et=Math.max(4,Math.min(12,Math.floor(rt/90)||4)),Z=W/et,X=[1,2,3,5,7,10,14,21,30,60,90,180,365],mt=X[X.length-1];for(let d of X)if(d>=Z){mt=d;break}let Vt=[],Qe=x(st);for(let d=Qe;d<=it+.5*H;d+=mt*H)Vt.push(d);let $t=document.createElementNS(h.namespaceURI,"line");$t.setAttribute("x1",String(I)),$t.setAttribute("y1",String(O)),$t.setAttribute("x2",String(p-j)),$t.setAttribute("y2",String(O)),$t.setAttribute("stroke","#111111"),h.appendChild($t);for(let d of Vt){let F=at(d),Q=document.createElementNS(h.namespaceURI,"line");Q.setAttribute("x1",String(F)),Q.setAttribute("y1",String(O)),Q.setAttribute("x2",String(F)),Q.setAttribute("y2",String(U-nt)),Q.setAttribute("stroke","#111111"),Q.setAttribute("stroke-opacity","0.20"),Q.setAttribute("stroke-dasharray","2,4"),h.appendChild(Q);let tt=document.createElementNS(h.namespaceURI,"text");tt.setAttribute("x",String(F)),tt.setAttribute("y",String(O-4)),tt.setAttribute("text-anchor","middle"),tt.setAttribute("font-size","10"),tt.setAttribute("fill","#111111"),tt.textContent=Mt(new Date(d)),h.appendChild(tt)}let ye=new Date;ye.setHours(0,0,0,0);let le=ye.getTime();if(le>=st&&le<=it){let d=at(le),F=document.createElementNS(h.namespaceURI,"line");F.setAttribute("x1",String(d)),F.setAttribute("y1",String(O)),F.setAttribute("x2",String(d)),F.setAttribute("y2",String(U-nt)),F.setAttribute("stroke","#4caf50"),F.setAttribute("stroke-width","2"),F.setAttribute("stroke-dasharray","4,2"),h.appendChild(F);let Q=document.createElementNS(h.namespaceURI,"text");Q.setAttribute("x",String(d+4)),Q.setAttribute("y",String(O+12)),Q.setAttribute("font-size","10"),Q.setAttribute("fill","#4caf50"),Q.textContent="hoje",h.appendChild(Q)}let Ot=S.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",A==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${I}px`,Ot.style.top="4px",Ot.addEventListener("click",d=>{d.preventDefault();let Q=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=Q,se(s,r,t,n)});let Ve=["status","priority"],ce=Array.isArray(e.tooltipFields)?e.tooltipFields.map(d=>String(d)):null,Ke=ce&&ce.length?ce:Ve,Ht=0,Xt=null;for(let d of R){let F=d.start,Q=d.end,tt=(Q.getTime()-F.getTime())/6e4,_t=d.props,Tt=d.notePath,wt=d.noteTitle,Kt=(we=(Ae=d.row.notes)==null?void 0:Ae.length)!=null?we:0,Ct=d.due,ft=d.estMinutes,Nt=[];Nt.push(`${Mt(F)} \u2192 ${Mt(Q)}`),typeof ft=="number"&&!Number.isNaN(ft)?Nt.push(`est: ${Math.round(ft)} min`):tt>0&&Nt.push(`dura\xE7\xE3o: ${Math.round(tt)} min`),Ct instanceof Date&&Nt.push(`due: ${Mt(Ct)}`);for(let ot of Ke){let q=g(_t,ot);q!=null&&String(q).trim()!==""&&Nt.push(`${ot}: ${String(q)}`)}let Gt=Nt.join("<br>"),Lt=ot=>{var q;ot.preventDefault(),u&&Tt?new me(Tt,r,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():bt(s,C,wt,ft!=null?ft:tt,(q=d.row.notes)!=null?q:[],i)},St=ot=>{wt&&Gt&&gt(s,w,wt,Gt,Kt,ot)},pt=()=>yt(w);if(d.groupKey!==Xt&&(Xt=d.groupKey,Xt!==m)){let ot=O+8+Ht*f+f/2,q=a(Xt);L(q,4,ot,I-12,11,"600"),Ht+=1}let xt=O+8+Ht*f,kt=f-10,Ut=at(F.getTime()),Rt=at(Q.getTime()),zt=Math.max(4,Rt-Ut),ct=d.fullName,lt=document.createElementNS(h.namespaceURI,"rect");lt.setAttribute("x",String(Ut)),lt.setAttribute("y",String(xt)),lt.setAttribute("width",String(zt)),lt.setAttribute("height",String(kt)),lt.setAttribute("rx","3"),lt.setAttribute("ry","3"),lt.setAttribute("fill",ut((De=d.row.series)!=null?De:ct,Ht)),lt.setAttribute("stroke","rgba(0,0,0,0.25)"),lt.setAttribute("stroke-width","0.5"),lt.style.cursor=u&&Tt?"pointer":"default",lt.addEventListener("mouseenter",St),lt.addEventListener("mouseleave",pt),lt.addEventListener("click",Lt),h.appendChild(lt);let Te=xt+kt/2;if(zt>=6){let ot=ut((Ee=d.row.series)!=null?Ee:ct,Ht),q=document.createElementNS(h.namespaceURI,"circle");q.setAttribute("cx",String(Ut)),q.setAttribute("cy",String(Te)),q.setAttribute("r","3.5"),q.setAttribute("fill","#ffffff"),q.setAttribute("stroke",ot),q.setAttribute("stroke-width","1.5"),h.appendChild(q);let It=document.createElementNS(h.namespaceURI,"circle");It.setAttribute("cx",String(Rt)),It.setAttribute("cy",String(Te)),It.setAttribute("r","3.5"),It.setAttribute("fill","#ffffff"),It.setAttribute("stroke",ot),It.setAttribute("stroke-width","1.5"),h.appendChild(It)}let Ce=xt+kt/2+2,qt=4;if(A==="wide")L(ct,qt,Ce,I-qt-4,11,null,St,pt,Lt);else{let ot=ct,q=Math.max(40,I-qt-8),Ne=Math.max(8,Math.floor(q/6));ot.length>Ne&&(ot=ot.slice(0,Ne-1)+"\u2026");let vt=document.createElementNS(h.namespaceURI,"text");vt.setAttribute("x",String(qt)),vt.setAttribute("y",String(Ce)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=ot,vt.style.cursor="pointer",vt.addEventListener("mouseenter",St),vt.addEventListener("mouseleave",pt),vt.addEventListener("click",Lt),h.appendChild(vt)}if(Ct instanceof Date){let ot=at(Ct.getTime()),q=document.createElementNS(h.namespaceURI,"line");q.setAttribute("x1",String(ot)),q.setAttribute("y1",String(xt)),q.setAttribute("x2",String(ot)),q.setAttribute("y2",String(xt+kt)),q.setAttribute("stroke","#ff6b6b"),q.setAttribute("stroke-width","2"),q.setAttribute("stroke-dasharray","4,2"),h.appendChild(q)}Ht+=1}if(u){let d=s.createDiv({cls:"prop-charts-empty"});d.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function fe(s,r,t){var I,z,J,p;let n=(I=r.options)!=null?I:{},e=n.background,o=(z=n.drilldown)!=null?z:!0,i=(J=t.rows)!=null?J:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:u,svg:a,tooltip:l,details:b}=At(s,e),D=s.getBoundingClientRect().width||600,y=Math.max(D,480);u.style.width=y+"px";let g=40,m=16,N=18,R=28,f=300;a.setAttribute("height",String(f));let k=y-g-m,M=f-N-R,E=new Map;for(let S of i){let h=String(S.x),w=(p=E.get(h))!=null?p:{label:S.x,rows:[]};w.rows.push(S),E.set(h,w)}let H=Array.from(E.keys()).sort((S,h)=>S<h?-1:S>h?1:0).map(S=>E.get(S)),x=H.length,T=new Set;i.forEach(S=>{S.series!=null&&T.add(String(S.series))});let c=Array.from(T),P=c.length>1,v=P?"grouped":"single",A=0;i.forEach(S=>{S.y>A&&(A=S.y)}),(!isFinite(A)||A<=0)&&(A=1);let $=S=>N+M-S/(A||1)*M,K=$(0),Y=4;for(let S=0;S<=Y;S++){let h=A*S/Y,w=$(h),C=document.createElementNS(a.namespaceURI,"line");C.setAttribute("x1",String(g)),C.setAttribute("y1",String(w)),C.setAttribute("x2",String(y-m)),C.setAttribute("y2",String(w)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),a.appendChild(C);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(g-4)),L.setAttribute("y",String(w+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(h)),a.appendChild(L)}let _=x>0?k/x:k;if(H.forEach((S,h)=>{let w=g+_*(h+.5),C=String(S.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(w)),L.setAttribute("y",String(f-R+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=C,a.appendChild(L)}),P){let S=s.createDiv({cls:"chart-notes-legend"});c.forEach((h,w)=>{let C=S.createDiv({cls:"chart-notes-legend-item"}),L=C.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=ut(h,w),C.createSpan({text:h})})}H.forEach((S,h)=>{let w=g+_*(h+.5),C=S.rows;if(v==="single"){let U=C[0],rt=U.y,O=_*.6,dt=w-O/2,st=$(rt),it=Math.max(2,K-st),at=ut("bar",h),W=document.createElementNS(a.namespaceURI,"rect");W.setAttribute("x",String(dt)),W.setAttribute("y",String(st)),W.setAttribute("width",String(O)),W.setAttribute("height",String(it)),W.setAttribute("fill",at),W.setAttribute("stroke","rgba(0,0,0,0.25)"),W.setAttribute("stroke-width","0.5"),W.style.cursor="pointer";let B=String(S.label),et=`valor: ${Math.round(rt*100)/100}`;W.addEventListener("mouseenter",Z=>{var X,mt;return gt(s,l,B,et,(mt=(X=U.notes)==null?void 0:X.length)!=null?mt:0,Z)}),W.addEventListener("mouseleave",()=>yt(l)),W.addEventListener("click",Z=>{var X;Z.preventDefault(),bt(s,b,B,rt,(X=U.notes)!=null?X:[],o)}),a.appendChild(W);return}let L=c.length,G=_/Math.max(L+1,2),nt=L*G,j=w-nt/2;c.forEach((U,rt)=>{let O=C.find(X=>(X.series!=null?String(X.series):"")===U);if(!O)return;let dt=O.y,st=j+rt*G,it=$(dt),at=Math.max(2,K-it),W=ut(U,rt),B=document.createElementNS(a.namespaceURI,"rect");B.setAttribute("x",String(st)),B.setAttribute("y",String(it)),B.setAttribute("width",String(G)),B.setAttribute("height",String(at)),B.setAttribute("fill",W),B.setAttribute("stroke","rgba(0,0,0,0.25)"),B.setAttribute("stroke-width","0.5"),B.style.cursor="pointer";let et=`${U} @ ${String(S.label)}`,Z=`valor: ${Math.round(dt*100)/100}`;B.addEventListener("mouseenter",X=>{var mt,Vt;return gt(s,l,et,Z,(Vt=(mt=O.notes)==null?void 0:mt.length)!=null?Vt:0,X)}),B.addEventListener("mouseleave",()=>yt(l)),B.addEventListener("click",X=>{var mt;X.preventDefault(),bt(s,b,et,dt,(mt=O.notes)!=null?mt:[],o)}),a.appendChild(B)})})}function He(s,r,t){var _,I,z,J;let n=(_=r.options)!=null?_:{},e=n.background,o=(I=n.drilldown)!=null?I:!0,i=(z=t.rows)!=null?z:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:u,svg:a,tooltip:l,details:b}=At(s,e),D=s.getBoundingClientRect().width||600,y=Math.max(D,480);u.style.width=y+"px";let g=40,m=16,N=18,R=28,f=300;a.setAttribute("height",String(f));let k=y-g-m,M=f-N-R,E=new Map;for(let p of i){let S=String(p.x),h=(J=E.get(S))!=null?J:{label:p.x,rows:[]};h.rows.push(p),E.set(S,h)}let H=Array.from(E.keys()).sort((p,S)=>p<S?-1:p>S?1:0).map(p=>E.get(p)),x=H.length,T=new Set;i.forEach(p=>{p.series!=null&&T.add(String(p.series))});let c=Array.from(T);if(!c.length){fe(s,r,t);return}let P=0;H.forEach(p=>{let S=p.rows.reduce((h,w)=>h+w.y,0);S>P&&(P=S)}),(!isFinite(P)||P<=0)&&(P=1);let v=p=>N+M-p/(P||1)*M,A=v(0),$=4;for(let p=0;p<=$;p++){let S=P*p/$,h=v(S),w=document.createElementNS(a.namespaceURI,"line");w.setAttribute("x1",String(g)),w.setAttribute("y1",String(h)),w.setAttribute("x2",String(y-m)),w.setAttribute("y2",String(h)),w.setAttribute("stroke","#cccccc"),w.setAttribute("stroke-opacity","0.25"),a.appendChild(w);let C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(g-4)),C.setAttribute("y",String(h+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=String(Math.round(S)),a.appendChild(C)}let K=x>0?k/x:k;H.forEach((p,S)=>{let h=g+K*(S+.5),w=String(p.label),C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(h)),C.setAttribute("y",String(f-R+12)),C.setAttribute("text-anchor","middle"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=w,a.appendChild(C)});let Y=s.createDiv({cls:"chart-notes-legend"});c.forEach((p,S)=>{let h=Y.createDiv({cls:"chart-notes-legend-item"}),w=h.createDiv();w.style.width="10px",w.style.height="10px",w.style.borderRadius="999px",w.style.backgroundColor=ut(p,S),h.createSpan({text:p})}),H.forEach((p,S)=>{let h=g+K*(S+.5),w=K*.6,C=h-w/2,L=0;c.forEach((G,nt)=>{let j=p.rows.find(Z=>(Z.series!=null?String(Z.series):"")===G);if(!j)return;let U=j.y,rt=L,O=L+U;L=O;let dt=v(rt),st=v(O),it=Math.max(2,dt-st),at=ut(G,nt),W=document.createElementNS(a.namespaceURI,"rect");W.setAttribute("x",String(C)),W.setAttribute("y",String(st)),W.setAttribute("width",String(w)),W.setAttribute("height",String(it)),W.setAttribute("fill",at),W.setAttribute("stroke","rgba(0,0,0,0.25)"),W.setAttribute("stroke-width","0.5"),W.style.cursor="pointer";let B=`${G} @ ${String(p.label)}`,et=`valor: ${Math.round(U*100)/100}`;W.addEventListener("mouseenter",Z=>{var X,mt;return gt(s,l,B,et,(mt=(X=j.notes)==null?void 0:X.length)!=null?mt:0,Z)}),W.addEventListener("mouseleave",()=>yt(l)),W.addEventListener("click",Z=>{var X;Z.preventDefault(),bt(s,b,B,U,(X=j.notes)!=null?X:[],o)}),a.appendChild(W)})})}function Wt(s){if(!s)return null;if(s instanceof Date){let r=s.getTime();return Number.isNaN(r)?null:s}if(typeof s=="string"){let r=s.trim();if(!r||/^\d+$/.test(r))return null;let t=new Date(r);if(!Number.isNaN(t.getTime()))return t}return null}function ge(s,r,t,n){var _,I,z,J;let e=(_=r.options)!=null?_:{},o=e.background,i=(I=e.drilldown)!=null?I:!0,u=(z=t.rows)!=null?z:[];if(!u.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:b,details:D}=At(s,o),y=s.getBoundingClientRect().width||600,g=Math.max(y,480);a.style.width=g+"px";let m=40,N=16,R=18,f=28,k=300;l.setAttribute("height",String(k));let M=g-m-N,E=k-R-f,V=u.map(p=>Wt(p.x)).filter(p=>!!p),H=V.length>=2&&V.length>=u.length*.6,x=new Map;for(let p of u){let S=p.series!=null&&p.series!==""?String(p.series):"__default__",h=(J=x.get(S))!=null?J:[];h.push(p),x.set(S,h)}let T=Array.from(x.keys()),c,P;if(H){let S=V.map(B=>B.getTime()).sort((B,et)=>B-et),h=S[0],w=S[S.length-1];h===w&&(h-=864e5,w+=864e5);let C=w-h||864e5,L=h-C*.02,G=w+C*.02;c=B=>{let et=Wt(B);if(!et)return m;let Z=et.getTime();return m+(Z-L)/(G-L||1)*M},P=B=>{let et=Wt(B);return et?Mt(et):String(B)};let nt=R+E,j=document.createElementNS(l.namespaceURI,"line");j.setAttribute("x1",String(m)),j.setAttribute("y1",String(nt)),j.setAttribute("x2",String(g-N)),j.setAttribute("y2",String(nt)),j.setAttribute("stroke","#111111"),j.setAttribute("stroke-width","1"),l.appendChild(j);let U=(G-L)/864e5,O=Math.max(3,Math.min(10,Math.floor(M/90)||3)),dt=U/O,st=[1,2,3,5,7,10,14,21,30,60,90,180,365],it=st[st.length-1];for(let B of st)if(B>=dt){it=B;break}let W=(B=>{let et=new Date(B);return et.setHours(0,0,0,0),et.getTime()})(L);for(let B=W;B<=G+.5*864e5;B+=it*864e5){let et=m+(B-L)/(G-L)*M,Z=document.createElementNS(l.namespaceURI,"line");Z.setAttribute("x1",String(et)),Z.setAttribute("y1",String(R)),Z.setAttribute("x2",String(et)),Z.setAttribute("y2",String(nt)),Z.setAttribute("stroke","#111111"),Z.setAttribute("stroke-opacity","0.18"),Z.setAttribute("stroke-dasharray","2,4"),l.appendChild(Z);let X=document.createElementNS(l.namespaceURI,"text");X.setAttribute("x",String(et)),X.setAttribute("y",String(nt+12)),X.setAttribute("text-anchor","middle"),X.setAttribute("font-size","10"),X.setAttribute("fill","#111111"),X.textContent=Mt(new Date(B)),l.appendChild(X)}}else{let p=[],S=new Set;for(let w of u){let C=String(w.x);S.has(C)||(S.add(C),p.push(w.x))}let h=p.length||1;c=w=>{let C=String(w),L=p.findIndex(G=>String(G)===C);return L<0?m:h===1?m+M/2:m+L/(h-1)*M},P=w=>String(w)}let v=Number.POSITIVE_INFINITY,A=Number.NEGATIVE_INFINITY;for(let p of u)p.y<v&&(v=p.y),p.y>A&&(A=p.y);(!isFinite(v)||!isFinite(A))&&(v=0,A=1),v===A&&(v===0?A=1:v=0);let $=p=>R+E-(p-v)/(A-v||1)*E,K=4;for(let p=0;p<=K;p++){let S=v+(A-v)*p/K,h=$(S),w=document.createElementNS(l.namespaceURI,"line");w.setAttribute("x1",String(m)),w.setAttribute("y1",String(h)),w.setAttribute("x2",String(g-N)),w.setAttribute("y2",String(h)),w.setAttribute("stroke","#cccccc"),w.setAttribute("stroke-opacity","0.25"),l.appendChild(w);let C=document.createElementNS(l.namespaceURI,"text");C.setAttribute("x",String(m-4)),C.setAttribute("y",String(h+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=Math.abs(S)>=100?String(Math.round(S)):String(Math.round(S*10)/10),l.appendChild(C)}let Y=T.filter(p=>p!=="__default__");if(Y.length>1){let p=s.createDiv({cls:"chart-notes-legend"});Y.forEach((S,h)=>{let w=S,C=p.createDiv({cls:"chart-notes-legend-item"}),L=C.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=ut(w,h),C.createSpan({text:w})})}T.forEach((p,S)=>{let h=x.get(p);if(!(h!=null&&h.length))return;let w=p==="__default__"?ut("line",S):ut(p,S),C=[...h];H&&C.sort((G,nt)=>{let j=Wt(G.x),U=Wt(nt.x),rt=j?j.getTime():0,O=U?U.getTime():0;return rt-O});let L="";if(C.forEach((G,nt)=>{let j=c(G.x),U=$(G.y);L+=(nt===0?"M ":" L ")+j+" "+U}),n){let G=C[0],nt=C[C.length-1],j=c(G.x),U=c(nt.x),rt=$(v);L+=` L ${U} ${rt} L ${j} ${rt} Z`;let O=document.createElementNS(l.namespaceURI,"path");O.setAttribute("d",L),O.setAttribute("fill",w),O.setAttribute("fill-opacity","0.18"),O.setAttribute("stroke",w),O.setAttribute("stroke-width","1.5"),l.appendChild(O)}else{let G=document.createElementNS(l.namespaceURI,"path");G.setAttribute("d",L),G.setAttribute("fill","none"),G.setAttribute("stroke",w),G.setAttribute("stroke-width","2"),l.appendChild(G)}C.forEach(G=>{let nt=c(G.x),j=$(G.y),U=document.createElementNS(l.namespaceURI,"circle");U.setAttribute("cx",String(nt)),U.setAttribute("cy",String(j)),U.setAttribute("r","3"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",w),U.setAttribute("stroke-width","1.5"),U.style.cursor="pointer";let rt=P(G.x),O=p==="__default__"?"":String(G.series),dt=O?`${O} @ ${rt}`:rt,st=`valor: ${Math.round(G.y*100)/100}`;U.addEventListener("mouseenter",it=>{var at,W;return gt(s,b,dt,st,(W=(at=G.notes)==null?void 0:at.length)!=null?W:0,it)}),U.addEventListener("mouseleave",()=>yt(b)),U.addEventListener("click",it=>{var at;it.preventDefault(),bt(s,D,dt,G.y,(at=G.notes)!=null?at:[],i)}),l.appendChild(U)})})}function Ge(s,r,t){var M;let{background:n,drilldown:e=!0}=(M=r.options)!=null?M:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=$e(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:u,svg:a,tooltip:l,details:b}=At(s,n),D=Math.max(i,420);u.style.width=D+"px",o&&(a.style.color=o);let y=300,g=D/2,m=(y-28+28)/2,N=Math.min(D/2-20,y/2-20),f=t.rows.map(E=>Math.max(0,E.y)).reduce((E,V)=>E+V,0)||1,k=-Math.PI/2;t.rows.forEach((E,V)=>{var _;let H=E.x instanceof Date?E.x.toISOString().slice(0,10):String(E.x),x=E.y,T=x/f*Math.PI*2,c=g+N*Math.cos(k),P=m+N*Math.sin(k),v=g+N*Math.cos(k+T),A=m+N*Math.sin(k+T),$=T>Math.PI?1:0,K=document.createElementNS(a.namespaceURI,"path"),Y=[`M ${g} ${m}`,`L ${c} ${P}`,`A ${N} ${N} 0 ${$} 1 ${v} ${A}`,"Z"].join(" ");K.setAttribute("d",Y),K.setAttribute("fill",ut((_=E.series)!=null?_:H,V)),K.style.cursor="pointer",K.addEventListener("mouseenter",I=>{var z,J;return gt(s,l,H,x,(J=(z=E.notes)==null?void 0:z.length)!=null?J:0,I)}),K.addEventListener("mouseleave",()=>yt(l)),K.addEventListener("click",()=>{var I;return bt(s,b,H,x,(I=E.notes)!=null?I:[],e)}),a.appendChild(K),k+=T})}function Be(s,r,t){var P;let{background:n,drilldown:e=!0}=(P=r.options)!=null?P:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:u,svg:a,tooltip:l,details:b}=At(s,n),D=Math.max(i,700);u.style.width=D+"px",o&&(a.style.color=o);let y=300,g=D-48-10,m=y-28-28,N=t.rows.map(v=>{let A=v.x;if(A instanceof Date)return A.getTime();if(typeof A=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(A)){let K=new Date(A);if(!isNaN(K.getTime()))return K.getTime()}let $=Number(A);return isNaN($)?null:$}return typeof A=="number"?A:null}),R=t.rows.map(v=>v.y),f=N.filter(v=>v!==null);if(f.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let k=Math.min(...f),M=Math.max(...f),E=Math.min(...R),V=Math.max(...R),H=v=>48+(v-k)/(M-k||1)*g,x=v=>y-28-(v-E)/(V-E||1)*m,T=document.createElementNS(a.namespaceURI,"line");T.setAttribute("x1",String(48)),T.setAttribute("y1",String(28)),T.setAttribute("x2",String(48)),T.setAttribute("y2",String(y-28)),T.setAttribute("stroke","currentColor"),a.appendChild(T);let c=document.createElementNS(a.namespaceURI,"line");c.setAttribute("x1",String(48)),c.setAttribute("y1",String(y-28)),c.setAttribute("x2",String(D-10)),c.setAttribute("y2",String(y-28)),c.setAttribute("stroke","currentColor"),a.appendChild(c),t.rows.forEach((v,A)=>{let $=N[A];if($==null)return;let K=H($),Y=x(R[A]),_=document.createElementNS(a.namespaceURI,"circle");_.setAttribute("cx",String(K)),_.setAttribute("cy",String(Y)),_.setAttribute("r","4"),_.setAttribute("fill",ut(v.series,A)),_.style.cursor="pointer";let I=v.x instanceof Date?v.x.toISOString().slice(0,10):typeof v.x=="string"?v.x:String(v.x);_.addEventListener("mouseenter",z=>{var J,p;return gt(s,l,I,v.y,(p=(J=v.notes)==null?void 0:J.length)!=null?p:0,z)}),_.addEventListener("mouseleave",()=>yt(l)),_.addEventListener("click",z=>{var J;z.preventDefault(),bt(s,b,I,v.y,(J=v.notes)!=null?J:[],e)}),a.appendChild(_)})}var ie=class{render(r,t,n,e){var a;let{title:o}=(a=t.options)!=null?a:{};r.empty(),r.addClass("prop-charts-container");let u=r.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(o&&(u.textContent=o),t.type){case"bar":fe(r,t,n);break;case"stacked-bar":He(r,t,n);break;case"line":ge(r,t,n,!1);break;case"area":ge(r,t,n,!0);break;case"pie":Ge(r,t,n);break;case"scatter":Be(r,t,n);break;case"gantt":se(r,t,n,e);break;default:r.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}}};var ae=class extends Qt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("Chart Notes: loading plugin (Bases-only)"),this.indexer=new te(this.app),await this.indexer.buildIndex(),this.query=new re(()=>this.indexer.getAll(),[]),this.renderer=new ie,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Qt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Qt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Qt.TFile&&this.indexer.removeFile(t)})),this.registerBasesView(de,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new Zt(t,n,this.renderer),options:()=>{let t=[];return t.push({type:"dropdown",key:"chartType",displayName:"Chart type",description:"Type of chart to render",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}}),t.push({type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",description:"Property used for the X axis or categories (for pie, this is the slice).",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")==="gantt"}}),t.push({type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:`Label for each task bar.
If empty, uses the note title.`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"yProperty",displayName:"Y value (empty = count)",description:`Numeric property summed on the Y axis.
Leave empty to just count notes.`,shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return e==="pie"||e==="gantt"}}),t.push({type:"property",key:"seriesProperty",displayName:"Series / color (optional)",description:"Property that defines series / color for bars, lines and area.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")==="pie"}}),t.push({type:"dropdown",key:"aggregateY",displayName:"Value aggregation (Y)",description:"How to aggregate Y values for line/area charts (normal sum or cumulative sum).",default:"sum",options:{sum:"Sum",cumulative:"Cumulative sum"},shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return!(e==="line"||e==="area")}}),t.push({type:"dropdown",key:"xBucket",displayName:"X bucket (dates)",description:"How to bucket dates on the X axis for line / area charts (day, week, month...).",default:"auto",options:{auto:"Auto",none:"None",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:n=>{var o;let e=String((o=n.get("chartType"))!=null?o:"bar");return!(e==="line"||e==="area")}}),t.push({type:"property",key:"startProperty",displayName:"Start (Gantt)",description:"Start date/datetime for the task.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"endProperty",displayName:"End (Gantt)",description:"End date/datetime for the task.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"dueProperty",displayName:"Due (deadline, optional)",description:"Due date / deadline for the task.",shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"property",key:"durationProperty",displayName:"Duration in minutes (optional)",description:`Duration of the task in minutes.
Used together with start/end/due.`,shouldHide:n=>{var e;return String((e=n.get("chartType"))!=null?e:"bar")!=="gantt"}}),t.push({type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0}),t.push({type:"text",key:"title",displayName:"Title (optional)",description:`Custom chart title.
Falls back to the view name.`}),t}})}onunload(){console.log("Chart Notes: unloading plugin")}};
