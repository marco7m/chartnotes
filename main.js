/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var Ye=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Oe=Object.prototype.hasOwnProperty;var Ue=(o,s)=>{for(var t in s)ce(o,t,{get:s[t],enumerable:!0})},Xe=(o,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of Ke(s))!Oe.call(o,n)&&n!==t&&ce(o,n,{get:()=>s[n],enumerable:!(e=Ye(s,n))||e.enumerable});return o};var qe=o=>Xe(ce({},"__esModule",{value:!0}),o);var pn={};Ue(pn,{default:()=>oe});module.exports=qe(pn);var It=require("obsidian");var Jt=require("obsidian");function ke(o,s){if(!s||s.length===0)return!0;for(let t of s){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Pe(o,s){if(!s||s.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let n of s)if(t.includes(n)||t.includes("#"+n))return!0;return!1}let e=String(t);for(let n of s)if(e===n||e==="#"+n)return!0;return!1}function qt(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function Rt(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,n]=o.split("-");return new Date(Number(t),Number(e)-1,Number(n),0,0,0,0)}let s=new Date(o);return isNaN(s.getTime())?null:s}function ut(o){let s=new Date(o);return s.setHours(0,0,0,0),s}function Xt(o,s){let t=new Date(o);return t.setDate(t.getDate()-s),t}function je(o,s){return Xt(o,s*7)}function Ze(o,s){let t=new Date(o);return t.setMonth(t.getMonth()-s),t}function de(o,s){let t=new Date(o);return t.setDate(t.getDate()+s),t}function Je(o,s){return de(o,s*7)}function tn(o,s){let t=new Date(o);return t.setMonth(t.getMonth()+s),t}function Re(o){let s=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(s)||s.endsWith("date")||s.endsWith("at")||s.endsWith("on"))}function Me(o,s){let t=s?new Date(s):new Date,e=ut(t),n=o.trim().toLowerCase();if(n==="today")return e;if(n==="yesterday")return ut(Xt(e,1));if(/^-\d+$/.test(n)){let r=parseInt(n.slice(1),10);return ut(Xt(e,r))}if(/^-\d+d$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(Xt(e,r))}if(/^-\d+w$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(je(e,r))}if(/^-\d+m$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(Ze(e,r))}if(/^\+\d+$/.test(n)){let r=parseInt(n.slice(1),10);return ut(de(e,r))}if(/^\+\d+d$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(de(e,r))}if(/^\+\d+w$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(Je(e,r))}if(/^\+\d+m$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(tn(e,r))}return null}function Le(o){let s=o.trim(),t=s.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let p=t[1].trim(),m=t[2].trim(),h=t[3].trim(),f=Re(p),S=ue(m,f),y=ue(h,f),E=S.valueType==="date"||y.valueType==="date"?"date":S.valueType;return{field:p,op:"between",value:S.value,value2:y.value,valueType:E}}let e=/(==|!=|>=|<=|>|<)/,n=s.split(e);if(n.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let r=n[0].trim(),i=n[1].trim(),c=n[2].trim(),a=Re(r),l=ue(c,a);return{field:r,op:i,value:l.value,valueType:l.valueType}}function ue(o,s){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),n=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(s){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(n){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(qt(t)){let i=Rt(t);if(i)return{value:i,valueType:"date"}}let r=Number(t);return Number.isNaN(r)?{value:t,valueType:"string"}:{value:r,valueType:"number"}}function Ie(o,s){let t=o[s.field];if(t==null)return!1;if(s.valueType==="date"){let r=t instanceof Date?ut(t):qt(t)?ut(Rt(t)):null;if(!r)return!1;let i=s.value instanceof Date?s.value:null,c=s.value2 instanceof Date?s.value2:null;if(!i)return!1;let a=r.getTime(),l=ut(i).getTime();switch(s.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!c)return!1;let p=ut(c).getTime();return a>=l&&a<=p}}if(s.valueType==="number"){let r=Number(t);if(isNaN(r))return!1;let i=Number(s.value);switch(s.op){case"==":return r===i;case"!=":return r!==i;case">":return r>i;case">=":return r>=i;case"<":return r<i;case"<=":return r<=i;case"between":return typeof s.value2!="number"?!1:r>=i&&r<=s.value2}}let e=String(t),n=String(s.value);switch(s.op){case"==":return e===n;case"!=":return e!==n;case">":return e>n;case">=":return e>=n;case"<":return e<n;case"<=":return e<=n;case"between":return!1}}var pe="chartnotes-view",en=["bar","stacked-bar","line","area","pie","scatter","gantt"];function nn(o){let s=String(o!=null?o:"bar").trim().toLowerCase();return en.includes(s)?s:"bar"}var rn=["normal","cumulative-sum"];function sn(o){let s=String(o!=null?o:"normal").trim().toLowerCase();return rn.includes(s)?s:"normal"}var jt="(missing)",Zt=class extends Jt.BasesView{constructor(t,e,n){super(t);this.type=pe;this.renderer=n,this.rootEl=e.createDiv("chartnotes-bases-view")}onDataUpdated(){var X,B,_;this.rootEl.empty();let t=this.data,e=(X=t==null?void 0:t.groupedData)!=null?X:[];if(!e.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let n=this.config,r=nn((B=n==null?void 0:n.get("chartType"))!=null?B:"bar"),i=r==="pie",c=r==="scatter",a=r==="gantt",l=sn(n==null?void 0:n.get("aggregateMode")),m=l==="cumulative-sum"&&!(r==="line"||r==="area")?"normal":l,h="auto",f=this.getPropFromConfig("xProperty"),S=this.getPropFromConfig("yProperty"),y=this.getPropFromConfig("seriesProperty");i&&(y={id:null,name:null});let E=this.getPropFromConfig("startProperty"),C=this.getPropFromConfig("endProperty"),w=this.getPropFromConfig("dueProperty"),F=this.getPropFromConfig("scheduledProperty"),N=this.getPropFromConfig("durationProperty"),H=this.getPropFromConfig("groupProperty");if(!a&&!f.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(c&&(!f.id||!S.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(E.id||C.id||F.id||w.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Scheduled/Due with Duration."});return}let $;if(a)$=this.buildRowsForGantt(e,f,y,E,C,w,F,N,H);else if(c)$=this.buildRowsForScatter(e,f,S,y);else{let O=i;$=this.buildRowsForAggregatedCharts(e,f,S,y,m,h,O)}if(!$.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let v={rows:$},d=((_=n==null?void 0:n.get("title"))!=null?_:"").trim()||(n==null?void 0:n.name)||"Chart Notes (Bases)",A=n==null?void 0:n.get("drilldown"),T=typeof A=="boolean"?A:!0,x=this.buildEncoding({x:f,y:S,series:y,start:E,end:C,due:w,duration:N,group:H,aggMode:m,xBucket:h,chartType:r}),k={type:r,source:{type:"properties",query:""},encoding:x,options:{title:d,drilldown:T}},V={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,k,v,V)}getPropFromConfig(t){var c,a;let e=this.config,n=(c=e==null?void 0:e.get)==null?void 0:c.call(e,t);if(!n)return{id:null,name:null};let r=n.trim();if(!r||r==="undefined"||r==="null")return{id:null,name:null};let i=r;try{let l=(0,Jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,e){if(!e.id)return null;let n;try{n=t.getValue(e.id)}catch(r){return null}if(!n)return null;try{if(typeof n.isEmpty=="function"&&n.isEmpty())return null}catch(r){}try{let r=n.toString();if(r==null)return null;let i=String(r).trim();return i.length?i:null}catch(r){return null}}parseDate(t){if(!t)return null;let e=t.trim();if(!e)return null;let n=Rt(e);if(n&&!Number.isNaN(n.getTime()))return n;let r=new Date(e);return Number.isNaN(r.getTime())?null:r}compareX(t,e){let n=this.parseDate(t),r=this.parseDate(e);if(n&&r)return n.getTime()-r.getTime();let i=Number(t),c=Number(e);return!Number.isNaN(i)&&!Number.isNaN(c)?i-c:String(t!=null?t:"").localeCompare(String(e!=null?e:""))}fmtDate(t){let e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${r}`}startOfWeek(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=(e.getDay()+6)%7;return e.setDate(e.getDate()-n),e.setHours(0,0,0,0),e}makeLocalDate(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate());return e.setHours(0,0,0,0),e}endOfDay(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999)}parseISODateLocal(t){let e=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;let n=Number(e[1]),r=Number(e[2])-1,i=Number(e[3]),c=new Date(n,r,i);return c.setHours(0,0,0,0),Number.isNaN(c.getTime())?null:c}parseDateLoose(t){if(t instanceof Date)return this.makeLocalDate(t);if(t==null)return null;let e=String(t).trim();if(!e)return null;let n=this.parseISODateLocal(e);if(n)return n;if(/^\d{4}-\d{2}-\d{2}T/.test(e)){let c=new Date(e);if(!Number.isNaN(c.getTime()))return this.makeLocalDate(c)}let r=e.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(r){let c=Number(r[1]),a=Number(r[2]),l=Number(r[3]);if(!(c>12)){let m=c;c=a,a=m}let p=new Date(l,a-1,c);return p.setHours(0,0,0,0),Number.isNaN(p.getTime())?null:p}let i=new Date(e);return Number.isNaN(i.getTime())?null:this.makeLocalDate(i)}readDate(t,e){if(!(e!=null&&e.id))return null;let n;try{n=t.getValue(e.id)}catch(r){return null}if(n==null)return null;try{if(typeof n.toDate=="function"){let r=n.toDate();if(r instanceof Date&&!Number.isNaN(r.getTime()))return this.makeLocalDate(r)}}catch(r){}try{if(typeof n.toISODate=="function"){let r=n.toISODate(),i=this.parseISODateLocal(String(r));if(i)return i}}catch(r){}if(n instanceof Date)return this.makeLocalDate(n);try{return this.parseDateLoose(n.toString())}catch(r){return null}}startOfMonth(t){let e=new Date(t.getFullYear(),t.getMonth(),1);return e.setHours(0,0,0,0),e}startOfQuarter(t){let e=Math.floor(t.getMonth()/3),n=new Date(t.getFullYear(),e*3,1);return n.setHours(0,0,0,0),n}startOfYear(t){let e=new Date(t.getFullYear(),0,1);return e.setHours(0,0,0,0),e}bucketX(t,e){let n=this.parseDate(t);if(!n||e==="none")return t;let r=new Date(n.getFullYear(),n.getMonth(),n.getDate());if(r.setHours(0,0,0,0),e==="auto"||e==="day")return r;switch(e){case"week":return this.startOfWeek(r);case"month":return this.startOfMonth(r);case"quarter":return this.startOfQuarter(r);case"year":return this.startOfYear(r);default:return r}}getXValuesForEntry(t,e,n,r){var p,m;let i=[],c=h=>this.bucketX(h,n);if(!e.id){let h=t.file,f=h!=null&&h.name?String(h.name):String((p=h==null?void 0:h.path)!=null?p:jt);return i.push(c(f)),i}if(!r){let h=(m=this.readValue(t,e))!=null?m:jt;return i.push(c(h)),i}let a=null;try{a=t.getValue(e.id)}catch(h){a=null}let l=h=>{if(!h)return;let f=String(h).trim();f&&i.push(c(f))};if(a==null)l(jt);else if(typeof a=="string"){let h=a.trim();if(h){let f=h.split(/\s+/);for(let S of f)l(S)}}else if(Array.isArray(a))for(let h of a){if(h==null)continue;let f;try{f=h.toString()}catch(S){continue}l(f)}else if(typeof a.toArray=="function"){let h=a.toArray();if(Array.isArray(h))for(let f of h){if(f==null)continue;let S;try{S=f.toString()}catch(y){continue}l(S)}else{let f;try{f=a.toString()}catch(S){f=""}l(f)}}else{let h;try{h=a.toString()}catch(f){h=""}l(h)}return i.length||l(jt),i}buildRowsForAggregatedCharts(t,e,n,r,i,c,a){let l=new Map,p=a||!n.id,m=n.name||"y";for(let f of t)for(let S of f.entries){let y=S.file,E=this.getXValuesForEntry(S,e,c,a),C=1,w=null;if(!p&&n.id){if(w=this.readValue(S,n),w==null)continue;let H=Number(w);if(Number.isNaN(H))continue;C=H}else C=1;let F=this.readValue(S,r),N=F!=null?String(F):void 0;for(let H of E){let $=`${H}@@${N!=null?N:""}`,v=l.get($);if(v||(v={x:H,y:0,series:N,notes:[],props:{}},l.set($,v)),v.y+=C,y!=null&&y.path&&v.notes.push(y.path),v.props&&e.name){let D=H instanceof Date?this.fmtDate(H):String(H);v.props[e.name]=D}v.props&&m&&(v.props[m]=v.y),v.props&&r.name&&F!=null&&(v.props[r.name]=F)}}let h=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(h):h}toCumulative(t){var r,i;let e=new Map;for(let c of t){let a=(r=c.series)!=null?r:"__no_series__",l=e.get(a);l||(l=[],e.set(a,l)),l.push(c)}let n=[];for(let[,c]of e){let a=[...c].sort((p,m)=>this.compareX(p.x,m.x)),l=0;for(let p of a){let m=Number((i=p.y)!=null?i:0);Number.isNaN(m)||(l+=m,n.push({...p,y:l}))}}return n}buildRowsForScatter(t,e,n,r){let i=[];for(let c of t)for(let a of c.entries){let l=a.file,p=this.readValue(a,e),m=this.readValue(a,n);if(p==null||m==null)continue;let h=Number(p),f=Number(m);if(Number.isNaN(h)||Number.isNaN(f))continue;let S=this.readValue(a,r),y=S!=null?String(S):void 0;i.push({x:h,y:f,series:y,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,e,n,r,i,c,a,l,p){var h,f;let m=[];for(let S of t)for(let y of S.entries){let E=y.file,C=this.readValue(y,r),w=this.readValue(y,i),F=this.readValue(y,c),N=this.readValue(y,a),H=this.readValue(y,l),$=H!=null?Number(H):NaN,v=Number.isFinite($),D=this.parseDate(C),d=this.parseDate(w),A=this.parseDate(F),T=this.parseDate(N),x=d||T||A||null,k=D;if(!k&&v&&x&&(k=new Date(x.getTime()-$*6e4)),!x&&k&&v&&(x=new Date(k.getTime()+$*6e4)),!k||!x)continue;let V=new Date(k.getFullYear(),k.getMonth(),k.getDate(),0,0,0,0),X=new Date(x.getFullYear(),x.getMonth(),x.getDate(),23,59,59,999),B=(f=this.readValue(y,e))!=null?f:E!=null&&E.name?String(E.name).replace(/\.md$/i,""):String((h=E==null?void 0:E.path)!=null?h:""),_=this.readValue(y,n),O=_!=null?String(_):void 0,j=this.readValue(y,p),L={};v&&l.name&&(L[l.name]=$),p.name&&j!=null&&(L[p.name]=j),n.name&&_!=null&&(L[n.name]=_),m.push({x:B,y:0,series:O,start:V,end:X,due:A!=null?A:void 0,notes:E!=null&&E.path?[E.path]:[],props:L})}return m}buildEncoding(t){var r,i,c,a,l,p,m,h;let e=(r=t.x.name)!=null?r:"x",n=(i=t.y.name)!=null?i:"y";return{x:e,y:n,series:(c=t.series.name)!=null?c:"series",start:(a=t.start.name)!=null?a:"start",end:(l=t.end.name)!=null?l:"end",due:(p=t.due.name)!=null?p:"due",duration:(m=t.duration.name)!=null?m:"duration",group:(h=t.group.name)!=null?h:"group"}}};var Fe=require("obsidian"),te=class{constructor(s){this.index=new Map;this.app=s}async buildIndex(){this.index.clear();let s=this.app.vault.getMarkdownFiles();for(let t of s)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(s){if(s.extension!=="md")return;let t={};try{let n=(await this.app.vault.read(s)).match(/^---\n([\s\S]*?)\n---\n?/);if(n){let i=(0,Fe.parseYaml)(n[1])||{};if(i&&typeof i=="object")for(let[c,a]of Object.entries(i))c!=="position"&&(t[c]=a)}let r=this.app.metadataCache.getFileCache(s);r!=null&&r.tags&&!t.tags&&(t.tags=r.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",s.path,e)}this.index.set(s.path,{path:s.path,props:t})}removeFile(s){this.index.delete(s.path)}};function on(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(qt(o)){let s=Rt(o);if(s)return{key:s,isDate:!0}}return{key:o,isDate:!1}}function an(o,s){let t=o.x,e=s.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let n=String(t),r=String(e);return n<r?-1:n>r?1:0}function ln(o,s){var r,i;let t=an(o,s);if(t!==0)return t;let e=(r=o.series)!=null?r:"",n=(i=s.series)!=null?i:"";return e<n?-1:e>n?1:0}function cn(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let s=o.trim().match(/^(\d+)/);if(s){let t=Number(s[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function un(o){var e,n;let s=new Map,t=[];for(let r of o){let i=(e=r.series)!=null?e:"__no_series__",a=((n=s.get(i))!=null?n:0)+r.y;s.set(i,a),t.push({...r,y:a})}return t}function dn(o,s){var i,c;let t=cn(s);if(!t||t<=1)return[...o];let e=new Map,n=new Map,r=[];for(let a of o){let l=(i=a.series)!=null?i:"__no_series__",p=e.get(l);p||(p=[],e.set(l,p));let m=(c=n.get(l))!=null?c:0;if(p.push(a.y),m+=a.y,p.length>t){let S=p.shift();m-=S}n.set(l,m);let h=p.length||1,f=m/h;r.push({...a,y:f})}return r}var ee=class{constructor(s,t){this.getIndex=s,this.defaultPaths=t}run(s){var i,c,a;let t=this.getIndex(),e=(i=s.source)!=null&&i.paths&&s.source.paths.length?s.source.paths:this.defaultPaths,n=(c=s.source)!=null&&c.tags&&s.source.tags.length?s.source.tags:[],r=[];for(let l of t){let p=e&&e.length?ke(l.path,e):!0,m=n&&n.length?Pe(l.props,n):!0;if(!p||!m)continue;let h=!0;if((a=s.source)!=null&&a.where&&s.source.where.length>0)for(let f of s.source.where){let S;try{S=Le(f)}catch(y){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${f} (${y.message})`)}if(!Ie(l.props,S)){h=!1;break}}h&&r.push(l)}return s.type==="gantt"?this.runGantt(s,r):s.type==="table"?this.runTable(s,r):this.runStandard(s,r)}runTable(s,t){var n,r;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(n=s.encoding)==null?void 0:n.x,yField:(r=s.encoding)==null?void 0:r.y}}runGantt(s,t){var m,h,f;let e=(m=s.encoding)!=null?m:{},n=e.start,r=e.end,i=(h=e.label)!=null?h:e.x,c=e.series,a=e.duration,l=e.due,p=[];for(let S of t){let y=(f=S.props)!=null?f:{},E=v=>Array.isArray(v)?v[0]:v,C=null;if(r){let v=E(y[r]),D=Rt(v);D&&(C=D)}if(!C)continue;let w=null;if(n){let v=E(y[n]),D=Rt(v);D&&(w=D)}if(!w&&a){let v=E(y[a]),D=Number(v);Number.isNaN(D)||(w=new Date(C.getTime()-D*6e4))}w||(w=new Date(C.getTime()));let F;if(l){let v=E(y[l]),D=Rt(v);D&&(F=D)}let N;if(i){let v=E(y[i]);(v==null||v==="")&&(v=S.path),N=v}else N=S.path;let H;if(c){let v=E(y[c]);v!=null&&(H=String(v))}let $={x:N,y:0,notes:[S.path],series:H,start:w,end:C,props:y};F&&($.due=F),p.push($)}return p.sort((S,y)=>{let E=S.start?S.start.getTime():0,C=y.start?y.start.getTime():0;return E-C}),{rows:p,xField:i,yField:r}}runStandard(s,t){var S,y,E,C,w,F,N,H,$,v;let e=(S=s.encoding)==null?void 0:S.x,n=(y=s.encoding)==null?void 0:y.y,r=(E=s.encoding)==null?void 0:E.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(C=s.aggregate)!=null?C:{},c=(w=i.y)!=null?w:null,a=!!i.cumulative,l=i.rolling;if(!n&&c!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let p=[];for(let D of t){let d=(F=D.props)!=null?F:{},A=_=>Array.isArray(_)?_[0]:_,T=A(d[e]);if(T==null)continue;let x=on(T),k=x.key,V=x.isDate,X;if(r){let _=A(d[r]);_!=null&&String(_).trim()!==""&&(X=String(_))}let B;if(c==="count")B=1;else{let _=A(d[n]);if(_==null)continue;let O=Number(_);if(Number.isNaN(O))continue;B=O}p.push({x:k,y:B,notes:[D.path],series:X,props:d,_isDate:V,_origX:T})}if(p.length===0)return{rows:[],xField:e,yField:n};let m=[];if(c){let D=new Map;for(let d of p){let A=(N=d.series)!=null?N:"",T=d.x instanceof Date?d.x.toISOString().slice(0,10):String(d.x),x=A+"||"+T,k=(H=D.get(x))!=null?H:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:d.x,isDate:d._isDate,series:d.series,props:d.props};k.sum+=d.y,k.count+=1,d.y<k.min&&(k.min=d.y),d.y>k.max&&(k.max=d.y),k.notes.push(...d.notes),k.props=($=d.props)!=null?$:k.props,D.set(x,k)}for(let[,d]of D){let A=d.sum;switch(c){case"sum":A=d.sum;break;case"avg":A=d.sum/d.count;break;case"min":A=d.min;break;case"max":A=d.max;break;case"count":A=d.count;break}m.push({x:d.xRep,y:A,notes:d.notes,series:d.series,props:d.props})}}else m=p.map(D=>({x:D.x,y:D.y,notes:D.notes,series:D.series,props:D.props}));if(m.length===0)return{rows:[],xField:e,yField:n};let h=((v=s.sort)==null?void 0:v.x)==="desc"?"desc":"asc";if(m.sort((D,d)=>{let A=ln(D,d);return h==="asc"?A:-A}),(a||l)&&!(s.type==="line"||s.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let f=m;return l?f=dn(m,l):a&&(f=un(m)),{rows:f,xField:e,yField:n}}};var Ct=require("obsidian");var _e=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,s){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,n)=>e*33+n.charCodeAt(0)>>>0,0);return _e[t%_e.length]}function wt(o,s){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,s&&(e.style.background=s);let n="http://www.w3.org/2000/svg",r=document.createElementNS(n,"svg");r.setAttribute("width","100%"),r.setAttribute("height",String(300)),r.style.display="block",e.appendChild(r);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let c=o.createDiv({cls:"chart-notes-details"});return c.style.display="none",{scroll:t,inner:e,svg:r,tooltip:i,details:c}}function mt(o,s,t,e,n,r){let i=o.getBoundingClientRect(),c=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);s.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${c}</div>
    <div class="chart-notes-tooltip-notes">${n} nota${n===1?"":"s"}</div>
  `,s.style.display="block";let a=s.getBoundingClientRect(),l=r.clientX-i.left+6,p=r.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),p+a.height>i.height-4&&(p=i.height-a.height-4),p<4&&(p=4),s.style.left=l+"px",s.style.top=p+"px"}function gt(o){o.style.display="none"}function yt(o,s,t,e,n,r){if(!r)return;if(s.empty(),!n||n.length===0){s.style.display="none";return}s.style.display="block";let i=s.createEl("div",{cls:"chart-notes-details-header"}),c=i.createEl("div",{cls:"chart-notes-details-title"});c.textContent=`Notas em "${t}" (${n.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{s.style.display="none"});let l=s.createEl("ul",{cls:"chart-notes-details-list"});for(let p of n){let h=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:p});h.href="#",h.addEventListener("click",f=>{f.preventDefault(),app.workspace.openLinkText(p,"",!1)})}}function Gt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let s=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${s}/${t}`}function $e(o){if(!o)return!1;let s=o.trim().toLowerCase();if(s==="#fff"||s==="#ffffff"||s==="white")return!0;if(!s.startsWith("#"))return!1;let t,e,n;if(s.length===4)t=parseInt(s[1]+s[1],16),e=parseInt(s[2]+s[2],16),n=parseInt(s[3]+s[3],16);else if(s.length===7)t=parseInt(s.slice(1,3),16),e=parseInt(s.slice(3,5),16),n=parseInt(s.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*n)/255>.7}var he=class extends Ct.Modal{constructor(t,e,n,r){var c;super(app);this.notePath=t,this.spec=e,this.refresh=n,this.reindexFile=r;let i=(c=e.encoding)!=null?c:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var v,D;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let n=await this.app.vault.read(e),r={},i=n,c=/^---\n([\s\S]*?)\n---\n?/m.exec(n);if(c){try{r=(v=(0,Ct.parseYaml)(c[1]))!=null?v:{}}catch(d){r={}}i=n.slice(c[0].length)}(typeof r!="object"||r==null)&&(r={});let a=(D=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?D:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),p=l.createEl("a",{text:a,cls:"gantt-edit-title"});p.href="#",p.addEventListener("click",d=>{d.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let m=l.createDiv({cls:"gantt-edit-subtitle"});m.textContent=this.notePath;let h=t.createDiv({cls:"gantt-edit-form"}),f=d=>{let A=h.createDiv({cls:"gantt-edit-row"}),T=A.createDiv({cls:"gantt-edit-label"});T.textContent=d;let x=A.createDiv({cls:"gantt-edit-field"});return{row:A,field:x}},S=d=>{if(!d)return"";let T=String(d).match(/^(\d{4}-\d{2}-\d{2})/);return T?T[1]:""},y=d=>{if(d=d.trim(),!!d&&/^\d{4}-\d{2}-\d{2}$/.test(d))return d},E=null;if(this.startKey){let{field:d}=f(this.startKey+" (in\xEDcio)");E=d.createEl("input",{type:"date"}),E.value=S(r[this.startKey])}let C=null;if(this.endKey){let{field:d}=f(this.endKey+" (fim)");C=d.createEl("input",{type:"date"}),C.value=S(r[this.endKey])}let w=null;if(this.durationKey){let{field:d}=f(this.durationKey+" (minutos)");w=d.createEl("input",{type:"number"});let A=r[this.durationKey];w.value=A!=null?String(A):"",w.min="0",w.step="5"}let F=null;if(this.dueKey){let{field:d}=f(this.dueKey+" (due)");F=d.createEl("input",{type:"date"}),F.value=S(r[this.dueKey])}let N=t.createDiv({cls:"gantt-edit-buttons"}),H=N.createEl("button",{text:"Salvar",cls:"mod-cta"});N.createEl("button",{text:"Cancelar"}).addEventListener("click",d=>{d.preventDefault(),this.close()}),H.addEventListener("click",async d=>{if(d.preventDefault(),this.startKey&&E){let x=y(E.value);x?r[this.startKey]=x:delete r[this.startKey]}if(this.endKey&&C){let x=y(C.value);x?r[this.endKey]=x:delete r[this.endKey]}if(this.durationKey&&w){let x=w.value.trim();if(x==="")delete r[this.durationKey];else{let k=Number(x);Number.isNaN(k)||(r[this.durationKey]=k)}}if(this.dueKey&&F){let x=y(F.value);x?r[this.dueKey]=x:delete r[this.dueKey]}let T=`---
${(0,Ct.stringifyYaml)(r).trim()}
---
`+i;if(await this.app.vault.modify(e,T),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(x){}if(this.refresh)try{this.refresh()}catch(x){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(o,s,t,e){var be,xe,Se,ve,we,De,Ae,Ee;let n=(be=s.options)!=null?be:{},r=n.background,i=(xe=n.drilldown)!=null?xe:!0,c=!0,a=u=>{if(u==null)return"";let P=String(u).trim();if(!P)return"";let Q=P.match(/^\[\[(.+?)\]\]$/);Q&&(P=Q[1]);let U=P.lastIndexOf("/");return U>=0&&U<P.length-1&&(P=P.slice(U+1)),P};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(u=>u.start&&u.end);if(l.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let p=s.encoding,m=p.group,h=p.duration,f=(u,P)=>{if(!u||!P)return;let Q=u[P];return Array.isArray(Q)?Q[0]:Q},y=l.map(u=>{var xt,ct;let P=u.start,Q=u.end,U=u.props,Ft=typeof u.x=="string"?u.x:u.x instanceof Date?Gt(P):String(u.x),Dt=a(Ft),bt,_t=m?f(U,m):void 0;_t!=null?bt=String(_t):u.series!=null?bt=String(u.series):bt=Dt;let ft=(xt=u.notes)==null?void 0:xt[0],At=ft?(ct=ft.replace(/\.md$/i,"").split("/").pop())!=null?ct:ft:Dt,Nt=u.due,$t,Pt=f(U,h);if(Pt!=null){let St=Number(Pt);Number.isNaN(St)||($t=St)}return{row:u,start:P,end:Q,props:U,fullName:Dt,groupKey:bt,notePath:ft,noteTitle:At,due:Nt,estMinutes:$t}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(y.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}y.sort((u,P)=>{if(u.groupKey<P.groupKey)return-1;if(u.groupKey>P.groupKey)return 1;let Q=u.start.getTime(),U=P.start.getTime();return Q!==U?Q-U:u.fullName.localeCompare(P.fullName)});let E=26,C=0,w=null;for(let u of y)u.groupKey!==w&&(w=u.groupKey,C+=1),C+=1;let F=Math.min(...y.map(u=>u.start.getTime())),N=Math.max(...y.map(u=>u.end.getTime()));if(!isFinite(F)||!isFinite(N)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let H=24*60*60*1e3,$=u=>{let P=new Date(u);return P.setHours(0,0,0,0),P.getTime()},v=$(F),D=$(N),d=o.querySelector(".prop-charts-title-row");d||(d=o.createDiv({cls:"prop-charts-title-row"}));let A=o.dataset.ganttZoomMode||String((Se=n.zoomMode)!=null?Se:"100");o.dataset.ganttZoomMode=A;let T=o.dataset.ganttLabelMode||String((ve=n.labelMode)!=null?ve:"compact");o.dataset.ganttLabelMode=T;let x=d.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let P=x.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===A&&P.addClass("is-active"),P.addEventListener("click",Q=>{Q.preventDefault(),o.dataset.ganttZoomMode=u.id,ne(o,s,t,e)})}),x.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let P=o.querySelector(".chart-notes-zoom-button");P&&P.click()});let X=Number(n.labelWidth),B=!Number.isNaN(X)&&X>120?X:260,_=T==="wide"?B+160:B,O=o.getBoundingClientRect().width||600,j=Math.max(O,820),L;if(A==="fit")L=O;else{let u=Number(A)/100||1;L=j*u}let{inner:g,svg:b,tooltip:R,details:M}=wt(o,r);g.style.width=L+"px";let I=(u,P,Q,U,Ft,Dt,bt,_t,ft)=>{if(!u)return;let At=Math.max(40,U-8),$t=Math.max(8,Math.floor(At/6)),Pt=u.split(/\s+/),xt=[],ct="";for(let Tt of Pt){if(!ct){ct=Tt;continue}(ct+" "+Tt).length<=$t?ct+=" "+Tt:(xt.push(ct),ct=Tt)}ct&&xt.push(ct);let St=Ft+2,Bt=xt.length*St,Wt=Q-Bt/2+Ft;xt.forEach((Tt,Ot)=>{let ot=document.createElementNS(b.namespaceURI,"text");ot.setAttribute("x",String(P)),ot.setAttribute("y",String(Wt+Ot*St)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(Ft)),ot.setAttribute("fill","#111111"),Dt&&ot.setAttribute("font-weight",Dt),ot.textContent=Tt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),_t&&ot.addEventListener("mouseleave",()=>_t()),ft&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>ft(rt))),b.appendChild(ot)})},tt=28,z=28,st=10,q=Math.max(300,tt+z+C*E+24);b.setAttribute("height",String(q));let W=L-_-st,Y=tt+6;b.style.color="#111111";let et=D+H-v||1,at=v-et*.02,ht=D+H+et*.08,lt=u=>_+(u-at)/(ht-at)*W,G=(ht-at)/H,kt=Math.max(4,Math.min(12,Math.floor(W/90)||4)),dt=G/kt,J=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=J[J.length-1];for(let u of J)if(u>=dt){pt=u;break}let zt=[],Ve=$(at);for(let u=Ve;u<=ht+.5*H;u+=pt*H)zt.push(u);let Ht=document.createElementNS(b.namespaceURI,"line");Ht.setAttribute("x1",String(_)),Ht.setAttribute("y1",String(Y)),Ht.setAttribute("x2",String(L-st)),Ht.setAttribute("y2",String(Y)),Ht.setAttribute("stroke","#111111"),b.appendChild(Ht);for(let u of zt){let P=lt(u),Q=document.createElementNS(b.namespaceURI,"line");Q.setAttribute("x1",String(P)),Q.setAttribute("y1",String(Y)),Q.setAttribute("x2",String(P)),Q.setAttribute("y2",String(q-z)),Q.setAttribute("stroke","#111111"),Q.setAttribute("stroke-opacity","0.20"),Q.setAttribute("stroke-dasharray","2,4"),b.appendChild(Q);let U=document.createElementNS(b.namespaceURI,"text");U.setAttribute("x",String(P)),U.setAttribute("y",String(Y-4)),U.setAttribute("text-anchor","middle"),U.setAttribute("font-size","10"),U.setAttribute("fill","#111111"),U.textContent=Gt(new Date(u)),b.appendChild(U)}let ye=new Date;ye.setHours(0,0,0,0);let ie=ye.getTime();if(ie>=at&&ie<=ht){let u=lt(ie),P=document.createElementNS(b.namespaceURI,"line");P.setAttribute("x1",String(u)),P.setAttribute("y1",String(Y)),P.setAttribute("x2",String(u)),P.setAttribute("y2",String(q-z)),P.setAttribute("stroke","#4caf50"),P.setAttribute("stroke-width","2"),P.setAttribute("stroke-dasharray","4,2"),b.appendChild(P);let Q=document.createElementNS(b.namespaceURI,"text");Q.setAttribute("x",String(u+4)),Q.setAttribute("y",String(Y+12)),Q.setAttribute("font-size","10"),Q.setAttribute("fill","#4caf50"),Q.textContent="hoje",b.appendChild(Q)}let Kt=g.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Kt.setAttr("title",T==="wide"?"Compactar nomes":"Expandir nomes"),Kt.style.left=`${_}px`,Kt.style.top="4px",Kt.addEventListener("click",u=>{u.preventDefault();let Q=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=Q,ne(o,s,t,e)});let ze=["status","priority"],ae=Array.isArray(n.tooltipFields)?n.tooltipFields.map(u=>String(u)):null,We=ae&&ae.length?ae:ze,Qt=0,le=null;for(let u of y){let P=u.start,Q=u.end,U=(Q.getTime()-P.getTime())/6e4,Ft=u.props,Dt=u.notePath,bt=u.noteTitle,_t=(De=(we=u.row.notes)==null?void 0:we.length)!=null?De:0,ft=u.due,At=u.estMinutes,Nt=[];Nt.push(`${Gt(P)} \u2192 ${Gt(Q)}`),typeof At=="number"&&!Number.isNaN(At)?Nt.push(`est: ${Math.round(At)} min`):U>0&&Nt.push(`dura\xE7\xE3o: ${Math.round(U)} min`),ft instanceof Date&&Nt.push(`due: ${Gt(ft)}`);for(let nt of We){let K=f(Ft,nt);K!=null&&String(K).trim()!==""&&Nt.push(`${nt}: ${String(K)}`)}let $t=Nt.join("<br>"),Pt=nt=>{var K;nt.preventDefault(),c&&Dt?new he(Dt,s,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(o,M,bt,At!=null?At:U,(K=u.row.notes)!=null?K:[],i)},xt=nt=>{bt&&$t&&mt(o,R,bt,$t,_t,nt)},ct=()=>gt(R);if(u.groupKey!==le){le=u.groupKey;let nt=Y+8+Qt*E+E/2,K=a(le);I(K,4,nt,_-12,11,"600"),Qt+=1}let St=Y+8+Qt*E,Bt=E-10,Wt=lt(P.getTime()),Tt=lt(Q.getTime()),Ot=Math.max(4,Tt-Wt),ot=u.fullName,rt=document.createElementNS(b.namespaceURI,"rect");rt.setAttribute("x",String(Wt)),rt.setAttribute("y",String(St)),rt.setAttribute("width",String(Ot)),rt.setAttribute("height",String(Bt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=u.row.series)!=null?Ae:ot,Qt)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=c&&Dt?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",ct),rt.addEventListener("click",Pt),b.appendChild(rt);let Ce=St+Bt/2;if(Ot>=6){let nt=it((Ee=u.row.series)!=null?Ee:ot,Qt),K=document.createElementNS(b.namespaceURI,"circle");K.setAttribute("cx",String(Wt)),K.setAttribute("cy",String(Ce)),K.setAttribute("r","3.5"),K.setAttribute("fill","#ffffff"),K.setAttribute("stroke",nt),K.setAttribute("stroke-width","1.5"),b.appendChild(K);let Lt=document.createElementNS(b.namespaceURI,"circle");Lt.setAttribute("cx",String(Tt)),Lt.setAttribute("cy",String(Ce)),Lt.setAttribute("r","3.5"),Lt.setAttribute("fill","#ffffff"),Lt.setAttribute("stroke",nt),Lt.setAttribute("stroke-width","1.5"),b.appendChild(Lt)}let Ne=St+Bt/2+2,Ut=m?16:4;if(T==="wide")I(ot,Ut,Ne,_-Ut-4,11,null,xt,ct,Pt);else{let nt=ot,K=Math.max(40,_-Ut-8),Te=Math.max(8,Math.floor(K/6));nt.length>Te&&(nt=nt.slice(0,Te-1)+"\u2026");let vt=document.createElementNS(b.namespaceURI,"text");vt.setAttribute("x",String(Ut)),vt.setAttribute("y",String(Ne)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",xt),vt.addEventListener("mouseleave",ct),vt.addEventListener("click",Pt),b.appendChild(vt)}if(ft instanceof Date){let nt=lt(ft.getTime()),K=document.createElementNS(b.namespaceURI,"line");K.setAttribute("x1",String(nt)),K.setAttribute("y1",String(St)),K.setAttribute("x2",String(nt)),K.setAttribute("y2",String(St+Bt)),K.setAttribute("stroke","#ff6b6b"),K.setAttribute("stroke-width","2"),K.setAttribute("stroke-dasharray","4,2"),b.appendChild(K)}Qt+=1}if(c){let u=o.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function fe(o,s,t){var _,O,j,L;let e=(_=s.options)!=null?_:{},n=e.background,r=(O=e.drilldown)!=null?O:!0,i=(j=t.rows)!=null?j:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:c,svg:a,tooltip:l,details:p}=wt(o,n),m=o.getBoundingClientRect().width||600,h=Math.max(m,480);c.style.width=h+"px";let f=40,S=16,y=18,E=28,C=300;a.setAttribute("height",String(C));let w=h-f-S,F=C-y-E,N=new Map;for(let g of i){let b=String(g.x),R=(L=N.get(b))!=null?L:{label:g.x,rows:[]};R.rows.push(g),N.set(b,R)}let $=Array.from(N.keys()).sort((g,b)=>g<b?-1:g>b?1:0).map(g=>N.get(g)),v=$.length,D=new Set;i.forEach(g=>{g.series!=null&&D.add(String(g.series))});let d=Array.from(D),A=d.length>1,T=A?"grouped":"single",x=0;i.forEach(g=>{g.y>x&&(x=g.y)}),(!isFinite(x)||x<=0)&&(x=1);let k=g=>y+F-g/(x||1)*F,V=k(0),X=4;for(let g=0;g<=X;g++){let b=x*g/X,R=k(b),M=document.createElementNS(a.namespaceURI,"line");M.setAttribute("x1",String(f)),M.setAttribute("y1",String(R)),M.setAttribute("x2",String(h-S)),M.setAttribute("y2",String(R)),M.setAttribute("stroke","#cccccc"),M.setAttribute("stroke-opacity","0.25"),a.appendChild(M);let I=document.createElementNS(a.namespaceURI,"text");I.setAttribute("x",String(f-4)),I.setAttribute("y",String(R+3)),I.setAttribute("text-anchor","end"),I.setAttribute("font-size","10"),I.setAttribute("fill","#111111"),I.textContent=String(Math.round(b)),a.appendChild(I)}let B=v>0?w/v:w;if($.forEach((g,b)=>{let R=f+B*(b+.5),M=String(g.label),I=document.createElementNS(a.namespaceURI,"text");I.setAttribute("x",String(R)),I.setAttribute("y",String(C-E+12)),I.setAttribute("text-anchor","middle"),I.setAttribute("font-size","10"),I.setAttribute("fill","#111111"),I.textContent=M,a.appendChild(I)}),A){let g=o.createDiv({cls:"chart-notes-legend"});d.forEach((b,R)=>{let M=g.createDiv({cls:"chart-notes-legend-item"}),I=M.createDiv();I.style.width="10px",I.style.height="10px",I.style.borderRadius="999px",I.style.backgroundColor=it(b,R),M.createSpan({text:b})})}$.forEach((g,b)=>{let R=f+B*(b+.5),M=g.rows;if(T==="single"){let q=M[0],W=q.y,Y=B*.6,et=R-Y/2,at=k(W),ht=Math.max(2,V-at),lt=it("bar",b),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(et)),G.setAttribute("y",String(at)),G.setAttribute("width",String(Y)),G.setAttribute("height",String(ht)),G.setAttribute("fill",lt),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let Z=String(g.label),kt=`valor: ${Math.round(W*100)/100}`;G.addEventListener("mouseenter",dt=>{var J,pt;return mt(o,l,Z,kt,(pt=(J=q.notes)==null?void 0:J.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>gt(l)),G.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(o,p,Z,W,(J=q.notes)!=null?J:[],r)}),a.appendChild(G);return}let I=d.length,tt=B/Math.max(I+1,2),z=I*tt,st=R-z/2;d.forEach((q,W)=>{let Y=M.find(J=>(J.series!=null?String(J.series):"")===q);if(!Y)return;let et=Y.y,at=st+W*tt,ht=k(et),lt=Math.max(2,V-ht),G=it(q,W),Z=document.createElementNS(a.namespaceURI,"rect");Z.setAttribute("x",String(at)),Z.setAttribute("y",String(ht)),Z.setAttribute("width",String(tt)),Z.setAttribute("height",String(lt)),Z.setAttribute("fill",G),Z.setAttribute("stroke","rgba(0,0,0,0.25)"),Z.setAttribute("stroke-width","0.5"),Z.style.cursor="pointer";let kt=`${q} @ ${String(g.label)}`,dt=`valor: ${Math.round(et*100)/100}`;Z.addEventListener("mouseenter",J=>{var pt,zt;return mt(o,l,kt,dt,(zt=(pt=Y.notes)==null?void 0:pt.length)!=null?zt:0,J)}),Z.addEventListener("mouseleave",()=>gt(l)),Z.addEventListener("click",J=>{var pt;J.preventDefault(),yt(o,p,kt,et,(pt=Y.notes)!=null?pt:[],r)}),a.appendChild(Z)})})}function He(o,s,t){var B,_,O,j;let e=(B=s.options)!=null?B:{},n=e.background,r=(_=e.drilldown)!=null?_:!0,i=(O=t.rows)!=null?O:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:c,svg:a,tooltip:l,details:p}=wt(o,n),m=o.getBoundingClientRect().width||600,h=Math.max(m,480);c.style.width=h+"px";let f=40,S=16,y=18,E=28,C=300;a.setAttribute("height",String(C));let w=h-f-S,F=C-y-E,N=new Map;for(let L of i){let g=String(L.x),b=(j=N.get(g))!=null?j:{label:L.x,rows:[]};b.rows.push(L),N.set(g,b)}let $=Array.from(N.keys()).sort((L,g)=>L<g?-1:L>g?1:0).map(L=>N.get(L)),v=$.length,D=new Set;i.forEach(L=>{L.series!=null&&D.add(String(L.series))});let d=Array.from(D);if(!d.length){fe(o,s,t);return}let A=0;$.forEach(L=>{let g=L.rows.reduce((b,R)=>b+R.y,0);g>A&&(A=g)}),(!isFinite(A)||A<=0)&&(A=1);let T=L=>y+F-L/(A||1)*F,x=T(0),k=4;for(let L=0;L<=k;L++){let g=A*L/k,b=T(g),R=document.createElementNS(a.namespaceURI,"line");R.setAttribute("x1",String(f)),R.setAttribute("y1",String(b)),R.setAttribute("x2",String(h-S)),R.setAttribute("y2",String(b)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),a.appendChild(R);let M=document.createElementNS(a.namespaceURI,"text");M.setAttribute("x",String(f-4)),M.setAttribute("y",String(b+3)),M.setAttribute("text-anchor","end"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=String(Math.round(g)),a.appendChild(M)}let V=v>0?w/v:w;$.forEach((L,g)=>{let b=f+V*(g+.5),R=String(L.label),M=document.createElementNS(a.namespaceURI,"text");M.setAttribute("x",String(b)),M.setAttribute("y",String(C-E+12)),M.setAttribute("text-anchor","middle"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=R,a.appendChild(M)});let X=o.createDiv({cls:"chart-notes-legend"});d.forEach((L,g)=>{let b=X.createDiv({cls:"chart-notes-legend-item"}),R=b.createDiv();R.style.width="10px",R.style.height="10px",R.style.borderRadius="999px",R.style.backgroundColor=it(L,g),b.createSpan({text:L})}),$.forEach((L,g)=>{let b=f+V*(g+.5),R=V*.6,M=b-R/2,I=0;d.forEach((tt,z)=>{let st=L.rows.find(dt=>(dt.series!=null?String(dt.series):"")===tt);if(!st)return;let q=st.y,W=I,Y=I+q;I=Y;let et=T(W),at=T(Y),ht=Math.max(2,et-at),lt=it(tt,z),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(M)),G.setAttribute("y",String(at)),G.setAttribute("width",String(R)),G.setAttribute("height",String(ht)),G.setAttribute("fill",lt),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let Z=`${tt} @ ${String(L.label)}`,kt=`valor: ${Math.round(q*100)/100}`;G.addEventListener("mouseenter",dt=>{var J,pt;return mt(o,l,Z,kt,(pt=(J=st.notes)==null?void 0:J.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>gt(l)),G.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(o,p,Z,q,(J=st.notes)!=null?J:[],r)}),a.appendChild(G)})})}function me(o,s,t,e){var _,O,j,L;let n=(_=s.options)!=null?_:{},r=n.background,i=(O=n.drilldown)!=null?O:!0,c=(j=t.rows)!=null?j:[];if(!c.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:p,details:m}=wt(o,r),h=o.getBoundingClientRect().width||600,f=Math.max(h,480);a.style.width=f+"px";let S=40,y=16,E=18,C=24,w=300;l.setAttribute("height",String(w));let F=f-S-y,N=w-E-C,H=new Map;for(let g of c){let b=g.series!=null?String(g.series):"__default__",R=(L=H.get(b))!=null?L:[];R.push(g),H.set(b,R)}let $=Array.from(H.keys()),v=[],D=new Set;for(let g of c){let b=String(g.x);D.has(b)||(D.add(b),v.push(g.x))}let d=v.length||1,A=g=>{let b=String(g),R=v.findIndex(M=>String(M)===b);return R<0?S:d===1?S+F/2:S+R/(d-1)*F},T=g=>String(g),x=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY;for(let g of c)g.y<x&&(x=g.y),g.y>k&&(k=g.y);(!isFinite(x)||!isFinite(k))&&(x=0,k=1),x===k&&(x===0?k=1:x=0);let V=g=>E+N-(g-x)/(k-x||1)*N,X=4;for(let g=0;g<=X;g++){let b=x+(k-x)*g/X,R=V(b),M=document.createElementNS(l.namespaceURI,"line");M.setAttribute("x1",String(S)),M.setAttribute("y1",String(R)),M.setAttribute("x2",String(f-y)),M.setAttribute("y2",String(R)),M.setAttribute("stroke","#cccccc"),M.setAttribute("stroke-opacity","0.25"),l.appendChild(M);let I=document.createElementNS(l.namespaceURI,"text");I.setAttribute("x",String(S-4)),I.setAttribute("y",String(R+3)),I.setAttribute("text-anchor","end"),I.setAttribute("font-size","10"),I.setAttribute("fill","#111111"),I.textContent=Math.abs(b)>=100?String(Math.round(b)):String(Math.round(b*10)/10),l.appendChild(I)}let B=$.filter(g=>g!=="__default__");if(B.length>1){let g=o.createDiv({cls:"chart-notes-legend"});B.forEach((b,R)=>{let M=b,I=g.createDiv({cls:"chart-notes-legend-item"}),tt=I.createDiv();tt.style.width="10px",tt.style.height="10px",tt.style.borderRadius="999px",tt.style.backgroundColor=it(M,R),I.createSpan({text:M})})}$.forEach((g,b)=>{let R=H.get(g);if(!(R!=null&&R.length))return;let M=g==="__default__"?it("line",b):it(g,b),I=[...R].sort((z,st)=>{let q=v.findIndex(Y=>String(Y)===String(z.x)),W=v.findIndex(Y=>String(Y)===String(st.x));return q-W}),tt="";if(I.forEach((z,st)=>{let q=A(z.x),W=V(z.y);tt+=(st===0?"M ":" L ")+q+" "+W}),e){let z=I[0],st=I[I.length-1],q=A(z.x),W=A(st.x),Y=V(x);tt+=` L ${W} ${Y} L ${q} ${Y} Z`;let et=document.createElementNS(l.namespaceURI,"path");et.setAttribute("d",tt),et.setAttribute("fill",M),et.setAttribute("fill-opacity","0.18"),et.setAttribute("stroke",M),et.setAttribute("stroke-width","1.5"),l.appendChild(et)}else{let z=document.createElementNS(l.namespaceURI,"path");z.setAttribute("d",tt),z.setAttribute("fill","none"),z.setAttribute("stroke",M),z.setAttribute("stroke-width","2"),l.appendChild(z)}I.forEach(z=>{let st=A(z.x),q=V(z.y),W=document.createElementNS(l.namespaceURI,"circle");W.setAttribute("cx",String(st)),W.setAttribute("cy",String(q)),W.setAttribute("r","3"),W.setAttribute("fill","#ffffff"),W.setAttribute("stroke",M),W.setAttribute("stroke-width","1.5"),W.style.cursor="pointer";let Y=T(z.x),et=g==="__default__"?"":String(z.series),at=et?`${et} @ ${Y}`:Y,ht=`valor: ${Math.round(z.y*100)/100}`;W.addEventListener("mouseenter",lt=>{var G,Z;return mt(o,p,at,ht,(Z=(G=z.notes)==null?void 0:G.length)!=null?Z:0,lt)}),W.addEventListener("mouseleave",()=>gt(p)),W.addEventListener("click",lt=>{var G;lt.preventDefault(),yt(o,m,at,z.y,(G=z.notes)!=null?G:[],i)}),l.appendChild(W)})})}function Qe(o,s,t){var F;let{background:e,drilldown:n=!0}=(F=s.options)!=null?F:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let r=$e(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:c,svg:a,tooltip:l,details:p}=wt(o,e),m=Math.max(i,420);c.style.width=m+"px",r&&(a.style.color=r);let h=300,f=m/2,S=(h-28+28)/2,y=Math.min(m/2-20,h/2-20),C=t.rows.map(N=>Math.max(0,N.y)).reduce((N,H)=>N+H,0)||1,w=-Math.PI/2;t.rows.forEach((N,H)=>{var B;let $=N.x instanceof Date?N.x.toISOString().slice(0,10):String(N.x),v=N.y,D=v/C*Math.PI*2,d=f+y*Math.cos(w),A=S+y*Math.sin(w),T=f+y*Math.cos(w+D),x=S+y*Math.sin(w+D),k=D>Math.PI?1:0,V=document.createElementNS(a.namespaceURI,"path"),X=[`M ${f} ${S}`,`L ${d} ${A}`,`A ${y} ${y} 0 ${k} 1 ${T} ${x}`,"Z"].join(" ");V.setAttribute("d",X),V.setAttribute("fill",it((B=N.series)!=null?B:$,H)),V.style.cursor="pointer",V.addEventListener("mouseenter",_=>{var O,j;return mt(o,l,$,v,(j=(O=N.notes)==null?void 0:O.length)!=null?j:0,_)}),V.addEventListener("mouseleave",()=>gt(l)),V.addEventListener("click",()=>{var _;return yt(o,p,$,v,(_=N.notes)!=null?_:[],n)}),a.appendChild(V),w+=D})}function Be(o,s,t){var A;let{background:e,drilldown:n=!0}=(A=s.options)!=null?A:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let r=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:c,svg:a,tooltip:l,details:p}=wt(o,e),m=Math.max(i,700);c.style.width=m+"px",r&&(a.style.color=r);let h=300,f=m-48-10,S=h-28-28,y=t.rows.map(T=>{let x=T.x;if(x instanceof Date)return x.getTime();if(typeof x=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(x)){let V=new Date(x);if(!isNaN(V.getTime()))return V.getTime()}let k=Number(x);return isNaN(k)?null:k}return typeof x=="number"?x:null}),E=t.rows.map(T=>T.y),C=y.filter(T=>T!==null);if(C.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let w=Math.min(...C),F=Math.max(...C),N=Math.min(...E),H=Math.max(...E),$=T=>48+(T-w)/(F-w||1)*f,v=T=>h-28-(T-N)/(H-N||1)*S,D=document.createElementNS(a.namespaceURI,"line");D.setAttribute("x1",String(48)),D.setAttribute("y1",String(28)),D.setAttribute("x2",String(48)),D.setAttribute("y2",String(h-28)),D.setAttribute("stroke","currentColor"),a.appendChild(D);let d=document.createElementNS(a.namespaceURI,"line");d.setAttribute("x1",String(48)),d.setAttribute("y1",String(h-28)),d.setAttribute("x2",String(m-10)),d.setAttribute("y2",String(h-28)),d.setAttribute("stroke","currentColor"),a.appendChild(d),t.rows.forEach((T,x)=>{let k=y[x];if(k==null)return;let V=$(k),X=v(E[x]),B=document.createElementNS(a.namespaceURI,"circle");B.setAttribute("cx",String(V)),B.setAttribute("cy",String(X)),B.setAttribute("r","4"),B.setAttribute("fill",it(T.series,x)),B.style.cursor="pointer";let _=T.x instanceof Date?T.x.toISOString().slice(0,10):typeof T.x=="string"?T.x:String(T.x);B.addEventListener("mouseenter",O=>{var j,L;return mt(o,l,_,T.y,(L=(j=T.notes)==null?void 0:j.length)!=null?L:0,O)}),B.addEventListener("mouseleave",()=>gt(l)),B.addEventListener("click",O=>{var j;O.preventDefault(),yt(o,p,_,T.y,(j=T.notes)!=null?j:[],n)}),a.appendChild(B)})}var Ge=require("obsidian"),se=class{render(s,t,e,n,r=!1){var l;let{title:i}=(l=t.options)!=null?l:{};s.empty(),s.addClass("prop-charts-container");let a=s.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":fe(s,t,e);break;case"stacked-bar":He(s,t,e);break;case"line":me(s,t,e,!1);break;case"area":me(s,t,e,!0);break;case"pie":Qe(s,t,e);break;case"scatter":Be(s,t,e);break;case"gantt":ne(s,t,e,n);break;default:s.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!r){let p=s.createEl("button",{cls:"chart-notes-zoom-button"});p.setAttr("type","button"),p.setAttr("aria-label","Expandir gr\xE1fico"),p.textContent="\u2922",p.addEventListener("click",m=>{m.preventDefault(),new ge(t,e,this,n).open()})}}},ge=class extends Ge.Modal{constructor(t,e,n,r){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=n,this.ctx=r}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),n=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:n,cls:"chart-notes-zoom-title"});let r=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(l,p)=>{let m=r.createEl("button",{cls:"chart-notes-zoom-size-btn",text:l});(()=>{m.toggleClass("is-active",this.size===p)})(),m.addEventListener("click",f=>{f.preventDefault(),this.size=p,this.applySize(),r.querySelectorAll(".chart-notes-zoom-size-btn").forEach(y=>y.classList.remove("is-active")),m.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let c=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(c,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",n="85vh";switch(this.size){case"small":e="60vw",n="55vh";break;case"medium":e="80vw",n="70vh";break;case"large":default:e="95vw",n="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=n,t.style.maxHeight=n}};var oe=class extends It.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new te(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof It.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof It.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof It.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,n)=>{var p;let r;try{let m=(0,It.parseYaml)(t);if(!m||typeof m!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}r=m}catch(m){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+m.message});return}if(!r.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=r.type==="gantt",c=r.type==="table";if(!i&&!c){if(!r.encoding||!r.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let h=((p=r.aggregate)==null?void 0:p.y)==="count";if(!r.encoding.y&&!h){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}r.encoding||(r.encoding={}),r.source||(r.source={});let l;try{l=this.query.run(r)}catch(m){e.createEl("div",{text:"Chart Notes: erro na query: "+m.message});return}this.renderer.render(e,r,l)}),this.registerBasesView(pe,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new Zt(t,e,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},e={type:"property",key:"xProperty",displayName:"Category / group"},n={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:C=>{var w;return String((w=C.get("chartType"))!=null?w:"bar")==="pie"}},r={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:C=>{var w;return String((w=C.get("chartType"))!=null?w:"bar")==="pie"}},i={type:"dropdown",key:"aggregateMode",displayName:"Value mode",default:"normal",options:{normal:"Normal (sum / count)","cumulative-sum":"Cumulative (line/area only)"},shouldHide:C=>{var F;let w=String((F=C.get("chartType"))!=null?F:"bar");return w!=="line"&&w!=="area"}},c={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (date \u2192 day)",none:"None",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:C=>{var F;let w=String((F=C.get("chartType"))!=null?F:"bar");return w==="pie"||w==="scatter"||w==="gantt"}},a=(C,w)=>({type:"property",key:C,displayName:w,shouldHide:F=>{var N;return String((N=F.get("chartType"))!=null?N:"")!=="gantt"}}),l=a("startProperty","Start (Gantt)"),p=a("endProperty","End (Gantt)"),m=a("dueProperty","Due (optional)"),h=a("scheduledProperty","Scheduled (optional)"),f=a("durationProperty","Duration in minutes (optional)"),S=a("groupProperty","Group / lane (optional)");return[t,e,n,r,i,l,p,m,h,f,S,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
