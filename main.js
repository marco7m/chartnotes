/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var Ve=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var We=Object.prototype.hasOwnProperty;var Ue=(s,e)=>{for(var t in e)ce(s,t,{get:e[t],enumerable:!0})},Ye=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ke(e))!We.call(s,r)&&r!==t&&ce(s,r,{get:()=>e[r],enumerable:!(n=Ve(e,r))||n.enumerable});return s};var Xe=s=>Ye(ce({},"__esModule",{value:!0}),s);var dn={};Ue(dn,{default:()=>oe});module.exports=Xe(dn);var Vt=require("obsidian");var jt=require("obsidian"),ue="chartnotes-view",Oe=["bar","stacked-bar","line","area","pie","scatter","gantt"];function ze(s){let e=String(s!=null?s:"bar").trim().toLowerCase();return Oe.includes(e)?e:"bar"}var qe=["sum","count","cumulative-sum"];function je(s){let e=String(s!=null?s:"sum").trim().toLowerCase();return qe.includes(e)?e:"sum"}var Ze=["auto","none","day","week","month","quarter","year"];function Je(s){let e=String(s!=null?s:"auto").trim().toLowerCase();return Ze.includes(e)?e:"auto"}var zt="(missing)",qt=class extends jt.BasesView{constructor(t,n,r){super(t);this.type=ue;this.renderer=r,this.rootEl=n.createDiv("chartnotes-bases-view")}onDataUpdated(){var O,Y,$;this.rootEl.empty();let t=this.data,n=(O=t==null?void 0:t.groupedData)!=null?O:[];if(!n.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,o=ze((Y=r==null?void 0:r.get("chartType"))!=null?Y:"bar"),i=o==="pie",p=o==="scatter",a=o==="gantt",l=je(r==null?void 0:r.get("aggregateMode")),x=l==="cumulative-sum"&&!(o==="line"||o==="area")?"sum":l,h=Je(r==null?void 0:r.get("xBucket")),f=i||p||a?"none":h,y=this.getPropFromConfig("xProperty"),m=this.getPropFromConfig("ganttLabelProperty"),A=this.getPropFromConfig("yProperty"),D=this.getPropFromConfig("seriesProperty");i&&(D={id:null,name:null});let b=this.getPropFromConfig("startProperty"),M=this.getPropFromConfig("endProperty"),R=this.getPropFromConfig("dueProperty"),F=this.getPropFromConfig("scheduledProperty"),Q=this.getPropFromConfig("durationProperty"),S=this.getPropFromConfig("groupProperty");if(!a&&!y.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(p&&(!y.id||!A.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(b.id||M.id||F.id||R.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Scheduled/Due with Duration."});return}let v=a&&m.id?m:a?y:{id:null,name:null},u;if(a)u=this.buildRowsForGantt(n,v,D,b,M,R,F,Q,S);else if(p)u=this.buildRowsForScatter(n,y,A,D);else{let c=i;u=this.buildRowsForAggregatedCharts(n,y,A,D,x,f,c)}if(!u.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let E={rows:u},w=(($=r==null?void 0:r.get("title"))!=null?$:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",P=r==null?void 0:r.get("drilldown"),B=typeof P=="boolean"?P:!0,Z=this.buildEncoding({x:y,y:A,series:D,start:b,end:M,due:R,duration:Q,group:S,label:v,aggMode:x,xBucket:f,chartType:o}),_={type:o,source:{type:"properties",query:""},encoding:Z,options:{title:w,drilldown:B}},K={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,_,E,K)}getPropFromConfig(t){var p,a;let n=this.config,r=(p=n==null?void 0:n.get)==null?void 0:p.call(n,t);if(!r)return{id:null,name:null};let o=r.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let l=(0,jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,n){if(!n.id)return null;let r;try{r=t.getValue(n.id)}catch(o){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=new Date(t.trim());return Number.isNaN(n.getTime())?null:n}compareX(t,n){let r=this.parseDate(t!=null?String(t):null),o=this.parseDate(n!=null?String(n):null);if(r&&o)return r.getTime()-o.getTime();let i=Number(t),p=Number(n);return!Number.isNaN(i)&&!Number.isNaN(p)?i-p:String(t!=null?t:"").localeCompare(String(n!=null?n:""))}fmtDate(t){let n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${o}`}startOfWeek(t){let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(n.getDay()+6)%7;return n.setDate(n.getDate()-r),n.setHours(0,0,0,0),n}bucketX(t,n){let r=this.parseDate(t);if(!r)return t;switch(n){case"none":return t;case"auto":case"day":return this.fmtDate(new Date(r.getFullYear(),r.getMonth(),r.getDate()));case"week":{let o=this.startOfWeek(r);return`${this.fmtDate(o)} (W)`}case"month":{let o=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${o}`}case"quarter":{let o=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${o}`}case"year":return`${r.getFullYear()}`;default:return t}}getXValuesForEntry(t,n,r,o){var g,x;let i=[],p=h=>this.bucketX(h,r);if(!n.id){let h=t.file,f=h!=null&&h.name?String(h.name):String((g=h==null?void 0:h.path)!=null?g:zt);return i.push(p(f)),i}if(!o){let h=(x=this.readValue(t,n))!=null?x:zt;return i.push(p(h)),i}let a=null;try{a=t.getValue(n.id)}catch(h){a=null}let l=h=>{if(!h)return;let f=String(h).trim();f&&i.push(p(f))};if(a==null)l(zt);else if(typeof a=="string"){let h=a.trim();if(h){let f=h.split(/\s+/);for(let y of f)l(y)}}else if(Array.isArray(a))for(let h of a){if(h==null)continue;let f;try{f=h.toString()}catch(y){continue}l(f)}else if(typeof a.toArray=="function"){let h=a.toArray();if(Array.isArray(h))for(let f of h){if(f==null)continue;let y;try{y=f.toString()}catch(m){continue}l(y)}else{let f;try{f=a.toString()}catch(y){f=""}l(f)}}else{let h;try{h=a.toString()}catch(f){h=""}l(h)}return i.length||l(zt),i}buildRowsForAggregatedCharts(t,n,r,o,i,p,a){let l=new Map,g=a||i==="count"||!r.id&&i!=="sum",x=r.name||"y";for(let f of t)for(let y of f.entries){let m=y.file,A=this.getXValuesForEntry(y,n,p,a),D=1,b=null;if(!g&&r.id){if(b=this.readValue(y,r),b==null)continue;let F=Number(b);if(Number.isNaN(F))continue;D=F}else D=1;let M=this.readValue(y,o),R=M!=null?String(M):void 0;for(let F of A){let Q=`${F}@@${R!=null?R:""}`,S=l.get(Q);S||(S={x:F,y:0,series:R,notes:[],props:{}},l.set(Q,S)),S.y+=D,m!=null&&m.path&&S.notes.push(m.path),S.props&&n.name&&(S.props[n.name]=F),!g&&S.props&&x&&b!=null&&(S.props[x]=S.y),g&&S.props&&(S.props[x]=S.y),S.props&&o.name&&M!=null&&(S.props[o.name]=M)}}let h=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(h):h}toCumulative(t){var o,i;let n=new Map;for(let p of t){let a=(o=p.series)!=null?o:"__no_series__",l=n.get(a);l||(l=[],n.set(a,l)),l.push(p)}let r=[];for(let[,p]of n){let a=[...p].sort((g,x)=>this.compareX(g.x,x.x)),l=0;for(let g of a){let x=Number((i=g.y)!=null?i:0);Number.isNaN(x)||(l+=x,r.push({...g,y:l}))}}return r}buildRowsForScatter(t,n,r,o){let i=[];for(let p of t)for(let a of p.entries){let l=a.file,g=this.readValue(a,n),x=this.readValue(a,r);if(g==null||x==null)continue;let h=Number(g),f=Number(x);if(Number.isNaN(h)||Number.isNaN(f))continue;let y=this.readValue(a,o),m=y!=null?String(y):void 0;i.push({x:h,y:f,series:m,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,n,r,o,i,p,a,l,g){var h,f;let x=[];for(let y of t)for(let m of y.entries){let A=m.file,D=this.readValue(m,o),b=this.readValue(m,i),M=this.readValue(m,p),R=this.readValue(m,a),F=this.readValue(m,l),Q=F!=null?Number(F):NaN,S=Number.isFinite(Q),v=this.parseDate(D),u=this.parseDate(b),E=this.parseDate(M),T=this.parseDate(R);if(!v&&S&&(T?v=new Date(T.getTime()-Q*6e4):E?v=new Date(E.getTime()-Q*6e4):u&&(v=new Date(u.getTime()-Q*6e4))),!u&&v&&S&&(u=new Date(v.getTime()+Q*6e4)),!v||!u)continue;let w=(f=this.readValue(m,n))!=null?f:A!=null&&A.name?String(A.name).replace(/\.md$/i,""):String((h=A==null?void 0:A.path)!=null?h:""),P=this.readValue(m,r),B=P!=null?String(P):void 0,Z=this.readValue(m,g),_={};n.name&&(_[n.name]=w),S&&l.name&&(_[l.name]=Q),g.name&&Z!=null&&(_[g.name]=Z),x.push({x:w,y:0,series:B,start:v,end:u,due:E!=null?E:void 0,notes:A!=null&&A.path?[A.path]:[],props:_})}return x}buildEncoding(t){var i,p,a,l,g,x,h,f,y,m,A;let n=(i=t.x.name)!=null?i:"x",r=(p=t.y.name)!=null?p:"y",o=(g=(l=(a=t.label.name)!=null?a:t.x.name)!=null?l:t.group.name)!=null?g:"label";return{x:n,y:r,series:(x=t.series.name)!=null?x:"series",start:(h=t.start.name)!=null?h:"start",end:(f=t.end.name)!=null?f:"end",due:(y=t.due.name)!=null?y:"due",duration:(m=t.duration.name)!=null?m:"duration",group:(A=t.group.name)!=null?A:"group",label:o}}};var Te=require("obsidian"),Zt=class{constructor(e){this.index=new Map;this.app=e}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(e){if(e.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(e)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Te.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[p,a]of Object.entries(i))p!=="position"&&(t[p]=a)}let o=this.app.metadataCache.getFileCache(e);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",e.path,n)}this.index.set(e.path,{path:e.path,props:t})}removeFile(e){this.index.delete(e.path)}};function Me(s,e){if(!e||e.length===0)return!0;for(let t of e){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Pe(s,e){if(!e||e.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of e)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let n=String(t);for(let r of e)if(n===r||n==="#"+r)return!0;return!1}function te(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function _t(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,n,r]=s.split("-");return new Date(Number(t),Number(n)-1,Number(r),0,0,0,0)}let e=new Date(s);return isNaN(e.getTime())?null:e}function ut(s){let e=new Date(s);return e.setHours(0,0,0,0),e}function Jt(s,e){let t=new Date(s);return t.setDate(t.getDate()-e),t}function tn(s,e){return Jt(s,e*7)}function en(s,e){let t=new Date(s);return t.setMonth(t.getMonth()-e),t}function pe(s,e){let t=new Date(s);return t.setDate(t.getDate()+e),t}function nn(s,e){return pe(s,e*7)}function rn(s,e){let t=new Date(s);return t.setMonth(t.getMonth()+e),t}function Ne(s){let e=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(e)||e.endsWith("date")||e.endsWith("at")||e.endsWith("on"))}function ke(s,e){let t=e?new Date(e):new Date,n=ut(t),r=s.trim().toLowerCase();if(r==="today")return n;if(r==="yesterday")return ut(Jt(n,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(Jt(n,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Jt(n,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(tn(n,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(en(n,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(pe(n,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(pe(n,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(nn(n,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(rn(n,o))}return null}function Le(s){let e=s.trim(),t=e.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let g=t[1].trim(),x=t[2].trim(),h=t[3].trim(),f=Ne(g),y=de(x,f),m=de(h,f),A=y.valueType==="date"||m.valueType==="date"?"date":y.valueType;return{field:g,op:"between",value:y.value,value2:m.value,valueType:A}}let n=/(==|!=|>=|<=|>|<)/,r=e.split(n);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),p=r[2].trim(),a=Ne(o),l=de(p,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function de(s,e){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),r=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(e){if(t==="0"||n==="today")return{value:ut(new Date),valueType:"date"};let i=ke(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=ke(t);if(i)return{value:i,valueType:"date"}}if(te(t)){let i=_t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ie(s,e){let t=s[e.field];if(t==null)return!1;if(e.valueType==="date"){let o=t instanceof Date?ut(t):te(t)?ut(_t(t)):null;if(!o)return!1;let i=e.value instanceof Date?e.value:null,p=e.value2 instanceof Date?e.value2:null;if(!i)return!1;let a=o.getTime(),l=ut(i).getTime();switch(e.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!p)return!1;let g=ut(p).getTime();return a>=l&&a<=g}}if(e.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(e.value);switch(e.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof e.value2!="number"?!1:o>=i&&o<=e.value2}}let n=String(t),r=String(e.value);switch(e.op){case"==":return n===r;case"!=":return n!==r;case">":return n>r;case">=":return n>=r;case"<":return n<r;case"<=":return n<=r;case"between":return!1}}function sn(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(te(s)){let e=_t(s);if(e)return{key:e,isDate:!0}}return{key:s,isDate:!1}}function on(s,e){let t=s.x,n=e.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let r=String(t),o=String(n);return r<o?-1:r>o?1:0}function an(s,e){var o,i;let t=on(s,e);if(t!==0)return t;let n=(o=s.series)!=null?o:"",r=(i=e.series)!=null?i:"";return n<r?-1:n>r?1:0}function ln(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let e=s.trim().match(/^(\d+)/);if(e){let t=Number(e[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function cn(s){var n,r;let e=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:"__no_series__",a=((r=e.get(i))!=null?r:0)+o.y;e.set(i,a),t.push({...o,y:a})}return t}function un(s,e){var i,p;let t=ln(e);if(!t||t<=1)return[...s];let n=new Map,r=new Map,o=[];for(let a of s){let l=(i=a.series)!=null?i:"__no_series__",g=n.get(l);g||(g=[],n.set(l,g));let x=(p=r.get(l))!=null?p:0;if(g.push(a.y),x+=a.y,g.length>t){let y=g.shift();x-=y}r.set(l,x);let h=g.length||1,f=x/h;o.push({...a,y:f})}return o}var ee=class{constructor(e,t){this.getIndex=e,this.defaultPaths=t}run(e){var i,p,a;let t=this.getIndex(),n=(i=e.source)!=null&&i.paths&&e.source.paths.length?e.source.paths:this.defaultPaths,r=(p=e.source)!=null&&p.tags&&e.source.tags.length?e.source.tags:[],o=[];for(let l of t){let g=n&&n.length?Me(l.path,n):!0,x=r&&r.length?Pe(l.props,r):!0;if(!g||!x)continue;let h=!0;if((a=e.source)!=null&&a.where&&e.source.where.length>0)for(let f of e.source.where){let y;try{y=Le(f)}catch(m){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${f} (${m.message})`)}if(!Ie(l.props,y)){h=!1;break}}h&&o.push(l)}return e.type==="gantt"?this.runGantt(e,o):e.type==="table"?this.runTable(e,o):this.runStandard(e,o)}runTable(e,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=e.encoding)==null?void 0:r.x,yField:(o=e.encoding)==null?void 0:o.y}}runGantt(e,t){var x,h,f;let n=(x=e.encoding)!=null?x:{},r=n.start,o=n.end,i=(h=n.label)!=null?h:n.x,p=n.series,a=n.duration,l=n.due,g=[];for(let y of t){let m=(f=y.props)!=null?f:{},A=S=>Array.isArray(S)?S[0]:S,D=null;if(o){let S=A(m[o]),v=_t(S);v&&(D=v)}if(!D)continue;let b=null;if(r){let S=A(m[r]),v=_t(S);v&&(b=v)}if(!b&&a){let S=A(m[a]),v=Number(S);Number.isNaN(v)||(b=new Date(D.getTime()-v*6e4))}b||(b=new Date(D.getTime()));let M;if(l){let S=A(m[l]),v=_t(S);v&&(M=v)}let R;if(i){let S=A(m[i]);(S==null||S==="")&&(S=y.path),R=S}else R=y.path;let F;if(p){let S=A(m[p]);S!=null&&(F=String(S))}let Q={x:R,y:0,notes:[y.path],series:F,start:b,end:D,props:m};M&&(Q.due=M),g.push(Q)}return g.sort((y,m)=>{let A=y.start?y.start.getTime():0,D=m.start?m.start.getTime():0;return A-D}),{rows:g,xField:i,yField:o}}runStandard(e,t){var y,m,A,D,b,M,R,F,Q,S;let n=(y=e.encoding)==null?void 0:y.x,r=(m=e.encoding)==null?void 0:m.y,o=(A=e.encoding)==null?void 0:A.series;if(!n)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(D=e.aggregate)!=null?D:{},p=(b=i.y)!=null?b:null,a=!!i.cumulative,l=i.rolling;if(!r&&p!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let g=[];for(let v of t){let u=(M=v.props)!=null?M:{},E=K=>Array.isArray(K)?K[0]:K,T=E(u[n]);if(T==null)continue;let w=sn(T),P=w.key,B=w.isDate,Z;if(o){let K=E(u[o]);K!=null&&String(K).trim()!==""&&(Z=String(K))}let _;if(p==="count")_=1;else{let K=E(u[r]);if(K==null)continue;let O=Number(K);if(Number.isNaN(O))continue;_=O}g.push({x:P,y:_,notes:[v.path],series:Z,props:u,_isDate:B,_origX:T})}if(g.length===0)return{rows:[],xField:n,yField:r};let x=[];if(p){let v=new Map;for(let u of g){let E=(R=u.series)!=null?R:"",T=u.x instanceof Date?u.x.toISOString().slice(0,10):String(u.x),w=E+"||"+T,P=(F=v.get(w))!=null?F:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:u.x,isDate:u._isDate,series:u.series,props:u.props};P.sum+=u.y,P.count+=1,u.y<P.min&&(P.min=u.y),u.y>P.max&&(P.max=u.y),P.notes.push(...u.notes),P.props=(Q=u.props)!=null?Q:P.props,v.set(w,P)}for(let[,u]of v){let E=u.sum;switch(p){case"sum":E=u.sum;break;case"avg":E=u.sum/u.count;break;case"min":E=u.min;break;case"max":E=u.max;break;case"count":E=u.count;break}x.push({x:u.xRep,y:E,notes:u.notes,series:u.series,props:u.props})}}else x=g.map(v=>({x:v.x,y:v.y,notes:v.notes,series:v.series,props:v.props}));if(x.length===0)return{rows:[],xField:n,yField:r};let h=((S=e.sort)==null?void 0:S.x)==="desc"?"desc":"asc";if(x.sort((v,u)=>{let E=an(v,u);return h==="asc"?E:-E}),(a||l)&&!(e.type==="line"||e.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let f=x;return l?f=un(x,l):a&&(f=cn(x)),{rows:f,xField:n,yField:r}}};var Ct=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(s,e){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,r)=>n*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(s,e){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,e&&(n.style.background=e);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let p=s.createDiv({cls:"chart-notes-details"});return p.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:p}}function ft(s,e,t,n,r,o){let i=s.getBoundingClientRect(),p=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);e.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${p}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,e.style.display="block";let a=e.getBoundingClientRect(),l=o.clientX-i.left+6,g=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),g+a.height>i.height-4&&(g=i.height-a.height-4),g<4&&(g=4),e.style.left=l+"px",e.style.top=g+"px"}function gt(s){s.style.display="none"}function mt(s,e,t,n,r,o){if(!o)return;if(e.empty(),!r||r.length===0){e.style.display="none";return}e.style.display="block";let i=e.createEl("div",{cls:"chart-notes-details-header"}),p=i.createEl("div",{cls:"chart-notes-details-title"});p.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{e.style.display="none"});let l=e.createEl("ul",{cls:"chart-notes-details-list"});for(let g of r){let h=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:g});h.href="#",h.addEventListener("click",f=>{f.preventDefault(),app.workspace.openLinkText(g,"",!1)})}}function Ht(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let e=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${e}/${t}`}function _e(s){if(!s)return!1;let e=s.trim().toLowerCase();if(e==="#fff"||e==="#ffffff"||e==="white")return!0;if(!e.startsWith("#"))return!1;let t,n,r;if(e.length===4)t=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16),r=parseInt(e[3]+e[3],16);else if(e.length===7)t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*r)/255>.7}var he=class extends Ct.Modal{constructor(t,n,r,o){var p;super(app);this.notePath=t,this.spec=n,this.refresh=r,this.reindexFile=o;let i=(p=n.encoding)!=null?p:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var S,v;let{contentEl:t}=this;t.empty();let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(n),o={},i=r,p=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(p){try{o=(S=(0,Ct.parseYaml)(p[1]))!=null?S:{}}catch(u){o={}}i=r.slice(p[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(v=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?v:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),g=l.createEl("a",{text:a,cls:"gantt-edit-title"});g.href="#",g.addEventListener("click",u=>{u.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let x=l.createDiv({cls:"gantt-edit-subtitle"});x.textContent=this.notePath;let h=t.createDiv({cls:"gantt-edit-form"}),f=u=>{let E=h.createDiv({cls:"gantt-edit-row"}),T=E.createDiv({cls:"gantt-edit-label"});T.textContent=u;let w=E.createDiv({cls:"gantt-edit-field"});return{row:E,field:w}},y=u=>{if(!u)return"";let T=String(u).match(/^(\d{4}-\d{2}-\d{2})/);return T?T[1]:""},m=u=>{if(u=u.trim(),!!u&&/^\d{4}-\d{2}-\d{2}$/.test(u))return u},A=null;if(this.startKey){let{field:u}=f(this.startKey+" (in\xEDcio)");A=u.createEl("input",{type:"date"}),A.value=y(o[this.startKey])}let D=null;if(this.endKey){let{field:u}=f(this.endKey+" (fim)");D=u.createEl("input",{type:"date"}),D.value=y(o[this.endKey])}let b=null;if(this.durationKey){let{field:u}=f(this.durationKey+" (minutos)");b=u.createEl("input",{type:"number"});let E=o[this.durationKey];b.value=E!=null?String(E):"",b.min="0",b.step="5"}let M=null;if(this.dueKey){let{field:u}=f(this.dueKey+" (due)");M=u.createEl("input",{type:"date"}),M.value=y(o[this.dueKey])}let R=t.createDiv({cls:"gantt-edit-buttons"}),F=R.createEl("button",{text:"Salvar",cls:"mod-cta"});R.createEl("button",{text:"Cancelar"}).addEventListener("click",u=>{u.preventDefault(),this.close()}),F.addEventListener("click",async u=>{if(u.preventDefault(),this.startKey&&A){let w=m(A.value);w?o[this.startKey]=w:delete o[this.startKey]}if(this.endKey&&D){let w=m(D.value);w?o[this.endKey]=w:delete o[this.endKey]}if(this.durationKey&&b){let w=b.value.trim();if(w==="")delete o[this.durationKey];else{let P=Number(w);Number.isNaN(P)||(o[this.durationKey]=P)}}if(this.dueKey&&M){let w=m(M.value);w?o[this.dueKey]=w:delete o[this.dueKey]}let T=`---
${(0,Ct.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,T),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(w){}if(this.refresh)try{this.refresh()}catch(w){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(s,e,t,n){var ye,be,Se,xe,ve,we,Ae,De;let r=(ye=e.options)!=null?ye:{},o=r.background,i=(be=r.drilldown)!=null?be:!0,p=!0,a=d=>{if(d==null)return"";let I=String(d).trim();if(!I)return"";let G=I.match(/^\[\[(.+?)\]\]$/);G&&(I=G[1]);let X=I.lastIndexOf("/");return X>=0&&X<I.length-1&&(I=I.slice(X+1)),I};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(d=>d.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(d=>d.start&&d.end);if(l.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let g=e.encoding,x=g.group,h=g.duration,f=(d,I)=>{if(!d||!I)return;let G=d[I];return Array.isArray(G)?G[0]:G},m=l.map(d=>{var St,ct;let I=d.start,G=d.end,X=d.props,Lt=typeof d.x=="string"?d.x:d.x instanceof Date?Ht(I):String(d.x),At=a(Lt),bt,It=x?f(X,x):void 0;It!=null?bt=String(It):d.series!=null?bt=String(d.series):bt=At;let ht=(St=d.notes)==null?void 0:St[0],Dt=ht?(ct=ht.replace(/\.md$/i,"").split("/").pop())!=null?ct:ht:At,Rt=d.due,Ft,Mt=f(X,h);if(Mt!=null){let xt=Number(Mt);Number.isNaN(xt)||(Ft=xt)}return{row:d,start:I,end:G,props:X,fullName:At,groupKey:bt,notePath:ht,noteTitle:Dt,due:Rt,estMinutes:Ft}}).filter(d=>d.start instanceof Date&&!isNaN(d.start.getTime())&&d.end instanceof Date&&!isNaN(d.end.getTime()));if(m.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}m.sort((d,I)=>{if(d.groupKey<I.groupKey)return-1;if(d.groupKey>I.groupKey)return 1;let G=d.start.getTime(),X=I.start.getTime();return G!==X?G-X:d.fullName.localeCompare(I.fullName)});let A=26,D=0,b=null;for(let d of m)d.groupKey!==b&&(b=d.groupKey,D+=1),D+=1;let M=Math.min(...m.map(d=>d.start.getTime())),R=Math.max(...m.map(d=>d.end.getTime()));if(!isFinite(M)||!isFinite(R)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let F=24*60*60*1e3,Q=d=>{let I=new Date(d);return I.setHours(0,0,0,0),I.getTime()},S=Q(M),v=Q(R),u=s.querySelector(".prop-charts-title-row");u||(u=s.createDiv({cls:"prop-charts-title-row"}));let E=s.dataset.ganttZoomMode||String((Se=r.zoomMode)!=null?Se:"100");s.dataset.ganttZoomMode=E;let T=s.dataset.ganttLabelMode||String((xe=r.labelMode)!=null?xe:"compact");s.dataset.ganttLabelMode=T;let w=u.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(d=>{let I=w.createEl("button",{cls:"gantt-zoom-btn",text:d.label});d.id===E&&I.addClass("is-active"),I.addEventListener("click",G=>{G.preventDefault(),s.dataset.ganttZoomMode=d.id,ne(s,e,t,n)})});let B=Number(r.labelWidth),Z=!Number.isNaN(B)&&B>120?B:260,_=T==="wide"?Z+160:Z,K=s.getBoundingClientRect().width||600,O=Math.max(K,820),Y;if(E==="fit")Y=K;else{let d=Number(E)/100||1;Y=O*d}let{inner:$,svg:c,tooltip:N,details:k}=wt(s,o);$.style.width=Y+"px";let C=(d,I,G,X,Lt,At,bt,It,ht)=>{if(!d)return;let Dt=Math.max(40,X-8),Ft=Math.max(8,Math.floor(Dt/6)),Mt=d.split(/\s+/),St=[],ct="";for(let Tt of Mt){if(!ct){ct=Tt;continue}(ct+" "+Tt).length<=Ft?ct+=" "+Tt:(St.push(ct),ct=Tt)}ct&&St.push(ct);let xt=Lt+2,Gt=St.length*xt,Kt=G-Gt/2+Lt;St.forEach((Tt,Xt)=>{let ot=document.createElementNS(c.namespaceURI,"text");ot.setAttribute("x",String(I)),ot.setAttribute("y",String(Kt+Xt*xt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(Lt)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Tt,bt&&ot.addEventListener("mouseenter",st=>bt(st)),It&&ot.addEventListener("mouseleave",()=>It()),ht&&(ot.style.cursor="pointer",ot.addEventListener("click",st=>ht(st))),c.appendChild(ot)})},L=28,tt=28,W=10,rt=Math.max(300,L+tt+D*A+24);c.setAttribute("height",String(rt));let J=Y-_-W,H=L+6;c.style.color="#111111";let z=v+F-S||1,q=S-z*.02,lt=v+F+z*.08,dt=d=>_+(d-q)/(lt-q)*J,yt=(lt-q)/F,j=Math.max(4,Math.min(12,Math.floor(J/90)||4)),kt=yt/j,at=[1,2,3,5,7,10,14,21,30,60,90,180,365],et=at[at.length-1];for(let d of at)if(d>=kt){et=d;break}let pt=[],Ut=Q(q);for(let d=Ut;d<=lt+.5*F;d+=et*F)pt.push(d);let $t=document.createElementNS(c.namespaceURI,"line");$t.setAttribute("x1",String(_)),$t.setAttribute("y1",String(H)),$t.setAttribute("x2",String(Y-W)),$t.setAttribute("y2",String(H)),$t.setAttribute("stroke","#111111"),c.appendChild($t);for(let d of pt){let I=dt(d),G=document.createElementNS(c.namespaceURI,"line");G.setAttribute("x1",String(I)),G.setAttribute("y1",String(H)),G.setAttribute("x2",String(I)),G.setAttribute("y2",String(rt-tt)),G.setAttribute("stroke","#111111"),G.setAttribute("stroke-opacity","0.20"),G.setAttribute("stroke-dasharray","2,4"),c.appendChild(G);let X=document.createElementNS(c.namespaceURI,"text");X.setAttribute("x",String(I)),X.setAttribute("y",String(H-4)),X.setAttribute("text-anchor","middle"),X.setAttribute("font-size","10"),X.setAttribute("fill","#111111"),X.textContent=Ht(new Date(d)),c.appendChild(X)}let me=new Date;me.setHours(0,0,0,0);let ie=me.getTime();if(ie>=q&&ie<=lt){let d=dt(ie),I=document.createElementNS(c.namespaceURI,"line");I.setAttribute("x1",String(d)),I.setAttribute("y1",String(H)),I.setAttribute("x2",String(d)),I.setAttribute("y2",String(rt-tt)),I.setAttribute("stroke","#4caf50"),I.setAttribute("stroke-width","2"),I.setAttribute("stroke-dasharray","4,2"),c.appendChild(I);let G=document.createElementNS(c.namespaceURI,"text");G.setAttribute("x",String(d+4)),G.setAttribute("y",String(H+12)),G.setAttribute("font-size","10"),G.setAttribute("fill","#4caf50"),G.textContent="hoje",c.appendChild(G)}let Yt=$.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Yt.setAttr("title",T==="wide"?"Compactar nomes":"Expandir nomes"),Yt.style.left=`${_}px`,Yt.style.top="4px",Yt.addEventListener("click",d=>{d.preventDefault();let G=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=G,ne(s,e,t,n)});let He=["status","priority"],ae=Array.isArray(r.tooltipFields)?r.tooltipFields.map(d=>String(d)):null,Be=ae&&ae.length?ae:He,Qt=0,le=null;for(let d of m){let I=d.start,G=d.end,X=(G.getTime()-I.getTime())/6e4,Lt=d.props,At=d.notePath,bt=d.noteTitle,It=(we=(ve=d.row.notes)==null?void 0:ve.length)!=null?we:0,ht=d.due,Dt=d.estMinutes,Rt=[];Rt.push(`${Ht(I)} \u2192 ${Ht(G)}`),typeof Dt=="number"&&!Number.isNaN(Dt)?Rt.push(`est: ${Math.round(Dt)} min`):X>0&&Rt.push(`dura\xE7\xE3o: ${Math.round(X)} min`),ht instanceof Date&&Rt.push(`due: ${Ht(ht)}`);for(let nt of Be){let U=f(Lt,nt);U!=null&&String(U).trim()!==""&&Rt.push(`${nt}: ${String(U)}`)}let Ft=Rt.join("<br>"),Mt=nt=>{var U;nt.preventDefault(),p&&At?new he(At,e,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():mt(s,k,bt,Dt!=null?Dt:X,(U=d.row.notes)!=null?U:[],i)},St=nt=>{bt&&Ft&&ft(s,N,bt,Ft,It,nt)},ct=()=>gt(N);if(d.groupKey!==le){le=d.groupKey;let nt=H+8+Qt*A+A/2,U=a(le);C(U,4,nt,_-12,11,"600"),Qt+=1}let xt=H+8+Qt*A,Gt=A-10,Kt=dt(I.getTime()),Tt=dt(G.getTime()),Xt=Math.max(4,Tt-Kt),ot=d.fullName,st=document.createElementNS(c.namespaceURI,"rect");st.setAttribute("x",String(Kt)),st.setAttribute("y",String(xt)),st.setAttribute("width",String(Xt)),st.setAttribute("height",String(Gt)),st.setAttribute("rx","3"),st.setAttribute("ry","3"),st.setAttribute("fill",it((Ae=d.row.series)!=null?Ae:ot,Qt)),st.setAttribute("stroke","rgba(0,0,0,0.25)"),st.setAttribute("stroke-width","0.5"),st.style.cursor=p&&At?"pointer":"default",st.addEventListener("mouseenter",St),st.addEventListener("mouseleave",ct),st.addEventListener("click",Mt),c.appendChild(st);let Ee=xt+Gt/2;if(Xt>=6){let nt=it((De=d.row.series)!=null?De:ot,Qt),U=document.createElementNS(c.namespaceURI,"circle");U.setAttribute("cx",String(Kt)),U.setAttribute("cy",String(Ee)),U.setAttribute("r","3.5"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",nt),U.setAttribute("stroke-width","1.5"),c.appendChild(U);let Pt=document.createElementNS(c.namespaceURI,"circle");Pt.setAttribute("cx",String(Tt)),Pt.setAttribute("cy",String(Ee)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),c.appendChild(Pt)}let Ce=xt+Gt/2+2,Ot=x?16:4;if(T==="wide")C(ot,Ot,Ce,_-Ot-4,11,null,St,ct,Mt);else{let nt=ot,U=Math.max(40,_-Ot-8),Re=Math.max(8,Math.floor(U/6));nt.length>Re&&(nt=nt.slice(0,Re-1)+"\u2026");let vt=document.createElementNS(c.namespaceURI,"text");vt.setAttribute("x",String(Ot)),vt.setAttribute("y",String(Ce)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",St),vt.addEventListener("mouseleave",ct),vt.addEventListener("click",Mt),c.appendChild(vt)}if(ht instanceof Date){let nt=dt(ht.getTime()),U=document.createElementNS(c.namespaceURI,"line");U.setAttribute("x1",String(nt)),U.setAttribute("y1",String(xt)),U.setAttribute("x2",String(nt)),U.setAttribute("y2",String(xt+Gt)),U.setAttribute("stroke","#ff6b6b"),U.setAttribute("stroke-width","2"),U.setAttribute("stroke-dasharray","4,2"),c.appendChild(U)}Qt+=1}if(p){let d=s.createDiv({cls:"prop-charts-empty"});d.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function fe(s,e,t){var K,O,Y,$;let n=(K=e.options)!=null?K:{},r=n.background,o=(O=n.drilldown)!=null?O:!0,i=(Y=t.rows)!=null?Y:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:g}=wt(s,r),x=s.getBoundingClientRect().width||600,h=Math.max(x,480);p.style.width=h+"px";let f=40,y=16,m=18,A=28,D=300;a.setAttribute("height",String(D));let b=h-f-y,M=D-m-A,R=new Map;for(let c of i){let N=String(c.x),k=($=R.get(N))!=null?$:{label:c.x,rows:[]};k.rows.push(c),R.set(N,k)}let Q=Array.from(R.keys()).sort((c,N)=>c<N?-1:c>N?1:0).map(c=>R.get(c)),S=Q.length,v=new Set;i.forEach(c=>{c.series!=null&&v.add(String(c.series))});let u=Array.from(v),E=u.length>1,T=E?"grouped":"single",w=0;i.forEach(c=>{c.y>w&&(w=c.y)}),(!isFinite(w)||w<=0)&&(w=1);let P=c=>m+M-c/(w||1)*M,B=P(0),Z=4;for(let c=0;c<=Z;c++){let N=w*c/Z,k=P(N),C=document.createElementNS(a.namespaceURI,"line");C.setAttribute("x1",String(f)),C.setAttribute("y1",String(k)),C.setAttribute("x2",String(h-y)),C.setAttribute("y2",String(k)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),a.appendChild(C);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(f-4)),L.setAttribute("y",String(k+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(N)),a.appendChild(L)}let _=S>0?b/S:b;if(Q.forEach((c,N)=>{let k=f+_*(N+.5),C=String(c.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(k)),L.setAttribute("y",String(D-A+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=C,a.appendChild(L)}),E){let c=s.createDiv({cls:"chart-notes-legend"});u.forEach((N,k)=>{let C=c.createDiv({cls:"chart-notes-legend-item"}),L=C.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=it(N,k),C.createSpan({text:N})})}Q.forEach((c,N)=>{let k=f+_*(N+.5),C=c.rows;if(T==="single"){let J=C[0],H=J.y,z=_*.6,q=k-z/2,lt=P(H),dt=Math.max(2,B-lt),yt=it("bar",N),V=document.createElementNS(a.namespaceURI,"rect");V.setAttribute("x",String(q)),V.setAttribute("y",String(lt)),V.setAttribute("width",String(z)),V.setAttribute("height",String(dt)),V.setAttribute("fill",yt),V.setAttribute("stroke","rgba(0,0,0,0.25)"),V.setAttribute("stroke-width","0.5"),V.style.cursor="pointer";let j=String(c.label),kt=`valor: ${Math.round(H*100)/100}`;V.addEventListener("mouseenter",at=>{var et,pt;return ft(s,l,j,kt,(pt=(et=J.notes)==null?void 0:et.length)!=null?pt:0,at)}),V.addEventListener("mouseleave",()=>gt(l)),V.addEventListener("click",at=>{var et;at.preventDefault(),mt(s,g,j,H,(et=J.notes)!=null?et:[],o)}),a.appendChild(V);return}let L=u.length,tt=_/Math.max(L+1,2),W=L*tt,rt=k-W/2;u.forEach((J,H)=>{let z=C.find(et=>(et.series!=null?String(et.series):"")===J);if(!z)return;let q=z.y,lt=rt+H*tt,dt=P(q),yt=Math.max(2,B-dt),V=it(J,H),j=document.createElementNS(a.namespaceURI,"rect");j.setAttribute("x",String(lt)),j.setAttribute("y",String(dt)),j.setAttribute("width",String(tt)),j.setAttribute("height",String(yt)),j.setAttribute("fill",V),j.setAttribute("stroke","rgba(0,0,0,0.25)"),j.setAttribute("stroke-width","0.5"),j.style.cursor="pointer";let kt=`${J} @ ${String(c.label)}`,at=`valor: ${Math.round(q*100)/100}`;j.addEventListener("mouseenter",et=>{var pt,Ut;return ft(s,l,kt,at,(Ut=(pt=z.notes)==null?void 0:pt.length)!=null?Ut:0,et)}),j.addEventListener("mouseleave",()=>gt(l)),j.addEventListener("click",et=>{var pt;et.preventDefault(),mt(s,g,kt,q,(pt=z.notes)!=null?pt:[],o)}),a.appendChild(j)})})}function $e(s,e,t){var _,K,O,Y;let n=(_=e.options)!=null?_:{},r=n.background,o=(K=n.drilldown)!=null?K:!0,i=(O=t.rows)!=null?O:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:g}=wt(s,r),x=s.getBoundingClientRect().width||600,h=Math.max(x,480);p.style.width=h+"px";let f=40,y=16,m=18,A=28,D=300;a.setAttribute("height",String(D));let b=h-f-y,M=D-m-A,R=new Map;for(let $ of i){let c=String($.x),N=(Y=R.get(c))!=null?Y:{label:$.x,rows:[]};N.rows.push($),R.set(c,N)}let Q=Array.from(R.keys()).sort(($,c)=>$<c?-1:$>c?1:0).map($=>R.get($)),S=Q.length,v=new Set;i.forEach($=>{$.series!=null&&v.add(String($.series))});let u=Array.from(v);if(!u.length){fe(s,e,t);return}let E=0;Q.forEach($=>{let c=$.rows.reduce((N,k)=>N+k.y,0);c>E&&(E=c)}),(!isFinite(E)||E<=0)&&(E=1);let T=$=>m+M-$/(E||1)*M,w=T(0),P=4;for(let $=0;$<=P;$++){let c=E*$/P,N=T(c),k=document.createElementNS(a.namespaceURI,"line");k.setAttribute("x1",String(f)),k.setAttribute("y1",String(N)),k.setAttribute("x2",String(h-y)),k.setAttribute("y2",String(N)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),a.appendChild(k);let C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(f-4)),C.setAttribute("y",String(N+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=String(Math.round(c)),a.appendChild(C)}let B=S>0?b/S:b;Q.forEach(($,c)=>{let N=f+B*(c+.5),k=String($.label),C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(N)),C.setAttribute("y",String(D-A+12)),C.setAttribute("text-anchor","middle"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=k,a.appendChild(C)});let Z=s.createDiv({cls:"chart-notes-legend"});u.forEach(($,c)=>{let N=Z.createDiv({cls:"chart-notes-legend-item"}),k=N.createDiv();k.style.width="10px",k.style.height="10px",k.style.borderRadius="999px",k.style.backgroundColor=it($,c),N.createSpan({text:$})}),Q.forEach(($,c)=>{let N=f+B*(c+.5),k=B*.6,C=N-k/2,L=0;u.forEach((tt,W)=>{let rt=$.rows.find(at=>(at.series!=null?String(at.series):"")===tt);if(!rt)return;let J=rt.y,H=L,z=L+J;L=z;let q=T(H),lt=T(z),dt=Math.max(2,q-lt),yt=it(tt,W),V=document.createElementNS(a.namespaceURI,"rect");V.setAttribute("x",String(C)),V.setAttribute("y",String(lt)),V.setAttribute("width",String(k)),V.setAttribute("height",String(dt)),V.setAttribute("fill",yt),V.setAttribute("stroke","rgba(0,0,0,0.25)"),V.setAttribute("stroke-width","0.5"),V.style.cursor="pointer";let j=`${tt} @ ${String($.label)}`,kt=`valor: ${Math.round(J*100)/100}`;V.addEventListener("mouseenter",at=>{var et,pt;return ft(s,l,j,kt,(pt=(et=rt.notes)==null?void 0:et.length)!=null?pt:0,at)}),V.addEventListener("mouseleave",()=>gt(l)),V.addEventListener("click",at=>{var et;at.preventDefault(),mt(s,g,j,J,(et=rt.notes)!=null?et:[],o)}),a.appendChild(V)})})}function ge(s,e,t,n){var K,O,Y,$;let r=(K=e.options)!=null?K:{},o=r.background,i=(O=r.drilldown)!=null?O:!0,p=(Y=t.rows)!=null?Y:[];if(!p.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:g,details:x}=wt(s,o),h=s.getBoundingClientRect().width||600,f=Math.max(h,480);a.style.width=f+"px";let y=40,m=16,A=18,D=24,b=300;l.setAttribute("height",String(b));let M=f-y-m,R=b-A-D,F=new Map;for(let c of p){let N=c.series!=null?String(c.series):"__default__",k=($=F.get(N))!=null?$:[];k.push(c),F.set(N,k)}let Q=Array.from(F.keys()),S=[],v=new Set;for(let c of p){let N=String(c.x);v.has(N)||(v.add(N),S.push(c.x))}let u=S.length||1,E=c=>{let N=String(c),k=S.findIndex(C=>String(C)===N);return k<0?y:u===1?y+M/2:y+k/(u-1)*M},T=c=>String(c),w=Number.POSITIVE_INFINITY,P=Number.NEGATIVE_INFINITY;for(let c of p)c.y<w&&(w=c.y),c.y>P&&(P=c.y);(!isFinite(w)||!isFinite(P))&&(w=0,P=1),w===P&&(w===0?P=1:w=0);let B=c=>A+R-(c-w)/(P-w||1)*R,Z=4;for(let c=0;c<=Z;c++){let N=w+(P-w)*c/Z,k=B(N),C=document.createElementNS(l.namespaceURI,"line");C.setAttribute("x1",String(y)),C.setAttribute("y1",String(k)),C.setAttribute("x2",String(f-m)),C.setAttribute("y2",String(k)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),l.appendChild(C);let L=document.createElementNS(l.namespaceURI,"text");L.setAttribute("x",String(y-4)),L.setAttribute("y",String(k+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=Math.abs(N)>=100?String(Math.round(N)):String(Math.round(N*10)/10),l.appendChild(L)}let _=Q.filter(c=>c!=="__default__");if(_.length>1){let c=s.createDiv({cls:"chart-notes-legend"});_.forEach((N,k)=>{let C=N,L=c.createDiv({cls:"chart-notes-legend-item"}),tt=L.createDiv();tt.style.width="10px",tt.style.height="10px",tt.style.borderRadius="999px",tt.style.backgroundColor=it(C,k),L.createSpan({text:C})})}Q.forEach((c,N)=>{let k=F.get(c);if(!(k!=null&&k.length))return;let C=c==="__default__"?it("line",N):it(c,N),L=[...k].sort((W,rt)=>{let J=S.findIndex(z=>String(z)===String(W.x)),H=S.findIndex(z=>String(z)===String(rt.x));return J-H}),tt="";if(L.forEach((W,rt)=>{let J=E(W.x),H=B(W.y);tt+=(rt===0?"M ":" L ")+J+" "+H}),n){let W=L[0],rt=L[L.length-1],J=E(W.x),H=E(rt.x),z=B(w);tt+=` L ${H} ${z} L ${J} ${z} Z`;let q=document.createElementNS(l.namespaceURI,"path");q.setAttribute("d",tt),q.setAttribute("fill",C),q.setAttribute("fill-opacity","0.18"),q.setAttribute("stroke",C),q.setAttribute("stroke-width","1.5"),l.appendChild(q)}else{let W=document.createElementNS(l.namespaceURI,"path");W.setAttribute("d",tt),W.setAttribute("fill","none"),W.setAttribute("stroke",C),W.setAttribute("stroke-width","2"),l.appendChild(W)}L.forEach(W=>{let rt=E(W.x),J=B(W.y),H=document.createElementNS(l.namespaceURI,"circle");H.setAttribute("cx",String(rt)),H.setAttribute("cy",String(J)),H.setAttribute("r","3"),H.setAttribute("fill","#ffffff"),H.setAttribute("stroke",C),H.setAttribute("stroke-width","1.5"),H.style.cursor="pointer";let z=T(W.x),q=c==="__default__"?"":String(W.series),lt=q?`${q} @ ${z}`:z,dt=`valor: ${Math.round(W.y*100)/100}`;H.addEventListener("mouseenter",yt=>{var V,j;return ft(s,g,lt,dt,(j=(V=W.notes)==null?void 0:V.length)!=null?j:0,yt)}),H.addEventListener("mouseleave",()=>gt(g)),H.addEventListener("click",yt=>{var V;yt.preventDefault(),mt(s,x,lt,W.y,(V=W.notes)!=null?V:[],i)}),l.appendChild(H)})})}function Qe(s,e,t){var M;let{background:n,drilldown:r=!0}=(M=e.options)!=null?M:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=_e(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:g}=wt(s,n),x=Math.max(i,420);p.style.width=x+"px",o&&(a.style.color=o);let h=300,f=x/2,y=(h-28+28)/2,m=Math.min(x/2-20,h/2-20),D=t.rows.map(R=>Math.max(0,R.y)).reduce((R,F)=>R+F,0)||1,b=-Math.PI/2;t.rows.forEach((R,F)=>{var _;let Q=R.x instanceof Date?R.x.toISOString().slice(0,10):String(R.x),S=R.y,v=S/D*Math.PI*2,u=f+m*Math.cos(b),E=y+m*Math.sin(b),T=f+m*Math.cos(b+v),w=y+m*Math.sin(b+v),P=v>Math.PI?1:0,B=document.createElementNS(a.namespaceURI,"path"),Z=[`M ${f} ${y}`,`L ${u} ${E}`,`A ${m} ${m} 0 ${P} 1 ${T} ${w}`,"Z"].join(" ");B.setAttribute("d",Z),B.setAttribute("fill",it((_=R.series)!=null?_:Q,F)),B.style.cursor="pointer",B.addEventListener("mouseenter",K=>{var O,Y;return ft(s,l,Q,S,(Y=(O=R.notes)==null?void 0:O.length)!=null?Y:0,K)}),B.addEventListener("mouseleave",()=>gt(l)),B.addEventListener("click",()=>{var K;return mt(s,g,Q,S,(K=R.notes)!=null?K:[],r)}),a.appendChild(B),b+=v})}function Ge(s,e,t){var E;let{background:n,drilldown:r=!0}=(E=e.options)!=null?E:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:g}=wt(s,n),x=Math.max(i,700);p.style.width=x+"px",o&&(a.style.color=o);let h=300,f=x-48-10,y=h-28-28,m=t.rows.map(T=>{let w=T.x;if(w instanceof Date)return w.getTime();if(typeof w=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(w)){let B=new Date(w);if(!isNaN(B.getTime()))return B.getTime()}let P=Number(w);return isNaN(P)?null:P}return typeof w=="number"?w:null}),A=t.rows.map(T=>T.y),D=m.filter(T=>T!==null);if(D.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let b=Math.min(...D),M=Math.max(...D),R=Math.min(...A),F=Math.max(...A),Q=T=>48+(T-b)/(M-b||1)*f,S=T=>h-28-(T-R)/(F-R||1)*y,v=document.createElementNS(a.namespaceURI,"line");v.setAttribute("x1",String(48)),v.setAttribute("y1",String(28)),v.setAttribute("x2",String(48)),v.setAttribute("y2",String(h-28)),v.setAttribute("stroke","currentColor"),a.appendChild(v);let u=document.createElementNS(a.namespaceURI,"line");u.setAttribute("x1",String(48)),u.setAttribute("y1",String(h-28)),u.setAttribute("x2",String(x-10)),u.setAttribute("y2",String(h-28)),u.setAttribute("stroke","currentColor"),a.appendChild(u),t.rows.forEach((T,w)=>{let P=m[w];if(P==null)return;let B=Q(P),Z=S(A[w]),_=document.createElementNS(a.namespaceURI,"circle");_.setAttribute("cx",String(B)),_.setAttribute("cy",String(Z)),_.setAttribute("r","4"),_.setAttribute("fill",it(T.series,w)),_.style.cursor="pointer";let K=T.x instanceof Date?T.x.toISOString().slice(0,10):typeof T.x=="string"?T.x:String(T.x);_.addEventListener("mouseenter",O=>{var Y,$;return ft(s,l,K,T.y,($=(Y=T.notes)==null?void 0:Y.length)!=null?$:0,O)}),_.addEventListener("mouseleave",()=>gt(l)),_.addEventListener("click",O=>{var Y;O.preventDefault(),mt(s,g,K,T.y,(Y=T.notes)!=null?Y:[],r)}),a.appendChild(_)})}var se=class{render(e,t,n,r){var a;let{title:o}=(a=t.options)!=null?a:{};e.empty(),e.addClass("prop-charts-container");let p=e.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(o&&(p.textContent=o),t.type){case"bar":fe(e,t,n);break;case"stacked-bar":$e(e,t,n);break;case"line":ge(e,t,n,!1);break;case"area":ge(e,t,n,!0);break;case"pie":Qe(e,t,n);break;case"scatter":Ge(e,t,n);break;case"gantt":ne(e,t,n,r);break;default:e.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}}};var oe=class extends Vt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("Chart Notes: loading plugin (Bases-only)"),this.indexer=new Zt(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Vt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Vt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Vt.TFile&&this.indexer.removeFile(t)})),this.registerBasesView(ue,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new qt(t,n,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},n={type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",shouldHide:D=>{var b;return String((b=D.get("chartType"))!=null?b:"bar")==="gantt"}},r={type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:"Texto mostrado em cada tarefa. Se vazio, usa o nome da nota.",shouldHide:D=>{var b;return String((b=D.get("chartType"))!=null?b:"bar")!=="gantt"}},o={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:D=>{var M;let b=String((M=D.get("chartType"))!=null?M:"bar");return b==="pie"||b==="gantt"}},i={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:D=>{var b;return String((b=D.get("chartType"))!=null?b:"bar")==="pie"}},p={type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum (line/area only)"},shouldHide:D=>{var M;let b=String((M=D.get("chartType"))!=null?M:"bar");return b!=="line"&&b!=="area"}},a={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (keep date/time)",none:"None (raw)",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:D=>{var M;let b=String((M=D.get("chartType"))!=null?M:"bar");return b==="pie"||b==="scatter"||b==="gantt"}},l=(D,b,M)=>({type:"property",key:D,displayName:b,description:M,shouldHide:R=>{var F;return String((F=R.get("chartType"))!=null?F:"")!=="gantt"}}),g=l("startProperty","Start (Gantt)","Data/hora de in\xEDcio. Se faltar, tentamos inferir via fim + dura\xE7\xE3o."),x=l("endProperty","End (Gantt)","Data/hora de fim da barra (geralmente 'scheduled' ou 'finish')."),h=l("dueProperty","Due (deadline, optional)","Deadline. Usado como fallback quando h\xE1 due + dura\xE7\xE3o, e mostrado no tooltip."),f=l("durationProperty","Duration in minutes (optional)","Estimativa em minutos. Usada para inferir start/end quando s\xF3 um dos lados existe."),y=l("groupProperty","Group / lane (optional)","Projeto/\xE1rea usada como lane no lado esquerdo do Gantt.");return[t,n,r,o,i,p,a,g,x,h,f,y,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
