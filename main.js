/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Xe=(o,r)=>{for(var t in r)le(o,t,{get:r[t],enumerable:!0})},qe=(o,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Oe(r))!Ye.call(o,s)&&s!==t&&le(o,s,{get:()=>r[s],enumerable:!(e=Ue(r,s))||e.enumerable});return o};var je=o=>qe(le({},"__esModule",{value:!0}),o);var lr={};Xe(lr,{default:()=>se});module.exports=je(lr);var Lt=require("obsidian");var Kt=require("obsidian"),ce="chartnotes-view",Te=["bar","stacked-bar","line","area","pie","scatter","gantt"];function Re(o){let r=String(o!=null?o:"bar").trim().toLowerCase();return Te.includes(r)?r:"bar"}var qt=class extends Kt.BasesView{constructor(t,e,s){super(t);this.type=ce;this.settings={chartType:"bar",xProperty:null,yProperty:null,seriesProperty:null,startProperty:null,endProperty:null,dueProperty:null,durationProperty:null,groupProperty:null};this.groupedData=[];this.initializedFromConfig=!1;this.renderer=s,this.containerEl=e,this.containerEl.empty(),this.containerEl.addClass("chartnotes-bases-root"),this.controlsEl=this.containerEl.createDiv("chartnotes-bases-controls"),this.chartEl=this.containerEl.createDiv("chartnotes-bases-chart");let n=this.controlsEl.style;n.display="flex",n.flexWrap="wrap",n.alignItems="flex-end",n.gap="8px",n.margin="8px 0",n.padding="6px 8px",n.borderBottom="1px solid var(--background-modifier-border)",n.backgroundColor="var(--background-secondary)";let i=this.controlsEl.createEl("div");i.textContent="Chart Notes \u2013 controles (UI interna)",i.style.fontWeight="bold",i.style.marginRight="12px"}onDataUpdated(){var e;let t=this.data;this.groupedData=(e=t==null?void 0:t.groupedData)!=null?e:[],this.initializedFromConfig||(this.loadSettingsFromConfig(),this.ensureDefaultsFromOrder(),this.initializedFromConfig=!0),this.buildControlsUI(),this.renderChart()}loadSettingsFromConfig(){let t=this.config;if(!t)return;let e=n=>{try{let i=t.get(n);if(typeof i=="string"&&i.trim().length>0)return i}catch(i){}return null},s=e("chartType");s&&(this.settings.chartType=s),this.settings.xProperty=e("xProperty"),this.settings.yProperty=e("yProperty"),this.settings.seriesProperty=e("seriesProperty"),this.settings.startProperty=e("startProperty"),this.settings.endProperty=e("endProperty"),this.settings.dueProperty=e("dueProperty"),this.settings.durationProperty=e("durationProperty"),this.settings.groupProperty=e("groupProperty")}saveSettingsToConfig(){let t=this.config;if(!t||typeof t.set!="function")return;let e=(s,n)=>{try{t.set(s,n!=null?n:null)}catch(i){}};e("chartType",this.settings.chartType),e("xProperty",this.settings.xProperty),e("yProperty",this.settings.yProperty),e("seriesProperty",this.settings.seriesProperty),e("startProperty",this.settings.startProperty),e("endProperty",this.settings.endProperty),e("dueProperty",this.settings.dueProperty),e("durationProperty",this.settings.durationProperty),e("groupProperty",this.settings.groupProperty)}ensureDefaultsFromOrder(){var n,i;let t=this.config,e=(i=(n=t==null?void 0:t.getOrder)==null?void 0:n.call(t))!=null?i:[];if(!e.length)return;let s=y=>y>=0&&y<e.length?e[y]:null;this.settings.xProperty||(this.settings.xProperty=s(0)),this.settings.yProperty||(this.settings.yProperty=s(1)),this.settings.seriesProperty||(this.settings.seriesProperty=s(2))}buildControlsUI(){var l,p;let t=Array.from(this.controlsEl.children);for(let d=1;d<t.length;d++)t[d].remove();let e=this.config,s=(p=(l=e==null?void 0:e.getOrder)==null?void 0:l.call(e))!=null?p:[],n=this.controlsEl.createDiv("chartnotes-control"),i=n.createEl("label");i.textContent="Tipo:",i.style.marginRight="4px";let y=n.createEl("select");for(let d of Te){let S=y.createEl("option");S.value=d,S.text=d}y.value=Re(this.settings.chartType),y.onchange=()=>{this.settings.chartType=y.value,this.saveSettingsToConfig(),this.renderChart()};let a=(d,S)=>{var A,F,M;let b=this.controlsEl.createDiv("chartnotes-control"),m=b.createEl("label");m.textContent=S,m.style.marginRight="4px";let g=b.createEl("select"),E=g.createEl("option");E.value="",E.text="(auto)";for(let _ of s){let H=_;try{let v=(0,Kt.parsePropertyId)(_),c=(A=v.type)!=null?A:"",w=(F=v.name)!=null?F:_;H=c?`${w} (${c})`:w}catch(v){}let C=g.createEl("option");C.value=_,C.text=H}let N=(M=this.settings[d])!=null?M:"";N&&(g.value=N),g.onchange=()=>{let _=g.value||null;this.settings[d]=_,this.saveSettingsToConfig(),this.renderChart()}};a("xProperty","X:"),a("yProperty","Y:"),a("seriesProperty","S\xE9rie:"),a("startProperty","In\xEDcio:"),a("endProperty","Fim:"),a("dueProperty","Due:"),a("durationProperty","Dura\xE7\xE3o:"),a("groupProperty","Grupo:")}renderChart(){var p;if(this.chartEl.empty(),!this.groupedData||this.groupedData.length===0){this.chartEl.createDiv({cls:"prop-charts-empty",text:"Sem dados (Base vazia ou sem resultados)."});return}let t=Re(this.settings.chartType),e;if(t==="gantt"?e=this.buildRowsForGantt(this.groupedData):t==="scatter"?e=this.buildRowsForScatter(this.groupedData):e=this.buildRowsForAggregatedCharts(this.groupedData),!e.length){this.chartEl.createDiv({cls:"prop-charts-empty",text:"Sem linhas para exibir (verifique as propriedades X/Y)."});return}let s={rows:e},n=this.buildEncoding(),i=this.config,y=(p=i==null?void 0:i.name)!=null?p:"Chart Notes (Bases)",a={type:t,source:{type:"properties",query:""},encoding:n,options:{title:y,drilldown:!0}},l={refresh:()=>this.onDataUpdated()};this.renderer.render(this.chartEl,a,s,l)}getSelectedProp(t){var s;let e=this.settings[t];if(!e)return{id:null,name:null};try{let n=(0,Kt.parsePropertyId)(e);return{id:e,name:(s=n.name)!=null?s:e}}catch(n){return{id:e,name:e}}}readValue(t,e){if(!e.id)return null;let s;try{s=t.getValue(e.id)}catch(n){return null}if(!s)return null;try{if(typeof s.isEmpty=="function"&&s.isEmpty())return null}catch(n){}try{let n=s.toString();if(n==null)return null;let i=String(n).trim();return i.length?i:null}catch(n){return null}}parseDate(t){if(!t)return null;let e=t.trim();if(!e)return null;let s=new Date(e);return Number.isNaN(s.getTime())?null:s}buildRowsForAggregatedCharts(t){var y,a;let e=this.getSelectedProp("xProperty"),s=this.getSelectedProp("yProperty"),n=this.getSelectedProp("seriesProperty"),i=new Map;for(let l of t)for(let p of l.entries){let d=p.file,S=(a=this.readValue(p,e))!=null?a:d!=null&&d.name?String(d.name):String((y=d==null?void 0:d.path)!=null?y:""),b=this.readValue(p,s),m=1;if(s.id){if(b==null)continue;let F=Number(b);if(Number.isNaN(F))continue;m=F}let g=this.readValue(p,n),E=g!=null?String(g):void 0,N=`${S}@@${E!=null?E:""}`,A=i.get(N);A||(A={x:S,y:0,series:E,notes:[],props:{}},i.set(N,A)),A.y+=m,d!=null&&d.path&&A.notes.push(d.path),A.props&&e.name&&(A.props[e.name]=S),A.props&&s.name&&b!=null&&(A.props[s.name]=m),A.props&&n.name&&g!=null&&(A.props[n.name]=g)}return Array.from(i.values())}buildRowsForScatter(t){let e=this.getSelectedProp("xProperty"),s=this.getSelectedProp("yProperty"),n=this.getSelectedProp("seriesProperty"),i=[];for(let y of t)for(let a of y.entries){let l=a.file,p=this.readValue(a,e),d=this.readValue(a,s);if(p==null||d==null)continue;let S=Number(p),b=Number(d);if(Number.isNaN(S)||Number.isNaN(b))continue;let m=this.readValue(a,n),g=m!=null?String(m):void 0,E={x:S,y:b,series:g,notes:l!=null&&l.path?[l.path]:[],props:{}};i.push(E)}return i}buildRowsForGantt(t){var d,S;let e=this.getSelectedProp("xProperty"),s=this.getSelectedProp("seriesProperty"),n=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),y=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),l=this.getSelectedProp("groupProperty"),p=[];for(let b of t)for(let m of b.entries){let g=m.file,E=this.readValue(m,n),N=this.readValue(m,i);if(!E||!N)continue;let A=this.parseDate(E),F=this.parseDate(N);if(!A||!F)continue;let M=(S=this.readValue(m,e))!=null?S:g!=null&&g.name?String(g.name).replace(/\.md$/i,""):String((d=g==null?void 0:g.path)!=null?d:""),_=this.readValue(m,y),H=this.parseDate(_!=null?_:null),C=this.readValue(m,a),v=C!=null?Number(C):void 0,c=typeof v=="number"&&!Number.isNaN(v),w=this.readValue(m,s),R=w!=null?String(w):void 0,x=this.readValue(m,l),L={};a.name&&c&&(L[a.name]=v),l.name&&x!=null&&(L[l.name]=x);let B={x:M,y:0,series:R,start:A,end:F,due:H!=null?H:void 0,notes:g!=null&&g.path?[g.path]:[],props:L};p.push(B)}return p}buildEncoding(){var p,d,S,b,m,g,E,N;let t=this.getSelectedProp("xProperty"),e=this.getSelectedProp("yProperty"),s=this.getSelectedProp("seriesProperty"),n=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),y=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),l=this.getSelectedProp("groupProperty");return{x:(p=t.name)!=null?p:"x",y:(d=e.name)!=null?d:"y",series:(S=s.name)!=null?S:"series",start:(b=n.name)!=null?b:"start",end:(m=i.name)!=null?m:"end",due:(g=y.name)!=null?g:"due",duration:(E=a.name)!=null?E:"duration",group:(N=l.name)!=null?N:"group"}}};var Ne=require("obsidian"),jt=class{constructor(r){this.index=new Map;this.app=r}async buildIndex(){this.index.clear();let r=this.app.vault.getMarkdownFiles();for(let t of r)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(r){if(r.extension!=="md")return;let t={};try{let s=(await this.app.vault.read(r)).match(/^---\n([\s\S]*?)\n---\n?/);if(s){let i=(0,Ne.parseYaml)(s[1])||{};if(i&&typeof i=="object")for(let[y,a]of Object.entries(i))y!=="position"&&(t[y]=a)}let n=this.app.metadataCache.getFileCache(r);n!=null&&n.tags&&!t.tags&&(t.tags=n.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",r.path,e)}this.index.set(r.path,{path:r.path,props:t})}removeFile(r){this.index.delete(r.path)}};function Le(o,r){if(!r||r.length===0)return!0;for(let t of r){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Ie(o,r){if(!r||r.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let s of r)if(t.includes(s)||t.includes("#"+s))return!0;return!1}let e=String(t);for(let s of r)if(e===s||e==="#"+s)return!0;return!1}function Jt(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function $t(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,s]=o.split("-");return new Date(Number(t),Number(e)-1,Number(s),0,0,0,0)}let r=new Date(o);return isNaN(r.getTime())?null:r}function ut(o){let r=new Date(o);return r.setHours(0,0,0,0),r}function Zt(o,r){let t=new Date(o);return t.setDate(t.getDate()-r),t}function Ze(o,r){return Zt(o,r*7)}function Je(o,r){let t=new Date(o);return t.setMonth(t.getMonth()-r),t}function de(o,r){let t=new Date(o);return t.setDate(t.getDate()+r),t}function tr(o,r){return de(o,r*7)}function er(o,r){let t=new Date(o);return t.setMonth(t.getMonth()+r),t}function ke(o){let r=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(r)||r.endsWith("date")||r.endsWith("at")||r.endsWith("on"))}function Me(o,r){let t=r?new Date(r):new Date,e=ut(t),s=o.trim().toLowerCase();if(s==="today")return e;if(s==="yesterday")return ut(Zt(e,1));if(/^-\d+$/.test(s)){let n=parseInt(s.slice(1),10);return ut(Zt(e,n))}if(/^-\d+d$/.test(s)){let n=parseInt(s.slice(1,-1),10);return ut(Zt(e,n))}if(/^-\d+w$/.test(s)){let n=parseInt(s.slice(1,-1),10);return ut(Ze(e,n))}if(/^-\d+m$/.test(s)){let n=parseInt(s.slice(1,-1),10);return ut(Je(e,n))}if(/^\+\d+$/.test(s)){let n=parseInt(s.slice(1),10);return ut(de(e,n))}if(/^\+\d+d$/.test(s)){let n=parseInt(s.slice(1,-1),10);return ut(de(e,n))}if(/^\+\d+w$/.test(s)){let n=parseInt(s.slice(1,-1),10);return ut(tr(e,n))}if(/^\+\d+m$/.test(s)){let n=parseInt(s.slice(1,-1),10);return ut(er(e,n))}return null}function Fe(o){let r=o.trim(),t=r.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let p=t[1].trim(),d=t[2].trim(),S=t[3].trim(),b=ke(p),m=ue(d,b),g=ue(S,b),E=m.valueType==="date"||g.valueType==="date"?"date":m.valueType;return{field:p,op:"between",value:m.value,value2:g.value,valueType:E}}let e=/(==|!=|>=|<=|>|<)/,s=r.split(e);if(s.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let n=s[0].trim(),i=s[1].trim(),y=s[2].trim(),a=ke(n),l=ue(y,a);return{field:n,op:i,value:l.value,valueType:l.valueType}}function ue(o,r){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),s=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(r){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(s){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(Jt(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let n=Number(t);return Number.isNaN(n)?{value:t,valueType:"string"}:{value:n,valueType:"number"}}function _e(o,r){let t=o[r.field];if(t==null)return!1;if(r.valueType==="date"){let n=t instanceof Date?ut(t):Jt(t)?ut($t(t)):null;if(!n)return!1;let i=r.value instanceof Date?r.value:null,y=r.value2 instanceof Date?r.value2:null;if(!i)return!1;let a=n.getTime(),l=ut(i).getTime();switch(r.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!y)return!1;let p=ut(y).getTime();return a>=l&&a<=p}}if(r.valueType==="number"){let n=Number(t);if(isNaN(n))return!1;let i=Number(r.value);switch(r.op){case"==":return n===i;case"!=":return n!==i;case">":return n>i;case">=":return n>=i;case"<":return n<i;case"<=":return n<=i;case"between":return typeof r.value2!="number"?!1:n>=i&&n<=r.value2}}let e=String(t),s=String(r.value);switch(r.op){case"==":return e===s;case"!=":return e!==s;case">":return e>s;case">=":return e>=s;case"<":return e<s;case"<=":return e<=s;case"between":return!1}}function rr(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(Jt(o)){let r=$t(o);if(r)return{key:r,isDate:!0}}return{key:o,isDate:!1}}function nr(o,r){let t=o.x,e=r.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let s=String(t),n=String(e);return s<n?-1:s>n?1:0}function sr(o,r){var n,i;let t=nr(o,r);if(t!==0)return t;let e=(n=o.series)!=null?n:"",s=(i=r.series)!=null?i:"";return e<s?-1:e>s?1:0}function or(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let r=o.trim().match(/^(\d+)/);if(r){let t=Number(r[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function ir(o){var e,s;let r=new Map,t=[];for(let n of o){let i=(e=n.series)!=null?e:"__no_series__",a=((s=r.get(i))!=null?s:0)+n.y;r.set(i,a),t.push({...n,y:a})}return t}function ar(o,r){var i,y;let t=or(r);if(!t||t<=1)return[...o];let e=new Map,s=new Map,n=[];for(let a of o){let l=(i=a.series)!=null?i:"__no_series__",p=e.get(l);p||(p=[],e.set(l,p));let d=(y=s.get(l))!=null?y:0;if(p.push(a.y),d+=a.y,p.length>t){let m=p.shift();d-=m}s.set(l,d);let S=p.length||1,b=d/S;n.push({...a,y:b})}return n}var te=class{constructor(r,t){this.getIndex=r,this.defaultPaths=t}run(r){var i,y,a;let t=this.getIndex(),e=(i=r.source)!=null&&i.paths&&r.source.paths.length?r.source.paths:this.defaultPaths,s=(y=r.source)!=null&&y.tags&&r.source.tags.length?r.source.tags:[],n=[];for(let l of t){let p=e&&e.length?Le(l.path,e):!0,d=s&&s.length?Ie(l.props,s):!0;if(!p||!d)continue;let S=!0;if((a=r.source)!=null&&a.where&&r.source.where.length>0)for(let b of r.source.where){let m;try{m=Fe(b)}catch(g){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${b} (${g.message})`)}if(!_e(l.props,m)){S=!1;break}}S&&n.push(l)}return r.type==="gantt"?this.runGantt(r,n):r.type==="table"?this.runTable(r,n):this.runStandard(r,n)}runTable(r,t){var s,n;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(s=r.encoding)==null?void 0:s.x,yField:(n=r.encoding)==null?void 0:n.y}}runGantt(r,t){var d,S,b;let e=(d=r.encoding)!=null?d:{},s=e.start,n=e.end,i=(S=e.label)!=null?S:e.x,y=e.series,a=e.duration,l=e.due,p=[];for(let m of t){let g=(b=m.props)!=null?b:{},E=C=>Array.isArray(C)?C[0]:C,N=null;if(n){let C=E(g[n]),v=$t(C);v&&(N=v)}if(!N)continue;let A=null;if(s){let C=E(g[s]),v=$t(C);v&&(A=v)}if(!A&&a){let C=E(g[a]),v=Number(C);Number.isNaN(v)||(A=new Date(N.getTime()-v*6e4))}A||(A=new Date(N.getTime()));let F;if(l){let C=E(g[l]),v=$t(C);v&&(F=v)}let M;if(i){let C=E(g[i]);(C==null||C==="")&&(C=m.path),M=C}else M=m.path;let _;if(y){let C=E(g[y]);C!=null&&(_=String(C))}let H={x:M,y:0,notes:[m.path],series:_,start:A,end:N,props:g};F&&(H.due=F),p.push(H)}return p.sort((m,g)=>{let E=m.start?m.start.getTime():0,N=g.start?g.start.getTime():0;return E-N}),{rows:p,xField:i,yField:n}}runStandard(r,t){var m,g,E,N,A,F,M,_,H,C;let e=(m=r.encoding)==null?void 0:m.x,s=(g=r.encoding)==null?void 0:g.y,n=(E=r.encoding)==null?void 0:E.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(N=r.aggregate)!=null?N:{},y=(A=i.y)!=null?A:null,a=!!i.cumulative,l=i.rolling;if(!s&&y!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let p=[];for(let v of t){let c=(F=v.props)!=null?F:{},w=Q=>Array.isArray(Q)?Q[0]:Q,R=w(c[e]);if(R==null)continue;let x=rr(R),L=x.key,B=x.isDate,rt;if(n){let Q=w(c[n]);Q!=null&&String(Q).trim()!==""&&(rt=String(Q))}let W;if(y==="count")W=1;else{let Q=w(c[s]);if(Q==null)continue;let j=Number(Q);if(Number.isNaN(j))continue;W=j}p.push({x:L,y:W,notes:[v.path],series:rt,props:c,_isDate:B,_origX:R})}if(p.length===0)return{rows:[],xField:e,yField:s};let d=[];if(y){let v=new Map;for(let c of p){let w=(M=c.series)!=null?M:"",R=c.x instanceof Date?c.x.toISOString().slice(0,10):String(c.x),x=w+"||"+R,L=(_=v.get(x))!=null?_:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:c.x,isDate:c._isDate,series:c.series,props:c.props};L.sum+=c.y,L.count+=1,c.y<L.min&&(L.min=c.y),c.y>L.max&&(L.max=c.y),L.notes.push(...c.notes),L.props=(H=c.props)!=null?H:L.props,v.set(x,L)}for(let[,c]of v){let w=c.sum;switch(y){case"sum":w=c.sum;break;case"avg":w=c.sum/c.count;break;case"min":w=c.min;break;case"max":w=c.max;break;case"count":w=c.count;break}d.push({x:c.xRep,y:w,notes:c.notes,series:c.series,props:c.props})}}else d=p.map(v=>({x:v.x,y:v.y,notes:v.notes,series:v.series,props:v.props}));if(d.length===0)return{rows:[],xField:e,yField:s};let S=((C=r.sort)==null?void 0:C.x)==="desc"?"desc":"asc";if(d.sort((v,c)=>{let w=sr(v,c);return S==="asc"?w:-w}),(a||l)&&!(r.type==="line"||r.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let b=d;return l?b=ar(d,l):a&&(b=ir(d)),{rows:b,xField:e,yField:s}}};var Pt=require("obsidian");var $e=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,r){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,s)=>e*33+s.charCodeAt(0)>>>0,0);return $e[t%$e.length]}function wt(o,r){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,r&&(e.style.background=r);let s="http://www.w3.org/2000/svg",n=document.createElementNS(s,"svg");n.setAttribute("width","100%"),n.setAttribute("height",String(300)),n.style.display="block",e.appendChild(n);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let y=o.createDiv({cls:"chart-notes-details"});return y.style.display="none",{scroll:t,inner:e,svg:n,tooltip:i,details:y}}function gt(o,r,t,e,s,n){let i=o.getBoundingClientRect(),y=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);r.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${y}</div>
    <div class="chart-notes-tooltip-notes">${s} nota${s===1?"":"s"}</div>
  `,r.style.display="block";let a=r.getBoundingClientRect(),l=n.clientX-i.left+6,p=n.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),p+a.height>i.height-4&&(p=i.height-a.height-4),p<4&&(p=4),r.style.left=l+"px",r.style.top=p+"px"}function ft(o){o.style.display="none"}function mt(o,r,t,e,s,n){if(!n)return;if(r.empty(),!s||s.length===0){r.style.display="none";return}r.style.display="block";let i=r.createEl("div",{cls:"chart-notes-details-header"}),y=i.createEl("div",{cls:"chart-notes-details-title"});y.textContent=`Notas em "${t}" (${s.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{r.style.display="none"});let l=r.createEl("ul",{cls:"chart-notes-details-list"});for(let p of s){let S=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:p});S.href="#",S.addEventListener("click",b=>{b.preventDefault(),app.workspace.openLinkText(p,"",!1)})}}function Wt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let r=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${r}/${t}`}function He(o){if(!o)return!1;let r=o.trim().toLowerCase();if(r==="#fff"||r==="#ffffff"||r==="white")return!0;if(!r.startsWith("#"))return!1;let t,e,s;if(r.length===4)t=parseInt(r[1]+r[1],16),e=parseInt(r[2]+r[2],16),s=parseInt(r[3]+r[3],16);else if(r.length===7)t=parseInt(r.slice(1,3),16),e=parseInt(r.slice(3,5),16),s=parseInt(r.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*s)/255>.7}var pe=class extends Pt.Modal{constructor(t,e,s,n){var y;super(app);this.notePath=t,this.spec=e,this.refresh=s,this.reindexFile=n;let i=(y=e.encoding)!=null?y:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var C,v;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Pt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let s=await this.app.vault.read(e),n={},i=s,y=/^---\n([\s\S]*?)\n---\n?/m.exec(s);if(y){try{n=(C=(0,Pt.parseYaml)(y[1]))!=null?C:{}}catch(c){n={}}i=s.slice(y[0].length)}(typeof n!="object"||n==null)&&(n={});let a=(v=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?v:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),p=l.createEl("a",{text:a,cls:"gantt-edit-title"});p.href="#",p.addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let d=l.createDiv({cls:"gantt-edit-subtitle"});d.textContent=this.notePath;let S=t.createDiv({cls:"gantt-edit-form"}),b=c=>{let w=S.createDiv({cls:"gantt-edit-row"}),R=w.createDiv({cls:"gantt-edit-label"});R.textContent=c;let x=w.createDiv({cls:"gantt-edit-field"});return{row:w,field:x}},m=c=>{if(!c)return"";let R=String(c).match(/^(\d{4}-\d{2}-\d{2})/);return R?R[1]:""},g=c=>{if(c=c.trim(),!!c&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c},E=null;if(this.startKey){let{field:c}=b(this.startKey+" (in\xEDcio)");E=c.createEl("input",{type:"date"}),E.value=m(n[this.startKey])}let N=null;if(this.endKey){let{field:c}=b(this.endKey+" (fim)");N=c.createEl("input",{type:"date"}),N.value=m(n[this.endKey])}let A=null;if(this.durationKey){let{field:c}=b(this.durationKey+" (minutos)");A=c.createEl("input",{type:"number"});let w=n[this.durationKey];A.value=w!=null?String(w):"",A.min="0",A.step="5"}let F=null;if(this.dueKey){let{field:c}=b(this.dueKey+" (due)");F=c.createEl("input",{type:"date"}),F.value=m(n[this.dueKey])}let M=t.createDiv({cls:"gantt-edit-buttons"}),_=M.createEl("button",{text:"Salvar",cls:"mod-cta"});M.createEl("button",{text:"Cancelar"}).addEventListener("click",c=>{c.preventDefault(),this.close()}),_.addEventListener("click",async c=>{if(c.preventDefault(),this.startKey&&E){let x=g(E.value);x?n[this.startKey]=x:delete n[this.startKey]}if(this.endKey&&N){let x=g(N.value);x?n[this.endKey]=x:delete n[this.endKey]}if(this.durationKey&&A){let x=A.value.trim();if(x==="")delete n[this.durationKey];else{let L=Number(x);Number.isNaN(L)||(n[this.durationKey]=L)}}if(this.dueKey&&F){let x=g(F.value);x?n[this.dueKey]=x:delete n[this.dueKey]}let R=`---
${(0,Pt.stringifyYaml)(n).trim()}
---
`+i;if(await this.app.vault.modify(e,R),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(x){}if(this.refresh)try{this.refresh()}catch(x){}new Pt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ee(o,r,t,e){var me,be,xe,ve,Se,we,Ae,Ee;let s=(me=r.options)!=null?me:{},n=s.background,i=(be=s.drilldown)!=null?be:!0,y=!0,a=u=>{if(u==null)return"";let T=String(u).trim();if(!T)return"";let $=T.match(/^\[\[(.+?)\]\]$/);$&&(T=$[1]);let O=T.lastIndexOf("/");return O>=0&&O<T.length-1&&(T=T.slice(O+1)),T};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(u=>u.start&&u.end);if(l.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let p=r.encoding,d=p.group,S=p.duration,b=(u,T)=>{if(!u||!T)return;let $=u[T];return Array.isArray($)?$[0]:$},g=l.map(u=>{var xt,ct;let T=u.start,$=u.end,O=u.props,It=typeof u.x=="string"?u.x:u.x instanceof Date?Wt(T):String(u.x),At=a(It),bt,Ft=d?b(O,d):void 0;Ft!=null?bt=String(Ft):u.series!=null?bt=String(u.series):bt=At;let yt=(xt=u.notes)==null?void 0:xt[0],Et=yt?(ct=yt.replace(/\.md$/i,"").split("/").pop())!=null?ct:yt:At,Ct=u.due,_t,kt=b(O,S);if(kt!=null){let vt=Number(kt);Number.isNaN(vt)||(_t=vt)}return{row:u,start:T,end:$,props:O,fullName:At,groupKey:bt,notePath:yt,noteTitle:Et,due:Ct,estMinutes:_t}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(g.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}g.sort((u,T)=>{if(u.groupKey<T.groupKey)return-1;if(u.groupKey>T.groupKey)return 1;let $=u.start.getTime(),O=T.start.getTime();return $!==O?$-O:u.fullName.localeCompare(T.fullName)});let E=26,N=0,A=null;for(let u of g)u.groupKey!==A&&(A=u.groupKey,N+=1),N+=1;let F=Math.min(...g.map(u=>u.start.getTime())),M=Math.max(...g.map(u=>u.end.getTime()));if(!isFinite(F)||!isFinite(M)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let _=24*60*60*1e3,H=u=>{let T=new Date(u);return T.setHours(0,0,0,0),T.getTime()},C=H(F),v=H(M),c=o.querySelector(".prop-charts-title-row");c||(c=o.createDiv({cls:"prop-charts-title-row"}));let w=o.dataset.ganttZoomMode||String((xe=s.zoomMode)!=null?xe:"100");o.dataset.ganttZoomMode=w;let R=o.dataset.ganttLabelMode||String((ve=s.labelMode)!=null?ve:"compact");o.dataset.ganttLabelMode=R;let x=c.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let T=x.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===w&&T.addClass("is-active"),T.addEventListener("click",$=>{$.preventDefault(),o.dataset.ganttZoomMode=u.id,ee(o,r,t,e)})}),x.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let T=o.querySelector(".chart-notes-zoom-button");T&&T.click()});let rt=Number(s.labelWidth),W=!Number.isNaN(rt)&&rt>120?rt:260,Q=R==="wide"?W+160:W,j=o.getBoundingClientRect().width||600,tt=Math.max(j,820),I;if(w==="fit")I=j;else{let u=Number(w)/100||1;I=tt*u}let{inner:h,svg:f,tooltip:D,details:P}=wt(o,n);h.style.width=I+"px";let k=(u,T,$,O,It,At,bt,Ft,yt)=>{if(!u)return;let Et=Math.max(40,O-8),_t=Math.max(8,Math.floor(Et/6)),kt=u.split(/\s+/),xt=[],ct="";for(let Rt of kt){if(!ct){ct=Rt;continue}(ct+" "+Rt).length<=_t?ct+=" "+Rt:(xt.push(ct),ct=Rt)}ct&&xt.push(ct);let vt=It+2,zt=xt.length*vt,Vt=$-zt/2+It;xt.forEach((Rt,Yt)=>{let ot=document.createElementNS(f.namespaceURI,"text");ot.setAttribute("x",String(T)),ot.setAttribute("y",String(Vt+Yt*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Rt,bt&&ot.addEventListener("mouseenter",nt=>bt(nt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),yt&&(ot.style.cursor="pointer",ot.addEventListener("click",nt=>yt(nt))),f.appendChild(ot)})},Z=28,G=28,st=10,Y=Math.max(300,Z+G+N*E+24);f.setAttribute("height",String(Y));let V=I-Q-st,K=Z+6;f.style.color="#111111";let J=v+_-C||1,at=C-J*.02,ht=v+_+J*.08,lt=u=>Q+(u-at)/(ht-at)*V,z=(ht-at)/_,Nt=Math.max(4,Math.min(12,Math.floor(V/90)||4)),dt=z/Nt,q=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=q[q.length-1];for(let u of q)if(u>=dt){pt=u;break}let Gt=[],Ge=H(at);for(let u=Ge;u<=ht+.5*_;u+=pt*_)Gt.push(u);let Ht=document.createElementNS(f.namespaceURI,"line");Ht.setAttribute("x1",String(Q)),Ht.setAttribute("y1",String(K)),Ht.setAttribute("x2",String(I-st)),Ht.setAttribute("y2",String(K)),Ht.setAttribute("stroke","#111111"),f.appendChild(Ht);for(let u of Gt){let T=lt(u),$=document.createElementNS(f.namespaceURI,"line");$.setAttribute("x1",String(T)),$.setAttribute("y1",String(K)),$.setAttribute("x2",String(T)),$.setAttribute("y2",String(Y-G)),$.setAttribute("stroke","#111111"),$.setAttribute("stroke-opacity","0.20"),$.setAttribute("stroke-dasharray","2,4"),f.appendChild($);let O=document.createElementNS(f.namespaceURI,"text");O.setAttribute("x",String(T)),O.setAttribute("y",String(K-4)),O.setAttribute("text-anchor","middle"),O.setAttribute("font-size","10"),O.setAttribute("fill","#111111"),O.textContent=Wt(new Date(u)),f.appendChild(O)}let fe=new Date;fe.setHours(0,0,0,0);let oe=fe.getTime();if(oe>=at&&oe<=ht){let u=lt(oe),T=document.createElementNS(f.namespaceURI,"line");T.setAttribute("x1",String(u)),T.setAttribute("y1",String(K)),T.setAttribute("x2",String(u)),T.setAttribute("y2",String(Y-G)),T.setAttribute("stroke","#4caf50"),T.setAttribute("stroke-width","2"),T.setAttribute("stroke-dasharray","4,2"),f.appendChild(T);let $=document.createElementNS(f.namespaceURI,"text");$.setAttribute("x",String(u+4)),$.setAttribute("y",String(K+12)),$.setAttribute("font-size","10"),$.setAttribute("fill","#4caf50"),$.textContent="hoje",f.appendChild($)}let Ot=h.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",R==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${Q}px`,Ot.style.top="4px",Ot.addEventListener("click",u=>{u.preventDefault();let $=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=$,ee(o,r,t,e)});let Ve=["status","priority"],ie=Array.isArray(s.tooltipFields)?s.tooltipFields.map(u=>String(u)):null,Ke=ie&&ie.length?ie:Ve,Qt=0,ae=null;for(let u of g){let T=u.start,$=u.end,O=($.getTime()-T.getTime())/6e4,It=u.props,At=u.notePath,bt=u.noteTitle,Ft=(we=(Se=u.row.notes)==null?void 0:Se.length)!=null?we:0,yt=u.due,Et=u.estMinutes,Ct=[];Ct.push(`${Wt(T)} \u2192 ${Wt($)}`),typeof Et=="number"&&!Number.isNaN(Et)?Ct.push(`est: ${Math.round(Et)} min`):O>0&&Ct.push(`dura\xE7\xE3o: ${Math.round(O)} min`),yt instanceof Date&&Ct.push(`due: ${Wt(yt)}`);for(let et of Ke){let U=b(It,et);U!=null&&String(U).trim()!==""&&Ct.push(`${et}: ${String(U)}`)}let _t=Ct.join("<br>"),kt=et=>{var U;et.preventDefault(),y&&At?new pe(At,r,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():mt(o,P,bt,Et!=null?Et:O,(U=u.row.notes)!=null?U:[],i)},xt=et=>{bt&&_t&&gt(o,D,bt,_t,Ft,et)},ct=()=>ft(D);if(u.groupKey!==ae){ae=u.groupKey;let et=K+8+Qt*E+E/2,U=a(ae);k(U,4,et,Q-12,11,"600"),Qt+=1}let vt=K+8+Qt*E,zt=E-10,Vt=lt(T.getTime()),Rt=lt($.getTime()),Yt=Math.max(4,Rt-Vt),ot=u.fullName,nt=document.createElementNS(f.namespaceURI,"rect");nt.setAttribute("x",String(Vt)),nt.setAttribute("y",String(vt)),nt.setAttribute("width",String(Yt)),nt.setAttribute("height",String(zt)),nt.setAttribute("rx","3"),nt.setAttribute("ry","3"),nt.setAttribute("fill",it((Ae=u.row.series)!=null?Ae:ot,Qt)),nt.setAttribute("stroke","rgba(0,0,0,0.25)"),nt.setAttribute("stroke-width","0.5"),nt.style.cursor=y&&At?"pointer":"default",nt.addEventListener("mouseenter",xt),nt.addEventListener("mouseleave",ct),nt.addEventListener("click",kt),f.appendChild(nt);let De=vt+zt/2;if(Yt>=6){let et=it((Ee=u.row.series)!=null?Ee:ot,Qt),U=document.createElementNS(f.namespaceURI,"circle");U.setAttribute("cx",String(Vt)),U.setAttribute("cy",String(De)),U.setAttribute("r","3.5"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",et),U.setAttribute("stroke-width","1.5"),f.appendChild(U);let Mt=document.createElementNS(f.namespaceURI,"circle");Mt.setAttribute("cx",String(Rt)),Mt.setAttribute("cy",String(De)),Mt.setAttribute("r","3.5"),Mt.setAttribute("fill","#ffffff"),Mt.setAttribute("stroke",et),Mt.setAttribute("stroke-width","1.5"),f.appendChild(Mt)}let Pe=vt+zt/2+2,Xt=d?16:4;if(R==="wide")k(ot,Xt,Pe,Q-Xt-4,11,null,xt,ct,kt);else{let et=ot,U=Math.max(40,Q-Xt-8),Ce=Math.max(8,Math.floor(U/6));et.length>Ce&&(et=et.slice(0,Ce-1)+"\u2026");let St=document.createElementNS(f.namespaceURI,"text");St.setAttribute("x",String(Xt)),St.setAttribute("y",String(Pe)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=et,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",ct),St.addEventListener("click",kt),f.appendChild(St)}if(yt instanceof Date){let et=lt(yt.getTime()),U=document.createElementNS(f.namespaceURI,"line");U.setAttribute("x1",String(et)),U.setAttribute("y1",String(vt)),U.setAttribute("x2",String(et)),U.setAttribute("y2",String(vt+zt)),U.setAttribute("stroke","#ff6b6b"),U.setAttribute("stroke-width","2"),U.setAttribute("stroke-dasharray","4,2"),f.appendChild(U)}Qt+=1}if(y){let u=o.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function he(o,r,t){var Q,j,tt,I;let e=(Q=r.options)!=null?Q:{},s=e.background,n=(j=e.drilldown)!=null?j:!0,i=(tt=t.rows)!=null?tt:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:y,svg:a,tooltip:l,details:p}=wt(o,s),d=o.getBoundingClientRect().width||600,S=Math.max(d,480);y.style.width=S+"px";let b=40,m=16,g=18,E=28,N=300;a.setAttribute("height",String(N));let A=S-b-m,F=N-g-E,M=new Map;for(let h of i){let f=String(h.x),D=(I=M.get(f))!=null?I:{label:h.x,rows:[]};D.rows.push(h),M.set(f,D)}let H=Array.from(M.keys()).sort((h,f)=>h<f?-1:h>f?1:0).map(h=>M.get(h)),C=H.length,v=new Set;i.forEach(h=>{h.series!=null&&v.add(String(h.series))});let c=Array.from(v),w=c.length>1,R=w?"grouped":"single",x=0;i.forEach(h=>{h.y>x&&(x=h.y)}),(!isFinite(x)||x<=0)&&(x=1);let L=h=>g+F-h/(x||1)*F,B=L(0),rt=4;for(let h=0;h<=rt;h++){let f=x*h/rt,D=L(f),P=document.createElementNS(a.namespaceURI,"line");P.setAttribute("x1",String(b)),P.setAttribute("y1",String(D)),P.setAttribute("x2",String(S-m)),P.setAttribute("y2",String(D)),P.setAttribute("stroke","#cccccc"),P.setAttribute("stroke-opacity","0.25"),a.appendChild(P);let k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(b-4)),k.setAttribute("y",String(D+3)),k.setAttribute("text-anchor","end"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=String(Math.round(f)),a.appendChild(k)}let W=C>0?A/C:A;if(H.forEach((h,f)=>{let D=b+W*(f+.5),P=String(h.label),k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(D)),k.setAttribute("y",String(N-E+12)),k.setAttribute("text-anchor","middle"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=P,a.appendChild(k)}),w){let h=o.createDiv({cls:"chart-notes-legend"});c.forEach((f,D)=>{let P=h.createDiv({cls:"chart-notes-legend-item"}),k=P.createDiv();k.style.width="10px",k.style.height="10px",k.style.borderRadius="999px",k.style.backgroundColor=it(f,D),P.createSpan({text:f})})}H.forEach((h,f)=>{let D=b+W*(f+.5),P=h.rows;if(R==="single"){let Y=P[0],V=Y.y,K=W*.6,J=D-K/2,at=L(V),ht=Math.max(2,B-at),lt=it("bar",f),z=document.createElementNS(a.namespaceURI,"rect");z.setAttribute("x",String(J)),z.setAttribute("y",String(at)),z.setAttribute("width",String(K)),z.setAttribute("height",String(ht)),z.setAttribute("fill",lt),z.setAttribute("stroke","rgba(0,0,0,0.25)"),z.setAttribute("stroke-width","0.5"),z.style.cursor="pointer";let X=String(h.label),Nt=`valor: ${Math.round(V*100)/100}`;z.addEventListener("mouseenter",dt=>{var q,pt;return gt(o,l,X,Nt,(pt=(q=Y.notes)==null?void 0:q.length)!=null?pt:0,dt)}),z.addEventListener("mouseleave",()=>ft(l)),z.addEventListener("click",dt=>{var q;dt.preventDefault(),mt(o,p,X,V,(q=Y.notes)!=null?q:[],n)}),a.appendChild(z);return}let k=c.length,Z=W/Math.max(k+1,2),G=k*Z,st=D-G/2;c.forEach((Y,V)=>{let K=P.find(q=>(q.series!=null?String(q.series):"")===Y);if(!K)return;let J=K.y,at=st+V*Z,ht=L(J),lt=Math.max(2,B-ht),z=it(Y,V),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(at)),X.setAttribute("y",String(ht)),X.setAttribute("width",String(Z)),X.setAttribute("height",String(lt)),X.setAttribute("fill",z),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let Nt=`${Y} @ ${String(h.label)}`,dt=`valor: ${Math.round(J*100)/100}`;X.addEventListener("mouseenter",q=>{var pt,Gt;return gt(o,l,Nt,dt,(Gt=(pt=K.notes)==null?void 0:pt.length)!=null?Gt:0,q)}),X.addEventListener("mouseleave",()=>ft(l)),X.addEventListener("click",q=>{var pt;q.preventDefault(),mt(o,p,Nt,J,(pt=K.notes)!=null?pt:[],n)}),a.appendChild(X)})})}function Qe(o,r,t){var W,Q,j,tt;let e=(W=r.options)!=null?W:{},s=e.background,n=(Q=e.drilldown)!=null?Q:!0,i=(j=t.rows)!=null?j:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:y,svg:a,tooltip:l,details:p}=wt(o,s),d=o.getBoundingClientRect().width||600,S=Math.max(d,480);y.style.width=S+"px";let b=40,m=16,g=18,E=28,N=300;a.setAttribute("height",String(N));let A=S-b-m,F=N-g-E,M=new Map;for(let I of i){let h=String(I.x),f=(tt=M.get(h))!=null?tt:{label:I.x,rows:[]};f.rows.push(I),M.set(h,f)}let H=Array.from(M.keys()).sort((I,h)=>I<h?-1:I>h?1:0).map(I=>M.get(I)),C=H.length,v=new Set;i.forEach(I=>{I.series!=null&&v.add(String(I.series))});let c=Array.from(v);if(!c.length){he(o,r,t);return}let w=0;H.forEach(I=>{let h=I.rows.reduce((f,D)=>f+D.y,0);h>w&&(w=h)}),(!isFinite(w)||w<=0)&&(w=1);let R=I=>g+F-I/(w||1)*F,x=R(0),L=4;for(let I=0;I<=L;I++){let h=w*I/L,f=R(h),D=document.createElementNS(a.namespaceURI,"line");D.setAttribute("x1",String(b)),D.setAttribute("y1",String(f)),D.setAttribute("x2",String(S-m)),D.setAttribute("y2",String(f)),D.setAttribute("stroke","#cccccc"),D.setAttribute("stroke-opacity","0.25"),a.appendChild(D);let P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(b-4)),P.setAttribute("y",String(f+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=String(Math.round(h)),a.appendChild(P)}let B=C>0?A/C:A;H.forEach((I,h)=>{let f=b+B*(h+.5),D=String(I.label),P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(f)),P.setAttribute("y",String(N-E+12)),P.setAttribute("text-anchor","middle"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=D,a.appendChild(P)});let rt=o.createDiv({cls:"chart-notes-legend"});c.forEach((I,h)=>{let f=rt.createDiv({cls:"chart-notes-legend-item"}),D=f.createDiv();D.style.width="10px",D.style.height="10px",D.style.borderRadius="999px",D.style.backgroundColor=it(I,h),f.createSpan({text:I})}),H.forEach((I,h)=>{let f=b+B*(h+.5),D=B*.6,P=f-D/2,k=0;c.forEach((Z,G)=>{let st=I.rows.find(dt=>(dt.series!=null?String(dt.series):"")===Z);if(!st)return;let Y=st.y,V=k,K=k+Y;k=K;let J=R(V),at=R(K),ht=Math.max(2,J-at),lt=it(Z,G),z=document.createElementNS(a.namespaceURI,"rect");z.setAttribute("x",String(P)),z.setAttribute("y",String(at)),z.setAttribute("width",String(D)),z.setAttribute("height",String(ht)),z.setAttribute("fill",lt),z.setAttribute("stroke","rgba(0,0,0,0.25)"),z.setAttribute("stroke-width","0.5"),z.style.cursor="pointer";let X=`${Z} @ ${String(I.label)}`,Nt=`valor: ${Math.round(Y*100)/100}`;z.addEventListener("mouseenter",dt=>{var q,pt;return gt(o,l,X,Nt,(pt=(q=st.notes)==null?void 0:q.length)!=null?pt:0,dt)}),z.addEventListener("mouseleave",()=>ft(l)),z.addEventListener("click",dt=>{var q;dt.preventDefault(),mt(o,p,X,Y,(q=st.notes)!=null?q:[],n)}),a.appendChild(z)})})}function ye(o,r,t,e){var Q,j,tt,I;let s=(Q=r.options)!=null?Q:{},n=s.background,i=(j=s.drilldown)!=null?j:!0,y=(tt=t.rows)!=null?tt:[];if(!y.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:p,details:d}=wt(o,n),S=o.getBoundingClientRect().width||600,b=Math.max(S,480);a.style.width=b+"px";let m=40,g=16,E=18,N=24,A=300;l.setAttribute("height",String(A));let F=b-m-g,M=A-E-N,_=new Map;for(let h of y){let f=h.series!=null?String(h.series):"__default__",D=(I=_.get(f))!=null?I:[];D.push(h),_.set(f,D)}let H=Array.from(_.keys()),C=[],v=new Set;for(let h of y){let f=String(h.x);v.has(f)||(v.add(f),C.push(h.x))}let c=C.length||1,w=h=>{let f=String(h),D=C.findIndex(P=>String(P)===f);return D<0?m:c===1?m+F/2:m+D/(c-1)*F},R=h=>String(h),x=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY;for(let h of y)h.y<x&&(x=h.y),h.y>L&&(L=h.y);(!isFinite(x)||!isFinite(L))&&(x=0,L=1),x===L&&(x===0?L=1:x=0);let B=h=>E+M-(h-x)/(L-x||1)*M,rt=4;for(let h=0;h<=rt;h++){let f=x+(L-x)*h/rt,D=B(f),P=document.createElementNS(l.namespaceURI,"line");P.setAttribute("x1",String(m)),P.setAttribute("y1",String(D)),P.setAttribute("x2",String(b-g)),P.setAttribute("y2",String(D)),P.setAttribute("stroke","#cccccc"),P.setAttribute("stroke-opacity","0.25"),l.appendChild(P);let k=document.createElementNS(l.namespaceURI,"text");k.setAttribute("x",String(m-4)),k.setAttribute("y",String(D+3)),k.setAttribute("text-anchor","end"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=Math.abs(f)>=100?String(Math.round(f)):String(Math.round(f*10)/10),l.appendChild(k)}let W=H.filter(h=>h!=="__default__");if(W.length>1){let h=o.createDiv({cls:"chart-notes-legend"});W.forEach((f,D)=>{let P=f,k=h.createDiv({cls:"chart-notes-legend-item"}),Z=k.createDiv();Z.style.width="10px",Z.style.height="10px",Z.style.borderRadius="999px",Z.style.backgroundColor=it(P,D),k.createSpan({text:P})})}H.forEach((h,f)=>{let D=_.get(h);if(!(D!=null&&D.length))return;let P=h==="__default__"?it("line",f):it(h,f),k=[...D].sort((G,st)=>{let Y=C.findIndex(K=>String(K)===String(G.x)),V=C.findIndex(K=>String(K)===String(st.x));return Y-V}),Z="";if(k.forEach((G,st)=>{let Y=w(G.x),V=B(G.y);Z+=(st===0?"M ":" L ")+Y+" "+V}),e){let G=k[0],st=k[k.length-1],Y=w(G.x),V=w(st.x),K=B(x);Z+=` L ${V} ${K} L ${Y} ${K} Z`;let J=document.createElementNS(l.namespaceURI,"path");J.setAttribute("d",Z),J.setAttribute("fill",P),J.setAttribute("fill-opacity","0.18"),J.setAttribute("stroke",P),J.setAttribute("stroke-width","1.5"),l.appendChild(J)}else{let G=document.createElementNS(l.namespaceURI,"path");G.setAttribute("d",Z),G.setAttribute("fill","none"),G.setAttribute("stroke",P),G.setAttribute("stroke-width","2"),l.appendChild(G)}k.forEach(G=>{let st=w(G.x),Y=B(G.y),V=document.createElementNS(l.namespaceURI,"circle");V.setAttribute("cx",String(st)),V.setAttribute("cy",String(Y)),V.setAttribute("r","3"),V.setAttribute("fill","#ffffff"),V.setAttribute("stroke",P),V.setAttribute("stroke-width","1.5"),V.style.cursor="pointer";let K=R(G.x),J=h==="__default__"?"":String(G.series),at=J?`${J} @ ${K}`:K,ht=`valor: ${Math.round(G.y*100)/100}`;V.addEventListener("mouseenter",lt=>{var z,X;return gt(o,p,at,ht,(X=(z=G.notes)==null?void 0:z.length)!=null?X:0,lt)}),V.addEventListener("mouseleave",()=>ft(p)),V.addEventListener("click",lt=>{var z;lt.preventDefault(),mt(o,d,at,G.y,(z=G.notes)!=null?z:[],i)}),l.appendChild(V)})})}function ze(o,r,t){var F;let{background:e,drilldown:s=!0}=(F=r.options)!=null?F:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let n=He(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:y,svg:a,tooltip:l,details:p}=wt(o,e),d=Math.max(i,420);y.style.width=d+"px",n&&(a.style.color=n);let S=300,b=d/2,m=(S-28+28)/2,g=Math.min(d/2-20,S/2-20),N=t.rows.map(M=>Math.max(0,M.y)).reduce((M,_)=>M+_,0)||1,A=-Math.PI/2;t.rows.forEach((M,_)=>{var W;let H=M.x instanceof Date?M.x.toISOString().slice(0,10):String(M.x),C=M.y,v=C/N*Math.PI*2,c=b+g*Math.cos(A),w=m+g*Math.sin(A),R=b+g*Math.cos(A+v),x=m+g*Math.sin(A+v),L=v>Math.PI?1:0,B=document.createElementNS(a.namespaceURI,"path"),rt=[`M ${b} ${m}`,`L ${c} ${w}`,`A ${g} ${g} 0 ${L} 1 ${R} ${x}`,"Z"].join(" ");B.setAttribute("d",rt),B.setAttribute("fill",it((W=M.series)!=null?W:H,_)),B.style.cursor="pointer",B.addEventListener("mouseenter",Q=>{var j,tt;return gt(o,l,H,C,(tt=(j=M.notes)==null?void 0:j.length)!=null?tt:0,Q)}),B.addEventListener("mouseleave",()=>ft(l)),B.addEventListener("click",()=>{var Q;return mt(o,p,H,C,(Q=M.notes)!=null?Q:[],s)}),a.appendChild(B),A+=v})}function We(o,r,t){var w;let{background:e,drilldown:s=!0}=(w=r.options)!=null?w:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let n=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:y,svg:a,tooltip:l,details:p}=wt(o,e),d=Math.max(i,700);y.style.width=d+"px",n&&(a.style.color=n);let S=300,b=d-48-10,m=S-28-28,g=t.rows.map(R=>{let x=R.x;if(x instanceof Date)return x.getTime();if(typeof x=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(x)){let B=new Date(x);if(!isNaN(B.getTime()))return B.getTime()}let L=Number(x);return isNaN(L)?null:L}return typeof x=="number"?x:null}),E=t.rows.map(R=>R.y),N=g.filter(R=>R!==null);if(N.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let A=Math.min(...N),F=Math.max(...N),M=Math.min(...E),_=Math.max(...E),H=R=>48+(R-A)/(F-A||1)*b,C=R=>S-28-(R-M)/(_-M||1)*m,v=document.createElementNS(a.namespaceURI,"line");v.setAttribute("x1",String(48)),v.setAttribute("y1",String(28)),v.setAttribute("x2",String(48)),v.setAttribute("y2",String(S-28)),v.setAttribute("stroke","currentColor"),a.appendChild(v);let c=document.createElementNS(a.namespaceURI,"line");c.setAttribute("x1",String(48)),c.setAttribute("y1",String(S-28)),c.setAttribute("x2",String(d-10)),c.setAttribute("y2",String(S-28)),c.setAttribute("stroke","currentColor"),a.appendChild(c),t.rows.forEach((R,x)=>{let L=g[x];if(L==null)return;let B=H(L),rt=C(E[x]),W=document.createElementNS(a.namespaceURI,"circle");W.setAttribute("cx",String(B)),W.setAttribute("cy",String(rt)),W.setAttribute("r","4"),W.setAttribute("fill",it(R.series,x)),W.style.cursor="pointer";let Q=R.x instanceof Date?R.x.toISOString().slice(0,10):typeof R.x=="string"?R.x:String(R.x);W.addEventListener("mouseenter",j=>{var tt,I;return gt(o,l,Q,R.y,(I=(tt=R.notes)==null?void 0:tt.length)!=null?I:0,j)}),W.addEventListener("mouseleave",()=>ft(l)),W.addEventListener("click",j=>{var tt;j.preventDefault(),mt(o,p,Q,R.y,(tt=R.notes)!=null?tt:[],s)}),a.appendChild(W)})}var Be=require("obsidian"),ne=class{render(r,t,e,s,n=!1){var l;let{title:i}=(l=t.options)!=null?l:{};r.empty(),r.addClass("prop-charts-container");let a=r.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":he(r,t,e);break;case"stacked-bar":Qe(r,t,e);break;case"line":ye(r,t,e,!1);break;case"area":ye(r,t,e,!0);break;case"pie":ze(r,t,e);break;case"scatter":We(r,t,e);break;case"gantt":ee(r,t,e,s);break;default:r.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!n){let p=r.createEl("button",{cls:"chart-notes-zoom-button"});p.setAttr("type","button"),p.setAttr("aria-label","Expandir gr\xE1fico"),p.textContent="\u2922",p.addEventListener("click",d=>{d.preventDefault(),new ge(t,e,this,s).open()})}}},ge=class extends Be.Modal{constructor(t,e,s,n){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=s,this.ctx=n}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),s=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:s,cls:"chart-notes-zoom-title"});let n=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(l,p)=>{let d=n.createEl("button",{cls:"chart-notes-zoom-size-btn",text:l});(()=>{d.toggleClass("is-active",this.size===p)})(),d.addEventListener("click",b=>{b.preventDefault(),this.size=p,this.applySize(),n.querySelectorAll(".chart-notes-zoom-size-btn").forEach(g=>g.classList.remove("is-active")),d.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let y=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(y,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",s="85vh";switch(this.size){case"small":e="60vw",s="55vh";break;case"medium":e="80vw",s="70vh";break;case"large":default:e="95vw",s="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=s,t.style.maxHeight=s}};var se=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("loading Chart Notes plugin"),this.indexer=new jt(this.app),await this.indexer.buildIndex(),this.query=new te(()=>this.indexer.getAll(),[]),this.renderer=new ne,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,s)=>{var p;let n;try{let d=(0,Lt.parseYaml)(t);if(!d||typeof d!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}n=d}catch(d){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+d.message});return}if(!n.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=n.type==="gantt",y=n.type==="table";if(!i&&!y){if(!n.encoding||!n.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let S=((p=n.aggregate)==null?void 0:p.y)==="count";if(!n.encoding.y&&!S){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}n.encoding||(n.encoding={}),n.source||(n.source={});let l;try{l=this.query.run(n)}catch(d){e.createEl("div",{text:"Chart Notes: erro na query: "+d.message});return}this.renderer.render(e,n,l)}),this.registerBasesView(ce,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new qt(t,e,this.renderer),options:()=>[{type:"dropdown",key:"chartType",displayName:"Tipo do gr\xE1fico",default:"bar",options:{bar:"Barra","stacked-bar":"Barra empilhada",line:"Linha",area:"\xC1rea",pie:"Pizza",scatter:"Dispers\xE3o",gantt:"Gantt"}},{type:"text",key:"title",displayName:"T\xEDtulo (opcional)",placeholder:"(vazio = usa nome da view)"},{type:"property",key:"xProperty",displayName:"Propriedade X / label"},{type:"property",key:"yProperty",displayName:"Propriedade Y / valor (vazio = conta linhas)"},{type:"property",key:"seriesProperty",displayName:"S\xE9rie (opcional, gera legenda / cores)"},{type:"property",key:"startProperty",displayName:"In\xEDcio (Gantt)"},{type:"property",key:"endProperty",displayName:"Fim (Gantt)"},{type:"property",key:"dueProperty",displayName:"Due date (Gantt, opcional)"},{type:"property",key:"durationProperty",displayName:"Dura\xE7\xE3o em minutos (Gantt, opcional)"},{type:"property",key:"groupProperty",displayName:"Grupo / lane (Gantt / s\xE9ries, opcional)"},{type:"toggle",key:"drilldown",displayName:"Drilldown (clicar abre lista de notas)",default:!0},{type:"text",key:"background",displayName:"Cor de fundo (ex: #ffffff, opcional)",placeholder:"#ffffff"},{type:"multitext",key:"tooltipFields",displayName:"Campos extras no tooltip (ex: status,priority)",default:[]}]})}onunload(){console.log("unloading Chart Notes plugin")}};
