/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var Ke=Object.getOwnPropertyDescriptor;var Be=Object.getOwnPropertyNames;var Ue=Object.prototype.hasOwnProperty;var Ye=(s,e)=>{for(var t in e)ce(s,t,{get:e[t],enumerable:!0})},Oe=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Be(e))!Ue.call(s,r)&&r!==t&&ce(s,r,{get:()=>e[r],enumerable:!(n=Ke(e,r))||n.enumerable});return s};var Xe=s=>Oe(ce({},"__esModule",{value:!0}),s);var an={};Ye(an,{default:()=>se});module.exports=Xe(an);var Lt=require("obsidian");var Jt=require("obsidian");var Rt=require("obsidian");var Ne=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(s,e){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,r)=>n*33+r.charCodeAt(0)>>>0,0);return Ne[t%Ne.length]}function wt(s,e){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,e&&(n.style.background=e);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let m=s.createDiv({cls:"chart-notes-details"});return m.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:m}}function mt(s,e,t,n,r,o){let i=s.getBoundingClientRect(),m=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);e.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${m}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,e.style.display="block";let a=e.getBoundingClientRect(),c=o.clientX-i.left+6,h=o.clientY-i.top+6;c+a.width>i.width-4&&(c=i.width-a.width-4),c<4&&(c=4),h+a.height>i.height-4&&(h=i.height-a.height-4),h<4&&(h=4),e.style.left=c+"px",e.style.top=h+"px"}function gt(s){s.style.display="none"}function yt(s,e,t,n,r,o){if(!o)return;if(e.empty(),!r||r.length===0){e.style.display="none";return}e.style.display="block";let i=e.createEl("div",{cls:"chart-notes-details-header"}),m=i.createEl("div",{cls:"chart-notes-details-title"});m.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{e.style.display="none"});let c=e.createEl("ul",{cls:"chart-notes-details-list"});for(let h of r){let S=c.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:h});S.href="#",S.addEventListener("click",y=>{y.preventDefault(),app.workspace.openLinkText(h,"",!1)})}}function Vt(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let e=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${e}/${t}`}function Te(s){if(!s)return!1;let e=s.trim().toLowerCase();if(e==="#fff"||e==="#ffffff"||e==="white")return!0;if(!e.startsWith("#"))return!1;let t,n,r;if(e.length===4)t=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16),r=parseInt(e[3]+e[3],16);else if(e.length===7)t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*r)/255>.7}var le=class extends Rt.Modal{constructor(t,n,r,o){var m;super(app);this.notePath=t,this.spec=n,this.refresh=r,this.reindexFile=o;let i=(m=n.encoding)!=null?m:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var N,v;let{contentEl:t}=this;t.empty();let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Rt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(n),o={},i=r,m=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(m){try{o=(N=(0,Rt.parseYaml)(m[1]))!=null?N:{}}catch(u){o={}}i=r.slice(m[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(v=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?v:this.notePath,c=t.createDiv({cls:"gantt-edit-header"}),h=c.createEl("a",{text:a,cls:"gantt-edit-title"});h.href="#",h.addEventListener("click",u=>{u.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let p=c.createDiv({cls:"gantt-edit-subtitle"});p.textContent=this.notePath;let S=t.createDiv({cls:"gantt-edit-form"}),y=u=>{let w=S.createDiv({cls:"gantt-edit-row"}),C=w.createDiv({cls:"gantt-edit-label"});C.textContent=u;let b=w.createDiv({cls:"gantt-edit-field"});return{row:w,field:b}},x=u=>{if(!u)return"";let C=String(u).match(/^(\d{4}-\d{2}-\d{2})/);return C?C[1]:""},g=u=>{if(u=u.trim(),!!u&&/^\d{4}-\d{2}-\d{2}$/.test(u))return u},R=null;if(this.startKey){let{field:u}=y(this.startKey+" (in\xEDcio)");R=u.createEl("input",{type:"date"}),R.value=x(o[this.startKey])}let k=null;if(this.endKey){let{field:u}=y(this.endKey+" (fim)");k=u.createEl("input",{type:"date"}),k.value=x(o[this.endKey])}let D=null;if(this.durationKey){let{field:u}=y(this.durationKey+" (minutos)");D=u.createEl("input",{type:"number"});let w=o[this.durationKey];D.value=w!=null?String(w):"",D.min="0",D.step="5"}let Q=null;if(this.dueKey){let{field:u}=y(this.dueKey+" (due)");Q=u.createEl("input",{type:"date"}),Q.value=x(o[this.dueKey])}let L=t.createDiv({cls:"gantt-edit-buttons"}),z=L.createEl("button",{text:"Salvar",cls:"mod-cta"});L.createEl("button",{text:"Cancelar"}).addEventListener("click",u=>{u.preventDefault(),this.close()}),z.addEventListener("click",async u=>{if(u.preventDefault(),this.startKey&&R){let b=g(R.value);b?o[this.startKey]=b:delete o[this.startKey]}if(this.endKey&&k){let b=g(k.value);b?o[this.endKey]=b:delete o[this.endKey]}if(this.durationKey&&D){let b=D.value.trim();if(b==="")delete o[this.durationKey];else{let M=Number(b);Number.isNaN(M)||(o[this.durationKey]=M)}}if(this.dueKey&&Q){let b=g(Q.value);b?o[this.dueKey]=b:delete o[this.dueKey]}let C=`---
${(0,Rt.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,C),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(b){}if(this.refresh)try{this.refresh()}catch(b){}new Rt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function qt(s,e,t,n){var ye,be,xe,ve,Se,we,Ae,Ee;let r=(ye=e.options)!=null?ye:{},o=r.background,i=(be=r.drilldown)!=null?be:!0,m=!0,a=l=>{if(l==null)return"";let T=String(l).trim();if(!T)return"";let F=T.match(/^\[\[(.+?)\]\]$/);F&&(T=F[1]);let Y=T.lastIndexOf("/");return Y>=0&&Y<T.length-1&&(T=T.slice(Y+1)),T};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(l=>l.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let c=t.rows.filter(l=>l.start&&l.end);if(c.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let h=e.encoding,p=h.group,S=h.duration,y=(l,T)=>{if(!l||!T)return;let F=l[T];return Array.isArray(F)?F[0]:F},g=c.map(l=>{var xt,lt;let T=l.start,F=l.end,Y=l.props,It=typeof l.x=="string"?l.x:l.x instanceof Date?Vt(T):String(l.x),At=a(It),bt,Ft=p?y(Y,p):void 0;Ft!=null?bt=String(Ft):l.series!=null?bt=String(l.series):bt=At;let ft=(xt=l.notes)==null?void 0:xt[0],Et=ft?(lt=ft.replace(/\.md$/i,"").split("/").pop())!=null?lt:ft:At,Ct=l.due,_t,Mt=y(Y,S);if(Mt!=null){let vt=Number(Mt);Number.isNaN(vt)||(_t=vt)}return{row:l,start:T,end:F,props:Y,fullName:At,groupKey:bt,notePath:ft,noteTitle:Et,due:Ct,estMinutes:_t}}).filter(l=>l.start instanceof Date&&!isNaN(l.start.getTime())&&l.end instanceof Date&&!isNaN(l.end.getTime()));if(g.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}g.sort((l,T)=>{if(l.groupKey<T.groupKey)return-1;if(l.groupKey>T.groupKey)return 1;let F=l.start.getTime(),Y=T.start.getTime();return F!==Y?F-Y:l.fullName.localeCompare(T.fullName)});let R=26,k=0,D=null;for(let l of g)l.groupKey!==D&&(D=l.groupKey,k+=1),k+=1;let Q=Math.min(...g.map(l=>l.start.getTime())),L=Math.max(...g.map(l=>l.end.getTime()));if(!isFinite(Q)||!isFinite(L)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let z=24*60*60*1e3,H=l=>{let T=new Date(l);return T.setHours(0,0,0,0),T.getTime()},N=H(Q),v=H(L),u=s.querySelector(".prop-charts-title-row");u||(u=s.createDiv({cls:"prop-charts-title-row"}));let w=s.dataset.ganttZoomMode||String((xe=r.zoomMode)!=null?xe:"100");s.dataset.ganttZoomMode=w;let C=s.dataset.ganttLabelMode||String((ve=r.labelMode)!=null?ve:"compact");s.dataset.ganttLabelMode=C;let b=u.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(l=>{let T=b.createEl("button",{cls:"gantt-zoom-btn",text:l.label});l.id===w&&T.addClass("is-active"),T.addEventListener("click",F=>{F.preventDefault(),s.dataset.ganttZoomMode=l.id,qt(s,e,t,n)})}),b.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",l=>{l.preventDefault();let T=s.querySelector(".chart-notes-zoom-button");T&&T.click()});let nt=Number(r.labelWidth),V=!Number.isNaN(nt)&&nt>120?nt:260,_=C==="wide"?V+160:V,j=s.getBoundingClientRect().width||600,tt=Math.max(j,820),I;if(w==="fit")I=j;else{let l=Number(w)/100||1;I=tt*l}let{inner:d,svg:f,tooltip:A,details:E}=wt(s,o);d.style.width=I+"px";let P=(l,T,F,Y,It,At,bt,Ft,ft)=>{if(!l)return;let Et=Math.max(40,Y-8),_t=Math.max(8,Math.floor(Et/6)),Mt=l.split(/\s+/),xt=[],lt="";for(let Nt of Mt){if(!lt){lt=Nt;continue}(lt+" "+Nt).length<=_t?lt+=" "+Nt:(xt.push(lt),lt=Nt)}lt&&xt.push(lt);let vt=It+2,zt=xt.length*vt,Bt=F-zt/2+It;xt.forEach((Nt,Ot)=>{let ot=document.createElementNS(f.namespaceURI,"text");ot.setAttribute("x",String(T)),ot.setAttribute("y",String(Bt+Ot*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Nt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),ft&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>ft(rt))),f.appendChild(ot)})},Z=28,W=28,st=10,O=Math.max(300,Z+W+k*R+24);f.setAttribute("height",String(O));let K=I-_-st,B=Z+6;f.style.color="#111111";let J=v+z-N||1,at=N-J*.02,ht=v+z+J*.08,ct=l=>_+(l-at)/(ht-at)*K,$=(ht-at)/z,Pt=Math.max(4,Math.min(12,Math.floor(K/90)||4)),dt=$/Pt,q=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=q[q.length-1];for(let l of q)if(l>=dt){pt=l;break}let Kt=[],Ve=H(at);for(let l=Ve;l<=ht+.5*z;l+=pt*z)Kt.push(l);let Qt=document.createElementNS(f.namespaceURI,"line");Qt.setAttribute("x1",String(_)),Qt.setAttribute("y1",String(B)),Qt.setAttribute("x2",String(I-st)),Qt.setAttribute("y2",String(B)),Qt.setAttribute("stroke","#111111"),f.appendChild(Qt);for(let l of Kt){let T=ct(l),F=document.createElementNS(f.namespaceURI,"line");F.setAttribute("x1",String(T)),F.setAttribute("y1",String(B)),F.setAttribute("x2",String(T)),F.setAttribute("y2",String(O-W)),F.setAttribute("stroke","#111111"),F.setAttribute("stroke-opacity","0.20"),F.setAttribute("stroke-dasharray","2,4"),f.appendChild(F);let Y=document.createElementNS(f.namespaceURI,"text");Y.setAttribute("x",String(T)),Y.setAttribute("y",String(B-4)),Y.setAttribute("text-anchor","middle"),Y.setAttribute("font-size","10"),Y.setAttribute("fill","#111111"),Y.textContent=Vt(new Date(l)),f.appendChild(Y)}let ge=new Date;ge.setHours(0,0,0,0);let oe=ge.getTime();if(oe>=at&&oe<=ht){let l=ct(oe),T=document.createElementNS(f.namespaceURI,"line");T.setAttribute("x1",String(l)),T.setAttribute("y1",String(B)),T.setAttribute("x2",String(l)),T.setAttribute("y2",String(O-W)),T.setAttribute("stroke","#4caf50"),T.setAttribute("stroke-width","2"),T.setAttribute("stroke-dasharray","4,2"),f.appendChild(T);let F=document.createElementNS(f.namespaceURI,"text");F.setAttribute("x",String(l+4)),F.setAttribute("y",String(B+12)),F.setAttribute("font-size","10"),F.setAttribute("fill","#4caf50"),F.textContent="hoje",f.appendChild(F)}let Yt=d.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Yt.setAttr("title",C==="wide"?"Compactar nomes":"Expandir nomes"),Yt.style.left=`${_}px`,Yt.style.top="4px",Yt.addEventListener("click",l=>{l.preventDefault();let F=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=F,qt(s,e,t,n)});let Ge=["status","priority"],ie=Array.isArray(r.tooltipFields)?r.tooltipFields.map(l=>String(l)):null,We=ie&&ie.length?ie:Ge,Ht=0,ae=null;for(let l of g){let T=l.start,F=l.end,Y=(F.getTime()-T.getTime())/6e4,It=l.props,At=l.notePath,bt=l.noteTitle,Ft=(we=(Se=l.row.notes)==null?void 0:Se.length)!=null?we:0,ft=l.due,Et=l.estMinutes,Ct=[];Ct.push(`${Vt(T)} \u2192 ${Vt(F)}`),typeof Et=="number"&&!Number.isNaN(Et)?Ct.push(`est: ${Math.round(Et)} min`):Y>0&&Ct.push(`dura\xE7\xE3o: ${Math.round(Y)} min`),ft instanceof Date&&Ct.push(`due: ${Vt(ft)}`);for(let et of We){let U=y(It,et);U!=null&&String(U).trim()!==""&&Ct.push(`${et}: ${String(U)}`)}let _t=Ct.join("<br>"),Mt=et=>{var U;et.preventDefault(),m&&At?new le(At,e,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():yt(s,E,bt,Et!=null?Et:Y,(U=l.row.notes)!=null?U:[],i)},xt=et=>{bt&&_t&&mt(s,A,bt,_t,Ft,et)},lt=()=>gt(A);if(l.groupKey!==ae){ae=l.groupKey;let et=B+8+Ht*R+R/2,U=a(ae);P(U,4,et,_-12,11,"600"),Ht+=1}let vt=B+8+Ht*R,zt=R-10,Bt=ct(T.getTime()),Nt=ct(F.getTime()),Ot=Math.max(4,Nt-Bt),ot=l.fullName,rt=document.createElementNS(f.namespaceURI,"rect");rt.setAttribute("x",String(Bt)),rt.setAttribute("y",String(vt)),rt.setAttribute("width",String(Ot)),rt.setAttribute("height",String(zt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=l.row.series)!=null?Ae:ot,Ht)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=m&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",lt),rt.addEventListener("click",Mt),f.appendChild(rt);let De=vt+zt/2;if(Ot>=6){let et=it((Ee=l.row.series)!=null?Ee:ot,Ht),U=document.createElementNS(f.namespaceURI,"circle");U.setAttribute("cx",String(Bt)),U.setAttribute("cy",String(De)),U.setAttribute("r","3.5"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",et),U.setAttribute("stroke-width","1.5"),f.appendChild(U);let kt=document.createElementNS(f.namespaceURI,"circle");kt.setAttribute("cx",String(Nt)),kt.setAttribute("cy",String(De)),kt.setAttribute("r","3.5"),kt.setAttribute("fill","#ffffff"),kt.setAttribute("stroke",et),kt.setAttribute("stroke-width","1.5"),f.appendChild(kt)}let Re=vt+zt/2+2,Xt=p?16:4;if(C==="wide")P(ot,Xt,Re,_-Xt-4,11,null,xt,lt,Mt);else{let et=ot,U=Math.max(40,_-Xt-8),Ce=Math.max(8,Math.floor(U/6));et.length>Ce&&(et=et.slice(0,Ce-1)+"\u2026");let St=document.createElementNS(f.namespaceURI,"text");St.setAttribute("x",String(Xt)),St.setAttribute("y",String(Re)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=et,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",lt),St.addEventListener("click",Mt),f.appendChild(St)}if(ft instanceof Date){let et=ct(ft.getTime()),U=document.createElementNS(f.namespaceURI,"line");U.setAttribute("x1",String(et)),U.setAttribute("y1",String(vt)),U.setAttribute("x2",String(et)),U.setAttribute("y2",String(vt+zt)),U.setAttribute("stroke","#ff6b6b"),U.setAttribute("stroke-width","2"),U.setAttribute("stroke-dasharray","4,2"),f.appendChild(U)}Ht+=1}if(m){let l=s.createDiv({cls:"prop-charts-empty"});l.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function ue(s,e,t){var _,j,tt,I;let n=(_=e.options)!=null?_:{},r=n.background,o=(j=n.drilldown)!=null?j:!0,i=(tt=t.rows)!=null?tt:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:m,svg:a,tooltip:c,details:h}=wt(s,r),p=s.getBoundingClientRect().width||600,S=Math.max(p,480);m.style.width=S+"px";let y=40,x=16,g=18,R=28,k=300;a.setAttribute("height",String(k));let D=S-y-x,Q=k-g-R,L=new Map;for(let d of i){let f=String(d.x),A=(I=L.get(f))!=null?I:{label:d.x,rows:[]};A.rows.push(d),L.set(f,A)}let H=Array.from(L.keys()).sort((d,f)=>d<f?-1:d>f?1:0).map(d=>L.get(d)),N=H.length,v=new Set;i.forEach(d=>{d.series!=null&&v.add(String(d.series))});let u=Array.from(v),w=u.length>1,C=w?"grouped":"single",b=0;i.forEach(d=>{d.y>b&&(b=d.y)}),(!isFinite(b)||b<=0)&&(b=1);let M=d=>g+Q-d/(b||1)*Q,G=M(0),nt=4;for(let d=0;d<=nt;d++){let f=b*d/nt,A=M(f),E=document.createElementNS(a.namespaceURI,"line");E.setAttribute("x1",String(y)),E.setAttribute("y1",String(A)),E.setAttribute("x2",String(S-x)),E.setAttribute("y2",String(A)),E.setAttribute("stroke","#cccccc"),E.setAttribute("stroke-opacity","0.25"),a.appendChild(E);let P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(y-4)),P.setAttribute("y",String(A+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=String(Math.round(f)),a.appendChild(P)}let V=N>0?D/N:D;if(H.forEach((d,f)=>{let A=y+V*(f+.5),E=String(d.label),P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(A)),P.setAttribute("y",String(k-R+12)),P.setAttribute("text-anchor","middle"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=E,a.appendChild(P)}),w){let d=s.createDiv({cls:"chart-notes-legend"});u.forEach((f,A)=>{let E=d.createDiv({cls:"chart-notes-legend-item"}),P=E.createDiv();P.style.width="10px",P.style.height="10px",P.style.borderRadius="999px",P.style.backgroundColor=it(f,A),E.createSpan({text:f})})}H.forEach((d,f)=>{let A=y+V*(f+.5),E=d.rows;if(C==="single"){let O=E[0],K=O.y,B=V*.6,J=A-B/2,at=M(K),ht=Math.max(2,G-at),ct=it("bar",f),$=document.createElementNS(a.namespaceURI,"rect");$.setAttribute("x",String(J)),$.setAttribute("y",String(at)),$.setAttribute("width",String(B)),$.setAttribute("height",String(ht)),$.setAttribute("fill",ct),$.setAttribute("stroke","rgba(0,0,0,0.25)"),$.setAttribute("stroke-width","0.5"),$.style.cursor="pointer";let X=String(d.label),Pt=`valor: ${Math.round(K*100)/100}`;$.addEventListener("mouseenter",dt=>{var q,pt;return mt(s,c,X,Pt,(pt=(q=O.notes)==null?void 0:q.length)!=null?pt:0,dt)}),$.addEventListener("mouseleave",()=>gt(c)),$.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(s,h,X,K,(q=O.notes)!=null?q:[],o)}),a.appendChild($);return}let P=u.length,Z=V/Math.max(P+1,2),W=P*Z,st=A-W/2;u.forEach((O,K)=>{let B=E.find(q=>(q.series!=null?String(q.series):"")===O);if(!B)return;let J=B.y,at=st+K*Z,ht=M(J),ct=Math.max(2,G-ht),$=it(O,K),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(at)),X.setAttribute("y",String(ht)),X.setAttribute("width",String(Z)),X.setAttribute("height",String(ct)),X.setAttribute("fill",$),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let Pt=`${O} @ ${String(d.label)}`,dt=`valor: ${Math.round(J*100)/100}`;X.addEventListener("mouseenter",q=>{var pt,Kt;return mt(s,c,Pt,dt,(Kt=(pt=B.notes)==null?void 0:pt.length)!=null?Kt:0,q)}),X.addEventListener("mouseleave",()=>gt(c)),X.addEventListener("click",q=>{var pt;q.preventDefault(),yt(s,h,Pt,J,(pt=B.notes)!=null?pt:[],o)}),a.appendChild(X)})})}function Pe(s,e,t){var V,_,j,tt;let n=(V=e.options)!=null?V:{},r=n.background,o=(_=n.drilldown)!=null?_:!0,i=(j=t.rows)!=null?j:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:m,svg:a,tooltip:c,details:h}=wt(s,r),p=s.getBoundingClientRect().width||600,S=Math.max(p,480);m.style.width=S+"px";let y=40,x=16,g=18,R=28,k=300;a.setAttribute("height",String(k));let D=S-y-x,Q=k-g-R,L=new Map;for(let I of i){let d=String(I.x),f=(tt=L.get(d))!=null?tt:{label:I.x,rows:[]};f.rows.push(I),L.set(d,f)}let H=Array.from(L.keys()).sort((I,d)=>I<d?-1:I>d?1:0).map(I=>L.get(I)),N=H.length,v=new Set;i.forEach(I=>{I.series!=null&&v.add(String(I.series))});let u=Array.from(v);if(!u.length){ue(s,e,t);return}let w=0;H.forEach(I=>{let d=I.rows.reduce((f,A)=>f+A.y,0);d>w&&(w=d)}),(!isFinite(w)||w<=0)&&(w=1);let C=I=>g+Q-I/(w||1)*Q,b=C(0),M=4;for(let I=0;I<=M;I++){let d=w*I/M,f=C(d),A=document.createElementNS(a.namespaceURI,"line");A.setAttribute("x1",String(y)),A.setAttribute("y1",String(f)),A.setAttribute("x2",String(S-x)),A.setAttribute("y2",String(f)),A.setAttribute("stroke","#cccccc"),A.setAttribute("stroke-opacity","0.25"),a.appendChild(A);let E=document.createElementNS(a.namespaceURI,"text");E.setAttribute("x",String(y-4)),E.setAttribute("y",String(f+3)),E.setAttribute("text-anchor","end"),E.setAttribute("font-size","10"),E.setAttribute("fill","#111111"),E.textContent=String(Math.round(d)),a.appendChild(E)}let G=N>0?D/N:D;H.forEach((I,d)=>{let f=y+G*(d+.5),A=String(I.label),E=document.createElementNS(a.namespaceURI,"text");E.setAttribute("x",String(f)),E.setAttribute("y",String(k-R+12)),E.setAttribute("text-anchor","middle"),E.setAttribute("font-size","10"),E.setAttribute("fill","#111111"),E.textContent=A,a.appendChild(E)});let nt=s.createDiv({cls:"chart-notes-legend"});u.forEach((I,d)=>{let f=nt.createDiv({cls:"chart-notes-legend-item"}),A=f.createDiv();A.style.width="10px",A.style.height="10px",A.style.borderRadius="999px",A.style.backgroundColor=it(I,d),f.createSpan({text:I})}),H.forEach((I,d)=>{let f=y+G*(d+.5),A=G*.6,E=f-A/2,P=0;u.forEach((Z,W)=>{let st=I.rows.find(dt=>(dt.series!=null?String(dt.series):"")===Z);if(!st)return;let O=st.y,K=P,B=P+O;P=B;let J=C(K),at=C(B),ht=Math.max(2,J-at),ct=it(Z,W),$=document.createElementNS(a.namespaceURI,"rect");$.setAttribute("x",String(E)),$.setAttribute("y",String(at)),$.setAttribute("width",String(A)),$.setAttribute("height",String(ht)),$.setAttribute("fill",ct),$.setAttribute("stroke","rgba(0,0,0,0.25)"),$.setAttribute("stroke-width","0.5"),$.style.cursor="pointer";let X=`${Z} @ ${String(I.label)}`,Pt=`valor: ${Math.round(O*100)/100}`;$.addEventListener("mouseenter",dt=>{var q,pt;return mt(s,c,X,Pt,(pt=(q=st.notes)==null?void 0:q.length)!=null?pt:0,dt)}),$.addEventListener("mouseleave",()=>gt(c)),$.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(s,h,X,O,(q=st.notes)!=null?q:[],o)}),a.appendChild($)})})}function de(s,e,t,n){var _,j,tt,I;let r=(_=e.options)!=null?_:{},o=r.background,i=(j=r.drilldown)!=null?j:!0,m=(tt=t.rows)!=null?tt:[];if(!m.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:c,tooltip:h,details:p}=wt(s,o),S=s.getBoundingClientRect().width||600,y=Math.max(S,480);a.style.width=y+"px";let x=40,g=16,R=18,k=24,D=300;c.setAttribute("height",String(D));let Q=y-x-g,L=D-R-k,z=new Map;for(let d of m){let f=d.series!=null?String(d.series):"__default__",A=(I=z.get(f))!=null?I:[];A.push(d),z.set(f,A)}let H=Array.from(z.keys()),N=[],v=new Set;for(let d of m){let f=String(d.x);v.has(f)||(v.add(f),N.push(d.x))}let u=N.length||1,w=d=>{let f=String(d),A=N.findIndex(E=>String(E)===f);return A<0?x:u===1?x+Q/2:x+A/(u-1)*Q},C=d=>String(d),b=Number.POSITIVE_INFINITY,M=Number.NEGATIVE_INFINITY;for(let d of m)d.y<b&&(b=d.y),d.y>M&&(M=d.y);(!isFinite(b)||!isFinite(M))&&(b=0,M=1),b===M&&(b===0?M=1:b=0);let G=d=>R+L-(d-b)/(M-b||1)*L,nt=4;for(let d=0;d<=nt;d++){let f=b+(M-b)*d/nt,A=G(f),E=document.createElementNS(c.namespaceURI,"line");E.setAttribute("x1",String(x)),E.setAttribute("y1",String(A)),E.setAttribute("x2",String(y-g)),E.setAttribute("y2",String(A)),E.setAttribute("stroke","#cccccc"),E.setAttribute("stroke-opacity","0.25"),c.appendChild(E);let P=document.createElementNS(c.namespaceURI,"text");P.setAttribute("x",String(x-4)),P.setAttribute("y",String(A+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=Math.abs(f)>=100?String(Math.round(f)):String(Math.round(f*10)/10),c.appendChild(P)}let V=H.filter(d=>d!=="__default__");if(V.length>1){let d=s.createDiv({cls:"chart-notes-legend"});V.forEach((f,A)=>{let E=f,P=d.createDiv({cls:"chart-notes-legend-item"}),Z=P.createDiv();Z.style.width="10px",Z.style.height="10px",Z.style.borderRadius="999px",Z.style.backgroundColor=it(E,A),P.createSpan({text:E})})}H.forEach((d,f)=>{let A=z.get(d);if(!(A!=null&&A.length))return;let E=d==="__default__"?it("line",f):it(d,f),P=[...A].sort((W,st)=>{let O=N.findIndex(B=>String(B)===String(W.x)),K=N.findIndex(B=>String(B)===String(st.x));return O-K}),Z="";if(P.forEach((W,st)=>{let O=w(W.x),K=G(W.y);Z+=(st===0?"M ":" L ")+O+" "+K}),n){let W=P[0],st=P[P.length-1],O=w(W.x),K=w(st.x),B=G(b);Z+=` L ${K} ${B} L ${O} ${B} Z`;let J=document.createElementNS(c.namespaceURI,"path");J.setAttribute("d",Z),J.setAttribute("fill",E),J.setAttribute("fill-opacity","0.18"),J.setAttribute("stroke",E),J.setAttribute("stroke-width","1.5"),c.appendChild(J)}else{let W=document.createElementNS(c.namespaceURI,"path");W.setAttribute("d",Z),W.setAttribute("fill","none"),W.setAttribute("stroke",E),W.setAttribute("stroke-width","2"),c.appendChild(W)}P.forEach(W=>{let st=w(W.x),O=G(W.y),K=document.createElementNS(c.namespaceURI,"circle");K.setAttribute("cx",String(st)),K.setAttribute("cy",String(O)),K.setAttribute("r","3"),K.setAttribute("fill","#ffffff"),K.setAttribute("stroke",E),K.setAttribute("stroke-width","1.5"),K.style.cursor="pointer";let B=C(W.x),J=d==="__default__"?"":String(W.series),at=J?`${J} @ ${B}`:B,ht=`valor: ${Math.round(W.y*100)/100}`;K.addEventListener("mouseenter",ct=>{var $,X;return mt(s,h,at,ht,(X=($=W.notes)==null?void 0:$.length)!=null?X:0,ct)}),K.addEventListener("mouseleave",()=>gt(h)),K.addEventListener("click",ct=>{var $;ct.preventDefault(),yt(s,p,at,W.y,($=W.notes)!=null?$:[],i)}),c.appendChild(K)})})}function Me(s,e,t){var Q;let{background:n,drilldown:r=!0}=(Q=e.options)!=null?Q:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=Te(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:m,svg:a,tooltip:c,details:h}=wt(s,n),p=Math.max(i,420);m.style.width=p+"px",o&&(a.style.color=o);let S=300,y=p/2,x=(S-28+28)/2,g=Math.min(p/2-20,S/2-20),k=t.rows.map(L=>Math.max(0,L.y)).reduce((L,z)=>L+z,0)||1,D=-Math.PI/2;t.rows.forEach((L,z)=>{var V;let H=L.x instanceof Date?L.x.toISOString().slice(0,10):String(L.x),N=L.y,v=N/k*Math.PI*2,u=y+g*Math.cos(D),w=x+g*Math.sin(D),C=y+g*Math.cos(D+v),b=x+g*Math.sin(D+v),M=v>Math.PI?1:0,G=document.createElementNS(a.namespaceURI,"path"),nt=[`M ${y} ${x}`,`L ${u} ${w}`,`A ${g} ${g} 0 ${M} 1 ${C} ${b}`,"Z"].join(" ");G.setAttribute("d",nt),G.setAttribute("fill",it((V=L.series)!=null?V:H,z)),G.style.cursor="pointer",G.addEventListener("mouseenter",_=>{var j,tt;return mt(s,c,H,N,(tt=(j=L.notes)==null?void 0:j.length)!=null?tt:0,_)}),G.addEventListener("mouseleave",()=>gt(c)),G.addEventListener("click",()=>{var _;return yt(s,h,H,N,(_=L.notes)!=null?_:[],r)}),a.appendChild(G),D+=v})}function ke(s,e,t){var w;let{background:n,drilldown:r=!0}=(w=e.options)!=null?w:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:m,svg:a,tooltip:c,details:h}=wt(s,n),p=Math.max(i,700);m.style.width=p+"px",o&&(a.style.color=o);let S=300,y=p-48-10,x=S-28-28,g=t.rows.map(C=>{let b=C.x;if(b instanceof Date)return b.getTime();if(typeof b=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(b)){let G=new Date(b);if(!isNaN(G.getTime()))return G.getTime()}let M=Number(b);return isNaN(M)?null:M}return typeof b=="number"?b:null}),R=t.rows.map(C=>C.y),k=g.filter(C=>C!==null);if(k.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let D=Math.min(...k),Q=Math.max(...k),L=Math.min(...R),z=Math.max(...R),H=C=>48+(C-D)/(Q-D||1)*y,N=C=>S-28-(C-L)/(z-L||1)*x,v=document.createElementNS(a.namespaceURI,"line");v.setAttribute("x1",String(48)),v.setAttribute("y1",String(28)),v.setAttribute("x2",String(48)),v.setAttribute("y2",String(S-28)),v.setAttribute("stroke","currentColor"),a.appendChild(v);let u=document.createElementNS(a.namespaceURI,"line");u.setAttribute("x1",String(48)),u.setAttribute("y1",String(S-28)),u.setAttribute("x2",String(p-10)),u.setAttribute("y2",String(S-28)),u.setAttribute("stroke","currentColor"),a.appendChild(u),t.rows.forEach((C,b)=>{let M=g[b];if(M==null)return;let G=H(M),nt=N(R[b]),V=document.createElementNS(a.namespaceURI,"circle");V.setAttribute("cx",String(G)),V.setAttribute("cy",String(nt)),V.setAttribute("r","4"),V.setAttribute("fill",it(C.series,b)),V.style.cursor="pointer";let _=C.x instanceof Date?C.x.toISOString().slice(0,10):typeof C.x=="string"?C.x:String(C.x);V.addEventListener("mouseenter",j=>{var tt,I;return mt(s,c,_,C.y,(I=(tt=C.notes)==null?void 0:tt.length)!=null?I:0,j)}),V.addEventListener("mouseleave",()=>gt(c)),V.addEventListener("click",j=>{var tt;j.preventDefault(),yt(s,h,_,C.y,(tt=C.notes)!=null?tt:[],r)}),a.appendChild(V)})}var Le=require("obsidian"),Wt=class{render(e,t,n,r,o=!1){var c;let{title:i}=(c=t.options)!=null?c:{};e.empty(),e.addClass("prop-charts-container");let a=e.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":ue(e,t,n);break;case"stacked-bar":Pe(e,t,n);break;case"line":de(e,t,n,!1);break;case"area":de(e,t,n,!0);break;case"pie":Me(e,t,n);break;case"scatter":ke(e,t,n);break;case"gantt":qt(e,t,n,r);break;default:e.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!o){let h=e.createEl("button",{cls:"chart-notes-zoom-button"});h.setAttr("type","button"),h.setAttr("aria-label","Expandir gr\xE1fico"),h.textContent="\u2922",h.addEventListener("click",p=>{p.preventDefault(),new pe(t,n,this,r).open()})}}},pe=class extends Le.Modal{constructor(t,n,r,o){super(app);this.size="large";this.spec=t,this.data=n,this.renderer=r,this.ctx=o}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let n=t.createDiv({cls:"chart-notes-zoom-header"}),r=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";n.createEl("div",{text:r,cls:"chart-notes-zoom-title"});let o=n.createDiv({cls:"chart-notes-zoom-sizes"}),i=(c,h)=>{let p=o.createEl("button",{cls:"chart-notes-zoom-size-btn",text:c});(()=>{p.toggleClass("is-active",this.size===h)})(),p.addEventListener("click",y=>{y.preventDefault(),this.size=h,this.applySize(),o.querySelectorAll(".chart-notes-zoom-size-btn").forEach(g=>g.classList.remove("is-active")),p.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let m=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(m,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let n="95vw",r="85vh";switch(this.size){case"small":n="60vw",r="55vh";break;case"medium":n="80vw",r="70vh";break;case"large":default:n="95vw",r="85vh";break}t.style.maxWidth=n,t.style.width=n,t.style.height=r,t.style.maxHeight=r}};var he="chartnotes-view",Zt=class extends Jt.BasesView{constructor(t,n){super(t);this.type=he;this.containerEl=n.createDiv("chartnotes-bases-view"),this.renderer=new Wt}onDataUpdated(){var h,p,S,y;this.containerEl.empty();let t=(h=this.data)==null?void 0:h.groupedData;if(!t||t.length===0){this.containerEl.createDiv({cls:"prop-charts-empty",text:"Sem dados (Base vazia ou sem resultados)."});return}let r=(((p=this.config)==null?void 0:p.get("chartType"))||"bar").trim().toLowerCase(),o;if(r==="gantt"?o=this.buildRowsForGantt(t):r==="scatter"?o=this.buildRowsForScatter(t):o=this.buildRowsForAggregatedCharts(t),!o.length){this.containerEl.createDiv({cls:"prop-charts-empty",text:"Sem linhas para exibir (verifique as propriedades configuradas)."});return}let i={rows:o},m=this.buildEncoding(),a={type:r,source:{type:"properties",query:""},encoding:m,options:{title:(y=(S=this.config)==null?void 0:S.name)!=null?y:"Chart Notes (Bases)"}},c={refresh:()=>this.onDataUpdated()};this.renderer.render(this.containerEl,a,i,c)}getSelectedProp(t){var i;let n=this.config,r=n==null?void 0:n.get(t);if(!r||typeof r!="string")return{id:null,name:null};let o=r;try{let m=(0,Jt.parsePropertyId)(o);return{id:r,name:(i=m==null?void 0:m.name)!=null?i:r}}catch(m){return{id:r,name:r}}}readValue(t,n){if(!n.id)return null;let r;try{r=t.getValue(n.id)}catch(o){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=t.trim();if(!n)return null;let r=new Date(n);return Number.isNaN(r.getTime())?null:r}buildRowsForAggregatedCharts(t){var m,a;let n=this.getSelectedProp("xProperty"),r=this.getSelectedProp("yProperty"),o=this.getSelectedProp("seriesProperty"),i=new Map;for(let c of t)for(let h of c.entries){let p=h.file,S=(a=this.readValue(h,n))!=null?a:p!=null&&p.name?String(p.name):String((m=p==null?void 0:p.path)!=null?m:""),y=this.readValue(h,r),x=1;if(r.id){if(y==null)continue;let Q=Number(y);if(Number.isNaN(Q))continue;x=Q}let g=this.readValue(h,o),R=g!=null?String(g):void 0,k=`${S}@@${R!=null?R:""}`,D=i.get(k);D||(D={x:S,y:0,series:R,notes:[],props:{}},i.set(k,D)),D.y+=x,p!=null&&p.path&&D.notes.push(p.path),D.props&&n.name&&(D.props[n.name]=S),D.props&&r.name&&y!=null&&(D.props[r.name]=x),D.props&&o.name&&g!=null&&(D.props[o.name]=g)}return Array.from(i.values())}buildRowsForScatter(t){let n=this.getSelectedProp("xProperty"),r=this.getSelectedProp("yProperty"),o=this.getSelectedProp("seriesProperty"),i=[];for(let m of t)for(let a of m.entries){let c=a.file,h=this.readValue(a,n),p=this.readValue(a,r);if(h==null||p==null)continue;let S=Number(h),y=Number(p);if(Number.isNaN(S)||Number.isNaN(y))continue;let x=this.readValue(a,o),g=x!=null?String(x):void 0,R={x:S,y,series:g,notes:c!=null&&c.path?[c.path]:[],props:{}};i.push(R)}return i}buildRowsForGantt(t){var p,S;let n=this.getSelectedProp("xProperty"),r=this.getSelectedProp("seriesProperty"),o=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),m=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),c=this.getSelectedProp("groupProperty"),h=[];for(let y of t)for(let x of y.entries){let g=x.file,R=this.readValue(x,o),k=this.readValue(x,i);if(!R||!k)continue;let D=this.parseDate(R),Q=this.parseDate(k);if(!D||!Q)continue;let L=(S=this.readValue(x,n))!=null?S:g!=null&&g.name?String(g.name).replace(/\.md$/i,""):String((p=g==null?void 0:g.path)!=null?p:""),z=this.readValue(x,m),H=this.parseDate(z!=null?z:null),N=this.readValue(x,a),v=N!=null?Number(N):void 0,u=typeof v=="number"&&!Number.isNaN(v),w=this.readValue(x,r),C=w!=null?String(w):void 0,b=this.readValue(x,c),M={};a.name&&u&&(M[a.name]=v),c.name&&b!=null&&(M[c.name]=b);let G={x:L,y:0,series:C,start:D,end:Q,due:H!=null?H:void 0,notes:g!=null&&g.path?[g.path]:[],props:M};h.push(G)}return h}buildEncoding(){var h,p,S,y,x,g,R,k;let t=this.getSelectedProp("xProperty"),n=this.getSelectedProp("yProperty"),r=this.getSelectedProp("seriesProperty"),o=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),m=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),c=this.getSelectedProp("groupProperty");return{x:(h=t.name)!=null?h:"x",y:(p=n.name)!=null?p:"y",series:(S=r.name)!=null?S:"series",start:(y=o.name)!=null?y:"start",end:(x=i.name)!=null?x:"end",due:(g=m.name)!=null?g:"due",duration:(R=a.name)!=null?R:"duration",group:(k=c.name)!=null?k:"group"}}};var Ie=require("obsidian"),te=class{constructor(e){this.index=new Map;this.app=e}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(e){if(e.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(e)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Ie.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[m,a]of Object.entries(i))m!=="position"&&(t[m]=a)}let o=this.app.metadataCache.getFileCache(e);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",e.path,n)}this.index.set(e.path,{path:e.path,props:t})}removeFile(e){this.index.delete(e.path)}};function $e(s,e){if(!e||e.length===0)return!0;for(let t of e){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Qe(s,e){if(!e||e.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of e)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let n=String(t);for(let r of e)if(n===r||n==="#"+r)return!0;return!1}function ne(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function $t(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,n,r]=s.split("-");return new Date(Number(t),Number(n)-1,Number(r),0,0,0,0)}let e=new Date(s);return isNaN(e.getTime())?null:e}function ut(s){let e=new Date(s);return e.setHours(0,0,0,0),e}function ee(s,e){let t=new Date(s);return t.setDate(t.getDate()-e),t}function qe(s,e){return ee(s,e*7)}function je(s,e){let t=new Date(s);return t.setMonth(t.getMonth()-e),t}function me(s,e){let t=new Date(s);return t.setDate(t.getDate()+e),t}function Ze(s,e){return me(s,e*7)}function Je(s,e){let t=new Date(s);return t.setMonth(t.getMonth()+e),t}function Fe(s){let e=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(e)||e.endsWith("date")||e.endsWith("at")||e.endsWith("on"))}function _e(s,e){let t=e?new Date(e):new Date,n=ut(t),r=s.trim().toLowerCase();if(r==="today")return n;if(r==="yesterday")return ut(ee(n,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(ee(n,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(ee(n,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(qe(n,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(je(n,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(me(n,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(me(n,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Ze(n,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Je(n,o))}return null}function He(s){let e=s.trim(),t=e.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let h=t[1].trim(),p=t[2].trim(),S=t[3].trim(),y=Fe(h),x=fe(p,y),g=fe(S,y),R=x.valueType==="date"||g.valueType==="date"?"date":x.valueType;return{field:h,op:"between",value:x.value,value2:g.value,valueType:R}}let n=/(==|!=|>=|<=|>|<)/,r=e.split(n);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),m=r[2].trim(),a=Fe(o),c=fe(m,a);return{field:o,op:i,value:c.value,valueType:c.valueType}}function fe(s,e){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),r=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(e){if(t==="0"||n==="today")return{value:ut(new Date),valueType:"date"};let i=_e(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=_e(t);if(i)return{value:i,valueType:"date"}}if(ne(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function ze(s,e){let t=s[e.field];if(t==null)return!1;if(e.valueType==="date"){let o=t instanceof Date?ut(t):ne(t)?ut($t(t)):null;if(!o)return!1;let i=e.value instanceof Date?e.value:null,m=e.value2 instanceof Date?e.value2:null;if(!i)return!1;let a=o.getTime(),c=ut(i).getTime();switch(e.op){case"==":return a===c;case"!=":return a!==c;case">":return a>c;case">=":return a>=c;case"<":return a<c;case"<=":return a<=c;case"between":if(!m)return!1;let h=ut(m).getTime();return a>=c&&a<=h}}if(e.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(e.value);switch(e.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof e.value2!="number"?!1:o>=i&&o<=e.value2}}let n=String(t),r=String(e.value);switch(e.op){case"==":return n===r;case"!=":return n!==r;case">":return n>r;case">=":return n>=r;case"<":return n<r;case"<=":return n<=r;case"between":return!1}}function tn(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(ne(s)){let e=$t(s);if(e)return{key:e,isDate:!0}}return{key:s,isDate:!1}}function en(s,e){let t=s.x,n=e.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let r=String(t),o=String(n);return r<o?-1:r>o?1:0}function nn(s,e){var o,i;let t=en(s,e);if(t!==0)return t;let n=(o=s.series)!=null?o:"",r=(i=e.series)!=null?i:"";return n<r?-1:n>r?1:0}function rn(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let e=s.trim().match(/^(\d+)/);if(e){let t=Number(e[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function sn(s){var n,r;let e=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:"__no_series__",a=((r=e.get(i))!=null?r:0)+o.y;e.set(i,a),t.push({...o,y:a})}return t}function on(s,e){var i,m;let t=rn(e);if(!t||t<=1)return[...s];let n=new Map,r=new Map,o=[];for(let a of s){let c=(i=a.series)!=null?i:"__no_series__",h=n.get(c);h||(h=[],n.set(c,h));let p=(m=r.get(c))!=null?m:0;if(h.push(a.y),p+=a.y,h.length>t){let x=h.shift();p-=x}r.set(c,p);let S=h.length||1,y=p/S;o.push({...a,y})}return o}var re=class{constructor(e,t){this.getIndex=e,this.defaultPaths=t}run(e){var i,m,a;let t=this.getIndex(),n=(i=e.source)!=null&&i.paths&&e.source.paths.length?e.source.paths:this.defaultPaths,r=(m=e.source)!=null&&m.tags&&e.source.tags.length?e.source.tags:[],o=[];for(let c of t){let h=n&&n.length?$e(c.path,n):!0,p=r&&r.length?Qe(c.props,r):!0;if(!h||!p)continue;let S=!0;if((a=e.source)!=null&&a.where&&e.source.where.length>0)for(let y of e.source.where){let x;try{x=He(y)}catch(g){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${y} (${g.message})`)}if(!ze(c.props,x)){S=!1;break}}S&&o.push(c)}return e.type==="gantt"?this.runGantt(e,o):e.type==="table"?this.runTable(e,o):this.runStandard(e,o)}runTable(e,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=e.encoding)==null?void 0:r.x,yField:(o=e.encoding)==null?void 0:o.y}}runGantt(e,t){var p,S,y;let n=(p=e.encoding)!=null?p:{},r=n.start,o=n.end,i=(S=n.label)!=null?S:n.x,m=n.series,a=n.duration,c=n.due,h=[];for(let x of t){let g=(y=x.props)!=null?y:{},R=N=>Array.isArray(N)?N[0]:N,k=null;if(o){let N=R(g[o]),v=$t(N);v&&(k=v)}if(!k)continue;let D=null;if(r){let N=R(g[r]),v=$t(N);v&&(D=v)}if(!D&&a){let N=R(g[a]),v=Number(N);Number.isNaN(v)||(D=new Date(k.getTime()-v*6e4))}D||(D=new Date(k.getTime()));let Q;if(c){let N=R(g[c]),v=$t(N);v&&(Q=v)}let L;if(i){let N=R(g[i]);(N==null||N==="")&&(N=x.path),L=N}else L=x.path;let z;if(m){let N=R(g[m]);N!=null&&(z=String(N))}let H={x:L,y:0,notes:[x.path],series:z,start:D,end:k,props:g};Q&&(H.due=Q),h.push(H)}return h.sort((x,g)=>{let R=x.start?x.start.getTime():0,k=g.start?g.start.getTime():0;return R-k}),{rows:h,xField:i,yField:o}}runStandard(e,t){var x,g,R,k,D,Q,L,z,H,N;let n=(x=e.encoding)==null?void 0:x.x,r=(g=e.encoding)==null?void 0:g.y,o=(R=e.encoding)==null?void 0:R.series;if(!n)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(k=e.aggregate)!=null?k:{},m=(D=i.y)!=null?D:null,a=!!i.cumulative,c=i.rolling;if(!r&&m!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let h=[];for(let v of t){let u=(Q=v.props)!=null?Q:{},w=_=>Array.isArray(_)?_[0]:_,C=w(u[n]);if(C==null)continue;let b=tn(C),M=b.key,G=b.isDate,nt;if(o){let _=w(u[o]);_!=null&&String(_).trim()!==""&&(nt=String(_))}let V;if(m==="count")V=1;else{let _=w(u[r]);if(_==null)continue;let j=Number(_);if(Number.isNaN(j))continue;V=j}h.push({x:M,y:V,notes:[v.path],series:nt,props:u,_isDate:G,_origX:C})}if(h.length===0)return{rows:[],xField:n,yField:r};let p=[];if(m){let v=new Map;for(let u of h){let w=(L=u.series)!=null?L:"",C=u.x instanceof Date?u.x.toISOString().slice(0,10):String(u.x),b=w+"||"+C,M=(z=v.get(b))!=null?z:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:u.x,isDate:u._isDate,series:u.series,props:u.props};M.sum+=u.y,M.count+=1,u.y<M.min&&(M.min=u.y),u.y>M.max&&(M.max=u.y),M.notes.push(...u.notes),M.props=(H=u.props)!=null?H:M.props,v.set(b,M)}for(let[,u]of v){let w=u.sum;switch(m){case"sum":w=u.sum;break;case"avg":w=u.sum/u.count;break;case"min":w=u.min;break;case"max":w=u.max;break;case"count":w=u.count;break}p.push({x:u.xRep,y:w,notes:u.notes,series:u.series,props:u.props})}}else p=h.map(v=>({x:v.x,y:v.y,notes:v.notes,series:v.series,props:v.props}));if(p.length===0)return{rows:[],xField:n,yField:r};let S=((N=e.sort)==null?void 0:N.x)==="desc"?"desc":"asc";if(p.sort((v,u)=>{let w=nn(v,u);return S==="asc"?w:-w}),(a||c)&&!(e.type==="line"||e.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&c)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let y=p;return c?y=on(p,c):a&&(y=sn(p)),{rows:y,xField:n,yField:r}}};var se=class extends Lt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("loading Chart Notes plugin"),this.indexer=new te(this.app),await this.indexer.buildIndex(),this.query=new re(()=>this.indexer.getAll(),[]),this.renderer=new Wt,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,n,r)=>{var h;let o;try{let p=(0,Lt.parseYaml)(t);if(!p||typeof p!="object"){n.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}o=p}catch(p){n.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+p.message});return}if(!o.type){n.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=o.type==="gantt",m=o.type==="table";if(!i&&!m){if(!o.encoding||!o.encoding.x){n.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let S=((h=o.aggregate)==null?void 0:h.y)==="count";if(!o.encoding.y&&!S){n.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}o.encoding||(o.encoding={}),o.source||(o.source={});let c;try{c=this.query.run(o)}catch(p){n.createEl("div",{text:"Chart Notes: erro na query: "+p.message});return}this.renderer.render(n,o,c)}),this.registerBasesView(he,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new Zt(t,n),options:()=>[{type:"text",key:"chartType",displayName:"Tipo do gr\xE1fico (bar, line, area, pie, scatter, gantt, stacked-bar)",default:"bar"},{type:"property",key:"xProperty",displayName:"Propriedade X / label"},{type:"property",key:"yProperty",displayName:"Propriedade Y / valor (vazio = conta linhas)"},{type:"property",key:"seriesProperty",displayName:"S\xE9rie (opcional, gera legenda)"},{type:"property",key:"startProperty",displayName:"In\xEDcio (Gantt)"},{type:"property",key:"endProperty",displayName:"Fim (Gantt)"},{type:"property",key:"dueProperty",displayName:"Due date (Gantt, opcional)"},{type:"property",key:"durationProperty",displayName:"Dura\xE7\xE3o em minutos (Gantt, opcional)"},{type:"property",key:"groupProperty",displayName:"Grupo (Gantt / s\xE9ries, opcional)"}]})}onunload(){console.log("unloading Chart Notes plugin")}};
