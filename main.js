/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var Ke=Object.getOwnPropertyDescriptor;var Ue=Object.getOwnPropertyNames;var Ve=Object.prototype.hasOwnProperty;var We=(s,e)=>{for(var t in e)ce(s,t,{get:e[t],enumerable:!0})},Oe=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ue(e))!Ve.call(s,r)&&r!==t&&ce(s,r,{get:()=>e[r],enumerable:!(n=Ke(e,r))||n.enumerable});return s};var Ye=s=>Oe(ce({},"__esModule",{value:!0}),s);var dn={};We(dn,{default:()=>oe});module.exports=Ye(dn);var Kt=require("obsidian");var jt=require("obsidian"),ue="chartnotes-view",Xe=["bar","stacked-bar","line","area","pie","scatter","gantt"];function ze(s){let e=String(s!=null?s:"bar").trim().toLowerCase();return Xe.includes(e)?e:"bar"}var qe=["sum","count","cumulative-sum"];function je(s){let e=String(s!=null?s:"sum").trim().toLowerCase();return qe.includes(e)?e:"sum"}var Ze=["auto","none","day","week","month","quarter","year"];function Je(s){let e=String(s!=null?s:"auto").trim().toLowerCase();return Ze.includes(e)?e:"auto"}var zt="(missing)",qt=class extends jt.BasesView{constructor(t,n,r){super(t);this.type=ue;this.renderer=r,this.rootEl=n.createDiv("chartnotes-bases-view")}onDataUpdated(){var Q,V,W;this.rootEl.empty();let t=this.data,n=(Q=t==null?void 0:t.groupedData)!=null?Q:[];if(!n.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,o=ze((V=r==null?void 0:r.get("chartType"))!=null?V:"bar"),i=o==="pie",p=o==="scatter",a=o==="gantt",l=je(r==null?void 0:r.get("aggregateMode")),w=l==="cumulative-sum"&&!(o==="line"||o==="area")?"sum":l,m=Je(r==null?void 0:r.get("xBucket")),g=i||p||a?"none":m,x=this.getPropFromConfig("xProperty"),v=this.getPropFromConfig("ganttLabelProperty"),T=a&&v.id?v:x,S=this.getPropFromConfig("yProperty"),b=this.getPropFromConfig("seriesProperty");i&&(b={id:null,name:null});let P=this.getPropFromConfig("startProperty"),R=this.getPropFromConfig("endProperty"),F=this.getPropFromConfig("dueProperty"),$=this.getPropFromConfig("durationProperty"),y=this.getPropFromConfig("groupProperty");if(!a&&!T.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(p&&(!T.id||!S.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(P.id||R.id||F.id||$.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs at least Start/End or Due/Duration configured."});return}let D;if(a)D=this.buildRowsForGantt(n,T,b,P,R,F,$,y);else if(p)D=this.buildRowsForScatter(n,T,S,b);else{let _=i;D=this.buildRowsForAggregatedCharts(n,T,S,b,w,g,_)}if(!D.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let u={rows:D},E=((W=r==null?void 0:r.get("title"))!=null?W:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",f=r==null?void 0:r.get("drilldown"),A=typeof f=="boolean"?f:!0,H=this.buildEncoding({x:T,y:S,series:b,start:P,end:R,due:F,duration:$,group:y,aggMode:w,xBucket:g,chartType:o}),Z={type:o,source:{type:"properties",query:""},encoding:H,options:{title:E,drilldown:A}},B={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,Z,u,B)}getPropFromConfig(t){var p,a;let n=this.config,r=(p=n==null?void 0:n.get)==null?void 0:p.call(n,t);if(!r)return{id:null,name:null};let o=r.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let l=(0,jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,n){if(!n.id)return null;let r;try{r=t.getValue(n.id)}catch(o){return null}if(r==null)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=new Date(t.trim());return Number.isNaN(n.getTime())?null:n}compareX(t,n){let r=this.parseDate(t!=null?String(t):null),o=this.parseDate(n!=null?String(n):null);if(r&&o)return r.getTime()-o.getTime();let i=Number(t),p=Number(n);return!Number.isNaN(i)&&!Number.isNaN(p)?i-p:String(t!=null?t:"").localeCompare(String(n!=null?n:""))}fmtDate(t){let n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${o}`}startOfWeek(t){let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(n.getDay()+6)%7;return n.setDate(n.getDate()-r),n.setHours(0,0,0,0),n}bucketX(t,n){let r=this.parseDate(t);if(!r)return t;switch(n){case"none":case"auto":return t;case"day":{let o=new Date(r.getFullYear(),r.getMonth(),r.getDate());return this.fmtDate(o)}case"week":{let o=this.startOfWeek(r);return`${this.fmtDate(o)} (W)`}case"month":{let o=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${o}`}case"quarter":{let o=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${o}`}case"year":return`${r.getFullYear()}`;default:return t}}getXValuesForEntry(t,n,r,o){var h,w;let i=[],p=m=>this.bucketX(m,r);if(!n.id){let m=t.file,g=m!=null&&m.name?String(m.name):String((h=m==null?void 0:m.path)!=null?h:zt);return i.push(p(g)),i}if(!o){let m=(w=this.readValue(t,n))!=null?w:zt;return i.push(p(m)),i}let a=null;try{a=t.getValue(n.id)}catch(m){a=null}let l=m=>{if(!m)return;let g=String(m).trim();g&&i.push(p(g))};if(a==null)l(zt);else if(typeof a=="string"){let m=a.trim();if(m){let g=m.split(/\s+/);for(let x of g)l(x)}}else if(Array.isArray(a))for(let m of a){if(m==null)continue;let g;try{g=m.toString()}catch(x){continue}l(g)}else if(typeof a.toArray=="function"){let m=a.toArray();if(Array.isArray(m))for(let g of m){if(g==null)continue;let x;try{x=g.toString()}catch(v){continue}l(x)}else{let g;try{g=a.toString()}catch(x){g=""}l(g)}}else{let m;try{m=a.toString()}catch(g){m=""}l(m)}return i.length||l(zt),i}buildRowsForAggregatedCharts(t,n,r,o,i,p,a){let l=new Map,h=a||i==="count"||!r.id&&i!=="sum",w=r.name||"y";for(let g of t)for(let x of g.entries){let v=x.file,T=this.getXValuesForEntry(x,n,p,a),S=1,b=null;if(!h&&r.id){if(b=this.readValue(x,r),b==null)continue;let F=Number(b);if(Number.isNaN(F))continue;S=F}else S=1;let P=this.readValue(x,o),R=P!=null?String(P):void 0;for(let F of T){let $=`${F}@@${R!=null?R:""}`,y=l.get($);y||(y={x:F,y:0,series:R,notes:[],props:{}},l.set($,y)),y.y+=S,v!=null&&v.path&&y.notes.push(v.path),y.props&&n.name&&(y.props[n.name]=F),!h&&y.props&&w&&b!=null&&(y.props[w]=y.y),h&&y.props&&(y.props[w]=y.y),y.props&&o.name&&P!=null&&(y.props[o.name]=P)}}let m=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(m):m}toCumulative(t){var o,i;let n=new Map;for(let p of t){let a=(o=p.series)!=null?o:"__no_series__",l=n.get(a);l||(l=[],n.set(a,l)),l.push(p)}let r=[];for(let[,p]of n){let a=[...p].sort((h,w)=>this.compareX(h.x,w.x)),l=0;for(let h of a){let w=Number((i=h.y)!=null?i:0);Number.isNaN(w)||(l+=w,r.push({...h,y:l}))}}return r}buildRowsForScatter(t,n,r,o){let i=[];for(let p of t)for(let a of p.entries){let l=a.file,h=this.readValue(a,n),w=this.readValue(a,r);if(h==null||w==null)continue;let m=Number(h),g=Number(w);if(Number.isNaN(m)||Number.isNaN(g))continue;let x=this.readValue(a,o),v=x!=null?String(x):void 0;i.push({x:m,y:g,series:v,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,n,r,o,i,p,a,l){var g,x;let h=[];for(let v of t)for(let T of v.entries){let S=T.file,b=this.readValue(T,o),P=this.readValue(T,i),R=this.readValue(T,p),F=this.readValue(T,a),$=F!=null?Number(F):NaN,y=Number.isFinite($)&&$>0,D=y?$*6e4:36e5,u=this.parseDate(b),N=this.parseDate(P),E=this.parseDate(R),f=u,A=N;if(f&&A||(f&&y&&!A?A=new Date(f.getTime()+D):!f&&A&&y?f=new Date(A.getTime()-D):!f&&!A&&E&&y?(A=E,f=new Date(E.getTime()-D)):f&&!A&&!y?A=new Date(f.getTime()+36e5):!f&&A&&!y?f=new Date(A.getTime()-36e5):!f&&!A&&E&&!y&&(f=E,A=new Date(E.getTime()+36e5))),!f||!A)continue;if(f.getTime()>A.getTime()){let W=f;f=A,A=W}let H=(x=this.readValue(T,n))!=null?x:S!=null&&S.name?String(S.name).replace(/\.md$/i,""):String((g=S==null?void 0:S.path)!=null?g:""),Z=this.readValue(T,r),B=Z!=null?String(Z):void 0,Q=this.readValue(T,l),V={};n.name&&(V[n.name]=H),V.label=H,o.name&&f&&(V[o.name]=f),i.name&&A&&(V[i.name]=A),p.name&&E&&(V[p.name]=E),y&&a.name&&(V[a.name]=$),l.name&&Q!=null&&(V[l.name]=Q),h.push({x:H,y:0,series:B,start:f,end:A,due:E!=null?E:void 0,notes:S!=null&&S.path?[S.path]:[],props:V})}return h.sort((v,T)=>!v.start||!T.start?0:v.start.getTime()-T.start.getTime()),h}buildEncoding(t){var i,p,a,l,h,w,m,g,x;let n=(i=t.x.name)!=null?i:"x",r=(p=t.y.name)!=null?p:"y",o={x:n,y:r,series:(a=t.series.name)!=null?a:"series",start:(l=t.start.name)!=null?l:"start",end:(h=t.end.name)!=null?h:"end",due:(w=t.due.name)!=null?w:"due",duration:(m=t.duration.name)!=null?m:"duration",group:(g=t.group.name)!=null?g:"group"};return t.chartType==="gantt"&&(o.label=(x=t.x.name)!=null?x:"label"),o}};var Re=require("obsidian"),Zt=class{constructor(e){this.index=new Map;this.app=e}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(e){if(e.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(e)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Re.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[p,a]of Object.entries(i))p!=="position"&&(t[p]=a)}let o=this.app.metadataCache.getFileCache(e);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",e.path,n)}this.index.set(e.path,{path:e.path,props:t})}removeFile(e){this.index.delete(e.path)}};function ke(s,e){if(!e||e.length===0)return!0;for(let t of e){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Pe(s,e){if(!e||e.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of e)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let n=String(t);for(let r of e)if(n===r||n==="#"+r)return!0;return!1}function te(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function _t(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,n,r]=s.split("-");return new Date(Number(t),Number(n)-1,Number(r),0,0,0,0)}let e=new Date(s);return isNaN(e.getTime())?null:e}function ut(s){let e=new Date(s);return e.setHours(0,0,0,0),e}function Jt(s,e){let t=new Date(s);return t.setDate(t.getDate()-e),t}function tn(s,e){return Jt(s,e*7)}function en(s,e){let t=new Date(s);return t.setMonth(t.getMonth()-e),t}function pe(s,e){let t=new Date(s);return t.setDate(t.getDate()+e),t}function nn(s,e){return pe(s,e*7)}function rn(s,e){let t=new Date(s);return t.setMonth(t.getMonth()+e),t}function Ne(s){let e=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(e)||e.endsWith("date")||e.endsWith("at")||e.endsWith("on"))}function Me(s,e){let t=e?new Date(e):new Date,n=ut(t),r=s.trim().toLowerCase();if(r==="today")return n;if(r==="yesterday")return ut(Jt(n,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(Jt(n,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Jt(n,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(tn(n,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(en(n,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(pe(n,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(pe(n,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(nn(n,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(rn(n,o))}return null}function Le(s){let e=s.trim(),t=e.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let h=t[1].trim(),w=t[2].trim(),m=t[3].trim(),g=Ne(h),x=de(w,g),v=de(m,g),T=x.valueType==="date"||v.valueType==="date"?"date":x.valueType;return{field:h,op:"between",value:x.value,value2:v.value,valueType:T}}let n=/(==|!=|>=|<=|>|<)/,r=e.split(n);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),p=r[2].trim(),a=Ne(o),l=de(p,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function de(s,e){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),r=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(e){if(t==="0"||n==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(te(t)){let i=_t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ie(s,e){let t=s[e.field];if(t==null)return!1;if(e.valueType==="date"){let o=t instanceof Date?ut(t):te(t)?ut(_t(t)):null;if(!o)return!1;let i=e.value instanceof Date?e.value:null,p=e.value2 instanceof Date?e.value2:null;if(!i)return!1;let a=o.getTime(),l=ut(i).getTime();switch(e.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!p)return!1;let h=ut(p).getTime();return a>=l&&a<=h}}if(e.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(e.value);switch(e.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof e.value2!="number"?!1:o>=i&&o<=e.value2}}let n=String(t),r=String(e.value);switch(e.op){case"==":return n===r;case"!=":return n!==r;case">":return n>r;case">=":return n>=r;case"<":return n<r;case"<=":return n<=r;case"between":return!1}}function sn(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(te(s)){let e=_t(s);if(e)return{key:e,isDate:!0}}return{key:s,isDate:!1}}function on(s,e){let t=s.x,n=e.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let r=String(t),o=String(n);return r<o?-1:r>o?1:0}function an(s,e){var o,i;let t=on(s,e);if(t!==0)return t;let n=(o=s.series)!=null?o:"",r=(i=e.series)!=null?i:"";return n<r?-1:n>r?1:0}function ln(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let e=s.trim().match(/^(\d+)/);if(e){let t=Number(e[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function cn(s){var n,r;let e=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:"__no_series__",a=((r=e.get(i))!=null?r:0)+o.y;e.set(i,a),t.push({...o,y:a})}return t}function un(s,e){var i,p;let t=ln(e);if(!t||t<=1)return[...s];let n=new Map,r=new Map,o=[];for(let a of s){let l=(i=a.series)!=null?i:"__no_series__",h=n.get(l);h||(h=[],n.set(l,h));let w=(p=r.get(l))!=null?p:0;if(h.push(a.y),w+=a.y,h.length>t){let x=h.shift();w-=x}r.set(l,w);let m=h.length||1,g=w/m;o.push({...a,y:g})}return o}var ee=class{constructor(e,t){this.getIndex=e,this.defaultPaths=t}run(e){var i,p,a;let t=this.getIndex(),n=(i=e.source)!=null&&i.paths&&e.source.paths.length?e.source.paths:this.defaultPaths,r=(p=e.source)!=null&&p.tags&&e.source.tags.length?e.source.tags:[],o=[];for(let l of t){let h=n&&n.length?ke(l.path,n):!0,w=r&&r.length?Pe(l.props,r):!0;if(!h||!w)continue;let m=!0;if((a=e.source)!=null&&a.where&&e.source.where.length>0)for(let g of e.source.where){let x;try{x=Le(g)}catch(v){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${g} (${v.message})`)}if(!Ie(l.props,x)){m=!1;break}}m&&o.push(l)}return e.type==="gantt"?this.runGantt(e,o):e.type==="table"?this.runTable(e,o):this.runStandard(e,o)}runTable(e,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=e.encoding)==null?void 0:r.x,yField:(o=e.encoding)==null?void 0:o.y}}runGantt(e,t){var w,m,g;let n=(w=e.encoding)!=null?w:{},r=n.start,o=n.end,i=(m=n.label)!=null?m:n.x,p=n.series,a=n.duration,l=n.due,h=[];for(let x of t){let v=(g=x.props)!=null?g:{},T=y=>Array.isArray(y)?y[0]:y,S=null;if(o){let y=T(v[o]),D=_t(y);D&&(S=D)}if(!S)continue;let b=null;if(r){let y=T(v[r]),D=_t(y);D&&(b=D)}if(!b&&a){let y=T(v[a]),D=Number(y);Number.isNaN(D)||(b=new Date(S.getTime()-D*6e4))}b||(b=new Date(S.getTime()));let P;if(l){let y=T(v[l]),D=_t(y);D&&(P=D)}let R;if(i){let y=T(v[i]);(y==null||y==="")&&(y=x.path),R=y}else R=x.path;let F;if(p){let y=T(v[p]);y!=null&&(F=String(y))}let $={x:R,y:0,notes:[x.path],series:F,start:b,end:S,props:v};P&&($.due=P),h.push($)}return h.sort((x,v)=>{let T=x.start?x.start.getTime():0,S=v.start?v.start.getTime():0;return T-S}),{rows:h,xField:i,yField:o}}runStandard(e,t){var x,v,T,S,b,P,R,F,$,y;let n=(x=e.encoding)==null?void 0:x.x,r=(v=e.encoding)==null?void 0:v.y,o=(T=e.encoding)==null?void 0:T.series;if(!n)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(S=e.aggregate)!=null?S:{},p=(b=i.y)!=null?b:null,a=!!i.cumulative,l=i.rolling;if(!r&&p!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let h=[];for(let D of t){let u=(P=D.props)!=null?P:{},N=Q=>Array.isArray(Q)?Q[0]:Q,E=N(u[n]);if(E==null)continue;let f=sn(E),A=f.key,H=f.isDate,Z;if(o){let Q=N(u[o]);Q!=null&&String(Q).trim()!==""&&(Z=String(Q))}let B;if(p==="count")B=1;else{let Q=N(u[r]);if(Q==null)continue;let V=Number(Q);if(Number.isNaN(V))continue;B=V}h.push({x:A,y:B,notes:[D.path],series:Z,props:u,_isDate:H,_origX:E})}if(h.length===0)return{rows:[],xField:n,yField:r};let w=[];if(p){let D=new Map;for(let u of h){let N=(R=u.series)!=null?R:"",E=u.x instanceof Date?u.x.toISOString().slice(0,10):String(u.x),f=N+"||"+E,A=(F=D.get(f))!=null?F:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:u.x,isDate:u._isDate,series:u.series,props:u.props};A.sum+=u.y,A.count+=1,u.y<A.min&&(A.min=u.y),u.y>A.max&&(A.max=u.y),A.notes.push(...u.notes),A.props=($=u.props)!=null?$:A.props,D.set(f,A)}for(let[,u]of D){let N=u.sum;switch(p){case"sum":N=u.sum;break;case"avg":N=u.sum/u.count;break;case"min":N=u.min;break;case"max":N=u.max;break;case"count":N=u.count;break}w.push({x:u.xRep,y:N,notes:u.notes,series:u.series,props:u.props})}}else w=h.map(D=>({x:D.x,y:D.y,notes:D.notes,series:D.series,props:D.props}));if(w.length===0)return{rows:[],xField:n,yField:r};let m=((y=e.sort)==null?void 0:y.x)==="desc"?"desc":"asc";if(w.sort((D,u)=>{let N=an(D,u);return m==="asc"?N:-N}),(a||l)&&!(e.type==="line"||e.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let g=w;return l?g=un(w,l):a&&(g=cn(w)),{rows:g,xField:n,yField:r}}};var Tt=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(s,e){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,r)=>n*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(s,e){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,e&&(n.style.background=e);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let p=s.createDiv({cls:"chart-notes-details"});return p.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:p}}function gt(s,e,t,n,r,o){let i=s.getBoundingClientRect(),p=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);e.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${p}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,e.style.display="block";let a=e.getBoundingClientRect(),l=o.clientX-i.left+6,h=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),h+a.height>i.height-4&&(h=i.height-a.height-4),h<4&&(h=4),e.style.left=l+"px",e.style.top=h+"px"}function mt(s){s.style.display="none"}function ht(s,e,t,n,r,o){if(!o)return;if(e.empty(),!r||r.length===0){e.style.display="none";return}e.style.display="block";let i=e.createEl("div",{cls:"chart-notes-details-header"}),p=i.createEl("div",{cls:"chart-notes-details-title"});p.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{e.style.display="none"});let l=e.createEl("ul",{cls:"chart-notes-details-list"});for(let h of r){let m=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:h});m.href="#",m.addEventListener("click",g=>{g.preventDefault(),app.workspace.openLinkText(h,"",!1)})}}function Ht(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let e=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${e}/${t}`}function _e(s){if(!s)return!1;let e=s.trim().toLowerCase();if(e==="#fff"||e==="#ffffff"||e==="white")return!0;if(!e.startsWith("#"))return!1;let t,n,r;if(e.length===4)t=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16),r=parseInt(e[3]+e[3],16);else if(e.length===7)t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*r)/255>.7}var fe=class extends Tt.Modal{constructor(t,n,r,o){var p;super(app);this.notePath=t,this.spec=n,this.refresh=r,this.reindexFile=o;let i=(p=n.encoding)!=null?p:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var y,D;let{contentEl:t}=this;t.empty();let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Tt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(n),o={},i=r,p=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(p){try{o=(y=(0,Tt.parseYaml)(p[1]))!=null?y:{}}catch(u){o={}}i=r.slice(p[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(D=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?D:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),h=l.createEl("a",{text:a,cls:"gantt-edit-title"});h.href="#",h.addEventListener("click",u=>{u.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let w=l.createDiv({cls:"gantt-edit-subtitle"});w.textContent=this.notePath;let m=t.createDiv({cls:"gantt-edit-form"}),g=u=>{let N=m.createDiv({cls:"gantt-edit-row"}),E=N.createDiv({cls:"gantt-edit-label"});E.textContent=u;let f=N.createDiv({cls:"gantt-edit-field"});return{row:N,field:f}},x=u=>{if(!u)return"";let E=String(u).match(/^(\d{4}-\d{2}-\d{2})/);return E?E[1]:""},v=u=>{if(u=u.trim(),!!u&&/^\d{4}-\d{2}-\d{2}$/.test(u))return u},T=null;if(this.startKey){let{field:u}=g(this.startKey+" (in\xEDcio)");T=u.createEl("input",{type:"date"}),T.value=x(o[this.startKey])}let S=null;if(this.endKey){let{field:u}=g(this.endKey+" (fim)");S=u.createEl("input",{type:"date"}),S.value=x(o[this.endKey])}let b=null;if(this.durationKey){let{field:u}=g(this.durationKey+" (minutos)");b=u.createEl("input",{type:"number"});let N=o[this.durationKey];b.value=N!=null?String(N):"",b.min="0",b.step="5"}let P=null;if(this.dueKey){let{field:u}=g(this.dueKey+" (due)");P=u.createEl("input",{type:"date"}),P.value=x(o[this.dueKey])}let R=t.createDiv({cls:"gantt-edit-buttons"}),F=R.createEl("button",{text:"Salvar",cls:"mod-cta"});R.createEl("button",{text:"Cancelar"}).addEventListener("click",u=>{u.preventDefault(),this.close()}),F.addEventListener("click",async u=>{if(u.preventDefault(),this.startKey&&T){let f=v(T.value);f?o[this.startKey]=f:delete o[this.startKey]}if(this.endKey&&S){let f=v(S.value);f?o[this.endKey]=f:delete o[this.endKey]}if(this.durationKey&&b){let f=b.value.trim();if(f==="")delete o[this.durationKey];else{let A=Number(f);Number.isNaN(A)||(o[this.durationKey]=A)}}if(this.dueKey&&P){let f=v(P.value);f?o[this.dueKey]=f:delete o[this.dueKey]}let E=`---
${(0,Tt.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,E),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(f){}if(this.refresh)try{this.refresh()}catch(f){}new Tt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(s,e,t,n){var ye,be,Se,xe,ve,we,Ae,De;let r=(ye=e.options)!=null?ye:{},o=r.background,i=(be=r.drilldown)!=null?be:!0,p=!0,a=d=>{if(d==null)return"";let I=String(d).trim();if(!I)return"";let G=I.match(/^\[\[(.+?)\]\]$/);G&&(I=G[1]);let X=I.lastIndexOf("/");return X>=0&&X<I.length-1&&(I=I.slice(X+1)),I};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(d=>d.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(d=>d.start&&d.end);if(l.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let h=e.encoding,w=h.group,m=h.duration,g=(d,I)=>{if(!d||!I)return;let G=d[I];return Array.isArray(G)?G[0]:G},v=l.map(d=>{var St,ct;let I=d.start,G=d.end,X=d.props,Lt=typeof d.x=="string"?d.x:d.x instanceof Date?Ht(I):String(d.x),At=a(Lt),bt,It=w?g(X,w):void 0;It!=null?bt=String(It):d.series!=null?bt=String(d.series):bt=At;let ft=(St=d.notes)==null?void 0:St[0],Dt=ft?(ct=ft.replace(/\.md$/i,"").split("/").pop())!=null?ct:ft:At,Ct=d.due,Ft,kt=g(X,m);if(kt!=null){let xt=Number(kt);Number.isNaN(xt)||(Ft=xt)}return{row:d,start:I,end:G,props:X,fullName:At,groupKey:bt,notePath:ft,noteTitle:Dt,due:Ct,estMinutes:Ft}}).filter(d=>d.start instanceof Date&&!isNaN(d.start.getTime())&&d.end instanceof Date&&!isNaN(d.end.getTime()));if(v.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}v.sort((d,I)=>{if(d.groupKey<I.groupKey)return-1;if(d.groupKey>I.groupKey)return 1;let G=d.start.getTime(),X=I.start.getTime();return G!==X?G-X:d.fullName.localeCompare(I.fullName)});let T=26,S=0,b=null;for(let d of v)d.groupKey!==b&&(b=d.groupKey,S+=1),S+=1;let P=Math.min(...v.map(d=>d.start.getTime())),R=Math.max(...v.map(d=>d.end.getTime()));if(!isFinite(P)||!isFinite(R)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let F=24*60*60*1e3,$=d=>{let I=new Date(d);return I.setHours(0,0,0,0),I.getTime()},y=$(P),D=$(R),u=s.querySelector(".prop-charts-title-row");u||(u=s.createDiv({cls:"prop-charts-title-row"}));let N=s.dataset.ganttZoomMode||String((Se=r.zoomMode)!=null?Se:"100");s.dataset.ganttZoomMode=N;let E=s.dataset.ganttLabelMode||String((xe=r.labelMode)!=null?xe:"compact");s.dataset.ganttLabelMode=E;let f=u.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(d=>{let I=f.createEl("button",{cls:"gantt-zoom-btn",text:d.label});d.id===N&&I.addClass("is-active"),I.addEventListener("click",G=>{G.preventDefault(),s.dataset.ganttZoomMode=d.id,ne(s,e,t,n)})});let H=Number(r.labelWidth),Z=!Number.isNaN(H)&&H>120?H:260,B=E==="wide"?Z+160:Z,Q=s.getBoundingClientRect().width||600,V=Math.max(Q,820),W;if(N==="fit")W=Q;else{let d=Number(N)/100||1;W=V*d}let{inner:_,svg:c,tooltip:M,details:k}=wt(s,o);_.style.width=W+"px";let C=(d,I,G,X,Lt,At,bt,It,ft)=>{if(!d)return;let Dt=Math.max(40,X-8),Ft=Math.max(8,Math.floor(Dt/6)),kt=d.split(/\s+/),St=[],ct="";for(let Rt of kt){if(!ct){ct=Rt;continue}(ct+" "+Rt).length<=Ft?ct+=" "+Rt:(St.push(ct),ct=Rt)}ct&&St.push(ct);let xt=Lt+2,Gt=St.length*xt,Ut=G-Gt/2+Lt;St.forEach((Rt,Yt)=>{let ot=document.createElementNS(c.namespaceURI,"text");ot.setAttribute("x",String(I)),ot.setAttribute("y",String(Ut+Yt*xt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(Lt)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Rt,bt&&ot.addEventListener("mouseenter",st=>bt(st)),It&&ot.addEventListener("mouseleave",()=>It()),ft&&(ot.style.cursor="pointer",ot.addEventListener("click",st=>ft(st))),c.appendChild(ot)})},L=28,tt=28,O=10,rt=Math.max(300,L+tt+S*T+24);c.setAttribute("height",String(rt));let J=W-B-O,K=L+6;c.style.color="#111111";let z=D+F-y||1,q=y-z*.02,lt=D+F+z*.08,dt=d=>B+(d-q)/(lt-q)*J,yt=(lt-q)/F,j=Math.max(4,Math.min(12,Math.floor(J/90)||4)),Mt=yt/j,at=[1,2,3,5,7,10,14,21,30,60,90,180,365],et=at[at.length-1];for(let d of at)if(d>=Mt){et=d;break}let pt=[],Wt=$(q);for(let d=Wt;d<=lt+.5*F;d+=et*F)pt.push(d);let $t=document.createElementNS(c.namespaceURI,"line");$t.setAttribute("x1",String(B)),$t.setAttribute("y1",String(K)),$t.setAttribute("x2",String(W-O)),$t.setAttribute("y2",String(K)),$t.setAttribute("stroke","#111111"),c.appendChild($t);for(let d of pt){let I=dt(d),G=document.createElementNS(c.namespaceURI,"line");G.setAttribute("x1",String(I)),G.setAttribute("y1",String(K)),G.setAttribute("x2",String(I)),G.setAttribute("y2",String(rt-tt)),G.setAttribute("stroke","#111111"),G.setAttribute("stroke-opacity","0.20"),G.setAttribute("stroke-dasharray","2,4"),c.appendChild(G);let X=document.createElementNS(c.namespaceURI,"text");X.setAttribute("x",String(I)),X.setAttribute("y",String(K-4)),X.setAttribute("text-anchor","middle"),X.setAttribute("font-size","10"),X.setAttribute("fill","#111111"),X.textContent=Ht(new Date(d)),c.appendChild(X)}let he=new Date;he.setHours(0,0,0,0);let ie=he.getTime();if(ie>=q&&ie<=lt){let d=dt(ie),I=document.createElementNS(c.namespaceURI,"line");I.setAttribute("x1",String(d)),I.setAttribute("y1",String(K)),I.setAttribute("x2",String(d)),I.setAttribute("y2",String(rt-tt)),I.setAttribute("stroke","#4caf50"),I.setAttribute("stroke-width","2"),I.setAttribute("stroke-dasharray","4,2"),c.appendChild(I);let G=document.createElementNS(c.namespaceURI,"text");G.setAttribute("x",String(d+4)),G.setAttribute("y",String(K+12)),G.setAttribute("font-size","10"),G.setAttribute("fill","#4caf50"),G.textContent="hoje",c.appendChild(G)}let Ot=_.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",E==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${B}px`,Ot.style.top="4px",Ot.addEventListener("click",d=>{d.preventDefault();let G=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=G,ne(s,e,t,n)});let He=["status","priority"],ae=Array.isArray(r.tooltipFields)?r.tooltipFields.map(d=>String(d)):null,Qe=ae&&ae.length?ae:He,Bt=0,le=null;for(let d of v){let I=d.start,G=d.end,X=(G.getTime()-I.getTime())/6e4,Lt=d.props,At=d.notePath,bt=d.noteTitle,It=(we=(ve=d.row.notes)==null?void 0:ve.length)!=null?we:0,ft=d.due,Dt=d.estMinutes,Ct=[];Ct.push(`${Ht(I)} \u2192 ${Ht(G)}`),typeof Dt=="number"&&!Number.isNaN(Dt)?Ct.push(`est: ${Math.round(Dt)} min`):X>0&&Ct.push(`dura\xE7\xE3o: ${Math.round(X)} min`),ft instanceof Date&&Ct.push(`due: ${Ht(ft)}`);for(let nt of Qe){let Y=g(Lt,nt);Y!=null&&String(Y).trim()!==""&&Ct.push(`${nt}: ${String(Y)}`)}let Ft=Ct.join("<br>"),kt=nt=>{var Y;nt.preventDefault(),p&&At?new fe(At,e,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():ht(s,k,bt,Dt!=null?Dt:X,(Y=d.row.notes)!=null?Y:[],i)},St=nt=>{bt&&Ft&&gt(s,M,bt,Ft,It,nt)},ct=()=>mt(M);if(d.groupKey!==le){le=d.groupKey;let nt=K+8+Bt*T+T/2,Y=a(le);C(Y,4,nt,B-12,11,"600"),Bt+=1}let xt=K+8+Bt*T,Gt=T-10,Ut=dt(I.getTime()),Rt=dt(G.getTime()),Yt=Math.max(4,Rt-Ut),ot=d.fullName,st=document.createElementNS(c.namespaceURI,"rect");st.setAttribute("x",String(Ut)),st.setAttribute("y",String(xt)),st.setAttribute("width",String(Yt)),st.setAttribute("height",String(Gt)),st.setAttribute("rx","3"),st.setAttribute("ry","3"),st.setAttribute("fill",it((Ae=d.row.series)!=null?Ae:ot,Bt)),st.setAttribute("stroke","rgba(0,0,0,0.25)"),st.setAttribute("stroke-width","0.5"),st.style.cursor=p&&At?"pointer":"default",st.addEventListener("mouseenter",St),st.addEventListener("mouseleave",ct),st.addEventListener("click",kt),c.appendChild(st);let Ee=xt+Gt/2;if(Yt>=6){let nt=it((De=d.row.series)!=null?De:ot,Bt),Y=document.createElementNS(c.namespaceURI,"circle");Y.setAttribute("cx",String(Ut)),Y.setAttribute("cy",String(Ee)),Y.setAttribute("r","3.5"),Y.setAttribute("fill","#ffffff"),Y.setAttribute("stroke",nt),Y.setAttribute("stroke-width","1.5"),c.appendChild(Y);let Pt=document.createElementNS(c.namespaceURI,"circle");Pt.setAttribute("cx",String(Rt)),Pt.setAttribute("cy",String(Ee)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),c.appendChild(Pt)}let Te=xt+Gt/2+2,Xt=w?16:4;if(E==="wide")C(ot,Xt,Te,B-Xt-4,11,null,St,ct,kt);else{let nt=ot,Y=Math.max(40,B-Xt-8),Ce=Math.max(8,Math.floor(Y/6));nt.length>Ce&&(nt=nt.slice(0,Ce-1)+"\u2026");let vt=document.createElementNS(c.namespaceURI,"text");vt.setAttribute("x",String(Xt)),vt.setAttribute("y",String(Te)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",St),vt.addEventListener("mouseleave",ct),vt.addEventListener("click",kt),c.appendChild(vt)}if(ft instanceof Date){let nt=dt(ft.getTime()),Y=document.createElementNS(c.namespaceURI,"line");Y.setAttribute("x1",String(nt)),Y.setAttribute("y1",String(xt)),Y.setAttribute("x2",String(nt)),Y.setAttribute("y2",String(xt+Gt)),Y.setAttribute("stroke","#ff6b6b"),Y.setAttribute("stroke-width","2"),Y.setAttribute("stroke-dasharray","4,2"),c.appendChild(Y)}Bt+=1}if(p){let d=s.createDiv({cls:"prop-charts-empty"});d.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function ge(s,e,t){var Q,V,W,_;let n=(Q=e.options)!=null?Q:{},r=n.background,o=(V=n.drilldown)!=null?V:!0,i=(W=t.rows)!=null?W:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:h}=wt(s,r),w=s.getBoundingClientRect().width||600,m=Math.max(w,480);p.style.width=m+"px";let g=40,x=16,v=18,T=28,S=300;a.setAttribute("height",String(S));let b=m-g-x,P=S-v-T,R=new Map;for(let c of i){let M=String(c.x),k=(_=R.get(M))!=null?_:{label:c.x,rows:[]};k.rows.push(c),R.set(M,k)}let $=Array.from(R.keys()).sort((c,M)=>c<M?-1:c>M?1:0).map(c=>R.get(c)),y=$.length,D=new Set;i.forEach(c=>{c.series!=null&&D.add(String(c.series))});let u=Array.from(D),N=u.length>1,E=N?"grouped":"single",f=0;i.forEach(c=>{c.y>f&&(f=c.y)}),(!isFinite(f)||f<=0)&&(f=1);let A=c=>v+P-c/(f||1)*P,H=A(0),Z=4;for(let c=0;c<=Z;c++){let M=f*c/Z,k=A(M),C=document.createElementNS(a.namespaceURI,"line");C.setAttribute("x1",String(g)),C.setAttribute("y1",String(k)),C.setAttribute("x2",String(m-x)),C.setAttribute("y2",String(k)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),a.appendChild(C);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(g-4)),L.setAttribute("y",String(k+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(M)),a.appendChild(L)}let B=y>0?b/y:b;if($.forEach((c,M)=>{let k=g+B*(M+.5),C=String(c.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(k)),L.setAttribute("y",String(S-T+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=C,a.appendChild(L)}),N){let c=s.createDiv({cls:"chart-notes-legend"});u.forEach((M,k)=>{let C=c.createDiv({cls:"chart-notes-legend-item"}),L=C.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=it(M,k),C.createSpan({text:M})})}$.forEach((c,M)=>{let k=g+B*(M+.5),C=c.rows;if(E==="single"){let J=C[0],K=J.y,z=B*.6,q=k-z/2,lt=A(K),dt=Math.max(2,H-lt),yt=it("bar",M),U=document.createElementNS(a.namespaceURI,"rect");U.setAttribute("x",String(q)),U.setAttribute("y",String(lt)),U.setAttribute("width",String(z)),U.setAttribute("height",String(dt)),U.setAttribute("fill",yt),U.setAttribute("stroke","rgba(0,0,0,0.25)"),U.setAttribute("stroke-width","0.5"),U.style.cursor="pointer";let j=String(c.label),Mt=`valor: ${Math.round(K*100)/100}`;U.addEventListener("mouseenter",at=>{var et,pt;return gt(s,l,j,Mt,(pt=(et=J.notes)==null?void 0:et.length)!=null?pt:0,at)}),U.addEventListener("mouseleave",()=>mt(l)),U.addEventListener("click",at=>{var et;at.preventDefault(),ht(s,h,j,K,(et=J.notes)!=null?et:[],o)}),a.appendChild(U);return}let L=u.length,tt=B/Math.max(L+1,2),O=L*tt,rt=k-O/2;u.forEach((J,K)=>{let z=C.find(et=>(et.series!=null?String(et.series):"")===J);if(!z)return;let q=z.y,lt=rt+K*tt,dt=A(q),yt=Math.max(2,H-dt),U=it(J,K),j=document.createElementNS(a.namespaceURI,"rect");j.setAttribute("x",String(lt)),j.setAttribute("y",String(dt)),j.setAttribute("width",String(tt)),j.setAttribute("height",String(yt)),j.setAttribute("fill",U),j.setAttribute("stroke","rgba(0,0,0,0.25)"),j.setAttribute("stroke-width","0.5"),j.style.cursor="pointer";let Mt=`${J} @ ${String(c.label)}`,at=`valor: ${Math.round(q*100)/100}`;j.addEventListener("mouseenter",et=>{var pt,Wt;return gt(s,l,Mt,at,(Wt=(pt=z.notes)==null?void 0:pt.length)!=null?Wt:0,et)}),j.addEventListener("mouseleave",()=>mt(l)),j.addEventListener("click",et=>{var pt;et.preventDefault(),ht(s,h,Mt,q,(pt=z.notes)!=null?pt:[],o)}),a.appendChild(j)})})}function $e(s,e,t){var B,Q,V,W;let n=(B=e.options)!=null?B:{},r=n.background,o=(Q=n.drilldown)!=null?Q:!0,i=(V=t.rows)!=null?V:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:h}=wt(s,r),w=s.getBoundingClientRect().width||600,m=Math.max(w,480);p.style.width=m+"px";let g=40,x=16,v=18,T=28,S=300;a.setAttribute("height",String(S));let b=m-g-x,P=S-v-T,R=new Map;for(let _ of i){let c=String(_.x),M=(W=R.get(c))!=null?W:{label:_.x,rows:[]};M.rows.push(_),R.set(c,M)}let $=Array.from(R.keys()).sort((_,c)=>_<c?-1:_>c?1:0).map(_=>R.get(_)),y=$.length,D=new Set;i.forEach(_=>{_.series!=null&&D.add(String(_.series))});let u=Array.from(D);if(!u.length){ge(s,e,t);return}let N=0;$.forEach(_=>{let c=_.rows.reduce((M,k)=>M+k.y,0);c>N&&(N=c)}),(!isFinite(N)||N<=0)&&(N=1);let E=_=>v+P-_/(N||1)*P,f=E(0),A=4;for(let _=0;_<=A;_++){let c=N*_/A,M=E(c),k=document.createElementNS(a.namespaceURI,"line");k.setAttribute("x1",String(g)),k.setAttribute("y1",String(M)),k.setAttribute("x2",String(m-x)),k.setAttribute("y2",String(M)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),a.appendChild(k);let C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(g-4)),C.setAttribute("y",String(M+3)),C.setAttribute("text-anchor","end"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=String(Math.round(c)),a.appendChild(C)}let H=y>0?b/y:b;$.forEach((_,c)=>{let M=g+H*(c+.5),k=String(_.label),C=document.createElementNS(a.namespaceURI,"text");C.setAttribute("x",String(M)),C.setAttribute("y",String(S-T+12)),C.setAttribute("text-anchor","middle"),C.setAttribute("font-size","10"),C.setAttribute("fill","#111111"),C.textContent=k,a.appendChild(C)});let Z=s.createDiv({cls:"chart-notes-legend"});u.forEach((_,c)=>{let M=Z.createDiv({cls:"chart-notes-legend-item"}),k=M.createDiv();k.style.width="10px",k.style.height="10px",k.style.borderRadius="999px",k.style.backgroundColor=it(_,c),M.createSpan({text:_})}),$.forEach((_,c)=>{let M=g+H*(c+.5),k=H*.6,C=M-k/2,L=0;u.forEach((tt,O)=>{let rt=_.rows.find(at=>(at.series!=null?String(at.series):"")===tt);if(!rt)return;let J=rt.y,K=L,z=L+J;L=z;let q=E(K),lt=E(z),dt=Math.max(2,q-lt),yt=it(tt,O),U=document.createElementNS(a.namespaceURI,"rect");U.setAttribute("x",String(C)),U.setAttribute("y",String(lt)),U.setAttribute("width",String(k)),U.setAttribute("height",String(dt)),U.setAttribute("fill",yt),U.setAttribute("stroke","rgba(0,0,0,0.25)"),U.setAttribute("stroke-width","0.5"),U.style.cursor="pointer";let j=`${tt} @ ${String(_.label)}`,Mt=`valor: ${Math.round(J*100)/100}`;U.addEventListener("mouseenter",at=>{var et,pt;return gt(s,l,j,Mt,(pt=(et=rt.notes)==null?void 0:et.length)!=null?pt:0,at)}),U.addEventListener("mouseleave",()=>mt(l)),U.addEventListener("click",at=>{var et;at.preventDefault(),ht(s,h,j,J,(et=rt.notes)!=null?et:[],o)}),a.appendChild(U)})})}function me(s,e,t,n){var Q,V,W,_;let r=(Q=e.options)!=null?Q:{},o=r.background,i=(V=r.drilldown)!=null?V:!0,p=(W=t.rows)!=null?W:[];if(!p.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:h,details:w}=wt(s,o),m=s.getBoundingClientRect().width||600,g=Math.max(m,480);a.style.width=g+"px";let x=40,v=16,T=18,S=24,b=300;l.setAttribute("height",String(b));let P=g-x-v,R=b-T-S,F=new Map;for(let c of p){let M=c.series!=null?String(c.series):"__default__",k=(_=F.get(M))!=null?_:[];k.push(c),F.set(M,k)}let $=Array.from(F.keys()),y=[],D=new Set;for(let c of p){let M=String(c.x);D.has(M)||(D.add(M),y.push(c.x))}let u=y.length||1,N=c=>{let M=String(c),k=y.findIndex(C=>String(C)===M);return k<0?x:u===1?x+P/2:x+k/(u-1)*P},E=c=>String(c),f=Number.POSITIVE_INFINITY,A=Number.NEGATIVE_INFINITY;for(let c of p)c.y<f&&(f=c.y),c.y>A&&(A=c.y);(!isFinite(f)||!isFinite(A))&&(f=0,A=1),f===A&&(f===0?A=1:f=0);let H=c=>T+R-(c-f)/(A-f||1)*R,Z=4;for(let c=0;c<=Z;c++){let M=f+(A-f)*c/Z,k=H(M),C=document.createElementNS(l.namespaceURI,"line");C.setAttribute("x1",String(x)),C.setAttribute("y1",String(k)),C.setAttribute("x2",String(g-v)),C.setAttribute("y2",String(k)),C.setAttribute("stroke","#cccccc"),C.setAttribute("stroke-opacity","0.25"),l.appendChild(C);let L=document.createElementNS(l.namespaceURI,"text");L.setAttribute("x",String(x-4)),L.setAttribute("y",String(k+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=Math.abs(M)>=100?String(Math.round(M)):String(Math.round(M*10)/10),l.appendChild(L)}let B=$.filter(c=>c!=="__default__");if(B.length>1){let c=s.createDiv({cls:"chart-notes-legend"});B.forEach((M,k)=>{let C=M,L=c.createDiv({cls:"chart-notes-legend-item"}),tt=L.createDiv();tt.style.width="10px",tt.style.height="10px",tt.style.borderRadius="999px",tt.style.backgroundColor=it(C,k),L.createSpan({text:C})})}$.forEach((c,M)=>{let k=F.get(c);if(!(k!=null&&k.length))return;let C=c==="__default__"?it("line",M):it(c,M),L=[...k].sort((O,rt)=>{let J=y.findIndex(z=>String(z)===String(O.x)),K=y.findIndex(z=>String(z)===String(rt.x));return J-K}),tt="";if(L.forEach((O,rt)=>{let J=N(O.x),K=H(O.y);tt+=(rt===0?"M ":" L ")+J+" "+K}),n){let O=L[0],rt=L[L.length-1],J=N(O.x),K=N(rt.x),z=H(f);tt+=` L ${K} ${z} L ${J} ${z} Z`;let q=document.createElementNS(l.namespaceURI,"path");q.setAttribute("d",tt),q.setAttribute("fill",C),q.setAttribute("fill-opacity","0.18"),q.setAttribute("stroke",C),q.setAttribute("stroke-width","1.5"),l.appendChild(q)}else{let O=document.createElementNS(l.namespaceURI,"path");O.setAttribute("d",tt),O.setAttribute("fill","none"),O.setAttribute("stroke",C),O.setAttribute("stroke-width","2"),l.appendChild(O)}L.forEach(O=>{let rt=N(O.x),J=H(O.y),K=document.createElementNS(l.namespaceURI,"circle");K.setAttribute("cx",String(rt)),K.setAttribute("cy",String(J)),K.setAttribute("r","3"),K.setAttribute("fill","#ffffff"),K.setAttribute("stroke",C),K.setAttribute("stroke-width","1.5"),K.style.cursor="pointer";let z=E(O.x),q=c==="__default__"?"":String(O.series),lt=q?`${q} @ ${z}`:z,dt=`valor: ${Math.round(O.y*100)/100}`;K.addEventListener("mouseenter",yt=>{var U,j;return gt(s,h,lt,dt,(j=(U=O.notes)==null?void 0:U.length)!=null?j:0,yt)}),K.addEventListener("mouseleave",()=>mt(h)),K.addEventListener("click",yt=>{var U;yt.preventDefault(),ht(s,w,lt,O.y,(U=O.notes)!=null?U:[],i)}),l.appendChild(K)})})}function Be(s,e,t){var P;let{background:n,drilldown:r=!0}=(P=e.options)!=null?P:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=_e(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:h}=wt(s,n),w=Math.max(i,420);p.style.width=w+"px",o&&(a.style.color=o);let m=300,g=w/2,x=(m-28+28)/2,v=Math.min(w/2-20,m/2-20),S=t.rows.map(R=>Math.max(0,R.y)).reduce((R,F)=>R+F,0)||1,b=-Math.PI/2;t.rows.forEach((R,F)=>{var B;let $=R.x instanceof Date?R.x.toISOString().slice(0,10):String(R.x),y=R.y,D=y/S*Math.PI*2,u=g+v*Math.cos(b),N=x+v*Math.sin(b),E=g+v*Math.cos(b+D),f=x+v*Math.sin(b+D),A=D>Math.PI?1:0,H=document.createElementNS(a.namespaceURI,"path"),Z=[`M ${g} ${x}`,`L ${u} ${N}`,`A ${v} ${v} 0 ${A} 1 ${E} ${f}`,"Z"].join(" ");H.setAttribute("d",Z),H.setAttribute("fill",it((B=R.series)!=null?B:$,F)),H.style.cursor="pointer",H.addEventListener("mouseenter",Q=>{var V,W;return gt(s,l,$,y,(W=(V=R.notes)==null?void 0:V.length)!=null?W:0,Q)}),H.addEventListener("mouseleave",()=>mt(l)),H.addEventListener("click",()=>{var Q;return ht(s,h,$,y,(Q=R.notes)!=null?Q:[],r)}),a.appendChild(H),b+=D})}function Ge(s,e,t){var N;let{background:n,drilldown:r=!0}=(N=e.options)!=null?N:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:h}=wt(s,n),w=Math.max(i,700);p.style.width=w+"px",o&&(a.style.color=o);let m=300,g=w-48-10,x=m-28-28,v=t.rows.map(E=>{let f=E.x;if(f instanceof Date)return f.getTime();if(typeof f=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(f)){let H=new Date(f);if(!isNaN(H.getTime()))return H.getTime()}let A=Number(f);return isNaN(A)?null:A}return typeof f=="number"?f:null}),T=t.rows.map(E=>E.y),S=v.filter(E=>E!==null);if(S.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let b=Math.min(...S),P=Math.max(...S),R=Math.min(...T),F=Math.max(...T),$=E=>48+(E-b)/(P-b||1)*g,y=E=>m-28-(E-R)/(F-R||1)*x,D=document.createElementNS(a.namespaceURI,"line");D.setAttribute("x1",String(48)),D.setAttribute("y1",String(28)),D.setAttribute("x2",String(48)),D.setAttribute("y2",String(m-28)),D.setAttribute("stroke","currentColor"),a.appendChild(D);let u=document.createElementNS(a.namespaceURI,"line");u.setAttribute("x1",String(48)),u.setAttribute("y1",String(m-28)),u.setAttribute("x2",String(w-10)),u.setAttribute("y2",String(m-28)),u.setAttribute("stroke","currentColor"),a.appendChild(u),t.rows.forEach((E,f)=>{let A=v[f];if(A==null)return;let H=$(A),Z=y(T[f]),B=document.createElementNS(a.namespaceURI,"circle");B.setAttribute("cx",String(H)),B.setAttribute("cy",String(Z)),B.setAttribute("r","4"),B.setAttribute("fill",it(E.series,f)),B.style.cursor="pointer";let Q=E.x instanceof Date?E.x.toISOString().slice(0,10):typeof E.x=="string"?E.x:String(E.x);B.addEventListener("mouseenter",V=>{var W,_;return gt(s,l,Q,E.y,(_=(W=E.notes)==null?void 0:W.length)!=null?_:0,V)}),B.addEventListener("mouseleave",()=>mt(l)),B.addEventListener("click",V=>{var W;V.preventDefault(),ht(s,h,Q,E.y,(W=E.notes)!=null?W:[],r)}),a.appendChild(B)})}var se=class{render(e,t,n,r){var a;let{title:o}=(a=t.options)!=null?a:{};e.empty(),e.addClass("prop-charts-container");let p=e.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(o&&(p.textContent=o),t.type){case"bar":ge(e,t,n);break;case"stacked-bar":$e(e,t,n);break;case"line":me(e,t,n,!1);break;case"area":me(e,t,n,!0);break;case"pie":Be(e,t,n);break;case"scatter":Ge(e,t,n);break;case"gantt":ne(e,t,n,r);break;default:e.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}}};var oe=class extends Kt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("Chart Notes: loading plugin (Bases-only)"),this.indexer=new Zt(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Kt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Kt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Kt.TFile&&this.indexer.removeFile(t)})),this.registerBasesView(ue,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new qt(t,n,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},n={type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",shouldHide:S=>{var b;return String((b=S.get("chartType"))!=null?b:"bar")==="gantt"}},r={type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:"Texto mostrado em cada tarefa. Se vazio, usa o nome da nota.",shouldHide:S=>{var b;return String((b=S.get("chartType"))!=null?b:"bar")!=="gantt"}},o={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:S=>{var P;let b=String((P=S.get("chartType"))!=null?P:"bar");return b==="pie"||b==="gantt"}},i={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:S=>{var b;return String((b=S.get("chartType"))!=null?b:"bar")==="pie"}},p={type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum (line/area only)"},shouldHide:S=>{var P;let b=String((P=S.get("chartType"))!=null?P:"bar");return b!=="line"&&b!=="area"}},a={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (keep date/time)",none:"None (raw)",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:S=>{var P;let b=String((P=S.get("chartType"))!=null?P:"bar");return b==="pie"||b==="scatter"||b==="gantt"}},l=(S,b,P)=>({type:"property",key:S,displayName:b,description:P,shouldHide:R=>{var F;return String((F=R.get("chartType"))!=null?F:"")!=="gantt"}}),h=l("startProperty","Start (Gantt)","Data/hora de in\xEDcio. Se faltar, tentamos inferir via fim + dura\xE7\xE3o."),w=l("endProperty","End (Gantt)","Data/hora de fim da barra (geralmente 'scheduled' ou 'finish')."),m=l("dueProperty","Due (deadline, optional)","Deadline. Usado como fallback quando h\xE1 due + dura\xE7\xE3o, e mostrado no tooltip."),g=l("durationProperty","Duration in minutes (optional)","Estimativa em minutos. Usada para inferir start/end quando s\xF3 um dos lados existe."),x=l("groupProperty","Group / lane (optional)","Projeto/\xE1rea usada como lane no lado esquerdo do Gantt.");return[t,n,r,o,i,p,a,h,w,m,g,x,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
