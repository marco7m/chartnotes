/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var We=Object.prototype.hasOwnProperty;var Oe=(s,e)=>{for(var t in e)ce(s,t,{get:e[t],enumerable:!0})},Ye=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ve(e))!We.call(s,r)&&r!==t&&ce(s,r,{get:()=>e[r],enumerable:!(n=Ue(e,r))||n.enumerable});return s};var Xe=s=>Ye(ce({},"__esModule",{value:!0}),s);var pn={};Oe(pn,{default:()=>oe});module.exports=Xe(pn);var Kt=require("obsidian");var jt=require("obsidian"),ue="chartnotes-view",ze=["bar","stacked-bar","line","area","pie","scatter","gantt"];function qe(s){let e=String(s!=null?s:"bar").trim().toLowerCase();return ze.includes(e)?e:"bar"}var je=["sum","count","cumulative-sum"];function Ze(s){let e=String(s!=null?s:"sum").trim().toLowerCase();return je.includes(e)?e:"sum"}var Je=["auto","none","day","week","month","quarter","year"];function tn(s){let e=String(s!=null?s:"auto").trim().toLowerCase();return Je.includes(e)?e:"auto"}var zt="(missing)",qt=class extends jt.BasesView{constructor(t,n,r){super(t);this.type=ue;this.renderer=r,this.rootEl=n.createDiv("chartnotes-bases-view")}onDataUpdated(){var O,X,F;this.rootEl.empty();let t=this.data,n=(O=t==null?void 0:t.groupedData)!=null?O:[];if(!n.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,o=qe((X=r==null?void 0:r.get("chartType"))!=null?X:"bar"),i=o==="pie",d=o==="scatter",a=o==="gantt",l=Ze(r==null?void 0:r.get("aggregateMode")),w=l==="cumulative-sum"&&!(o==="line"||o==="area")?"sum":l,m=tn(r==null?void 0:r.get("xBucket")),y=i||d||a?"none":m,h=this.getPropFromConfig("xProperty"),D=this.getPropFromConfig("ganttLabelProperty"),k=this.getPropFromConfig("yProperty"),S=this.getPropFromConfig("seriesProperty");i&&(S={id:null,name:null});let g=this.getPropFromConfig("startProperty"),E=this.getPropFromConfig("endProperty"),P=this.getPropFromConfig("dueProperty"),G=this.getPropFromConfig("scheduledProperty"),Q=this.getPropFromConfig("durationProperty"),v=this.getPropFromConfig("groupProperty");if(!a&&!h.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(d&&(!h.id||!k.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(g.id||E.id||G.id||P.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Scheduled/Due with Duration."});return}let C=a&&D.id?D:a?h:{id:null,name:null},c;if(a)c=this.buildRowsForGantt(n,C,S,g,E,P,G,Q,v);else if(d)c=this.buildRowsForScatter(n,h,k,S);else{let p=i;c=this.buildRowsForAggregatedCharts(n,h,k,S,w,y,p)}if(!c.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let T={rows:c},x=((F=r==null?void 0:r.get("title"))!=null?F:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",I=r==null?void 0:r.get("drilldown"),B=typeof I=="boolean"?I:!0,V=this.buildEncoding({x:h,y:k,series:S,start:g,end:E,due:P,duration:Q,group:v,label:C,aggMode:w,xBucket:y,chartType:o}),R={type:o,source:{type:"properties",query:""},encoding:V,options:{title:x,drilldown:B}},A={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,R,T,A)}getPropFromConfig(t){var d,a;let n=this.config,r=(d=n==null?void 0:n.get)==null?void 0:d.call(n,t);if(!r)return{id:null,name:null};let o=r.trim();if(!o||o==="undefined"||o==="null")return{id:null,name:null};let i=o;try{let l=(0,jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,n){if(!n.id)return null;let r;try{r=t.getValue(n.id)}catch(o){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(o){}try{let o=r.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let n=new Date(t.trim());return Number.isNaN(n.getTime())?null:n}compareX(t,n){let r=this.parseDate(t!=null?String(t):null),o=this.parseDate(n!=null?String(n):null);if(r&&o)return r.getTime()-o.getTime();let i=Number(t),d=Number(n);return!Number.isNaN(i)&&!Number.isNaN(d)?i-d:String(t!=null?t:"").localeCompare(String(n!=null?n:""))}fmtDate(t){let n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${o}`}startOfWeek(t){let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(n.getDay()+6)%7;return n.setDate(n.getDate()-r),n.setHours(0,0,0,0),n}bucketX(t,n){let r=this.parseDate(t);if(!r)return t;switch(n){case"none":return t;case"auto":case"day":return this.fmtDate(new Date(r.getFullYear(),r.getMonth(),r.getDate()));case"week":{let o=this.startOfWeek(r);return`${this.fmtDate(o)} (W)`}case"month":{let o=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${o}`}case"quarter":{let o=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${o}`}case"year":return`${r.getFullYear()}`;default:return t}}getXValuesForEntry(t,n,r,o){var b,w;let i=[],d=m=>this.bucketX(m,r);if(!n.id){let m=t.file,y=m!=null&&m.name?String(m.name):String((b=m==null?void 0:m.path)!=null?b:zt);return i.push(d(y)),i}if(!o){let m=(w=this.readValue(t,n))!=null?w:zt;return i.push(d(m)),i}let a=null;try{a=t.getValue(n.id)}catch(m){a=null}let l=m=>{if(!m)return;let y=String(m).trim();y&&i.push(d(y))};if(a==null)l(zt);else if(typeof a=="string"){let m=a.trim();if(m){let y=m.split(/\s+/);for(let h of y)l(h)}}else if(Array.isArray(a))for(let m of a){if(m==null)continue;let y;try{y=m.toString()}catch(h){continue}l(y)}else if(typeof a.toArray=="function"){let m=a.toArray();if(Array.isArray(m))for(let y of m){if(y==null)continue;let h;try{h=y.toString()}catch(D){continue}l(h)}else{let y;try{y=a.toString()}catch(h){y=""}l(y)}}else{let m;try{m=a.toString()}catch(y){m=""}l(m)}return i.length||l(zt),i}buildRowsForAggregatedCharts(t,n,r,o,i,d,a){let l=new Map,b=a||i==="count"||!r.id&&i!=="sum",w=r.name||"y";for(let y of t)for(let h of y.entries){let D=h.file,k=this.getXValuesForEntry(h,n,d,a),S=1,g=null;if(!b&&r.id){if(g=this.readValue(h,r),g==null)continue;let G=Number(g);if(Number.isNaN(G))continue;S=G}else S=1;let E=this.readValue(h,o),P=E!=null?String(E):void 0;for(let G of k){let Q=`${G}@@${P!=null?P:""}`,v=l.get(Q);v||(v={x:G,y:0,series:P,notes:[],props:{}},l.set(Q,v)),v.y+=S,D!=null&&D.path&&v.notes.push(D.path),v.props&&n.name&&(v.props[n.name]=G),!b&&v.props&&w&&g!=null&&(v.props[w]=v.y),b&&v.props&&(v.props[w]=v.y),v.props&&o.name&&E!=null&&(v.props[o.name]=E)}}let m=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(m):m}toCumulative(t){var o,i;let n=new Map;for(let d of t){let a=(o=d.series)!=null?o:"__no_series__",l=n.get(a);l||(l=[],n.set(a,l)),l.push(d)}let r=[];for(let[,d]of n){let a=[...d].sort((b,w)=>this.compareX(b.x,w.x)),l=0;for(let b of a){let w=Number((i=b.y)!=null?i:0);Number.isNaN(w)||(l+=w,r.push({...b,y:l}))}}return r}buildRowsForScatter(t,n,r,o){let i=[];for(let d of t)for(let a of d.entries){let l=a.file,b=this.readValue(a,n),w=this.readValue(a,r);if(b==null||w==null)continue;let m=Number(b),y=Number(w);if(Number.isNaN(m)||Number.isNaN(y))continue;let h=this.readValue(a,o),D=h!=null?String(h):void 0;i.push({x:m,y,series:D,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,n,r,o,i,d,a,l,b){var D,k;let w=[],h=n;try{let S=this.getPropFromConfig("ganttLabelProperty");S&&S.id&&(h=S)}catch(S){}for(let S of t)for(let g of S.entries){let E=g.file,P=this.readValue(g,o),G=this.readValue(g,i),Q=this.readValue(g,d),v=this.readValue(g,a),C=this.readValue(g,l),c=C!=null?Number(C):NaN,T=Number.isFinite(c)&&c>0,N=T?c*6e4:36e5,x=this.parseDate(P),I=this.parseDate(G),B=this.parseDate(Q),V=this.parseDate(v),R=x,A=I;if(R&&A||(!R&&!A&&V&&(T?(A=V,R=new Date(V.getTime()-N)):(R=V,A=new Date(V.getTime()+36e5))),(!R||!A)&&!V&&B&&(T?(A=B,R=new Date(B.getTime()-N)):!R&&!A&&(R=B,A=new Date(B.getTime()+36e5))),(!R||!A)&&x&&T&&!I&&(R=x,A=new Date(x.getTime()+N)),(!R||!A)&&I&&T&&!x&&(A=I,R=new Date(I.getTime()-N)),R&&!A&&!T&&(A=new Date(R.getTime()+36e5)),!R&&A&&!T&&(R=new Date(A.getTime()-36e5))),!R||!A)continue;if(R.getTime()>A.getTime()){let M=R;R=A,A=M}let O=(k=this.readValue(g,h))!=null?k:E!=null&&E.name?String(E.name).replace(/\.md$/i,""):String((D=E==null?void 0:E.path)!=null?D:""),X=this.readValue(g,r),F=X!=null?String(X):void 0,p=this.readValue(g,b),f={};h.name&&(f[h.name]=O),f.label=O,o.name&&R&&(f[o.name]=R),i.name&&A&&(f[i.name]=A),d.name&&B&&(f[d.name]=B),a.name&&V&&(f[a.name]=V),T&&l.name&&(f[l.name]=c),b.name&&p!=null&&(f[b.name]=p),w.push({x:O,y:0,series:F,start:R,end:A,due:B!=null?B:void 0,notes:E!=null&&E.path?[E.path]:[],props:f})}return w.sort((S,g)=>!S.start||!g.start?0:S.start.getTime()-g.start.getTime()),w}buildEncoding(t){var i,d,a,l,b,w,m,y,h,D,k;let n=(i=t.x.name)!=null?i:"x",r=(d=t.y.name)!=null?d:"y",o=(b=(l=(a=t.label.name)!=null?a:t.x.name)!=null?l:t.group.name)!=null?b:"label";return{x:n,y:r,series:(w=t.series.name)!=null?w:"series",start:(m=t.start.name)!=null?m:"start",end:(y=t.end.name)!=null?y:"end",due:(h=t.due.name)!=null?h:"due",duration:(D=t.duration.name)!=null?D:"duration",group:(k=t.group.name)!=null?k:"group",label:o}}};var Re=require("obsidian"),Zt=class{constructor(e){this.index=new Map;this.app=e}async buildIndex(){this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let t of e)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(e){if(e.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(e)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Re.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[d,a]of Object.entries(i))d!=="position"&&(t[d]=a)}let o=this.app.metadataCache.getFileCache(e);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(n){console.error("Chart Notes: erro ao indexar",e.path,n)}this.index.set(e.path,{path:e.path,props:t})}removeFile(e){this.index.delete(e.path)}};function ke(s,e){if(!e||e.length===0)return!0;for(let t of e){if(t===".")return!0;let n=t.endsWith("/")?t:t+"/";if(s===t||s.startsWith(n))return!0}return!1}function Pe(s,e){if(!e||e.length===0)return!0;let t=s.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of e)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let n=String(t);for(let r of e)if(n===r||n==="#"+r)return!0;return!1}function te(s){return typeof s!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(s)}function _t(s){if(s instanceof Date)return s;if(typeof s!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(s)){let[t,n,r]=s.split("-");return new Date(Number(t),Number(n)-1,Number(r),0,0,0,0)}let e=new Date(s);return isNaN(e.getTime())?null:e}function ut(s){let e=new Date(s);return e.setHours(0,0,0,0),e}function Jt(s,e){let t=new Date(s);return t.setDate(t.getDate()-e),t}function en(s,e){return Jt(s,e*7)}function nn(s,e){let t=new Date(s);return t.setMonth(t.getMonth()-e),t}function pe(s,e){let t=new Date(s);return t.setDate(t.getDate()+e),t}function rn(s,e){return pe(s,e*7)}function sn(s,e){let t=new Date(s);return t.setMonth(t.getMonth()+e),t}function Ne(s){let e=s.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(e)||e.endsWith("date")||e.endsWith("at")||e.endsWith("on"))}function Me(s,e){let t=e?new Date(e):new Date,n=ut(t),r=s.trim().toLowerCase();if(r==="today")return n;if(r==="yesterday")return ut(Jt(n,1));if(/^-\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(Jt(n,o))}if(/^-\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(Jt(n,o))}if(/^-\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(en(n,o))}if(/^-\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(nn(n,o))}if(/^\+\d+$/.test(r)){let o=parseInt(r.slice(1),10);return ut(pe(n,o))}if(/^\+\d+d$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(pe(n,o))}if(/^\+\d+w$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(rn(n,o))}if(/^\+\d+m$/.test(r)){let o=parseInt(r.slice(1,-1),10);return ut(sn(n,o))}return null}function Le(s){let e=s.trim(),t=e.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let b=t[1].trim(),w=t[2].trim(),m=t[3].trim(),y=Ne(b),h=de(w,y),D=de(m,y),k=h.valueType==="date"||D.valueType==="date"?"date":h.valueType;return{field:b,op:"between",value:h.value,value2:D.value,valueType:k}}let n=/(==|!=|>=|<=|>|<)/,r=e.split(n);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+s);let o=r[0].trim(),i=r[1].trim(),d=r[2].trim(),a=Ne(o),l=de(d,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function de(s,e){let t=s.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let n=t.toLowerCase(),r=n==="today"||n==="yesterday"||n.startsWith("-")||n.startsWith("+");if(e){if(t==="0"||n==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(te(t)){let i=_t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ie(s,e){let t=s[e.field];if(t==null)return!1;if(e.valueType==="date"){let o=t instanceof Date?ut(t):te(t)?ut(_t(t)):null;if(!o)return!1;let i=e.value instanceof Date?e.value:null,d=e.value2 instanceof Date?e.value2:null;if(!i)return!1;let a=o.getTime(),l=ut(i).getTime();switch(e.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!d)return!1;let b=ut(d).getTime();return a>=l&&a<=b}}if(e.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(e.value);switch(e.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof e.value2!="number"?!1:o>=i&&o<=e.value2}}let n=String(t),r=String(e.value);switch(e.op){case"==":return n===r;case"!=":return n!==r;case">":return n>r;case">=":return n>=r;case"<":return n<r;case"<=":return n<=r;case"between":return!1}}function on(s){if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}/.test(s))return{key:s.slice(0,10),isDate:!0};if(te(s)){let e=_t(s);if(e)return{key:e,isDate:!0}}return{key:s,isDate:!1}}function an(s,e){let t=s.x,n=e.x;if(t instanceof Date&&n instanceof Date)return t.getTime()-n.getTime();let r=String(t),o=String(n);return r<o?-1:r>o?1:0}function ln(s,e){var o,i;let t=an(s,e);if(t!==0)return t;let n=(o=s.series)!=null?o:"",r=(i=e.series)!=null?i:"";return n<r?-1:n>r?1:0}function cn(s){if(s==null)return 0;if(typeof s=="number")return s>0?Math.floor(s):0;if(typeof s=="string"){let e=s.trim().match(/^(\d+)/);if(e){let t=Number(e[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(s)}`)}function un(s){var n,r;let e=new Map,t=[];for(let o of s){let i=(n=o.series)!=null?n:"__no_series__",a=((r=e.get(i))!=null?r:0)+o.y;e.set(i,a),t.push({...o,y:a})}return t}function dn(s,e){var i,d;let t=cn(e);if(!t||t<=1)return[...s];let n=new Map,r=new Map,o=[];for(let a of s){let l=(i=a.series)!=null?i:"__no_series__",b=n.get(l);b||(b=[],n.set(l,b));let w=(d=r.get(l))!=null?d:0;if(b.push(a.y),w+=a.y,b.length>t){let h=b.shift();w-=h}r.set(l,w);let m=b.length||1,y=w/m;o.push({...a,y})}return o}var ee=class{constructor(e,t){this.getIndex=e,this.defaultPaths=t}run(e){var i,d,a;let t=this.getIndex(),n=(i=e.source)!=null&&i.paths&&e.source.paths.length?e.source.paths:this.defaultPaths,r=(d=e.source)!=null&&d.tags&&e.source.tags.length?e.source.tags:[],o=[];for(let l of t){let b=n&&n.length?ke(l.path,n):!0,w=r&&r.length?Pe(l.props,r):!0;if(!b||!w)continue;let m=!0;if((a=e.source)!=null&&a.where&&e.source.where.length>0)for(let y of e.source.where){let h;try{h=Le(y)}catch(D){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${y} (${D.message})`)}if(!Ie(l.props,h)){m=!1;break}}m&&o.push(l)}return e.type==="gantt"?this.runGantt(e,o):e.type==="table"?this.runTable(e,o):this.runStandard(e,o)}runTable(e,t){var r,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=e.encoding)==null?void 0:r.x,yField:(o=e.encoding)==null?void 0:o.y}}runGantt(e,t){var w,m,y;let n=(w=e.encoding)!=null?w:{},r=n.start,o=n.end,i=(m=n.label)!=null?m:n.x,d=n.series,a=n.duration,l=n.due,b=[];for(let h of t){let D=(y=h.props)!=null?y:{},k=v=>Array.isArray(v)?v[0]:v,S=null;if(o){let v=k(D[o]),C=_t(v);C&&(S=C)}if(!S)continue;let g=null;if(r){let v=k(D[r]),C=_t(v);C&&(g=C)}if(!g&&a){let v=k(D[a]),C=Number(v);Number.isNaN(C)||(g=new Date(S.getTime()-C*6e4))}g||(g=new Date(S.getTime()));let E;if(l){let v=k(D[l]),C=_t(v);C&&(E=C)}let P;if(i){let v=k(D[i]);(v==null||v==="")&&(v=h.path),P=v}else P=h.path;let G;if(d){let v=k(D[d]);v!=null&&(G=String(v))}let Q={x:P,y:0,notes:[h.path],series:G,start:g,end:S,props:D};E&&(Q.due=E),b.push(Q)}return b.sort((h,D)=>{let k=h.start?h.start.getTime():0,S=D.start?D.start.getTime():0;return k-S}),{rows:b,xField:i,yField:o}}runStandard(e,t){var h,D,k,S,g,E,P,G,Q,v;let n=(h=e.encoding)==null?void 0:h.x,r=(D=e.encoding)==null?void 0:D.y,o=(k=e.encoding)==null?void 0:k.series;if(!n)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(S=e.aggregate)!=null?S:{},d=(g=i.y)!=null?g:null,a=!!i.cumulative,l=i.rolling;if(!r&&d!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let b=[];for(let C of t){let c=(E=C.props)!=null?E:{},T=A=>Array.isArray(A)?A[0]:A,N=T(c[n]);if(N==null)continue;let x=on(N),I=x.key,B=x.isDate,V;if(o){let A=T(c[o]);A!=null&&String(A).trim()!==""&&(V=String(A))}let R;if(d==="count")R=1;else{let A=T(c[r]);if(A==null)continue;let O=Number(A);if(Number.isNaN(O))continue;R=O}b.push({x:I,y:R,notes:[C.path],series:V,props:c,_isDate:B,_origX:N})}if(b.length===0)return{rows:[],xField:n,yField:r};let w=[];if(d){let C=new Map;for(let c of b){let T=(P=c.series)!=null?P:"",N=c.x instanceof Date?c.x.toISOString().slice(0,10):String(c.x),x=T+"||"+N,I=(G=C.get(x))!=null?G:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:c.x,isDate:c._isDate,series:c.series,props:c.props};I.sum+=c.y,I.count+=1,c.y<I.min&&(I.min=c.y),c.y>I.max&&(I.max=c.y),I.notes.push(...c.notes),I.props=(Q=c.props)!=null?Q:I.props,C.set(x,I)}for(let[,c]of C){let T=c.sum;switch(d){case"sum":T=c.sum;break;case"avg":T=c.sum/c.count;break;case"min":T=c.min;break;case"max":T=c.max;break;case"count":T=c.count;break}w.push({x:c.xRep,y:T,notes:c.notes,series:c.series,props:c.props})}}else w=b.map(C=>({x:C.x,y:C.y,notes:C.notes,series:C.series,props:C.props}));if(w.length===0)return{rows:[],xField:n,yField:r};let m=((v=e.sort)==null?void 0:v.x)==="desc"?"desc":"asc";if(w.sort((C,c)=>{let T=ln(C,c);return m==="asc"?T:-T}),(a||l)&&!(e.type==="line"||e.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let y=w;return l?y=dn(w,l):a&&(y=un(w)),{rows:y,xField:n,yField:r}}};var Tt=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(s,e){if(!s)return"var(--text-accent, #5b6cff)";let t=Array.from(s).reduce((n,r)=>n*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(s,e){s.addClass("prop-charts-container"),s.style.width="100%",s.style.maxWidth="100%",s.style.position="relative";let t=s.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let n=t.createDiv({cls:"chart-notes-inner"});n.style.display="block",n.style.minHeight=`${300}px`,e&&(n.style.background=e);let r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",n.appendChild(o);let i=s.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let d=s.createDiv({cls:"chart-notes-details"});return d.style.display="none",{scroll:t,inner:n,svg:o,tooltip:i,details:d}}function mt(s,e,t,n,r,o){let i=s.getBoundingClientRect(),d=typeof n=="number"?Number.isInteger(n)?String(n):n.toFixed(2):String(n);e.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${d}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,e.style.display="block";let a=e.getBoundingClientRect(),l=o.clientX-i.left+6,b=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),b+a.height>i.height-4&&(b=i.height-a.height-4),b<4&&(b=4),e.style.left=l+"px",e.style.top=b+"px"}function ht(s){s.style.display="none"}function yt(s,e,t,n,r,o){if(!o)return;if(e.empty(),!r||r.length===0){e.style.display="none";return}e.style.display="block";let i=e.createEl("div",{cls:"chart-notes-details-header"}),d=i.createEl("div",{cls:"chart-notes-details-title"});d.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(n)&&n!==0?` \u2013 valor ${Number.isInteger(n)?n:n.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{e.style.display="none"});let l=e.createEl("ul",{cls:"chart-notes-details-list"});for(let b of r){let m=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:b});m.href="#",m.addEventListener("click",y=>{y.preventDefault(),app.workspace.openLinkText(b,"",!1)})}}function Qt(s){if(!(s instanceof Date)||isNaN(s.getTime()))return"";let e=s.getDate().toString().padStart(2,"0"),t=(s.getMonth()+1).toString().padStart(2,"0");return`${e}/${t}`}function _e(s){if(!s)return!1;let e=s.trim().toLowerCase();if(e==="#fff"||e==="#ffffff"||e==="white")return!0;if(!e.startsWith("#"))return!1;let t,n,r;if(e.length===4)t=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16),r=parseInt(e[3]+e[3],16);else if(e.length===7)t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);else return!1;return(.2126*t+.7152*n+.0722*r)/255>.7}var fe=class extends Tt.Modal{constructor(t,n,r,o){var d;super(app);this.notePath=t,this.spec=n,this.refresh=r,this.reindexFile=o;let i=(d=n.encoding)!=null?d:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var v,C;let{contentEl:t}=this;t.empty();let n=this.app.vault.getAbstractFileByPath(this.notePath);if(!(n instanceof Tt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(n),o={},i=r,d=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(d){try{o=(v=(0,Tt.parseYaml)(d[1]))!=null?v:{}}catch(c){o={}}i=r.slice(d[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(C=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?C:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),b=l.createEl("a",{text:a,cls:"gantt-edit-title"});b.href="#",b.addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let w=l.createDiv({cls:"gantt-edit-subtitle"});w.textContent=this.notePath;let m=t.createDiv({cls:"gantt-edit-form"}),y=c=>{let T=m.createDiv({cls:"gantt-edit-row"}),N=T.createDiv({cls:"gantt-edit-label"});N.textContent=c;let x=T.createDiv({cls:"gantt-edit-field"});return{row:T,field:x}},h=c=>{if(!c)return"";let N=String(c).match(/^(\d{4}-\d{2}-\d{2})/);return N?N[1]:""},D=c=>{if(c=c.trim(),!!c&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c},k=null;if(this.startKey){let{field:c}=y(this.startKey+" (in\xEDcio)");k=c.createEl("input",{type:"date"}),k.value=h(o[this.startKey])}let S=null;if(this.endKey){let{field:c}=y(this.endKey+" (fim)");S=c.createEl("input",{type:"date"}),S.value=h(o[this.endKey])}let g=null;if(this.durationKey){let{field:c}=y(this.durationKey+" (minutos)");g=c.createEl("input",{type:"number"});let T=o[this.durationKey];g.value=T!=null?String(T):"",g.min="0",g.step="5"}let E=null;if(this.dueKey){let{field:c}=y(this.dueKey+" (due)");E=c.createEl("input",{type:"date"}),E.value=h(o[this.dueKey])}let P=t.createDiv({cls:"gantt-edit-buttons"}),G=P.createEl("button",{text:"Salvar",cls:"mod-cta"});P.createEl("button",{text:"Cancelar"}).addEventListener("click",c=>{c.preventDefault(),this.close()}),G.addEventListener("click",async c=>{if(c.preventDefault(),this.startKey&&k){let x=D(k.value);x?o[this.startKey]=x:delete o[this.startKey]}if(this.endKey&&S){let x=D(S.value);x?o[this.endKey]=x:delete o[this.endKey]}if(this.durationKey&&g){let x=g.value.trim();if(x==="")delete o[this.durationKey];else{let I=Number(x);Number.isNaN(I)||(o[this.durationKey]=I)}}if(this.dueKey&&E){let x=D(E.value);x?o[this.dueKey]=x:delete o[this.dueKey]}let N=`---
${(0,Tt.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(n,N),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(x){}if(this.refresh)try{this.refresh()}catch(x){}new Tt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(s,e,t,n){var ye,be,Se,xe,ve,we,Ae,De;let r=(ye=e.options)!=null?ye:{},o=r.background,i=(be=r.drilldown)!=null?be:!0,d=!0,a=u=>{if(u==null)return"";let $=String(u).trim();if(!$)return"";let H=$.match(/^\[\[(.+?)\]\]$/);H&&($=H[1]);let z=$.lastIndexOf("/");return z>=0&&z<$.length-1&&($=$.slice(z+1)),$};if(Array.from(s.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(u=>u.start&&u.end);if(l.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let b=e.encoding,w=b.group,m=b.duration,y=b.label,h=(u,$)=>{if(!u||!$)return;let H=u[$];return Array.isArray(H)?H[0]:H},k=l.map(u=>{var ct,xt;let $=u.start,H=u.end,z=u.props,bt,Ct=y?h(z,y):void 0;Ct!=null?bt=String(Ct):typeof u.x=="string"?bt=u.x:u.x instanceof Date?bt=Qt($):bt=String(u.x);let At=a(bt),Rt,Dt=w?h(z,w):void 0;Dt!=null?Rt=String(Dt):u.series!=null?Rt=String(u.series):Rt=At;let gt=(ct=u.notes)==null?void 0:ct[0],Nt=gt?(xt=gt.replace(/\.md$/i,"").split("/").pop())!=null?xt:gt:At,Gt=u.due,It,St=h(z,m);if(St!=null){let Mt=Number(St);Number.isNaN(Mt)||(It=Mt)}return{row:u,start:$,end:H,props:z,fullName:At,groupKey:Rt,notePath:gt,noteTitle:Nt,due:Gt,estMinutes:It}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(k.length===0){s.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}k.sort((u,$)=>{if(u.groupKey<$.groupKey)return-1;if(u.groupKey>$.groupKey)return 1;let H=u.start.getTime(),z=$.start.getTime();return H!==z?H-z:u.fullName.localeCompare($.fullName)});let S=26,g=0,E=null;for(let u of k)u.groupKey!==E&&(E=u.groupKey,g+=1),g+=1;let P=Math.min(...k.map(u=>u.start.getTime())),G=Math.max(...k.map(u=>u.end.getTime()));if(!isFinite(P)||!isFinite(G)){s.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let Q=24*60*60*1e3,v=u=>{let $=new Date(u);return $.setHours(0,0,0,0),$.getTime()},C=v(P),c=v(G),T=s.querySelector(".prop-charts-title-row");T||(T=s.createDiv({cls:"prop-charts-title-row"}));let N=s.dataset.ganttZoomMode||String((Se=r.zoomMode)!=null?Se:"100");s.dataset.ganttZoomMode=N;let x=s.dataset.ganttLabelMode||String((xe=r.labelMode)!=null?xe:"compact");s.dataset.ganttLabelMode=x;let I=T.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let $=I.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===N&&$.addClass("is-active"),$.addEventListener("click",H=>{H.preventDefault(),s.dataset.ganttZoomMode=u.id,ne(s,e,t,n)})});let V=Number(r.labelWidth),R=!Number.isNaN(V)&&V>120?V:260,A=x==="wide"?R+160:R,O=s.getBoundingClientRect().width||600,X=Math.max(O,820),F;if(N==="fit")F=O;else{let u=Number(N)/100||1;F=X*u}let{inner:p,svg:f,tooltip:M,details:L}=wt(s,o);p.style.width=F+"px";let _=(u,$,H,z,bt,Ct,At,Rt,Dt)=>{if(!u)return;let gt=Math.max(40,z-8),Gt=Math.max(8,Math.floor(gt/6)),It=u.split(/\s+/),St=[],ct="";for(let kt of It){if(!ct){ct=kt;continue}(ct+" "+kt).length<=Gt?ct+=" "+kt:(St.push(ct),ct=kt)}ct&&St.push(ct);let xt=bt+2,Mt=St.length*xt,Vt=H-Mt/2+bt;St.forEach((kt,Yt)=>{let ot=document.createElementNS(f.namespaceURI,"text");ot.setAttribute("x",String($)),ot.setAttribute("y",String(Vt+Yt*xt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(bt)),ot.setAttribute("fill","#111111"),Ct&&ot.setAttribute("font-weight",Ct),ot.textContent=kt,At&&ot.addEventListener("mouseenter",rt=>At(rt)),Rt&&ot.addEventListener("mouseleave",()=>Rt()),Dt&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>Dt(rt))),f.appendChild(ot)})},tt=28,W=28,st=10,q=Math.max(300,tt+W+g*S+24);f.setAttribute("height",String(q));let K=tt+6,j=F-A-st;f.style.color="#111111";let et=c+Q-C||1,at=C-et*.02,ft=c+Q+et*.08,lt=u=>A+(u-at)/(ft-at)*j,U=(ft-at)/Q,Lt=Math.max(4,Math.min(12,Math.floor(j/90)||4)),dt=U/Lt,J=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=J[J.length-1];for(let u of J)if(u>=dt){pt=u;break}let Ut=[],Qe=v(at);for(let u=Qe;u<=ft+.5*Q;u+=pt*Q)Ut.push(u);let $t=document.createElementNS(f.namespaceURI,"line");$t.setAttribute("x1",String(A)),$t.setAttribute("y1",String(K)),$t.setAttribute("x2",String(F-st)),$t.setAttribute("y2",String(K)),$t.setAttribute("stroke","#111111"),f.appendChild($t);for(let u of Ut){let $=lt(u),H=document.createElementNS(f.namespaceURI,"line");H.setAttribute("x1",String($)),H.setAttribute("y1",String(K)),H.setAttribute("x2",String($)),H.setAttribute("y2",String(q-W)),H.setAttribute("stroke","#111111"),H.setAttribute("stroke-opacity","0.20"),H.setAttribute("stroke-dasharray","2,4"),f.appendChild(H);let z=document.createElementNS(f.namespaceURI,"text");z.setAttribute("x",String($)),z.setAttribute("y",String(K-4)),z.setAttribute("text-anchor","middle"),z.setAttribute("font-size","10"),z.setAttribute("fill","#111111"),z.textContent=Qt(new Date(u)),f.appendChild(z)}let he=new Date;he.setHours(0,0,0,0);let ie=he.getTime();if(ie>=at&&ie<=ft){let u=lt(ie),$=document.createElementNS(f.namespaceURI,"line");$.setAttribute("x1",String(u)),$.setAttribute("y1",String(K)),$.setAttribute("x2",String(u)),$.setAttribute("y2",String(q-W)),$.setAttribute("stroke","#4caf50"),$.setAttribute("stroke-width","2"),$.setAttribute("stroke-dasharray","4,2"),f.appendChild($);let H=document.createElementNS(f.namespaceURI,"text");H.setAttribute("x",String(u+4)),H.setAttribute("y",String(K+12)),H.setAttribute("font-size","10"),H.setAttribute("fill","#4caf50"),H.textContent="hoje",f.appendChild(H)}let Ot=p.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",x==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${A}px`,Ot.style.top="4px",Ot.addEventListener("click",u=>{u.preventDefault();let H=(s.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";s.dataset.ganttLabelMode=H,ne(s,e,t,n)});let He=["status","priority"],ae=Array.isArray(r.tooltipFields)?r.tooltipFields.map(u=>String(u)):null,Ke=ae&&ae.length?ae:He,Bt=0,le=null;for(let u of k){let $=u.start,H=u.end,z=(H.getTime()-$.getTime())/6e4,bt=u.props,Ct=u.notePath,At=u.noteTitle,Rt=(we=(ve=u.row.notes)==null?void 0:ve.length)!=null?we:0,Dt=u.due,gt=u.estMinutes,Nt=[];Nt.push(`${Qt($)} \u2192 ${Qt(H)}`),typeof gt=="number"&&!Number.isNaN(gt)?Nt.push(`est: ${Math.round(gt)} min`):z>0&&Nt.push(`dura\xE7\xE3o: ${Math.round(z)} min`),Dt instanceof Date&&Nt.push(`due: ${Qt(Dt)}`);for(let nt of Ke){let Y=h(bt,nt);Y!=null&&String(Y).trim()!==""&&Nt.push(`${nt}: ${String(Y)}`)}let Gt=Nt.join("<br>"),It=nt=>{var Y;nt.preventDefault(),d&&Ct?new fe(Ct,e,n==null?void 0:n.refresh,n==null?void 0:n.reindexFile).open():yt(s,L,At,gt!=null?gt:z,(Y=u.row.notes)!=null?Y:[],i)},St=nt=>{At&&Gt&&mt(s,M,At,Gt,Rt,nt)},ct=()=>ht(M);if(u.groupKey!==le){le=u.groupKey;let nt=K+8+Bt*S+S/2,Y=a(le);_(Y,4,nt,A-12,11,"600"),Bt+=1}let xt=K+8+Bt*S,Mt=S-10,Vt=lt($.getTime()),kt=lt(H.getTime()),Yt=Math.max(4,kt-Vt),ot=u.fullName,rt=document.createElementNS(f.namespaceURI,"rect");rt.setAttribute("x",String(Vt)),rt.setAttribute("y",String(xt)),rt.setAttribute("width",String(Yt)),rt.setAttribute("height",String(Mt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=u.row.series)!=null?Ae:ot,Bt)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=d&&Ct?"pointer":"default",rt.addEventListener("mouseenter",St),rt.addEventListener("mouseleave",ct),rt.addEventListener("click",It),f.appendChild(rt);let Ee=xt+Mt/2;if(Yt>=6){let nt=it((De=u.row.series)!=null?De:ot,Bt),Y=document.createElementNS(f.namespaceURI,"circle");Y.setAttribute("cx",String(Vt)),Y.setAttribute("cy",String(Ee)),Y.setAttribute("r","3.5"),Y.setAttribute("fill","#ffffff"),Y.setAttribute("stroke",nt),Y.setAttribute("stroke-width","1.5"),f.appendChild(Y);let Ft=document.createElementNS(f.namespaceURI,"circle");Ft.setAttribute("cx",String(kt)),Ft.setAttribute("cy",String(Ee)),Ft.setAttribute("r","3.5"),Ft.setAttribute("fill","#ffffff"),Ft.setAttribute("stroke",nt),Ft.setAttribute("stroke-width","1.5"),f.appendChild(Ft)}let Te=xt+Mt/2+2,Xt=w?16:4;if(x==="wide")_(ot,Xt,Te,A-Xt-4,11,null,St,ct,It);else{let nt=ot,Y=Math.max(40,A-Xt-8),Ce=Math.max(8,Math.floor(Y/6));nt.length>Ce&&(nt=nt.slice(0,Ce-1)+"\u2026");let vt=document.createElementNS(f.namespaceURI,"text");vt.setAttribute("x",String(Xt)),vt.setAttribute("y",String(Te)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",St),vt.addEventListener("mouseleave",ct),vt.addEventListener("click",It),f.appendChild(vt)}if(Dt instanceof Date){let nt=lt(Dt.getTime()),Y=document.createElementNS(f.namespaceURI,"line");Y.setAttribute("x1",String(nt)),Y.setAttribute("y1",String(xt)),Y.setAttribute("x2",String(nt)),Y.setAttribute("y2",String(xt+Mt)),Y.setAttribute("stroke","#ff6b6b"),Y.setAttribute("stroke-width","2"),Y.setAttribute("stroke-dasharray","4,2"),f.appendChild(Y)}Bt+=1}if(d){let u=s.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function ge(s,e,t){var A,O,X,F;let n=(A=e.options)!=null?A:{},r=n.background,o=(O=n.drilldown)!=null?O:!0,i=(X=t.rows)!=null?X:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:d,svg:a,tooltip:l,details:b}=wt(s,r),w=s.getBoundingClientRect().width||600,m=Math.max(w,480);d.style.width=m+"px";let y=40,h=16,D=18,k=28,S=300;a.setAttribute("height",String(S));let g=m-y-h,E=S-D-k,P=new Map;for(let p of i){let f=String(p.x),M=(F=P.get(f))!=null?F:{label:p.x,rows:[]};M.rows.push(p),P.set(f,M)}let Q=Array.from(P.keys()).sort((p,f)=>p<f?-1:p>f?1:0).map(p=>P.get(p)),v=Q.length,C=new Set;i.forEach(p=>{p.series!=null&&C.add(String(p.series))});let c=Array.from(C),T=c.length>1,N=T?"grouped":"single",x=0;i.forEach(p=>{p.y>x&&(x=p.y)}),(!isFinite(x)||x<=0)&&(x=1);let I=p=>D+E-p/(x||1)*E,B=I(0),V=4;for(let p=0;p<=V;p++){let f=x*p/V,M=I(f),L=document.createElementNS(a.namespaceURI,"line");L.setAttribute("x1",String(y)),L.setAttribute("y1",String(M)),L.setAttribute("x2",String(m-h)),L.setAttribute("y2",String(M)),L.setAttribute("stroke","#cccccc"),L.setAttribute("stroke-opacity","0.25"),a.appendChild(L);let _=document.createElementNS(a.namespaceURI,"text");_.setAttribute("x",String(y-4)),_.setAttribute("y",String(M+3)),_.setAttribute("text-anchor","end"),_.setAttribute("font-size","10"),_.setAttribute("fill","#111111"),_.textContent=String(Math.round(f)),a.appendChild(_)}let R=v>0?g/v:g;if(Q.forEach((p,f)=>{let M=y+R*(f+.5),L=String(p.label),_=document.createElementNS(a.namespaceURI,"text");_.setAttribute("x",String(M)),_.setAttribute("y",String(S-k+12)),_.setAttribute("text-anchor","middle"),_.setAttribute("font-size","10"),_.setAttribute("fill","#111111"),_.textContent=L,a.appendChild(_)}),T){let p=s.createDiv({cls:"chart-notes-legend"});c.forEach((f,M)=>{let L=p.createDiv({cls:"chart-notes-legend-item"}),_=L.createDiv();_.style.width="10px",_.style.height="10px",_.style.borderRadius="999px",_.style.backgroundColor=it(f,M),L.createSpan({text:f})})}Q.forEach((p,f)=>{let M=y+R*(f+.5),L=p.rows;if(N==="single"){let q=L[0],K=q.y,j=R*.6,et=M-j/2,at=I(K),ft=Math.max(2,B-at),lt=it("bar",f),U=document.createElementNS(a.namespaceURI,"rect");U.setAttribute("x",String(et)),U.setAttribute("y",String(at)),U.setAttribute("width",String(j)),U.setAttribute("height",String(ft)),U.setAttribute("fill",lt),U.setAttribute("stroke","rgba(0,0,0,0.25)"),U.setAttribute("stroke-width","0.5"),U.style.cursor="pointer";let Z=String(p.label),Lt=`valor: ${Math.round(K*100)/100}`;U.addEventListener("mouseenter",dt=>{var J,pt;return mt(s,l,Z,Lt,(pt=(J=q.notes)==null?void 0:J.length)!=null?pt:0,dt)}),U.addEventListener("mouseleave",()=>ht(l)),U.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(s,b,Z,K,(J=q.notes)!=null?J:[],o)}),a.appendChild(U);return}let _=c.length,tt=R/Math.max(_+1,2),W=_*tt,st=M-W/2;c.forEach((q,K)=>{let j=L.find(J=>(J.series!=null?String(J.series):"")===q);if(!j)return;let et=j.y,at=st+K*tt,ft=I(et),lt=Math.max(2,B-ft),U=it(q,K),Z=document.createElementNS(a.namespaceURI,"rect");Z.setAttribute("x",String(at)),Z.setAttribute("y",String(ft)),Z.setAttribute("width",String(tt)),Z.setAttribute("height",String(lt)),Z.setAttribute("fill",U),Z.setAttribute("stroke","rgba(0,0,0,0.25)"),Z.setAttribute("stroke-width","0.5"),Z.style.cursor="pointer";let Lt=`${q} @ ${String(p.label)}`,dt=`valor: ${Math.round(et*100)/100}`;Z.addEventListener("mouseenter",J=>{var pt,Ut;return mt(s,l,Lt,dt,(Ut=(pt=j.notes)==null?void 0:pt.length)!=null?Ut:0,J)}),Z.addEventListener("mouseleave",()=>ht(l)),Z.addEventListener("click",J=>{var pt;J.preventDefault(),yt(s,b,Lt,et,(pt=j.notes)!=null?pt:[],o)}),a.appendChild(Z)})})}function $e(s,e,t){var R,A,O,X;let n=(R=e.options)!=null?R:{},r=n.background,o=(A=n.drilldown)!=null?A:!0,i=(O=t.rows)!=null?O:[];if(!i.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:d,svg:a,tooltip:l,details:b}=wt(s,r),w=s.getBoundingClientRect().width||600,m=Math.max(w,480);d.style.width=m+"px";let y=40,h=16,D=18,k=28,S=300;a.setAttribute("height",String(S));let g=m-y-h,E=S-D-k,P=new Map;for(let F of i){let p=String(F.x),f=(X=P.get(p))!=null?X:{label:F.x,rows:[]};f.rows.push(F),P.set(p,f)}let Q=Array.from(P.keys()).sort((F,p)=>F<p?-1:F>p?1:0).map(F=>P.get(F)),v=Q.length,C=new Set;i.forEach(F=>{F.series!=null&&C.add(String(F.series))});let c=Array.from(C);if(!c.length){ge(s,e,t);return}let T=0;Q.forEach(F=>{let p=F.rows.reduce((f,M)=>f+M.y,0);p>T&&(T=p)}),(!isFinite(T)||T<=0)&&(T=1);let N=F=>D+E-F/(T||1)*E,x=N(0),I=4;for(let F=0;F<=I;F++){let p=T*F/I,f=N(p),M=document.createElementNS(a.namespaceURI,"line");M.setAttribute("x1",String(y)),M.setAttribute("y1",String(f)),M.setAttribute("x2",String(m-h)),M.setAttribute("y2",String(f)),M.setAttribute("stroke","#cccccc"),M.setAttribute("stroke-opacity","0.25"),a.appendChild(M);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(y-4)),L.setAttribute("y",String(f+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(p)),a.appendChild(L)}let B=v>0?g/v:g;Q.forEach((F,p)=>{let f=y+B*(p+.5),M=String(F.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(f)),L.setAttribute("y",String(S-k+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=M,a.appendChild(L)});let V=s.createDiv({cls:"chart-notes-legend"});c.forEach((F,p)=>{let f=V.createDiv({cls:"chart-notes-legend-item"}),M=f.createDiv();M.style.width="10px",M.style.height="10px",M.style.borderRadius="999px",M.style.backgroundColor=it(F,p),f.createSpan({text:F})}),Q.forEach((F,p)=>{let f=y+B*(p+.5),M=B*.6,L=f-M/2,_=0;c.forEach((tt,W)=>{let st=F.rows.find(dt=>(dt.series!=null?String(dt.series):"")===tt);if(!st)return;let q=st.y,K=_,j=_+q;_=j;let et=N(K),at=N(j),ft=Math.max(2,et-at),lt=it(tt,W),U=document.createElementNS(a.namespaceURI,"rect");U.setAttribute("x",String(L)),U.setAttribute("y",String(at)),U.setAttribute("width",String(M)),U.setAttribute("height",String(ft)),U.setAttribute("fill",lt),U.setAttribute("stroke","rgba(0,0,0,0.25)"),U.setAttribute("stroke-width","0.5"),U.style.cursor="pointer";let Z=`${tt} @ ${String(F.label)}`,Lt=`valor: ${Math.round(q*100)/100}`;U.addEventListener("mouseenter",dt=>{var J,pt;return mt(s,l,Z,Lt,(pt=(J=st.notes)==null?void 0:J.length)!=null?pt:0,dt)}),U.addEventListener("mouseleave",()=>ht(l)),U.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(s,b,Z,q,(J=st.notes)!=null?J:[],o)}),a.appendChild(U)})})}function me(s,e,t,n){var A,O,X,F;let r=(A=e.options)!=null?A:{},o=r.background,i=(O=r.drilldown)!=null?O:!0,d=(X=t.rows)!=null?X:[];if(!d.length){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:b,details:w}=wt(s,o),m=s.getBoundingClientRect().width||600,y=Math.max(m,480);a.style.width=y+"px";let h=40,D=16,k=18,S=24,g=300;l.setAttribute("height",String(g));let E=y-h-D,P=g-k-S,G=new Map;for(let p of d){let f=p.series!=null?String(p.series):"__default__",M=(F=G.get(f))!=null?F:[];M.push(p),G.set(f,M)}let Q=Array.from(G.keys()),v=[],C=new Set;for(let p of d){let f=String(p.x);C.has(f)||(C.add(f),v.push(p.x))}let c=v.length||1,T=p=>{let f=String(p),M=v.findIndex(L=>String(L)===f);return M<0?h:c===1?h+E/2:h+M/(c-1)*E},N=p=>String(p),x=Number.POSITIVE_INFINITY,I=Number.NEGATIVE_INFINITY;for(let p of d)p.y<x&&(x=p.y),p.y>I&&(I=p.y);(!isFinite(x)||!isFinite(I))&&(x=0,I=1),x===I&&(x===0?I=1:x=0);let B=p=>k+P-(p-x)/(I-x||1)*P,V=4;for(let p=0;p<=V;p++){let f=x+(I-x)*p/V,M=B(f),L=document.createElementNS(l.namespaceURI,"line");L.setAttribute("x1",String(h)),L.setAttribute("y1",String(M)),L.setAttribute("x2",String(y-D)),L.setAttribute("y2",String(M)),L.setAttribute("stroke","#cccccc"),L.setAttribute("stroke-opacity","0.25"),l.appendChild(L);let _=document.createElementNS(l.namespaceURI,"text");_.setAttribute("x",String(h-4)),_.setAttribute("y",String(M+3)),_.setAttribute("text-anchor","end"),_.setAttribute("font-size","10"),_.setAttribute("fill","#111111"),_.textContent=Math.abs(f)>=100?String(Math.round(f)):String(Math.round(f*10)/10),l.appendChild(_)}let R=Q.filter(p=>p!=="__default__");if(R.length>1){let p=s.createDiv({cls:"chart-notes-legend"});R.forEach((f,M)=>{let L=f,_=p.createDiv({cls:"chart-notes-legend-item"}),tt=_.createDiv();tt.style.width="10px",tt.style.height="10px",tt.style.borderRadius="999px",tt.style.backgroundColor=it(L,M),_.createSpan({text:L})})}Q.forEach((p,f)=>{let M=G.get(p);if(!(M!=null&&M.length))return;let L=p==="__default__"?it("line",f):it(p,f),_=[...M].sort((W,st)=>{let q=v.findIndex(j=>String(j)===String(W.x)),K=v.findIndex(j=>String(j)===String(st.x));return q-K}),tt="";if(_.forEach((W,st)=>{let q=T(W.x),K=B(W.y);tt+=(st===0?"M ":" L ")+q+" "+K}),n){let W=_[0],st=_[_.length-1],q=T(W.x),K=T(st.x),j=B(x);tt+=` L ${K} ${j} L ${q} ${j} Z`;let et=document.createElementNS(l.namespaceURI,"path");et.setAttribute("d",tt),et.setAttribute("fill",L),et.setAttribute("fill-opacity","0.18"),et.setAttribute("stroke",L),et.setAttribute("stroke-width","1.5"),l.appendChild(et)}else{let W=document.createElementNS(l.namespaceURI,"path");W.setAttribute("d",tt),W.setAttribute("fill","none"),W.setAttribute("stroke",L),W.setAttribute("stroke-width","2"),l.appendChild(W)}_.forEach(W=>{let st=T(W.x),q=B(W.y),K=document.createElementNS(l.namespaceURI,"circle");K.setAttribute("cx",String(st)),K.setAttribute("cy",String(q)),K.setAttribute("r","3"),K.setAttribute("fill","#ffffff"),K.setAttribute("stroke",L),K.setAttribute("stroke-width","1.5"),K.style.cursor="pointer";let j=N(W.x),et=p==="__default__"?"":String(W.series),at=et?`${et} @ ${j}`:j,ft=`valor: ${Math.round(W.y*100)/100}`;K.addEventListener("mouseenter",lt=>{var U,Z;return mt(s,b,at,ft,(Z=(U=W.notes)==null?void 0:U.length)!=null?Z:0,lt)}),K.addEventListener("mouseleave",()=>ht(b)),K.addEventListener("click",lt=>{var U;lt.preventDefault(),yt(s,w,at,W.y,(U=W.notes)!=null?U:[],i)}),l.appendChild(K)})})}function Be(s,e,t){var E;let{background:n,drilldown:r=!0}=(E=e.options)!=null?E:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=_e(n)?"#000000":void 0,i=s.getBoundingClientRect().width||600,{inner:d,svg:a,tooltip:l,details:b}=wt(s,n),w=Math.max(i,420);d.style.width=w+"px",o&&(a.style.color=o);let m=300,y=w/2,h=(m-28+28)/2,D=Math.min(w/2-20,m/2-20),S=t.rows.map(P=>Math.max(0,P.y)).reduce((P,G)=>P+G,0)||1,g=-Math.PI/2;t.rows.forEach((P,G)=>{var R;let Q=P.x instanceof Date?P.x.toISOString().slice(0,10):String(P.x),v=P.y,C=v/S*Math.PI*2,c=y+D*Math.cos(g),T=h+D*Math.sin(g),N=y+D*Math.cos(g+C),x=h+D*Math.sin(g+C),I=C>Math.PI?1:0,B=document.createElementNS(a.namespaceURI,"path"),V=[`M ${y} ${h}`,`L ${c} ${T}`,`A ${D} ${D} 0 ${I} 1 ${N} ${x}`,"Z"].join(" ");B.setAttribute("d",V),B.setAttribute("fill",it((R=P.series)!=null?R:Q,G)),B.style.cursor="pointer",B.addEventListener("mouseenter",A=>{var O,X;return mt(s,l,Q,v,(X=(O=P.notes)==null?void 0:O.length)!=null?X:0,A)}),B.addEventListener("mouseleave",()=>ht(l)),B.addEventListener("click",()=>{var A;return yt(s,b,Q,v,(A=P.notes)!=null?A:[],r)}),a.appendChild(B),g+=C})}function Ge(s,e,t){var T;let{background:n,drilldown:r=!0}=(T=e.options)!=null?T:{};if(t.rows.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=n?"#111111":void 0,i=s.getBoundingClientRect().width||600,{inner:d,svg:a,tooltip:l,details:b}=wt(s,n),w=Math.max(i,700);d.style.width=w+"px",o&&(a.style.color=o);let m=300,y=w-48-10,h=m-28-28,D=t.rows.map(N=>{let x=N.x;if(x instanceof Date)return x.getTime();if(typeof x=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(x)){let B=new Date(x);if(!isNaN(B.getTime()))return B.getTime()}let I=Number(x);return isNaN(I)?null:I}return typeof x=="number"?x:null}),k=t.rows.map(N=>N.y),S=D.filter(N=>N!==null);if(S.length===0){s.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let g=Math.min(...S),E=Math.max(...S),P=Math.min(...k),G=Math.max(...k),Q=N=>48+(N-g)/(E-g||1)*y,v=N=>m-28-(N-P)/(G-P||1)*h,C=document.createElementNS(a.namespaceURI,"line");C.setAttribute("x1",String(48)),C.setAttribute("y1",String(28)),C.setAttribute("x2",String(48)),C.setAttribute("y2",String(m-28)),C.setAttribute("stroke","currentColor"),a.appendChild(C);let c=document.createElementNS(a.namespaceURI,"line");c.setAttribute("x1",String(48)),c.setAttribute("y1",String(m-28)),c.setAttribute("x2",String(w-10)),c.setAttribute("y2",String(m-28)),c.setAttribute("stroke","currentColor"),a.appendChild(c),t.rows.forEach((N,x)=>{let I=D[x];if(I==null)return;let B=Q(I),V=v(k[x]),R=document.createElementNS(a.namespaceURI,"circle");R.setAttribute("cx",String(B)),R.setAttribute("cy",String(V)),R.setAttribute("r","4"),R.setAttribute("fill",it(N.series,x)),R.style.cursor="pointer";let A=N.x instanceof Date?N.x.toISOString().slice(0,10):typeof N.x=="string"?N.x:String(N.x);R.addEventListener("mouseenter",O=>{var X,F;return mt(s,l,A,N.y,(F=(X=N.notes)==null?void 0:X.length)!=null?F:0,O)}),R.addEventListener("mouseleave",()=>ht(l)),R.addEventListener("click",O=>{var X;O.preventDefault(),yt(s,b,A,N.y,(X=N.notes)!=null?X:[],r)}),a.appendChild(R)})}var se=class{render(e,t,n,r){var a;let{title:o}=(a=t.options)!=null?a:{};e.empty(),e.addClass("prop-charts-container");let d=e.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(o&&(d.textContent=o),t.type){case"bar":ge(e,t,n);break;case"stacked-bar":$e(e,t,n);break;case"line":me(e,t,n,!1);break;case"area":me(e,t,n,!0);break;case"pie":Be(e,t,n);break;case"scatter":Ge(e,t,n);break;case"gantt":ne(e,t,n,r);break;default:e.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}}};var oe=class extends Kt.Plugin{constructor(t,n){super(t,n)}async onload(){console.log("Chart Notes: loading plugin (Bases-only)"),this.indexer=new Zt(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Kt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Kt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Kt.TFile&&this.indexer.removeFile(t)})),this.registerBasesView(ue,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,n)=>new qt(t,n,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},n={type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",shouldHide:S=>{var g;return String((g=S.get("chartType"))!=null?g:"bar")==="gantt"}},r={type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:"Texto mostrado em cada tarefa. Se vazio, usa o nome da nota.",shouldHide:S=>{var g;return String((g=S.get("chartType"))!=null?g:"bar")!=="gantt"}},o={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:S=>{var E;let g=String((E=S.get("chartType"))!=null?E:"bar");return g==="pie"||g==="gantt"}},i={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:S=>{var g;return String((g=S.get("chartType"))!=null?g:"bar")==="pie"}},d={type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum (line/area only)"},shouldHide:S=>{var E;let g=String((E=S.get("chartType"))!=null?E:"bar");return g!=="line"&&g!=="area"}},a={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (keep date/time)",none:"None (raw)",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:S=>{var E;let g=String((E=S.get("chartType"))!=null?E:"bar");return g==="pie"||g==="scatter"||g==="gantt"}},l=(S,g,E)=>({type:"property",key:S,displayName:g,description:E,shouldHide:P=>{var G;return String((G=P.get("chartType"))!=null?G:"")!=="gantt"}}),b=l("startProperty","Start (Gantt)","Data/hora de in\xEDcio. Se faltar, tentamos inferir via fim + dura\xE7\xE3o."),w=l("endProperty","End (Gantt)","Data/hora de fim da barra (geralmente 'scheduled' ou 'finish')."),m=l("dueProperty","Due (deadline, optional)","Deadline. Usado como fallback quando h\xE1 due + dura\xE7\xE3o, e mostrado no tooltip."),y=l("durationProperty","Duration in minutes (optional)","Estimativa em minutos. Usada para inferir start/end quando s\xF3 um dos lados existe."),h=l("groupProperty","Group / lane (optional)","Projeto/\xE1rea usada como lane no lado esquerdo do Gantt.");return[t,n,r,o,i,d,a,b,w,m,y,h,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
