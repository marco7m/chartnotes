/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var ze=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Ue=(o,n)=>{for(var t in n)ce(o,t,{get:n[t],enumerable:!0})},Oe=(o,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of Ke(n))!Ye.call(o,r)&&r!==t&&ce(o,r,{get:()=>n[r],enumerable:!(e=ze(n,r))||e.enumerable});return o};var Xe=o=>Oe(ce({},"__esModule",{value:!0}),o);var hn={};Ue(hn,{default:()=>se});module.exports=Xe(hn);var Lt=require("obsidian");var qt=require("obsidian"),le="chartnotes-view",qe=["bar","stacked-bar","line","area","pie","scatter","gantt"];function je(o){let n=String(o!=null?o:"bar").trim().toLowerCase();return qe.includes(n)?n:"bar"}var Ze=["sum","count","cumulative-sum"];function Je(o){let n=String(o!=null?o:"sum").trim().toLowerCase();return Ze.includes(n)?n:"sum"}var tn=["auto","none","day","week","month","quarter","year"];function en(o){let n=String(o!=null?o:"auto").trim().toLowerCase();return tn.includes(n)?n:"auto"}var Xt=class extends qt.BasesView{constructor(t,e,r){super(t);this.type=le;this.renderer=r,this.rootEl=e.createDiv("chartnotes-bases-view")}onDataUpdated(){var U,Q,$;this.rootEl.empty();let t=this.data,e=(U=t==null?void 0:t.groupedData)!=null?U:[];if(!e.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,s=je((Q=r==null?void 0:r.get("chartType"))!=null?Q:"bar"),i=Je(r==null?void 0:r.get("aggregateMode")),a=i==="cumulative-sum"&&!(s==="line"||s==="area")?"sum":i,c=en(r==null?void 0:r.get("xBucket")),d=this.getPropFromConfig("xProperty"),m=this.getPropFromConfig("yProperty"),S=this.getPropFromConfig("seriesProperty");s==="pie"&&(S={id:null,name:null});let w=this.getPropFromConfig("startProperty"),g=this.getPropFromConfig("endProperty"),D=this.getPropFromConfig("dueProperty"),T=this.getPropFromConfig("scheduledProperty"),E=this.getPropFromConfig("durationProperty"),L=this.getPropFromConfig("groupProperty"),C=s==="gantt",H=s==="scatter";if(!C&&!d.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'Category / X axis' property in view options."});return}if(H&&(!d.id||!m.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(C&&!(w.id||g.id||T.id||D.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Scheduled/Due with Duration."});return}let F;if(C?F=this.buildRowsForGantt(e,d,S,w,g,D,T,E,L):H?F=this.buildRowsForScatter(e,d,m,S):F=this.buildRowsForAggregatedCharts(e,d,m,S,a,c),!F.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let b={rows:F},l=(($=r==null?void 0:r.get("title"))!=null?$:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",A=r==null?void 0:r.get("drilldown"),R=typeof A=="boolean"?A:!0,x=this.buildEncoding({x:d,y:m,series:S,start:w,end:g,due:D,duration:E,group:L,aggMode:a,xBucket:c}),I={type:s,source:{type:"properties",query:""},encoding:x,options:{title:l,drilldown:R}},V={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,I,b,V)}getPropFromConfig(t){var h,a;let e=this.config,r=(h=e==null?void 0:e.get)==null?void 0:h.call(e,t);if(!r)return{id:null,name:null};let s=r.trim();if(!s||s==="undefined"||s==="null")return{id:null,name:null};let i=s;try{let c=(0,qt.parsePropertyId)(i);return{id:i,name:(a=c.name)!=null?a:i}}catch(c){return{id:i,name:i}}}readValue(t,e){if(!e.id)return null;let r;try{r=t.getValue(e.id)}catch(s){return null}if(!r)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(s){}try{let s=r.toString();if(s==null)return null;let i=String(s).trim();return i.length?i:null}catch(s){return null}}parseDate(t){if(!t)return null;let e=new Date(t.trim());return Number.isNaN(e.getTime())?null:e}compareX(t,e){let r=this.parseDate(t!=null?String(t):null),s=this.parseDate(e!=null?String(e):null);if(r&&s)return r.getTime()-s.getTime();let i=Number(t),h=Number(e);return!Number.isNaN(i)&&!Number.isNaN(h)?i-h:String(t!=null?t:"").localeCompare(String(e!=null?e:""))}fmtDate(t){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${r}-${s}`}startOfWeek(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(e.getDay()+6)%7;return e.setDate(e.getDate()-r),e.setHours(0,0,0,0),e}bucketX(t,e){let r=this.parseDate(t);if(!r)return t;switch(e){case"none":return t;case"auto":case"day":return this.fmtDate(new Date(r.getFullYear(),r.getMonth(),r.getDate()));case"week":{let s=this.startOfWeek(r);return`${this.fmtDate(s)} (W)`}case"month":{let s=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${s}`}case"quarter":{let s=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${s}`}case"year":return`${r.getFullYear()}`;default:return t}}buildRowsForAggregatedCharts(t,e,r,s,i,h){var m,S;let a=new Map,c=i==="count"||!r.id&&i!=="sum";for(let v of t)for(let w of v.entries){let g=w.file,D=(S=this.readValue(w,e))!=null?S:g!=null&&g.name?String(g.name):String((m=g==null?void 0:g.path)!=null?m:""),T=this.bucketX(D,h),E=1,L=null;if(!c&&r.id){if(L=this.readValue(w,r),L==null)continue;let y=Number(L);if(Number.isNaN(y))continue;E=y}else E=1;let C=this.readValue(w,s),H=C!=null?String(C):void 0,F=`${T}@@${H!=null?H:""}`,b=a.get(F);b||(b={x:T,y:0,series:H,notes:[],props:{}},a.set(F,b)),b.y+=E,g!=null&&g.path&&b.notes.push(g.path),b.props&&e.name&&(b.props[e.name]=T),!c&&b.props&&r.name&&L!=null&&(b.props[r.name]=b.y),b.props&&s.name&&C!=null&&(b.props[s.name]=C)}let d=Array.from(a.values());return i==="cumulative-sum"?this.toCumulative(d):d}toCumulative(t){var s,i,h;let e=new Map;for(let a of t){let c=(s=a.series)!=null?s:"__no_series__";((i=e.get(c))!=null?i:e.set(c,[]).get(c)).push(a)}let r=[];for(let[,a]of e){let c=[...a].sort((m,S)=>this.compareX(m.x,S.x)),d=0;for(let m of c){let S=Number((h=m.y)!=null?h:0);Number.isNaN(S)||(d+=S,r.push({...m,y:d}))}}return r}buildRowsForScatter(t,e,r,s){let i=[];for(let h of t)for(let a of h.entries){let c=a.file,d=this.readValue(a,e),m=this.readValue(a,r);if(d==null||m==null)continue;let S=Number(d),v=Number(m);if(Number.isNaN(S)||Number.isNaN(v))continue;let w=this.readValue(a,s),g=w!=null?String(w):void 0;i.push({x:S,y:v,series:g,notes:c!=null&&c.path?[c.path]:[],props:{}})}return i}buildRowsForGantt(t,e,r,s,i,h,a,c,d){var S,v;let m=[];for(let w of t)for(let g of w.entries){let D=g.file,T=this.readValue(g,s),E=this.readValue(g,i),L=this.readValue(g,h),C=this.readValue(g,a),H=this.readValue(g,c),F=H!=null?Number(H):NaN,b=Number.isFinite(F),y=this.parseDate(T),l=this.parseDate(E),A=this.parseDate(L),R=this.parseDate(C);if(!y&&b&&(R?y=new Date(R.getTime()-F*6e4):A?y=new Date(A.getTime()-F*6e4):l&&(y=new Date(l.getTime()-F*6e4))),!l&&y&&b&&(l=new Date(y.getTime()+F*6e4)),!y||!l)continue;let x=(v=this.readValue(g,e))!=null?v:D!=null&&D.name?String(D.name).replace(/\.md$/i,""):String((S=D==null?void 0:D.path)!=null?S:""),I=this.readValue(g,r),V=I!=null?String(I):void 0,U=this.readValue(g,d),Q={};b&&c.name&&(Q[c.name]=F),d.name&&U!=null&&(Q[d.name]=U),m.push({x,y:0,series:V,start:y,end:l,due:A!=null?A:void 0,notes:D!=null&&D.path?[D.path]:[],props:Q})}return m}buildEncoding(t){var i,h,a,c,d,m;let e=t.aggMode==="count"||!t.y.id&&t.aggMode!=="sum",r;e?r="Count":t.aggMode==="cumulative-sum"?r=t.y.name?`${t.y.name} (cumulative)`:"Cumulative":r=t.y.name?`${t.y.name} (sum)`:"Value";let s=t.xBucket&&t.xBucket!=="none"?` (${t.xBucket})`:"";return{x:t.x.name?`${t.x.name}${s}`:"x",y:r,series:(i=t.series.name)!=null?i:"series",start:(h=t.start.name)!=null?h:"start",end:(a=t.end.name)!=null?a:"end",due:(c=t.due.name)!=null?c:"due",duration:(d=t.duration.name)!=null?d:"duration",group:(m=t.group.name)!=null?m:"group"}}};var ke=require("obsidian"),jt=class{constructor(n){this.index=new Map;this.app=n}async buildIndex(){this.index.clear();let n=this.app.vault.getMarkdownFiles();for(let t of n)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(n){if(n.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(n)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,ke.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[h,a]of Object.entries(i))h!=="position"&&(t[h]=a)}let s=this.app.metadataCache.getFileCache(n);s!=null&&s.tags&&!t.tags&&(t.tags=s.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",n.path,e)}this.index.set(n.path,{path:n.path,props:t})}removeFile(n){this.index.delete(n.path)}};function Ne(o,n){if(!n||n.length===0)return!0;for(let t of n){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Pe(o,n){if(!n||n.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of n)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let e=String(t);for(let r of n)if(e===r||e==="#"+r)return!0;return!1}function Jt(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function $t(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,r]=o.split("-");return new Date(Number(t),Number(e)-1,Number(r),0,0,0,0)}let n=new Date(o);return isNaN(n.getTime())?null:n}function ut(o){let n=new Date(o);return n.setHours(0,0,0,0),n}function Zt(o,n){let t=new Date(o);return t.setDate(t.getDate()-n),t}function nn(o,n){return Zt(o,n*7)}function rn(o,n){let t=new Date(o);return t.setMonth(t.getMonth()-n),t}function de(o,n){let t=new Date(o);return t.setDate(t.getDate()+n),t}function sn(o,n){return de(o,n*7)}function on(o,n){let t=new Date(o);return t.setMonth(t.getMonth()+n),t}function Me(o){let n=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(n)||n.endsWith("date")||n.endsWith("at")||n.endsWith("on"))}function Te(o,n){let t=n?new Date(n):new Date,e=ut(t),r=o.trim().toLowerCase();if(r==="today")return e;if(r==="yesterday")return ut(Zt(e,1));if(/^-\d+$/.test(r)){let s=parseInt(r.slice(1),10);return ut(Zt(e,s))}if(/^-\d+d$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(Zt(e,s))}if(/^-\d+w$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(nn(e,s))}if(/^-\d+m$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(rn(e,s))}if(/^\+\d+$/.test(r)){let s=parseInt(r.slice(1),10);return ut(de(e,s))}if(/^\+\d+d$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(de(e,s))}if(/^\+\d+w$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(sn(e,s))}if(/^\+\d+m$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(on(e,s))}return null}function Le(o){let n=o.trim(),t=n.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let d=t[1].trim(),m=t[2].trim(),S=t[3].trim(),v=Me(d),w=ue(m,v),g=ue(S,v),D=w.valueType==="date"||g.valueType==="date"?"date":w.valueType;return{field:d,op:"between",value:w.value,value2:g.value,valueType:D}}let e=/(==|!=|>=|<=|>|<)/,r=n.split(e);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let s=r[0].trim(),i=r[1].trim(),h=r[2].trim(),a=Me(s),c=ue(h,a);return{field:s,op:i,value:c.value,valueType:c.valueType}}function ue(o,n){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),r=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(n){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Te(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Te(t);if(i)return{value:i,valueType:"date"}}if(Jt(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let s=Number(t);return Number.isNaN(s)?{value:t,valueType:"string"}:{value:s,valueType:"number"}}function Ie(o,n){let t=o[n.field];if(t==null)return!1;if(n.valueType==="date"){let s=t instanceof Date?ut(t):Jt(t)?ut($t(t)):null;if(!s)return!1;let i=n.value instanceof Date?n.value:null,h=n.value2 instanceof Date?n.value2:null;if(!i)return!1;let a=s.getTime(),c=ut(i).getTime();switch(n.op){case"==":return a===c;case"!=":return a!==c;case">":return a>c;case">=":return a>=c;case"<":return a<c;case"<=":return a<=c;case"between":if(!h)return!1;let d=ut(h).getTime();return a>=c&&a<=d}}if(n.valueType==="number"){let s=Number(t);if(isNaN(s))return!1;let i=Number(n.value);switch(n.op){case"==":return s===i;case"!=":return s!==i;case">":return s>i;case">=":return s>=i;case"<":return s<i;case"<=":return s<=i;case"between":return typeof n.value2!="number"?!1:s>=i&&s<=n.value2}}let e=String(t),r=String(n.value);switch(n.op){case"==":return e===r;case"!=":return e!==r;case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r;case"between":return!1}}function an(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(Jt(o)){let n=$t(o);if(n)return{key:n,isDate:!0}}return{key:o,isDate:!1}}function cn(o,n){let t=o.x,e=n.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let r=String(t),s=String(e);return r<s?-1:r>s?1:0}function ln(o,n){var s,i;let t=cn(o,n);if(t!==0)return t;let e=(s=o.series)!=null?s:"",r=(i=n.series)!=null?i:"";return e<r?-1:e>r?1:0}function un(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let n=o.trim().match(/^(\d+)/);if(n){let t=Number(n[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function dn(o){var e,r;let n=new Map,t=[];for(let s of o){let i=(e=s.series)!=null?e:"__no_series__",a=((r=n.get(i))!=null?r:0)+s.y;n.set(i,a),t.push({...s,y:a})}return t}function pn(o,n){var i,h;let t=un(n);if(!t||t<=1)return[...o];let e=new Map,r=new Map,s=[];for(let a of o){let c=(i=a.series)!=null?i:"__no_series__",d=e.get(c);d||(d=[],e.set(c,d));let m=(h=r.get(c))!=null?h:0;if(d.push(a.y),m+=a.y,d.length>t){let w=d.shift();m-=w}r.set(c,m);let S=d.length||1,v=m/S;s.push({...a,y:v})}return s}var te=class{constructor(n,t){this.getIndex=n,this.defaultPaths=t}run(n){var i,h,a;let t=this.getIndex(),e=(i=n.source)!=null&&i.paths&&n.source.paths.length?n.source.paths:this.defaultPaths,r=(h=n.source)!=null&&h.tags&&n.source.tags.length?n.source.tags:[],s=[];for(let c of t){let d=e&&e.length?Ne(c.path,e):!0,m=r&&r.length?Pe(c.props,r):!0;if(!d||!m)continue;let S=!0;if((a=n.source)!=null&&a.where&&n.source.where.length>0)for(let v of n.source.where){let w;try{w=Le(v)}catch(g){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${v} (${g.message})`)}if(!Ie(c.props,w)){S=!1;break}}S&&s.push(c)}return n.type==="gantt"?this.runGantt(n,s):n.type==="table"?this.runTable(n,s):this.runStandard(n,s)}runTable(n,t){var r,s;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=n.encoding)==null?void 0:r.x,yField:(s=n.encoding)==null?void 0:s.y}}runGantt(n,t){var m,S,v;let e=(m=n.encoding)!=null?m:{},r=e.start,s=e.end,i=(S=e.label)!=null?S:e.x,h=e.series,a=e.duration,c=e.due,d=[];for(let w of t){let g=(v=w.props)!=null?v:{},D=b=>Array.isArray(b)?b[0]:b,T=null;if(s){let b=D(g[s]),y=$t(b);y&&(T=y)}if(!T)continue;let E=null;if(r){let b=D(g[r]),y=$t(b);y&&(E=y)}if(!E&&a){let b=D(g[a]),y=Number(b);Number.isNaN(y)||(E=new Date(T.getTime()-y*6e4))}E||(E=new Date(T.getTime()));let L;if(c){let b=D(g[c]),y=$t(b);y&&(L=y)}let C;if(i){let b=D(g[i]);(b==null||b==="")&&(b=w.path),C=b}else C=w.path;let H;if(h){let b=D(g[h]);b!=null&&(H=String(b))}let F={x:C,y:0,notes:[w.path],series:H,start:E,end:T,props:g};L&&(F.due=L),d.push(F)}return d.sort((w,g)=>{let D=w.start?w.start.getTime():0,T=g.start?g.start.getTime():0;return D-T}),{rows:d,xField:i,yField:s}}runStandard(n,t){var w,g,D,T,E,L,C,H,F,b;let e=(w=n.encoding)==null?void 0:w.x,r=(g=n.encoding)==null?void 0:g.y,s=(D=n.encoding)==null?void 0:D.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(T=n.aggregate)!=null?T:{},h=(E=i.y)!=null?E:null,a=!!i.cumulative,c=i.rolling;if(!r&&h!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let d=[];for(let y of t){let l=(L=y.props)!=null?L:{},A=$=>Array.isArray($)?$[0]:$,R=A(l[e]);if(R==null)continue;let x=an(R),I=x.key,V=x.isDate,U;if(s){let $=A(l[s]);$!=null&&String($).trim()!==""&&(U=String($))}let Q;if(h==="count")Q=1;else{let $=A(l[r]);if($==null)continue;let Z=Number($);if(Number.isNaN(Z))continue;Q=Z}d.push({x:I,y:Q,notes:[y.path],series:U,props:l,_isDate:V,_origX:R})}if(d.length===0)return{rows:[],xField:e,yField:r};let m=[];if(h){let y=new Map;for(let l of d){let A=(C=l.series)!=null?C:"",R=l.x instanceof Date?l.x.toISOString().slice(0,10):String(l.x),x=A+"||"+R,I=(H=y.get(x))!=null?H:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:l.x,isDate:l._isDate,series:l.series,props:l.props};I.sum+=l.y,I.count+=1,l.y<I.min&&(I.min=l.y),l.y>I.max&&(I.max=l.y),I.notes.push(...l.notes),I.props=(F=l.props)!=null?F:I.props,y.set(x,I)}for(let[,l]of y){let A=l.sum;switch(h){case"sum":A=l.sum;break;case"avg":A=l.sum/l.count;break;case"min":A=l.min;break;case"max":A=l.max;break;case"count":A=l.count;break}m.push({x:l.xRep,y:A,notes:l.notes,series:l.series,props:l.props})}}else m=d.map(y=>({x:y.x,y:y.y,notes:y.notes,series:y.series,props:y.props}));if(m.length===0)return{rows:[],xField:e,yField:r};let S=((b=n.sort)==null?void 0:b.x)==="desc"?"desc":"asc";if(m.sort((y,l)=>{let A=ln(y,l);return S==="asc"?A:-A}),(a||c)&&!(n.type==="line"||n.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&c)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let v=m;return c?v=pn(m,c):a&&(v=dn(m)),{rows:v,xField:e,yField:r}}};var Ct=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,n){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,r)=>e*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(o,n){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,n&&(e.style.background=n);let r="http://www.w3.org/2000/svg",s=document.createElementNS(r,"svg");s.setAttribute("width","100%"),s.setAttribute("height",String(300)),s.style.display="block",e.appendChild(s);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let h=o.createDiv({cls:"chart-notes-details"});return h.style.display="none",{scroll:t,inner:e,svg:s,tooltip:i,details:h}}function gt(o,n,t,e,r,s){let i=o.getBoundingClientRect(),h=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);n.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${h}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,n.style.display="block";let a=n.getBoundingClientRect(),c=s.clientX-i.left+6,d=s.clientY-i.top+6;c+a.width>i.width-4&&(c=i.width-a.width-4),c<4&&(c=4),d+a.height>i.height-4&&(d=i.height-a.height-4),d<4&&(d=4),n.style.left=c+"px",n.style.top=d+"px"}function ft(o){o.style.display="none"}function yt(o,n,t,e,r,s){if(!s)return;if(n.empty(),!r||r.length===0){n.style.display="none";return}n.style.display="block";let i=n.createEl("div",{cls:"chart-notes-details-header"}),h=i.createEl("div",{cls:"chart-notes-details-title"});h.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{n.style.display="none"});let c=n.createEl("ul",{cls:"chart-notes-details-list"});for(let d of r){let S=c.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:d});S.href="#",S.addEventListener("click",v=>{v.preventDefault(),app.workspace.openLinkText(d,"",!1)})}}function Gt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let n=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${n}/${t}`}function _e(o){if(!o)return!1;let n=o.trim().toLowerCase();if(n==="#fff"||n==="#ffffff"||n==="white")return!0;if(!n.startsWith("#"))return!1;let t,e,r;if(n.length===4)t=parseInt(n[1]+n[1],16),e=parseInt(n[2]+n[2],16),r=parseInt(n[3]+n[3],16);else if(n.length===7)t=parseInt(n.slice(1,3),16),e=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*r)/255>.7}var pe=class extends Ct.Modal{constructor(t,e,r,s){var h;super(app);this.notePath=t,this.spec=e,this.refresh=r,this.reindexFile=s;let i=(h=e.encoding)!=null?h:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var b,y;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(e),s={},i=r,h=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(h){try{s=(b=(0,Ct.parseYaml)(h[1]))!=null?b:{}}catch(l){s={}}i=r.slice(h[0].length)}(typeof s!="object"||s==null)&&(s={});let a=(y=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?y:this.notePath,c=t.createDiv({cls:"gantt-edit-header"}),d=c.createEl("a",{text:a,cls:"gantt-edit-title"});d.href="#",d.addEventListener("click",l=>{l.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let m=c.createDiv({cls:"gantt-edit-subtitle"});m.textContent=this.notePath;let S=t.createDiv({cls:"gantt-edit-form"}),v=l=>{let A=S.createDiv({cls:"gantt-edit-row"}),R=A.createDiv({cls:"gantt-edit-label"});R.textContent=l;let x=A.createDiv({cls:"gantt-edit-field"});return{row:A,field:x}},w=l=>{if(!l)return"";let R=String(l).match(/^(\d{4}-\d{2}-\d{2})/);return R?R[1]:""},g=l=>{if(l=l.trim(),!!l&&/^\d{4}-\d{2}-\d{2}$/.test(l))return l},D=null;if(this.startKey){let{field:l}=v(this.startKey+" (in\xEDcio)");D=l.createEl("input",{type:"date"}),D.value=w(s[this.startKey])}let T=null;if(this.endKey){let{field:l}=v(this.endKey+" (fim)");T=l.createEl("input",{type:"date"}),T.value=w(s[this.endKey])}let E=null;if(this.durationKey){let{field:l}=v(this.durationKey+" (minutos)");E=l.createEl("input",{type:"number"});let A=s[this.durationKey];E.value=A!=null?String(A):"",E.min="0",E.step="5"}let L=null;if(this.dueKey){let{field:l}=v(this.dueKey+" (due)");L=l.createEl("input",{type:"date"}),L.value=w(s[this.dueKey])}let C=t.createDiv({cls:"gantt-edit-buttons"}),H=C.createEl("button",{text:"Salvar",cls:"mod-cta"});C.createEl("button",{text:"Cancelar"}).addEventListener("click",l=>{l.preventDefault(),this.close()}),H.addEventListener("click",async l=>{if(l.preventDefault(),this.startKey&&D){let x=g(D.value);x?s[this.startKey]=x:delete s[this.startKey]}if(this.endKey&&T){let x=g(T.value);x?s[this.endKey]=x:delete s[this.endKey]}if(this.durationKey&&E){let x=E.value.trim();if(x==="")delete s[this.durationKey];else{let I=Number(x);Number.isNaN(I)||(s[this.durationKey]=I)}}if(this.dueKey&&L){let x=g(L.value);x?s[this.dueKey]=x:delete s[this.dueKey]}let R=`---
${(0,Ct.stringifyYaml)(s).trim()}
---
`+i;if(await this.app.vault.modify(e,R),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(x){}if(this.refresh)try{this.refresh()}catch(x){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ee(o,n,t,e){var ye,be,xe,Se,ve,we,Ae,Ee;let r=(ye=n.options)!=null?ye:{},s=r.background,i=(be=r.drilldown)!=null?be:!0,h=!0,a=u=>{if(u==null)return"";let N=String(u).trim();if(!N)return"";let B=N.match(/^\[\[(.+?)\]\]$/);B&&(N=B[1]);let O=N.lastIndexOf("/");return O>=0&&O<N.length-1&&(N=N.slice(O+1)),N};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let c=t.rows.filter(u=>u.start&&u.end);if(c.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let d=n.encoding,m=d.group,S=d.duration,v=(u,N)=>{if(!u||!N)return;let B=u[N];return Array.isArray(B)?B[0]:B},g=c.map(u=>{var xt,lt;let N=u.start,B=u.end,O=u.props,It=typeof u.x=="string"?u.x:u.x instanceof Date?Gt(N):String(u.x),At=a(It),bt,Ft=m?v(O,m):void 0;Ft!=null?bt=String(Ft):u.series!=null?bt=String(u.series):bt=At;let mt=(xt=u.notes)==null?void 0:xt[0],Et=mt?(lt=mt.replace(/\.md$/i,"").split("/").pop())!=null?lt:mt:At,Rt=u.due,_t,Nt=v(O,S);if(Nt!=null){let St=Number(Nt);Number.isNaN(St)||(_t=St)}return{row:u,start:N,end:B,props:O,fullName:At,groupKey:bt,notePath:mt,noteTitle:Et,due:Rt,estMinutes:_t}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(g.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}g.sort((u,N)=>{if(u.groupKey<N.groupKey)return-1;if(u.groupKey>N.groupKey)return 1;let B=u.start.getTime(),O=N.start.getTime();return B!==O?B-O:u.fullName.localeCompare(N.fullName)});let D=26,T=0,E=null;for(let u of g)u.groupKey!==E&&(E=u.groupKey,T+=1),T+=1;let L=Math.min(...g.map(u=>u.start.getTime())),C=Math.max(...g.map(u=>u.end.getTime()));if(!isFinite(L)||!isFinite(C)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let H=24*60*60*1e3,F=u=>{let N=new Date(u);return N.setHours(0,0,0,0),N.getTime()},b=F(L),y=F(C),l=o.querySelector(".prop-charts-title-row");l||(l=o.createDiv({cls:"prop-charts-title-row"}));let A=o.dataset.ganttZoomMode||String((xe=r.zoomMode)!=null?xe:"100");o.dataset.ganttZoomMode=A;let R=o.dataset.ganttLabelMode||String((Se=r.labelMode)!=null?Se:"compact");o.dataset.ganttLabelMode=R;let x=l.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let N=x.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===A&&N.addClass("is-active"),N.addEventListener("click",B=>{B.preventDefault(),o.dataset.ganttZoomMode=u.id,ee(o,n,t,e)})}),x.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let N=o.querySelector(".chart-notes-zoom-button");N&&N.click()});let U=Number(r.labelWidth),Q=!Number.isNaN(U)&&U>120?U:260,$=R==="wide"?Q+160:Q,Z=o.getBoundingClientRect().width||600,et=Math.max(Z,820),_;if(A==="fit")_=Z;else{let u=Number(A)/100||1;_=et*u}let{inner:p,svg:f,tooltip:k,details:M}=wt(o,s);p.style.width=_+"px";let P=(u,N,B,O,It,At,bt,Ft,mt)=>{if(!u)return;let Et=Math.max(40,O-8),_t=Math.max(8,Math.floor(Et/6)),Nt=u.split(/\s+/),xt=[],lt="";for(let kt of Nt){if(!lt){lt=kt;continue}(lt+" "+kt).length<=_t?lt+=" "+kt:(xt.push(lt),lt=kt)}lt&&xt.push(lt);let St=It+2,Bt=xt.length*St,zt=B-Bt/2+It;xt.forEach((kt,Ut)=>{let ot=document.createElementNS(f.namespaceURI,"text");ot.setAttribute("x",String(N)),ot.setAttribute("y",String(zt+Ut*St)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=kt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),mt&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>mt(rt))),f.appendChild(ot)})},J=28,W=28,st=10,X=Math.max(300,J+W+T*D+24);f.setAttribute("height",String(X));let z=_-$-st,K=J+6;f.style.color="#111111";let tt=y+H-b||1,at=b-tt*.02,ht=y+H+tt*.08,ct=u=>$+(u-at)/(ht-at)*z,G=(ht-at)/H,Tt=Math.max(4,Math.min(12,Math.floor(z/90)||4)),dt=G/Tt,j=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=j[j.length-1];for(let u of j)if(u>=dt){pt=u;break}let Wt=[],Ge=F(at);for(let u=Ge;u<=ht+.5*H;u+=pt*H)Wt.push(u);let Ht=document.createElementNS(f.namespaceURI,"line");Ht.setAttribute("x1",String($)),Ht.setAttribute("y1",String(K)),Ht.setAttribute("x2",String(_-st)),Ht.setAttribute("y2",String(K)),Ht.setAttribute("stroke","#111111"),f.appendChild(Ht);for(let u of Wt){let N=ct(u),B=document.createElementNS(f.namespaceURI,"line");B.setAttribute("x1",String(N)),B.setAttribute("y1",String(K)),B.setAttribute("x2",String(N)),B.setAttribute("y2",String(X-W)),B.setAttribute("stroke","#111111"),B.setAttribute("stroke-opacity","0.20"),B.setAttribute("stroke-dasharray","2,4"),f.appendChild(B);let O=document.createElementNS(f.namespaceURI,"text");O.setAttribute("x",String(N)),O.setAttribute("y",String(K-4)),O.setAttribute("text-anchor","middle"),O.setAttribute("font-size","10"),O.setAttribute("fill","#111111"),O.textContent=Gt(new Date(u)),f.appendChild(O)}let fe=new Date;fe.setHours(0,0,0,0);let oe=fe.getTime();if(oe>=at&&oe<=ht){let u=ct(oe),N=document.createElementNS(f.namespaceURI,"line");N.setAttribute("x1",String(u)),N.setAttribute("y1",String(K)),N.setAttribute("x2",String(u)),N.setAttribute("y2",String(X-W)),N.setAttribute("stroke","#4caf50"),N.setAttribute("stroke-width","2"),N.setAttribute("stroke-dasharray","4,2"),f.appendChild(N);let B=document.createElementNS(f.namespaceURI,"text");B.setAttribute("x",String(u+4)),B.setAttribute("y",String(K+12)),B.setAttribute("font-size","10"),B.setAttribute("fill","#4caf50"),B.textContent="hoje",f.appendChild(B)}let Yt=p.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Yt.setAttr("title",R==="wide"?"Compactar nomes":"Expandir nomes"),Yt.style.left=`${$}px`,Yt.style.top="4px",Yt.addEventListener("click",u=>{u.preventDefault();let B=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=B,ee(o,n,t,e)});let Ve=["status","priority"],ie=Array.isArray(r.tooltipFields)?r.tooltipFields.map(u=>String(u)):null,We=ie&&ie.length?ie:Ve,Qt=0,ae=null;for(let u of g){let N=u.start,B=u.end,O=(B.getTime()-N.getTime())/6e4,It=u.props,At=u.notePath,bt=u.noteTitle,Ft=(we=(ve=u.row.notes)==null?void 0:ve.length)!=null?we:0,mt=u.due,Et=u.estMinutes,Rt=[];Rt.push(`${Gt(N)} \u2192 ${Gt(B)}`),typeof Et=="number"&&!Number.isNaN(Et)?Rt.push(`est: ${Math.round(Et)} min`):O>0&&Rt.push(`dura\xE7\xE3o: ${Math.round(O)} min`),mt instanceof Date&&Rt.push(`due: ${Gt(mt)}`);for(let nt of We){let Y=v(It,nt);Y!=null&&String(Y).trim()!==""&&Rt.push(`${nt}: ${String(Y)}`)}let _t=Rt.join("<br>"),Nt=nt=>{var Y;nt.preventDefault(),h&&At?new pe(At,n,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(o,M,bt,Et!=null?Et:O,(Y=u.row.notes)!=null?Y:[],i)},xt=nt=>{bt&&_t&&gt(o,k,bt,_t,Ft,nt)},lt=()=>ft(k);if(u.groupKey!==ae){ae=u.groupKey;let nt=K+8+Qt*D+D/2,Y=a(ae);P(Y,4,nt,$-12,11,"600"),Qt+=1}let St=K+8+Qt*D,Bt=D-10,zt=ct(N.getTime()),kt=ct(B.getTime()),Ut=Math.max(4,kt-zt),ot=u.fullName,rt=document.createElementNS(f.namespaceURI,"rect");rt.setAttribute("x",String(zt)),rt.setAttribute("y",String(St)),rt.setAttribute("width",String(Ut)),rt.setAttribute("height",String(Bt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=u.row.series)!=null?Ae:ot,Qt)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=h&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",lt),rt.addEventListener("click",Nt),f.appendChild(rt);let De=St+Bt/2;if(Ut>=6){let nt=it((Ee=u.row.series)!=null?Ee:ot,Qt),Y=document.createElementNS(f.namespaceURI,"circle");Y.setAttribute("cx",String(zt)),Y.setAttribute("cy",String(De)),Y.setAttribute("r","3.5"),Y.setAttribute("fill","#ffffff"),Y.setAttribute("stroke",nt),Y.setAttribute("stroke-width","1.5"),f.appendChild(Y);let Pt=document.createElementNS(f.namespaceURI,"circle");Pt.setAttribute("cx",String(kt)),Pt.setAttribute("cy",String(De)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),f.appendChild(Pt)}let Ce=St+Bt/2+2,Ot=m?16:4;if(R==="wide")P(ot,Ot,Ce,$-Ot-4,11,null,xt,lt,Nt);else{let nt=ot,Y=Math.max(40,$-Ot-8),Re=Math.max(8,Math.floor(Y/6));nt.length>Re&&(nt=nt.slice(0,Re-1)+"\u2026");let vt=document.createElementNS(f.namespaceURI,"text");vt.setAttribute("x",String(Ot)),vt.setAttribute("y",String(Ce)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",xt),vt.addEventListener("mouseleave",lt),vt.addEventListener("click",Nt),f.appendChild(vt)}if(mt instanceof Date){let nt=ct(mt.getTime()),Y=document.createElementNS(f.namespaceURI,"line");Y.setAttribute("x1",String(nt)),Y.setAttribute("y1",String(St)),Y.setAttribute("x2",String(nt)),Y.setAttribute("y2",String(St+Bt)),Y.setAttribute("stroke","#ff6b6b"),Y.setAttribute("stroke-width","2"),Y.setAttribute("stroke-dasharray","4,2"),f.appendChild(Y)}Qt+=1}if(h){let u=o.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function he(o,n,t){var $,Z,et,_;let e=($=n.options)!=null?$:{},r=e.background,s=(Z=e.drilldown)!=null?Z:!0,i=(et=t.rows)!=null?et:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:h,svg:a,tooltip:c,details:d}=wt(o,r),m=o.getBoundingClientRect().width||600,S=Math.max(m,480);h.style.width=S+"px";let v=40,w=16,g=18,D=28,T=300;a.setAttribute("height",String(T));let E=S-v-w,L=T-g-D,C=new Map;for(let p of i){let f=String(p.x),k=(_=C.get(f))!=null?_:{label:p.x,rows:[]};k.rows.push(p),C.set(f,k)}let F=Array.from(C.keys()).sort((p,f)=>p<f?-1:p>f?1:0).map(p=>C.get(p)),b=F.length,y=new Set;i.forEach(p=>{p.series!=null&&y.add(String(p.series))});let l=Array.from(y),A=l.length>1,R=A?"grouped":"single",x=0;i.forEach(p=>{p.y>x&&(x=p.y)}),(!isFinite(x)||x<=0)&&(x=1);let I=p=>g+L-p/(x||1)*L,V=I(0),U=4;for(let p=0;p<=U;p++){let f=x*p/U,k=I(f),M=document.createElementNS(a.namespaceURI,"line");M.setAttribute("x1",String(v)),M.setAttribute("y1",String(k)),M.setAttribute("x2",String(S-w)),M.setAttribute("y2",String(k)),M.setAttribute("stroke","#cccccc"),M.setAttribute("stroke-opacity","0.25"),a.appendChild(M);let P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(v-4)),P.setAttribute("y",String(k+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=String(Math.round(f)),a.appendChild(P)}let Q=b>0?E/b:E;if(F.forEach((p,f)=>{let k=v+Q*(f+.5),M=String(p.label),P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(k)),P.setAttribute("y",String(T-D+12)),P.setAttribute("text-anchor","middle"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=M,a.appendChild(P)}),A){let p=o.createDiv({cls:"chart-notes-legend"});l.forEach((f,k)=>{let M=p.createDiv({cls:"chart-notes-legend-item"}),P=M.createDiv();P.style.width="10px",P.style.height="10px",P.style.borderRadius="999px",P.style.backgroundColor=it(f,k),M.createSpan({text:f})})}F.forEach((p,f)=>{let k=v+Q*(f+.5),M=p.rows;if(R==="single"){let X=M[0],z=X.y,K=Q*.6,tt=k-K/2,at=I(z),ht=Math.max(2,V-at),ct=it("bar",f),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(tt)),G.setAttribute("y",String(at)),G.setAttribute("width",String(K)),G.setAttribute("height",String(ht)),G.setAttribute("fill",ct),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let q=String(p.label),Tt=`valor: ${Math.round(z*100)/100}`;G.addEventListener("mouseenter",dt=>{var j,pt;return gt(o,c,q,Tt,(pt=(j=X.notes)==null?void 0:j.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>ft(c)),G.addEventListener("click",dt=>{var j;dt.preventDefault(),yt(o,d,q,z,(j=X.notes)!=null?j:[],s)}),a.appendChild(G);return}let P=l.length,J=Q/Math.max(P+1,2),W=P*J,st=k-W/2;l.forEach((X,z)=>{let K=M.find(j=>(j.series!=null?String(j.series):"")===X);if(!K)return;let tt=K.y,at=st+z*J,ht=I(tt),ct=Math.max(2,V-ht),G=it(X,z),q=document.createElementNS(a.namespaceURI,"rect");q.setAttribute("x",String(at)),q.setAttribute("y",String(ht)),q.setAttribute("width",String(J)),q.setAttribute("height",String(ct)),q.setAttribute("fill",G),q.setAttribute("stroke","rgba(0,0,0,0.25)"),q.setAttribute("stroke-width","0.5"),q.style.cursor="pointer";let Tt=`${X} @ ${String(p.label)}`,dt=`valor: ${Math.round(tt*100)/100}`;q.addEventListener("mouseenter",j=>{var pt,Wt;return gt(o,c,Tt,dt,(Wt=(pt=K.notes)==null?void 0:pt.length)!=null?Wt:0,j)}),q.addEventListener("mouseleave",()=>ft(c)),q.addEventListener("click",j=>{var pt;j.preventDefault(),yt(o,d,Tt,tt,(pt=K.notes)!=null?pt:[],s)}),a.appendChild(q)})})}function $e(o,n,t){var Q,$,Z,et;let e=(Q=n.options)!=null?Q:{},r=e.background,s=($=e.drilldown)!=null?$:!0,i=(Z=t.rows)!=null?Z:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:h,svg:a,tooltip:c,details:d}=wt(o,r),m=o.getBoundingClientRect().width||600,S=Math.max(m,480);h.style.width=S+"px";let v=40,w=16,g=18,D=28,T=300;a.setAttribute("height",String(T));let E=S-v-w,L=T-g-D,C=new Map;for(let _ of i){let p=String(_.x),f=(et=C.get(p))!=null?et:{label:_.x,rows:[]};f.rows.push(_),C.set(p,f)}let F=Array.from(C.keys()).sort((_,p)=>_<p?-1:_>p?1:0).map(_=>C.get(_)),b=F.length,y=new Set;i.forEach(_=>{_.series!=null&&y.add(String(_.series))});let l=Array.from(y);if(!l.length){he(o,n,t);return}let A=0;F.forEach(_=>{let p=_.rows.reduce((f,k)=>f+k.y,0);p>A&&(A=p)}),(!isFinite(A)||A<=0)&&(A=1);let R=_=>g+L-_/(A||1)*L,x=R(0),I=4;for(let _=0;_<=I;_++){let p=A*_/I,f=R(p),k=document.createElementNS(a.namespaceURI,"line");k.setAttribute("x1",String(v)),k.setAttribute("y1",String(f)),k.setAttribute("x2",String(S-w)),k.setAttribute("y2",String(f)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),a.appendChild(k);let M=document.createElementNS(a.namespaceURI,"text");M.setAttribute("x",String(v-4)),M.setAttribute("y",String(f+3)),M.setAttribute("text-anchor","end"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=String(Math.round(p)),a.appendChild(M)}let V=b>0?E/b:E;F.forEach((_,p)=>{let f=v+V*(p+.5),k=String(_.label),M=document.createElementNS(a.namespaceURI,"text");M.setAttribute("x",String(f)),M.setAttribute("y",String(T-D+12)),M.setAttribute("text-anchor","middle"),M.setAttribute("font-size","10"),M.setAttribute("fill","#111111"),M.textContent=k,a.appendChild(M)});let U=o.createDiv({cls:"chart-notes-legend"});l.forEach((_,p)=>{let f=U.createDiv({cls:"chart-notes-legend-item"}),k=f.createDiv();k.style.width="10px",k.style.height="10px",k.style.borderRadius="999px",k.style.backgroundColor=it(_,p),f.createSpan({text:_})}),F.forEach((_,p)=>{let f=v+V*(p+.5),k=V*.6,M=f-k/2,P=0;l.forEach((J,W)=>{let st=_.rows.find(dt=>(dt.series!=null?String(dt.series):"")===J);if(!st)return;let X=st.y,z=P,K=P+X;P=K;let tt=R(z),at=R(K),ht=Math.max(2,tt-at),ct=it(J,W),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(M)),G.setAttribute("y",String(at)),G.setAttribute("width",String(k)),G.setAttribute("height",String(ht)),G.setAttribute("fill",ct),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let q=`${J} @ ${String(_.label)}`,Tt=`valor: ${Math.round(X*100)/100}`;G.addEventListener("mouseenter",dt=>{var j,pt;return gt(o,c,q,Tt,(pt=(j=st.notes)==null?void 0:j.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>ft(c)),G.addEventListener("click",dt=>{var j;dt.preventDefault(),yt(o,d,q,X,(j=st.notes)!=null?j:[],s)}),a.appendChild(G)})})}function me(o,n,t,e){var $,Z,et,_;let r=($=n.options)!=null?$:{},s=r.background,i=(Z=r.drilldown)!=null?Z:!0,h=(et=t.rows)!=null?et:[];if(!h.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:c,tooltip:d,details:m}=wt(o,s),S=o.getBoundingClientRect().width||600,v=Math.max(S,480);a.style.width=v+"px";let w=40,g=16,D=18,T=24,E=300;c.setAttribute("height",String(E));let L=v-w-g,C=E-D-T,H=new Map;for(let p of h){let f=p.series!=null?String(p.series):"__default__",k=(_=H.get(f))!=null?_:[];k.push(p),H.set(f,k)}let F=Array.from(H.keys()),b=[],y=new Set;for(let p of h){let f=String(p.x);y.has(f)||(y.add(f),b.push(p.x))}let l=b.length||1,A=p=>{let f=String(p),k=b.findIndex(M=>String(M)===f);return k<0?w:l===1?w+L/2:w+k/(l-1)*L},R=p=>String(p),x=Number.POSITIVE_INFINITY,I=Number.NEGATIVE_INFINITY;for(let p of h)p.y<x&&(x=p.y),p.y>I&&(I=p.y);(!isFinite(x)||!isFinite(I))&&(x=0,I=1),x===I&&(x===0?I=1:x=0);let V=p=>D+C-(p-x)/(I-x||1)*C,U=4;for(let p=0;p<=U;p++){let f=x+(I-x)*p/U,k=V(f),M=document.createElementNS(c.namespaceURI,"line");M.setAttribute("x1",String(w)),M.setAttribute("y1",String(k)),M.setAttribute("x2",String(v-g)),M.setAttribute("y2",String(k)),M.setAttribute("stroke","#cccccc"),M.setAttribute("stroke-opacity","0.25"),c.appendChild(M);let P=document.createElementNS(c.namespaceURI,"text");P.setAttribute("x",String(w-4)),P.setAttribute("y",String(k+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=Math.abs(f)>=100?String(Math.round(f)):String(Math.round(f*10)/10),c.appendChild(P)}let Q=F.filter(p=>p!=="__default__");if(Q.length>1){let p=o.createDiv({cls:"chart-notes-legend"});Q.forEach((f,k)=>{let M=f,P=p.createDiv({cls:"chart-notes-legend-item"}),J=P.createDiv();J.style.width="10px",J.style.height="10px",J.style.borderRadius="999px",J.style.backgroundColor=it(M,k),P.createSpan({text:M})})}F.forEach((p,f)=>{let k=H.get(p);if(!(k!=null&&k.length))return;let M=p==="__default__"?it("line",f):it(p,f),P=[...k].sort((W,st)=>{let X=b.findIndex(K=>String(K)===String(W.x)),z=b.findIndex(K=>String(K)===String(st.x));return X-z}),J="";if(P.forEach((W,st)=>{let X=A(W.x),z=V(W.y);J+=(st===0?"M ":" L ")+X+" "+z}),e){let W=P[0],st=P[P.length-1],X=A(W.x),z=A(st.x),K=V(x);J+=` L ${z} ${K} L ${X} ${K} Z`;let tt=document.createElementNS(c.namespaceURI,"path");tt.setAttribute("d",J),tt.setAttribute("fill",M),tt.setAttribute("fill-opacity","0.18"),tt.setAttribute("stroke",M),tt.setAttribute("stroke-width","1.5"),c.appendChild(tt)}else{let W=document.createElementNS(c.namespaceURI,"path");W.setAttribute("d",J),W.setAttribute("fill","none"),W.setAttribute("stroke",M),W.setAttribute("stroke-width","2"),c.appendChild(W)}P.forEach(W=>{let st=A(W.x),X=V(W.y),z=document.createElementNS(c.namespaceURI,"circle");z.setAttribute("cx",String(st)),z.setAttribute("cy",String(X)),z.setAttribute("r","3"),z.setAttribute("fill","#ffffff"),z.setAttribute("stroke",M),z.setAttribute("stroke-width","1.5"),z.style.cursor="pointer";let K=R(W.x),tt=p==="__default__"?"":String(W.series),at=tt?`${tt} @ ${K}`:K,ht=`valor: ${Math.round(W.y*100)/100}`;z.addEventListener("mouseenter",ct=>{var G,q;return gt(o,d,at,ht,(q=(G=W.notes)==null?void 0:G.length)!=null?q:0,ct)}),z.addEventListener("mouseleave",()=>ft(d)),z.addEventListener("click",ct=>{var G;ct.preventDefault(),yt(o,m,at,W.y,(G=W.notes)!=null?G:[],i)}),c.appendChild(z)})})}function He(o,n,t){var L;let{background:e,drilldown:r=!0}=(L=n.options)!=null?L:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=_e(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:h,svg:a,tooltip:c,details:d}=wt(o,e),m=Math.max(i,420);h.style.width=m+"px",s&&(a.style.color=s);let S=300,v=m/2,w=(S-28+28)/2,g=Math.min(m/2-20,S/2-20),T=t.rows.map(C=>Math.max(0,C.y)).reduce((C,H)=>C+H,0)||1,E=-Math.PI/2;t.rows.forEach((C,H)=>{var Q;let F=C.x instanceof Date?C.x.toISOString().slice(0,10):String(C.x),b=C.y,y=b/T*Math.PI*2,l=v+g*Math.cos(E),A=w+g*Math.sin(E),R=v+g*Math.cos(E+y),x=w+g*Math.sin(E+y),I=y>Math.PI?1:0,V=document.createElementNS(a.namespaceURI,"path"),U=[`M ${v} ${w}`,`L ${l} ${A}`,`A ${g} ${g} 0 ${I} 1 ${R} ${x}`,"Z"].join(" ");V.setAttribute("d",U),V.setAttribute("fill",it((Q=C.series)!=null?Q:F,H)),V.style.cursor="pointer",V.addEventListener("mouseenter",$=>{var Z,et;return gt(o,c,F,b,(et=(Z=C.notes)==null?void 0:Z.length)!=null?et:0,$)}),V.addEventListener("mouseleave",()=>ft(c)),V.addEventListener("click",()=>{var $;return yt(o,d,F,b,($=C.notes)!=null?$:[],r)}),a.appendChild(V),E+=y})}function Qe(o,n,t){var A;let{background:e,drilldown:r=!0}=(A=n.options)!=null?A:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:h,svg:a,tooltip:c,details:d}=wt(o,e),m=Math.max(i,700);h.style.width=m+"px",s&&(a.style.color=s);let S=300,v=m-48-10,w=S-28-28,g=t.rows.map(R=>{let x=R.x;if(x instanceof Date)return x.getTime();if(typeof x=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(x)){let V=new Date(x);if(!isNaN(V.getTime()))return V.getTime()}let I=Number(x);return isNaN(I)?null:I}return typeof x=="number"?x:null}),D=t.rows.map(R=>R.y),T=g.filter(R=>R!==null);if(T.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let E=Math.min(...T),L=Math.max(...T),C=Math.min(...D),H=Math.max(...D),F=R=>48+(R-E)/(L-E||1)*v,b=R=>S-28-(R-C)/(H-C||1)*w,y=document.createElementNS(a.namespaceURI,"line");y.setAttribute("x1",String(48)),y.setAttribute("y1",String(28)),y.setAttribute("x2",String(48)),y.setAttribute("y2",String(S-28)),y.setAttribute("stroke","currentColor"),a.appendChild(y);let l=document.createElementNS(a.namespaceURI,"line");l.setAttribute("x1",String(48)),l.setAttribute("y1",String(S-28)),l.setAttribute("x2",String(m-10)),l.setAttribute("y2",String(S-28)),l.setAttribute("stroke","currentColor"),a.appendChild(l),t.rows.forEach((R,x)=>{let I=g[x];if(I==null)return;let V=F(I),U=b(D[x]),Q=document.createElementNS(a.namespaceURI,"circle");Q.setAttribute("cx",String(V)),Q.setAttribute("cy",String(U)),Q.setAttribute("r","4"),Q.setAttribute("fill",it(R.series,x)),Q.style.cursor="pointer";let $=R.x instanceof Date?R.x.toISOString().slice(0,10):typeof R.x=="string"?R.x:String(R.x);Q.addEventListener("mouseenter",Z=>{var et,_;return gt(o,c,$,R.y,(_=(et=R.notes)==null?void 0:et.length)!=null?_:0,Z)}),Q.addEventListener("mouseleave",()=>ft(c)),Q.addEventListener("click",Z=>{var et;Z.preventDefault(),yt(o,d,$,R.y,(et=R.notes)!=null?et:[],r)}),a.appendChild(Q)})}var Be=require("obsidian"),re=class{render(n,t,e,r,s=!1){var c;let{title:i}=(c=t.options)!=null?c:{};n.empty(),n.addClass("prop-charts-container");let a=n.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":he(n,t,e);break;case"stacked-bar":$e(n,t,e);break;case"line":me(n,t,e,!1);break;case"area":me(n,t,e,!0);break;case"pie":He(n,t,e);break;case"scatter":Qe(n,t,e);break;case"gantt":ee(n,t,e,r);break;default:n.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!s){let d=n.createEl("button",{cls:"chart-notes-zoom-button"});d.setAttr("type","button"),d.setAttr("aria-label","Expandir gr\xE1fico"),d.textContent="\u2922",d.addEventListener("click",m=>{m.preventDefault(),new ge(t,e,this,r).open()})}}},ge=class extends Be.Modal{constructor(t,e,r,s){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=r,this.ctx=s}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),r=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:r,cls:"chart-notes-zoom-title"});let s=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(c,d)=>{let m=s.createEl("button",{cls:"chart-notes-zoom-size-btn",text:c});(()=>{m.toggleClass("is-active",this.size===d)})(),m.addEventListener("click",v=>{v.preventDefault(),this.size=d,this.applySize(),s.querySelectorAll(".chart-notes-zoom-size-btn").forEach(g=>g.classList.remove("is-active")),m.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let h=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(h,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",r="85vh";switch(this.size){case"small":e="60vw",r="55vh";break;case"medium":e="80vw",r="70vh";break;case"large":default:e="95vw",r="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=r,t.style.maxHeight=r}};var se=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new jt(this.app),await this.indexer.buildIndex(),this.query=new te(()=>this.indexer.getAll(),[]),this.renderer=new re,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,r)=>{var d;let s;try{let m=(0,Lt.parseYaml)(t);if(!m||typeof m!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}s=m}catch(m){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+m.message});return}if(!s.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=s.type==="gantt",h=s.type==="table";if(!i&&!h){if(!s.encoding||!s.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let S=((d=s.aggregate)==null?void 0:d.y)==="count";if(!s.encoding.y&&!S){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}s.encoding||(s.encoding={}),s.source||(s.source={});let c;try{c=this.query.run(s)}catch(m){e.createEl("div",{text:"Chart Notes: erro na query: "+m.message});return}this.renderer.render(e,s,c)}),this.registerBasesView(le,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new Xt(t,e,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},e={type:"property",key:"xProperty",displayName:"Category / X axis (slice label)"},r={type:"property",key:"yProperty",displayName:"Value (Y) \u2013 empty = count"},s={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:T=>{var E;return String((E=T.get("chartType"))!=null?E:"bar")==="pie"}},i={type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative (line/area only)"},shouldHide:T=>{var L;let E=String((L=T.get("chartType"))!=null?L:"bar");return E==="scatter"||E==="gantt"}},h={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (date \u2192 day)",none:"None",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:T=>{var L;let E=String((L=T.get("chartType"))!=null?L:"bar");return E==="pie"||E==="scatter"||E==="gantt"}},a=(T,E)=>({type:"property",key:T,displayName:E,shouldHide:L=>{var C;return String((C=L.get("chartType"))!=null?C:"")!=="gantt"}}),c=a("startProperty","Start (Gantt)"),d=a("endProperty","End (Gantt)"),m=a("dueProperty","Due (optional)"),S=a("scheduledProperty","Scheduled (optional)"),v=a("durationProperty","Duration in minutes (optional)"),w=a("groupProperty","Group / lane (optional)");return[t,e,r,s,i,h,c,d,m,S,v,w,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
