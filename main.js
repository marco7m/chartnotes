/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Oe=(o,n)=>{for(var t in n)le(o,t,{get:n[t],enumerable:!0})},Xe=(o,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of ze(n))!Ye.call(o,r)&&r!==t&&le(o,r,{get:()=>n[r],enumerable:!(e=We(n,r))||e.enumerable});return o};var qe=o=>Xe(le({},"__esModule",{value:!0}),o);var mn={};Oe(mn,{default:()=>oe});module.exports=qe(mn);var Lt=require("obsidian");var jt=require("obsidian"),ue="chartnotes-view",je=["bar","stacked-bar","line","area","pie","scatter","gantt"];function Ze(o){let n=String(o!=null?o:"bar").trim().toLowerCase();return je.includes(n)?n:"bar"}var Je=["sum","count","cumulative-sum"];function tn(o){let n=String(o!=null?o:"sum").trim().toLowerCase();return Je.includes(n)?n:"sum"}var en=["auto","none","day","week","month","quarter","year"];function nn(o){let n=String(o!=null?o:"auto").trim().toLowerCase();return en.includes(n)?n:"auto"}var Xt="(missing)",qt=class extends jt.BasesView{constructor(t,e,r){super(t);this.type=ue;this.renderer=r,this.rootEl=e.createDiv("chartnotes-bases-view")}onDataUpdated(){var G,B,Y;this.rootEl.empty();let t=this.data,e=(G=t==null?void 0:t.groupedData)!=null?G:[];if(!e.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,s=Ze((B=r==null?void 0:r.get("chartType"))!=null?B:"bar"),i=s==="pie",d=s==="scatter",a=s==="gantt",c=tn(r==null?void 0:r.get("aggregateMode")),f=c==="cumulative-sum"&&!(s==="line"||s==="area")?"sum":c,m=nn(r==null?void 0:r.get("xBucket")),g=i||d||a?"none":m,S=this.getPropFromConfig("xProperty"),w=this.getPropFromConfig("yProperty"),P=this.getPropFromConfig("seriesProperty");i&&(P={id:null,name:null});let A=this.getPropFromConfig("startProperty"),x=this.getPropFromConfig("endProperty"),I=this.getPropFromConfig("dueProperty"),M=this.getPropFromConfig("scheduledProperty"),H=this.getPropFromConfig("durationProperty"),K=this.getPropFromConfig("groupProperty");if(!a&&!S.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'Category / group' property in view options."});return}if(d&&(!S.id||!w.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(A.id||x.id||M.id||I.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Scheduled/Due with Duration."});return}let v;if(a)v=this.buildRowsForGantt(e,S,P,A,x,I,M,H,K);else if(d)v=this.buildRowsForScatter(e,S,w,P);else{let q=i;v=this.buildRowsForAggregatedCharts(e,S,w,P,f,g,q)}if(!v.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let E={rows:v},D=((Y=r==null?void 0:r.get("title"))!=null?Y:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",C=r==null?void 0:r.get("drilldown"),b=typeof C=="boolean"?C:!0,R=this.buildEncoding({x:S,y:w,series:P,start:A,end:x,due:I,duration:H,group:K,aggMode:f,xBucket:g,chartType:s}),T={type:s,source:{type:"properties",query:""},encoding:R,options:{title:D,drilldown:b}},F={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,T,E,F)}getPropFromConfig(t){var d,a;let e=this.config,r=(d=e==null?void 0:e.get)==null?void 0:d.call(e,t);if(!r)return{id:null,name:null};let s=r.trim();if(!s||s==="undefined"||s==="null")return{id:null,name:null};let i=s;try{let c=(0,jt.parsePropertyId)(i);return{id:i,name:(a=c.name)!=null?a:i}}catch(c){return{id:i,name:i}}}readValue(t,e){if(!e.id)return null;let r;try{r=t.getValue(e.id)}catch(s){return null}if(r==null)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(s){}try{let s=r.toString();if(s==null)return null;let i=String(s).trim();return i.length?i:null}catch(s){return null}}parseDate(t){if(!t)return null;let e=new Date(t.trim());return Number.isNaN(e.getTime())?null:e}compareX(t,e){let r=this.parseDate(t!=null?String(t):null),s=this.parseDate(e!=null?String(e):null);if(r&&s)return r.getTime()-s.getTime();let i=Number(t),d=Number(e);return!Number.isNaN(i)&&!Number.isNaN(d)?i-d:String(t!=null?t:"").localeCompare(String(e!=null?e:""))}fmtDate(t){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${r}-${s}`}startOfWeek(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(e.getDay()+6)%7;return e.setDate(e.getDate()-r),e.setHours(0,0,0,0),e}bucketX(t,e){let r=this.parseDate(t);if(!r)return t;switch(e){case"none":case"auto":return t;case"day":return this.fmtDate(new Date(r.getFullYear(),r.getMonth(),r.getDate()));case"week":{let s=this.startOfWeek(r);return`${this.fmtDate(s)} (W)`}case"month":{let s=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${s}`}case"quarter":{let s=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${s}`}case"year":return`${r.getFullYear()}`;default:return t}}getXValuesForEntry(t,e,r,s){var h,f;let i=[],d=m=>this.bucketX(m,r);if(!e.id){let m=t.file,g=m!=null&&m.name?String(m.name):String((h=m==null?void 0:m.path)!=null?h:Xt);return i.push(d(g)),i}if(!s){let m=(f=this.readValue(t,e))!=null?f:Xt;return i.push(d(m)),i}let a=null;try{a=t.getValue(e.id)}catch(m){a=null}let c=m=>{if(!m)return;let g=String(m).trim();g&&i.push(d(g))};if(a==null)c(Xt);else if(typeof a=="string"){let m=a.trim();if(m){let g=m.split(/\s+/);for(let S of g)c(S)}}else if(Array.isArray(a))for(let m of a){if(m==null)continue;let g;try{g=m.toString()}catch(S){continue}c(g)}else if(typeof a.toArray=="function"){let m=a.toArray();if(Array.isArray(m))for(let g of m){if(g==null)continue;let S;try{S=g.toString()}catch(w){continue}c(S)}else{let g;try{g=a.toString()}catch(S){g=""}c(g)}}else{let m;try{m=a.toString()}catch(g){m=""}c(m)}return i.length||c(Xt),i}buildRowsForAggregatedCharts(t,e,r,s,i,d,a){let c=new Map,h=a||i==="count"||!r.id&&i!=="sum",f=r.name||"y";for(let g of t)for(let S of g.entries){let w=S.file,P=this.getXValuesForEntry(S,e,d,a),A=1,x=null;if(!h&&r.id){if(x=this.readValue(S,r),x==null)continue;let H=Number(x);if(Number.isNaN(H))continue;A=H}else A=1;let I=this.readValue(S,s),M=I!=null?String(I):void 0;for(let H of P){let K=`${H}@@${M!=null?M:""}`,v=c.get(K);v||(v={x:H,y:0,series:M,notes:[],props:{}},c.set(K,v)),v.y+=A,w!=null&&w.path&&v.notes.push(w.path),v.props&&e.name&&(v.props[e.name]=H),!h&&v.props&&f&&x!=null&&(v.props[f]=v.y),h&&v.props&&(v.props[f]=v.y),v.props&&s.name&&I!=null&&(v.props[s.name]=I)}}let m=Array.from(c.values());return i==="cumulative-sum"?this.toCumulative(m):m}toCumulative(t){var s,i;let e=new Map;for(let d of t){let a=(s=d.series)!=null?s:"__no_series__",c=e.get(a);c||(c=[],e.set(a,c)),c.push(d)}let r=[];for(let[,d]of e){let a=[...d].sort((h,f)=>this.compareX(h.x,f.x)),c=0;for(let h of a){let f=Number((i=h.y)!=null?i:0);Number.isNaN(f)||(c+=f,r.push({...h,y:c}))}}return r}buildRowsForScatter(t,e,r,s){let i=[];for(let d of t)for(let a of d.entries){let c=a.file,h=this.readValue(a,e),f=this.readValue(a,r);if(h==null||f==null)continue;let m=Number(h),g=Number(f);if(Number.isNaN(m)||Number.isNaN(g))continue;let S=this.readValue(a,s),w=S!=null?String(S):void 0;i.push({x:m,y:g,series:w,notes:c!=null&&c.path?[c.path]:[],props:{}})}return i}buildRowsForGantt(t,e,r,s,i,d,a,c,h){var S,w;let f=[];for(let P of t)for(let A of P.entries){let x=A.file,I=this.readValue(A,s),M=this.readValue(A,i),H=this.readValue(A,d),K=this.readValue(A,a),v=this.readValue(A,c),E=v!=null?Number(v):NaN,l=Number.isFinite(E)&&E>0,D=this.parseDate(I),C=this.parseDate(M),b=this.parseDate(H),R=this.parseDate(K),T=D,F=C,G=l?E*6e4:36e5;if(T&&F||(T&&l&&!F?F=new Date(T.getTime()+G):!T&&R&&l&&!F?(F=R,T=new Date(R.getTime()-G)):!T&&!R&&b&&l&&!F?(F=b,T=new Date(b.getTime()-G)):!T&&!F&&R&&!l?(T=R,F=new Date(R.getTime()+36e5)):T&&!F&&!l?F=new Date(T.getTime()+36e5):!T&&!F&&b&&!l?(T=b,F=new Date(b.getTime()+36e5)):!T&&F&&l?T=new Date(F.getTime()-G):!T&&F&&!l&&(T=new Date(F.getTime()-36e5))),!T||!F)continue;if(T.getTime()>F.getTime()){let y=T;T=F,F=y}let B=(w=this.readValue(A,e))!=null?w:x!=null&&x.name?String(x.name).replace(/\.md$/i,""):String((S=x==null?void 0:x.path)!=null?S:""),Y=this.readValue(A,r),q=Y!=null?String(Y):void 0,$=this.readValue(A,h),p={};s.name&&T&&(p[s.name]=T),i.name&&F&&(p[i.name]=F),a.name&&R&&(p[a.name]=R),d.name&&b&&(p[d.name]=b),l&&c.name&&(p[c.name]=E),h.name&&$!=null&&(p[h.name]=$),f.push({x:B,y:0,series:q,start:T,end:F,due:b!=null?b:void 0,notes:x!=null&&x.path?[x.path]:[],props:p})}return f}buildEncoding(t){var s,i,d,a,c,h,f,m;let e=(s=t.x.name)!=null?s:"x",r=(i=t.y.name)!=null?i:"y";return{x:e,y:r,series:(d=t.series.name)!=null?d:"series",start:(a=t.start.name)!=null?a:"start",end:(c=t.end.name)!=null?c:"end",due:(h=t.due.name)!=null?h:"due",duration:(f=t.duration.name)!=null?f:"duration",group:(m=t.group.name)!=null?m:"group"}}};var Re=require("obsidian"),Zt=class{constructor(n){this.index=new Map;this.app=n}async buildIndex(){this.index.clear();let n=this.app.vault.getMarkdownFiles();for(let t of n)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(n){if(n.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(n)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,Re.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[d,a]of Object.entries(i))d!=="position"&&(t[d]=a)}let s=this.app.metadataCache.getFileCache(n);s!=null&&s.tags&&!t.tags&&(t.tags=s.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",n.path,e)}this.index.set(n.path,{path:n.path,props:t})}removeFile(n){this.index.delete(n.path)}};function Pe(o,n){if(!n||n.length===0)return!0;for(let t of n){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Le(o,n){if(!n||n.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of n)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let e=String(t);for(let r of n)if(e===r||e==="#"+r)return!0;return!1}function te(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function $t(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,r]=o.split("-");return new Date(Number(t),Number(e)-1,Number(r),0,0,0,0)}let n=new Date(o);return isNaN(n.getTime())?null:n}function ut(o){let n=new Date(o);return n.setHours(0,0,0,0),n}function Jt(o,n){let t=new Date(o);return t.setDate(t.getDate()-n),t}function rn(o,n){return Jt(o,n*7)}function sn(o,n){let t=new Date(o);return t.setMonth(t.getMonth()-n),t}function pe(o,n){let t=new Date(o);return t.setDate(t.getDate()+n),t}function on(o,n){return pe(o,n*7)}function an(o,n){let t=new Date(o);return t.setMonth(t.getMonth()+n),t}function Ne(o){let n=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(n)||n.endsWith("date")||n.endsWith("at")||n.endsWith("on"))}function ke(o,n){let t=n?new Date(n):new Date,e=ut(t),r=o.trim().toLowerCase();if(r==="today")return e;if(r==="yesterday")return ut(Jt(e,1));if(/^-\d+$/.test(r)){let s=parseInt(r.slice(1),10);return ut(Jt(e,s))}if(/^-\d+d$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(Jt(e,s))}if(/^-\d+w$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(rn(e,s))}if(/^-\d+m$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(sn(e,s))}if(/^\+\d+$/.test(r)){let s=parseInt(r.slice(1),10);return ut(pe(e,s))}if(/^\+\d+d$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(pe(e,s))}if(/^\+\d+w$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(on(e,s))}if(/^\+\d+m$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(an(e,s))}return null}function Ie(o){let n=o.trim(),t=n.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let h=t[1].trim(),f=t[2].trim(),m=t[3].trim(),g=Ne(h),S=de(f,g),w=de(m,g),P=S.valueType==="date"||w.valueType==="date"?"date":S.valueType;return{field:h,op:"between",value:S.value,value2:w.value,valueType:P}}let e=/(==|!=|>=|<=|>|<)/,r=n.split(e);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let s=r[0].trim(),i=r[1].trim(),d=r[2].trim(),a=Ne(s),c=de(d,a);return{field:s,op:i,value:c.value,valueType:c.valueType}}function de(o,n){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),r=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(n){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=ke(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=ke(t);if(i)return{value:i,valueType:"date"}}if(te(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let s=Number(t);return Number.isNaN(s)?{value:t,valueType:"string"}:{value:s,valueType:"number"}}function _e(o,n){let t=o[n.field];if(t==null)return!1;if(n.valueType==="date"){let s=t instanceof Date?ut(t):te(t)?ut($t(t)):null;if(!s)return!1;let i=n.value instanceof Date?n.value:null,d=n.value2 instanceof Date?n.value2:null;if(!i)return!1;let a=s.getTime(),c=ut(i).getTime();switch(n.op){case"==":return a===c;case"!=":return a!==c;case">":return a>c;case">=":return a>=c;case"<":return a<c;case"<=":return a<=c;case"between":if(!d)return!1;let h=ut(d).getTime();return a>=c&&a<=h}}if(n.valueType==="number"){let s=Number(t);if(isNaN(s))return!1;let i=Number(n.value);switch(n.op){case"==":return s===i;case"!=":return s!==i;case">":return s>i;case">=":return s>=i;case"<":return s<i;case"<=":return s<=i;case"between":return typeof n.value2!="number"?!1:s>=i&&s<=n.value2}}let e=String(t),r=String(n.value);switch(n.op){case"==":return e===r;case"!=":return e!==r;case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r;case"between":return!1}}function cn(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(te(o)){let n=$t(o);if(n)return{key:n,isDate:!0}}return{key:o,isDate:!1}}function ln(o,n){let t=o.x,e=n.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let r=String(t),s=String(e);return r<s?-1:r>s?1:0}function un(o,n){var s,i;let t=ln(o,n);if(t!==0)return t;let e=(s=o.series)!=null?s:"",r=(i=n.series)!=null?i:"";return e<r?-1:e>r?1:0}function dn(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let n=o.trim().match(/^(\d+)/);if(n){let t=Number(n[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function pn(o){var e,r;let n=new Map,t=[];for(let s of o){let i=(e=s.series)!=null?e:"__no_series__",a=((r=n.get(i))!=null?r:0)+s.y;n.set(i,a),t.push({...s,y:a})}return t}function hn(o,n){var i,d;let t=dn(n);if(!t||t<=1)return[...o];let e=new Map,r=new Map,s=[];for(let a of o){let c=(i=a.series)!=null?i:"__no_series__",h=e.get(c);h||(h=[],e.set(c,h));let f=(d=r.get(c))!=null?d:0;if(h.push(a.y),f+=a.y,h.length>t){let S=h.shift();f-=S}r.set(c,f);let m=h.length||1,g=f/m;s.push({...a,y:g})}return s}var ee=class{constructor(n,t){this.getIndex=n,this.defaultPaths=t}run(n){var i,d,a;let t=this.getIndex(),e=(i=n.source)!=null&&i.paths&&n.source.paths.length?n.source.paths:this.defaultPaths,r=(d=n.source)!=null&&d.tags&&n.source.tags.length?n.source.tags:[],s=[];for(let c of t){let h=e&&e.length?Pe(c.path,e):!0,f=r&&r.length?Le(c.props,r):!0;if(!h||!f)continue;let m=!0;if((a=n.source)!=null&&a.where&&n.source.where.length>0)for(let g of n.source.where){let S;try{S=Ie(g)}catch(w){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${g} (${w.message})`)}if(!_e(c.props,S)){m=!1;break}}m&&s.push(c)}return n.type==="gantt"?this.runGantt(n,s):n.type==="table"?this.runTable(n,s):this.runStandard(n,s)}runTable(n,t){var r,s;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=n.encoding)==null?void 0:r.x,yField:(s=n.encoding)==null?void 0:s.y}}runGantt(n,t){var f,m,g;let e=(f=n.encoding)!=null?f:{},r=e.start,s=e.end,i=(m=e.label)!=null?m:e.x,d=e.series,a=e.duration,c=e.due,h=[];for(let S of t){let w=(g=S.props)!=null?g:{},P=v=>Array.isArray(v)?v[0]:v,A=null;if(s){let v=P(w[s]),E=$t(v);E&&(A=E)}if(!A)continue;let x=null;if(r){let v=P(w[r]),E=$t(v);E&&(x=E)}if(!x&&a){let v=P(w[a]),E=Number(v);Number.isNaN(E)||(x=new Date(A.getTime()-E*6e4))}x||(x=new Date(A.getTime()));let I;if(c){let v=P(w[c]),E=$t(v);E&&(I=E)}let M;if(i){let v=P(w[i]);(v==null||v==="")&&(v=S.path),M=v}else M=S.path;let H;if(d){let v=P(w[d]);v!=null&&(H=String(v))}let K={x:M,y:0,notes:[S.path],series:H,start:x,end:A,props:w};I&&(K.due=I),h.push(K)}return h.sort((S,w)=>{let P=S.start?S.start.getTime():0,A=w.start?w.start.getTime():0;return P-A}),{rows:h,xField:i,yField:s}}runStandard(n,t){var S,w,P,A,x,I,M,H,K,v;let e=(S=n.encoding)==null?void 0:S.x,r=(w=n.encoding)==null?void 0:w.y,s=(P=n.encoding)==null?void 0:P.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(A=n.aggregate)!=null?A:{},d=(x=i.y)!=null?x:null,a=!!i.cumulative,c=i.rolling;if(!r&&d!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let h=[];for(let E of t){let l=(I=E.props)!=null?I:{},D=B=>Array.isArray(B)?B[0]:B,C=D(l[e]);if(C==null)continue;let b=cn(C),R=b.key,T=b.isDate,F;if(s){let B=D(l[s]);B!=null&&String(B).trim()!==""&&(F=String(B))}let G;if(d==="count")G=1;else{let B=D(l[r]);if(B==null)continue;let Y=Number(B);if(Number.isNaN(Y))continue;G=Y}h.push({x:R,y:G,notes:[E.path],series:F,props:l,_isDate:T,_origX:C})}if(h.length===0)return{rows:[],xField:e,yField:r};let f=[];if(d){let E=new Map;for(let l of h){let D=(M=l.series)!=null?M:"",C=l.x instanceof Date?l.x.toISOString().slice(0,10):String(l.x),b=D+"||"+C,R=(H=E.get(b))!=null?H:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:l.x,isDate:l._isDate,series:l.series,props:l.props};R.sum+=l.y,R.count+=1,l.y<R.min&&(R.min=l.y),l.y>R.max&&(R.max=l.y),R.notes.push(...l.notes),R.props=(K=l.props)!=null?K:R.props,E.set(b,R)}for(let[,l]of E){let D=l.sum;switch(d){case"sum":D=l.sum;break;case"avg":D=l.sum/l.count;break;case"min":D=l.min;break;case"max":D=l.max;break;case"count":D=l.count;break}f.push({x:l.xRep,y:D,notes:l.notes,series:l.series,props:l.props})}}else f=h.map(E=>({x:E.x,y:E.y,notes:E.notes,series:E.series,props:E.props}));if(f.length===0)return{rows:[],xField:e,yField:r};let m=((v=n.sort)==null?void 0:v.x)==="desc"?"desc":"asc";if(f.sort((E,l)=>{let D=un(E,l);return m==="asc"?D:-D}),(a||c)&&!(n.type==="line"||n.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&c)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let g=f;return c?g=hn(f,c):a&&(g=pn(f)),{rows:g,xField:e,yField:r}}};var Ct=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,n){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,r)=>e*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(o,n){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,n&&(e.style.background=n);let r="http://www.w3.org/2000/svg",s=document.createElementNS(r,"svg");s.setAttribute("width","100%"),s.setAttribute("height",String(300)),s.style.display="block",e.appendChild(s);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let d=o.createDiv({cls:"chart-notes-details"});return d.style.display="none",{scroll:t,inner:e,svg:s,tooltip:i,details:d}}function ft(o,n,t,e,r,s){let i=o.getBoundingClientRect(),d=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);n.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${d}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,n.style.display="block";let a=n.getBoundingClientRect(),c=s.clientX-i.left+6,h=s.clientY-i.top+6;c+a.width>i.width-4&&(c=i.width-a.width-4),c<4&&(c=4),h+a.height>i.height-4&&(h=i.height-a.height-4),h<4&&(h=4),n.style.left=c+"px",n.style.top=h+"px"}function gt(o){o.style.display="none"}function yt(o,n,t,e,r,s){if(!s)return;if(n.empty(),!r||r.length===0){n.style.display="none";return}n.style.display="block";let i=n.createEl("div",{cls:"chart-notes-details-header"}),d=i.createEl("div",{cls:"chart-notes-details-title"});d.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{n.style.display="none"});let c=n.createEl("ul",{cls:"chart-notes-details-list"});for(let h of r){let m=c.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:h});m.href="#",m.addEventListener("click",g=>{g.preventDefault(),app.workspace.openLinkText(h,"",!1)})}}function Qt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let n=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${n}/${t}`}function $e(o){if(!o)return!1;let n=o.trim().toLowerCase();if(n==="#fff"||n==="#ffffff"||n==="white")return!0;if(!n.startsWith("#"))return!1;let t,e,r;if(n.length===4)t=parseInt(n[1]+n[1],16),e=parseInt(n[2]+n[2],16),r=parseInt(n[3]+n[3],16);else if(n.length===7)t=parseInt(n.slice(1,3),16),e=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*r)/255>.7}var he=class extends Ct.Modal{constructor(t,e,r,s){var d;super(app);this.notePath=t,this.spec=e,this.refresh=r,this.reindexFile=s;let i=(d=e.encoding)!=null?d:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var v,E;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(e),s={},i=r,d=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(d){try{s=(v=(0,Ct.parseYaml)(d[1]))!=null?v:{}}catch(l){s={}}i=r.slice(d[0].length)}(typeof s!="object"||s==null)&&(s={});let a=(E=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?E:this.notePath,c=t.createDiv({cls:"gantt-edit-header"}),h=c.createEl("a",{text:a,cls:"gantt-edit-title"});h.href="#",h.addEventListener("click",l=>{l.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let f=c.createDiv({cls:"gantt-edit-subtitle"});f.textContent=this.notePath;let m=t.createDiv({cls:"gantt-edit-form"}),g=l=>{let D=m.createDiv({cls:"gantt-edit-row"}),C=D.createDiv({cls:"gantt-edit-label"});C.textContent=l;let b=D.createDiv({cls:"gantt-edit-field"});return{row:D,field:b}},S=l=>{if(!l)return"";let C=String(l).match(/^(\d{4}-\d{2}-\d{2})/);return C?C[1]:""},w=l=>{if(l=l.trim(),!!l&&/^\d{4}-\d{2}-\d{2}$/.test(l))return l},P=null;if(this.startKey){let{field:l}=g(this.startKey+" (in\xEDcio)");P=l.createEl("input",{type:"date"}),P.value=S(s[this.startKey])}let A=null;if(this.endKey){let{field:l}=g(this.endKey+" (fim)");A=l.createEl("input",{type:"date"}),A.value=S(s[this.endKey])}let x=null;if(this.durationKey){let{field:l}=g(this.durationKey+" (minutos)");x=l.createEl("input",{type:"number"});let D=s[this.durationKey];x.value=D!=null?String(D):"",x.min="0",x.step="5"}let I=null;if(this.dueKey){let{field:l}=g(this.dueKey+" (due)");I=l.createEl("input",{type:"date"}),I.value=S(s[this.dueKey])}let M=t.createDiv({cls:"gantt-edit-buttons"}),H=M.createEl("button",{text:"Salvar",cls:"mod-cta"});M.createEl("button",{text:"Cancelar"}).addEventListener("click",l=>{l.preventDefault(),this.close()}),H.addEventListener("click",async l=>{if(l.preventDefault(),this.startKey&&P){let b=w(P.value);b?s[this.startKey]=b:delete s[this.startKey]}if(this.endKey&&A){let b=w(A.value);b?s[this.endKey]=b:delete s[this.endKey]}if(this.durationKey&&x){let b=x.value.trim();if(b==="")delete s[this.durationKey];else{let R=Number(b);Number.isNaN(R)||(s[this.durationKey]=R)}}if(this.dueKey&&I){let b=w(I.value);b?s[this.dueKey]=b:delete s[this.dueKey]}let C=`---
${(0,Ct.stringifyYaml)(s).trim()}
---
`+i;if(await this.app.vault.modify(e,C),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(b){}if(this.refresh)try{this.refresh()}catch(b){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(o,n,t,e){var be,xe,Se,ve,we,Ae,Ee,De;let r=(be=n.options)!=null?be:{},s=r.background,i=(xe=r.drilldown)!=null?xe:!0,d=!0,a=u=>{if(u==null)return"";let L=String(u).trim();if(!L)return"";let Q=L.match(/^\[\[(.+?)\]\]$/);Q&&(L=Q[1]);let X=L.lastIndexOf("/");return X>=0&&X<L.length-1&&(L=L.slice(X+1)),L};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(u=>u.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let c=t.rows.filter(u=>u.start&&u.end);if(c.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let h=n.encoding,f=h.group,m=h.duration,g=(u,L)=>{if(!u||!L)return;let Q=u[L];return Array.isArray(Q)?Q[0]:Q},w=c.map(u=>{var xt,lt;let L=u.start,Q=u.end,X=u.props,It=typeof u.x=="string"?u.x:u.x instanceof Date?Qt(L):String(u.x),At=a(It),bt,_t=f?g(X,f):void 0;_t!=null?bt=String(_t):u.series!=null?bt=String(u.series):bt=At;let mt=(xt=u.notes)==null?void 0:xt[0],Et=mt?(lt=mt.replace(/\.md$/i,"").split("/").pop())!=null?lt:mt:At,Tt=u.due,Ft,kt=g(X,m);if(kt!=null){let St=Number(kt);Number.isNaN(St)||(Ft=St)}return{row:u,start:L,end:Q,props:X,fullName:At,groupKey:bt,notePath:mt,noteTitle:Et,due:Tt,estMinutes:Ft}}).filter(u=>u.start instanceof Date&&!isNaN(u.start.getTime())&&u.end instanceof Date&&!isNaN(u.end.getTime()));if(w.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}w.sort((u,L)=>{if(u.groupKey<L.groupKey)return-1;if(u.groupKey>L.groupKey)return 1;let Q=u.start.getTime(),X=L.start.getTime();return Q!==X?Q-X:u.fullName.localeCompare(L.fullName)});let P=26,A=0,x=null;for(let u of w)u.groupKey!==x&&(x=u.groupKey,A+=1),A+=1;let I=Math.min(...w.map(u=>u.start.getTime())),M=Math.max(...w.map(u=>u.end.getTime()));if(!isFinite(I)||!isFinite(M)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let H=24*60*60*1e3,K=u=>{let L=new Date(u);return L.setHours(0,0,0,0),L.getTime()},v=K(I),E=K(M),l=o.querySelector(".prop-charts-title-row");l||(l=o.createDiv({cls:"prop-charts-title-row"}));let D=o.dataset.ganttZoomMode||String((Se=r.zoomMode)!=null?Se:"100");o.dataset.ganttZoomMode=D;let C=o.dataset.ganttLabelMode||String((ve=r.labelMode)!=null?ve:"compact");o.dataset.ganttLabelMode=C;let b=l.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(u=>{let L=b.createEl("button",{cls:"gantt-zoom-btn",text:u.label});u.id===D&&L.addClass("is-active"),L.addEventListener("click",Q=>{Q.preventDefault(),o.dataset.ganttZoomMode=u.id,ne(o,n,t,e)})}),b.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",u=>{u.preventDefault();let L=o.querySelector(".chart-notes-zoom-button");L&&L.click()});let F=Number(r.labelWidth),G=!Number.isNaN(F)&&F>120?F:260,B=C==="wide"?G+160:G,Y=o.getBoundingClientRect().width||600,q=Math.max(Y,820),$;if(D==="fit")$=Y;else{let u=Number(D)/100||1;$=q*u}let{inner:p,svg:y,tooltip:N,details:k}=wt(o,s);p.style.width=$+"px";let _=(u,L,Q,X,It,At,bt,_t,mt)=>{if(!u)return;let Et=Math.max(40,X-8),Ft=Math.max(8,Math.floor(Et/6)),kt=u.split(/\s+/),xt=[],lt="";for(let Mt of kt){if(!lt){lt=Mt;continue}(lt+" "+Mt).length<=Ft?lt+=" "+Mt:(xt.push(lt),lt=Mt)}lt&&xt.push(lt);let St=It+2,Gt=xt.length*St,Vt=Q-Gt/2+It;xt.forEach((Mt,Yt)=>{let ot=document.createElementNS(y.namespaceURI,"text");ot.setAttribute("x",String(L)),ot.setAttribute("y",String(Vt+Yt*St)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Mt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),_t&&ot.addEventListener("mouseleave",()=>_t()),mt&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>mt(rt))),y.appendChild(ot)})},tt=28,V=28,st=10,j=Math.max(300,tt+V+A*P+24);y.setAttribute("height",String(j));let W=$-B-st,z=tt+6;y.style.color="#111111";let et=E+H-v||1,at=v-et*.02,ht=E+H+et*.08,ct=u=>B+(u-at)/(ht-at)*W,U=(ht-at)/H,Nt=Math.max(4,Math.min(12,Math.floor(W/90)||4)),dt=U/Nt,J=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=J[J.length-1];for(let u of J)if(u>=dt){pt=u;break}let Ut=[],Ke=K(at);for(let u=Ke;u<=ht+.5*H;u+=pt*H)Ut.push(u);let Bt=document.createElementNS(y.namespaceURI,"line");Bt.setAttribute("x1",String(B)),Bt.setAttribute("y1",String(z)),Bt.setAttribute("x2",String($-st)),Bt.setAttribute("y2",String(z)),Bt.setAttribute("stroke","#111111"),y.appendChild(Bt);for(let u of Ut){let L=ct(u),Q=document.createElementNS(y.namespaceURI,"line");Q.setAttribute("x1",String(L)),Q.setAttribute("y1",String(z)),Q.setAttribute("x2",String(L)),Q.setAttribute("y2",String(j-V)),Q.setAttribute("stroke","#111111"),Q.setAttribute("stroke-opacity","0.20"),Q.setAttribute("stroke-dasharray","2,4"),y.appendChild(Q);let X=document.createElementNS(y.namespaceURI,"text");X.setAttribute("x",String(L)),X.setAttribute("y",String(z-4)),X.setAttribute("text-anchor","middle"),X.setAttribute("font-size","10"),X.setAttribute("fill","#111111"),X.textContent=Qt(new Date(u)),y.appendChild(X)}let ye=new Date;ye.setHours(0,0,0,0);let ie=ye.getTime();if(ie>=at&&ie<=ht){let u=ct(ie),L=document.createElementNS(y.namespaceURI,"line");L.setAttribute("x1",String(u)),L.setAttribute("y1",String(z)),L.setAttribute("x2",String(u)),L.setAttribute("y2",String(j-V)),L.setAttribute("stroke","#4caf50"),L.setAttribute("stroke-width","2"),L.setAttribute("stroke-dasharray","4,2"),y.appendChild(L);let Q=document.createElementNS(y.namespaceURI,"text");Q.setAttribute("x",String(u+4)),Q.setAttribute("y",String(z+12)),Q.setAttribute("font-size","10"),Q.setAttribute("fill","#4caf50"),Q.textContent="hoje",y.appendChild(Q)}let zt=p.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});zt.setAttr("title",C==="wide"?"Compactar nomes":"Expandir nomes"),zt.style.left=`${B}px`,zt.style.top="4px",zt.addEventListener("click",u=>{u.preventDefault();let Q=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=Q,ne(o,n,t,e)});let Ue=["status","priority"],ae=Array.isArray(r.tooltipFields)?r.tooltipFields.map(u=>String(u)):null,Ve=ae&&ae.length?ae:Ue,Ht=0,ce=null;for(let u of w){let L=u.start,Q=u.end,X=(Q.getTime()-L.getTime())/6e4,It=u.props,At=u.notePath,bt=u.noteTitle,_t=(Ae=(we=u.row.notes)==null?void 0:we.length)!=null?Ae:0,mt=u.due,Et=u.estMinutes,Tt=[];Tt.push(`${Qt(L)} \u2192 ${Qt(Q)}`),typeof Et=="number"&&!Number.isNaN(Et)?Tt.push(`est: ${Math.round(Et)} min`):X>0&&Tt.push(`dura\xE7\xE3o: ${Math.round(X)} min`),mt instanceof Date&&Tt.push(`due: ${Qt(mt)}`);for(let nt of Ve){let O=g(It,nt);O!=null&&String(O).trim()!==""&&Tt.push(`${nt}: ${String(O)}`)}let Ft=Tt.join("<br>"),kt=nt=>{var O;nt.preventDefault(),d&&At?new he(At,n,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(o,k,bt,Et!=null?Et:X,(O=u.row.notes)!=null?O:[],i)},xt=nt=>{bt&&Ft&&ft(o,N,bt,Ft,_t,nt)},lt=()=>gt(N);if(u.groupKey!==ce){ce=u.groupKey;let nt=z+8+Ht*P+P/2,O=a(ce);_(O,4,nt,B-12,11,"600"),Ht+=1}let St=z+8+Ht*P,Gt=P-10,Vt=ct(L.getTime()),Mt=ct(Q.getTime()),Yt=Math.max(4,Mt-Vt),ot=u.fullName,rt=document.createElementNS(y.namespaceURI,"rect");rt.setAttribute("x",String(Vt)),rt.setAttribute("y",String(St)),rt.setAttribute("width",String(Yt)),rt.setAttribute("height",String(Gt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ee=u.row.series)!=null?Ee:ot,Ht)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=d&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",lt),rt.addEventListener("click",kt),y.appendChild(rt);let Ce=St+Gt/2;if(Yt>=6){let nt=it((De=u.row.series)!=null?De:ot,Ht),O=document.createElementNS(y.namespaceURI,"circle");O.setAttribute("cx",String(Vt)),O.setAttribute("cy",String(Ce)),O.setAttribute("r","3.5"),O.setAttribute("fill","#ffffff"),O.setAttribute("stroke",nt),O.setAttribute("stroke-width","1.5"),y.appendChild(O);let Pt=document.createElementNS(y.namespaceURI,"circle");Pt.setAttribute("cx",String(Mt)),Pt.setAttribute("cy",String(Ce)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),y.appendChild(Pt)}let Te=St+Gt/2+2,Ot=f?16:4;if(C==="wide")_(ot,Ot,Te,B-Ot-4,11,null,xt,lt,kt);else{let nt=ot,O=Math.max(40,B-Ot-8),Me=Math.max(8,Math.floor(O/6));nt.length>Me&&(nt=nt.slice(0,Me-1)+"\u2026");let vt=document.createElementNS(y.namespaceURI,"text");vt.setAttribute("x",String(Ot)),vt.setAttribute("y",String(Te)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",xt),vt.addEventListener("mouseleave",lt),vt.addEventListener("click",kt),y.appendChild(vt)}if(mt instanceof Date){let nt=ct(mt.getTime()),O=document.createElementNS(y.namespaceURI,"line");O.setAttribute("x1",String(nt)),O.setAttribute("y1",String(St)),O.setAttribute("x2",String(nt)),O.setAttribute("y2",String(St+Gt)),O.setAttribute("stroke","#ff6b6b"),O.setAttribute("stroke-width","2"),O.setAttribute("stroke-dasharray","4,2"),y.appendChild(O)}Ht+=1}if(d){let u=o.createDiv({cls:"prop-charts-empty"});u.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function me(o,n,t){var B,Y,q,$;let e=(B=n.options)!=null?B:{},r=e.background,s=(Y=e.drilldown)!=null?Y:!0,i=(q=t.rows)!=null?q:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:d,svg:a,tooltip:c,details:h}=wt(o,r),f=o.getBoundingClientRect().width||600,m=Math.max(f,480);d.style.width=m+"px";let g=40,S=16,w=18,P=28,A=300;a.setAttribute("height",String(A));let x=m-g-S,I=A-w-P,M=new Map;for(let p of i){let y=String(p.x),N=($=M.get(y))!=null?$:{label:p.x,rows:[]};N.rows.push(p),M.set(y,N)}let K=Array.from(M.keys()).sort((p,y)=>p<y?-1:p>y?1:0).map(p=>M.get(p)),v=K.length,E=new Set;i.forEach(p=>{p.series!=null&&E.add(String(p.series))});let l=Array.from(E),D=l.length>1,C=D?"grouped":"single",b=0;i.forEach(p=>{p.y>b&&(b=p.y)}),(!isFinite(b)||b<=0)&&(b=1);let R=p=>w+I-p/(b||1)*I,T=R(0),F=4;for(let p=0;p<=F;p++){let y=b*p/F,N=R(y),k=document.createElementNS(a.namespaceURI,"line");k.setAttribute("x1",String(g)),k.setAttribute("y1",String(N)),k.setAttribute("x2",String(m-S)),k.setAttribute("y2",String(N)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),a.appendChild(k);let _=document.createElementNS(a.namespaceURI,"text");_.setAttribute("x",String(g-4)),_.setAttribute("y",String(N+3)),_.setAttribute("text-anchor","end"),_.setAttribute("font-size","10"),_.setAttribute("fill","#111111"),_.textContent=String(Math.round(y)),a.appendChild(_)}let G=v>0?x/v:x;if(K.forEach((p,y)=>{let N=g+G*(y+.5),k=String(p.label),_=document.createElementNS(a.namespaceURI,"text");_.setAttribute("x",String(N)),_.setAttribute("y",String(A-P+12)),_.setAttribute("text-anchor","middle"),_.setAttribute("font-size","10"),_.setAttribute("fill","#111111"),_.textContent=k,a.appendChild(_)}),D){let p=o.createDiv({cls:"chart-notes-legend"});l.forEach((y,N)=>{let k=p.createDiv({cls:"chart-notes-legend-item"}),_=k.createDiv();_.style.width="10px",_.style.height="10px",_.style.borderRadius="999px",_.style.backgroundColor=it(y,N),k.createSpan({text:y})})}K.forEach((p,y)=>{let N=g+G*(y+.5),k=p.rows;if(C==="single"){let j=k[0],W=j.y,z=G*.6,et=N-z/2,at=R(W),ht=Math.max(2,T-at),ct=it("bar",y),U=document.createElementNS(a.namespaceURI,"rect");U.setAttribute("x",String(et)),U.setAttribute("y",String(at)),U.setAttribute("width",String(z)),U.setAttribute("height",String(ht)),U.setAttribute("fill",ct),U.setAttribute("stroke","rgba(0,0,0,0.25)"),U.setAttribute("stroke-width","0.5"),U.style.cursor="pointer";let Z=String(p.label),Nt=`valor: ${Math.round(W*100)/100}`;U.addEventListener("mouseenter",dt=>{var J,pt;return ft(o,c,Z,Nt,(pt=(J=j.notes)==null?void 0:J.length)!=null?pt:0,dt)}),U.addEventListener("mouseleave",()=>gt(c)),U.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(o,h,Z,W,(J=j.notes)!=null?J:[],s)}),a.appendChild(U);return}let _=l.length,tt=G/Math.max(_+1,2),V=_*tt,st=N-V/2;l.forEach((j,W)=>{let z=k.find(J=>(J.series!=null?String(J.series):"")===j);if(!z)return;let et=z.y,at=st+W*tt,ht=R(et),ct=Math.max(2,T-ht),U=it(j,W),Z=document.createElementNS(a.namespaceURI,"rect");Z.setAttribute("x",String(at)),Z.setAttribute("y",String(ht)),Z.setAttribute("width",String(tt)),Z.setAttribute("height",String(ct)),Z.setAttribute("fill",U),Z.setAttribute("stroke","rgba(0,0,0,0.25)"),Z.setAttribute("stroke-width","0.5"),Z.style.cursor="pointer";let Nt=`${j} @ ${String(p.label)}`,dt=`valor: ${Math.round(et*100)/100}`;Z.addEventListener("mouseenter",J=>{var pt,Ut;return ft(o,c,Nt,dt,(Ut=(pt=z.notes)==null?void 0:pt.length)!=null?Ut:0,J)}),Z.addEventListener("mouseleave",()=>gt(c)),Z.addEventListener("click",J=>{var pt;J.preventDefault(),yt(o,h,Nt,et,(pt=z.notes)!=null?pt:[],s)}),a.appendChild(Z)})})}function Be(o,n,t){var G,B,Y,q;let e=(G=n.options)!=null?G:{},r=e.background,s=(B=e.drilldown)!=null?B:!0,i=(Y=t.rows)!=null?Y:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:d,svg:a,tooltip:c,details:h}=wt(o,r),f=o.getBoundingClientRect().width||600,m=Math.max(f,480);d.style.width=m+"px";let g=40,S=16,w=18,P=28,A=300;a.setAttribute("height",String(A));let x=m-g-S,I=A-w-P,M=new Map;for(let $ of i){let p=String($.x),y=(q=M.get(p))!=null?q:{label:$.x,rows:[]};y.rows.push($),M.set(p,y)}let K=Array.from(M.keys()).sort(($,p)=>$<p?-1:$>p?1:0).map($=>M.get($)),v=K.length,E=new Set;i.forEach($=>{$.series!=null&&E.add(String($.series))});let l=Array.from(E);if(!l.length){me(o,n,t);return}let D=0;K.forEach($=>{let p=$.rows.reduce((y,N)=>y+N.y,0);p>D&&(D=p)}),(!isFinite(D)||D<=0)&&(D=1);let C=$=>w+I-$/(D||1)*I,b=C(0),R=4;for(let $=0;$<=R;$++){let p=D*$/R,y=C(p),N=document.createElementNS(a.namespaceURI,"line");N.setAttribute("x1",String(g)),N.setAttribute("y1",String(y)),N.setAttribute("x2",String(m-S)),N.setAttribute("y2",String(y)),N.setAttribute("stroke","#cccccc"),N.setAttribute("stroke-opacity","0.25"),a.appendChild(N);let k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(g-4)),k.setAttribute("y",String(y+3)),k.setAttribute("text-anchor","end"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=String(Math.round(p)),a.appendChild(k)}let T=v>0?x/v:x;K.forEach(($,p)=>{let y=g+T*(p+.5),N=String($.label),k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(y)),k.setAttribute("y",String(A-P+12)),k.setAttribute("text-anchor","middle"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=N,a.appendChild(k)});let F=o.createDiv({cls:"chart-notes-legend"});l.forEach(($,p)=>{let y=F.createDiv({cls:"chart-notes-legend-item"}),N=y.createDiv();N.style.width="10px",N.style.height="10px",N.style.borderRadius="999px",N.style.backgroundColor=it($,p),y.createSpan({text:$})}),K.forEach(($,p)=>{let y=g+T*(p+.5),N=T*.6,k=y-N/2,_=0;l.forEach((tt,V)=>{let st=$.rows.find(dt=>(dt.series!=null?String(dt.series):"")===tt);if(!st)return;let j=st.y,W=_,z=_+j;_=z;let et=C(W),at=C(z),ht=Math.max(2,et-at),ct=it(tt,V),U=document.createElementNS(a.namespaceURI,"rect");U.setAttribute("x",String(k)),U.setAttribute("y",String(at)),U.setAttribute("width",String(N)),U.setAttribute("height",String(ht)),U.setAttribute("fill",ct),U.setAttribute("stroke","rgba(0,0,0,0.25)"),U.setAttribute("stroke-width","0.5"),U.style.cursor="pointer";let Z=`${tt} @ ${String($.label)}`,Nt=`valor: ${Math.round(j*100)/100}`;U.addEventListener("mouseenter",dt=>{var J,pt;return ft(o,c,Z,Nt,(pt=(J=st.notes)==null?void 0:J.length)!=null?pt:0,dt)}),U.addEventListener("mouseleave",()=>gt(c)),U.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(o,h,Z,j,(J=st.notes)!=null?J:[],s)}),a.appendChild(U)})})}function fe(o,n,t,e){var B,Y,q,$;let r=(B=n.options)!=null?B:{},s=r.background,i=(Y=r.drilldown)!=null?Y:!0,d=(q=t.rows)!=null?q:[];if(!d.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:c,tooltip:h,details:f}=wt(o,s),m=o.getBoundingClientRect().width||600,g=Math.max(m,480);a.style.width=g+"px";let S=40,w=16,P=18,A=24,x=300;c.setAttribute("height",String(x));let I=g-S-w,M=x-P-A,H=new Map;for(let p of d){let y=p.series!=null?String(p.series):"__default__",N=($=H.get(y))!=null?$:[];N.push(p),H.set(y,N)}let K=Array.from(H.keys()),v=[],E=new Set;for(let p of d){let y=String(p.x);E.has(y)||(E.add(y),v.push(p.x))}let l=v.length||1,D=p=>{let y=String(p),N=v.findIndex(k=>String(k)===y);return N<0?S:l===1?S+I/2:S+N/(l-1)*I},C=p=>String(p),b=Number.POSITIVE_INFINITY,R=Number.NEGATIVE_INFINITY;for(let p of d)p.y<b&&(b=p.y),p.y>R&&(R=p.y);(!isFinite(b)||!isFinite(R))&&(b=0,R=1),b===R&&(b===0?R=1:b=0);let T=p=>P+M-(p-b)/(R-b||1)*M,F=4;for(let p=0;p<=F;p++){let y=b+(R-b)*p/F,N=T(y),k=document.createElementNS(c.namespaceURI,"line");k.setAttribute("x1",String(S)),k.setAttribute("y1",String(N)),k.setAttribute("x2",String(g-w)),k.setAttribute("y2",String(N)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),c.appendChild(k);let _=document.createElementNS(c.namespaceURI,"text");_.setAttribute("x",String(S-4)),_.setAttribute("y",String(N+3)),_.setAttribute("text-anchor","end"),_.setAttribute("font-size","10"),_.setAttribute("fill","#111111"),_.textContent=Math.abs(y)>=100?String(Math.round(y)):String(Math.round(y*10)/10),c.appendChild(_)}let G=K.filter(p=>p!=="__default__");if(G.length>1){let p=o.createDiv({cls:"chart-notes-legend"});G.forEach((y,N)=>{let k=y,_=p.createDiv({cls:"chart-notes-legend-item"}),tt=_.createDiv();tt.style.width="10px",tt.style.height="10px",tt.style.borderRadius="999px",tt.style.backgroundColor=it(k,N),_.createSpan({text:k})})}K.forEach((p,y)=>{let N=H.get(p);if(!(N!=null&&N.length))return;let k=p==="__default__"?it("line",y):it(p,y),_=[...N].sort((V,st)=>{let j=v.findIndex(z=>String(z)===String(V.x)),W=v.findIndex(z=>String(z)===String(st.x));return j-W}),tt="";if(_.forEach((V,st)=>{let j=D(V.x),W=T(V.y);tt+=(st===0?"M ":" L ")+j+" "+W}),e){let V=_[0],st=_[_.length-1],j=D(V.x),W=D(st.x),z=T(b);tt+=` L ${W} ${z} L ${j} ${z} Z`;let et=document.createElementNS(c.namespaceURI,"path");et.setAttribute("d",tt),et.setAttribute("fill",k),et.setAttribute("fill-opacity","0.18"),et.setAttribute("stroke",k),et.setAttribute("stroke-width","1.5"),c.appendChild(et)}else{let V=document.createElementNS(c.namespaceURI,"path");V.setAttribute("d",tt),V.setAttribute("fill","none"),V.setAttribute("stroke",k),V.setAttribute("stroke-width","2"),c.appendChild(V)}_.forEach(V=>{let st=D(V.x),j=T(V.y),W=document.createElementNS(c.namespaceURI,"circle");W.setAttribute("cx",String(st)),W.setAttribute("cy",String(j)),W.setAttribute("r","3"),W.setAttribute("fill","#ffffff"),W.setAttribute("stroke",k),W.setAttribute("stroke-width","1.5"),W.style.cursor="pointer";let z=C(V.x),et=p==="__default__"?"":String(V.series),at=et?`${et} @ ${z}`:z,ht=`valor: ${Math.round(V.y*100)/100}`;W.addEventListener("mouseenter",ct=>{var U,Z;return ft(o,h,at,ht,(Z=(U=V.notes)==null?void 0:U.length)!=null?Z:0,ct)}),W.addEventListener("mouseleave",()=>gt(h)),W.addEventListener("click",ct=>{var U;ct.preventDefault(),yt(o,f,at,V.y,(U=V.notes)!=null?U:[],i)}),c.appendChild(W)})})}function He(o,n,t){var I;let{background:e,drilldown:r=!0}=(I=n.options)!=null?I:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=$e(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:d,svg:a,tooltip:c,details:h}=wt(o,e),f=Math.max(i,420);d.style.width=f+"px",s&&(a.style.color=s);let m=300,g=f/2,S=(m-28+28)/2,w=Math.min(f/2-20,m/2-20),A=t.rows.map(M=>Math.max(0,M.y)).reduce((M,H)=>M+H,0)||1,x=-Math.PI/2;t.rows.forEach((M,H)=>{var G;let K=M.x instanceof Date?M.x.toISOString().slice(0,10):String(M.x),v=M.y,E=v/A*Math.PI*2,l=g+w*Math.cos(x),D=S+w*Math.sin(x),C=g+w*Math.cos(x+E),b=S+w*Math.sin(x+E),R=E>Math.PI?1:0,T=document.createElementNS(a.namespaceURI,"path"),F=[`M ${g} ${S}`,`L ${l} ${D}`,`A ${w} ${w} 0 ${R} 1 ${C} ${b}`,"Z"].join(" ");T.setAttribute("d",F),T.setAttribute("fill",it((G=M.series)!=null?G:K,H)),T.style.cursor="pointer",T.addEventListener("mouseenter",B=>{var Y,q;return ft(o,c,K,v,(q=(Y=M.notes)==null?void 0:Y.length)!=null?q:0,B)}),T.addEventListener("mouseleave",()=>gt(c)),T.addEventListener("click",()=>{var B;return yt(o,h,K,v,(B=M.notes)!=null?B:[],r)}),a.appendChild(T),x+=E})}function Ge(o,n,t){var D;let{background:e,drilldown:r=!0}=(D=n.options)!=null?D:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:d,svg:a,tooltip:c,details:h}=wt(o,e),f=Math.max(i,700);d.style.width=f+"px",s&&(a.style.color=s);let m=300,g=f-48-10,S=m-28-28,w=t.rows.map(C=>{let b=C.x;if(b instanceof Date)return b.getTime();if(typeof b=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(b)){let T=new Date(b);if(!isNaN(T.getTime()))return T.getTime()}let R=Number(b);return isNaN(R)?null:R}return typeof b=="number"?b:null}),P=t.rows.map(C=>C.y),A=w.filter(C=>C!==null);if(A.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let x=Math.min(...A),I=Math.max(...A),M=Math.min(...P),H=Math.max(...P),K=C=>48+(C-x)/(I-x||1)*g,v=C=>m-28-(C-M)/(H-M||1)*S,E=document.createElementNS(a.namespaceURI,"line");E.setAttribute("x1",String(48)),E.setAttribute("y1",String(28)),E.setAttribute("x2",String(48)),E.setAttribute("y2",String(m-28)),E.setAttribute("stroke","currentColor"),a.appendChild(E);let l=document.createElementNS(a.namespaceURI,"line");l.setAttribute("x1",String(48)),l.setAttribute("y1",String(m-28)),l.setAttribute("x2",String(f-10)),l.setAttribute("y2",String(m-28)),l.setAttribute("stroke","currentColor"),a.appendChild(l),t.rows.forEach((C,b)=>{let R=w[b];if(R==null)return;let T=K(R),F=v(P[b]),G=document.createElementNS(a.namespaceURI,"circle");G.setAttribute("cx",String(T)),G.setAttribute("cy",String(F)),G.setAttribute("r","4"),G.setAttribute("fill",it(C.series,b)),G.style.cursor="pointer";let B=C.x instanceof Date?C.x.toISOString().slice(0,10):typeof C.x=="string"?C.x:String(C.x);G.addEventListener("mouseenter",Y=>{var q,$;return ft(o,c,B,C.y,($=(q=C.notes)==null?void 0:q.length)!=null?$:0,Y)}),G.addEventListener("mouseleave",()=>gt(c)),G.addEventListener("click",Y=>{var q;Y.preventDefault(),yt(o,h,B,C.y,(q=C.notes)!=null?q:[],r)}),a.appendChild(G)})}var Qe=require("obsidian"),se=class{render(n,t,e,r,s=!1){var c;let{title:i}=(c=t.options)!=null?c:{};n.empty(),n.addClass("prop-charts-container");let a=n.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":me(n,t,e);break;case"stacked-bar":Be(n,t,e);break;case"line":fe(n,t,e,!1);break;case"area":fe(n,t,e,!0);break;case"pie":He(n,t,e);break;case"scatter":Ge(n,t,e);break;case"gantt":ne(n,t,e,r);break;default:n.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!s){let h=n.createEl("button",{cls:"chart-notes-zoom-button"});h.setAttr("type","button"),h.setAttr("aria-label","Expandir gr\xE1fico"),h.textContent="\u2922",h.addEventListener("click",f=>{f.preventDefault(),new ge(t,e,this,r).open()})}}},ge=class extends Qe.Modal{constructor(t,e,r,s){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=r,this.ctx=s}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),r=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:r,cls:"chart-notes-zoom-title"});let s=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(c,h)=>{let f=s.createEl("button",{cls:"chart-notes-zoom-size-btn",text:c});(()=>{f.toggleClass("is-active",this.size===h)})(),f.addEventListener("click",g=>{g.preventDefault(),this.size=h,this.applySize(),s.querySelectorAll(".chart-notes-zoom-size-btn").forEach(w=>w.classList.remove("is-active")),f.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let d=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(d,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",r="85vh";switch(this.size){case"small":e="60vw",r="55vh";break;case"medium":e="80vw",r="70vh";break;case"large":default:e="95vw",r="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=r,t.style.maxHeight=r}};var oe=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new Zt(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,r)=>{var h;let s;try{let f=(0,Lt.parseYaml)(t);if(!f||typeof f!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}s=f}catch(f){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+f.message});return}if(!s.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=s.type==="gantt",d=s.type==="table";if(!i&&!d){if(!s.encoding||!s.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let m=((h=s.aggregate)==null?void 0:h.y)==="count";if(!s.encoding.y&&!m){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}s.encoding||(s.encoding={}),s.source||(s.source={});let c;try{c=this.query.run(s)}catch(f){e.createEl("div",{text:"Chart Notes: erro na query: "+f.message});return}this.renderer.render(e,s,c)}),this.registerBasesView(ue,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new qt(t,e,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},e={type:"property",key:"xProperty",displayName:"Category / group"},r={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:A=>{var x;return String((x=A.get("chartType"))!=null?x:"bar")==="pie"}},s={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:A=>{var x;return String((x=A.get("chartType"))!=null?x:"bar")==="pie"}},i={type:"dropdown",key:"aggregateMode",displayName:"Value mode",default:"normal",options:{normal:"Normal (sum / count)","cumulative-sum":"Cumulative (line/area only)"},shouldHide:A=>{var I;let x=String((I=A.get("chartType"))!=null?I:"bar");return x!=="line"&&x!=="area"}},d={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (date \u2192 day)",none:"None",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:A=>{var I;let x=String((I=A.get("chartType"))!=null?I:"bar");return x==="pie"||x==="scatter"||x==="gantt"}},a=(A,x)=>({type:"property",key:A,displayName:x,shouldHide:I=>{var M;return String((M=I.get("chartType"))!=null?M:"")!=="gantt"}}),c=a("startProperty","Start (Gantt)"),h=a("endProperty","End (Gantt)"),f=a("dueProperty","Due (optional)"),m=a("scheduledProperty","Scheduled (optional)"),g=a("durationProperty","Duration in minutes (optional)"),S=a("groupProperty","Group / lane (optional)");return[t,e,r,s,i,c,h,f,m,g,S,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
