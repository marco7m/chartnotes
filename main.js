/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Ue=Object.prototype.hasOwnProperty;var Ye=(r,n)=>{for(var t in n)le(r,t,{get:n[t],enumerable:!0})},Oe=(r,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of Ke(n))!Ue.call(r,s)&&s!==t&&le(r,s,{get:()=>n[s],enumerable:!(e=Be(n,s))||e.enumerable});return r};var Xe=r=>Oe(le({},"__esModule",{value:!0}),r);var an={};Ye(an,{default:()=>se});module.exports=Xe(an);var Lt=require("obsidian");var qt=require("obsidian"),ce="chartnotes-view",Xt=class extends qt.BasesView{constructor(t,e,s){super(t);this.type=ce;this.containerEl=e.createDiv("chartnotes-bases-view"),this.renderer=s}onDataUpdated(){var M,z,$,C;this.containerEl.empty();let t=(M=this.data)==null?void 0:M.groupedData;if(!t||t.length===0){this.containerEl.createDiv({cls:"prop-charts-empty",text:"Sem dados (Base vazia ou sem resultados)."});return}let e=this.config,o=(((z=e==null?void 0:e.get("chartType"))!=null?z:"bar")||"bar").trim().toLowerCase();new Set(["bar","stacked-bar","line","area","pie","scatter","gantt"]).has(o)||(o="bar");let p;if(o==="gantt"?p=this.buildRowsForGantt(t):o==="scatter"?p=this.buildRowsForScatter(t):p=this.buildRowsForAggregatedCharts(t),!p.length){this.containerEl.createDiv({cls:"prop-charts-empty",text:"Sem linhas para exibir (verifique as propriedades configuradas)."});return}let a={rows:p},l=this.buildEncoding(),h=(($=e==null?void 0:e.get("title"))!=null?$:"").trim()||(e==null?void 0:e.name)||"Chart Notes (Bases)",x=((C=e==null?void 0:e.get("background"))!=null?C:"").trim()||void 0,y=e==null?void 0:e.get("drilldown"),g=typeof y=="boolean"?y:!0,w=e==null?void 0:e.get("tooltipFields"),T;Array.isArray(w)&&(T=w.map(v=>String(v).trim()).filter(v=>v.length>0),T.length===0&&(T=void 0));let A={type:o,source:{type:"properties",query:""},encoding:l,options:{title:h,background:x,drilldown:g,tooltipFields:T}},_={refresh:()=>this.onDataUpdated()};this.renderer.render(this.containerEl,A,a,_)}getSelectedProp(t){var i;let e=this.config,s=e==null?void 0:e.get(t);if(!s||typeof s!="string")return{id:null,name:null};let o=s;try{let p=(0,qt.parsePropertyId)(o);return{id:s,name:(i=p==null?void 0:p.name)!=null?i:s}}catch(p){return{id:s,name:s}}}readValue(t,e){if(!e.id)return null;let s;try{s=t.getValue(e.id)}catch(o){return null}if(!s)return null;try{if(typeof s.isEmpty=="function"&&s.isEmpty())return null}catch(o){}try{let o=s.toString();if(o==null)return null;let i=String(o).trim();return i.length?i:null}catch(o){return null}}parseDate(t){if(!t)return null;let e=t.trim();if(!e)return null;let s=new Date(e);return Number.isNaN(s.getTime())?null:s}buildRowsForAggregatedCharts(t){var p,a;let e=this.getSelectedProp("xProperty"),s=this.getSelectedProp("yProperty"),o=this.getSelectedProp("seriesProperty"),i=new Map;for(let l of t)for(let f of l.entries){let h=f.file,S=(a=this.readValue(f,e))!=null?a:h!=null&&h.name?String(h.name):String((p=h==null?void 0:h.path)!=null?p:""),x=this.readValue(f,s),y=1;if(s.id){if(x==null)continue;let _=Number(x);if(Number.isNaN(_))continue;y=_}let g=this.readValue(f,o),w=g!=null?String(g):void 0,T=`${S}@@${w!=null?w:""}`,A=i.get(T);A||(A={x:S,y:0,series:w,notes:[],props:{}},i.set(T,A)),A.y+=y,h!=null&&h.path&&A.notes.push(h.path),A.props&&e.name&&(A.props[e.name]=S),A.props&&s.name&&x!=null&&(A.props[s.name]=y),A.props&&o.name&&g!=null&&(A.props[o.name]=g)}return Array.from(i.values())}buildRowsForScatter(t){let e=this.getSelectedProp("xProperty"),s=this.getSelectedProp("yProperty"),o=this.getSelectedProp("seriesProperty"),i=[];for(let p of t)for(let a of p.entries){let l=a.file,f=this.readValue(a,e),h=this.readValue(a,s);if(f==null||h==null)continue;let S=Number(f),x=Number(h);if(Number.isNaN(S)||Number.isNaN(x))continue;let y=this.readValue(a,o),g=y!=null?String(y):void 0,w={x:S,y:x,series:g,notes:l!=null&&l.path?[l.path]:[],props:{}};i.push(w)}return i}buildRowsForGantt(t){var h,S;let e=this.getSelectedProp("xProperty"),s=this.getSelectedProp("seriesProperty"),o=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),p=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),l=this.getSelectedProp("groupProperty"),f=[];for(let x of t)for(let y of x.entries){let g=y.file,w=this.readValue(y,o),T=this.readValue(y,i);if(!w||!T)continue;let A=this.parseDate(w),_=this.parseDate(T);if(!A||!_)continue;let M=(S=this.readValue(y,e))!=null?S:g!=null&&g.name?String(g.name).replace(/\.md$/i,""):String((h=g==null?void 0:g.path)!=null?h:""),z=this.readValue(y,p),$=this.parseDate(z!=null?z:null),C=this.readValue(y,a),v=C!=null?Number(C):void 0,u=typeof v=="number"&&!Number.isNaN(v),E=this.readValue(y,s),N=E!=null?String(E):void 0,b=this.readValue(y,l),L={};a.name&&u&&(L[a.name]=v),l.name&&b!=null&&(L[l.name]=b);let V={x:M,y:0,series:N,start:A,end:_,due:$!=null?$:void 0,notes:g!=null&&g.path?[g.path]:[],props:L};f.push(V)}return f}buildEncoding(){var f,h,S,x,y,g,w,T;let t=this.getSelectedProp("xProperty"),e=this.getSelectedProp("yProperty"),s=this.getSelectedProp("seriesProperty"),o=this.getSelectedProp("startProperty"),i=this.getSelectedProp("endProperty"),p=this.getSelectedProp("dueProperty"),a=this.getSelectedProp("durationProperty"),l=this.getSelectedProp("groupProperty");return{x:(f=t.name)!=null?f:"x",y:(h=e.name)!=null?h:"y",series:(S=s.name)!=null?S:"series",start:(x=o.name)!=null?x:"start",end:(y=i.name)!=null?y:"end",due:(g=p.name)!=null?g:"due",duration:(w=a.name)!=null?w:"duration",group:(T=l.name)!=null?T:"group"}}};var Ne=require("obsidian"),jt=class{constructor(n){this.index=new Map;this.app=n}async buildIndex(){this.index.clear();let n=this.app.vault.getMarkdownFiles();for(let t of n)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(n){if(n.extension!=="md")return;let t={};try{let s=(await this.app.vault.read(n)).match(/^---\n([\s\S]*?)\n---\n?/);if(s){let i=(0,Ne.parseYaml)(s[1])||{};if(i&&typeof i=="object")for(let[p,a]of Object.entries(i))p!=="position"&&(t[p]=a)}let o=this.app.metadataCache.getFileCache(n);o!=null&&o.tags&&!t.tags&&(t.tags=o.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",n.path,e)}this.index.set(n.path,{path:n.path,props:t})}removeFile(n){this.index.delete(n.path)}};function Pe(r,n){if(!n||n.length===0)return!0;for(let t of n){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(r===t||r.startsWith(e))return!0}return!1}function Me(r,n){if(!n||n.length===0)return!0;let t=r.tags;if(!t)return!1;if(Array.isArray(t)){for(let s of n)if(t.includes(s)||t.includes("#"+s))return!0;return!1}let e=String(t);for(let s of n)if(e===s||e==="#"+s)return!0;return!1}function Jt(r){return typeof r!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(r)}function $t(r){if(r instanceof Date)return r;if(typeof r!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(r)){let[t,e,s]=r.split("-");return new Date(Number(t),Number(e)-1,Number(s),0,0,0,0)}let n=new Date(r);return isNaN(n.getTime())?null:n}function ut(r){let n=new Date(r);return n.setHours(0,0,0,0),n}function Zt(r,n){let t=new Date(r);return t.setDate(t.getDate()-n),t}function qe(r,n){return Zt(r,n*7)}function je(r,n){let t=new Date(r);return t.setMonth(t.getMonth()-n),t}function de(r,n){let t=new Date(r);return t.setDate(t.getDate()+n),t}function Ze(r,n){return de(r,n*7)}function Je(r,n){let t=new Date(r);return t.setMonth(t.getMonth()+n),t}function Te(r){let n=r.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(n)||n.endsWith("date")||n.endsWith("at")||n.endsWith("on"))}function ke(r,n){let t=n?new Date(n):new Date,e=ut(t),s=r.trim().toLowerCase();if(s==="today")return e;if(s==="yesterday")return ut(Zt(e,1));if(/^-\d+$/.test(s)){let o=parseInt(s.slice(1),10);return ut(Zt(e,o))}if(/^-\d+d$/.test(s)){let o=parseInt(s.slice(1,-1),10);return ut(Zt(e,o))}if(/^-\d+w$/.test(s)){let o=parseInt(s.slice(1,-1),10);return ut(qe(e,o))}if(/^-\d+m$/.test(s)){let o=parseInt(s.slice(1,-1),10);return ut(je(e,o))}if(/^\+\d+$/.test(s)){let o=parseInt(s.slice(1),10);return ut(de(e,o))}if(/^\+\d+d$/.test(s)){let o=parseInt(s.slice(1,-1),10);return ut(de(e,o))}if(/^\+\d+w$/.test(s)){let o=parseInt(s.slice(1,-1),10);return ut(Ze(e,o))}if(/^\+\d+m$/.test(s)){let o=parseInt(s.slice(1,-1),10);return ut(Je(e,o))}return null}function Le(r){let n=r.trim(),t=n.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let f=t[1].trim(),h=t[2].trim(),S=t[3].trim(),x=Te(f),y=ue(h,x),g=ue(S,x),w=y.valueType==="date"||g.valueType==="date"?"date":y.valueType;return{field:f,op:"between",value:y.value,value2:g.value,valueType:w}}let e=/(==|!=|>=|<=|>|<)/,s=n.split(e);if(s.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+r);let o=s[0].trim(),i=s[1].trim(),p=s[2].trim(),a=Te(o),l=ue(p,a);return{field:o,op:i,value:l.value,valueType:l.valueType}}function ue(r,n){let t=r.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),s=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(n){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=ke(t);if(i)return{value:i,valueType:"date"}}else if(s){let i=ke(t);if(i)return{value:i,valueType:"date"}}if(Jt(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let o=Number(t);return Number.isNaN(o)?{value:t,valueType:"string"}:{value:o,valueType:"number"}}function Ie(r,n){let t=r[n.field];if(t==null)return!1;if(n.valueType==="date"){let o=t instanceof Date?ut(t):Jt(t)?ut($t(t)):null;if(!o)return!1;let i=n.value instanceof Date?n.value:null,p=n.value2 instanceof Date?n.value2:null;if(!i)return!1;let a=o.getTime(),l=ut(i).getTime();switch(n.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!p)return!1;let f=ut(p).getTime();return a>=l&&a<=f}}if(n.valueType==="number"){let o=Number(t);if(isNaN(o))return!1;let i=Number(n.value);switch(n.op){case"==":return o===i;case"!=":return o!==i;case">":return o>i;case">=":return o>=i;case"<":return o<i;case"<=":return o<=i;case"between":return typeof n.value2!="number"?!1:o>=i&&o<=n.value2}}let e=String(t),s=String(n.value);switch(n.op){case"==":return e===s;case"!=":return e!==s;case">":return e>s;case">=":return e>=s;case"<":return e<s;case"<=":return e<=s;case"between":return!1}}function tn(r){if(typeof r=="string"&&/^\d{4}-\d{2}-\d{2}/.test(r))return{key:r.slice(0,10),isDate:!0};if(Jt(r)){let n=$t(r);if(n)return{key:n,isDate:!0}}return{key:r,isDate:!1}}function en(r,n){let t=r.x,e=n.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let s=String(t),o=String(e);return s<o?-1:s>o?1:0}function nn(r,n){var o,i;let t=en(r,n);if(t!==0)return t;let e=(o=r.series)!=null?o:"",s=(i=n.series)!=null?i:"";return e<s?-1:e>s?1:0}function rn(r){if(r==null)return 0;if(typeof r=="number")return r>0?Math.floor(r):0;if(typeof r=="string"){let n=r.trim().match(/^(\d+)/);if(n){let t=Number(n[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(r)}`)}function sn(r){var e,s;let n=new Map,t=[];for(let o of r){let i=(e=o.series)!=null?e:"__no_series__",a=((s=n.get(i))!=null?s:0)+o.y;n.set(i,a),t.push({...o,y:a})}return t}function on(r,n){var i,p;let t=rn(n);if(!t||t<=1)return[...r];let e=new Map,s=new Map,o=[];for(let a of r){let l=(i=a.series)!=null?i:"__no_series__",f=e.get(l);f||(f=[],e.set(l,f));let h=(p=s.get(l))!=null?p:0;if(f.push(a.y),h+=a.y,f.length>t){let y=f.shift();h-=y}s.set(l,h);let S=f.length||1,x=h/S;o.push({...a,y:x})}return o}var te=class{constructor(n,t){this.getIndex=n,this.defaultPaths=t}run(n){var i,p,a;let t=this.getIndex(),e=(i=n.source)!=null&&i.paths&&n.source.paths.length?n.source.paths:this.defaultPaths,s=(p=n.source)!=null&&p.tags&&n.source.tags.length?n.source.tags:[],o=[];for(let l of t){let f=e&&e.length?Pe(l.path,e):!0,h=s&&s.length?Me(l.props,s):!0;if(!f||!h)continue;let S=!0;if((a=n.source)!=null&&a.where&&n.source.where.length>0)for(let x of n.source.where){let y;try{y=Le(x)}catch(g){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${x} (${g.message})`)}if(!Ie(l.props,y)){S=!1;break}}S&&o.push(l)}return n.type==="gantt"?this.runGantt(n,o):n.type==="table"?this.runTable(n,o):this.runStandard(n,o)}runTable(n,t){var s,o;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(s=n.encoding)==null?void 0:s.x,yField:(o=n.encoding)==null?void 0:o.y}}runGantt(n,t){var h,S,x;let e=(h=n.encoding)!=null?h:{},s=e.start,o=e.end,i=(S=e.label)!=null?S:e.x,p=e.series,a=e.duration,l=e.due,f=[];for(let y of t){let g=(x=y.props)!=null?x:{},w=C=>Array.isArray(C)?C[0]:C,T=null;if(o){let C=w(g[o]),v=$t(C);v&&(T=v)}if(!T)continue;let A=null;if(s){let C=w(g[s]),v=$t(C);v&&(A=v)}if(!A&&a){let C=w(g[a]),v=Number(C);Number.isNaN(v)||(A=new Date(T.getTime()-v*6e4))}A||(A=new Date(T.getTime()));let _;if(l){let C=w(g[l]),v=$t(C);v&&(_=v)}let M;if(i){let C=w(g[i]);(C==null||C==="")&&(C=y.path),M=C}else M=y.path;let z;if(p){let C=w(g[p]);C!=null&&(z=String(C))}let $={x:M,y:0,notes:[y.path],series:z,start:A,end:T,props:g};_&&($.due=_),f.push($)}return f.sort((y,g)=>{let w=y.start?y.start.getTime():0,T=g.start?g.start.getTime():0;return w-T}),{rows:f,xField:i,yField:o}}runStandard(n,t){var y,g,w,T,A,_,M,z,$,C;let e=(y=n.encoding)==null?void 0:y.x,s=(g=n.encoding)==null?void 0:g.y,o=(w=n.encoding)==null?void 0:w.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(T=n.aggregate)!=null?T:{},p=(A=i.y)!=null?A:null,a=!!i.cumulative,l=i.rolling;if(!s&&p!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let f=[];for(let v of t){let u=(_=v.props)!=null?_:{},E=Q=>Array.isArray(Q)?Q[0]:Q,N=E(u[e]);if(N==null)continue;let b=tn(N),L=b.key,V=b.isDate,nt;if(o){let Q=E(u[o]);Q!=null&&String(Q).trim()!==""&&(nt=String(Q))}let G;if(p==="count")G=1;else{let Q=E(u[s]);if(Q==null)continue;let j=Number(Q);if(Number.isNaN(j))continue;G=j}f.push({x:L,y:G,notes:[v.path],series:nt,props:u,_isDate:V,_origX:N})}if(f.length===0)return{rows:[],xField:e,yField:s};let h=[];if(p){let v=new Map;for(let u of f){let E=(M=u.series)!=null?M:"",N=u.x instanceof Date?u.x.toISOString().slice(0,10):String(u.x),b=E+"||"+N,L=(z=v.get(b))!=null?z:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:u.x,isDate:u._isDate,series:u.series,props:u.props};L.sum+=u.y,L.count+=1,u.y<L.min&&(L.min=u.y),u.y>L.max&&(L.max=u.y),L.notes.push(...u.notes),L.props=($=u.props)!=null?$:L.props,v.set(b,L)}for(let[,u]of v){let E=u.sum;switch(p){case"sum":E=u.sum;break;case"avg":E=u.sum/u.count;break;case"min":E=u.min;break;case"max":E=u.max;break;case"count":E=u.count;break}h.push({x:u.xRep,y:E,notes:u.notes,series:u.series,props:u.props})}}else h=f.map(v=>({x:v.x,y:v.y,notes:v.notes,series:v.series,props:v.props}));if(h.length===0)return{rows:[],xField:e,yField:s};let S=((C=n.sort)==null?void 0:C.x)==="desc"?"desc":"asc";if(h.sort((v,u)=>{let E=nn(v,u);return S==="asc"?E:-E}),(a||l)&&!(n.type==="line"||n.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let x=h;return l?x=on(h,l):a&&(x=sn(h)),{rows:x,xField:e,yField:s}}};var Rt=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(r,n){if(!r)return"var(--text-accent, #5b6cff)";let t=Array.from(r).reduce((e,s)=>e*33+s.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(r,n){r.addClass("prop-charts-container"),r.style.width="100%",r.style.maxWidth="100%",r.style.position="relative";let t=r.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,n&&(e.style.background=n);let s="http://www.w3.org/2000/svg",o=document.createElementNS(s,"svg");o.setAttribute("width","100%"),o.setAttribute("height",String(300)),o.style.display="block",e.appendChild(o);let i=r.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let p=r.createDiv({cls:"chart-notes-details"});return p.style.display="none",{scroll:t,inner:e,svg:o,tooltip:i,details:p}}function mt(r,n,t,e,s,o){let i=r.getBoundingClientRect(),p=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);n.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${p}</div>
    <div class="chart-notes-tooltip-notes">${s} nota${s===1?"":"s"}</div>
  `,n.style.display="block";let a=n.getBoundingClientRect(),l=o.clientX-i.left+6,f=o.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),f+a.height>i.height-4&&(f=i.height-a.height-4),f<4&&(f=4),n.style.left=l+"px",n.style.top=f+"px"}function gt(r){r.style.display="none"}function yt(r,n,t,e,s,o){if(!o)return;if(n.empty(),!s||s.length===0){n.style.display="none";return}n.style.display="block";let i=n.createEl("div",{cls:"chart-notes-details-header"}),p=i.createEl("div",{cls:"chart-notes-details-title"});p.textContent=`Notas em "${t}" (${s.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{n.style.display="none"});let l=n.createEl("ul",{cls:"chart-notes-details-list"});for(let f of s){let S=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:f});S.href="#",S.addEventListener("click",x=>{x.preventDefault(),app.workspace.openLinkText(f,"",!1)})}}function Gt(r){if(!(r instanceof Date)||isNaN(r.getTime()))return"";let n=r.getDate().toString().padStart(2,"0"),t=(r.getMonth()+1).toString().padStart(2,"0");return`${n}/${t}`}function _e(r){if(!r)return!1;let n=r.trim().toLowerCase();if(n==="#fff"||n==="#ffffff"||n==="white")return!0;if(!n.startsWith("#"))return!1;let t,e,s;if(n.length===4)t=parseInt(n[1]+n[1],16),e=parseInt(n[2]+n[2],16),s=parseInt(n[3]+n[3],16);else if(n.length===7)t=parseInt(n.slice(1,3),16),e=parseInt(n.slice(3,5),16),s=parseInt(n.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*s)/255>.7}var pe=class extends Rt.Modal{constructor(t,e,s,o){var p;super(app);this.notePath=t,this.spec=e,this.refresh=s,this.reindexFile=o;let i=(p=e.encoding)!=null?p:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var C,v;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Rt.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let s=await this.app.vault.read(e),o={},i=s,p=/^---\n([\s\S]*?)\n---\n?/m.exec(s);if(p){try{o=(C=(0,Rt.parseYaml)(p[1]))!=null?C:{}}catch(u){o={}}i=s.slice(p[0].length)}(typeof o!="object"||o==null)&&(o={});let a=(v=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?v:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),f=l.createEl("a",{text:a,cls:"gantt-edit-title"});f.href="#",f.addEventListener("click",u=>{u.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let h=l.createDiv({cls:"gantt-edit-subtitle"});h.textContent=this.notePath;let S=t.createDiv({cls:"gantt-edit-form"}),x=u=>{let E=S.createDiv({cls:"gantt-edit-row"}),N=E.createDiv({cls:"gantt-edit-label"});N.textContent=u;let b=E.createDiv({cls:"gantt-edit-field"});return{row:E,field:b}},y=u=>{if(!u)return"";let N=String(u).match(/^(\d{4}-\d{2}-\d{2})/);return N?N[1]:""},g=u=>{if(u=u.trim(),!!u&&/^\d{4}-\d{2}-\d{2}$/.test(u))return u},w=null;if(this.startKey){let{field:u}=x(this.startKey+" (in\xEDcio)");w=u.createEl("input",{type:"date"}),w.value=y(o[this.startKey])}let T=null;if(this.endKey){let{field:u}=x(this.endKey+" (fim)");T=u.createEl("input",{type:"date"}),T.value=y(o[this.endKey])}let A=null;if(this.durationKey){let{field:u}=x(this.durationKey+" (minutos)");A=u.createEl("input",{type:"number"});let E=o[this.durationKey];A.value=E!=null?String(E):"",A.min="0",A.step="5"}let _=null;if(this.dueKey){let{field:u}=x(this.dueKey+" (due)");_=u.createEl("input",{type:"date"}),_.value=y(o[this.dueKey])}let M=t.createDiv({cls:"gantt-edit-buttons"}),z=M.createEl("button",{text:"Salvar",cls:"mod-cta"});M.createEl("button",{text:"Cancelar"}).addEventListener("click",u=>{u.preventDefault(),this.close()}),z.addEventListener("click",async u=>{if(u.preventDefault(),this.startKey&&w){let b=g(w.value);b?o[this.startKey]=b:delete o[this.startKey]}if(this.endKey&&T){let b=g(T.value);b?o[this.endKey]=b:delete o[this.endKey]}if(this.durationKey&&A){let b=A.value.trim();if(b==="")delete o[this.durationKey];else{let L=Number(b);Number.isNaN(L)||(o[this.durationKey]=L)}}if(this.dueKey&&_){let b=g(_.value);b?o[this.dueKey]=b:delete o[this.dueKey]}let N=`---
${(0,Rt.stringifyYaml)(o).trim()}
---
`+i;if(await this.app.vault.modify(e,N),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(b){}if(this.refresh)try{this.refresh()}catch(b){}new Rt.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ee(r,n,t,e){var ye,be,xe,ve,Se,we,Ae,Ee;let s=(ye=n.options)!=null?ye:{},o=s.background,i=(be=s.drilldown)!=null?be:!0,p=!0,a=c=>{if(c==null)return"";let k=String(c).trim();if(!k)return"";let F=k.match(/^\[\[(.+?)\]\]$/);F&&(k=F[1]);let Y=k.lastIndexOf("/");return Y>=0&&Y<k.length-1&&(k=k.slice(Y+1)),k};if(Array.from(r.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(c=>c.remove()),t.rows.length===0){r.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(c=>c.start&&c.end);if(l.length===0){r.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let f=n.encoding,h=f.group,S=f.duration,x=(c,k)=>{if(!c||!k)return;let F=c[k];return Array.isArray(F)?F[0]:F},g=l.map(c=>{var xt,ct;let k=c.start,F=c.end,Y=c.props,It=typeof c.x=="string"?c.x:c.x instanceof Date?Gt(k):String(c.x),At=a(It),bt,Ft=h?x(Y,h):void 0;Ft!=null?bt=String(Ft):c.series!=null?bt=String(c.series):bt=At;let ft=(xt=c.notes)==null?void 0:xt[0],Et=ft?(ct=ft.replace(/\.md$/i,"").split("/").pop())!=null?ct:ft:At,Ct=c.due,_t,Pt=x(Y,S);if(Pt!=null){let vt=Number(Pt);Number.isNaN(vt)||(_t=vt)}return{row:c,start:k,end:F,props:Y,fullName:At,groupKey:bt,notePath:ft,noteTitle:Et,due:Ct,estMinutes:_t}}).filter(c=>c.start instanceof Date&&!isNaN(c.start.getTime())&&c.end instanceof Date&&!isNaN(c.end.getTime()));if(g.length===0){r.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}g.sort((c,k)=>{if(c.groupKey<k.groupKey)return-1;if(c.groupKey>k.groupKey)return 1;let F=c.start.getTime(),Y=k.start.getTime();return F!==Y?F-Y:c.fullName.localeCompare(k.fullName)});let w=26,T=0,A=null;for(let c of g)c.groupKey!==A&&(A=c.groupKey,T+=1),T+=1;let _=Math.min(...g.map(c=>c.start.getTime())),M=Math.max(...g.map(c=>c.end.getTime()));if(!isFinite(_)||!isFinite(M)){r.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let z=24*60*60*1e3,$=c=>{let k=new Date(c);return k.setHours(0,0,0,0),k.getTime()},C=$(_),v=$(M),u=r.querySelector(".prop-charts-title-row");u||(u=r.createDiv({cls:"prop-charts-title-row"}));let E=r.dataset.ganttZoomMode||String((xe=s.zoomMode)!=null?xe:"100");r.dataset.ganttZoomMode=E;let N=r.dataset.ganttLabelMode||String((ve=s.labelMode)!=null?ve:"compact");r.dataset.ganttLabelMode=N;let b=u.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(c=>{let k=b.createEl("button",{cls:"gantt-zoom-btn",text:c.label});c.id===E&&k.addClass("is-active"),k.addEventListener("click",F=>{F.preventDefault(),r.dataset.ganttZoomMode=c.id,ee(r,n,t,e)})}),b.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",c=>{c.preventDefault();let k=r.querySelector(".chart-notes-zoom-button");k&&k.click()});let nt=Number(s.labelWidth),G=!Number.isNaN(nt)&&nt>120?nt:260,Q=N==="wide"?G+160:G,j=r.getBoundingClientRect().width||600,tt=Math.max(j,820),I;if(E==="fit")I=j;else{let c=Number(E)/100||1;I=tt*c}let{inner:d,svg:m,tooltip:D,details:R}=wt(r,o);d.style.width=I+"px";let P=(c,k,F,Y,It,At,bt,Ft,ft)=>{if(!c)return;let Et=Math.max(40,Y-8),_t=Math.max(8,Math.floor(Et/6)),Pt=c.split(/\s+/),xt=[],ct="";for(let Nt of Pt){if(!ct){ct=Nt;continue}(ct+" "+Nt).length<=_t?ct+=" "+Nt:(xt.push(ct),ct=Nt)}ct&&xt.push(ct);let vt=It+2,zt=xt.length*vt,Bt=F-zt/2+It;xt.forEach((Nt,Yt)=>{let ot=document.createElementNS(m.namespaceURI,"text");ot.setAttribute("x",String(k)),ot.setAttribute("y",String(Bt+Yt*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Nt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),ft&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>ft(rt))),m.appendChild(ot)})},Z=28,W=28,st=10,O=Math.max(300,Z+W+T*w+24);m.setAttribute("height",String(O));let B=I-Q-st,K=Z+6;m.style.color="#111111";let J=v+z-C||1,at=C-J*.02,ht=v+z+J*.08,lt=c=>Q+(c-at)/(ht-at)*B,H=(ht-at)/z,kt=Math.max(4,Math.min(12,Math.floor(B/90)||4)),dt=H/kt,q=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=q[q.length-1];for(let c of q)if(c>=dt){pt=c;break}let Wt=[],Ge=$(at);for(let c=Ge;c<=ht+.5*z;c+=pt*z)Wt.push(c);let Qt=document.createElementNS(m.namespaceURI,"line");Qt.setAttribute("x1",String(Q)),Qt.setAttribute("y1",String(K)),Qt.setAttribute("x2",String(I-st)),Qt.setAttribute("y2",String(K)),Qt.setAttribute("stroke","#111111"),m.appendChild(Qt);for(let c of Wt){let k=lt(c),F=document.createElementNS(m.namespaceURI,"line");F.setAttribute("x1",String(k)),F.setAttribute("y1",String(K)),F.setAttribute("x2",String(k)),F.setAttribute("y2",String(O-W)),F.setAttribute("stroke","#111111"),F.setAttribute("stroke-opacity","0.20"),F.setAttribute("stroke-dasharray","2,4"),m.appendChild(F);let Y=document.createElementNS(m.namespaceURI,"text");Y.setAttribute("x",String(k)),Y.setAttribute("y",String(K-4)),Y.setAttribute("text-anchor","middle"),Y.setAttribute("font-size","10"),Y.setAttribute("fill","#111111"),Y.textContent=Gt(new Date(c)),m.appendChild(Y)}let ge=new Date;ge.setHours(0,0,0,0);let oe=ge.getTime();if(oe>=at&&oe<=ht){let c=lt(oe),k=document.createElementNS(m.namespaceURI,"line");k.setAttribute("x1",String(c)),k.setAttribute("y1",String(K)),k.setAttribute("x2",String(c)),k.setAttribute("y2",String(O-W)),k.setAttribute("stroke","#4caf50"),k.setAttribute("stroke-width","2"),k.setAttribute("stroke-dasharray","4,2"),m.appendChild(k);let F=document.createElementNS(m.namespaceURI,"text");F.setAttribute("x",String(c+4)),F.setAttribute("y",String(K+12)),F.setAttribute("font-size","10"),F.setAttribute("fill","#4caf50"),F.textContent="hoje",m.appendChild(F)}let Ut=d.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ut.setAttr("title",N==="wide"?"Compactar nomes":"Expandir nomes"),Ut.style.left=`${Q}px`,Ut.style.top="4px",Ut.addEventListener("click",c=>{c.preventDefault();let F=(r.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";r.dataset.ganttLabelMode=F,ee(r,n,t,e)});let Ve=["status","priority"],ie=Array.isArray(s.tooltipFields)?s.tooltipFields.map(c=>String(c)):null,We=ie&&ie.length?ie:Ve,Ht=0,ae=null;for(let c of g){let k=c.start,F=c.end,Y=(F.getTime()-k.getTime())/6e4,It=c.props,At=c.notePath,bt=c.noteTitle,Ft=(we=(Se=c.row.notes)==null?void 0:Se.length)!=null?we:0,ft=c.due,Et=c.estMinutes,Ct=[];Ct.push(`${Gt(k)} \u2192 ${Gt(F)}`),typeof Et=="number"&&!Number.isNaN(Et)?Ct.push(`est: ${Math.round(Et)} min`):Y>0&&Ct.push(`dura\xE7\xE3o: ${Math.round(Y)} min`),ft instanceof Date&&Ct.push(`due: ${Gt(ft)}`);for(let et of We){let U=x(It,et);U!=null&&String(U).trim()!==""&&Ct.push(`${et}: ${String(U)}`)}let _t=Ct.join("<br>"),Pt=et=>{var U;et.preventDefault(),p&&At?new pe(At,n,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(r,R,bt,Et!=null?Et:Y,(U=c.row.notes)!=null?U:[],i)},xt=et=>{bt&&_t&&mt(r,D,bt,_t,Ft,et)},ct=()=>gt(D);if(c.groupKey!==ae){ae=c.groupKey;let et=K+8+Ht*w+w/2,U=a(ae);P(U,4,et,Q-12,11,"600"),Ht+=1}let vt=K+8+Ht*w,zt=w-10,Bt=lt(k.getTime()),Nt=lt(F.getTime()),Yt=Math.max(4,Nt-Bt),ot=c.fullName,rt=document.createElementNS(m.namespaceURI,"rect");rt.setAttribute("x",String(Bt)),rt.setAttribute("y",String(vt)),rt.setAttribute("width",String(Yt)),rt.setAttribute("height",String(zt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=c.row.series)!=null?Ae:ot,Ht)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=p&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",ct),rt.addEventListener("click",Pt),m.appendChild(rt);let De=vt+zt/2;if(Yt>=6){let et=it((Ee=c.row.series)!=null?Ee:ot,Ht),U=document.createElementNS(m.namespaceURI,"circle");U.setAttribute("cx",String(Bt)),U.setAttribute("cy",String(De)),U.setAttribute("r","3.5"),U.setAttribute("fill","#ffffff"),U.setAttribute("stroke",et),U.setAttribute("stroke-width","1.5"),m.appendChild(U);let Mt=document.createElementNS(m.namespaceURI,"circle");Mt.setAttribute("cx",String(Nt)),Mt.setAttribute("cy",String(De)),Mt.setAttribute("r","3.5"),Mt.setAttribute("fill","#ffffff"),Mt.setAttribute("stroke",et),Mt.setAttribute("stroke-width","1.5"),m.appendChild(Mt)}let Re=vt+zt/2+2,Ot=h?16:4;if(N==="wide")P(ot,Ot,Re,Q-Ot-4,11,null,xt,ct,Pt);else{let et=ot,U=Math.max(40,Q-Ot-8),Ce=Math.max(8,Math.floor(U/6));et.length>Ce&&(et=et.slice(0,Ce-1)+"\u2026");let St=document.createElementNS(m.namespaceURI,"text");St.setAttribute("x",String(Ot)),St.setAttribute("y",String(Re)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=et,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",ct),St.addEventListener("click",Pt),m.appendChild(St)}if(ft instanceof Date){let et=lt(ft.getTime()),U=document.createElementNS(m.namespaceURI,"line");U.setAttribute("x1",String(et)),U.setAttribute("y1",String(vt)),U.setAttribute("x2",String(et)),U.setAttribute("y2",String(vt+zt)),U.setAttribute("stroke","#ff6b6b"),U.setAttribute("stroke-width","2"),U.setAttribute("stroke-dasharray","4,2"),m.appendChild(U)}Ht+=1}if(p){let c=r.createDiv({cls:"prop-charts-empty"});c.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function he(r,n,t){var Q,j,tt,I;let e=(Q=n.options)!=null?Q:{},s=e.background,o=(j=e.drilldown)!=null?j:!0,i=(tt=t.rows)!=null?tt:[];if(!i.length){r.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:f}=wt(r,s),h=r.getBoundingClientRect().width||600,S=Math.max(h,480);p.style.width=S+"px";let x=40,y=16,g=18,w=28,T=300;a.setAttribute("height",String(T));let A=S-x-y,_=T-g-w,M=new Map;for(let d of i){let m=String(d.x),D=(I=M.get(m))!=null?I:{label:d.x,rows:[]};D.rows.push(d),M.set(m,D)}let $=Array.from(M.keys()).sort((d,m)=>d<m?-1:d>m?1:0).map(d=>M.get(d)),C=$.length,v=new Set;i.forEach(d=>{d.series!=null&&v.add(String(d.series))});let u=Array.from(v),E=u.length>1,N=E?"grouped":"single",b=0;i.forEach(d=>{d.y>b&&(b=d.y)}),(!isFinite(b)||b<=0)&&(b=1);let L=d=>g+_-d/(b||1)*_,V=L(0),nt=4;for(let d=0;d<=nt;d++){let m=b*d/nt,D=L(m),R=document.createElementNS(a.namespaceURI,"line");R.setAttribute("x1",String(x)),R.setAttribute("y1",String(D)),R.setAttribute("x2",String(S-y)),R.setAttribute("y2",String(D)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),a.appendChild(R);let P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(x-4)),P.setAttribute("y",String(D+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=String(Math.round(m)),a.appendChild(P)}let G=C>0?A/C:A;if($.forEach((d,m)=>{let D=x+G*(m+.5),R=String(d.label),P=document.createElementNS(a.namespaceURI,"text");P.setAttribute("x",String(D)),P.setAttribute("y",String(T-w+12)),P.setAttribute("text-anchor","middle"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=R,a.appendChild(P)}),E){let d=r.createDiv({cls:"chart-notes-legend"});u.forEach((m,D)=>{let R=d.createDiv({cls:"chart-notes-legend-item"}),P=R.createDiv();P.style.width="10px",P.style.height="10px",P.style.borderRadius="999px",P.style.backgroundColor=it(m,D),R.createSpan({text:m})})}$.forEach((d,m)=>{let D=x+G*(m+.5),R=d.rows;if(N==="single"){let O=R[0],B=O.y,K=G*.6,J=D-K/2,at=L(B),ht=Math.max(2,V-at),lt=it("bar",m),H=document.createElementNS(a.namespaceURI,"rect");H.setAttribute("x",String(J)),H.setAttribute("y",String(at)),H.setAttribute("width",String(K)),H.setAttribute("height",String(ht)),H.setAttribute("fill",lt),H.setAttribute("stroke","rgba(0,0,0,0.25)"),H.setAttribute("stroke-width","0.5"),H.style.cursor="pointer";let X=String(d.label),kt=`valor: ${Math.round(B*100)/100}`;H.addEventListener("mouseenter",dt=>{var q,pt;return mt(r,l,X,kt,(pt=(q=O.notes)==null?void 0:q.length)!=null?pt:0,dt)}),H.addEventListener("mouseleave",()=>gt(l)),H.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(r,f,X,B,(q=O.notes)!=null?q:[],o)}),a.appendChild(H);return}let P=u.length,Z=G/Math.max(P+1,2),W=P*Z,st=D-W/2;u.forEach((O,B)=>{let K=R.find(q=>(q.series!=null?String(q.series):"")===O);if(!K)return;let J=K.y,at=st+B*Z,ht=L(J),lt=Math.max(2,V-ht),H=it(O,B),X=document.createElementNS(a.namespaceURI,"rect");X.setAttribute("x",String(at)),X.setAttribute("y",String(ht)),X.setAttribute("width",String(Z)),X.setAttribute("height",String(lt)),X.setAttribute("fill",H),X.setAttribute("stroke","rgba(0,0,0,0.25)"),X.setAttribute("stroke-width","0.5"),X.style.cursor="pointer";let kt=`${O} @ ${String(d.label)}`,dt=`valor: ${Math.round(J*100)/100}`;X.addEventListener("mouseenter",q=>{var pt,Wt;return mt(r,l,kt,dt,(Wt=(pt=K.notes)==null?void 0:pt.length)!=null?Wt:0,q)}),X.addEventListener("mouseleave",()=>gt(l)),X.addEventListener("click",q=>{var pt;q.preventDefault(),yt(r,f,kt,J,(pt=K.notes)!=null?pt:[],o)}),a.appendChild(X)})})}function $e(r,n,t){var G,Q,j,tt;let e=(G=n.options)!=null?G:{},s=e.background,o=(Q=e.drilldown)!=null?Q:!0,i=(j=t.rows)!=null?j:[];if(!i.length){r.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:p,svg:a,tooltip:l,details:f}=wt(r,s),h=r.getBoundingClientRect().width||600,S=Math.max(h,480);p.style.width=S+"px";let x=40,y=16,g=18,w=28,T=300;a.setAttribute("height",String(T));let A=S-x-y,_=T-g-w,M=new Map;for(let I of i){let d=String(I.x),m=(tt=M.get(d))!=null?tt:{label:I.x,rows:[]};m.rows.push(I),M.set(d,m)}let $=Array.from(M.keys()).sort((I,d)=>I<d?-1:I>d?1:0).map(I=>M.get(I)),C=$.length,v=new Set;i.forEach(I=>{I.series!=null&&v.add(String(I.series))});let u=Array.from(v);if(!u.length){he(r,n,t);return}let E=0;$.forEach(I=>{let d=I.rows.reduce((m,D)=>m+D.y,0);d>E&&(E=d)}),(!isFinite(E)||E<=0)&&(E=1);let N=I=>g+_-I/(E||1)*_,b=N(0),L=4;for(let I=0;I<=L;I++){let d=E*I/L,m=N(d),D=document.createElementNS(a.namespaceURI,"line");D.setAttribute("x1",String(x)),D.setAttribute("y1",String(m)),D.setAttribute("x2",String(S-y)),D.setAttribute("y2",String(m)),D.setAttribute("stroke","#cccccc"),D.setAttribute("stroke-opacity","0.25"),a.appendChild(D);let R=document.createElementNS(a.namespaceURI,"text");R.setAttribute("x",String(x-4)),R.setAttribute("y",String(m+3)),R.setAttribute("text-anchor","end"),R.setAttribute("font-size","10"),R.setAttribute("fill","#111111"),R.textContent=String(Math.round(d)),a.appendChild(R)}let V=C>0?A/C:A;$.forEach((I,d)=>{let m=x+V*(d+.5),D=String(I.label),R=document.createElementNS(a.namespaceURI,"text");R.setAttribute("x",String(m)),R.setAttribute("y",String(T-w+12)),R.setAttribute("text-anchor","middle"),R.setAttribute("font-size","10"),R.setAttribute("fill","#111111"),R.textContent=D,a.appendChild(R)});let nt=r.createDiv({cls:"chart-notes-legend"});u.forEach((I,d)=>{let m=nt.createDiv({cls:"chart-notes-legend-item"}),D=m.createDiv();D.style.width="10px",D.style.height="10px",D.style.borderRadius="999px",D.style.backgroundColor=it(I,d),m.createSpan({text:I})}),$.forEach((I,d)=>{let m=x+V*(d+.5),D=V*.6,R=m-D/2,P=0;u.forEach((Z,W)=>{let st=I.rows.find(dt=>(dt.series!=null?String(dt.series):"")===Z);if(!st)return;let O=st.y,B=P,K=P+O;P=K;let J=N(B),at=N(K),ht=Math.max(2,J-at),lt=it(Z,W),H=document.createElementNS(a.namespaceURI,"rect");H.setAttribute("x",String(R)),H.setAttribute("y",String(at)),H.setAttribute("width",String(D)),H.setAttribute("height",String(ht)),H.setAttribute("fill",lt),H.setAttribute("stroke","rgba(0,0,0,0.25)"),H.setAttribute("stroke-width","0.5"),H.style.cursor="pointer";let X=`${Z} @ ${String(I.label)}`,kt=`valor: ${Math.round(O*100)/100}`;H.addEventListener("mouseenter",dt=>{var q,pt;return mt(r,l,X,kt,(pt=(q=st.notes)==null?void 0:q.length)!=null?pt:0,dt)}),H.addEventListener("mouseleave",()=>gt(l)),H.addEventListener("click",dt=>{var q;dt.preventDefault(),yt(r,f,X,O,(q=st.notes)!=null?q:[],o)}),a.appendChild(H)})})}function fe(r,n,t,e){var Q,j,tt,I;let s=(Q=n.options)!=null?Q:{},o=s.background,i=(j=s.drilldown)!=null?j:!0,p=(tt=t.rows)!=null?tt:[];if(!p.length){r.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:f,details:h}=wt(r,o),S=r.getBoundingClientRect().width||600,x=Math.max(S,480);a.style.width=x+"px";let y=40,g=16,w=18,T=24,A=300;l.setAttribute("height",String(A));let _=x-y-g,M=A-w-T,z=new Map;for(let d of p){let m=d.series!=null?String(d.series):"__default__",D=(I=z.get(m))!=null?I:[];D.push(d),z.set(m,D)}let $=Array.from(z.keys()),C=[],v=new Set;for(let d of p){let m=String(d.x);v.has(m)||(v.add(m),C.push(d.x))}let u=C.length||1,E=d=>{let m=String(d),D=C.findIndex(R=>String(R)===m);return D<0?y:u===1?y+_/2:y+D/(u-1)*_},N=d=>String(d),b=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY;for(let d of p)d.y<b&&(b=d.y),d.y>L&&(L=d.y);(!isFinite(b)||!isFinite(L))&&(b=0,L=1),b===L&&(b===0?L=1:b=0);let V=d=>w+M-(d-b)/(L-b||1)*M,nt=4;for(let d=0;d<=nt;d++){let m=b+(L-b)*d/nt,D=V(m),R=document.createElementNS(l.namespaceURI,"line");R.setAttribute("x1",String(y)),R.setAttribute("y1",String(D)),R.setAttribute("x2",String(x-g)),R.setAttribute("y2",String(D)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),l.appendChild(R);let P=document.createElementNS(l.namespaceURI,"text");P.setAttribute("x",String(y-4)),P.setAttribute("y",String(D+3)),P.setAttribute("text-anchor","end"),P.setAttribute("font-size","10"),P.setAttribute("fill","#111111"),P.textContent=Math.abs(m)>=100?String(Math.round(m)):String(Math.round(m*10)/10),l.appendChild(P)}let G=$.filter(d=>d!=="__default__");if(G.length>1){let d=r.createDiv({cls:"chart-notes-legend"});G.forEach((m,D)=>{let R=m,P=d.createDiv({cls:"chart-notes-legend-item"}),Z=P.createDiv();Z.style.width="10px",Z.style.height="10px",Z.style.borderRadius="999px",Z.style.backgroundColor=it(R,D),P.createSpan({text:R})})}$.forEach((d,m)=>{let D=z.get(d);if(!(D!=null&&D.length))return;let R=d==="__default__"?it("line",m):it(d,m),P=[...D].sort((W,st)=>{let O=C.findIndex(K=>String(K)===String(W.x)),B=C.findIndex(K=>String(K)===String(st.x));return O-B}),Z="";if(P.forEach((W,st)=>{let O=E(W.x),B=V(W.y);Z+=(st===0?"M ":" L ")+O+" "+B}),e){let W=P[0],st=P[P.length-1],O=E(W.x),B=E(st.x),K=V(b);Z+=` L ${B} ${K} L ${O} ${K} Z`;let J=document.createElementNS(l.namespaceURI,"path");J.setAttribute("d",Z),J.setAttribute("fill",R),J.setAttribute("fill-opacity","0.18"),J.setAttribute("stroke",R),J.setAttribute("stroke-width","1.5"),l.appendChild(J)}else{let W=document.createElementNS(l.namespaceURI,"path");W.setAttribute("d",Z),W.setAttribute("fill","none"),W.setAttribute("stroke",R),W.setAttribute("stroke-width","2"),l.appendChild(W)}P.forEach(W=>{let st=E(W.x),O=V(W.y),B=document.createElementNS(l.namespaceURI,"circle");B.setAttribute("cx",String(st)),B.setAttribute("cy",String(O)),B.setAttribute("r","3"),B.setAttribute("fill","#ffffff"),B.setAttribute("stroke",R),B.setAttribute("stroke-width","1.5"),B.style.cursor="pointer";let K=N(W.x),J=d==="__default__"?"":String(W.series),at=J?`${J} @ ${K}`:K,ht=`valor: ${Math.round(W.y*100)/100}`;B.addEventListener("mouseenter",lt=>{var H,X;return mt(r,f,at,ht,(X=(H=W.notes)==null?void 0:H.length)!=null?X:0,lt)}),B.addEventListener("mouseleave",()=>gt(f)),B.addEventListener("click",lt=>{var H;lt.preventDefault(),yt(r,h,at,W.y,(H=W.notes)!=null?H:[],i)}),l.appendChild(B)})})}function Qe(r,n,t){var _;let{background:e,drilldown:s=!0}=(_=n.options)!=null?_:{};if(t.rows.length===0){r.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=_e(e)?"#000000":void 0,i=r.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:f}=wt(r,e),h=Math.max(i,420);p.style.width=h+"px",o&&(a.style.color=o);let S=300,x=h/2,y=(S-28+28)/2,g=Math.min(h/2-20,S/2-20),T=t.rows.map(M=>Math.max(0,M.y)).reduce((M,z)=>M+z,0)||1,A=-Math.PI/2;t.rows.forEach((M,z)=>{var G;let $=M.x instanceof Date?M.x.toISOString().slice(0,10):String(M.x),C=M.y,v=C/T*Math.PI*2,u=x+g*Math.cos(A),E=y+g*Math.sin(A),N=x+g*Math.cos(A+v),b=y+g*Math.sin(A+v),L=v>Math.PI?1:0,V=document.createElementNS(a.namespaceURI,"path"),nt=[`M ${x} ${y}`,`L ${u} ${E}`,`A ${g} ${g} 0 ${L} 1 ${N} ${b}`,"Z"].join(" ");V.setAttribute("d",nt),V.setAttribute("fill",it((G=M.series)!=null?G:$,z)),V.style.cursor="pointer",V.addEventListener("mouseenter",Q=>{var j,tt;return mt(r,l,$,C,(tt=(j=M.notes)==null?void 0:j.length)!=null?tt:0,Q)}),V.addEventListener("mouseleave",()=>gt(l)),V.addEventListener("click",()=>{var Q;return yt(r,f,$,C,(Q=M.notes)!=null?Q:[],s)}),a.appendChild(V),A+=v})}function He(r,n,t){var E;let{background:e,drilldown:s=!0}=(E=n.options)!=null?E:{};if(t.rows.length===0){r.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let o=e?"#111111":void 0,i=r.getBoundingClientRect().width||600,{inner:p,svg:a,tooltip:l,details:f}=wt(r,e),h=Math.max(i,700);p.style.width=h+"px",o&&(a.style.color=o);let S=300,x=h-48-10,y=S-28-28,g=t.rows.map(N=>{let b=N.x;if(b instanceof Date)return b.getTime();if(typeof b=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(b)){let V=new Date(b);if(!isNaN(V.getTime()))return V.getTime()}let L=Number(b);return isNaN(L)?null:L}return typeof b=="number"?b:null}),w=t.rows.map(N=>N.y),T=g.filter(N=>N!==null);if(T.length===0){r.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let A=Math.min(...T),_=Math.max(...T),M=Math.min(...w),z=Math.max(...w),$=N=>48+(N-A)/(_-A||1)*x,C=N=>S-28-(N-M)/(z-M||1)*y,v=document.createElementNS(a.namespaceURI,"line");v.setAttribute("x1",String(48)),v.setAttribute("y1",String(28)),v.setAttribute("x2",String(48)),v.setAttribute("y2",String(S-28)),v.setAttribute("stroke","currentColor"),a.appendChild(v);let u=document.createElementNS(a.namespaceURI,"line");u.setAttribute("x1",String(48)),u.setAttribute("y1",String(S-28)),u.setAttribute("x2",String(h-10)),u.setAttribute("y2",String(S-28)),u.setAttribute("stroke","currentColor"),a.appendChild(u),t.rows.forEach((N,b)=>{let L=g[b];if(L==null)return;let V=$(L),nt=C(w[b]),G=document.createElementNS(a.namespaceURI,"circle");G.setAttribute("cx",String(V)),G.setAttribute("cy",String(nt)),G.setAttribute("r","4"),G.setAttribute("fill",it(N.series,b)),G.style.cursor="pointer";let Q=N.x instanceof Date?N.x.toISOString().slice(0,10):typeof N.x=="string"?N.x:String(N.x);G.addEventListener("mouseenter",j=>{var tt,I;return mt(r,l,Q,N.y,(I=(tt=N.notes)==null?void 0:tt.length)!=null?I:0,j)}),G.addEventListener("mouseleave",()=>gt(l)),G.addEventListener("click",j=>{var tt;j.preventDefault(),yt(r,f,Q,N.y,(tt=N.notes)!=null?tt:[],s)}),a.appendChild(G)})}var ze=require("obsidian"),re=class{render(n,t,e,s,o=!1){var l;let{title:i}=(l=t.options)!=null?l:{};n.empty(),n.addClass("prop-charts-container");let a=n.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":he(n,t,e);break;case"stacked-bar":$e(n,t,e);break;case"line":fe(n,t,e,!1);break;case"area":fe(n,t,e,!0);break;case"pie":Qe(n,t,e);break;case"scatter":He(n,t,e);break;case"gantt":ee(n,t,e,s);break;default:n.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!o){let f=n.createEl("button",{cls:"chart-notes-zoom-button"});f.setAttr("type","button"),f.setAttr("aria-label","Expandir gr\xE1fico"),f.textContent="\u2922",f.addEventListener("click",h=>{h.preventDefault(),new me(t,e,this,s).open()})}}},me=class extends ze.Modal{constructor(t,e,s,o){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=s,this.ctx=o}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),s=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:s,cls:"chart-notes-zoom-title"});let o=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(l,f)=>{let h=o.createEl("button",{cls:"chart-notes-zoom-size-btn",text:l});(()=>{h.toggleClass("is-active",this.size===f)})(),h.addEventListener("click",x=>{x.preventDefault(),this.size=f,this.applySize(),o.querySelectorAll(".chart-notes-zoom-size-btn").forEach(g=>g.classList.remove("is-active")),h.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let p=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(p,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",s="85vh";switch(this.size){case"small":e="60vw",s="55vh";break;case"medium":e="80vw",s="70vh";break;case"large":default:e="95vw",s="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=s,t.style.maxHeight=s}};var se=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("loading Chart Notes plugin"),this.indexer=new jt(this.app),await this.indexer.buildIndex(),this.query=new te(()=>this.indexer.getAll(),[]),this.renderer=new re,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,s)=>{var f;let o;try{let h=(0,Lt.parseYaml)(t);if(!h||typeof h!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}o=h}catch(h){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+h.message});return}if(!o.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=o.type==="gantt",p=o.type==="table";if(!i&&!p){if(!o.encoding||!o.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let S=((f=o.aggregate)==null?void 0:f.y)==="count";if(!o.encoding.y&&!S){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}o.encoding||(o.encoding={}),o.source||(o.source={});let l;try{l=this.query.run(o)}catch(h){e.createEl("div",{text:"Chart Notes: erro na query: "+h.message});return}this.renderer.render(e,o,l)}),this.registerBasesView(ce,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new Xt(t,e,this.renderer),options:()=>[{type:"dropdown",key:"chartType",displayName:"Tipo do gr\xE1fico",default:"bar",options:{bar:"Barra","stacked-bar":"Barra empilhada",line:"Linha",area:"\xC1rea",pie:"Pizza",scatter:"Dispers\xE3o",gantt:"Gantt"}},{type:"text",key:"title",displayName:"T\xEDtulo (opcional)",placeholder:"(vazio = usa nome da view)"},{type:"property",key:"xProperty",displayName:"Propriedade X / label"},{type:"property",key:"yProperty",displayName:"Propriedade Y / valor (vazio = conta linhas)"},{type:"property",key:"seriesProperty",displayName:"S\xE9rie (opcional, gera legenda / cores)"},{type:"property",key:"startProperty",displayName:"In\xEDcio (Gantt)"},{type:"property",key:"endProperty",displayName:"Fim (Gantt)"},{type:"property",key:"dueProperty",displayName:"Due date (Gantt, opcional)"},{type:"property",key:"durationProperty",displayName:"Dura\xE7\xE3o em minutos (Gantt, opcional)"},{type:"property",key:"groupProperty",displayName:"Grupo / lane (Gantt / s\xE9ries, opcional)"},{type:"toggle",key:"drilldown",displayName:"Drilldown (clicar abre lista de notas)",default:!0},{type:"text",key:"background",displayName:"Cor de fundo (ex: #ffffff, opcional)",placeholder:"#ffffff"},{type:"multitext",key:"tooltipFields",displayName:"Campos extras no tooltip (ex: status,priority)",default:[]}]})}onunload(){console.log("unloading Chart Notes plugin")}};
