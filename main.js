/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var le=Object.defineProperty;var ze=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Oe=(o,n)=>{for(var t in n)le(o,t,{get:n[t],enumerable:!0})},Xe=(o,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of We(n))!Ye.call(o,r)&&r!==t&&le(o,r,{get:()=>n[r],enumerable:!(e=ze(n,r))||e.enumerable});return o};var qe=o=>Xe(le({},"__esModule",{value:!0}),o);var gn={};Oe(gn,{default:()=>oe});module.exports=qe(gn);var Lt=require("obsidian");var jt=require("obsidian"),ue="chartnotes-view",je=["bar","stacked-bar","line","area","pie","scatter","gantt"];function Ze(o){let n=String(o!=null?o:"bar").trim().toLowerCase();return je.includes(n)?n:"bar"}var Je=["sum","count","cumulative-sum"];function tn(o){let n=String(o!=null?o:"sum").trim().toLowerCase();return Je.includes(n)?n:"sum"}var en=["auto","none","day","week","month","quarter","year"];function nn(o){let n=String(o!=null?o:"auto").trim().toLowerCase();return en.includes(n)?n:"auto"}var Xt="(missing)",qt=class extends jt.BasesView{constructor(t,e,r){super(t);this.type=ue;this.renderer=r,this.rootEl=e.createDiv("chartnotes-bases-view")}onDataUpdated(){var $,U,O;this.rootEl.empty();let t=this.data,e=($=t==null?void 0:t.groupedData)!=null?$:[];if(!e.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let r=this.config,s=Ze((U=r==null?void 0:r.get("chartType"))!=null?U:"bar"),i=s==="pie",u=s==="scatter",a=s==="gantt",c=tn(r==null?void 0:r.get("aggregateMode")),x=c==="cumulative-sum"&&!(s==="line"||s==="area")?"sum":c,m=nn(r==null?void 0:r.get("xBucket")),l=i||u||a?"none":m,w=this.getPropFromConfig("xProperty"),A=this.getPropFromConfig("ganttLabelProperty"),T=a&&A.id?A:w,v=this.getPropFromConfig("yProperty"),S=this.getPropFromConfig("seriesProperty");i&&(S={id:null,name:null});let P=this.getPropFromConfig("startProperty"),M=this.getPropFromConfig("endProperty"),F=this.getPropFromConfig("dueProperty"),B=this.getPropFromConfig("durationProperty"),b=this.getPropFromConfig("groupProperty");if(!a&&!T.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(u&&(!T.id||!v.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(P.id||M.id||F.id||B.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs at least Start/End or Due/Duration configured."});return}let D;if(a)D=this.buildRowsForGantt(e,T,S,P,M,F,B,b);else if(u)D=this.buildRowsForScatter(e,T,v,S);else{let _=i;D=this.buildRowsForAggregatedCharts(e,T,v,S,x,l,_)}if(!D.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let p={rows:D},C=((O=r==null?void 0:r.get("title"))!=null?O:"").trim()||(r==null?void 0:r.name)||"Chart Notes (Bases)",g=r==null?void 0:r.get("drilldown"),E=typeof g=="boolean"?g:!0,K=this.buildEncoding({x:T,y:v,series:S,start:P,end:M,due:F,duration:B,group:b,aggMode:x,xBucket:l,chartType:s}),q={type:s,source:{type:"properties",query:""},encoding:K,options:{title:C,drilldown:E}},Q={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,q,p,Q)}getPropFromConfig(t){var u,a;let e=this.config,r=(u=e==null?void 0:e.get)==null?void 0:u.call(e,t);if(!r)return{id:null,name:null};let s=r.trim();if(!s||s==="undefined"||s==="null")return{id:null,name:null};let i=s;try{let c=(0,jt.parsePropertyId)(i);return{id:i,name:(a=c.name)!=null?a:i}}catch(c){return{id:i,name:i}}}readValue(t,e){if(!e.id)return null;let r;try{r=t.getValue(e.id)}catch(s){return null}if(r==null)return null;try{if(typeof r.isEmpty=="function"&&r.isEmpty())return null}catch(s){}try{let s=r.toString();if(s==null)return null;let i=String(s).trim();return i.length?i:null}catch(s){return null}}parseDate(t){if(!t)return null;let e=new Date(t.trim());return Number.isNaN(e.getTime())?null:e}compareX(t,e){let r=this.parseDate(t!=null?String(t):null),s=this.parseDate(e!=null?String(e):null);if(r&&s)return r.getTime()-s.getTime();let i=Number(t),u=Number(e);return!Number.isNaN(i)&&!Number.isNaN(u)?i-u:String(t!=null?t:"").localeCompare(String(e!=null?e:""))}fmtDate(t){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${r}-${s}`}startOfWeek(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=(e.getDay()+6)%7;return e.setDate(e.getDate()-r),e.setHours(0,0,0,0),e}bucketX(t,e){let r=this.parseDate(t);if(!r)return t;switch(e){case"none":case"auto":return t;case"day":{let s=new Date(r.getFullYear(),r.getMonth(),r.getDate());return this.fmtDate(s)}case"week":{let s=this.startOfWeek(r);return`${this.fmtDate(s)} (W)`}case"month":{let s=String(r.getMonth()+1).padStart(2,"0");return`${r.getFullYear()}-${s}`}case"quarter":{let s=Math.floor(r.getMonth()/3)+1;return`${r.getFullYear()}-Q${s}`}case"year":return`${r.getFullYear()}`;default:return t}}getXValuesForEntry(t,e,r,s){var h,x;let i=[],u=m=>this.bucketX(m,r);if(!e.id){let m=t.file,l=m!=null&&m.name?String(m.name):String((h=m==null?void 0:m.path)!=null?h:Xt);return i.push(u(l)),i}if(!s){let m=(x=this.readValue(t,e))!=null?x:Xt;return i.push(u(m)),i}let a=null;try{a=t.getValue(e.id)}catch(m){a=null}let c=m=>{if(!m)return;let l=String(m).trim();l&&i.push(u(l))};if(a==null)c(Xt);else if(typeof a=="string"){let m=a.trim();if(m){let l=m.split(/\s+/);for(let w of l)c(w)}}else if(Array.isArray(a))for(let m of a){if(m==null)continue;let l;try{l=m.toString()}catch(w){continue}c(l)}else if(typeof a.toArray=="function"){let m=a.toArray();if(Array.isArray(m))for(let l of m){if(l==null)continue;let w;try{w=l.toString()}catch(A){continue}c(w)}else{let l;try{l=a.toString()}catch(w){l=""}c(l)}}else{let m;try{m=a.toString()}catch(l){m=""}c(m)}return i.length||c(Xt),i}buildRowsForAggregatedCharts(t,e,r,s,i,u,a){let c=new Map,h=a||i==="count"||!r.id&&i!=="sum",x=r.name||"y";for(let l of t)for(let w of l.entries){let A=w.file,T=this.getXValuesForEntry(w,e,u,a),v=1,S=null;if(!h&&r.id){if(S=this.readValue(w,r),S==null)continue;let F=Number(S);if(Number.isNaN(F))continue;v=F}else v=1;let P=this.readValue(w,s),M=P!=null?String(P):void 0;for(let F of T){let B=`${F}@@${M!=null?M:""}`,b=c.get(B);b||(b={x:F,y:0,series:M,notes:[],props:{}},c.set(B,b)),b.y+=v,A!=null&&A.path&&b.notes.push(A.path),b.props&&e.name&&(b.props[e.name]=F),!h&&b.props&&x&&S!=null&&(b.props[x]=b.y),h&&b.props&&(b.props[x]=b.y),b.props&&s.name&&P!=null&&(b.props[s.name]=P)}}let m=Array.from(c.values());return i==="cumulative-sum"?this.toCumulative(m):m}toCumulative(t){var s,i;let e=new Map;for(let u of t){let a=(s=u.series)!=null?s:"__no_series__",c=e.get(a);c||(c=[],e.set(a,c)),c.push(u)}let r=[];for(let[,u]of e){let a=[...u].sort((h,x)=>this.compareX(h.x,x.x)),c=0;for(let h of a){let x=Number((i=h.y)!=null?i:0);Number.isNaN(x)||(c+=x,r.push({...h,y:c}))}}return r}buildRowsForScatter(t,e,r,s){let i=[];for(let u of t)for(let a of u.entries){let c=a.file,h=this.readValue(a,e),x=this.readValue(a,r);if(h==null||x==null)continue;let m=Number(h),l=Number(x);if(Number.isNaN(m)||Number.isNaN(l))continue;let w=this.readValue(a,s),A=w!=null?String(w):void 0;i.push({x:m,y:l,series:A,notes:c!=null&&c.path?[c.path]:[],props:{}})}return i}buildRowsForGantt(t,e,r,s,i,u,a,c){var l,w;let h=[];for(let A of t)for(let T of A.entries){let v=T.file,S=this.readValue(T,s),P=this.readValue(T,i),M=this.readValue(T,u),F=this.readValue(T,a),B=F!=null?Number(F):NaN,b=Number.isFinite(B)&&B>0,D=b?B*6e4:36e5,p=this.parseDate(S),k=this.parseDate(P),C=this.parseDate(M),g=p,E=k;if(g&&E||(g&&b&&!E?E=new Date(g.getTime()+D):!g&&E&&b?g=new Date(E.getTime()-D):!g&&!E&&C&&b?(E=C,g=new Date(C.getTime()-D)):g&&!E&&!b?E=new Date(g.getTime()+36e5):!g&&E&&!b?g=new Date(E.getTime()-36e5):!g&&!E&&C&&!b&&(g=C,E=new Date(C.getTime()+36e5))),!g||!E)continue;if(g.getTime()>E.getTime()){let O=g;g=E,E=O}let K=(w=this.readValue(T,e))!=null?w:v!=null&&v.name?String(v.name).replace(/\.md$/i,""):String((l=v==null?void 0:v.path)!=null?l:""),q=this.readValue(T,r),Q=q!=null?String(q):void 0,$=this.readValue(T,c),U={};s.name&&g&&(U[s.name]=g),i.name&&E&&(U[i.name]=E),u.name&&C&&(U[u.name]=C),b&&a.name&&(U[a.name]=B),c.name&&$!=null&&(U[c.name]=$),h.push({x:K,y:0,series:Q,start:g,end:E,due:C!=null?C:void 0,notes:v!=null&&v.path?[v.path]:[],props:U})}return h.sort((A,T)=>!A.start||!T.start?0:A.start.getTime()-T.start.getTime()),h}buildEncoding(t){var s,i,u,a,c,h,x,m;let e=(s=t.x.name)!=null?s:"x",r=(i=t.y.name)!=null?i:"y";return{x:e,y:r,series:(u=t.series.name)!=null?u:"series",start:(a=t.start.name)!=null?a:"start",end:(c=t.end.name)!=null?c:"end",due:(h=t.due.name)!=null?h:"due",duration:(x=t.duration.name)!=null?x:"duration",group:(m=t.group.name)!=null?m:"group"}}};var ke=require("obsidian"),Zt=class{constructor(n){this.index=new Map;this.app=n}async buildIndex(){this.index.clear();let n=this.app.vault.getMarkdownFiles();for(let t of n)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(n){if(n.extension!=="md")return;let t={};try{let r=(await this.app.vault.read(n)).match(/^---\n([\s\S]*?)\n---\n?/);if(r){let i=(0,ke.parseYaml)(r[1])||{};if(i&&typeof i=="object")for(let[u,a]of Object.entries(i))u!=="position"&&(t[u]=a)}let s=this.app.metadataCache.getFileCache(n);s!=null&&s.tags&&!t.tags&&(t.tags=s.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",n.path,e)}this.index.set(n.path,{path:n.path,props:t})}removeFile(n){this.index.delete(n.path)}};function Pe(o,n){if(!n||n.length===0)return!0;for(let t of n){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Le(o,n){if(!n||n.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let r of n)if(t.includes(r)||t.includes("#"+r))return!0;return!1}let e=String(t);for(let r of n)if(e===r||e==="#"+r)return!0;return!1}function te(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function $t(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,r]=o.split("-");return new Date(Number(t),Number(e)-1,Number(r),0,0,0,0)}let n=new Date(o);return isNaN(n.getTime())?null:n}function ut(o){let n=new Date(o);return n.setHours(0,0,0,0),n}function Jt(o,n){let t=new Date(o);return t.setDate(t.getDate()-n),t}function rn(o,n){return Jt(o,n*7)}function sn(o,n){let t=new Date(o);return t.setMonth(t.getMonth()-n),t}function pe(o,n){let t=new Date(o);return t.setDate(t.getDate()+n),t}function on(o,n){return pe(o,n*7)}function an(o,n){let t=new Date(o);return t.setMonth(t.getMonth()+n),t}function Re(o){let n=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(n)||n.endsWith("date")||n.endsWith("at")||n.endsWith("on"))}function Ne(o,n){let t=n?new Date(n):new Date,e=ut(t),r=o.trim().toLowerCase();if(r==="today")return e;if(r==="yesterday")return ut(Jt(e,1));if(/^-\d+$/.test(r)){let s=parseInt(r.slice(1),10);return ut(Jt(e,s))}if(/^-\d+d$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(Jt(e,s))}if(/^-\d+w$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(rn(e,s))}if(/^-\d+m$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(sn(e,s))}if(/^\+\d+$/.test(r)){let s=parseInt(r.slice(1),10);return ut(pe(e,s))}if(/^\+\d+d$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(pe(e,s))}if(/^\+\d+w$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(on(e,s))}if(/^\+\d+m$/.test(r)){let s=parseInt(r.slice(1,-1),10);return ut(an(e,s))}return null}function Ie(o){let n=o.trim(),t=n.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let h=t[1].trim(),x=t[2].trim(),m=t[3].trim(),l=Re(h),w=de(x,l),A=de(m,l),T=w.valueType==="date"||A.valueType==="date"?"date":w.valueType;return{field:h,op:"between",value:w.value,value2:A.value,valueType:T}}let e=/(==|!=|>=|<=|>|<)/,r=n.split(e);if(r.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let s=r[0].trim(),i=r[1].trim(),u=r[2].trim(),a=Re(s),c=de(u,a);return{field:s,op:i,value:c.value,valueType:c.valueType}}function de(o,n){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),r=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(n){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Ne(t);if(i)return{value:i,valueType:"date"}}else if(r){let i=Ne(t);if(i)return{value:i,valueType:"date"}}if(te(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let s=Number(t);return Number.isNaN(s)?{value:t,valueType:"string"}:{value:s,valueType:"number"}}function _e(o,n){let t=o[n.field];if(t==null)return!1;if(n.valueType==="date"){let s=t instanceof Date?ut(t):te(t)?ut($t(t)):null;if(!s)return!1;let i=n.value instanceof Date?n.value:null,u=n.value2 instanceof Date?n.value2:null;if(!i)return!1;let a=s.getTime(),c=ut(i).getTime();switch(n.op){case"==":return a===c;case"!=":return a!==c;case">":return a>c;case">=":return a>=c;case"<":return a<c;case"<=":return a<=c;case"between":if(!u)return!1;let h=ut(u).getTime();return a>=c&&a<=h}}if(n.valueType==="number"){let s=Number(t);if(isNaN(s))return!1;let i=Number(n.value);switch(n.op){case"==":return s===i;case"!=":return s!==i;case">":return s>i;case">=":return s>=i;case"<":return s<i;case"<=":return s<=i;case"between":return typeof n.value2!="number"?!1:s>=i&&s<=n.value2}}let e=String(t),r=String(n.value);switch(n.op){case"==":return e===r;case"!=":return e!==r;case">":return e>r;case">=":return e>=r;case"<":return e<r;case"<=":return e<=r;case"between":return!1}}function cn(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(te(o)){let n=$t(o);if(n)return{key:n,isDate:!0}}return{key:o,isDate:!1}}function ln(o,n){let t=o.x,e=n.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let r=String(t),s=String(e);return r<s?-1:r>s?1:0}function un(o,n){var s,i;let t=ln(o,n);if(t!==0)return t;let e=(s=o.series)!=null?s:"",r=(i=n.series)!=null?i:"";return e<r?-1:e>r?1:0}function dn(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let n=o.trim().match(/^(\d+)/);if(n){let t=Number(n[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function pn(o){var e,r;let n=new Map,t=[];for(let s of o){let i=(e=s.series)!=null?e:"__no_series__",a=((r=n.get(i))!=null?r:0)+s.y;n.set(i,a),t.push({...s,y:a})}return t}function hn(o,n){var i,u;let t=dn(n);if(!t||t<=1)return[...o];let e=new Map,r=new Map,s=[];for(let a of o){let c=(i=a.series)!=null?i:"__no_series__",h=e.get(c);h||(h=[],e.set(c,h));let x=(u=r.get(c))!=null?u:0;if(h.push(a.y),x+=a.y,h.length>t){let w=h.shift();x-=w}r.set(c,x);let m=h.length||1,l=x/m;s.push({...a,y:l})}return s}var ee=class{constructor(n,t){this.getIndex=n,this.defaultPaths=t}run(n){var i,u,a;let t=this.getIndex(),e=(i=n.source)!=null&&i.paths&&n.source.paths.length?n.source.paths:this.defaultPaths,r=(u=n.source)!=null&&u.tags&&n.source.tags.length?n.source.tags:[],s=[];for(let c of t){let h=e&&e.length?Pe(c.path,e):!0,x=r&&r.length?Le(c.props,r):!0;if(!h||!x)continue;let m=!0;if((a=n.source)!=null&&a.where&&n.source.where.length>0)for(let l of n.source.where){let w;try{w=Ie(l)}catch(A){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${l} (${A.message})`)}if(!_e(c.props,w)){m=!1;break}}m&&s.push(c)}return n.type==="gantt"?this.runGantt(n,s):n.type==="table"?this.runTable(n,s):this.runStandard(n,s)}runTable(n,t){var r,s;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(r=n.encoding)==null?void 0:r.x,yField:(s=n.encoding)==null?void 0:s.y}}runGantt(n,t){var x,m,l;let e=(x=n.encoding)!=null?x:{},r=e.start,s=e.end,i=(m=e.label)!=null?m:e.x,u=e.series,a=e.duration,c=e.due,h=[];for(let w of t){let A=(l=w.props)!=null?l:{},T=b=>Array.isArray(b)?b[0]:b,v=null;if(s){let b=T(A[s]),D=$t(b);D&&(v=D)}if(!v)continue;let S=null;if(r){let b=T(A[r]),D=$t(b);D&&(S=D)}if(!S&&a){let b=T(A[a]),D=Number(b);Number.isNaN(D)||(S=new Date(v.getTime()-D*6e4))}S||(S=new Date(v.getTime()));let P;if(c){let b=T(A[c]),D=$t(b);D&&(P=D)}let M;if(i){let b=T(A[i]);(b==null||b==="")&&(b=w.path),M=b}else M=w.path;let F;if(u){let b=T(A[u]);b!=null&&(F=String(b))}let B={x:M,y:0,notes:[w.path],series:F,start:S,end:v,props:A};P&&(B.due=P),h.push(B)}return h.sort((w,A)=>{let T=w.start?w.start.getTime():0,v=A.start?A.start.getTime():0;return T-v}),{rows:h,xField:i,yField:s}}runStandard(n,t){var w,A,T,v,S,P,M,F,B,b;let e=(w=n.encoding)==null?void 0:w.x,r=(A=n.encoding)==null?void 0:A.y,s=(T=n.encoding)==null?void 0:T.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(v=n.aggregate)!=null?v:{},u=(S=i.y)!=null?S:null,a=!!i.cumulative,c=i.rolling;if(!r&&u!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let h=[];for(let D of t){let p=(P=D.props)!=null?P:{},k=$=>Array.isArray($)?$[0]:$,C=k(p[e]);if(C==null)continue;let g=cn(C),E=g.key,K=g.isDate,q;if(s){let $=k(p[s]);$!=null&&String($).trim()!==""&&(q=String($))}let Q;if(u==="count")Q=1;else{let $=k(p[r]);if($==null)continue;let U=Number($);if(Number.isNaN(U))continue;Q=U}h.push({x:E,y:Q,notes:[D.path],series:q,props:p,_isDate:K,_origX:C})}if(h.length===0)return{rows:[],xField:e,yField:r};let x=[];if(u){let D=new Map;for(let p of h){let k=(M=p.series)!=null?M:"",C=p.x instanceof Date?p.x.toISOString().slice(0,10):String(p.x),g=k+"||"+C,E=(F=D.get(g))!=null?F:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:p.x,isDate:p._isDate,series:p.series,props:p.props};E.sum+=p.y,E.count+=1,p.y<E.min&&(E.min=p.y),p.y>E.max&&(E.max=p.y),E.notes.push(...p.notes),E.props=(B=p.props)!=null?B:E.props,D.set(g,E)}for(let[,p]of D){let k=p.sum;switch(u){case"sum":k=p.sum;break;case"avg":k=p.sum/p.count;break;case"min":k=p.min;break;case"max":k=p.max;break;case"count":k=p.count;break}x.push({x:p.xRep,y:k,notes:p.notes,series:p.series,props:p.props})}}else x=h.map(D=>({x:D.x,y:D.y,notes:D.notes,series:D.series,props:D.props}));if(x.length===0)return{rows:[],xField:e,yField:r};let m=((b=n.sort)==null?void 0:b.x)==="desc"?"desc":"asc";if(x.sort((D,p)=>{let k=un(D,p);return m==="asc"?k:-k}),(a||c)&&!(n.type==="line"||n.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&c)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let l=x;return c?l=hn(x,c):a&&(l=pn(x)),{rows:l,xField:e,yField:r}}};var Ct=require("obsidian");var Fe=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,n){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,r)=>e*33+r.charCodeAt(0)>>>0,0);return Fe[t%Fe.length]}function wt(o,n){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,n&&(e.style.background=n);let r="http://www.w3.org/2000/svg",s=document.createElementNS(r,"svg");s.setAttribute("width","100%"),s.setAttribute("height",String(300)),s.style.display="block",e.appendChild(s);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let u=o.createDiv({cls:"chart-notes-details"});return u.style.display="none",{scroll:t,inner:e,svg:s,tooltip:i,details:u}}function mt(o,n,t,e,r,s){let i=o.getBoundingClientRect(),u=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);n.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${u}</div>
    <div class="chart-notes-tooltip-notes">${r} nota${r===1?"":"s"}</div>
  `,n.style.display="block";let a=n.getBoundingClientRect(),c=s.clientX-i.left+6,h=s.clientY-i.top+6;c+a.width>i.width-4&&(c=i.width-a.width-4),c<4&&(c=4),h+a.height>i.height-4&&(h=i.height-a.height-4),h<4&&(h=4),n.style.left=c+"px",n.style.top=h+"px"}function ft(o){o.style.display="none"}function yt(o,n,t,e,r,s){if(!s)return;if(n.empty(),!r||r.length===0){n.style.display="none";return}n.style.display="block";let i=n.createEl("div",{cls:"chart-notes-details-header"}),u=i.createEl("div",{cls:"chart-notes-details-title"});u.textContent=`Notas em "${t}" (${r.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{n.style.display="none"});let c=n.createEl("ul",{cls:"chart-notes-details-list"});for(let h of r){let m=c.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:h});m.href="#",m.addEventListener("click",l=>{l.preventDefault(),app.workspace.openLinkText(h,"",!1)})}}function Qt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let n=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${n}/${t}`}function $e(o){if(!o)return!1;let n=o.trim().toLowerCase();if(n==="#fff"||n==="#ffffff"||n==="white")return!0;if(!n.startsWith("#"))return!1;let t,e,r;if(n.length===4)t=parseInt(n[1]+n[1],16),e=parseInt(n[2]+n[2],16),r=parseInt(n[3]+n[3],16);else if(n.length===7)t=parseInt(n.slice(1,3),16),e=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*r)/255>.7}var he=class extends Ct.Modal{constructor(t,e,r,s){var u;super(app);this.notePath=t,this.spec=e,this.refresh=r,this.reindexFile=s;let i=(u=e.encoding)!=null?u:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var b,D;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let r=await this.app.vault.read(e),s={},i=r,u=/^---\n([\s\S]*?)\n---\n?/m.exec(r);if(u){try{s=(b=(0,Ct.parseYaml)(u[1]))!=null?b:{}}catch(p){s={}}i=r.slice(u[0].length)}(typeof s!="object"||s==null)&&(s={});let a=(D=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?D:this.notePath,c=t.createDiv({cls:"gantt-edit-header"}),h=c.createEl("a",{text:a,cls:"gantt-edit-title"});h.href="#",h.addEventListener("click",p=>{p.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let x=c.createDiv({cls:"gantt-edit-subtitle"});x.textContent=this.notePath;let m=t.createDiv({cls:"gantt-edit-form"}),l=p=>{let k=m.createDiv({cls:"gantt-edit-row"}),C=k.createDiv({cls:"gantt-edit-label"});C.textContent=p;let g=k.createDiv({cls:"gantt-edit-field"});return{row:k,field:g}},w=p=>{if(!p)return"";let C=String(p).match(/^(\d{4}-\d{2}-\d{2})/);return C?C[1]:""},A=p=>{if(p=p.trim(),!!p&&/^\d{4}-\d{2}-\d{2}$/.test(p))return p},T=null;if(this.startKey){let{field:p}=l(this.startKey+" (in\xEDcio)");T=p.createEl("input",{type:"date"}),T.value=w(s[this.startKey])}let v=null;if(this.endKey){let{field:p}=l(this.endKey+" (fim)");v=p.createEl("input",{type:"date"}),v.value=w(s[this.endKey])}let S=null;if(this.durationKey){let{field:p}=l(this.durationKey+" (minutos)");S=p.createEl("input",{type:"number"});let k=s[this.durationKey];S.value=k!=null?String(k):"",S.min="0",S.step="5"}let P=null;if(this.dueKey){let{field:p}=l(this.dueKey+" (due)");P=p.createEl("input",{type:"date"}),P.value=w(s[this.dueKey])}let M=t.createDiv({cls:"gantt-edit-buttons"}),F=M.createEl("button",{text:"Salvar",cls:"mod-cta"});M.createEl("button",{text:"Cancelar"}).addEventListener("click",p=>{p.preventDefault(),this.close()}),F.addEventListener("click",async p=>{if(p.preventDefault(),this.startKey&&T){let g=A(T.value);g?s[this.startKey]=g:delete s[this.startKey]}if(this.endKey&&v){let g=A(v.value);g?s[this.endKey]=g:delete s[this.endKey]}if(this.durationKey&&S){let g=S.value.trim();if(g==="")delete s[this.durationKey];else{let E=Number(g);Number.isNaN(E)||(s[this.durationKey]=E)}}if(this.dueKey&&P){let g=A(P.value);g?s[this.dueKey]=g:delete s[this.dueKey]}let C=`---
${(0,Ct.stringifyYaml)(s).trim()}
---
`+i;if(await this.app.vault.modify(e,C),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(g){}if(this.refresh)try{this.refresh()}catch(g){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(o,n,t,e){var be,xe,Se,ve,we,Ae,Ee,De;let r=(be=n.options)!=null?be:{},s=r.background,i=(xe=r.drilldown)!=null?xe:!0,u=!0,a=d=>{if(d==null)return"";let L=String(d).trim();if(!L)return"";let H=L.match(/^\[\[(.+?)\]\]$/);H&&(L=H[1]);let X=L.lastIndexOf("/");return X>=0&&X<L.length-1&&(L=L.slice(X+1)),L};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(d=>d.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let c=t.rows.filter(d=>d.start&&d.end);if(c.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let h=n.encoding,x=h.group,m=h.duration,l=(d,L)=>{if(!d||!L)return;let H=d[L];return Array.isArray(H)?H[0]:H},A=c.map(d=>{var xt,lt;let L=d.start,H=d.end,X=d.props,It=typeof d.x=="string"?d.x:d.x instanceof Date?Qt(L):String(d.x),At=a(It),bt,_t=x?l(X,x):void 0;_t!=null?bt=String(_t):d.series!=null?bt=String(d.series):bt=At;let gt=(xt=d.notes)==null?void 0:xt[0],Et=gt?(lt=gt.replace(/\.md$/i,"").split("/").pop())!=null?lt:gt:At,Tt=d.due,Ft,Nt=l(X,m);if(Nt!=null){let St=Number(Nt);Number.isNaN(St)||(Ft=St)}return{row:d,start:L,end:H,props:X,fullName:At,groupKey:bt,notePath:gt,noteTitle:Et,due:Tt,estMinutes:Ft}}).filter(d=>d.start instanceof Date&&!isNaN(d.start.getTime())&&d.end instanceof Date&&!isNaN(d.end.getTime()));if(A.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}A.sort((d,L)=>{if(d.groupKey<L.groupKey)return-1;if(d.groupKey>L.groupKey)return 1;let H=d.start.getTime(),X=L.start.getTime();return H!==X?H-X:d.fullName.localeCompare(L.fullName)});let T=26,v=0,S=null;for(let d of A)d.groupKey!==S&&(S=d.groupKey,v+=1),v+=1;let P=Math.min(...A.map(d=>d.start.getTime())),M=Math.max(...A.map(d=>d.end.getTime()));if(!isFinite(P)||!isFinite(M)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let F=24*60*60*1e3,B=d=>{let L=new Date(d);return L.setHours(0,0,0,0),L.getTime()},b=B(P),D=B(M),p=o.querySelector(".prop-charts-title-row");p||(p=o.createDiv({cls:"prop-charts-title-row"}));let k=o.dataset.ganttZoomMode||String((Se=r.zoomMode)!=null?Se:"100");o.dataset.ganttZoomMode=k;let C=o.dataset.ganttLabelMode||String((ve=r.labelMode)!=null?ve:"compact");o.dataset.ganttLabelMode=C;let g=p.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(d=>{let L=g.createEl("button",{cls:"gantt-zoom-btn",text:d.label});d.id===k&&L.addClass("is-active"),L.addEventListener("click",H=>{H.preventDefault(),o.dataset.ganttZoomMode=d.id,ne(o,n,t,e)})}),g.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",d=>{d.preventDefault();let L=o.querySelector(".chart-notes-zoom-button");L&&L.click()});let q=Number(r.labelWidth),Q=!Number.isNaN(q)&&q>120?q:260,$=C==="wide"?Q+160:Q,U=o.getBoundingClientRect().width||600,O=Math.max(U,820),_;if(k==="fit")_=U;else{let d=Number(k)/100||1;_=O*d}let{inner:f,svg:y,tooltip:R,details:N}=wt(o,s);f.style.width=_+"px";let I=(d,L,H,X,It,At,bt,_t,gt)=>{if(!d)return;let Et=Math.max(40,X-8),Ft=Math.max(8,Math.floor(Et/6)),Nt=d.split(/\s+/),xt=[],lt="";for(let Mt of Nt){if(!lt){lt=Mt;continue}(lt+" "+Mt).length<=Ft?lt+=" "+Mt:(xt.push(lt),lt=Mt)}lt&&xt.push(lt);let St=It+2,Gt=xt.length*St,Vt=H-Gt/2+It;xt.forEach((Mt,Yt)=>{let ot=document.createElementNS(y.namespaceURI,"text");ot.setAttribute("x",String(L)),ot.setAttribute("y",String(Vt+Yt*St)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),At&&ot.setAttribute("font-weight",At),ot.textContent=Mt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),_t&&ot.addEventListener("mouseleave",()=>_t()),gt&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>gt(rt))),y.appendChild(ot)})},tt=28,V=28,st=10,j=Math.max(300,tt+V+v*T+24);y.setAttribute("height",String(j));let z=_-$-st,W=tt+6;y.style.color="#111111";let et=D+F-b||1,at=b-et*.02,ht=D+F+et*.08,ct=d=>$+(d-at)/(ht-at)*z,G=(ht-at)/F,Rt=Math.max(4,Math.min(12,Math.floor(z/90)||4)),dt=G/Rt,J=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=J[J.length-1];for(let d of J)if(d>=dt){pt=d;break}let Ut=[],Ke=B(at);for(let d=Ke;d<=ht+.5*F;d+=pt*F)Ut.push(d);let Bt=document.createElementNS(y.namespaceURI,"line");Bt.setAttribute("x1",String($)),Bt.setAttribute("y1",String(W)),Bt.setAttribute("x2",String(_-st)),Bt.setAttribute("y2",String(W)),Bt.setAttribute("stroke","#111111"),y.appendChild(Bt);for(let d of Ut){let L=ct(d),H=document.createElementNS(y.namespaceURI,"line");H.setAttribute("x1",String(L)),H.setAttribute("y1",String(W)),H.setAttribute("x2",String(L)),H.setAttribute("y2",String(j-V)),H.setAttribute("stroke","#111111"),H.setAttribute("stroke-opacity","0.20"),H.setAttribute("stroke-dasharray","2,4"),y.appendChild(H);let X=document.createElementNS(y.namespaceURI,"text");X.setAttribute("x",String(L)),X.setAttribute("y",String(W-4)),X.setAttribute("text-anchor","middle"),X.setAttribute("font-size","10"),X.setAttribute("fill","#111111"),X.textContent=Qt(new Date(d)),y.appendChild(X)}let ye=new Date;ye.setHours(0,0,0,0);let ie=ye.getTime();if(ie>=at&&ie<=ht){let d=ct(ie),L=document.createElementNS(y.namespaceURI,"line");L.setAttribute("x1",String(d)),L.setAttribute("y1",String(W)),L.setAttribute("x2",String(d)),L.setAttribute("y2",String(j-V)),L.setAttribute("stroke","#4caf50"),L.setAttribute("stroke-width","2"),L.setAttribute("stroke-dasharray","4,2"),y.appendChild(L);let H=document.createElementNS(y.namespaceURI,"text");H.setAttribute("x",String(d+4)),H.setAttribute("y",String(W+12)),H.setAttribute("font-size","10"),H.setAttribute("fill","#4caf50"),H.textContent="hoje",y.appendChild(H)}let Wt=f.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Wt.setAttr("title",C==="wide"?"Compactar nomes":"Expandir nomes"),Wt.style.left=`${$}px`,Wt.style.top="4px",Wt.addEventListener("click",d=>{d.preventDefault();let H=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=H,ne(o,n,t,e)});let Ue=["status","priority"],ae=Array.isArray(r.tooltipFields)?r.tooltipFields.map(d=>String(d)):null,Ve=ae&&ae.length?ae:Ue,Ht=0,ce=null;for(let d of A){let L=d.start,H=d.end,X=(H.getTime()-L.getTime())/6e4,It=d.props,At=d.notePath,bt=d.noteTitle,_t=(Ae=(we=d.row.notes)==null?void 0:we.length)!=null?Ae:0,gt=d.due,Et=d.estMinutes,Tt=[];Tt.push(`${Qt(L)} \u2192 ${Qt(H)}`),typeof Et=="number"&&!Number.isNaN(Et)?Tt.push(`est: ${Math.round(Et)} min`):X>0&&Tt.push(`dura\xE7\xE3o: ${Math.round(X)} min`),gt instanceof Date&&Tt.push(`due: ${Qt(gt)}`);for(let nt of Ve){let Y=l(It,nt);Y!=null&&String(Y).trim()!==""&&Tt.push(`${nt}: ${String(Y)}`)}let Ft=Tt.join("<br>"),Nt=nt=>{var Y;nt.preventDefault(),u&&At?new he(At,n,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(o,N,bt,Et!=null?Et:X,(Y=d.row.notes)!=null?Y:[],i)},xt=nt=>{bt&&Ft&&mt(o,R,bt,Ft,_t,nt)},lt=()=>ft(R);if(d.groupKey!==ce){ce=d.groupKey;let nt=W+8+Ht*T+T/2,Y=a(ce);I(Y,4,nt,$-12,11,"600"),Ht+=1}let St=W+8+Ht*T,Gt=T-10,Vt=ct(L.getTime()),Mt=ct(H.getTime()),Yt=Math.max(4,Mt-Vt),ot=d.fullName,rt=document.createElementNS(y.namespaceURI,"rect");rt.setAttribute("x",String(Vt)),rt.setAttribute("y",String(St)),rt.setAttribute("width",String(Yt)),rt.setAttribute("height",String(Gt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ee=d.row.series)!=null?Ee:ot,Ht)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=u&&At?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",lt),rt.addEventListener("click",Nt),y.appendChild(rt);let Ce=St+Gt/2;if(Yt>=6){let nt=it((De=d.row.series)!=null?De:ot,Ht),Y=document.createElementNS(y.namespaceURI,"circle");Y.setAttribute("cx",String(Vt)),Y.setAttribute("cy",String(Ce)),Y.setAttribute("r","3.5"),Y.setAttribute("fill","#ffffff"),Y.setAttribute("stroke",nt),Y.setAttribute("stroke-width","1.5"),y.appendChild(Y);let Pt=document.createElementNS(y.namespaceURI,"circle");Pt.setAttribute("cx",String(Mt)),Pt.setAttribute("cy",String(Ce)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),y.appendChild(Pt)}let Te=St+Gt/2+2,Ot=x?16:4;if(C==="wide")I(ot,Ot,Te,$-Ot-4,11,null,xt,lt,Nt);else{let nt=ot,Y=Math.max(40,$-Ot-8),Me=Math.max(8,Math.floor(Y/6));nt.length>Me&&(nt=nt.slice(0,Me-1)+"\u2026");let vt=document.createElementNS(y.namespaceURI,"text");vt.setAttribute("x",String(Ot)),vt.setAttribute("y",String(Te)),vt.setAttribute("text-anchor","start"),vt.setAttribute("font-size","11"),vt.setAttribute("fill","#111111"),vt.textContent=nt,vt.style.cursor="pointer",vt.addEventListener("mouseenter",xt),vt.addEventListener("mouseleave",lt),vt.addEventListener("click",Nt),y.appendChild(vt)}if(gt instanceof Date){let nt=ct(gt.getTime()),Y=document.createElementNS(y.namespaceURI,"line");Y.setAttribute("x1",String(nt)),Y.setAttribute("y1",String(St)),Y.setAttribute("x2",String(nt)),Y.setAttribute("y2",String(St+Gt)),Y.setAttribute("stroke","#ff6b6b"),Y.setAttribute("stroke-width","2"),Y.setAttribute("stroke-dasharray","4,2"),y.appendChild(Y)}Ht+=1}if(u){let d=o.createDiv({cls:"prop-charts-empty"});d.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function ge(o,n,t){var $,U,O,_;let e=($=n.options)!=null?$:{},r=e.background,s=(U=e.drilldown)!=null?U:!0,i=(O=t.rows)!=null?O:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:u,svg:a,tooltip:c,details:h}=wt(o,r),x=o.getBoundingClientRect().width||600,m=Math.max(x,480);u.style.width=m+"px";let l=40,w=16,A=18,T=28,v=300;a.setAttribute("height",String(v));let S=m-l-w,P=v-A-T,M=new Map;for(let f of i){let y=String(f.x),R=(_=M.get(y))!=null?_:{label:f.x,rows:[]};R.rows.push(f),M.set(y,R)}let B=Array.from(M.keys()).sort((f,y)=>f<y?-1:f>y?1:0).map(f=>M.get(f)),b=B.length,D=new Set;i.forEach(f=>{f.series!=null&&D.add(String(f.series))});let p=Array.from(D),k=p.length>1,C=k?"grouped":"single",g=0;i.forEach(f=>{f.y>g&&(g=f.y)}),(!isFinite(g)||g<=0)&&(g=1);let E=f=>A+P-f/(g||1)*P,K=E(0),q=4;for(let f=0;f<=q;f++){let y=g*f/q,R=E(y),N=document.createElementNS(a.namespaceURI,"line");N.setAttribute("x1",String(l)),N.setAttribute("y1",String(R)),N.setAttribute("x2",String(m-w)),N.setAttribute("y2",String(R)),N.setAttribute("stroke","#cccccc"),N.setAttribute("stroke-opacity","0.25"),a.appendChild(N);let I=document.createElementNS(a.namespaceURI,"text");I.setAttribute("x",String(l-4)),I.setAttribute("y",String(R+3)),I.setAttribute("text-anchor","end"),I.setAttribute("font-size","10"),I.setAttribute("fill","#111111"),I.textContent=String(Math.round(y)),a.appendChild(I)}let Q=b>0?S/b:S;if(B.forEach((f,y)=>{let R=l+Q*(y+.5),N=String(f.label),I=document.createElementNS(a.namespaceURI,"text");I.setAttribute("x",String(R)),I.setAttribute("y",String(v-T+12)),I.setAttribute("text-anchor","middle"),I.setAttribute("font-size","10"),I.setAttribute("fill","#111111"),I.textContent=N,a.appendChild(I)}),k){let f=o.createDiv({cls:"chart-notes-legend"});p.forEach((y,R)=>{let N=f.createDiv({cls:"chart-notes-legend-item"}),I=N.createDiv();I.style.width="10px",I.style.height="10px",I.style.borderRadius="999px",I.style.backgroundColor=it(y,R),N.createSpan({text:y})})}B.forEach((f,y)=>{let R=l+Q*(y+.5),N=f.rows;if(C==="single"){let j=N[0],z=j.y,W=Q*.6,et=R-W/2,at=E(z),ht=Math.max(2,K-at),ct=it("bar",y),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(et)),G.setAttribute("y",String(at)),G.setAttribute("width",String(W)),G.setAttribute("height",String(ht)),G.setAttribute("fill",ct),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let Z=String(f.label),Rt=`valor: ${Math.round(z*100)/100}`;G.addEventListener("mouseenter",dt=>{var J,pt;return mt(o,c,Z,Rt,(pt=(J=j.notes)==null?void 0:J.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>ft(c)),G.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(o,h,Z,z,(J=j.notes)!=null?J:[],s)}),a.appendChild(G);return}let I=p.length,tt=Q/Math.max(I+1,2),V=I*tt,st=R-V/2;p.forEach((j,z)=>{let W=N.find(J=>(J.series!=null?String(J.series):"")===j);if(!W)return;let et=W.y,at=st+z*tt,ht=E(et),ct=Math.max(2,K-ht),G=it(j,z),Z=document.createElementNS(a.namespaceURI,"rect");Z.setAttribute("x",String(at)),Z.setAttribute("y",String(ht)),Z.setAttribute("width",String(tt)),Z.setAttribute("height",String(ct)),Z.setAttribute("fill",G),Z.setAttribute("stroke","rgba(0,0,0,0.25)"),Z.setAttribute("stroke-width","0.5"),Z.style.cursor="pointer";let Rt=`${j} @ ${String(f.label)}`,dt=`valor: ${Math.round(et*100)/100}`;Z.addEventListener("mouseenter",J=>{var pt,Ut;return mt(o,c,Rt,dt,(Ut=(pt=W.notes)==null?void 0:pt.length)!=null?Ut:0,J)}),Z.addEventListener("mouseleave",()=>ft(c)),Z.addEventListener("click",J=>{var pt;J.preventDefault(),yt(o,h,Rt,et,(pt=W.notes)!=null?pt:[],s)}),a.appendChild(Z)})})}function Be(o,n,t){var Q,$,U,O;let e=(Q=n.options)!=null?Q:{},r=e.background,s=($=e.drilldown)!=null?$:!0,i=(U=t.rows)!=null?U:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:u,svg:a,tooltip:c,details:h}=wt(o,r),x=o.getBoundingClientRect().width||600,m=Math.max(x,480);u.style.width=m+"px";let l=40,w=16,A=18,T=28,v=300;a.setAttribute("height",String(v));let S=m-l-w,P=v-A-T,M=new Map;for(let _ of i){let f=String(_.x),y=(O=M.get(f))!=null?O:{label:_.x,rows:[]};y.rows.push(_),M.set(f,y)}let B=Array.from(M.keys()).sort((_,f)=>_<f?-1:_>f?1:0).map(_=>M.get(_)),b=B.length,D=new Set;i.forEach(_=>{_.series!=null&&D.add(String(_.series))});let p=Array.from(D);if(!p.length){ge(o,n,t);return}let k=0;B.forEach(_=>{let f=_.rows.reduce((y,R)=>y+R.y,0);f>k&&(k=f)}),(!isFinite(k)||k<=0)&&(k=1);let C=_=>A+P-_/(k||1)*P,g=C(0),E=4;for(let _=0;_<=E;_++){let f=k*_/E,y=C(f),R=document.createElementNS(a.namespaceURI,"line");R.setAttribute("x1",String(l)),R.setAttribute("y1",String(y)),R.setAttribute("x2",String(m-w)),R.setAttribute("y2",String(y)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),a.appendChild(R);let N=document.createElementNS(a.namespaceURI,"text");N.setAttribute("x",String(l-4)),N.setAttribute("y",String(y+3)),N.setAttribute("text-anchor","end"),N.setAttribute("font-size","10"),N.setAttribute("fill","#111111"),N.textContent=String(Math.round(f)),a.appendChild(N)}let K=b>0?S/b:S;B.forEach((_,f)=>{let y=l+K*(f+.5),R=String(_.label),N=document.createElementNS(a.namespaceURI,"text");N.setAttribute("x",String(y)),N.setAttribute("y",String(v-T+12)),N.setAttribute("text-anchor","middle"),N.setAttribute("font-size","10"),N.setAttribute("fill","#111111"),N.textContent=R,a.appendChild(N)});let q=o.createDiv({cls:"chart-notes-legend"});p.forEach((_,f)=>{let y=q.createDiv({cls:"chart-notes-legend-item"}),R=y.createDiv();R.style.width="10px",R.style.height="10px",R.style.borderRadius="999px",R.style.backgroundColor=it(_,f),y.createSpan({text:_})}),B.forEach((_,f)=>{let y=l+K*(f+.5),R=K*.6,N=y-R/2,I=0;p.forEach((tt,V)=>{let st=_.rows.find(dt=>(dt.series!=null?String(dt.series):"")===tt);if(!st)return;let j=st.y,z=I,W=I+j;I=W;let et=C(z),at=C(W),ht=Math.max(2,et-at),ct=it(tt,V),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(N)),G.setAttribute("y",String(at)),G.setAttribute("width",String(R)),G.setAttribute("height",String(ht)),G.setAttribute("fill",ct),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let Z=`${tt} @ ${String(_.label)}`,Rt=`valor: ${Math.round(j*100)/100}`;G.addEventListener("mouseenter",dt=>{var J,pt;return mt(o,c,Z,Rt,(pt=(J=st.notes)==null?void 0:J.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>ft(c)),G.addEventListener("click",dt=>{var J;dt.preventDefault(),yt(o,h,Z,j,(J=st.notes)!=null?J:[],s)}),a.appendChild(G)})})}function me(o,n,t,e){var $,U,O,_;let r=($=n.options)!=null?$:{},s=r.background,i=(U=r.drilldown)!=null?U:!0,u=(O=t.rows)!=null?O:[];if(!u.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:c,tooltip:h,details:x}=wt(o,s),m=o.getBoundingClientRect().width||600,l=Math.max(m,480);a.style.width=l+"px";let w=40,A=16,T=18,v=24,S=300;c.setAttribute("height",String(S));let P=l-w-A,M=S-T-v,F=new Map;for(let f of u){let y=f.series!=null?String(f.series):"__default__",R=(_=F.get(y))!=null?_:[];R.push(f),F.set(y,R)}let B=Array.from(F.keys()),b=[],D=new Set;for(let f of u){let y=String(f.x);D.has(y)||(D.add(y),b.push(f.x))}let p=b.length||1,k=f=>{let y=String(f),R=b.findIndex(N=>String(N)===y);return R<0?w:p===1?w+P/2:w+R/(p-1)*P},C=f=>String(f),g=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY;for(let f of u)f.y<g&&(g=f.y),f.y>E&&(E=f.y);(!isFinite(g)||!isFinite(E))&&(g=0,E=1),g===E&&(g===0?E=1:g=0);let K=f=>T+M-(f-g)/(E-g||1)*M,q=4;for(let f=0;f<=q;f++){let y=g+(E-g)*f/q,R=K(y),N=document.createElementNS(c.namespaceURI,"line");N.setAttribute("x1",String(w)),N.setAttribute("y1",String(R)),N.setAttribute("x2",String(l-A)),N.setAttribute("y2",String(R)),N.setAttribute("stroke","#cccccc"),N.setAttribute("stroke-opacity","0.25"),c.appendChild(N);let I=document.createElementNS(c.namespaceURI,"text");I.setAttribute("x",String(w-4)),I.setAttribute("y",String(R+3)),I.setAttribute("text-anchor","end"),I.setAttribute("font-size","10"),I.setAttribute("fill","#111111"),I.textContent=Math.abs(y)>=100?String(Math.round(y)):String(Math.round(y*10)/10),c.appendChild(I)}let Q=B.filter(f=>f!=="__default__");if(Q.length>1){let f=o.createDiv({cls:"chart-notes-legend"});Q.forEach((y,R)=>{let N=y,I=f.createDiv({cls:"chart-notes-legend-item"}),tt=I.createDiv();tt.style.width="10px",tt.style.height="10px",tt.style.borderRadius="999px",tt.style.backgroundColor=it(N,R),I.createSpan({text:N})})}B.forEach((f,y)=>{let R=F.get(f);if(!(R!=null&&R.length))return;let N=f==="__default__"?it("line",y):it(f,y),I=[...R].sort((V,st)=>{let j=b.findIndex(W=>String(W)===String(V.x)),z=b.findIndex(W=>String(W)===String(st.x));return j-z}),tt="";if(I.forEach((V,st)=>{let j=k(V.x),z=K(V.y);tt+=(st===0?"M ":" L ")+j+" "+z}),e){let V=I[0],st=I[I.length-1],j=k(V.x),z=k(st.x),W=K(g);tt+=` L ${z} ${W} L ${j} ${W} Z`;let et=document.createElementNS(c.namespaceURI,"path");et.setAttribute("d",tt),et.setAttribute("fill",N),et.setAttribute("fill-opacity","0.18"),et.setAttribute("stroke",N),et.setAttribute("stroke-width","1.5"),c.appendChild(et)}else{let V=document.createElementNS(c.namespaceURI,"path");V.setAttribute("d",tt),V.setAttribute("fill","none"),V.setAttribute("stroke",N),V.setAttribute("stroke-width","2"),c.appendChild(V)}I.forEach(V=>{let st=k(V.x),j=K(V.y),z=document.createElementNS(c.namespaceURI,"circle");z.setAttribute("cx",String(st)),z.setAttribute("cy",String(j)),z.setAttribute("r","3"),z.setAttribute("fill","#ffffff"),z.setAttribute("stroke",N),z.setAttribute("stroke-width","1.5"),z.style.cursor="pointer";let W=C(V.x),et=f==="__default__"?"":String(V.series),at=et?`${et} @ ${W}`:W,ht=`valor: ${Math.round(V.y*100)/100}`;z.addEventListener("mouseenter",ct=>{var G,Z;return mt(o,h,at,ht,(Z=(G=V.notes)==null?void 0:G.length)!=null?Z:0,ct)}),z.addEventListener("mouseleave",()=>ft(h)),z.addEventListener("click",ct=>{var G;ct.preventDefault(),yt(o,x,at,V.y,(G=V.notes)!=null?G:[],i)}),c.appendChild(z)})})}function He(o,n,t){var P;let{background:e,drilldown:r=!0}=(P=n.options)!=null?P:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=$e(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:u,svg:a,tooltip:c,details:h}=wt(o,e),x=Math.max(i,420);u.style.width=x+"px",s&&(a.style.color=s);let m=300,l=x/2,w=(m-28+28)/2,A=Math.min(x/2-20,m/2-20),v=t.rows.map(M=>Math.max(0,M.y)).reduce((M,F)=>M+F,0)||1,S=-Math.PI/2;t.rows.forEach((M,F)=>{var Q;let B=M.x instanceof Date?M.x.toISOString().slice(0,10):String(M.x),b=M.y,D=b/v*Math.PI*2,p=l+A*Math.cos(S),k=w+A*Math.sin(S),C=l+A*Math.cos(S+D),g=w+A*Math.sin(S+D),E=D>Math.PI?1:0,K=document.createElementNS(a.namespaceURI,"path"),q=[`M ${l} ${w}`,`L ${p} ${k}`,`A ${A} ${A} 0 ${E} 1 ${C} ${g}`,"Z"].join(" ");K.setAttribute("d",q),K.setAttribute("fill",it((Q=M.series)!=null?Q:B,F)),K.style.cursor="pointer",K.addEventListener("mouseenter",$=>{var U,O;return mt(o,c,B,b,(O=(U=M.notes)==null?void 0:U.length)!=null?O:0,$)}),K.addEventListener("mouseleave",()=>ft(c)),K.addEventListener("click",()=>{var $;return yt(o,h,B,b,($=M.notes)!=null?$:[],r)}),a.appendChild(K),S+=D})}function Ge(o,n,t){var k;let{background:e,drilldown:r=!0}=(k=n.options)!=null?k:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let s=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:u,svg:a,tooltip:c,details:h}=wt(o,e),x=Math.max(i,700);u.style.width=x+"px",s&&(a.style.color=s);let m=300,l=x-48-10,w=m-28-28,A=t.rows.map(C=>{let g=C.x;if(g instanceof Date)return g.getTime();if(typeof g=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(g)){let K=new Date(g);if(!isNaN(K.getTime()))return K.getTime()}let E=Number(g);return isNaN(E)?null:E}return typeof g=="number"?g:null}),T=t.rows.map(C=>C.y),v=A.filter(C=>C!==null);if(v.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let S=Math.min(...v),P=Math.max(...v),M=Math.min(...T),F=Math.max(...T),B=C=>48+(C-S)/(P-S||1)*l,b=C=>m-28-(C-M)/(F-M||1)*w,D=document.createElementNS(a.namespaceURI,"line");D.setAttribute("x1",String(48)),D.setAttribute("y1",String(28)),D.setAttribute("x2",String(48)),D.setAttribute("y2",String(m-28)),D.setAttribute("stroke","currentColor"),a.appendChild(D);let p=document.createElementNS(a.namespaceURI,"line");p.setAttribute("x1",String(48)),p.setAttribute("y1",String(m-28)),p.setAttribute("x2",String(x-10)),p.setAttribute("y2",String(m-28)),p.setAttribute("stroke","currentColor"),a.appendChild(p),t.rows.forEach((C,g)=>{let E=A[g];if(E==null)return;let K=B(E),q=b(T[g]),Q=document.createElementNS(a.namespaceURI,"circle");Q.setAttribute("cx",String(K)),Q.setAttribute("cy",String(q)),Q.setAttribute("r","4"),Q.setAttribute("fill",it(C.series,g)),Q.style.cursor="pointer";let $=C.x instanceof Date?C.x.toISOString().slice(0,10):typeof C.x=="string"?C.x:String(C.x);Q.addEventListener("mouseenter",U=>{var O,_;return mt(o,c,$,C.y,(_=(O=C.notes)==null?void 0:O.length)!=null?_:0,U)}),Q.addEventListener("mouseleave",()=>ft(c)),Q.addEventListener("click",U=>{var O;U.preventDefault(),yt(o,h,$,C.y,(O=C.notes)!=null?O:[],r)}),a.appendChild(Q)})}var Qe=require("obsidian"),se=class{render(n,t,e,r,s=!1){var c;let{title:i}=(c=t.options)!=null?c:{};n.empty(),n.addClass("prop-charts-container");let a=n.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":ge(n,t,e);break;case"stacked-bar":Be(n,t,e);break;case"line":me(n,t,e,!1);break;case"area":me(n,t,e,!0);break;case"pie":He(n,t,e);break;case"scatter":Ge(n,t,e);break;case"gantt":ne(n,t,e,r);break;default:n.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!s){let h=n.createEl("button",{cls:"chart-notes-zoom-button"});h.setAttr("type","button"),h.setAttr("aria-label","Expandir gr\xE1fico"),h.textContent="\u2922",h.addEventListener("click",x=>{x.preventDefault(),new fe(t,e,this,r).open()})}}},fe=class extends Qe.Modal{constructor(t,e,r,s){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=r,this.ctx=s}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),r=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:r,cls:"chart-notes-zoom-title"});let s=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(c,h)=>{let x=s.createEl("button",{cls:"chart-notes-zoom-size-btn",text:c});(()=>{x.toggleClass("is-active",this.size===h)})(),x.addEventListener("click",l=>{l.preventDefault(),this.size=h,this.applySize(),s.querySelectorAll(".chart-notes-zoom-size-btn").forEach(A=>A.classList.remove("is-active")),x.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let u=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(u,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",r="85vh";switch(this.size){case"small":e="60vw",r="55vh";break;case"medium":e="80vw",r="70vh";break;case"large":default:e="95vw",r="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=r,t.style.maxHeight=r}};var oe=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new Zt(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,r)=>{var h,x,m;let s;try{let l=(0,Lt.parseYaml)(t);if(!l||typeof l!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}s=l}catch(l){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+((h=l==null?void 0:l.message)!=null?h:String(l))});return}if(!s.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=s.type==="gantt",u=s.type==="table";if(!i&&!u){if(!s.encoding||!s.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let w=((x=s.aggregate)==null?void 0:x.y)==="count";if(!s.encoding.y&&!w){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}s.encoding||(s.encoding={}),s.source||(s.source={});let c;try{c=this.query.run(s)}catch(l){e.createEl("div",{text:"Chart Notes: erro na query: "+((m=l==null?void 0:l.message)!=null?m:String(l))});return}this.renderer.render(e,s,c)}),this.registerBasesView(ue,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new qt(t,e,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},e={type:"property",key:"xProperty",displayName:"X axis / category (bars & slices)",shouldHide:v=>{var S;return String((S=v.get("chartType"))!=null?S:"bar")==="gantt"}},r={type:"property",key:"ganttLabelProperty",displayName:"Task label (Gantt)",description:"Texto mostrado em cada tarefa. Se vazio, usa o nome da nota.",shouldHide:v=>{var S;return String((S=v.get("chartType"))!=null?S:"bar")!=="gantt"}},s={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:v=>{var P;let S=String((P=v.get("chartType"))!=null?P:"bar");return S==="pie"||S==="gantt"}},i={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:v=>{var S;return String((S=v.get("chartType"))!=null?S:"bar")==="pie"}},u={type:"dropdown",key:"aggregateMode",displayName:"Value aggregation (Y)",default:"sum",options:{sum:"Sum",count:"Count (ignore Y)","cumulative-sum":"Cumulative sum (line/area only)"},shouldHide:v=>{var P;let S=String((P=v.get("chartType"))!=null?P:"bar");return S!=="line"&&S!=="area"}},a={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (keep date/time)",none:"None (raw)",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:v=>{var P;let S=String((P=v.get("chartType"))!=null?P:"bar");return S==="pie"||S==="scatter"||S==="gantt"}},c=(v,S,P)=>({type:"property",key:v,displayName:S,description:P,shouldHide:M=>{var F;return String((F=M.get("chartType"))!=null?F:"")!=="gantt"}}),h=c("startProperty","Start (Gantt)","Data/hora de in\xEDcio. Se faltar, tentamos inferir via fim + dura\xE7\xE3o."),x=c("endProperty","End (Gantt)","Data/hora de fim da barra (geralmente 'scheduled' ou 'finish')."),m=c("dueProperty","Due (deadline, optional)","Deadline. Usado como fallback quando h\xE1 due + dura\xE7\xE3o, e mostrado no tooltip."),l=c("durationProperty","Duration in minutes (optional)","Estimativa em minutos. Usada para inferir start/end quando s\xF3 um dos lados existe."),w=c("groupProperty","Group / lane (optional)","Projeto/\xE1rea usada como lane no lado esquerdo do Gantt.");return[t,e,r,s,i,u,a,h,x,m,l,w,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
