/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ce=Object.defineProperty;var Ke=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Ue=(o,s)=>{for(var t in s)ce(o,t,{get:s[t],enumerable:!0})},Xe=(o,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of Oe(s))!Ye.call(o,n)&&n!==t&&ce(o,n,{get:()=>s[n],enumerable:!(e=Ke(s,n))||e.enumerable});return o};var qe=o=>Xe(ce({},"__esModule",{value:!0}),o);var pn={};Ue(pn,{default:()=>oe});module.exports=qe(pn);var Lt=require("obsidian");var jt=require("obsidian"),ue="chartnotes-view",je=["bar","stacked-bar","line","area","pie","scatter","gantt"];function Ze(o){let s=String(o!=null?o:"bar").trim().toLowerCase();return je.includes(s)?s:"bar"}var Je=["normal","cumulative-sum"];function tn(o){let s=String(o!=null?o:"normal").trim().toLowerCase();return Je.includes(s)?s:"normal"}var Xt="(missing)",qt=class extends jt.BasesView{constructor(t,e,n){super(t);this.type=ue;this.renderer=n,this.rootEl=e.createDiv("chartnotes-bases-view")}onDataUpdated(){var Y,Q,H;this.rootEl.empty();let t=this.data,e=(Y=t==null?void 0:t.groupedData)!=null?Y:[];if(!e.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No data in this view."});return}let n=this.config,r=Ze((Q=n==null?void 0:n.get("chartType"))!=null?Q:"bar"),i=r==="pie",u=r==="scatter",a=r==="gantt",l=tn(n==null?void 0:n.get("aggregateMode")),f=l==="cumulative-sum"&&!(r==="line"||r==="area")?"normal":l,h="auto",g=this.getPropFromConfig("xProperty"),v=this.getPropFromConfig("yProperty"),b=this.getPropFromConfig("seriesProperty");i&&(b={id:null,name:null});let A=this.getPropFromConfig("startProperty"),E=this.getPropFromConfig("endProperty"),D=this.getPropFromConfig("dueProperty"),M=this.getPropFromConfig("scheduledProperty"),N=this.getPropFromConfig("durationProperty"),$=this.getPropFromConfig("groupProperty");if(!a&&!g.id){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Configure the 'X axis / category' property in view options."});return}if(u&&(!g.id||!v.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Scatter plots need both X and Y numeric properties."});return}if(a&&!(A.id||E.id||M.id||D.id)){this.rootEl.createDiv({cls:"prop-charts-empty",text:"Gantt needs Start/End or Scheduled/Due with Duration."});return}let F;if(a)F=this.buildRowsForGantt(e,g,b,A,E,D,M,N,$);else if(u)F=this.buildRowsForScatter(e,g,v,b);else{let X=i;F=this.buildRowsForAggregatedCharts(e,g,v,b,f,h,X)}if(!F.length){this.rootEl.createDiv({cls:"prop-charts-empty",text:"No rows to display (check X/Y/aggregation)."});return}let S={rows:F},c=((H=n==null?void 0:n.get("title"))!=null?H:"").trim()||(n==null?void 0:n.name)||"Chart Notes (Bases)",C=n==null?void 0:n.get("drilldown"),T=typeof C=="boolean"?C:!0,w=this.buildEncoding({x:g,y:v,series:b,start:A,end:E,due:D,duration:N,group:$,aggMode:f,xBucket:h,chartType:r}),I={type:r,source:{type:"properties",query:""},encoding:w,options:{title:c,drilldown:T}},V={refresh:()=>this.onDataUpdated()};this.renderer.render(this.rootEl,I,S,V)}getPropFromConfig(t){var u,a;let e=this.config,n=(u=e==null?void 0:e.get)==null?void 0:u.call(e,t);if(!n)return{id:null,name:null};let r=n.trim();if(!r||r==="undefined"||r==="null")return{id:null,name:null};let i=r;try{let l=(0,jt.parsePropertyId)(i);return{id:i,name:(a=l.name)!=null?a:i}}catch(l){return{id:i,name:i}}}readValue(t,e){if(!e.id)return null;let n;try{n=t.getValue(e.id)}catch(r){return null}if(!n)return null;try{if(typeof n.isEmpty=="function"&&n.isEmpty())return null}catch(r){}try{let r=n.toString();if(r==null)return null;let i=String(r).trim();return i.length?i:null}catch(r){return null}}parseDate(t){if(t instanceof Date)return Number.isNaN(t.getTime())?null:t;if(t==null)return null;let e=new Date(String(t).trim());return Number.isNaN(e.getTime())?null:e}compareX(t,e){let n=this.parseDate(t),r=this.parseDate(e);if(n&&r)return n.getTime()-r.getTime();let i=Number(t),u=Number(e);return!Number.isNaN(i)&&!Number.isNaN(u)?i-u:String(t!=null?t:"").localeCompare(String(e!=null?e:""))}fmtDate(t){let e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${r}`}startOfWeek(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=(e.getDay()+6)%7;return e.setDate(e.getDate()-n),e.setHours(0,0,0,0),e}makeLocalDate(t){let e=new Date(t.getFullYear(),t.getMonth(),t.getDate());return e.setHours(0,0,0,0),e}endOfDay(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59,999)}parseISODateLocal(t){let e=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!e)return null;let n=Number(e[1]),r=Number(e[2])-1,i=Number(e[3]),u=new Date(n,r,i);return u.setHours(0,0,0,0),Number.isNaN(u.getTime())?null:u}parseDateLoose(t){if(t instanceof Date)return this.makeLocalDate(t);if(t==null)return null;let e=String(t).trim();if(!e)return null;let n=this.parseISODateLocal(e);if(n)return n;if(/^\d{4}-\d{2}-\d{2}T/.test(e)){let u=new Date(e);if(!Number.isNaN(u.getTime()))return this.makeLocalDate(u)}let r=e.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(r){let u=Number(r[1]),a=Number(r[2]),l=Number(r[3]);if(!(u>12)){let f=u;u=a,a=f}let p=new Date(l,a-1,u);return p.setHours(0,0,0,0),Number.isNaN(p.getTime())?null:p}let i=new Date(e);return Number.isNaN(i.getTime())?null:this.makeLocalDate(i)}readDate(t,e){if(!(e!=null&&e.id))return null;let n;try{n=t.getValue(e.id)}catch(r){return null}if(n==null)return null;try{if(typeof n.toDate=="function"){let r=n.toDate();if(r instanceof Date&&!Number.isNaN(r.getTime()))return this.makeLocalDate(r)}}catch(r){}try{if(typeof n.toISODate=="function"){let r=n.toISODate(),i=this.parseISODateLocal(String(r));if(i)return i}}catch(r){}if(n instanceof Date)return this.makeLocalDate(n);try{return this.parseDateLoose(n.toString())}catch(r){return null}}startOfMonth(t){let e=new Date(t.getFullYear(),t.getMonth(),1);return e.setHours(0,0,0,0),e}startOfQuarter(t){let e=Math.floor(t.getMonth()/3),n=new Date(t.getFullYear(),e*3,1);return n.setHours(0,0,0,0),n}startOfYear(t){let e=new Date(t.getFullYear(),0,1);return e.setHours(0,0,0,0),e}bucketX(t,e){let n=this.parseDate(t);if(!n||e==="none")return t;let r=new Date(n.getFullYear(),n.getMonth(),n.getDate());if(r.setHours(0,0,0,0),e==="auto"||e==="day")return r;switch(e){case"week":return this.startOfWeek(r);case"month":return this.startOfMonth(r);case"quarter":return this.startOfQuarter(r);case"year":return this.startOfYear(r);default:return r}}getXValuesForEntry(t,e,n,r){var p,f;let i=[],u=h=>this.bucketX(h,n);if(!e.id){let h=t.file,g=h!=null&&h.name?String(h.name):String((p=h==null?void 0:h.path)!=null?p:Xt);return i.push(u(g)),i}if(!r){let h=(f=this.readValue(t,e))!=null?f:Xt;return i.push(u(h)),i}let a=null;try{a=t.getValue(e.id)}catch(h){a=null}let l=h=>{if(!h)return;let g=String(h).trim();g&&i.push(u(g))};if(a==null)l(Xt);else if(typeof a=="string"){let h=a.trim();if(h){let g=h.split(/\s+/);for(let v of g)l(v)}}else if(Array.isArray(a))for(let h of a){if(h==null)continue;let g;try{g=h.toString()}catch(v){continue}l(g)}else if(typeof a.toArray=="function"){let h=a.toArray();if(Array.isArray(h))for(let g of h){if(g==null)continue;let v;try{v=g.toString()}catch(b){continue}l(v)}else{let g;try{g=a.toString()}catch(v){g=""}l(g)}}else{let h;try{h=a.toString()}catch(g){h=""}l(h)}return i.length||l(Xt),i}buildRowsForAggregatedCharts(t,e,n,r,i,u,a){let l=new Map,p=a||!n.id,f=n.name||"y";for(let g of t)for(let v of g.entries){let b=v.file,A=this.getXValuesForEntry(v,e,u,a),E=1,D=null;if(!p&&n.id){if(D=this.readValue(v,n),D==null)continue;let $=Number(D);if(Number.isNaN($))continue;E=$}else E=1;let M=this.readValue(v,r),N=M!=null?String(M):void 0;for(let $ of A){let F=`${$}@@${N!=null?N:""}`,S=l.get(F);if(S||(S={x:$,y:0,series:N,notes:[],props:{}},l.set(F,S)),S.y+=E,b!=null&&b.path&&S.notes.push(b.path),S.props&&e.name){let y=$ instanceof Date?this.fmtDate($):String($);S.props[e.name]=y}S.props&&f&&(S.props[f]=S.y),S.props&&r.name&&M!=null&&(S.props[r.name]=M)}}let h=Array.from(l.values());return i==="cumulative-sum"?this.toCumulative(h):h}toCumulative(t){var r,i;let e=new Map;for(let u of t){let a=(r=u.series)!=null?r:"__no_series__",l=e.get(a);l||(l=[],e.set(a,l)),l.push(u)}let n=[];for(let[,u]of e){let a=[...u].sort((p,f)=>this.compareX(p.x,f.x)),l=0;for(let p of a){let f=Number((i=p.y)!=null?i:0);Number.isNaN(f)||(l+=f,n.push({...p,y:l}))}}return n}buildRowsForScatter(t,e,n,r){let i=[];for(let u of t)for(let a of u.entries){let l=a.file,p=this.readValue(a,e),f=this.readValue(a,n);if(p==null||f==null)continue;let h=Number(p),g=Number(f);if(Number.isNaN(h)||Number.isNaN(g))continue;let v=this.readValue(a,r),b=v!=null?String(v):void 0;i.push({x:h,y:g,series:b,notes:l!=null&&l.path?[l.path]:[],props:{}})}return i}buildRowsForGantt(t,e,n,r,i,u,a,l,p){var h,g;let f=[];for(let v of t)for(let b of v.entries){let A=b.file,E=this.readDate(b,r),D=this.readDate(b,i),M=this.readDate(b,u),N=this.readDate(b,a),$=this.readValue(b,l),F=$!=null?Number($):NaN,S=Number.isFinite(F),y=E?new Date(E):null,c=D?new Date(D):null;if(!y&&c&&S&&(y=new Date(c.getTime()-F*6e4),y=this.makeLocalDate(y)),y&&!c&&S&&(c=new Date(y.getTime()+F*6e4)),!y&&!c&&N&&S&&(c=new Date(N),y=new Date(c.getTime()-F*6e4),y=this.makeLocalDate(y)),!y&&!c&&M&&S&&(c=new Date(M),y=new Date(c.getTime()-F*6e4),y=this.makeLocalDate(y)),!y||!c)continue;let C=y.getHours()===0&&y.getMinutes()===0&&y.getSeconds()===0,T=c.getHours()===0&&c.getMinutes()===0&&c.getSeconds()===0;C&&T&&(c=this.endOfDay(c));let w=(g=this.readValue(b,e))!=null?g:A!=null&&A.name?String(A.name).replace(/\.md$/i,""):String((h=A==null?void 0:A.path)!=null?h:""),I=this.readValue(b,n),V=I!=null?String(I):void 0,Y=this.readValue(b,p),Q={};S&&l.name&&(Q[l.name]=F),p.name&&Y!=null&&(Q[p.name]=Y),f.push({x:w,y:0,series:V,start:y,end:c,due:M!=null?M:void 0,notes:A!=null&&A.path?[A.path]:[],props:Q})}return f}buildEncoding(t){var r,i,u,a,l,p,f,h;let e=(r=t.x.name)!=null?r:"x",n=(i=t.y.name)!=null?i:"y";return{x:e,y:n,series:(u=t.series.name)!=null?u:"series",start:(a=t.start.name)!=null?a:"start",end:(l=t.end.name)!=null?l:"end",due:(p=t.due.name)!=null?p:"due",duration:(f=t.duration.name)!=null?f:"duration",group:(h=t.group.name)!=null?h:"group"}}};var Re=require("obsidian"),Zt=class{constructor(s){this.index=new Map;this.app=s}async buildIndex(){this.index.clear();let s=this.app.vault.getMarkdownFiles();for(let t of s)await this.updateFile(t)}async fullReindex(){await this.buildIndex()}getAll(){return Array.from(this.index.values())}async updateFile(s){if(s.extension!=="md")return;let t={};try{let n=(await this.app.vault.read(s)).match(/^---\n([\s\S]*?)\n---\n?/);if(n){let i=(0,Re.parseYaml)(n[1])||{};if(i&&typeof i=="object")for(let[u,a]of Object.entries(i))u!=="position"&&(t[u]=a)}let r=this.app.metadataCache.getFileCache(s);r!=null&&r.tags&&!t.tags&&(t.tags=r.tags.map(i=>i.tag.replace(/^#/,"")))}catch(e){console.error("Chart Notes: erro ao indexar",s.path,e)}this.index.set(s.path,{path:s.path,props:t})}removeFile(s){this.index.delete(s.path)}};function Pe(o,s){if(!s||s.length===0)return!0;for(let t of s){if(t===".")return!0;let e=t.endsWith("/")?t:t+"/";if(o===t||o.startsWith(e))return!0}return!1}function Le(o,s){if(!s||s.length===0)return!0;let t=o.tags;if(!t)return!1;if(Array.isArray(t)){for(let n of s)if(t.includes(n)||t.includes("#"+n))return!0;return!1}let e=String(t);for(let n of s)if(e===n||e==="#"+n)return!0;return!1}function te(o){return typeof o!="string"?!1:/^\d{4}-\d{2}-\d{2}/.test(o)}function $t(o){if(o instanceof Date)return o;if(typeof o!="string")return null;if(/^\d{4}-\d{2}-\d{2}$/.test(o)){let[t,e,n]=o.split("-");return new Date(Number(t),Number(e)-1,Number(n),0,0,0,0)}let s=new Date(o);return isNaN(s.getTime())?null:s}function ut(o){let s=new Date(o);return s.setHours(0,0,0,0),s}function Jt(o,s){let t=new Date(o);return t.setDate(t.getDate()-s),t}function en(o,s){return Jt(o,s*7)}function nn(o,s){let t=new Date(o);return t.setMonth(t.getMonth()-s),t}function pe(o,s){let t=new Date(o);return t.setDate(t.getDate()+s),t}function rn(o,s){return pe(o,s*7)}function sn(o,s){let t=new Date(o);return t.setMonth(t.getMonth()+s),t}function ke(o){let s=o.toLowerCase();return!!(["date","scheduled","due","start","end","created","modified","datecreated","datemodified"].includes(s)||s.endsWith("date")||s.endsWith("at")||s.endsWith("on"))}function Me(o,s){let t=s?new Date(s):new Date,e=ut(t),n=o.trim().toLowerCase();if(n==="today")return e;if(n==="yesterday")return ut(Jt(e,1));if(/^-\d+$/.test(n)){let r=parseInt(n.slice(1),10);return ut(Jt(e,r))}if(/^-\d+d$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(Jt(e,r))}if(/^-\d+w$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(en(e,r))}if(/^-\d+m$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(nn(e,r))}if(/^\+\d+$/.test(n)){let r=parseInt(n.slice(1),10);return ut(pe(e,r))}if(/^\+\d+d$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(pe(e,r))}if(/^\+\d+w$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(rn(e,r))}if(/^\+\d+m$/.test(n)){let r=parseInt(n.slice(1,-1),10);return ut(sn(e,r))}return null}function Ie(o){let s=o.trim(),t=s.match(/^([a-zA-Z0-9_.-]+)\s+between\s+(.+)\s+and\s+(.+)$/i);if(t){let p=t[1].trim(),f=t[2].trim(),h=t[3].trim(),g=ke(p),v=de(f,g),b=de(h,g),A=v.valueType==="date"||b.valueType==="date"?"date":v.valueType;return{field:p,op:"between",value:v.value,value2:b.value,valueType:A}}let e=/(==|!=|>=|<=|>|<)/,n=s.split(e);if(n.length!==3)throw new Error("express\xE3o where inv\xE1lida: "+o);let r=n[0].trim(),i=n[1].trim(),u=n[2].trim(),a=ke(r),l=de(u,a);return{field:r,op:i,value:l.value,valueType:l.valueType}}function de(o,s){let t=o.trim();if(t.startsWith("'")&&t.endsWith("'")||t.startsWith('"')&&t.endsWith('"'))return{value:t.slice(1,-1),valueType:"string"};let e=t.toLowerCase(),n=e==="today"||e==="yesterday"||e.startsWith("-")||e.startsWith("+");if(s){if(t==="0"||e==="today")return{value:ut(new Date),valueType:"date"};let i=Me(t);if(i)return{value:i,valueType:"date"}}else if(n){let i=Me(t);if(i)return{value:i,valueType:"date"}}if(te(t)){let i=$t(t);if(i)return{value:i,valueType:"date"}}let r=Number(t);return Number.isNaN(r)?{value:t,valueType:"string"}:{value:r,valueType:"number"}}function Fe(o,s){let t=o[s.field];if(t==null)return!1;if(s.valueType==="date"){let r=t instanceof Date?ut(t):te(t)?ut($t(t)):null;if(!r)return!1;let i=s.value instanceof Date?s.value:null,u=s.value2 instanceof Date?s.value2:null;if(!i)return!1;let a=r.getTime(),l=ut(i).getTime();switch(s.op){case"==":return a===l;case"!=":return a!==l;case">":return a>l;case">=":return a>=l;case"<":return a<l;case"<=":return a<=l;case"between":if(!u)return!1;let p=ut(u).getTime();return a>=l&&a<=p}}if(s.valueType==="number"){let r=Number(t);if(isNaN(r))return!1;let i=Number(s.value);switch(s.op){case"==":return r===i;case"!=":return r!==i;case">":return r>i;case">=":return r>=i;case"<":return r<i;case"<=":return r<=i;case"between":return typeof s.value2!="number"?!1:r>=i&&r<=s.value2}}let e=String(t),n=String(s.value);switch(s.op){case"==":return e===n;case"!=":return e!==n;case">":return e>n;case">=":return e>=n;case"<":return e<n;case"<=":return e<=n;case"between":return!1}}function on(o){if(typeof o=="string"&&/^\d{4}-\d{2}-\d{2}/.test(o))return{key:o.slice(0,10),isDate:!0};if(te(o)){let s=$t(o);if(s)return{key:s,isDate:!0}}return{key:o,isDate:!1}}function an(o,s){let t=o.x,e=s.x;if(t instanceof Date&&e instanceof Date)return t.getTime()-e.getTime();let n=String(t),r=String(e);return n<r?-1:n>r?1:0}function ln(o,s){var r,i;let t=an(o,s);if(t!==0)return t;let e=(r=o.series)!=null?r:"",n=(i=s.series)!=null?i:"";return e<n?-1:e>n?1:0}function cn(o){if(o==null)return 0;if(typeof o=="number")return o>0?Math.floor(o):0;if(typeof o=="string"){let s=o.trim().match(/^(\d+)/);if(s){let t=Number(s[1]);return Number.isFinite(t)&&t>0?Math.floor(t):0}}throw new Error(`aggregate.rolling inv\xE1lido: ${String(o)}`)}function un(o){var e,n;let s=new Map,t=[];for(let r of o){let i=(e=r.series)!=null?e:"__no_series__",a=((n=s.get(i))!=null?n:0)+r.y;s.set(i,a),t.push({...r,y:a})}return t}function dn(o,s){var i,u;let t=cn(s);if(!t||t<=1)return[...o];let e=new Map,n=new Map,r=[];for(let a of o){let l=(i=a.series)!=null?i:"__no_series__",p=e.get(l);p||(p=[],e.set(l,p));let f=(u=n.get(l))!=null?u:0;if(p.push(a.y),f+=a.y,p.length>t){let v=p.shift();f-=v}n.set(l,f);let h=p.length||1,g=f/h;r.push({...a,y:g})}return r}var ee=class{constructor(s,t){this.getIndex=s,this.defaultPaths=t}run(s){var i,u,a;let t=this.getIndex(),e=(i=s.source)!=null&&i.paths&&s.source.paths.length?s.source.paths:this.defaultPaths,n=(u=s.source)!=null&&u.tags&&s.source.tags.length?s.source.tags:[],r=[];for(let l of t){let p=e&&e.length?Pe(l.path,e):!0,f=n&&n.length?Le(l.props,n):!0;if(!p||!f)continue;let h=!0;if((a=s.source)!=null&&a.where&&s.source.where.length>0)for(let g of s.source.where){let v;try{v=Ie(g)}catch(b){throw new Error(`Condi\xE7\xE3o inv\xE1lida: ${g} (${b.message})`)}if(!Fe(l.props,v)){h=!1;break}}h&&r.push(l)}return s.type==="gantt"?this.runGantt(s,r):s.type==="table"?this.runTable(s,r):this.runStandard(s,r)}runTable(s,t){var n,r;return{rows:t.map(i=>({x:i.path,y:0,notes:[i.path],props:i.props})),xField:(n=s.encoding)==null?void 0:n.x,yField:(r=s.encoding)==null?void 0:r.y}}runGantt(s,t){var f,h,g;let e=(f=s.encoding)!=null?f:{},n=e.start,r=e.end,i=(h=e.label)!=null?h:e.x,u=e.series,a=e.duration,l=e.due,p=[];for(let v of t){let b=(g=v.props)!=null?g:{},A=S=>Array.isArray(S)?S[0]:S,E=null;if(r){let S=A(b[r]),y=$t(S);y&&(E=y)}if(!E)continue;let D=null;if(n){let S=A(b[n]),y=$t(S);y&&(D=y)}if(!D&&a){let S=A(b[a]),y=Number(S);Number.isNaN(y)||(D=new Date(E.getTime()-y*6e4))}D||(D=new Date(E.getTime()));let M;if(l){let S=A(b[l]),y=$t(S);y&&(M=y)}let N;if(i){let S=A(b[i]);(S==null||S==="")&&(S=v.path),N=S}else N=v.path;let $;if(u){let S=A(b[u]);S!=null&&($=String(S))}let F={x:N,y:0,notes:[v.path],series:$,start:D,end:E,props:b};M&&(F.due=M),p.push(F)}return p.sort((v,b)=>{let A=v.start?v.start.getTime():0,E=b.start?b.start.getTime():0;return A-E}),{rows:p,xField:i,yField:r}}runStandard(s,t){var v,b,A,E,D,M,N,$,F,S;let e=(v=s.encoding)==null?void 0:v.x,n=(b=s.encoding)==null?void 0:b.y,r=(A=s.encoding)==null?void 0:A.series;if(!e)throw new Error("encoding.x \xE9 obrigat\xF3rio.");let i=(E=s.aggregate)!=null?E:{},u=(D=i.y)!=null?D:null,a=!!i.cumulative,l=i.rolling;if(!n&&u!=="count")throw new Error("encoding.y \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count').");let p=[];for(let y of t){let c=(M=y.props)!=null?M:{},C=H=>Array.isArray(H)?H[0]:H,T=C(c[e]);if(T==null)continue;let w=on(T),I=w.key,V=w.isDate,Y;if(r){let H=C(c[r]);H!=null&&String(H).trim()!==""&&(Y=String(H))}let Q;if(u==="count")Q=1;else{let H=C(c[n]);if(H==null)continue;let X=Number(H);if(Number.isNaN(X))continue;Q=X}p.push({x:I,y:Q,notes:[y.path],series:Y,props:c,_isDate:V,_origX:T})}if(p.length===0)return{rows:[],xField:e,yField:n};let f=[];if(u){let y=new Map;for(let c of p){let C=(N=c.series)!=null?N:"",T=c.x instanceof Date?c.x.toISOString().slice(0,10):String(c.x),w=C+"||"+T,I=($=y.get(w))!=null?$:{sum:0,count:0,min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY,notes:[],xRep:c.x,isDate:c._isDate,series:c.series,props:c.props};I.sum+=c.y,I.count+=1,c.y<I.min&&(I.min=c.y),c.y>I.max&&(I.max=c.y),I.notes.push(...c.notes),I.props=(F=c.props)!=null?F:I.props,y.set(w,I)}for(let[,c]of y){let C=c.sum;switch(u){case"sum":C=c.sum;break;case"avg":C=c.sum/c.count;break;case"min":C=c.min;break;case"max":C=c.max;break;case"count":C=c.count;break}f.push({x:c.xRep,y:C,notes:c.notes,series:c.series,props:c.props})}}else f=p.map(y=>({x:y.x,y:y.y,notes:y.notes,series:y.series,props:y.props}));if(f.length===0)return{rows:[],xField:e,yField:n};let h=((S=s.sort)==null?void 0:S.x)==="desc"?"desc":"asc";if(f.sort((y,c)=>{let C=ln(y,c);return h==="asc"?C:-C}),(a||l)&&!(s.type==="line"||s.type==="area"))throw new Error("aggregate.cumulative / aggregate.rolling s\xF3 s\xE3o suportados em type: 'line' ou 'area'.");if(a&&l)throw new Error("Ainda n\xE3o \xE9 poss\xEDvel usar 'cumulative' e 'rolling' juntos no mesmo gr\xE1fico.");let g=f;return l?g=dn(f,l):a&&(g=un(f)),{rows:g,xField:e,yField:n}}};var Ct=require("obsidian");var _e=["#5b6cff","#5ec27f","#ffb347","#ff6b6b","#b47cff","#4dbbd5","#f78fb3","#50e3a4"];function it(o,s){if(!o)return"var(--text-accent, #5b6cff)";let t=Array.from(o).reduce((e,n)=>e*33+n.charCodeAt(0)>>>0,0);return _e[t%_e.length]}function wt(o,s){o.addClass("prop-charts-container"),o.style.width="100%",o.style.maxWidth="100%",o.style.position="relative";let t=o.createDiv({cls:"chart-notes-scroll"});t.style.overflowX="auto",t.style.overflowY="hidden",t.style.width="100%",t.style.maxWidth="100%";let e=t.createDiv({cls:"chart-notes-inner"});e.style.display="block",e.style.minHeight=`${300}px`,s&&(e.style.background=s);let n="http://www.w3.org/2000/svg",r=document.createElementNS(n,"svg");r.setAttribute("width","100%"),r.setAttribute("height",String(300)),r.style.display="block",e.appendChild(r);let i=o.createDiv({cls:"chart-notes-tooltip"});i.style.display="none";let u=o.createDiv({cls:"chart-notes-details"});return u.style.display="none",{scroll:t,inner:e,svg:r,tooltip:i,details:u}}function ft(o,s,t,e,n,r){let i=o.getBoundingClientRect(),u=typeof e=="number"?Number.isInteger(e)?String(e):e.toFixed(2):String(e);s.innerHTML=`
    <div class="chart-notes-tooltip-title">${t}</div>
    <div class="chart-notes-tooltip-value">${u}</div>
    <div class="chart-notes-tooltip-notes">${n} nota${n===1?"":"s"}</div>
  `,s.style.display="block";let a=s.getBoundingClientRect(),l=r.clientX-i.left+6,p=r.clientY-i.top+6;l+a.width>i.width-4&&(l=i.width-a.width-4),l<4&&(l=4),p+a.height>i.height-4&&(p=i.height-a.height-4),p<4&&(p=4),s.style.left=l+"px",s.style.top=p+"px"}function mt(o){o.style.display="none"}function yt(o,s,t,e,n,r){if(!r)return;if(s.empty(),!n||n.length===0){s.style.display="none";return}s.style.display="block";let i=s.createEl("div",{cls:"chart-notes-details-header"}),u=i.createEl("div",{cls:"chart-notes-details-title"});u.textContent=`Notas em "${t}" (${n.length})`+(Number.isFinite(e)&&e!==0?` \u2013 valor ${Number.isInteger(e)?e:e.toFixed(2)}`:"");let a=i.createEl("button",{cls:"chart-notes-details-close"});a.textContent="\xD7",a.addEventListener("click",()=>{s.style.display="none"});let l=s.createEl("ul",{cls:"chart-notes-details-list"});for(let p of n){let h=l.createEl("li",{cls:"chart-notes-details-item"}).createEl("a",{cls:"chart-notes-details-link",text:p});h.href="#",h.addEventListener("click",g=>{g.preventDefault(),app.workspace.openLinkText(p,"",!1)})}}function Gt(o){if(!(o instanceof Date)||isNaN(o.getTime()))return"";let s=o.getDate().toString().padStart(2,"0"),t=(o.getMonth()+1).toString().padStart(2,"0");return`${s}/${t}`}function $e(o){if(!o)return!1;let s=o.trim().toLowerCase();if(s==="#fff"||s==="#ffffff"||s==="white")return!0;if(!s.startsWith("#"))return!1;let t,e,n;if(s.length===4)t=parseInt(s[1]+s[1],16),e=parseInt(s[2]+s[2],16),n=parseInt(s[3]+s[3],16);else if(s.length===7)t=parseInt(s.slice(1,3),16),e=parseInt(s.slice(3,5),16),n=parseInt(s.slice(5,7),16);else return!1;return(.2126*t+.7152*e+.0722*n)/255>.7}var he=class extends Ct.Modal{constructor(t,e,n,r){var u;super(app);this.notePath=t,this.spec=e,this.refresh=n,this.reindexFile=r;let i=(u=e.encoding)!=null?u:{};this.startKey=i.start,this.endKey=i.end,this.durationKey=i.duration,this.dueKey=i.due}async onOpen(){var S,y;let{contentEl:t}=this;t.empty();let e=this.app.vault.getAbstractFileByPath(this.notePath);if(!(e instanceof Ct.TFile)){t.createEl("p",{text:"Arquivo n\xE3o encontrado: "+this.notePath});return}let n=await this.app.vault.read(e),r={},i=n,u=/^---\n([\s\S]*?)\n---\n?/m.exec(n);if(u){try{r=(S=(0,Ct.parseYaml)(u[1]))!=null?S:{}}catch(c){r={}}i=n.slice(u[0].length)}(typeof r!="object"||r==null)&&(r={});let a=(y=this.notePath.replace(/\.md$/i,"").split("/").pop())!=null?y:this.notePath,l=t.createDiv({cls:"gantt-edit-header"}),p=l.createEl("a",{text:a,cls:"gantt-edit-title"});p.href="#",p.addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(this.notePath,this.notePath,!0)});let f=l.createDiv({cls:"gantt-edit-subtitle"});f.textContent=this.notePath;let h=t.createDiv({cls:"gantt-edit-form"}),g=c=>{let C=h.createDiv({cls:"gantt-edit-row"}),T=C.createDiv({cls:"gantt-edit-label"});T.textContent=c;let w=C.createDiv({cls:"gantt-edit-field"});return{row:C,field:w}},v=c=>{if(!c)return"";let T=String(c).match(/^(\d{4}-\d{2}-\d{2})/);return T?T[1]:""},b=c=>{if(c=c.trim(),!!c&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c},A=null;if(this.startKey){let{field:c}=g(this.startKey+" (in\xEDcio)");A=c.createEl("input",{type:"date"}),A.value=v(r[this.startKey])}let E=null;if(this.endKey){let{field:c}=g(this.endKey+" (fim)");E=c.createEl("input",{type:"date"}),E.value=v(r[this.endKey])}let D=null;if(this.durationKey){let{field:c}=g(this.durationKey+" (minutos)");D=c.createEl("input",{type:"number"});let C=r[this.durationKey];D.value=C!=null?String(C):"",D.min="0",D.step="5"}let M=null;if(this.dueKey){let{field:c}=g(this.dueKey+" (due)");M=c.createEl("input",{type:"date"}),M.value=v(r[this.dueKey])}let N=t.createDiv({cls:"gantt-edit-buttons"}),$=N.createEl("button",{text:"Salvar",cls:"mod-cta"});N.createEl("button",{text:"Cancelar"}).addEventListener("click",c=>{c.preventDefault(),this.close()}),$.addEventListener("click",async c=>{if(c.preventDefault(),this.startKey&&A){let w=b(A.value);w?r[this.startKey]=w:delete r[this.startKey]}if(this.endKey&&E){let w=b(E.value);w?r[this.endKey]=w:delete r[this.endKey]}if(this.durationKey&&D){let w=D.value.trim();if(w==="")delete r[this.durationKey];else{let I=Number(w);Number.isNaN(I)||(r[this.durationKey]=I)}}if(this.dueKey&&M){let w=b(M.value);w?r[this.dueKey]=w:delete r[this.dueKey]}let T=`---
${(0,Ct.stringifyYaml)(r).trim()}
---
`+i;if(await this.app.vault.modify(e,T),this.reindexFile)try{await this.reindexFile(this.notePath)}catch(w){}if(this.refresh)try{this.refresh()}catch(w){}new Ct.Notice("Task atualizada"),this.close()})}onClose(){this.contentEl.empty()}};function ne(o,s,t,e){var be,xe,ve,Se,we,De,Ae,Ee;let n=(be=s.options)!=null?be:{},r=n.background,i=(xe=n.drilldown)!=null?xe:!0,u=!0,a=d=>{if(d==null)return"";let P=String(d).trim();if(!P)return"";let B=P.match(/^\[\[(.+?)\]\]$/);B&&(P=B[1]);let U=P.lastIndexOf("/");return U>=0&&U<P.length-1&&(P=P.slice(U+1)),P};if(Array.from(o.querySelectorAll(".gantt-zoom-controls, .gantt-label-floating-btn, .chart-notes-scroll, .chart-notes-details, .chart-notes-tooltip, .prop-charts-empty")).forEach(d=>d.remove()),t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let l=t.rows.filter(d=>d.start&&d.end);if(l.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: faltam campos de data."});return}let p=s.encoding,f=p.group,h=p.duration,g=(d,P)=>{if(!d||!P)return;let B=d[P];return Array.isArray(B)?B[0]:B},b=l.map(d=>{var xt,ct;let P=d.start,B=d.end,U=d.props,It=typeof d.x=="string"?d.x:d.x instanceof Date?Gt(P):String(d.x),Dt=a(It),bt,Ft=f?g(U,f):void 0;Ft!=null?bt=String(Ft):d.series!=null?bt=String(d.series):bt=Dt;let gt=(xt=d.notes)==null?void 0:xt[0],At=gt?(ct=gt.replace(/\.md$/i,"").split("/").pop())!=null?ct:gt:Dt,Nt=d.due,_t,Mt=g(U,h);if(Mt!=null){let vt=Number(Mt);Number.isNaN(vt)||(_t=vt)}return{row:d,start:P,end:B,props:U,fullName:Dt,groupKey:bt,notePath:gt,noteTitle:At,due:Nt,estMinutes:_t}}).filter(d=>d.start instanceof Date&&!isNaN(d.start.getTime())&&d.end instanceof Date&&!isNaN(d.end.getTime()));if(b.length===0){o.createDiv({cls:"prop-charts-empty",text:"Gantt: datas inv\xE1lidas."});return}b.sort((d,P)=>{if(d.groupKey<P.groupKey)return-1;if(d.groupKey>P.groupKey)return 1;let B=d.start.getTime(),U=P.start.getTime();return B!==U?B-U:d.fullName.localeCompare(P.fullName)});let A=26,E=0,D=null;for(let d of b)d.groupKey!==D&&(D=d.groupKey,E+=1),E+=1;let M=Math.min(...b.map(d=>d.start.getTime())),N=Math.max(...b.map(d=>d.end.getTime()));if(!isFinite(M)||!isFinite(N)){o.createDiv({cls:"prop-charts-empty",text:"Gantt: intervalo de datas inv\xE1lido."});return}let $=24*60*60*1e3,F=d=>{let P=new Date(d);return P.setHours(0,0,0,0),P.getTime()},S=F(M),y=F(N),c=o.querySelector(".prop-charts-title-row");c||(c=o.createDiv({cls:"prop-charts-title-row"}));let C=o.dataset.ganttZoomMode||String((ve=n.zoomMode)!=null?ve:"100");o.dataset.ganttZoomMode=C;let T=o.dataset.ganttLabelMode||String((Se=n.labelMode)!=null?Se:"compact");o.dataset.ganttLabelMode=T;let w=c.createDiv({cls:"gantt-zoom-controls"});[{id:"fit",label:"Fit"},{id:"100",label:"100%"},{id:"150",label:"150%"},{id:"200",label:"200%"}].forEach(d=>{let P=w.createEl("button",{cls:"gantt-zoom-btn",text:d.label});d.id===C&&P.addClass("is-active"),P.addEventListener("click",B=>{B.preventDefault(),o.dataset.ganttZoomMode=d.id,ne(o,s,t,e)})}),w.createEl("button",{cls:"gantt-zoom-btn gantt-fullscreen-btn",text:"\u2922"}).addEventListener("click",d=>{d.preventDefault();let P=o.querySelector(".chart-notes-zoom-button");P&&P.click()});let Y=Number(n.labelWidth),Q=!Number.isNaN(Y)&&Y>120?Y:260,H=T==="wide"?Q+160:Q,X=o.getBoundingClientRect().width||600,et=Math.max(X,820),_;if(C==="fit")_=X;else{let d=Number(C)/100||1;_=et*d}let{inner:m,svg:x,tooltip:R,details:k}=wt(o,r);m.style.width=_+"px";let L=(d,P,B,U,It,Dt,bt,Ft,gt)=>{if(!d)return;let At=Math.max(40,U-8),_t=Math.max(8,Math.floor(At/6)),Mt=d.split(/\s+/),xt=[],ct="";for(let Tt of Mt){if(!ct){ct=Tt;continue}(ct+" "+Tt).length<=_t?ct+=" "+Tt:(xt.push(ct),ct=Tt)}ct&&xt.push(ct);let vt=It+2,Bt=xt.length*vt,Wt=B-Bt/2+It;xt.forEach((Tt,Yt)=>{let ot=document.createElementNS(x.namespaceURI,"text");ot.setAttribute("x",String(P)),ot.setAttribute("y",String(Wt+Yt*vt)),ot.setAttribute("text-anchor","start"),ot.setAttribute("font-size",String(It)),ot.setAttribute("fill","#111111"),Dt&&ot.setAttribute("font-weight",Dt),ot.textContent=Tt,bt&&ot.addEventListener("mouseenter",rt=>bt(rt)),Ft&&ot.addEventListener("mouseleave",()=>Ft()),gt&&(ot.style.cursor="pointer",ot.addEventListener("click",rt=>gt(rt))),x.appendChild(ot)})},J=28,z=28,st=10,q=Math.max(300,J+z+E*A+24);x.setAttribute("height",String(q));let W=_-H-st,K=J+6;x.style.color="#111111";let tt=y+$-S||1,at=S-tt*.02,ht=y+$+tt*.08,lt=d=>H+(d-at)/(ht-at)*W,G=(ht-at)/$,kt=Math.max(4,Math.min(12,Math.floor(W/90)||4)),dt=G/kt,Z=[1,2,3,5,7,10,14,21,30,60,90,180,365],pt=Z[Z.length-1];for(let d of Z)if(d>=dt){pt=d;break}let zt=[],Ve=F(at);for(let d=Ve;d<=ht+.5*$;d+=pt*$)zt.push(d);let Ht=document.createElementNS(x.namespaceURI,"line");Ht.setAttribute("x1",String(H)),Ht.setAttribute("y1",String(K)),Ht.setAttribute("x2",String(_-st)),Ht.setAttribute("y2",String(K)),Ht.setAttribute("stroke","#111111"),x.appendChild(Ht);for(let d of zt){let P=lt(d),B=document.createElementNS(x.namespaceURI,"line");B.setAttribute("x1",String(P)),B.setAttribute("y1",String(K)),B.setAttribute("x2",String(P)),B.setAttribute("y2",String(q-z)),B.setAttribute("stroke","#111111"),B.setAttribute("stroke-opacity","0.20"),B.setAttribute("stroke-dasharray","2,4"),x.appendChild(B);let U=document.createElementNS(x.namespaceURI,"text");U.setAttribute("x",String(P)),U.setAttribute("y",String(K-4)),U.setAttribute("text-anchor","middle"),U.setAttribute("font-size","10"),U.setAttribute("fill","#111111"),U.textContent=Gt(new Date(d)),x.appendChild(U)}let ye=new Date;ye.setHours(0,0,0,0);let ie=ye.getTime();if(ie>=at&&ie<=ht){let d=lt(ie),P=document.createElementNS(x.namespaceURI,"line");P.setAttribute("x1",String(d)),P.setAttribute("y1",String(K)),P.setAttribute("x2",String(d)),P.setAttribute("y2",String(q-z)),P.setAttribute("stroke","#4caf50"),P.setAttribute("stroke-width","2"),P.setAttribute("stroke-dasharray","4,2"),x.appendChild(P);let B=document.createElementNS(x.namespaceURI,"text");B.setAttribute("x",String(d+4)),B.setAttribute("y",String(K+12)),B.setAttribute("font-size","10"),B.setAttribute("fill","#4caf50"),B.textContent="hoje",x.appendChild(B)}let Ot=m.createEl("button",{cls:"gantt-label-floating-btn",text:"\u2194"});Ot.setAttr("title",T==="wide"?"Compactar nomes":"Expandir nomes"),Ot.style.left=`${H}px`,Ot.style.top="4px",Ot.addEventListener("click",d=>{d.preventDefault();let B=(o.dataset.ganttLabelMode||"compact")==="wide"?"compact":"wide";o.dataset.ganttLabelMode=B,ne(o,s,t,e)});let ze=["status","priority"],ae=Array.isArray(n.tooltipFields)?n.tooltipFields.map(d=>String(d)):null,We=ae&&ae.length?ae:ze,Qt=0,le=null;for(let d of b){let P=d.start,B=d.end,U=(B.getTime()-P.getTime())/6e4,It=d.props,Dt=d.notePath,bt=d.noteTitle,Ft=(De=(we=d.row.notes)==null?void 0:we.length)!=null?De:0,gt=d.due,At=d.estMinutes,Nt=[];Nt.push(`${Gt(P)} \u2192 ${Gt(B)}`),typeof At=="number"&&!Number.isNaN(At)?Nt.push(`est: ${Math.round(At)} min`):U>0&&Nt.push(`dura\xE7\xE3o: ${Math.round(U)} min`),gt instanceof Date&&Nt.push(`due: ${Gt(gt)}`);for(let nt of We){let O=g(It,nt);O!=null&&String(O).trim()!==""&&Nt.push(`${nt}: ${String(O)}`)}let _t=Nt.join("<br>"),Mt=nt=>{var O;nt.preventDefault(),u&&Dt?new he(Dt,s,e==null?void 0:e.refresh,e==null?void 0:e.reindexFile).open():yt(o,k,bt,At!=null?At:U,(O=d.row.notes)!=null?O:[],i)},xt=nt=>{bt&&_t&&ft(o,R,bt,_t,Ft,nt)},ct=()=>mt(R);if(d.groupKey!==le){le=d.groupKey;let nt=K+8+Qt*A+A/2,O=a(le);L(O,4,nt,H-12,11,"600"),Qt+=1}let vt=K+8+Qt*A,Bt=A-10,Wt=lt(P.getTime()),Tt=lt(B.getTime()),Yt=Math.max(4,Tt-Wt),ot=d.fullName,rt=document.createElementNS(x.namespaceURI,"rect");rt.setAttribute("x",String(Wt)),rt.setAttribute("y",String(vt)),rt.setAttribute("width",String(Yt)),rt.setAttribute("height",String(Bt)),rt.setAttribute("rx","3"),rt.setAttribute("ry","3"),rt.setAttribute("fill",it((Ae=d.row.series)!=null?Ae:ot,Qt)),rt.setAttribute("stroke","rgba(0,0,0,0.25)"),rt.setAttribute("stroke-width","0.5"),rt.style.cursor=u&&Dt?"pointer":"default",rt.addEventListener("mouseenter",xt),rt.addEventListener("mouseleave",ct),rt.addEventListener("click",Mt),x.appendChild(rt);let Ce=vt+Bt/2;if(Yt>=6){let nt=it((Ee=d.row.series)!=null?Ee:ot,Qt),O=document.createElementNS(x.namespaceURI,"circle");O.setAttribute("cx",String(Wt)),O.setAttribute("cy",String(Ce)),O.setAttribute("r","3.5"),O.setAttribute("fill","#ffffff"),O.setAttribute("stroke",nt),O.setAttribute("stroke-width","1.5"),x.appendChild(O);let Pt=document.createElementNS(x.namespaceURI,"circle");Pt.setAttribute("cx",String(Tt)),Pt.setAttribute("cy",String(Ce)),Pt.setAttribute("r","3.5"),Pt.setAttribute("fill","#ffffff"),Pt.setAttribute("stroke",nt),Pt.setAttribute("stroke-width","1.5"),x.appendChild(Pt)}let Ne=vt+Bt/2+2,Ut=f?16:4;if(T==="wide")L(ot,Ut,Ne,H-Ut-4,11,null,xt,ct,Mt);else{let nt=ot,O=Math.max(40,H-Ut-8),Te=Math.max(8,Math.floor(O/6));nt.length>Te&&(nt=nt.slice(0,Te-1)+"\u2026");let St=document.createElementNS(x.namespaceURI,"text");St.setAttribute("x",String(Ut)),St.setAttribute("y",String(Ne)),St.setAttribute("text-anchor","start"),St.setAttribute("font-size","11"),St.setAttribute("fill","#111111"),St.textContent=nt,St.style.cursor="pointer",St.addEventListener("mouseenter",xt),St.addEventListener("mouseleave",ct),St.addEventListener("click",Mt),x.appendChild(St)}if(gt instanceof Date){let nt=lt(gt.getTime()),O=document.createElementNS(x.namespaceURI,"line");O.setAttribute("x1",String(nt)),O.setAttribute("y1",String(vt)),O.setAttribute("x2",String(nt)),O.setAttribute("y2",String(vt+Bt)),O.setAttribute("stroke","#ff6b6b"),O.setAttribute("stroke-width","2"),O.setAttribute("stroke-dasharray","4,2"),x.appendChild(O)}Qt+=1}if(u){let d=o.createDiv({cls:"prop-charts-empty"});d.textContent="Clique em uma barra ou no nome para ajustar datas e estimate da tarefa."}}function ge(o,s,t){var H,X,et,_;let e=(H=s.options)!=null?H:{},n=e.background,r=(X=e.drilldown)!=null?X:!0,i=(et=t.rows)!=null?et:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:u,svg:a,tooltip:l,details:p}=wt(o,n),f=o.getBoundingClientRect().width||600,h=Math.max(f,480);u.style.width=h+"px";let g=40,v=16,b=18,A=28,E=300;a.setAttribute("height",String(E));let D=h-g-v,M=E-b-A,N=new Map;for(let m of i){let x=String(m.x),R=(_=N.get(x))!=null?_:{label:m.x,rows:[]};R.rows.push(m),N.set(x,R)}let F=Array.from(N.keys()).sort((m,x)=>m<x?-1:m>x?1:0).map(m=>N.get(m)),S=F.length,y=new Set;i.forEach(m=>{m.series!=null&&y.add(String(m.series))});let c=Array.from(y),C=c.length>1,T=C?"grouped":"single",w=0;i.forEach(m=>{m.y>w&&(w=m.y)}),(!isFinite(w)||w<=0)&&(w=1);let I=m=>b+M-m/(w||1)*M,V=I(0),Y=4;for(let m=0;m<=Y;m++){let x=w*m/Y,R=I(x),k=document.createElementNS(a.namespaceURI,"line");k.setAttribute("x1",String(g)),k.setAttribute("y1",String(R)),k.setAttribute("x2",String(h-v)),k.setAttribute("y2",String(R)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),a.appendChild(k);let L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(g-4)),L.setAttribute("y",String(R+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=String(Math.round(x)),a.appendChild(L)}let Q=S>0?D/S:D;if(F.forEach((m,x)=>{let R=g+Q*(x+.5),k=String(m.label),L=document.createElementNS(a.namespaceURI,"text");L.setAttribute("x",String(R)),L.setAttribute("y",String(E-A+12)),L.setAttribute("text-anchor","middle"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=k,a.appendChild(L)}),C){let m=o.createDiv({cls:"chart-notes-legend"});c.forEach((x,R)=>{let k=m.createDiv({cls:"chart-notes-legend-item"}),L=k.createDiv();L.style.width="10px",L.style.height="10px",L.style.borderRadius="999px",L.style.backgroundColor=it(x,R),k.createSpan({text:x})})}F.forEach((m,x)=>{let R=g+Q*(x+.5),k=m.rows;if(T==="single"){let q=k[0],W=q.y,K=Q*.6,tt=R-K/2,at=I(W),ht=Math.max(2,V-at),lt=it("bar",x),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(tt)),G.setAttribute("y",String(at)),G.setAttribute("width",String(K)),G.setAttribute("height",String(ht)),G.setAttribute("fill",lt),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let j=String(m.label),kt=`valor: ${Math.round(W*100)/100}`;G.addEventListener("mouseenter",dt=>{var Z,pt;return ft(o,l,j,kt,(pt=(Z=q.notes)==null?void 0:Z.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>mt(l)),G.addEventListener("click",dt=>{var Z;dt.preventDefault(),yt(o,p,j,W,(Z=q.notes)!=null?Z:[],r)}),a.appendChild(G);return}let L=c.length,J=Q/Math.max(L+1,2),z=L*J,st=R-z/2;c.forEach((q,W)=>{let K=k.find(Z=>(Z.series!=null?String(Z.series):"")===q);if(!K)return;let tt=K.y,at=st+W*J,ht=I(tt),lt=Math.max(2,V-ht),G=it(q,W),j=document.createElementNS(a.namespaceURI,"rect");j.setAttribute("x",String(at)),j.setAttribute("y",String(ht)),j.setAttribute("width",String(J)),j.setAttribute("height",String(lt)),j.setAttribute("fill",G),j.setAttribute("stroke","rgba(0,0,0,0.25)"),j.setAttribute("stroke-width","0.5"),j.style.cursor="pointer";let kt=`${q} @ ${String(m.label)}`,dt=`valor: ${Math.round(tt*100)/100}`;j.addEventListener("mouseenter",Z=>{var pt,zt;return ft(o,l,kt,dt,(zt=(pt=K.notes)==null?void 0:pt.length)!=null?zt:0,Z)}),j.addEventListener("mouseleave",()=>mt(l)),j.addEventListener("click",Z=>{var pt;Z.preventDefault(),yt(o,p,kt,tt,(pt=K.notes)!=null?pt:[],r)}),a.appendChild(j)})})}function He(o,s,t){var Q,H,X,et;let e=(Q=s.options)!=null?Q:{},n=e.background,r=(H=e.drilldown)!=null?H:!0,i=(X=t.rows)!=null?X:[];if(!i.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:u,svg:a,tooltip:l,details:p}=wt(o,n),f=o.getBoundingClientRect().width||600,h=Math.max(f,480);u.style.width=h+"px";let g=40,v=16,b=18,A=28,E=300;a.setAttribute("height",String(E));let D=h-g-v,M=E-b-A,N=new Map;for(let _ of i){let m=String(_.x),x=(et=N.get(m))!=null?et:{label:_.x,rows:[]};x.rows.push(_),N.set(m,x)}let F=Array.from(N.keys()).sort((_,m)=>_<m?-1:_>m?1:0).map(_=>N.get(_)),S=F.length,y=new Set;i.forEach(_=>{_.series!=null&&y.add(String(_.series))});let c=Array.from(y);if(!c.length){ge(o,s,t);return}let C=0;F.forEach(_=>{let m=_.rows.reduce((x,R)=>x+R.y,0);m>C&&(C=m)}),(!isFinite(C)||C<=0)&&(C=1);let T=_=>b+M-_/(C||1)*M,w=T(0),I=4;for(let _=0;_<=I;_++){let m=C*_/I,x=T(m),R=document.createElementNS(a.namespaceURI,"line");R.setAttribute("x1",String(g)),R.setAttribute("y1",String(x)),R.setAttribute("x2",String(h-v)),R.setAttribute("y2",String(x)),R.setAttribute("stroke","#cccccc"),R.setAttribute("stroke-opacity","0.25"),a.appendChild(R);let k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(g-4)),k.setAttribute("y",String(x+3)),k.setAttribute("text-anchor","end"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=String(Math.round(m)),a.appendChild(k)}let V=S>0?D/S:D;F.forEach((_,m)=>{let x=g+V*(m+.5),R=String(_.label),k=document.createElementNS(a.namespaceURI,"text");k.setAttribute("x",String(x)),k.setAttribute("y",String(E-A+12)),k.setAttribute("text-anchor","middle"),k.setAttribute("font-size","10"),k.setAttribute("fill","#111111"),k.textContent=R,a.appendChild(k)});let Y=o.createDiv({cls:"chart-notes-legend"});c.forEach((_,m)=>{let x=Y.createDiv({cls:"chart-notes-legend-item"}),R=x.createDiv();R.style.width="10px",R.style.height="10px",R.style.borderRadius="999px",R.style.backgroundColor=it(_,m),x.createSpan({text:_})}),F.forEach((_,m)=>{let x=g+V*(m+.5),R=V*.6,k=x-R/2,L=0;c.forEach((J,z)=>{let st=_.rows.find(dt=>(dt.series!=null?String(dt.series):"")===J);if(!st)return;let q=st.y,W=L,K=L+q;L=K;let tt=T(W),at=T(K),ht=Math.max(2,tt-at),lt=it(J,z),G=document.createElementNS(a.namespaceURI,"rect");G.setAttribute("x",String(k)),G.setAttribute("y",String(at)),G.setAttribute("width",String(R)),G.setAttribute("height",String(ht)),G.setAttribute("fill",lt),G.setAttribute("stroke","rgba(0,0,0,0.25)"),G.setAttribute("stroke-width","0.5"),G.style.cursor="pointer";let j=`${J} @ ${String(_.label)}`,kt=`valor: ${Math.round(q*100)/100}`;G.addEventListener("mouseenter",dt=>{var Z,pt;return ft(o,l,j,kt,(pt=(Z=st.notes)==null?void 0:Z.length)!=null?pt:0,dt)}),G.addEventListener("mouseleave",()=>mt(l)),G.addEventListener("click",dt=>{var Z;dt.preventDefault(),yt(o,p,j,q,(Z=st.notes)!=null?Z:[],r)}),a.appendChild(G)})})}function fe(o,s,t,e){var H,X,et,_;let n=(H=s.options)!=null?H:{},r=n.background,i=(X=n.drilldown)!=null?X:!0,u=(et=t.rows)!=null?et:[];if(!u.length){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let{inner:a,svg:l,tooltip:p,details:f}=wt(o,r),h=o.getBoundingClientRect().width||600,g=Math.max(h,480);a.style.width=g+"px";let v=40,b=16,A=18,E=24,D=300;l.setAttribute("height",String(D));let M=g-v-b,N=D-A-E,$=new Map;for(let m of u){let x=m.series!=null?String(m.series):"__default__",R=(_=$.get(x))!=null?_:[];R.push(m),$.set(x,R)}let F=Array.from($.keys()),S=[],y=new Set;for(let m of u){let x=String(m.x);y.has(x)||(y.add(x),S.push(m.x))}let c=S.length||1,C=m=>{let x=String(m),R=S.findIndex(k=>String(k)===x);return R<0?v:c===1?v+M/2:v+R/(c-1)*M},T=m=>String(m),w=Number.POSITIVE_INFINITY,I=Number.NEGATIVE_INFINITY;for(let m of u)m.y<w&&(w=m.y),m.y>I&&(I=m.y);(!isFinite(w)||!isFinite(I))&&(w=0,I=1),w===I&&(w===0?I=1:w=0);let V=m=>A+N-(m-w)/(I-w||1)*N,Y=4;for(let m=0;m<=Y;m++){let x=w+(I-w)*m/Y,R=V(x),k=document.createElementNS(l.namespaceURI,"line");k.setAttribute("x1",String(v)),k.setAttribute("y1",String(R)),k.setAttribute("x2",String(g-b)),k.setAttribute("y2",String(R)),k.setAttribute("stroke","#cccccc"),k.setAttribute("stroke-opacity","0.25"),l.appendChild(k);let L=document.createElementNS(l.namespaceURI,"text");L.setAttribute("x",String(v-4)),L.setAttribute("y",String(R+3)),L.setAttribute("text-anchor","end"),L.setAttribute("font-size","10"),L.setAttribute("fill","#111111"),L.textContent=Math.abs(x)>=100?String(Math.round(x)):String(Math.round(x*10)/10),l.appendChild(L)}let Q=F.filter(m=>m!=="__default__");if(Q.length>1){let m=o.createDiv({cls:"chart-notes-legend"});Q.forEach((x,R)=>{let k=x,L=m.createDiv({cls:"chart-notes-legend-item"}),J=L.createDiv();J.style.width="10px",J.style.height="10px",J.style.borderRadius="999px",J.style.backgroundColor=it(k,R),L.createSpan({text:k})})}F.forEach((m,x)=>{let R=$.get(m);if(!(R!=null&&R.length))return;let k=m==="__default__"?it("line",x):it(m,x),L=[...R].sort((z,st)=>{let q=S.findIndex(K=>String(K)===String(z.x)),W=S.findIndex(K=>String(K)===String(st.x));return q-W}),J="";if(L.forEach((z,st)=>{let q=C(z.x),W=V(z.y);J+=(st===0?"M ":" L ")+q+" "+W}),e){let z=L[0],st=L[L.length-1],q=C(z.x),W=C(st.x),K=V(w);J+=` L ${W} ${K} L ${q} ${K} Z`;let tt=document.createElementNS(l.namespaceURI,"path");tt.setAttribute("d",J),tt.setAttribute("fill",k),tt.setAttribute("fill-opacity","0.18"),tt.setAttribute("stroke",k),tt.setAttribute("stroke-width","1.5"),l.appendChild(tt)}else{let z=document.createElementNS(l.namespaceURI,"path");z.setAttribute("d",J),z.setAttribute("fill","none"),z.setAttribute("stroke",k),z.setAttribute("stroke-width","2"),l.appendChild(z)}L.forEach(z=>{let st=C(z.x),q=V(z.y),W=document.createElementNS(l.namespaceURI,"circle");W.setAttribute("cx",String(st)),W.setAttribute("cy",String(q)),W.setAttribute("r","3"),W.setAttribute("fill","#ffffff"),W.setAttribute("stroke",k),W.setAttribute("stroke-width","1.5"),W.style.cursor="pointer";let K=T(z.x),tt=m==="__default__"?"":String(z.series),at=tt?`${tt} @ ${K}`:K,ht=`valor: ${Math.round(z.y*100)/100}`;W.addEventListener("mouseenter",lt=>{var G,j;return ft(o,p,at,ht,(j=(G=z.notes)==null?void 0:G.length)!=null?j:0,lt)}),W.addEventListener("mouseleave",()=>mt(p)),W.addEventListener("click",lt=>{var G;lt.preventDefault(),yt(o,f,at,z.y,(G=z.notes)!=null?G:[],i)}),l.appendChild(W)})})}function Qe(o,s,t){var M;let{background:e,drilldown:n=!0}=(M=s.options)!=null?M:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let r=$e(e)?"#000000":void 0,i=o.getBoundingClientRect().width||600,{inner:u,svg:a,tooltip:l,details:p}=wt(o,e),f=Math.max(i,420);u.style.width=f+"px",r&&(a.style.color=r);let h=300,g=f/2,v=(h-28+28)/2,b=Math.min(f/2-20,h/2-20),E=t.rows.map(N=>Math.max(0,N.y)).reduce((N,$)=>N+$,0)||1,D=-Math.PI/2;t.rows.forEach((N,$)=>{var Q;let F=N.x instanceof Date?N.x.toISOString().slice(0,10):String(N.x),S=N.y,y=S/E*Math.PI*2,c=g+b*Math.cos(D),C=v+b*Math.sin(D),T=g+b*Math.cos(D+y),w=v+b*Math.sin(D+y),I=y>Math.PI?1:0,V=document.createElementNS(a.namespaceURI,"path"),Y=[`M ${g} ${v}`,`L ${c} ${C}`,`A ${b} ${b} 0 ${I} 1 ${T} ${w}`,"Z"].join(" ");V.setAttribute("d",Y),V.setAttribute("fill",it((Q=N.series)!=null?Q:F,$)),V.style.cursor="pointer",V.addEventListener("mouseenter",H=>{var X,et;return ft(o,l,F,S,(et=(X=N.notes)==null?void 0:X.length)!=null?et:0,H)}),V.addEventListener("mouseleave",()=>mt(l)),V.addEventListener("click",()=>{var H;return yt(o,p,F,S,(H=N.notes)!=null?H:[],n)}),a.appendChild(V),D+=y})}function Be(o,s,t){var C;let{background:e,drilldown:n=!0}=(C=s.options)!=null?C:{};if(t.rows.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados."});return}let r=e?"#111111":void 0,i=o.getBoundingClientRect().width||600,{inner:u,svg:a,tooltip:l,details:p}=wt(o,e),f=Math.max(i,700);u.style.width=f+"px",r&&(a.style.color=r);let h=300,g=f-48-10,v=h-28-28,b=t.rows.map(T=>{let w=T.x;if(w instanceof Date)return w.getTime();if(typeof w=="string"){if(/^\d{4}-\d{2}-\d{2}/.test(w)){let V=new Date(w);if(!isNaN(V.getTime()))return V.getTime()}let I=Number(w);return isNaN(I)?null:I}return typeof w=="number"?w:null}),A=t.rows.map(T=>T.y),E=b.filter(T=>T!==null);if(E.length===0){o.createDiv({cls:"prop-charts-empty",text:"Sem dados (X n\xE3o \xE9 num\xE9rico/data)."});return}let D=Math.min(...E),M=Math.max(...E),N=Math.min(...A),$=Math.max(...A),F=T=>48+(T-D)/(M-D||1)*g,S=T=>h-28-(T-N)/($-N||1)*v,y=document.createElementNS(a.namespaceURI,"line");y.setAttribute("x1",String(48)),y.setAttribute("y1",String(28)),y.setAttribute("x2",String(48)),y.setAttribute("y2",String(h-28)),y.setAttribute("stroke","currentColor"),a.appendChild(y);let c=document.createElementNS(a.namespaceURI,"line");c.setAttribute("x1",String(48)),c.setAttribute("y1",String(h-28)),c.setAttribute("x2",String(f-10)),c.setAttribute("y2",String(h-28)),c.setAttribute("stroke","currentColor"),a.appendChild(c),t.rows.forEach((T,w)=>{let I=b[w];if(I==null)return;let V=F(I),Y=S(A[w]),Q=document.createElementNS(a.namespaceURI,"circle");Q.setAttribute("cx",String(V)),Q.setAttribute("cy",String(Y)),Q.setAttribute("r","4"),Q.setAttribute("fill",it(T.series,w)),Q.style.cursor="pointer";let H=T.x instanceof Date?T.x.toISOString().slice(0,10):typeof T.x=="string"?T.x:String(T.x);Q.addEventListener("mouseenter",X=>{var et,_;return ft(o,l,H,T.y,(_=(et=T.notes)==null?void 0:et.length)!=null?_:0,X)}),Q.addEventListener("mouseleave",()=>mt(l)),Q.addEventListener("click",X=>{var et;X.preventDefault(),yt(o,p,H,T.y,(et=T.notes)!=null?et:[],n)}),a.appendChild(Q)})}var Ge=require("obsidian"),se=class{render(s,t,e,n,r=!1){var l;let{title:i}=(l=t.options)!=null?l:{};s.empty(),s.addClass("prop-charts-container");let a=s.createDiv({cls:"prop-charts-title-row"}).createDiv({cls:"prop-charts-title"});switch(i&&(a.textContent=i),t.type){case"bar":ge(s,t,e);break;case"stacked-bar":He(s,t,e);break;case"line":fe(s,t,e,!1);break;case"area":fe(s,t,e,!0);break;case"pie":Qe(s,t,e);break;case"scatter":Be(s,t,e);break;case"gantt":ne(s,t,e,n);break;default:s.createDiv({text:"Chart Notes: tipo n\xE3o suportado: "+t.type})}if(!r){let p=s.createEl("button",{cls:"chart-notes-zoom-button"});p.setAttr("type","button"),p.setAttr("aria-label","Expandir gr\xE1fico"),p.textContent="\u2922",p.addEventListener("click",f=>{f.preventDefault(),new me(t,e,this,n).open()})}}},me=class extends Ge.Modal{constructor(t,e,n,r){super(app);this.size="large";this.spec=t,this.data=e,this.renderer=n,this.ctx=r}onOpen(){var a;let{contentEl:t}=this;t.empty(),this.modalEl.addClass("chart-notes-zoom-modal-shell"),t.addClass("chart-notes-zoom-modal"),this.applySize();let e=t.createDiv({cls:"chart-notes-zoom-header"}),n=(a=this.spec.options)!=null&&a.title&&this.spec.options.title.trim().length>0?this.spec.options.title:"Chart Notes";e.createEl("div",{text:n,cls:"chart-notes-zoom-title"});let r=e.createDiv({cls:"chart-notes-zoom-sizes"}),i=(l,p)=>{let f=r.createEl("button",{cls:"chart-notes-zoom-size-btn",text:l});(()=>{f.toggleClass("is-active",this.size===p)})(),f.addEventListener("click",g=>{g.preventDefault(),this.size=p,this.applySize(),r.querySelectorAll(".chart-notes-zoom-size-btn").forEach(b=>b.classList.remove("is-active")),f.classList.add("is-active")})};i("S","small"),i("M","medium"),i("L","large");let u=t.createDiv({cls:"chart-notes-zoom-body"});this.renderer.render(u,this.spec,this.data,this.ctx,!0)}onClose(){this.contentEl.empty()}applySize(){let t=this.modalEl;if(!t)return;let e="95vw",n="85vh";switch(this.size){case"small":e="60vw",n="55vh";break;case"medium":e="80vw",n="70vh";break;case"large":default:e="95vw",n="85vh";break}t.style.maxWidth=e,t.style.width=e,t.style.height=n,t.style.maxHeight=n}};var oe=class extends Lt.Plugin{constructor(t,e){super(t,e)}async onload(){console.log("Chart Notes: loading plugin"),this.indexer=new Zt(this.app),await this.indexer.buildIndex(),this.query=new ee(()=>this.indexer.getAll(),[]),this.renderer=new se,this.registerEvent(this.app.vault.on("modify",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("create",async t=>{t instanceof Lt.TFile&&await this.indexer.updateFile(t)})),this.registerEvent(this.app.vault.on("delete",async t=>{t instanceof Lt.TFile&&this.indexer.removeFile(t)})),this.registerMarkdownCodeBlockProcessor("chart",async(t,e,n)=>{var p;let r;try{let f=(0,Lt.parseYaml)(t);if(!f||typeof f!="object"){e.createEl("div",{text:"Chart Notes: bloco vazio ou inv\xE1lido."});return}r=f}catch(f){e.createEl("div",{text:"Chart Notes: erro ao ler YAML: "+f.message});return}if(!r.type){e.createEl("div",{text:"Chart Notes: 'type' obrigat\xF3rio."});return}let i=r.type==="gantt",u=r.type==="table";if(!i&&!u){if(!r.encoding||!r.encoding.x){e.createEl("div",{text:"Chart Notes: 'encoding.x' \xE9 obrigat\xF3rio."});return}let h=((p=r.aggregate)==null?void 0:p.y)==="count";if(!r.encoding.y&&!h){e.createEl("div",{text:"Chart Notes: 'encoding.y' \xE9 obrigat\xF3rio (exceto quando aggregate.y = 'count')."});return}}r.encoding||(r.encoding={}),r.source||(r.source={});let l;try{l=this.query.run(r)}catch(f){e.createEl("div",{text:"Chart Notes: erro na query: "+f.message});return}this.renderer.render(e,r,l)}),this.registerBasesView(ue,{name:"Chart Notes",icon:"lucide-chart-area",factory:(t,e)=>new qt(t,e,this.renderer),options:()=>{let t={type:"dropdown",key:"chartType",displayName:"Chart type",default:"bar",options:{bar:"Bar","stacked-bar":"Stacked bar",line:"Line",area:"Area",pie:"Pie",scatter:"Scatter",gantt:"Gantt"}},e={type:"property",key:"xProperty",displayName:"Category / group"},n={type:"property",key:"yProperty",displayName:"Y value (empty = count)",shouldHide:E=>{var D;return String((D=E.get("chartType"))!=null?D:"bar")==="pie"}},r={type:"property",key:"seriesProperty",displayName:"Series / color (optional)",shouldHide:E=>{var D;return String((D=E.get("chartType"))!=null?D:"bar")==="pie"}},i={type:"dropdown",key:"aggregateMode",displayName:"Value mode",default:"normal",options:{normal:"Normal (sum / count)","cumulative-sum":"Cumulative (line/area only)"},shouldHide:E=>{var M;let D=String((M=E.get("chartType"))!=null?M:"bar");return D!=="line"&&D!=="area"}},u={type:"dropdown",key:"xBucket",displayName:"X bucketing (dates)",default:"auto",options:{auto:"Auto (date \u2192 day)",none:"None",day:"Day",week:"Week",month:"Month",quarter:"Quarter",year:"Year"},shouldHide:E=>{var M;let D=String((M=E.get("chartType"))!=null?M:"bar");return D==="pie"||D==="scatter"||D==="gantt"}},a=(E,D)=>({type:"property",key:E,displayName:D,shouldHide:M=>{var N;return String((N=M.get("chartType"))!=null?N:"")!=="gantt"}}),l=a("startProperty","Start (Gantt)"),p=a("endProperty","End (Gantt)"),f=a("dueProperty","Due (optional)"),h=a("scheduledProperty","Scheduled (optional)"),g=a("durationProperty","Duration in minutes (optional)"),v=a("groupProperty","Group / lane (optional)");return[t,e,n,r,i,l,p,f,h,g,v,{type:"toggle",key:"drilldown",displayName:"Drilldown (click opens notes)",default:!0},{type:"text",key:"title",displayName:"Title (optional)"}]}})}onunload(){console.log("Chart Notes: unloading plugin")}};
